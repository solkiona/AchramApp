----- FILE: src/hooks/useAuth.ts -----
// src/hooks/useAuth.ts
import { useState, useEffect } from 'react';

const TOKEN_KEY = 'achrams_passenger_token';

export const useAuth = () => {
  const [token, setToken] = useState<string | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const stored = typeof window !== 'undefined' ? localStorage.getItem(TOKEN_KEY) : null;
    if (stored) setToken(stored);
    setLoading(false);
  }, []);

  const login = (newToken: string) => {
    localStorage.setItem(TOKEN_KEY, newToken);
    setToken(newToken);
  };

  const logout = () => {
    localStorage.removeItem(TOKEN_KEY);
    setToken(null);
  };

  return { token, login, logout, isLoading: loading };
};

----- FILE: src/hooks/useGeolocation.ts -----
// // src/hooks/useGeolocation.ts
// import { useState, useEffect } from 'react';

// export interface GeolocationCoordinates {
//   latitude: number;
//   longitude: number;
// }

// export interface GeolocationResult {
//   coords: GeolocationCoordinates | null;
//   error: string | null;
//   loading: boolean;
//   requestPermission: () => Promise<GeolocationCoordinates | null>;
// }

// export const useGeolocation = (): GeolocationResult => {
//   const [coords, setCoords] = useState<GeolocationCoordinates | null>(null);
//   const [error, setError] = useState<string | null>(null);
//   const [loading, setLoading] = useState<boolean>(false);

//   const requestPermission = (): Promise<GeolocationCoordinates | null> => {
//     return new Promise((resolve) => {
//       if (!navigator.geolocation) {
//         setError('Geolocation is not supported by this browser.');
//         resolve(null);
//         return;
//       }

//       setLoading(true);
//       navigator.geolocation.getCurrentPosition(
//         (position) => {
//           const { latitude, longitude } = position.coords;
//           const newCoords = { latitude, longitude };
//           setCoords(newCoords);
//           setError(null);
//           setLoading(false);
//           resolve(newCoords);
//         },
//         (err) => {
//           let message = 'Unable to retrieve your location.';
//           if (err.code === 1) message = 'Location access denied.';
//           else if (err.code === 2) message = 'Location unavailable.';
//           else if (err.code === 3) message = 'Location request timed out.';

//           setError(message);
//           setLoading(false);
//           resolve(null);
//         },
//         {
//           enableHighAccuracy: true,
//           timeout: 10000,
//           maximumAge: 0,
//         }
//       );
//     });
//   };

//   return { coords, error, loading, requestPermission };
// };

// src/hooks/useGeolocation.ts
import { useState, useEffect } from 'react';

export interface GeolocationCoordinates {
  latitude: number;
  longitude: number;
}

export interface GeolocationResult {
  coords: GeolocationCoordinates | null;
  error: string | null;
  loading: boolean; // NEW: Track overall loading state
  requestPermission: () => Promise<GeolocationCoordinates | null>;
}

export const useGeolocation = (): GeolocationResult => {
  const [coords, setCoords] = useState<GeolocationCoordinates | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [loading, setLoading] = useState<boolean>(false); // NEW: Overall loading state

  const requestPermission = (): Promise<GeolocationCoordinates | null> => {
    // NEW: Return a promise that resolves when getCurrentPosition succeeds or rejects on error
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        const errorMsg = 'Geolocation is not supported by this browser.';
        setError(errorMsg);
        setLoading(false); // NEW: Stop loading if unsupported
        reject(errorMsg);
        return;
      }

      // NEW: Set loading state before requesting
      setLoading(true);
      setError(null); // NEW: Clear previous errors
      setCoords(null); // NEW: Clear previous coords

      navigator.geolocation.getCurrentPosition(
        (position) => {
          // NEW: Success callback
          const { latitude, longitude } = position.coords;
          const newCoords = { latitude, longitude };
          setCoords(newCoords);
          setError(null); // Ensure error is cleared on success
          setLoading(false); // NEW: Stop loading on success
          resolve(newCoords); // NEW: Resolve the promise with the coords
        },
        (err) => {
          // NEW: Error callback
          let message = 'Unable to retrieve your location.';
          if (err.code === 1) message = 'Location access denied.';
          else if (err.code === 2) message = 'Location unavailable.';
          else if (err.code === 3) message = 'Location request timed out.';

          setError(message);
          setLoading(false); // NEW: Stop loading on error
          console.error("Geolocation error:", message); // NEW: Log for debugging
          reject(message); // NEW: Reject the promise with the error message
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0,
        }
      );
    });
  };

  // NEW: Provide overall loading state to consumers
  return { coords, error, loading, requestPermission };
};

----- FILE: src/contexts/AuthContext.tsx -----
// src/contexts/AuthContext.tsx
'use client';

import { createContext, useContext, useState, useEffect } from 'react';

type AuthContextType = {
  token: string | null;
  isAuthenticated: boolean;
};

const AuthContext = createContext<AuthContextType>({ token: null, isAuthenticated: false });

export function AuthProvider({ children }: { children: React.ReactNode }) {
  const [token, setToken] = useState<string | null>(null);

  useEffect(() => {
    const stored = typeof window !== 'undefined' ? localStorage.getItem('auth_token') : null;
    setToken(stored);
  }, []);

  return (
    <AuthContext.Provider value={{ token, isAuthenticated: !!token }}>
      {children}
    </AuthContext.Provider>
  );
}

export const useAuth = () => useContext(AuthContext);

----- FILE: src/types/trip.ts -----


----- FILE: src/types/passenger.ts -----
// src/types/passenger.ts

export interface Passenger {
  id: string;
  name: string;
  initials: string;
  email: string;
  first_name: string;
  last_name: string;
  phone_number: string;
  profile_photo?: string;
  is_2fa_enabled: boolean;
  verified_at?: string;
  last_login?: string;
  created_at: string;
  updated_at: string;
  profile: {
    status: { label: string; value: string };
    wallet: {
      balance: {
        formatted: string;
        currency: string;
        amount: number;
      };
    };
    active_trip: Trip | null;
  };
}


export interface PassengerAccount {
  id: string;
  first_name: string;
  last_name: string;
  email: string;
  phone_number: string;
  is_2fa_enabled: boolean;
  profile?: {
    wallet?: {
      balance: {
        formatted: string;
        amount: number;
        currency: string;
      };
    };
  };
}


export interface Trip {
  id: string;
  amount: Money;
  status: Status;
  pickup_address: string;
  destination_address: string;
  verification_code: string;
  rating: Rating | null;
  map_ MapData;
  driver: Driver | null;
  guest?: Guest;
}

export interface Money {
  formatted: string;
  currency: string;
  amount: number;
}

export interface Status {
  label: string;
  value: string;
}

export interface Rating {
  score: number;
  comment: string;
}

export interface MapData {
  pickup_location: GeoFeature;
  destination_location: GeoFeature;
}

export interface GeoFeature {
  type: 'Feature';
  geometry: {
    type: 'Point';
    coordinates: [number, number]; // [longitude, latitude]
  };
  properties: {
    name: string;
    description: string;
  };
}

export interface Driver {
  id: string;
  name: string;
  details: {
    
    car_type: string;
    car_color: string;
    car_photo?: string;
    plate_number: string;
  }
  profile_photo?: string;
  has_extra_leg_room: boolean;
  has_extra_trunk_space: boolean;
  has_wheel_chair_access: boolean;
  rating: string;
}

export interface Guest {
  id: string;
  name: string;
  email: string;
  phone_number: string;
  expires_at: string;
  url: string;
}

export interface AuthResponse {
  token: string;
}

export interface ApiResponse<T = unknown> {
  status: 'success' | 'error';
  message: string;
   T;
}

----- FILE: src/components/ClientProviders.tsx -----
// src/components/ClientProviders.tsx
'use client';

import { AuthProvider } from '@/contexts/AuthContext';
import QueryProvider from './QueryProvider'; // Assume this exists

interface ClientProvidersProps {
  children: React.ReactNode;
}

export default function ClientProviders({ children }: ClientProvidersProps) {
  return (
    <AuthProvider>
      <QueryProvider>
        {children}
      </QueryProvider>
    </AuthProvider>
  );
}

----- FILE: src/components/navigation/BottomNavBar.tsx -----
import React from 'react';
import Link from 'next/link';
import { Home, History, CreditCard, User, Car } from 'lucide-react'; // Added Car for Booking
import { usePathname } from 'next/navigation';

const BottomNavBar: React.FC = () => {
  const pathname = usePathname();

  const navItems = [
    { href: '/', label: 'Home', icon: Home },
    { href: '/booking', label: 'Book', icon: Car }, // Using Car for booking
    { href: '/history', label: 'History', icon: History },
    { href: '/wallet', label: 'Wallet', icon: CreditCard },
    { href: '/profile', label: 'Profile', icon: User },
  ];

  return (
    <nav className="fixed bottom-0 left-0 right-0 bg-achrams-background-primary border-t border-achrams-border p-3 flex justify-around z-10">
      {navItems.map((item) => {
        const IconComponent = item.icon;
        const isActive = pathname === item.href;

        return (
          <Link
            key={item.href}
            href={item.href}
            className={`flex flex-col items-center gap-1 p-2 rounded-lg min-w-[60px] ${
              isActive
                ? 'text-achrams-primary-solid'
                : 'text-achrams-text-secondary'
            }`}
            aria-current={isActive ? 'page' : undefined}
          >
            <IconComponent className="w-6 h-6" />
            <span className="text-xs">{item.label}</span>
          </Link>
        );
      })}
    </nav>
  );
};

export default BottomNavBar;

----- FILE: src/components/layout/BottomNavBar.tsx -----
// src/components/layout/BottomNavBar.tsx
import React from 'react';
import { useRouter } from 'next/navigation';
import { Home, MapPin, User, WalletCards } from 'lucide-react';
import { twMerge } from 'tailwind-merge';

interface BottomNavBarProps {
  activeTab: 'home' | 'book' | 'profile' | 'wallet'; // Define active tab prop
}

const BottomNavBar: React.FC<BottomNavBarProps> = ({ activeTab }) => {
  const router = useRouter();

  const navItems = [
    { id: 'home', icon: Home, label: 'Home', path: '/' },
    { id: 'book', icon: MapPin, label: 'Book', path: '/booking/details' },
    { id: 'wallet', icon: WalletCards, label: 'Wallet', path: '/wallet' },
    { id: 'profile', icon: User, label: 'Profile', path: '/profile' },
  ];

  return (
    <div className="fixed bottom-0 left-1/2 transform -translate-x-1/2 w-full max-w-md bg-achrams-background-primary border-t border-achrams-border py-2 px-4 flex justify-around items-center z-20">
      {navItems.map((item) => (
        <button
          key={item.id}
          onClick={() => router.push(item.path)}
          className={twMerge(
            'flex flex-col items-center gap-1 p-2 rounded-lg transition-colors w-full',
            activeTab === item.id
              ? 'text-achrams-primary-solid' // Active tab color
              : 'text-achrams-text-secondary hover:text-achrams-text-primary' // Inactive tab color
          )}
          aria-label={item.label}
        >
          <item.icon className="w-6 h-6" />
          <span className="text-xs font-medium">{item.label}</span>
        </button>
      ))}
    </div>
  );
};

export default BottomNavBar;

----- FILE: src/components/ui/Input.tsx -----
// src/components/ui/Input.tsx
import { InputHTMLAttributes } from 'react';
import { twMerge } from 'tailwind-merge';

interface InputProps extends InputHTMLAttributes<HTMLInputElement> {
  label?: string;
  error?: string;
  icon?: React.ReactNode;
}

const Input: React.FC<InputProps> = ({
  label,
  error,
  icon,
  className,
  ...props
}) => {
  const containerClasses = twMerge(
    'w-full',
    className
  );

  const inputClasses = twMerge(
    'w-full pl-10 pr-4 py-3 bg-achrams-background-card rounded-xl border border-achrams-border focus:outline-none focus:ring-2 focus:ring-achrams-primary-solid',
    error ? 'border-red-500 focus:ring-red-500' : '',
    icon ? 'pl-10' : 'pl-4'
  );

  return (
    <div className={containerClasses}>
      {label && <label className="block text-sm font-medium text-achrams-text-primary mb-1">{label}</label>}
      <div className="relative">
        {icon && <div className="absolute left-3 top-1/2 transform -translate-y-1/2 text-achrams-text-secondary">{icon}</div>}
        <input
          className={inputClasses}
          {...props}
        />
      </div>
      {error && <p className="mt-1 text-sm text-red-600">{error}</p>}
    </div>
  );
};

export default Input;

----- FILE: src/components/ui/OTPInput.tsx -----
// src/components/ui/OTPInput.tsx
import React, { useState, useRef, useEffect } from 'react';
import { twMerge } from 'tailwind-merge';

interface OTPInputProps {
  length?: number;
  onChange: (otp: string) => void;
  onComplete?: (otp: string) => void;
  autoFocus?: boolean;
  containerClassName?: string;
  inputClassName?: string;
  error?: string; // Add error prop
}

const OTPInput: React.FC<OTPInputProps> = ({
  length = 5,
  onChange,
  onComplete,
  autoFocus = true,
  containerClassName,
  inputClassName,
  error,
}) => {
  const [otp, setOtp] = useState<string[]>(Array(length).fill(''));
  const inputRefs = useRef<Array<HTMLInputElement | null>>([]);

  useEffect(() => {
    if (autoFocus && inputRefs.current[0]) {
      inputRefs.current[0]?.focus();
    }
  }, [autoFocus]);

  const handleChange = (index: number, value: string) => {
    if (/^\d*$/.test(value) && value.length <= 1) {
      const newOtp = [...otp];
      newOtp[index] = value;
      setOtp(newOtp);

      onChange(newOtp.join(''));

      // Auto-focus next input
      if (value && index < length - 1) {
        inputRefs.current[index + 1]?.focus();
      }

      // Auto-submit if all filled
      const allFilled = newOtp.every(digit => digit !== '');
      if (allFilled && newOtp.join('').length === length) {
        onComplete?.(newOtp.join(''));
      }
    }
  };

  const handleKeyDown = (index: number, e: React.KeyboardEvent<HTMLInputElement>) => {
    // Allow backspace to clear current and move to previous
    if (e.key === 'Backspace' && !otp[index] && index > 0) {
      inputRefs.current[index - 1]?.focus();
    }
  };

  const containerClasses = twMerge(
    'flex gap-3 justify-center bg-achrams-secondary-solid/50 ',
    containerClassName
  );

  const inputClasses = twMerge(
    'w-14 h-14 text-center text-2xl font-bold border-2 border-achrams-border rounded-xl focus:outline-none focus:ring-2 focus:ring-achrams-primary-solid bg-achrams-background-card',
    error ? 'border-red-500 focus:ring-red-500' : 'focus:border-achrams-primary-solid',
    inputClassName
  );

  return (
    <div className={containerClasses}>
      {otp.map((digit, index) => (
        <input
          key={index}
          ref={(el) => (inputRefs.current[index] = el)}
          type="text"
          inputMode="numeric"
          maxLength={1}
          value={digit}
          onChange={(e) => handleChange(index, e.target.value)}
          onKeyDown={(e) => handleKeyDown(index, e)}
          className={inputClasses}
        />
      ))}
      {error && <p className="mt-2 text-sm text-red-600 w-full text-center">{error}</p>}
    </div>
  );
};

export default OTPInput;

----- FILE: src/components/ui/ACHRAMSHeader.tsx -----
import React from 'react';
import { X } from 'lucide-react';
import { twMerge } from 'tailwind-merge';
import Image from "next/image"

interface ACHRAMSHeaderProps {
  title: string;
  showBackButton?: boolean;
  onBackClick?: () => void;
  showLogo?: boolean; // New prop to control logo visibility
  className?: string;
}

const ACHRAMSHeader: React.FC<ACHRAMSHeaderProps> = ({
  title,
  showBackButton = false,
  onBackClick,
  showLogo = true, // Default to true to maintain existing behavior on other screens
  className = "",
}) => {
  return (
    <div
      className={twMerge(
        " text-achrams-text-light  flex items-center gap-4 ",
        className
      )}
    >
      {/* Conditionally render the Logo Container */}
      {showLogo && (<>
        <div className="max-w-7xl mx-auto">
  <div className="flex items-center h-20 space-x-3">
    {/* Logo Box */}
    <div className="w-12 h-12 bg-achrams-gradient-primary rounded-xl flex items-center justify-center shadow-lg">
      <Image
        src="/images/logo.png"
        alt="ACHRAMS Logo"
        width={25}
        height={25}
        className="object-contain"
      />
    </div>

    {/* Title + Subtitle */}
    <div className="text-left flex flex-col items-start">
      <h1 className="text-2xl font-bold text-white ">
        ACHRAMS
      </h1>
      {/* text-achrams-primary-solid */}
      <p className="text-xs text-gray-300">
        Official Airport Car Hire
      </p>
    </div>
  </div>
</div>


      
      </>
      )}

      {showBackButton && (
        <button
          onClick={onBackClick}
          aria-label="Go back"
          className="p-1" // Add padding for touch target size
        >
          <X className="w-6 h-6" />
        </button>
      )}
      <h2 className="text-lg font-bold flex-1 text-center">
        {title}
      </h2>
    </div>
  );
};

export default ACHRAMSHeader;

----- FILE: src/components/ui/Button.tsx -----
// src/components/ui/Button.tsx
import { ButtonHTMLAttributes } from 'react';
import { twMerge } from 'tailwind-merge';

interface ButtonProps extends ButtonHTMLAttributes<HTMLButtonElement> {
  variant?: 'primary' | 'secondary' | 'outline' | 'ghost';
  size?: 'sm' | 'md' | 'lg';
  isLoading?: boolean;
}

const Button: React.FC<ButtonProps> = ({
  children,
  className,
  variant = 'primary',
  size = 'md',
  isLoading = false,
  disabled,
  ...props
}) => {
  const baseClasses = 'font-semibold rounded-xl transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2';
  const sizeClasses = {
    sm: 'text-xs py-2 px-4',
    md: 'text-sm py-3 px-6',
    lg: 'text-base py-4 px-8',
  };
  const variantClasses = {
    primary: 'bg-achrams-gradient-primary text-achrams-text-light hover:opacity-90 focus:ring-achrams-primary-solid',
    secondary: 'bg-achrams-secondary-solid text-achrams-text-light hover:bg-opacity-90 focus:ring-achrams-secondary-solid',
    outline: 'border border-achrams-border text-achrams-text-primary bg-transparent hover:bg-achrams-background-secondary focus:ring-achrams-border',
    ghost: 'text-achrams-text-primary hover:bg-achrams-background-secondary focus:ring-achrams-border',
  };

  const disabledClasses = disabled || isLoading ? 'opacity-60 cursor-not-allowed' : '';

  const classes = twMerge(
    baseClasses,
    sizeClasses[size],
    variantClasses[variant],
    disabledClasses,
    className
  );

  return (
    <button
      className={classes}
      disabled={disabled || isLoading}
      {...props}
    >
      {isLoading ? (
        <span className="flex items-center justify-center">
          <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-current" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          Loading...
        </span>
      ) : (
        children
      )}
    </button>
  );
};

export default Button;

----- FILE: src/components/QueryProvider.tsx -----
// src/components/QueryProvider.tsx
"use client"; // This marks the entire file as a Client Component

import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import { ReactNode, useState } from "react";

const QueryProvider = ({ children }: { children: ReactNode }) => {
  // Use useState to create the QueryClient instance only on the client side
  const [queryClient] = useState(
    () =>
      new QueryClient({
        defaultOptions: {
          queries: {
            staleTime: 5 * 60 * 1000, // 5 minutes
          },
        },
      })
  );

  return (
    <QueryClientProvider client={queryClient}>
      {children}
    </QueryClientProvider>
  );
};

export default QueryProvider;

----- FILE: src/components/icons/GoogleColor.tsx -----
export default function GoogleIconColor({ size = 24 }) {
  return (
    <svg
      width={size}
      height={size}
      viewBox="0 0 533.5 544.3"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path fill="#4285F4" d="M533.5 278.4c0-18.6-1.5-37.3-4.8-55.6H272v105.2h147.7c-6.4 35.6-26.1 65.7-55.3 85.9l89.3 69.2c52-48 82-118.6 82-204.7z"/>
      <path fill="#34A853" d="M272 544.3c74.7 0 137.4-24.7 183.1-67.2l-89.3-69.2c-24.8 16.8-56.6 26.6-93.8 26.6-72.2 0-133.4-48.8-155.3-114.2H25.8v71.9c45.8 90.8 139.3 152.1 246.2 152.1z"/>
      <path fill="#FBBC05" d="M116.7 320.3c-5.8-17.3-9-35.7-9-54.3s3.2-37 9-54.3V139.8H25.8C9.3 174.6 0 214.4 0 266c0 51.6 9.3 91.4 25.8 126.2l90.9-71.9z"/>
      <path fill="#EA4335" d="M272 107.1c40.7 0 77.3 14 106 41.4l79.3-79.3C409.3 24.7 346.6 0 272 0 165.1 0 71.6 61.3 25.8 152.1l90.9 71.9C138.6 155.9 199.8 107.1 272 107.1z"/>
    </svg>
  );
}


----- FILE: src/components/app/modals/UpdateProfileModal.tsx -----
// src/components/app/modals/UpdateProfileModal.tsx
import { X, User, Mail, Phone, Globe, Loader } from 'lucide-react';
import { useState, useEffect } from 'react';
import { apiClient } from '@/services/apiClient'; // Assuming you create this service

interface UpdateProfileModalProps {
  isOpen: boolean;
  initialData: { name: string; email: string; phone: string; preferred_language: string }; // NEW: Pass initial data
  onClose: () => void;
  onSuccess: (updatedData: any) => void; // NEW: Callback after successful update
}

export default function UpdateProfileModal({
  isOpen,
  initialData,
  onClose,
  onSuccess,
}: UpdateProfileModalProps) {
  if (!isOpen) return null;

  // NEW: State for form data, loading, error
  const [formData, setFormData] = useState(initialData); // NEW: Initialize with initial data
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  // NEW: Reset form when initialData changes (e.g., if modal is reused)
  useEffect(() => {
    if (isOpen) {
        setFormData(initialData);
        setError('');
    }
  }, [initialData, isOpen]);


  const handleChange = (field: keyof typeof formData, value: string) => {
    setFormData(prev => ({ ...prev, [field]: value }));
  };

  const handleSubmit = async () => {
    setError(''); // Clear previous errors
    // Basic validation can be added here if needed

    setLoading(true);
    try {
      // NEW: Call the update profile API using apiClient
      // Use PATCH /auth/passenger/me as per Postman doc
      const response = await apiClient.patch('/auth/passenger/me', formData);

      console.log("Profile Update Response:", response); // Debug log
      if (response.status === 200 && response.data && response.data.data) { // Assuming 200 for success
        // NEW: On success, close modal and trigger success handler with updated data
        onClose();
        onSuccess(response.data.data); // Pass the updated user data back
      } else {
          setError('Failed to update profile. Please try again.');
      }
    } catch (err: any) {
        console.error("Profile Update Error:", err);
        let errorMessage = 'An unexpected error occurred.';
        if (err.response && err.response.data && err.response.data.message) {
            errorMessage = err.response.data.message;
        } else if (err.message) {
            errorMessage = err.message;
        }
        setError(errorMessage);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-achrams-bg-primary bg-opacity-70 flex items-end z-50">
      <div className="bg-achrams-bg-primary w-full rounded-t-3xl p-6 animate-slideUp max-h-[85vh] overflow-y-auto border-t border-achrams-border">
        <div className="flex justify-between items-center mb-6">
          <h3 className="text-xl font-bold text-achrams-text-primary">Edit Profile</h3>
          <button
            onClick={onClose}
            disabled={loading} // NEW: Disable close button while loading
            className="text-achrams-text-secondary hover:text-achrams-text-primary transition-colors disabled:opacity-50"
          >
            <X className="w-6 h-6" />
          </button>
        </div>

        <div className="space-y-4 mb-6">
          <div className="relative">
            <User className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-achrams-text-secondary" />
            <input
              type="text"
              placeholder="Full name"
              value={formData.name}
              onChange={(e) => handleChange('name', e.target.value)}
              disabled={loading} // NEW: Disable input while loading
              className="w-full pl-10 pr-4 py-4 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border border-achrams-border"
            />
          </div>
          <div className="relative">
            <Mail className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-achrams-text-secondary" />
            <input
              type="email"
              placeholder="Email"
              value={formData.email}
              onChange={(e) => handleChange('email', e.target.value)}
              disabled={loading} // NEW: Disable input while loading
              className="w-full pl-10 pr-4 py-4 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border border-achrams-border"
            />
          </div>
          <div className="relative">
            <Phone className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-achrams-text-secondary" />
            <input
              type="tel"
              placeholder="Phone number"
              value={formData.phone}
              onChange={(e) => handleChange('phone', e.target.value)} // NEW: Handle phone change
              disabled={loading} // NEW: Disable input while loading
              className="w-full pl-10 pr-4 py-4 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border border-achrams-border"
            />
          </div>
          <div className="relative">
            <Globe className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-achrams-text-secondary" />
            <select // NEW: Use select for language
              value={formData.preferred_language}
              onChange={(e) => handleChange('preferred_language', e.target.value)}
              disabled={loading} // NEW: Disable input while loading
              className="w-full pl-10 pr-4 py-4 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border border-achrams-border appearance-none"
            >
              <option value="en">English</option>
              <option value="es">Spanish</option>
              <option value="fr">French</option>
              {/* Add more options as needed based on API support */}
            </select>
          </div>
        </div>

        {/* NEW: Error Message Display */}
        {error && (
          <p className="text-red-500 text-sm mb-4">{error}</p>
        )}

        <button
          onClick={handleSubmit}
          disabled={loading} // NEW: Disable based on loading
          className={`w-full py-4 rounded-xl font-semibold mb-3 transition-all ${
            loading
              ? 'bg-achrams-secondary-solid text-achrams-text-light opacity-75 cursor-not-allowed'
              : 'bg-achrams-gradient-primary text-achrams-text-light hover:opacity-90 active:scale-[0.98]'
          }`}
        >
          {loading ? ( // NEW: Show spinner while loading
            <div className="flex items-center justify-center">
              <Loader className="w-5 h-5 animate-spin mr-2" />
              Saving...
            </div>
          ) : (
            'Save Changes'
          )}
        </button>

        <button
          onClick={onClose}
          disabled={loading} // NEW: Disable "Cancel" while loading
          className="w-full text-achrams-text-secondary font-medium hover:text-achrams-text-primary transition-colors disabled:opacity-50"
        >
          Cancel
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/ProfileModal.tsx -----
// src/components/app/modals/ProfileModal.tsx
import { X, Phone, Mail, Star, Shield, ChevronRight } from 'lucide-react';
import { PassengerAccount } from '@/types/passenger'; // You can define this type

interface ProfileModalProps {
  isOpen: boolean;
  onClose: () => void;
  passenger: PassengerAccount | null;
  onLogout: () => void;
}

export default function ProfileModal({
  isOpen,
  onClose,
  passenger,
  onLogout,
}: ProfileModalProps) {
  if (!isOpen || !passenger) return null;

  const initials = `${passenger.first_name.charAt(0)}${passenger.last_name.charAt(0)}`.toUpperCase();

  return (
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 flex items-end z-50 animate-fadeIn">
      <div className="bg-white w-full rounded-t-3xl animate-slideUp max-h-[90vh] overflow-y-auto">
        <div className="bg-achrams-primary-solid text-white px-6 py-8">
          <button onClick={onClose} className="mb-6">
            <X className="w-6 h-6" />
          </button>
          <div className="flex items-center gap-4">
            <div className="w-20 h-20 bg-gradient-to-br from-emerald-400 to-teal-500 rounded-full flex items-center justify-center text-2xl font-bold shadow-lg">
              {initials}
            </div>
            <div>
              <h3 className="text-2xl font-bold mb-1">
                {passenger.first_name} {passenger.last_name}
              </h3>
              {passenger.is_2fa_enabled && (
                <div className="flex items-center gap-1 text-xs text-green-200">
                  <Shield className="w-4 h-4" />
                  <span>2FA enabled</span>
                </div>
              )}
            </div>
          </div>
        </div>

        <div className="px-6 py-6 space-y-6">
          {/* Contact Info */}
          <div>
            <h4 className="font-bold mb-4 text-gray-800">Contact information</h4>
            <div className="space-y-3">
              <div className="flex items-center gap-3 p-4 bg-gray-50 rounded-xl">
                <Phone className="w-5 h-5 text-gray-600" />
                <div>
                  <div className="text-xs text-gray-500 mb-1">Phone</div>
                  <div className="font-medium">{passenger.phone_number}</div>
                </div>
              </div>
              <div className="flex items-center gap-3 p-4 bg-gray-50 rounded-xl">
                <Mail className="w-5 h-5 text-gray-600" />
                <div>
                  <div className="text-xs text-gray-500 mb-1">Email</div>
                  <div className="font-medium">{passenger.email}</div>
                </div>
              </div>
            </div>
          </div>

          {/* Account Stats */}
          {passenger.profile?.wallet && (
            <div>
              <h4 className="font-bold mb-4 text-gray-800">Wallet</h4>
              <div className="p-4 bg-gray-50 rounded-xl">
                <div className="text-lg font-bold">
                  {passenger.profile.wallet.balance.formatted}
                </div>
              </div>
            </div>
          )}

          {/* Settings & Support */}
          <div>
            <h4 className="font-bold mb-4 text-gray-800">Account</h4>
            <div className="space-y-2">
              <button className="w-full flex items-center justify-between p-4 bg-gray-50 rounded-xl hover:bg-gray-100">
                <span>Security & 2FA</span>
                <ChevronRight className="w-5 h-5 text-gray-500" />
              </button>
              <button className="w-full flex items-center justify-between p-4 bg-gray-50 rounded-xl hover:bg-gray-100">
                <span>Payment methods</span>
                <ChevronRight className="w-5 h-5 text-gray-500" />
              </button>
              <button className="w-full flex items-center justify-between p-4 bg-gray-50 rounded-xl hover:bg-gray-100">
                <span>Trip history</span>
                <ChevronRight className="w-5 h-5 text-gray-500" />
              </button>
            </div>
          </div>

          <button
            onClick={onLogout}
            className="w-full py-4 text-center text-red-600 font-medium hover:bg-red-50 rounded-xl"
          >
            Log out
          </button>
          <div className="h-4"></div>
        </div>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/LocationPermissionModal.tsx -----
// src/components/app/modals/LocationPermissionModal.tsx
import { X } from 'lucide-react';

interface LocationPermissionModalProps {
  isOpen: boolean;
  onClose: () => void;
  onGrantAccess: () => void; // Function to trigger browser permission request
}

export default function LocationPermissionModal({
  isOpen,
  onClose,
  onGrantAccess,
}: LocationPermissionModalProps) {
  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 bg-opacity-70 flex items-end z-100">
      <div className="bg-white w-full rounded-t-3xl p-6 animate-slideUp max-h-[85vh] overflow-y-auto border-t border-achrams-border">
        <div className="flex justify-between items-center mb-6">
          <h3 className="text-xl font-bold text-achrams-text-primary">Location Access Required</h3>
          <button
            onClick={onClose}
            className="text-achrams-text-secondary hover:text-achrams-text-primary transition-colors"
          >
            <X className="w-6 h-6" />
          </button>
        </div>
        <div className="flex flex-col items-center gap-4 mb-6">
          <p className="text-center text-achrams-text-secondary">
            This app requires your location access to work. Please grant access to find nearby pickup locations.
          </p>
        </div>
        <button
          onClick={() => {
            onGrantAccess(); // Trigger the geolocation permission request
            onClose(); // Close the modal after triggering
          }}
          className={`w-full py-4 rounded-xl font-semibold transition-all bg-achrams-gradient-primary text-achrams-text-light hover:opacity-90 active:scale-[0.98]`}
        >
          Grant Access
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/PassengerDetailsModal.tsx -----
// src/components/app/modals/PassengerDetailsModal.tsx
import { X, Package, Users, Accessibility } from 'lucide-react'; // Added Wheelchair icon
import { useState } from 'react';

interface PassengerDetailsModalProps {
  isOpen: boolean;
  onClose: () => void;
  passengerData: { name: string; phone: string; email: string };
  setPassengerData: (data: any) => void;
  requirements: { luggage: boolean; wheelchair: boolean; elderly: boolean };
  setRequirements: (req: any) => void;
  onRequestRide: () => void;

  isLoading? : boolean;

}

export default function PassengerDetailsModal({
  isOpen,
  onClose,
  passengerData,
  setPassengerData,
  requirements,
  setRequirements,
  onRequestRide,
  isLoading,
}: PassengerDetailsModalProps) {
  const [showRequirements, setShowRequirements] = useState(false);

  if (!isOpen) return null;

  return (
    // Fixed background: use bg-achrams-bg-primary with opacity
    // Ensure it covers the whole screen behind the modal
    <div className=" fixed inset-0 bg-achrams-secondary-solid/50 flex items-end z-50"> 
      {/* The modal content */}
      <div className="bg-white w-full rounded-t-3xl p-6 animate-slideUp max-h-[85vh] overflow-y-auto border-t border-achrams-border">
        <div className="flex justify-between items-center mb-6">
          <h3 className="text-xl font-bold text-achrams-text-primary">Passenger details</h3>
          <button 
            onClick={onClose}
            className="text-achrams-text-secondary hover:text-achrams-text-primary transition-colors"
          >
            <X className="w-6 h-6" />
          </button>
        </div>
        <div className="space-y-4 mb-6">
          <input
            type="text"
            placeholder="Full name"
            value={passengerData.name}
            onChange={(e) => setPassengerData({ ...passengerData, name: e.target.value })}
            // Apply ACHRAMS styling to input
            className="w-full px-4 py-4 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border border-achrams-border"
          />
          <input
            type="tel"
            placeholder="Phone number"
            value={passengerData.phone}
            onChange={(e) => setPassengerData({ ...passengerData, phone: e.target.value })}
            // Apply ACHRAMS styling to input
            className="w-full px-4 py-4 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border border-achrams-border"
          />
          <input
            type="email"
            placeholder="Email address"
            value={passengerData.email}
            onChange={(e) => setPassengerData({ ...passengerData, email: e.target.value })}
            // Apply ACHRAMS styling to input
            className="w-full px-4 py-4 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border border-achrams-border"
          />
        </div>
        <button
          onClick={() => setShowRequirements(!showRequirements)}
          // Apply ACHRAMS styling to button
          className="w-full flex items-center justify-between py-4 border-t border-b border-achrams-border text-achrams-text-primary hover:bg-achrams-bg-secondary transition-colors"
        >
          <span className="font-medium">Special requirements</span>
          {/* Use ChevronDown/Up instead of X for consistency */}
          {showRequirements ? <X className="w-5 h-5" /> : <span className="text-achrams-text-secondary">+ Add</span>}
        </button>
        {showRequirements && (
          <div className="space-y-3 py-4">
            <label className="flex items-center gap-3 p-3 bg-achrams-bg-secondary rounded-xl cursor-pointer border border-achrams-border">
              <input
                type="checkbox"
                checked={requirements.luggage}
                onChange={(e) => setRequirements({ ...requirements, luggage: e.target.checked })}
                className="w-5 h-5 text-achrams-primary-solid rounded focus:ring-achrams-primary-solid focus:ring-offset-0"
              />
              <Package className="w-5 h-5 text-achrams-text-secondary flex-shrink-0" />
              <span className="text-achrams-text-primary">Extra luggage</span>
            </label>
            <label className="flex items-center gap-3 p-3 bg-achrams-bg-secondary rounded-xl cursor-pointer border border-achrams-border">
              <input
                type="checkbox"
                checked={requirements.wheelchair}
                onChange={(e) => setRequirements({ ...requirements, wheelchair: e.target.checked })}
                className="w-5 h-5 text-achrams-primary-solid rounded focus:ring-achrams-primary-solid focus:ring-offset-0"
              />
              {/* Replaced emoji with Wheelchair icon */}
              <Accessibility className="w-5 h-5 text-achrams-text-secondary flex-shrink-0" />
              <span className="text-achrams-text-primary">Wheelchair accessible</span>
            </label>
            <label className="flex items-center gap-3 p-3 bg-achrams-bg-secondary rounded-xl cursor-pointer border border-achrams-border">
              <input
                type="checkbox"
                checked={requirements.elderly}
                onChange={(e) => setRequirements({ ...requirements, elderly: e.target.checked })}
                className="w-5 h-5 text-achrams-primary-solid rounded focus:ring-achrams-primary-solid focus:ring-offset-0"
              />
              <Users className="w-5 h-5 text-achrams-text-secondary flex-shrink-0" />
              <span className="text-achrams-text-primary">Elderly passenger</span>
            </label>
          </div>
        )}
        <button
          onClick={onRequestRide}
          disabled={!passengerData.name || !passengerData.phone || !passengerData.email}
          // Apply ACHRAMS gradient button styling
          className={`w-full py-4 rounded-xl font-semibold mt-6 transition-all ${
            passengerData.name && passengerData.phone && passengerData.email
              ? 'bg-achrams-gradient-primary text-achrams-text-light hover:opacity-90 active:scale-[0.98]' // Enabled state
              : 'bg-achrams-secondary-solid text-achrams-text-light opacity-75 cursor-not-allowed' // Disabled state
          }`}
        >
          {isLoading ? 'Requesting...': 'Request a ride'}
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/Enable2FAModal.tsx -----
// src/components/app/modals/Enable2FAModal.tsx
import { X, QrCode, Loader } from 'lucide-react';
import { useState, useEffect } from 'react';
import { apiClient } from '@/services/apiClient'; // Assuming you create this service

interface Enable2FAModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSuccess: () => void; // NEW: Callback after successful enablement
}

export default function Enable2FAModal({
  isOpen,
  onClose,
  onSuccess,
}: Enable2FAModalProps) {
  if (!isOpen) return null;

  // NEW: State for QR code data, OTP input, loading, error
  const [qrDataUrl, setQrDataUrl] = useState<string | null>(null);
  const [secret, setSecret] = useState<string | null>(null); // NEW: Store secret if needed for manual entry
  const [otp, setOtp] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);
  const [loadingSetup, setLoadingSetup] = useState(true); // NEW: Loading for initial setup

  // NEW: Fetch QR code and secret on modal open
  useEffect(() => {
    if (isOpen) {
      const fetchSetupData = async () => {
        setLoadingSetup(true);
        setError('');
        try {
          const response = await apiClient.post('/auth/passenger/2fa/setup'); // Use correct endpoint from Postman
          if (response.status === 200 && response.data && response.data.data) {
            setQrDataUrl(response.data.data.qr_code_url); // Adjust based on actual API response structure
            setSecret(response.data.data.secret); // Adjust based on actual API response structure
          } else {
            setError('Failed to get setup data. Please try again.');
          }
        } catch (err) {
          console.error("2FA Setup Error:", err);
          let errorMessage = 'An unexpected error occurred.';
          if (err instanceof Error) {
            errorMessage = err.message;
          }
          setError(errorMessage);
        } finally {
          setLoadingSetup(false);
        }
      };

      fetchSetupData();
    } else {
        // NEW: Reset state when modal closes
        setQrDataUrl(null);
        setSecret(null);
        setOtp('');
        setError('');
        setLoading(false);
        setLoadingSetup(false);
    }
  }, [isOpen]);


  const handleEnable = async () => {
    setError(''); // Clear previous errors
    if (!otp) {
      setError('Please enter the OTP from your authenticator app.');
      return;
    }

    setLoading(true);
    try {
      // NEW: Call the enable API using apiClient
      const response = await apiClient.post('/auth/passenger/2fa/enable', { // Use correct endpoint from Postman
        token: otp, // Or 'otp' depending on API expectation
      });

      console.log("2FA Enable Response:", response); // Debug log
      if (response.status === 200) { // Assuming 200 for success
        // NEW: On success, close modal and trigger success handler (e.g., update profile info in parent)
        onClose();
        onSuccess();
      } else {
          setError('Failed to enable 2FA. Please check the code and try again.');
      }
    } catch (err: any) {
        console.error("2FA Enable Error:", err);
        let errorMessage = 'An unexpected error occurred.';
        if (err.response && err.response.data && err.response.data.message) {
            errorMessage = err.response.data.message;
        } else if (err.message) {
            errorMessage = err.message;
        }
        setError(errorMessage);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-achrams-bg-primary bg-opacity-70 flex items-end z-50">
      <div className="bg-achrams-bg-primary w-full rounded-t-3xl p-6 animate-slideUp max-h-[85vh] overflow-y-auto border-t border-achrams-border">
        <div className="flex justify-between items-center mb-6">
          <h3 className="text-xl font-bold text-achrams-text-primary">Enable Two-Factor Authentication</h3>
          <button
            onClick={onClose}
            disabled={loading} // NEW: Disable close button while loading
            className="text-achrams-text-secondary hover:text-achrams-text-primary transition-colors disabled:opacity-50"
          >
            <X className="w-6 h-6" />
          </button>
        </div>

        {loadingSetup ? (
          <div className="flex flex-col items-center justify-center py-8">
            <Loader className="w-8 h-8 animate-spin text-achrams-primary-solid mb-4" />
            <p className="text-achrams-text-secondary">Setting up...</p>
          </div>
        ) : (
          <>
            <p className="text-achrams-text-secondary mb-6">
              Scan the QR code below with your authenticator app (like Google Authenticator or Authy) to link your account.
            </p>

            {qrDataUrl ? (
              <div className="flex flex-col items-center mb-6">
                <img src={qrDataUrl} alt="2FA QR Code" className="w-48 h-48 bg-achrams-bg-secondary p-4 rounded-lg border border-achrams-border" />
                {secret && (
                  <p className="text-xs text-achrams-text-tertiary mt-2">
                    Secret: <span className="font-mono">{secret}</span> (For manual entry if QR scan fails)
                  </p>
                )}
              </div>
            ) : (
              <p className="text-red-500 text-sm text-center mb-6">Failed to load QR code.</p>
            )}

            <input
              type="text"
              placeholder="Enter 6-digit code from app"
              value={otp}
              onChange={(e) => setOtp(e.target.value.replace(/\D/g, '').slice(0, 6))} // NEW: Allow only digits, max 6
              disabled={loading} // NEW: Disable input while loading
              className="w-full px-4 py-4 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border border-achrams-border mb-4"
            />

            {/* NEW: Error Message Display */}
            {error && (
              <p className="text-red-500 text-sm mb-4">{error}</p>
            )}

            <button
              onClick={handleEnable}
              disabled={loading || !otp} // NEW: Disable based on loading and OTP field
              className={`w-full py-4 rounded-xl font-semibold mb-3 transition-all ${
                loading || !otp
                  ? 'bg-achrams-secondary-solid text-achrams-text-light opacity-75 cursor-not-allowed'
                  : 'bg-achrams-gradient-primary text-achrams-text-light hover:opacity-90 active:scale-[0.98]'
              }`}
            >
              {loading ? ( // NEW: Show spinner while loading
                <div className="flex items-center justify-center">
                  <Loader className="w-5 h-5 animate-spin mr-2" />
                  Enabling...
                </div>
              ) : (
                'Enable 2FA'
              )}
            </button>
          </>
        )}

        <button
          onClick={onClose}
          disabled={loading} // NEW: Disable "Cancel" while loading
          className="w-full text-achrams-text-secondary font-medium hover:text-achrams-text-primary transition-colors disabled:opacity-50"
        >
          Cancel
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/PanicModal.tsx -----
// src/components/app/modals/PanicModal.tsx
import { AlertCircle, X, Check } from 'lucide-react';
import { useState } from 'react';

const panicOptions = [
  'Driver is behaving suspiciously',
  'Taking wrong route',
  'Uncomfortable with driver behavior',
  'Vehicle condition is unsafe',
  'Other emergency',
];

export default function PanicModal({
  isOpen,
  onClose,
  onComplete,
}: {
  isOpen: boolean;
  onClose: () => void;
  onComplete: () => void;
}) {
  const [selected, setSelected] = useState<string | null>(null);
  const [sent, setSent] = useState(false);

  if (!isOpen) return null;

  const handleSubmit = () => {
    if (selected) {
      setSent(true);
      setTimeout(() => {
        setSent(false);
        onComplete();
        onClose();
      }, 2000);
    }
  };

  if (sent) {
    return (
      <div className="fixed inset-0 bg-achrams-secondary-solid/50 flex items-end z-50 animate-fadeIn">
        <div className="bg-white w-full rounded-t-3xl p-6 animate-slideUp text-center">
          <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <Check className="w-8 h-8 text-green-600" />
          </div>
          <h3 className="text-xl font-bold mb-2">Alert Sent</h3>
          <p className="text-gray-600">Your message has been received and someone is looking into it.</p>
        </div>
      </div>
    );
  }

  return (
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 bg-opacity-50 flex items-end z-50 animate-fadeIn">
      <div className="bg-white w-full rounded-t-3xl p-6 animate-slideUp">
        <div className="flex items-center justify-between mb-6">
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
              <AlertCircle className="w-6 h-6 text-red-600" />
            </div>
            <h3 className="text-xl font-bold">Safety Alert</h3>
          </div>
          <button onClick={onClose}>
            <X className="w-6 h-6" />
          </button>
        </div>
        <p className="text-gray-600 mb-6">Select an issue to quickly send an alert</p>
        <div className="space-y-3">
          {panicOptions.map((option, idx) => (
            <button
              key={idx}
              onClick={() => setSelected(option)}
              className={`w-full text-left px-4 py-4 rounded-xl transition-all ${
                selected === option ? 'bg-red-50 border border-red-200' : 'bg-gray-50 hover:bg-gray-100'
              }`}
            >
              {option}
            </button>
          ))}
        </div>
        <button
          onClick={handleSubmit}
          disabled={!selected}
          className="w-full mt-6 py-4 bg-red-600 text-white rounded-xl font-semibold disabled:bg-gray-300"
        >
          Send Alert
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/RateModal.tsx -----
// src/components/app/modals/RateModal.tsx
import { X, Star, Check } from 'lucide-react';
import { useState } from 'react';

interface RateModalProps {
  isOpen: boolean;
  onClose: () => void;
  onRate: (score: number, comment: string) => void;
  driverName?: string;
  // NEW: Prop to update the parent's notification state
  setNotification: (notification: { message: string; type: 'info' | 'success' | 'warning' | 'error' } | null) => void;
}

export default function RateModal({
  isOpen,
  onClose,
  onRate,
  driverName = 'your driver',
  setNotification, // NEW: Destructure the new prop
}: RateModalProps) {
  const [rating, setRating] = useState(0);
  const [comment, setComment] = useState('');

  const handleSubmit = () => {
    if (rating > 0) {
      // NEW: Call the API/rate handling function passed from parent (e.g., page.tsx)
      onRate(rating, comment);

      // NEW: Close the modal
      onClose();

      // NEW: Set the success notification in the parent component via the prop
      setNotification({
        message: 'Thank you for your feedback!',
        type: 'success'
      });

      // NEW: Optionally, reset local state after submission
      // setRating(0); // Resetting rating might be confusing if the API call fails, so leaving it as is for now
      // setComment('');
    }
  };

  if (!isOpen) return null;

  return (
    <div className="fixed bg-achrams-secondary-solid/50 inset-0 bg-opacity-50 flex items-end z-50 animate-fadeIn ">
      <div className="bg-white w-full rounded-t-3xl p-6 animate-slideUp max-h-[85vh] overflow-y-auto">
        <div className="flex justify-between items-center mb-6">
          <h3 className="text-2xl font-bold">Rate {driverName}</h3>
          <button onClick={onClose}>
            <X className="w-6 h-6" />
          </button>
        </div>

        <div className="flex justify-center gap-2 mb-6">
          {[1, 2, 3, 4, 5].map((star) => (
            <button
              key={star}
              onClick={() => setRating(star)}
              className="transform hover:scale-110 transition"
            >
              <Star
                className={`w-12 h-12 ${
                  star <= rating
                    ? 'fill-yellow-400 text-yellow-400'
                    : 'text-gray-300'
                }`}
              />
            </button>
          ))}
        </div>

        <textarea
          placeholder="Share your experience (optional)"
          value={comment}
          onChange={(e) => setComment(e.target.value)}
          className="w-full px-4 py-3 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary resize-none mb-6 border border-achrams-border"
          rows={3}
        />

        <button
          onClick={handleSubmit}
          disabled={rating === 0}
          className="w-full bg-achrams-primary-solid text-achrams-text-light py-4 rounded-xl font-semibold disabled:bg-gray-300"
        >
          Submit
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/SignupPromptModal.tsx -----
// src/components/app/modals/SignupPromptModal.tsx
import { X, Loader } from 'lucide-react';
import { useState } from 'react';
// NEW: Import apiClient for registration call
import { apiClient } from '@/services/apiClient'; // Assuming you create this service

interface SignupPromptModalProps {
  isOpen: boolean;
  passengerData: { name: string; email: string; phone: string };
  onClose: () => void;
  // NEW: Prop to handle successful registration and navigation (e.g., to OTP modal)
  onRegistrationSuccess: (email: string) => void;
  // NEW: Prop to trigger opening the LoginModal from page.tsx
  onOpenLoginModal: () => void;
}

export default function SignupPromptModal({
  isOpen,
  passengerData,
  onClose,
  onRegistrationSuccess,
  onOpenLoginModal, // NEW: Destructure the new prop
}: SignupPromptModalProps) {
  if (!isOpen) return null;

  // NEW: Local state for password fields and loading/error
  const [password, setPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  const handleRegister = async () => {
    setError(''); // Clear previous errors
    if (!password || !confirmPassword) {
      setError('Please fill in all password fields.');
      return;
    }
    if (password !== confirmPassword) {
      setError('Passwords do not match.');
      return;
    }
    if (password.length < 8) { // Example validation
      setError('Password must be at least 8 characters long.');
      return;
    }

    setLoading(true);
    try {
      // NEW: Call the registration API using apiClient
      // Split name into first and last name for API
      const nameParts = passengerData.name.split(' ');
      const firstName = nameParts[0] || 'Guest';
      const lastName = nameParts.slice(1).join(' ') || 'User';

      const response = await apiClient.post('/auth/passenger/register', {
        email: passengerData.email,
        phone_number: passengerData.phone, // API expects phone_number
        first_name: firstName,
        last_name: lastName,
        password: password,
      });

      console.log("Registration Response:", response); // Debug log
      // NEW: Check response status/message if needed
      if (response.status === 201) { // Assuming 201 for success
        // NEW: On success, close modal and trigger success handler (e.g., open OTP modal)
        onRegistrationSuccess(passengerData.email);
      } else {
          setError('Registration failed. Please try again.');
      }
    } catch (err: any) {
        console.error("Registration Error:", err);
        // NEW: Handle different error types if possible
        let errorMessage = 'An unexpected error occurred.';
        if (err.response && err.response.data && err.response.data.message) {
            errorMessage = err.response.data.message;
        } else if (err.message) {
            errorMessage = err.message;
        }
        setError(errorMessage);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 bg-opacity-70 flex items-end z-50">
      <div className="bg-white w-full rounded-t-3xl p-6 animate-slideUp max-h-[85vh] overflow-y-auto border-t border-achrams-border">
        <div className="flex justify-between items-center mb-2">
          <h3 className="text-xl font-bold text-achrams-text-primary">Create your account</h3>
          <button
            onClick={onClose}
            disabled={loading} // NEW: Disable close button while loading
            className="text-achrams-text-secondary hover:text-achrams-text-primary transition-colors disabled:opacity-50"
          >
            <X className="w-6 h-6" />
          </button>
        </div>
        <p className="text-achrams-text-secondary mb-6">Sign up to save your trips and preferences</p>

        {/* Display passenger data */}
        <div className="space-y-4 mb-4"> {/* Added mb-4 for spacing before password fields */}
          <div className="w-full px-4 py-3 bg-achrams-bg-secondary rounded-xl border border-achrams-border">
            <div className="text-xs text-achrams-text-secondary mb-1">Full name</div>
            <div className="text-achrams-text-primary">{passengerData.name}</div>
          </div>
          <div className="w-full px-4 py-3 bg-achrams-bg-secondary rounded-xl border border-achrams-border">
            <div className="text-xs text-achrams-text-secondary mb-1">Email</div>
            <div className="text-achrams-text-primary">{passengerData.email}</div>
          </div>
          <div className="w-full px-4 py-3 bg-achrams-bg-secondary rounded-xl border border-achrams-border">
            <div className="text-xs text-achrams-text-secondary mb-1">Phone</div>
            <div className="text-achrams-text-primary">{passengerData.phone}</div>
          </div>
        </div>

        {/* NEW: Password Fields */}
        <div className="space-y-4">
          <input
            type="password"
            placeholder="Password"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            disabled={loading} // NEW: Disable input while loading
            className="w-full px-4 py-3 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border border-achrams-border"
          />
          <input
            type="password"
            placeholder="Confirm Password"
            value={confirmPassword}
            onChange={(e) => setConfirmPassword(e.target.value)}
            disabled={loading} // NEW: Disable input while loading
            className="w-full px-4 py-3 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border border-achrams-border"
          />
        </div>

        {/* NEW: Error Message Display */}
        {error && (
          <p className="text-red-500 text-sm mt-2">{error}</p>
        )}

        <button
          onClick={handleRegister}
          disabled={loading || !password || !confirmPassword} // NEW: Disable based on loading and password fields
          className={`w-full py-4 rounded-xl font-semibold mt-6 transition-all ${
            loading || !password || !confirmPassword
              ? 'bg-achrams-secondary-solid text-achrams-text-light opacity-75 cursor-not-allowed'
              : 'bg-achrams-gradient-primary text-achrams-text-light hover:opacity-90 active:scale-[0.98]'
          }`}
        >
          {loading ? ( // NEW: Show spinner while loading
            <div className="flex items-center justify-center">
              <Loader className="w-5 h-5 animate-spin mr-2" />
              Creating...
            </div>
          ) : (
            'Create account'
          )}
        </button>

        {/* NEW: Sign In Link */}
        <div className="mt-4 text-center">
          <button
            onClick={() => {
              onClose(); // Close this modal
              onOpenLoginModal(); // NEW: Call the handler passed from page.tsx to open the login modal
            }}
            className="text-sm text-achrams-primary-solid hover:underline"
          >
            Already have an account? Sign In
          </button>
        </div>

        <button
          onClick={onClose}
          disabled={loading} // NEW: Disable "Not now" while loading
          className="w-full mt-4 text-achrams-text-secondary font-medium hover:text-achrams-text-primary transition-colors disabled:opacity-50"
        >
          Not now
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/OTPModal.tsx -----
// src/components/app/modals/OTPModal.tsx
import { useState, useEffect, useRef } from 'react';
import { X, Check, MailCheck } from 'lucide-react'; // Added MailCheck icon

export default function OTPModal({
  isOpen,
  email,
  onComplete,
  onClose,
}: {
  isOpen: boolean;
  email: string;
  onComplete: () => void;
  onClose: () => void;
}) {
  const [otp, setOtp] = useState(['', '', '', '', '']);
  const [verified, setVerified] = useState(false);
  const inputRefs = useRef<(HTMLInputElement | null)[]>([]);

  useEffect(() => {
    if (isOpen) {
      setOtp(['', '', '', '', '']);
      setVerified(false); // Reset verified state when opening
    }
  }, [isOpen]);

  const handleOtpChange = (index: number, value: string) => {
    if (!/^\d*$/.test(value) || value.length > 1) return;
    const newOtp = [...otp];
    newOtp[index] = value;
    setOtp(newOtp);

    if (value && index < 4) {
      inputRefs.current[index + 1]?.focus();
    }

    if (newOtp.every((d) => d !== '') && newOtp.join('').length === 5) {
      setTimeout(() => {
        setVerified(true);
        setTimeout(() => {
          onComplete();
        }, 1000);
      }, 800);
    }
  };

  if (!isOpen) return null;

  if (verified) {
    return (
      // Verified state modal
      <div className="fixed inset-0 bg-achrams-secondary-solid/50 flex items-end z-50">
        <div className="bg-white w-full rounded-t-3xl p-6 animate-slideUp text-center border-t border-achrams-border">
          <div className="w-16 h-16 bg-achrams-bg-secondary rounded-full flex items-center justify-center mx-auto mb-4 border border-achrams-border">
            <Check className="w-8 h-8 text-achrams-primary-solid" />
          </div>
          <h3 className="text-xl font-bold mb-2 text-achrams-text-primary">Email verified!</h3>
          <p className="text-achrams-text-secondary">Setting up your account...</p>
        </div>
      </div>
    );
  }

  return (
    // Input state modal
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 flex items-end z-50">
      <div className="bg-white w-full rounded-t-3xl p-6 animate-slideUp border-t border-achrams-border">
        <div className="flex justify-between items-center mb-2">
          <h3 className="text-xl font-bold text-achrams-text-primary text-center  mx-auto" >Verify your email</h3>
          <button
            onClick={onClose}
            className="text-achrams-text-secondary hover:text-achrams-text-primary transition-colors"
          >
            <X className="w-6 h-6" />
          </button>
        </div>
        <p className="text-achrams-text-secondary mb-8 mx-auto w-fit">Enter the 5-digit code sent to <span className="font-medium text-achrams-text-primary">{email}</span></p>
        <div className="flex gap-3 justify-center mb-8">
          {otp.map((_, idx) => (
            <input
              key={idx}
              ref={(el) => (inputRefs.current[idx] = el)}
              type="text"
              inputMode="numeric" // Better for mobile numeric keyboards
              maxLength={1}
              value={otp[idx]}
              onChange={(e) => handleOtpChange(idx, e.target.value)}
              // Apply ACHRAMS styling to input
              className="w-14 h-14 text-center text-2xl font-bold bg-achrams-bg-secondary border-2 border-achrams-border rounded-xl outline-none text-achrams-text-primary focus:border-achrams-primary-solid focus:ring-1 focus:ring-achrams-primary-solid"
            />
          ))}
        </div>
        <button className="w-full text-center text-achrams-text-secondary font-medium hover:text-achrams-text-primary transition-colors">
          Resend code
        </button>
        <button
          onClick={onClose}
          className="w-full mt-3 text-sm text-achrams-text-secondary font-medium hover:text-achrams-text-primary transition-colors"
        >
          Cancel
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/MessageWindowModal.tsx -----
// src/components/app/modals/MessageWindowModal.tsx
import { X, Send } from 'lucide-react';
import { useState } from 'react';

interface MessageWindowModalProps {
  isOpen: boolean;
  onClose: () => void;
  recipientName: string;
}

export default function MessageWindowModal({
  isOpen,
  onClose,
  recipientName,
}: MessageWindowModalProps) {
  const [message, setMessage] = useState('');

  const sendMessage = () => {
    if (message.trim()) {
      // In real app: call /messages or WebSocket
      console.log('Message sent to', recipientName, ':', message);
      setMessage('');
    }
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 z-50 animate-fadeIn">
      <div className="h-full flex flex-col">
        <div className="bg-achrams-primary-solid text-white px-6 py-4 flex items-center justify-between">
          <h2 className="text-xl font-bold">Message {recipientName}</h2>
          <button onClick={onClose}>
            <X className="w-6 h-6" />
          </button>
        </div>

        <div className="flex-1 p-4 bg-gray-100 overflow-y-auto">
          {/* Example message history */}
          <div className="bg-white rounded-2xl p-4 mb-4 max-w-xs ml-auto">
            <p className="text-sm">Hi, Im outside!</p>
          </div>
          <div className="bg-gray-200 rounded-2xl p-4 mb-4 max-w-xs">
            <p className="text-sm">OK, coming down now.</p>
          </div>
        </div>

        <div className="p-4 border-t bg-white">
          <div className="flex gap-3">
            <input
              type="text"
              value={message}
              onChange={(e) => setMessage(e.target.value)}
              placeholder="Type a message..."
              className="flex-1 px-4 py-3 bg-gray-100 rounded-full outline-none"
              onKeyDown={(e) => e.key === 'Enter' && sendMessage()}
            />
            <button
              onClick={sendMessage}
              disabled={!message.trim()}
              className="p-3 bg-achrams-primary-solid text-white rounded-full disabled:opacity-50"
            >
              <Send className="w-5 h-5" />
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/LoginModal.tsx -----
// src/components/app/modals/LoginModal.tsx
import { X, Loader, Mail, Chrome, Eye, EyeOff } from 'lucide-react'; // Added Eye/EyeOff for password visibility
import { useState } from 'react';
// NEW: Import apiClient for login call, useAuth hook to update context
import { apiClient } from '@/services/apiClient'; // Assuming you create this service
import { useAuth } from '@/contexts/AuthContext'; // Assuming this context manages the token

interface LoginModalProps {
  isOpen: boolean;
  onClose: () => void;
  // NEW: Prop to handle successful login (e.g., update auth context, navigate to dashboard)
  onLoginSuccess: () => void;
}

export default function LoginModal({
  isOpen,
  onClose,
  onLoginSuccess,
}: LoginModalProps) {
  if (!isOpen) return null;

  const { login: updateAuthContext } = useAuth(); // NEW: Get login function from context

  // NEW: Local state for credentials, password visibility, loading, error
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [showPassword, setShowPassword] = useState(false); // NEW: State for password visibility
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);
  const [loadingGoogle, setLoadingGoogle] = useState(false); // NEW: Separate loading state for Google

  const handleLogin = async () => {
    setError(''); // Clear previous errors
    if (!email || !password) {
      setError('Please fill in all fields.');
      return;
    }

    setLoading(true);
    try {
      // NEW: Call the login API using apiClient
      const response = await apiClient.post('/auth/passenger/login', {
        email: email,
        password: password,
      });

      console.log("Login Response:", response); // Debug log
      // NEW: Check response status/message if needed
      if (response.status === 200 && response.data && response.data.data && response.data.data.token) {
        const token = response.data.data.token;
        // NEW: Update the AuthContext with the received token
        updateAuthContext(token); // This should trigger a re-render and potentially navigate to dashboard in page.tsx
        // NEW: Close the modal and trigger success handler in parent (page.tsx)
        onClose();
        onLoginSuccess(); // Parent (page.tsx) can handle navigation to dashboard
      } else {
          setError('Login failed. Please check your credentials.');
      }
    } catch (err: any) {
        console.error("Login Error:", err);
        // NEW: Handle different error types if possible
        let errorMessage = 'An unexpected error occurred.';
        if (err.response && err.response.data && err.response.data.message) {
            errorMessage = err.response.data.message;
        } else if (err.message) {
            errorMessage = err.message;
        }
        setError(errorMessage);
    } finally {
      setLoading(false);
    }
  };

  // NEW: Placeholder for Google login function
  const handleGoogleLogin = () => {
      setLoadingGoogle(true);
      // Simulate Google login process (replace with actual Google SDK call)
      setTimeout(() => {
          setLoadingGoogle(false);
          // On successful Google login, you would receive a token or user info
          // You might need to link this Google account to your backend or create a new user
          // For now, let's assume a token is obtained and context is updated
          // updateAuthContext('MOCK_GOOGLE_TOKEN'); // Replace with real token
          // onClose();
          // onLoginSuccess();
          alert('Google login functionality would be implemented here using Google SDK.');
      }, 2000); // Simulate 2s delay
  };

  return (
    <div className="fixed inset-0 bg-achrams-bg-primary bg-opacity-70 flex items-end z-50">
      <div className="bg-achrams-bg-primary w-full rounded-t-3xl p-6 animate-slideUp max-h-[85vh] overflow-y-auto border-t border-achrams-border">
        <div className="flex justify-between items-center mb-2">
          <h3 className="text-xl font-bold text-achrams-text-primary">Sign In to your account</h3>
          <button
            onClick={onClose}
            disabled={loading || loadingGoogle} // NEW: Disable close button while loading
            className="text-achrams-text-secondary hover:text-achrams-text-primary transition-colors disabled:opacity-50"
          >
            <X className="w-6 h-6" />
          </button>
        </div>

        {/* NEW: Email/Password Login Form */}
        <div className="space-y-4 mb-6">
          <div className="relative">
            <Mail className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-achrams-text-secondary" />
            <input
              type="email"
              placeholder="Email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              disabled={loading || loadingGoogle} // NEW: Disable input while loading
              className="w-full pl-10 pr-4 py-3 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border border-achrams-border"
            />
          </div>
          <div className="relative">
            <input
              type={showPassword ? "text" : "password"} // NEW: Toggle input type
              placeholder="Password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              disabled={loading || loadingGoogle} // NEW: Disable input while loading
              className="w-full px-4 py-3 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border border-achrams-border pr-10" // Added pr-10 for eye button
            />
            <button // NEW: Toggle password visibility
              type="button"
              onClick={() => setShowPassword(!showPassword)}
              className="absolute right-3 top-1/2 transform -translate-y-1/2 text-achrams-text-secondary hover:text-achrams-text-primary"
            >
              {showPassword ? <EyeOff className="w-5 h-5" /> : <Eye className="w-5 h-5" />}
            </button>
          </div>
        </div>

        {/* NEW: Error Message Display */}
        {error && (
          <p className="text-red-500 text-sm mb-4">{error}</p>
        )}

        <button
          onClick={handleLogin}
          disabled={loading || loadingGoogle || !email || !password} // NEW: Disable based on loading and fields
          className={`w-full py-4 rounded-xl font-semibold mb-4 transition-all ${
            loading || loadingGoogle || !email || !password
              ? 'bg-achrams-secondary-solid text-achrams-text-light opacity-75 cursor-not-allowed'
              : 'bg-achrams-gradient-primary text-achrams-text-light hover:opacity-90 active:scale-[0.98]'
          }`}
        >
          {loading ? ( // NEW: Show spinner while loading
            <div className="flex items-center justify-center">
              <Loader className="w-5 h-5 animate-spin mr-2" />
              Signing In...
            </div>
          ) : (
            'Sign In'
          )}
        </button>

        {/* NEW: Google Login Button */}
        <button
          onClick={handleGoogleLogin}
          disabled={loading || loadingGoogle} // NEW: Disable Google button while any loading happens
          className={`w-full py-3 rounded-xl font-medium mb-4 transition-colors flex items-center justify-center gap-2 ${
            loadingGoogle
              ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
              : 'bg-white text-gray-800 border border-gray-300 hover:bg-gray-100'
          }`}
        >
          {loadingGoogle ? ( // NEW: Show spinner for Google
            <div className="flex items-center justify-center">
              <Loader className="w-5 h-5 animate-spin mr-2" />
              Signing In...
            </div>
          ) : (
            <>
              <Chrome className="w-5 h-5" />
              Sign In with Google
            </>
          )}
        </button>

        {/* NEW: Sign Up Link */}
        <div className="mt-4 text-center">
          <button
            onClick={() => {
              onClose(); // Close this modal
              // Assuming page.tsx will handle opening the signup prompt modal via a state prop
              // e.g., if page.tsx passes onOpenSignupPrompt prop:
              // onOpenSignupPrompt();
            }}
            className="text-sm text-achrams-primary-solid hover:underline"
          >
            Don't have an account? Sign Up
          </button>
        </div>

        <button
          onClick={onClose}
          disabled={loading || loadingGoogle} // NEW: Disable "Cancel" while loading
          className="w-full mt-4 text-achrams-text-secondary font-medium hover:text-achrams-text-primary transition-colors disabled:opacity-50"
        >
          Cancel
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/TripRequestStatusModal.tsx -----
// src/components/app/modals/TripRequestStatusModal.tsx
import { X, AlertCircle, CheckCircle, Loader } from 'lucide-react';

interface TripRequestStatusModalProps {
  isOpen: boolean;
  onClose: () => void;
  status: 'loading' | 'accepted' | 'no-driver' | 'error' | null;
  message?: string | null; // Optional custom message
  onConfirm?: () => void
}

export default function TripRequestStatusModal({
  isOpen,
  onClose,
  status,
  message,
  onConfirm,
}: TripRequestStatusModalProps) {
  if (!isOpen || !status) return null;

  let icon = null;
  let title = '';
  let description = '';
  let buttonText = 'OK';

  switch (status) {
    case 'loading':
      icon = <Loader className="w-8 h-8 animate-spin text-achrams-primary-solid" />;
      title = 'Finding a Driver...';
      description = 'Please wait while we connect you with a driver.';
      buttonText = 'Cancel'; // Or handle cancellation differently if needed
      break;
    case 'accepted':
      icon = <CheckCircle className="w-8 h-8 text-green-500" />;
      title = 'Driver Found!';
      description = message || 'Your ride has been confirmed.';
      buttonText = 'View Details';
      break;
    case 'no-driver':
      icon = <AlertCircle className="w-8 h-8 text-yellow-500" />;
      title = 'No Drivers Available';
      description = message || 'We couldn\'t find a driver at the moment. Please try again later.';
      buttonText = 'Try Again';
      break;
    case 'error':
      icon = <AlertCircle className="w-8 h-8 text-red-500" />;
      title = 'Something Went Wrong';
      description = message || 'An error occurred while processing your request. Please check your connection and try again.';
      buttonText = 'Retry';
      break;
  }

  return (
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 bg-opacity-70 flex items-end z-100">
      <div className="bg-white w-full rounded-t-3xl p-6 animate-slideUp max-h-[85vh] overflow-y-auto border-t border-achrams-border">
        <div className="flex justify-between items-center mb-6">
          <h3 className="text-xl font-bold text-achrams-text-primary">{title}</h3>
          <button
            onClick={onClose}
            className="text-achrams-text-secondary hover:text-achrams-text-primary transition-colors"
          >
            <X className="w-6 h-6" />
          </button>
        </div>
        <div className="flex flex-col items-center gap-4 mb-6">
          {icon}
          <p className="text-center text-achrams-text-secondary">{description}</p>
        </div>
        <button
          onClick={() => {
            if (status === 'accepted') {
              // The parent (page.tsx) handles the transition after 'accepted' status is set
              onClose(); // Close the modal
            } else if (status === 'no-driver' || status === 'error') {
              // Retry logic or close - in this mock, just 
              if (onConfirm) {onConfirm()} else onClose();
            } else onClose();
          }}
          className={`w-full py-4 rounded-xl font-semibold transition-all ${
            status === 'accepted'
              ? 'bg-achrams-gradient-primary text-achrams-text-light hover:opacity-90 active:scale-[0.98]'
              : 'bg-achrams-secondary-solid text-achrams-text-light hover:bg-achrams-secondary-solid/90'
          }`}
        >
          {buttonText}
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/DirectionsModal.tsx -----
// // src/components/app/modals/DirectionsModal.tsx
import { X } from 'lucide-react';
import { GoogleMap, Marker, DirectionsRenderer, useJsApiLoader } from '@react-google-maps/api'; // NEW: Import DirectionsRenderer
import {useState, useEffect} from 'react';
interface DirectionsModalProps {
  isOpen: boolean;
  onClose: () => void;
  pickup: string;
  pickupCoords?: [number, number] | null;
  destination: string; // NEW
  destinationCoords?: [number, number] | null; // NEW
}

// NEW: Define map container style
const mapContainerStyle = {
  width: '100%',
  height: '100%',
};

// NEW: Optional: Set a default center if no coordinates are provided
const defaultCenter = {
  lat: 6.5244, // Example: Lagos approximate center
  lng: 3.3792,
};

export default function DirectionsModal({
  isOpen,
  onClose,
  pickup,
  pickupCoords,
  destination, // NEW: Destructure the new prop
  destinationCoords, // NEW: Destructure the new prop
}: DirectionsModalProps) {
  if (!isOpen) return null;

  // NEW: Load the Google Maps API script
  const { isLoaded, loadError } = useJsApiLoader({
    id: 'google-map-script',
    // Ensure you have this in your .env.local
    googleMapsApiKey: process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY!,
  });

  // NEW: State for directions result
  const [directions, setDirections] = useState<google.maps.DirectionsResult | null>(null);
  const [directionsError, setDirectionsError] = useState<string | null>(null);

  // NEW: Calculate directions when both pickup and destination coords are available
  useEffect(() => {
    if (isLoaded && pickupCoords && destinationCoords) {
      const directionsService = new google.maps.DirectionsService();
      const request: google.maps.DirectionsRequest = {
        origin: { lat: pickupCoords[1], lng: pickupCoords[0] }, // [lng, lat] to {lat, lng}
        destination: { lat: destinationCoords[1], lng: destinationCoords[0] }, // [lng, lat] to {lat, lng}
        travelMode: google.maps.TravelMode.DRIVING,
      };

      directionsService.route(request, (result, status) => {
        if (status === "OK" && result) {
          setDirections(result);
          setDirectionsError(null);
        } else {
          console.error("Directions request failed due to " + status);
          setDirections(null);
          setDirectionsError("Could not calculate directions.");
        }
      });
    } else {
        setDirections(null); // Reset if coords are missing
        setDirectionsError(null);
    }
  }, [isLoaded, pickupCoords, destinationCoords]);

  // NEW: Determine map center based on available coordinates (could be pickup, destination, or midpoint)
  // For simplicity, using pickup if available, otherwise destination, otherwise default
  let mapCenter = defaultCenter;
  if (pickupCoords) {
      mapCenter = { lat: pickupCoords[1], lng: pickupCoords[0] };
  } else if (destinationCoords) {
      mapCenter = { lat: destinationCoords[1], lng: destinationCoords[0] };
  }


  // NEW: Handle loading/error states for the script
  if (loadError) {
    return (
      <div className="fixed inset-0 bg-achrams-bg-primary z-50 flex items-center justify-center">
        <p className="text-achrams-text-secondary">Error loading map: {loadError.message}</p>
      </div>
    );
  }

  return (
    // NEW: Apply ACHRAMS bg color
    <div className="fixed inset-0 bg-achrams-bg-primary z-50" suppressHydrationWarning={true}>
      <div className="h-full flex flex-col">
        {/* NEW: Apply ACHRAMS header styling */}
        <div className="bg-achrams-primary-solid text-achrams-text-light px-6 py-4 flex items-center justify-between">
          <h2 className="text-xl font-bold">Directions to Pickup</h2>
          <button
            onClick={onClose}
            className="text-achrams-text-light hover:text-achrams-text-light/80 transition-colors"
          >
            <X className="w-6 h-6" />
          </button>
        </div>

        {/* NEW: Map Container */}
        <div className="flex-1 relative">
          {isLoaded ? (
            <GoogleMap
              mapContainerStyle={mapContainerStyle}
              center={mapCenter}
              zoom={12} // Adjust zoom level as needed, maybe fitBounds later
              options={{
                // Optional: Disable default UI elements for a cleaner look
                // mapTypeControl: false,
                // streetViewControl: false,
                // fullscreenControl: false,
                // zoomControl: false,
                // Add other map options as needed
              }}
            >
              {/* NEW: Add marker for pickup location if coordinates are available */}
              {pickupCoords && (
                <Marker
                  position={{ lat: pickupCoords[1], lng: pickupCoords[0] }}
                  // Optional: Customize marker icon
                  // icon={...}
                  title={`Pickup: ${pickup}`}
                />
              )}
              {/* NEW: Add marker for destination location if coordinates are available */}
              {destinationCoords && (
                <Marker
                  position={{ lat: destinationCoords[1], lng: destinationCoords[0] }}
                  // Optional: Customize marker icon
                  // icon={...}
                  title={`Destination: ${destination}`}
                />
              )}
              {/* NEW: Render directions if available */}
              {directions && <DirectionsRenderer directions={directions} />}
              {/* NEW: Display error if directions failed */}
              {directionsError && (
                 <div className="absolute top-4 left-4 bg-red-100 text-red-800 p-2 rounded">
                    {directionsError}
                 </div>
              )}
            </GoogleMap>
          ) : (
            // NEW: Fallback while loading or if failed to load
            <div className="absolute inset-0 flex items-center justify-center bg-achrams-bg-secondary">
              <p className="text-achrams-text-secondary">Loading map...</p>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}


// src/components/app/modals/DirectionsModal.tsx
// import { X } from 'lucide-react';
// // NEW: Import the wrapper component
// import DirectionsMapWrapper from './DirectionsMapWrapper'; // Adjust path if necessary

// interface DirectionsModalProps {
//   isOpen: boolean;
//   onClose: () => void;
//   pickup: string;
//   pickupCoords?: [number, number] | null;
//   destination: string;
//   destinationCoords?: [number, number] | null;
// }

// export default function DirectionsModal({
//   isOpen,
//   onClose,
//   pickup,
//   pickupCoords,
//   destination,
//   destinationCoords,
// }: DirectionsModalProps) {
//   if (!isOpen) return null;

//   return (
//     <div className="fixed inset-0 bg-achrams-bg-primary z-50">
//       <div className="h-full flex flex-col">
//         <div className="bg-achrams-primary-solid text-achrams-text-light px-6 py-4 flex items-center justify-between">
//           <h2 className="text-xl font-bold">Directions to Pickup</h2>
//           <button onClick={onClose}>
//             <X className="w-6 h-6" />
//           </button>
//         </div>
//         {/* NEW: Use the wrapper component */}
//         <DirectionsMapWrapper
//           pickup={pickup}
//           destination={destination}
//           pickupCoords={pickupCoords || null}
//           destinationCoords={destinationCoords || null}
//         />
//       </div>
//     </div>
//   );
// }

----- FILE: src/components/app/modals/DriverVerificationModal.tsx -----
// src/components/app/modals/DriverVerificationModal.tsx
import { Shield, Check } from 'lucide-react';

interface DriverVerificationModalProps {
  isOpen: boolean;
  onClose: () => void;
  securityCode: string; // Pass the code from parent
}

export default function DriverVerificationModal({
  isOpen,
  onClose,
  securityCode,
}: DriverVerificationModalProps) {
  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 flex items-end z-50">
      <div className="bg-white w-full rounded-t-3xl p-6 animate-slideUp max-h-[85vh] overflow-y-auto  shadow-sm">
        <div className="flex justify-center mb-6">
          <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center text-green-600">
            <Shield className="w-8 h-8" />
          </div>
        </div>
        <div className="text-center mb-6">
          <h3 className="text-xl font-bold text-achrams-text-primary">Verify Your Driver</h3>
          <p className="text-achrams-text-secondary mt-2">Share this code with your driver to confirm their identity</p>
        </div>
        <div className="bg-achrams-bg-secondary rounded-xl p-4 mb-6 text-center">
          <div className="text-xs text-achrams-text-secondary mb-2">SECURITY CODE</div>
          <div className="text-4xl font-bold text-achrams-text-primary">{securityCode}</div>
        </div>
        <button
          onClick={onClose}
          className="w-full py-4 rounded-xl font-semibold bg-achrams-gradient-primary text-achrams-text-light hover:opacity-90 active:scale-[0.98] transition-all"
        >
          OK
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/OutsideServiceAreaModal.tsx -----
// src/components/app/modals/OutsideServiceAreaModal.tsx
import { X } from 'lucide-react';

interface OutsideServiceAreaModalProps {
  isOpen: boolean;
  onClose: () => void; // Allows closing the modal
}

export default function OutsideServiceAreaModal({
  isOpen,
  onClose,
}: OutsideServiceAreaModalProps) {
  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 bg-opacity-70 flex items-end z-100">
      <div className="bg-white w-full rounded-t-3xl p-6 animate-slideUp max-h-[85vh] overflow-y-auto border-t border-achrams-border">
        <div className="flex justify-between items-center mb-6">
          <h3 className="text-xl font-bold text-achrams-text-primary">Service Area Limitation</h3>
          <button
            onClick={onClose}
            className="text-achrams-text-secondary hover:text-achrams-text-primary transition-colors"
          >
            <X className="w-6 h-6" />
          </button>
        </div>
        <div className="flex flex-col items-center gap-4 mb-6">
          <p className="text-center text-achrams-text-secondary">
            You are currently outside our service area. Booking is not available from this location.
          </p>
        </div>
        <button
          onClick={onClose} // Close the modal when OK is clicked
          className={`w-full py-4 rounded-xl font-semibold transition-all bg-achrams-gradient-primary text-achrams-text-light hover:opacity-90 active:scale-[0.98]`}
        >
          OK
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/CancelModal.tsx -----
// src/components/app/modals/CancelModal.tsx
import { X, MapPin } from 'lucide-react';
import { useState } from 'react';

const cancelReasons = [
  'Driver is taking too long',
  'Changed my mind',
  'Found another ride',
  'Driver is unprofessional',
  'Other'
];

interface CancelModalProps {
  isOpen: boolean;
  onClose: () => void;
  onConfirm: (reason: string, location?: [number, number], address?: string) => void;
  pickupAddress?: string;
}

export default function CancelModal({
  isOpen,
  onClose,
  onConfirm,
  pickupAddress,
}: CancelModalProps) {
  const [selectedReason, setSelectedReason] = useState<string | null>(null);
  const [otherReason, setOtherReason] = useState('');

  const handleConfirm = () => {
    const reason = selectedReason === 'Other' ? otherReason : selectedReason;
    if (reason) {
      // In real app, get current coordinates via Geolocation
      onConfirm(reason, undefined, pickupAddress);
    }
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 flex items-end z-50 animate-fadeIn">
      <div className="bg-white w-full rounded-t-3xl p-6 animate-slideUp max-h-[85vh] overflow-y-auto">
        <div className="flex justify-between items-center mb-6">
          <h3 className="text-2xl font-bold">Cancel trip</h3>
          <button onClick={onClose}>
            <X className="w-6 h-6" />
          </button>
        </div>

        <p className="text-gray-600 mb-6">Why do you want to cancel?</p>

        <div className="space-y-3 mb-6">
          {cancelReasons.map((reason, idx) => (
            <button
              key={idx}
              onClick={() => setSelectedReason(reason)}
              className={`w-full text-left px-4 py-4 rounded-xl transition-all ${
                selectedReason === reason
                  ? 'bg-achrams-primary-solid text-white'
                  : 'bg-gray-50 hover:bg-gray-100'
              }`}
            >
              {reason}
            </button>
          ))}
        </div>

        {selectedReason === 'Other' && (
          <div className="mb-6">
            <textarea
              placeholder="Please specify..."
              value={otherReason}
              onChange={(e) => setOtherReason(e.target.value)}
              className="w-full px-4 py-3 bg-gray-50 rounded-xl outline-none resize-none"
              rows={2}
            />
          </div>
        )}

        {pickupAddress && (
          <div className="flex items-center gap-3 mb-6 p-4 bg-gray-50 rounded-xl">
            <MapPin className="w-5 h-5 text-gray-600 flex-shrink-0" />
            <span className="text-sm">{pickupAddress}</span>
          </div>
        )}

        <button
          onClick={handleConfirm}
          disabled={!selectedReason || (selectedReason === 'Other' && !otherReason.trim())}
          className="w-full bg-red-600 text-white py-4 rounded-xl font-semibold disabled:bg-gray-300"
        >
          Confirm cancellation
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/Disable2FAModal.tsx -----
// src/components/app/modals/Disable2FAModal.tsx
import { X, ShieldAlert, Loader } from 'lucide-react';
import { useState } from 'react';
import { apiClient } from '@/services/apiClient'; // Assuming you create this service

interface Disable2FAModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSuccess: () => void; // NEW: Callback after successful disable
}

export default function Disable2FAModal({
  isOpen,
  onClose,
  onSuccess,
}: Disable2FAModalProps) {
  if (!isOpen) return null;

  // NEW: State for OTP input, loading, error
  const [otp, setOtp] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  const handleDisable = async () => {
    setError(''); // Clear previous errors
    if (!otp) {
      setError('Please enter the OTP from your authenticator app.');
      return;
    }

    setLoading(true);
    try {
      // NEW: Call the disable API using apiClient
      // The exact endpoint might vary (e.g., POST /auth/passenger/2fa/disable, DELETE /auth/passenger/2fa, or PUT/PATCH with flag)
      // Check passenger postman DOC.txt for the correct endpoint.
      // Example: Assuming POST /auth/passenger/2fa/disable
      const response = await apiClient.post('/auth/passenger/2fa/disable', { // Use correct endpoint from Postman
        token: otp, // Or 'otp' depending on API expectation
      });

      console.log("2FA Disable Response:", response); // Debug log
      if (response.status === 200) { // Assuming 200 for success
        // NEW: On success, close modal and trigger success handler (e.g., update profile info in parent)
        onClose();
        onSuccess();
      } else {
          setError('Failed to disable 2FA. Please check the code and try again.');
      }
    } catch (err: any) {
        console.error("2FA Disable Error:", err);
        let errorMessage = 'An unexpected error occurred.';
        if (err.response && err.response.data && err.response.data.message) {
            errorMessage = err.response.data.message;
        } else if (err.message) {
            errorMessage = err.message;
        }
        setError(errorMessage);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-achrams-bg-primary bg-opacity-70 flex items-end z-50">
      <div className="bg-achrams-bg-primary w-full rounded-t-3xl p-6 animate-slideUp max-h-[85vh] overflow-y-auto border-t border-achrams-border">
        <div className="flex justify-between items-center mb-6">
          <h3 className="text-xl font-bold text-achrams-text-primary">Disable Two-Factor Authentication</h3>
          <button
            onClick={onClose}
            disabled={loading} // NEW: Disable close button while loading
            className="text-achrams-text-secondary hover:text-achrams-text-primary transition-colors disabled:opacity-50"
          >
            <X className="w-6 h-6" />
          </button>
        </div>

        <div className="flex items-center gap-3 p-4 bg-achrams-bg-secondary rounded-xl border border-achrams-border mb-6">
          <ShieldAlert className="w-6 h-6 text-achrams-warning-dark flex-shrink-0" />
          <p className="text-achrams-text-secondary text-sm">
            Disabling 2FA reduces the security of your account. Are you sure you want to proceed?
          </p>
        </div>

        <input
          type="text"
          placeholder="Enter 6-digit code from app"
          value={otp}
          onChange={(e) => setOtp(e.target.value.replace(/\D/g, '').slice(0, 6))} // NEW: Allow only digits, max 6
          disabled={loading} // NEW: Disable input while loading
          className="w-full px-4 py-4 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border border-achrams-border mb-4"
        />

        {/* NEW: Error Message Display */}
        {error && (
          <p className="text-red-500 text-sm mb-4">{error}</p>
        )}

        <button
          onClick={handleDisable}
          disabled={loading || !otp} // NEW: Disable based on loading and OTP field
          className={`w-full py-4 rounded-xl font-semibold mb-3 transition-all ${
            loading || !otp
              ? 'bg-achrams-secondary-solid text-achrams-text-light opacity-75 cursor-not-allowed'
              : 'bg-red-600 text-achrams-text-light hover:opacity-90 active:scale-[0.98]'
          }`}
        >
          {loading ? ( // NEW: Show spinner while loading
            <div className="flex items-center justify-center">
              <Loader className="w-5 h-5 animate-spin mr-2" />
              Disabling...
            </div>
          ) : (
            'Disable 2FA'
          )}
        </button>

        <button
          onClick={onClose}
          disabled={loading} // NEW: Disable "Cancel" while loading
          className="w-full text-achrams-text-secondary font-medium hover:text-achrams-text-primary transition-colors disabled:opacity-50"
        >
          Cancel
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/AirportSelectionModal.tsx -----
// src/components/app/modals/AirportSelectionModal.tsx
import { X } from 'lucide-react';
import { Airport } from '@/lib/airports'; // Assuming this is your Airport type from src/lib/airports.ts

interface AirportSelectionModalProps {
  isOpen: boolean;
  onClose: () => void;
  airports: Airport[]; // List of airports returned by the API
  onSelect: (airport: Airport) => void; // Callback when an airport is selected
}

export default function AirportSelectionModal({
  isOpen,
  onClose,
  airports,
  onSelect,
}: AirportSelectionModalProps) {
  if (!isOpen || airports.length === 0) return null;

  return (
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 bg-opacity-70 flex items-end z-100">
      <div className="bg-white w-full rounded-t-3xl p-6 animate-slideUp max-h-[85vh] overflow-y-auto border-t border-achrams-border">
        <div className="flex justify-between items-center mb-6">
          <h3 className="text-xl font-bold text-achrams-text-primary">Select Airport</h3>
          <button
            onClick={onClose}
            className="text-achrams-text-secondary hover:text-achrams-text-primary transition-colors"
          >
            <X className="w-6 h-6" />
          </button>
        </div>
        <div className="flex flex-col gap-2">
          {airports.map((airport) => (
            <button
              key={airport.id}
              onClick={() => {
                onSelect(airport); // Pass the selected airport back to the parent
                onClose(); // Close the modal
              }}
              className="w-full px-4 py-3 flex items-start gap-3 hover:bg-achrams-bg-secondary border border-achrams-border rounded-lg text-left transition-colors"
            >
              <div className="mt-0.5">
                {/* You could add an icon here if needed */}
              </div>
              <div>
                <div className="font-medium text-achrams-text-primary text-sm">{airport.name}</div>
                <div className="text-xs text-achrams-text-secondary">{airport.codename}</div>
              </div>
            </button>
          ))}
        </div>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/DirectionsMapWrapper.tsx -----
// src/components/app/modals/DirectionsMapWrapper.tsx
import { GoogleMap, Marker, useJsApiLoader } from '@react-google-maps/api';
import { useEffect, useState } from 'react';

interface DirectionsMapWrapperProps {
  pickupCoords: [number, number] | null;
  destinationCoords: [number, number] | null;
  pickup: string; // For display
  destination: string; // For display
  // Add any other props needed specifically for map rendering
}

const DirectionsMapWrapper: React.FC<DirectionsMapWrapperProps> = ({
  pickupCoords,
  destinationCoords,
  pickup,
  destination,
}) => {
  // NEW: State to ensure map renders only after mount
  const [hasMounted, setHasMounted] = useState(false);

  useEffect(() => {
    // NEW: Set mounted state after the first render
    setHasMounted(true);
  }, []);

  // NEW: Load Google Maps API only if mounted
  const { isLoaded, loadError } = useJsApiLoader({
    id: 'google-map-script-directions',
    googleMapsApiKey: process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY!,
    // NEW: Skip loading if not mounted yet
    skip: !hasMounted,
  });

  // NEW: Determine map center - prioritize pickup, then destination, then default
  let mapCenter = { lat: 6.5244, lng: 3.3792 }; // Default
  if (pickupCoords) {
    mapCenter = { lat: pickupCoords[1], lng: pickupCoords[0] };
  } else if (destinationCoords) {
    mapCenter = { lat: destinationCoords[1], lng: destinationCoords[0] };
  }

  // NEW: If not mounted, return a placeholder
  if (!hasMounted) {
    return <div className="absolute inset-0 flex items-center justify-center bg-achrams-bg-secondary"><p className="text-achrams-text-secondary">Loading map...</p></div>;
  }

  if (loadError) {
    return (
      <div className="absolute inset-0 flex items-center justify-center bg-achrams-bg-secondary">
        <p className="text-achrams-text-secondary">Error loading map: {loadError.message}</p>
      </div>
    );
  }

  return (
    <div className="flex-1 relative">
      {isLoaded ? (
        <GoogleMap
          mapContainerStyle={{ width: '100%', height: '100%' }}
          center={mapCenter}
          zoom={14}
          options={{
            // Optional: Disable default UI elements for a cleaner look
            // mapTypeControl: false,
            // streetViewControl: false,
            // fullscreenControl: false,
            // zoomControl: false,
            // Add other map options as needed
          }}
        >
          {/* Pickup Marker */}
          {pickupCoords && (
            <Marker
              position={{ lat: pickupCoords[1], lng: pickupCoords[0] }}
              // FIXED: Removed trailing spaces from URL
              icon={{ url: 'https://maps.google.com/mapfiles/ms/micons/green-dot.png', scaledSize: new window.google.maps.Size(32, 32) }}
              title="Pickup Location"
            />
          )}
          {/* Destination Marker */}
          {destinationCoords && (
            <Marker
              position={{ lat: destinationCoords[1], lng: destinationCoords[0] }}
              // FIXED: Removed trailing spaces from URL
              icon={{ url: 'https://maps.google.com/mapfiles/ms/micons/red-dot.png', scaledSize: new window.google.maps.Size(32, 32) }}
              title="Destination"
            />
          )}
        </GoogleMap>
      ) : (
        <div className="absolute inset-0 flex items-center justify-center bg-achrams-bg-secondary">
          <p className="text-achrams-text-secondary">Loading map...</p>
        </div>
      )}
    </div>
  );
};

export default DirectionsMapWrapper;

----- FILE: src/components/app/ui/BottomNavBar.tsx -----
// src/components/app/ui/BottomNavBar.tsx
import { House, Search, Wallet, User } from 'lucide-react';
import { usePathname, useRouter } from 'next/navigation'; // Or your routing library

interface BottomNavBarProps {
  onProfileClick: () => void; // Handler to open profile modal/settings
  walletBalance?: number; // Optional: Display small badge/indicator on wallet icon
  // NEW: Add handlers for other nav items if needed, e.g., onHomeClick, onSearchClick, onWalletClick
  onHomeClick?: () => void;
  onSearchClick?: () => void;
  onWalletClick?: () => void;
}

export default function BottomNavBar({
  onProfileClick,
  walletBalance,
  onHomeClick,
  onSearchClick,
  onWalletClick,
}: BottomNavBarProps) {
  const pathname = usePathname();
  const router = useRouter();

  // Helper to determine if a nav item is active
  const isActive = (path: string) => pathname === path;

  // Handlers for navigation clicks
  const handleHomeClick = () => {
    if (onHomeClick) {
      onHomeClick(); // Allow parent to handle logic (e.g., scroll to top)
    } else {
      // Default behavior: navigate to dashboard if not already there
      if (pathname !== '/dashboard') {
        router.push('/dashboard');
      } else {
        // If already on dashboard, maybe scroll to top
        window.scrollTo(0, 0);
      }
    }
  };

  const handleSearchClick = () => {
    if (onSearchClick) {
      onSearchClick();
    } else {
      // Navigate to search screen - placeholder path
      router.push('/search'); // Replace with actual search screen path
    }
  };

  const handleWalletClick = () => {
    if (onWalletClick) {
      onWalletClick();
    } else {
      // Navigate to wallet screen - placeholder path
      router.push('/wallet'); // Replace with actual wallet screen path
    }
  };

  return (
    <nav className="fixed bottom-0 left-0 right-0 bg-achrams-bg-primary border-t border-achrams-border z-40">
      <div className="flex justify-around items-center py-3 px-2">
        <button
          onClick={handleHomeClick}
          className={`flex flex-col items-center justify-center gap-1 p-2 rounded-lg transition-colors ${
            isActive('/dashboard') ? 'text-achrams-primary-solid' : 'text-achrams-text-secondary'
          }`}
        >
          <House className={`w-6 h-6 ${isActive('/dashboard') ? 'fill-current' : ''}`} />
          <span className="text-xs">Home</span>
        </button>
        <button
          onClick={handleSearchClick}
          className={`flex flex-col items-center justify-center gap-1 p-2 rounded-lg transition-colors ${
            isActive('/search') ? 'text-achrams-primary-solid' : 'text-achrams-text-secondary'
          }`}
        >
          <Search className={`w-6 h-6 ${isActive('/search') ? 'fill-current' : ''}`} />
          <span className="text-xs">Search</span>
        </button>
        <button
          onClick={handleWalletClick}
          className={`flex flex-col items-center justify-center gap-1 p-2 rounded-lg transition-colors relative ${
            isActive('/wallet') ? 'text-achrams-primary-solid' : 'text-achrams-text-secondary'
          }`}
        >
          <Wallet className={`w-6 h-6 ${isActive('/wallet') ? 'fill-current' : ''}`} />
          {/* Optional: Wallet balance indicator */}
          {walletBalance != null && walletBalance > 0 && (
            <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
              {walletBalance}
            </span>
          )}
          <span className="text-xs">Wallet</span>
        </button>
        <button
          onClick={onProfileClick}
          className={`flex flex-col items-center justify-center gap-1 p-2 rounded-lg transition-colors ${
            isActive('/profile') ? 'text-achrams-primary-solid' : 'text-achrams-text-secondary' // Assuming profile page path
          }`}
        >
          <User className={`w-6 h-6 ${isActive('/profile') ? 'fill-current' : ''}`} />
          <span className="text-xs">Profile</span>
        </button>
      </div>
    </nav>
  );
}

----- FILE: src/components/app/ui/TripUpdateNotification.tsx -----
// src/components/app/ui/TripUpdateNotification.tsx
import { useEffect } from 'react';
import { AlertTriangle, CheckCircle, Info, X } from 'lucide-react';

interface TripUpdateNotificationProps {
  message: string;
  type: 'info' | 'success' | 'warning' | 'error';
  onDismiss: () => void;
}

export default function TripUpdateNotification({
  message,
  type,
  onDismiss,
}: TripUpdateNotificationProps) {
  let icon = null;
  let bgColor = '';
  let textColor = '';
  let iconColor = '';

  switch (type) {
    case 'info':
      icon = <Info className="w-5 h-5" />;
      bgColor = 'bg-blue-100';
      textColor = 'text-blue-800';
      iconColor = 'text-blue-500';
      break;
    case 'success':
      icon = <CheckCircle className="w-5 h-5" />;
      bgColor = 'bg-green-100';
      textColor = 'text-green-800';
      iconColor = 'text-green-500';
      break;
    case 'warning':
      icon = <AlertTriangle className="w-5 h-5" />;
      bgColor = 'bg-yellow-100';
      textColor = 'text-yellow-800';
      iconColor = 'text-yellow-500';
      break;
    case 'error':
      icon = <AlertTriangle className="w-5 h-5" />;
      bgColor = 'bg-red-100';
      textColor = 'text-red-800';
      iconColor = 'text-red-500';
      break;
  }

  useEffect(()=>{
    const timer = setTimeout(()=>{
      onDismiss();
    }, 6000);

    return() => {
      clearTimeout(timer);
    }

  }, [onDismiss]);

  return (
    <div className={`fixed top-4 left-1/2 transform -translate-x-1/2 max-w-xs w-full p-4 rounded-lg shadow-lg ${bgColor} ${textColor} flex items-start gap-2 z-50 animate-fadeInUp`}>
      <div className={`flex-shrink-0 mt-0.5 ${iconColor}`}>{icon}</div>
      <div className="flex-1">
        <p className="text-sm">{message}</p>
      </div>
      <button
        onClick={onDismiss}
        className="flex-shrink-0 text-current hover:opacity-80"
      >
        <X className="w-4 h-4" />
      </button>
    </div>
  );
}

----- FILE: src/components/app/screens/TripDetailsScreen.tsx -----
// src/components/app/screens/TripDetailsScreen.tsx
import { useState, useEffect } from 'react';
import { MapPin, Clock, Star, Calendar, ChevronLeft, MessageCircle, Phone } from 'lucide-react';
import { GoogleMap, Marker, useJsApiLoader } from '@react-google-maps/api';
import { apiClient } from '@/services/apiClient'; // Assuming you create this service

interface TripDetails {
  id: string;
  amount: {
    formatted: string;
  };
  status: {
    label: string;
    value: string;
  };
  pickup_address: string;
  destination_address: string;
  verification_code: string;
  rating?: {
    score: number;
    comment?: string;
  } | null;
  map_data: {
    pickup_location: {
      geometry: {
        coordinates: [number, number]; // [lng, lat]
      };
      properties: {
        name: string;
        description: string;
      };
    };
    destination_location: {
      geometry: {
        coordinates: [number, number]; // [lng, lat]
      };
      properties: {
        name: string;
        description: string;
      };
    };
  };
  driver?: {
    name: string;
    rating: string; // e.g., "4.9"
    car_type: string;
    car_color: string;
    plate_number: string;
    profile_photo?: string;
    phone: string;
  };
  created_at: string; // ISO date string
  // Add other fields as needed
}

export default function TripDetailsScreen({ tripId, onBack }: { tripId: string; onBack: () => void }) {
  const [tripDetails, setTripDetails] = useState<TripDetails | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchTripDetails = async () => {
      try {
        setLoading(true);
        setError(null);
        // NEW: Call the specific trip API using apiClient
        // Example: GET /trips/{tripId}
        const response = await apiClient.get(`/trips/${tripId}`); // Use correct endpoint from Postman doc

        console.log("Trip Details Response:", response); // Debug log
        if (response.status === 200 && response.data && response.data.data) {
          setTripDetails(response.data.data);
        } else {
          setError('Failed to load trip details.');
        }
      } catch (err) {
        console.error("Trip Details Fetch Error:", err);
        let errorMessage = 'An unexpected error occurred.';
        if (err instanceof Error) {
          errorMessage = err.message;
        }
        setError(errorMessage);
      } finally {
        setLoading(false);
      }
    };

    if (tripId) {
        fetchTripDetails();
    }
  }, [tripId]);


  if (loading) {
    return (
      <div className="h-screen bg-achrams-bg-primary flex items-center justify-center">
        <div className="text-center">
          <div className="w-16 h-16 border-4 border-achrams-primary-solid border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p className="text-achrams-text-secondary">Loading trip details...</p>
        </div>
      </div>
    );
  }

  if (error || !tripDetails) {
    return (
      <div className="h-screen bg-achrams-bg-primary flex flex-col items-center justify-center p-6">
        <p className="text-red-500 text-center mb-6">{error || 'Trip details not found.'}</p>
        <button
          onClick={onBack} // Go back on error
          className="bg-achrams-gradient-primary text-achrams-text-light py-3 px-6 rounded-xl font-semibold"
        >
          Back to History
        </button>
      </div>
    );
  }

  // NEW: Extract map coordinates and center
  const pickupCoords = tripDetails.map_data.pickup_location.geometry.coordinates; // [lng, lat]
  const destCoords = tripDetails.map_data.destination_location.geometry.coordinates; // [lng, lat]
  const mapCenter = { lat: pickupCoords[1], lng: pickupCoords[0] }; // { lat: lat, lng: lng }

  // NEW: Load Google Maps API
  const { isLoaded, loadError } = useJsApiLoader({
    id: 'google-map-script-trip-details',
    googleMapsApiKey: process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY!,
  });

  return (
    <div className="h-screen bg-achrams-bg-primary flex flex-col">
      {/* Header */}
      <div className="bg-achrams-primary-solid text-achrams-text-light px-6 py-4 flex items-center">
        <button onClick={onBack} className="mr-4">
          <ChevronLeft className="w-6 h-6" />
        </button>
        <h1 className="text-xl font-bold">Trip Details</h1>
      </div>

      {/* Content */}
      <div className="flex-1 overflow-y-auto">
        {/* Map Preview (smaller) */}
        <div className="h-48 relative">
          {isLoaded ? (
            <GoogleMap
              mapContainerStyle={{ width: '100%', height: '100%' }}
              center={mapCenter}
              zoom={12}
              options={{
                // Disable default UI for a cleaner look in preview
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false,
                zoomControl: false,
              }}
            >
              <Marker
                position={{ lat: pickupCoords[1], lng: pickupCoords[0] }}
                icon={{ url: 'https://maps.google.com/mapfiles/ms/micons/green-dot.png', scaledSize: new window.google.maps.Size(32, 32) }}
                title={tripDetails.map_data.pickup_location.properties.name}
              />
              <Marker
                position={{ lat: destCoords[1], lng: destCoords[0] }}
                icon={{ url: 'https://maps.google.com/mapfiles/ms/micons/red-dot.png', scaledSize: new window.google.maps.Size(32, 32) }}
                title={tripDetails.map_data.destination_location.properties.name}
              />
            </GoogleMap>
          ) : (
            <div className="absolute inset-0 flex items-center justify-center bg-achrams-bg-secondary">
              <p className="text-achrams-text-secondary">Loading map...</p>
            </div>
          )}
        </div>

        {/* Trip Info */}
        <div className="p-6 space-y-6">
          {/* Date & Status */}
          <div className="flex justify-between items-center">
            <div className="flex items-center gap-2">
              <Calendar className="w-5 h-5 text-achrams-text-secondary" />
              <span className="text-achrams-text-primary">{new Date(tripDetails.created_at).toLocaleString()}</span>
            </div>
            <span className={`text-xs px-3 py-1 rounded-full ${
              tripDetails.status.value === 'completed' ? 'bg-green-100 text-green-800' :
              tripDetails.status.value === 'cancelled' ? 'bg-red-100 text-red-800' :
              'bg-yellow-100 text-yellow-800'
            }`}>
              {tripDetails.status.label}
            </span>
          </div>

          {/* Fare */}
          <div className="bg-achrams-bg-secondary rounded-xl p-4 border border-achrams-border">
            <div className="flex justify-between items-center">
              <span className="text-achrams-text-secondary">Total Fare</span>
              <span className="text-2xl font-bold text-achrams-text-primary">{tripDetails.amount.formatted}</span>
            </div>
          </div>

          {/* Verification Code */}
          {tripDetails.verification_code && (
            <div className="bg-achrams-bg-secondary rounded-xl p-4 border border-achrams-border">
              <div className="text-xs text-achrams-text-secondary mb-1">Verification Code</div>
              <div className="text-xl font-mono font-bold text-achrams-text-primary">{tripDetails.verification_code}</div>
            </div>
          )}

          {/* Driver Info (if assigned) */}
          {tripDetails.driver && (
            <div className="bg-achrams-bg-secondary rounded-xl p-4 border border-achrams-border">
              <h3 className="font-semibold mb-3 text-achrams-text-primary">Driver Info</h3>
              <div className="flex items-center gap-4 mb-4">
                <div className="w-14 h-14 bg-gradient-to-br from-achrams-primary-solid to-achrams-secondary-solid rounded-full flex items-center justify-center text-achrams-text-light text-lg font-bold">
                  {tripDetails.driver.name.charAt(0)}
                </div>
                <div className="flex-1">
                  <div className="font-bold text-achrams-text-primary">{tripDetails.driver.name}</div>
                  <div className="flex items-center gap-1 text-sm text-achrams-text-secondary">
                    <Star className="w-4 h-4 fill-yellow-400 text-yellow-400" />
                    <span>{tripDetails.driver.rating}</span>
                  </div>
                </div>
              </div>
              <div className="space-y-2">
                <div className="text-sm">
                  <span className="text-achrams-text-secondary">Car: </span>
                  <span className="text-achrams-text-primary">{tripDetails.driver.car_type}  {tripDetails.driver.car_color}</span>
                </div>
                <div className="text-sm">
                  <span className="text-achrams-text-secondary">Plate: </span>
                  <span className="text-achrams-text-primary">{tripDetails.driver.plate_number}</span>
                </div>
              </div>
              <div className="flex gap-3 mt-4">
                <button className="flex-1 flex items-center justify-center gap-2 py-3 bg-achrams-bg-primary border border-achrams-border rounded-xl font-medium text-achrams-text-primary hover:bg-achrams-bg-secondary transition-colors">
                  <MessageCircle className="w-5 h-5" />
                  Message
                </button>
                <button className="flex-1 flex items-center justify-center gap-2 py-3 bg-achrams-bg-primary border border-achrams-border rounded-xl font-medium text-achrams-text-primary hover:bg-achrams-bg-secondary transition-colors">
                  <Phone className="w-5 h-5" />
                  Call
                </button>
              </div>
            </div>
          )}

          {/* Rating */}
          {tripDetails.rating && (
            <div className="bg-achrams-bg-secondary rounded-xl p-4 border border-achrams-border">
              <h3 className="font-semibold mb-3 text-achrams-text-primary">Your Rating</h3>
              <div className="flex items-center gap-2 mb-2">
                {[...Array(5)].map((_, i) => (
                  <Star
                    key={i}
                    className={`w-6 h-6 ${
                      i < tripDetails.rating!.score
                        ? 'fill-yellow-400 text-yellow-400'
                        : 'text-gray-300'
                    }`}
                  />
                ))}
                <span className="ml-2 font-medium text-achrams-text-primary">{tripDetails.rating.score}/5</span>
              </div>
              {tripDetails.rating.comment && (
                <p className="text-achrams-text-secondary text-sm italic">"{tripDetails.rating.comment}"</p>
              )}
            </div>
          )}

          {/* Addresses */}
          <div className="space-y-4">
            <div className="flex items-start gap-3">
              <div className="w-2 h-2 bg-achrams-primary-solid rounded-full mt-2 flex-shrink-0"></div>
              <div className="flex-1">
                <div className="text-xs text-achrams-text-secondary mb-1">PICKUP</div>
                <div className="font-medium text-achrams-text-primary">{tripDetails.pickup_address}</div>
              </div>
            </div>
            <div className="flex items-start gap-3">
              <div className="w-2 h-2 bg-achrams-primary-solid rounded-full mt-2 flex-shrink-0"></div>
              <div className="flex-1">
                <div className="text-xs text-achrams-text-secondary mb-1">DESTINATION</div>
                <div className="font-medium text-achrams-text-primary">{tripDetails.destination_address}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

----- FILE: src/components/app/screens/TripProgressScreen.tsx -----
// // src/components/app/screens/TripProgressScreen.tsx
'use client';

import { Shield } from 'lucide-react';
import { GoogleMap, Marker, Polyline, useJsApiLoader } from '@react-google-maps/api';
import { Driver } from '@/types/passenger'; // Assuming this type is defined
import { useState, useEffect } from 'react';

interface TripProgressScreenProps {
  driver: Driver;
  onPanic: () => void;
  onComplete: () => void;
  pickupCoords: [number, number] | null; // NEW: Prop for pickup coordinates
  destinationCoords: [number, number] | null; // NEW: Prop for destination coordinates
  tripProgress: number; // NEW: Prop for simulated progress
}

export default function TripProgressScreen({
  driver,
  onPanic,
  onComplete,
  pickupCoords,
  destinationCoords,
  tripProgress, // NEW: Destructure prop
}: TripProgressScreenProps) {
  const [driverLocation, setDriverLocation] = useState<[number, number] | null>(null); // NEW: State for driver location

  // NEW: Simulate driver movement based on tripProgress
  useEffect(() => {
    if (pickupCoords && destinationCoords) {
      const [startLng, startLat] = pickupCoords;
      const [endLng, endLat] = destinationCoords;

      // Simple linear interpolation for simulation
      const lat = startLat + (endLat - startLat) * (tripProgress / 100);
      const lng = startLng + (endLng - startLng) * (tripProgress / 100);

      setDriverLocation([lng, lat]);
    }
  }, [tripProgress, pickupCoords, destinationCoords]);

  // NEW: Load Google Maps API
  const { isLoaded, loadError } = useJsApiLoader({
    id: 'google-map-script',
    googleMapsApiKey: process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY!,
  });

  // NEW: Determine map center (use driver location if available, otherwise pickup or default)
  let mapCenter = { lat: 6.5244, lng: 3.3792 }; // Default
  if (driverLocation) {
    mapCenter = { lat: driverLocation[1], lng: driverLocation[0] };
  } else if (pickupCoords) {
    mapCenter = { lat: pickupCoords[1], lng: pickupCoords[0] };
  }

  if (loadError) {
    return (
      <div className="h-screen bg-achrams-bg-primary flex flex-col">
        <div className="bg-achrams-primary-solid text-achrams-text-light px-6 py-4">
          <h1 className="text-xl font-bold">Trip in progress</h1>
        </div>
        <div className="flex-1 flex items-center justify-center bg-achrams-bg-secondary">
          <p className="text-achrams-text-secondary">Error loading map: {loadError.message}</p>
        </div>
        <div className="bg-achrams-bg-primary px-6 py-6 border-t border-achrams-border">
          <div className="flex items-center gap-4 mb-4">
            <div className="w-14 h-14 bg-gradient-to-br from-achrams-primary-solid to-achrams-secondary-solid rounded-full flex items-center justify-center text-achrams-text-light text-lg font-bold">
              {driver.initials || driver.name?.charAt(0) || 'D'}
            </div>
            <div>
              <div className="font-bold text-achrams-text-primary">{driver.name}</div>
              <div className="text-sm text-achrams-text-secondary">
                En route to {destinationCoords ? 'your destination' : 'unknown'}
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="h-screen bg-achrams-bg-primary flex flex-col">
      {/* Header */}
      <div className="bg-achrams-primary-solid text-achrams-text-light px-6 py-4 flex items-center justify-between">
        <h1 className="text-xl font-bold">Trip in progress</h1>
        <button
          onClick={onPanic}
          className="w-12 h-12 bg-achrams-bg-primary rounded-full shadow-lg flex items-center justify-center border border-achrams-border hover:bg-achrams-bg-secondary transition-colors"
        >
          <Shield className="w-6 h-6 text-white" />
        </button>
      </div>
      {/* Map Container */}
      <div className="flex-1 relative">
        {isLoaded ? (
          <GoogleMap
            mapContainerStyle={{ width: '100%', height: '100%' }}
            center={mapCenter}
            zoom={14}
            options={{
              // Optional: Disable default UI elements for a cleaner look
              // mapTypeControl: false,
              // streetViewControl: false,
              // fullscreenControl: false,
              // zoomControl: false,
              // Add other map options as needed
            }}
          >
            {/* Pickup Marker */}
            {pickupCoords && (
              <Marker
                position={{ lat: pickupCoords[1], lng: pickupCoords[0] }}
                icon={{
                  url: 'https://maps.google.com/mapfiles/ms/micons/green-dot.png',
                  scaledSize: new window.google.maps.Size(32, 32),
                }}
                title="Pickup Location"
              />
            )}
            {/* Destination Marker */}
            {destinationCoords && (
              <Marker
                position={{ lat: destinationCoords[1], lng: destinationCoords[0] }}
                icon={{
                  url: 'https://maps.google.com/mapfiles/ms/micons/red-dot.png',
                  scaledSize: new window.google.maps.Size(32, 32),
                }}
                title="Destination"
              />
            )}
            {/* Driver Marker */}
            {driverLocation && (
              <Marker
                position={{ lat: driverLocation[1], lng: driverLocation[0] }}
                icon={{
                  url: 'https://maps.google.com/mapfiles/ms/micons/blue-dot.png',
                  scaledSize: new window.google.maps.Size(32, 32),
                }}
                title={`Driver ${driver.name}`}
              />
            )}
            {/* Route Polyline (Optional) */}
            {pickupCoords && destinationCoords && (
              <Polyline
                path={[
                  { lat: pickupCoords[1], lng: pickupCoords[0] },
                  { lat: destinationCoords[1], lng: destinationCoords[0] },
                ]}
                options={{
                  strokeColor: '#FF0000',
                  strokeOpacity: 0.8,
                  strokeWeight: 2,
                }}
              />
            )}
          </GoogleMap>
        ) : (
          <div className="absolute inset-0 flex items-center justify-center bg-achrams-bg-secondary">
            <p className="text-achrams-text-secondary">Loading map...</p>
          </div>
        )}
      </div>
      {/* Driver Info Bar */}
      <div className="bg-achrams-bg-primary px-6 py-6 border-t border-achrams-border">
        <div className="flex items-center gap-4 mb-4">
          <div className="w-14 h-14 bg-gradient-to-br from-achrams-primary-solid to-achrams-secondary-solid rounded-full flex items-center justify-center text-achrams-text-light text-lg font-bold">
            {driver.initials || driver.name?.charAt(0) || 'D'}
          </div>
          <div>
            <div className="font-bold text-achrams-text-primary">{driver.name}</div>
            <div className="text-sm text-achrams-text-secondary">
              En route to {destinationCoords ? 'your destination' : 'unknown'}
            </div>
          </div>
        </div>
        {/* NEW: Progress indicator */}
        <div className="w-full bg-achrams-border rounded-full h-2.5">
          <div
            className="bg-achrams-gradient-primary h-2.5 rounded-full transition-all duration-300"
            style={{ width: `${tripProgress}%` }}
          ></div>
        </div>
        <div className="text-center mt-1 text-sm text-achrams-text-secondary">
          {tripProgress}% Complete
        </div>
      </div>
    </div>
  );
}


// src/components/app/screens/TripProgressScreen.tsx
// 'use client';

// import { Shield } from 'lucide-react';
// import { GoogleMap, Marker, Polyline, useJsApiLoader } from '@react-google-maps/api';
// import { Driver } from '@/types/passenger'; // Assuming this type is defined
// import { useState, useEffect } from 'react';

// interface TripProgressScreenProps {
//   driver: Driver;
//   onPanic: () => void;
//   onComplete: () => void;
//   pickupCoords: [number, number] | null; // NEW: Prop for pickup coordinates
//   destinationCoords: [number, number] | null; // NEW: Prop for destination coordinates
//   tripProgress: number; // NEW: Prop for simulated progress
// }

// export default function TripProgressScreen({
//   driver,
//   onPanic,
//   onComplete,
//   pickupCoords,
//   destinationCoords,
//   tripProgress, // NEW: Destructure prop
// }: TripProgressScreenProps) {
//   const [driverLocation, setDriverLocation] = useState<[number, number] | null>(null); // NEW: State for driver location

//   // NEW: Simulate driver movement based on tripProgress
//   useEffect(() => {
//     if (pickupCoords && destinationCoords) {
//       const [startLng, startLat] = pickupCoords;
//       const [endLng, endLat] = destinationCoords;

//       // Simple linear interpolation for simulation
//       const lat = startLat + (endLat - startLat) * (tripProgress / 100);
//       const lng = startLng + (endLng - startLng) * (tripProgress / 100);

//       setDriverLocation([lng, lat]);
//     }
//   }, [tripProgress, pickupCoords, destinationCoords]);

//   // NEW: Load Google Maps API
//   const { isLoaded, loadError } = useJsApiLoader({
//     id: 'google-map-script',
//     googleMapsApiKey: process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY!,
//   });

//   // NEW: Determine map center (use driver location if available, otherwise pickup or default)
//   let mapCenter = { lat: 6.5244, lng: 3.3792 }; // Default
//   if (driverLocation) {
//     mapCenter = { lat: driverLocation[1], lng: driverLocation[0] };
//   } else if (pickupCoords) {
//     mapCenter = { lat: pickupCoords[1], lng: pickupCoords[0] };
//   }

//   if (loadError) {
//     return (
//       <div className="h-screen bg-achrams-bg-primary flex flex-col">
//         <div className="bg-achrams-primary-solid text-achrams-text-light px-6 py-4">
//           <h1 className="text-xl font-bold">Trip in progress</h1>
//         </div>
//         <div className="flex-1 flex items-center justify-center bg-achrams-bg-secondary">
//           <p className="text-achrams-text-secondary">Error loading map: {loadError.message}</p>
//         </div>
//         <div className="bg-achrams-bg-primary px-6 py-6 border-t border-achrams-border">
//           <div className="flex items-center gap-4 mb-4">
//             <div className="w-14 h-14 bg-gradient-to-br from-achrams-primary-solid to-achrams-secondary-solid rounded-full flex items-center justify-center text-achrams-text-light text-lg font-bold">
//               {driver.initials || driver.name?.charAt(0) || 'D'}
//             </div>
//             <div>
//               <div className="font-bold text-achrams-text-primary">{driver.name}</div>
//               <div className="text-sm text-achrams-text-secondary">
//                 En route to {destinationCoords ? 'your destination' : 'unknown'}
//               </div>
//             </div>
//           </div>
//         </div>
//       </div>
//     );
//   }

//   return (
//     <div className="h-screen bg-achrams-bg-primary flex flex-col">
//       {/* Header */}
//       <div className="bg-achrams-primary-solid text-achrams-text-light px-6 py-4 flex items-center justify-between">
//         <h1 className="text-xl font-bold">Trip in progress</h1>
//         <button
//           onClick={onPanic}
//           className="w-12 h-12 bg-achrams-bg-primary rounded-full shadow-lg flex items-center justify-center border border-achrams-border hover:bg-achrams-bg-secondary transition-colors"
//         >
//           <Shield className="w-6 h-6 text-white" /> {/* Consider changing text color if background is light */}
//         </button>
//       </div>
//       {/* Map Container */}
//       <div className="flex-1 relative">
//         {isLoaded ? (
//           <GoogleMap
//             mapContainerStyle={{ width: '100%', height: '100%' }}
//             center={mapCenter}
//             zoom={14}
//             options={{
//               // Optional: Disable default UI elements for a cleaner look
//               // mapTypeControl: false,
//               // streetViewControl: false,
//               // fullscreenControl: false,
//               // zoomControl: false,
//               // Add other map options as needed
//             }}
//           >
//             {/* Pickup Marker */}
//             {pickupCoords && (
//               <Marker
//                 position={{ lat: pickupCoords[1], lng: pickupCoords[0] }}
//                 // FIXED: Removed trailing spaces from URL
//                 icon={{
//                   url: 'https://maps.google.com/mapfiles/ms/micons/green-dot.png',
//                   scaledSize: new window.google.maps.Size(32, 32),
//                 }}
//                 title="Pickup Location"
//               />
//             )}
//             {/* Destination Marker */}
//             {destinationCoords && (
//               <Marker
//                 position={{ lat: destinationCoords[1], lng: destinationCoords[0] }}
//                 // FIXED: Removed trailing spaces from URL
//                 icon={{
//                   url: 'https://maps.google.com/mapfiles/ms/micons/red-dot.png',
//                   scaledSize: new window.google.maps.Size(32, 32),
//                 }}
//                 title="Destination"
//               />
//             )}
//             {/* Driver Marker */}
//             {driverLocation && (
//               <Marker
//                 position={{ lat: driverLocation[1], lng: driverLocation[0] }}
//                 // FIXED: Removed trailing spaces from URL
//                 icon={{
//                   url: 'https://maps.google.com/mapfiles/ms/micons/blue-dot.png',
//                   scaledSize: new window.google.maps.Size(32, 32),
//                 }}
//                 title={`Driver ${driver.name}`}
//               />
//             )}
//             {/* Route Polyline (Optional) */}
//             {pickupCoords && destinationCoords && (
//               <Polyline
//                 path={[
//                   { lat: pickupCoords[1], lng: pickupCoords[0] },
//                   { lat: destinationCoords[1], lng: destinationCoords[0] },
//                 ]}
//                 options={{
//                   strokeColor: '#FF0000',
//                   strokeOpacity: 0.8,
//                   strokeWeight: 2,
//                 }}
//               />
//             )}
//           </GoogleMap>
//         ) : (
//           <div className="absolute inset-0 flex items-center justify-center bg-achrams-bg-secondary">
//             <p className="text-achrams-text-secondary">Loading map...</p>
//           </div>
//         )}
//       </div>
//       {/* Driver Info Bar */}
//       <div className="bg-achrams-bg-primary px-6 py-6 border-t border-achrams-border">
//         <div className="flex items-center gap-4 mb-4">
//           <div className="w-14 h-14 bg-gradient-to-br from-achrams-primary-solid to-achrams-secondary-solid rounded-full flex items-center justify-center text-achrams-text-light text-lg font-bold">
//             {driver.initials || driver.name?.charAt(0) || 'D'}
//           </div>
//           <div>
//             <div className="font-bold text-achrams-text-primary">{driver.name}</div>
//             <div className="text-sm text-achrams-text-secondary">
//               En route to {destinationCoords ? 'your destination' : 'unknown'}
//             </div>
//           </div>
//         </div>
//         {/* NEW: Progress indicator */}
//         <div className="w-full bg-achrams-border rounded-full h-2.5">
//           <div
//             className="bg-achrams-gradient-primary h-2.5 rounded-full transition-all duration-300"
//             style={{ width: `${tripProgress}%` }}
//           ></div>
//         </div>
//         <div className="text-center mt-1 text-sm text-achrams-text-secondary">
//           {tripProgress}% Complete
//         </div>
//       </div>
//     </div>
//   );
// }

----- FILE: src/components/app/screens/BookingScreen.tsx -----
"use client";
import { useState, useEffect, useRef, useCallback } from "react";
import {
  MapPin,
  Navigation,
  Plane,
  ChevronDown,
  X,
  Loader,
} from "lucide-react";
import { useGeolocation } from "@/hooks/useGeolocation";
import ACHRAMSHeader from "@/components/ui/ACHRAMSHeader";
import { findNearestAirport, Airport } from "@/lib/airports";
import { LoadScript, StandaloneSearchBox } from "@react-google-maps/api";
import AirportSelectionModal from "@/components/app/modals/AirportSelectionModal";
import OutsideServiceAreaModal from "@/components/app/modals/OutsideServiceAreaModal";

interface LocationData {
  name: string;
  coords: [number, number] | null;
}

interface BookingScreenProps {
  pickup: string;
  setPickup: (val: string) => void;
  destination: string;
  setDestination: (val: string) => void;
  fareEstimate: number | null;
  setFareEstimate: (val: number | null) => void;
  onProceed: () => void;
  setShowPassengerDetails: (val: boolean) => void;
  passengerData: any;
  setPassengerData: (val: any) => void;
  showPassengerDetails: boolean;
  requirements: any;
  setRequirements: (val: any) => void;
  setPickupCoords: (coords: [number, number] | null) => void;
  setDestinationCoords: (coords: [number, number] | null) => void;
  tripRequestStatus: 'loading' | 'accepted' | 'no-driver' | 'error' | null;
}

const losCoords: [number, number] = [3.330058, 6.568287];
const abvCoords: [number, number] = [7.2667, 9.0167];

const airports = [
  { id: "current", name: "Use my current location", special: true },
  { id: "los", name: "Murtala Muhammed Int'l Airport (LOS)", city: "Lagos" },
  { id: "abv", name: "Nnamdi Azikiwe Int'l Airport (ABV)", city: "Abuja" },
];

const destinationCoordsMap: Record<string, [number, number] | null> = {
  "Victoria Island, Lagos": [3.4084, 6.4397],
  "Lekki Phase 1, Lagos": [3.9942, 6.4253],
  "Ikeja GRA, Lagos": [3.3519, 6.555],
  "Ikorodu, Lagos": [3.504145, 6.620891],
};

const GOOGLE_MAPS_API_KEY = process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY!;
const libraries: ("places")[] = ["places"];

// Custom debounce hook (lightweight & stable)
function useDebounceCallback<T extends (...args: any[]) => any>(
  callback: T,
  delay: number
) {
  const timeoutRef = useRef<NodeJS.Timeout | null>(null);

  useEffect(() => {
    return () => {
      if (timeoutRef.current) clearTimeout(timeoutRef.current);
    };
  }, []);

  return useCallback(
    ((...args: Parameters<T>) => {
      if (timeoutRef.current) clearTimeout(timeoutRef.current);
      timeoutRef.current = setTimeout(() => {
        callback(...args);
      }, delay);
    }) as T,
    [callback, delay]
  );
}

export default function BookingScreen({
  pickup,
  setPickup,
  destination,
  setDestination,
  fareEstimate,
  setFareEstimate,
  onProceed,
  setPickupCoords,
  setDestinationCoords,
  tripRequestStatus,
}: BookingScreenProps) {
  const [pickupOpen, setPickupOpen] = useState(false);
  const [destOpen, setDestOpen] = useState(false);
  const [showAirportSelectionModal, setShowAirportSelectionModal] = useState(false);
  const [airportsToSelect, setAirportsToSelect] = useState<Airport[]>([]);
  const [showOutsideServiceModal, setShowOutsideServiceModal] = useState(false);
  const [showLocationSettingsModal, setShowLocationSettingsModal] = useState(false);

  const searchBoxRef = useRef<google.maps.places.SearchBox | null>(null);
  const destinationInputRef = useRef<HTMLInputElement>(null);

  const { coords, error, requestPermission, loading: hookLoading } = useGeolocation();
  const [isFetchingLocation, setIsFetchingLocation] = useState(false);

  const [pickupLocationData, setPickupLocationData] = useState<LocationData>({
    name: pickup,
    coords: null,
  });

  const [destinationLocationData, setDestinationLocationData] = useState<LocationData>({
    name: destination,
    coords: null,
  });

 
  
  // Sync local state  parent
  useEffect(() => {
    setPickup(pickupLocationData.name);
    setPickupCoords(pickupLocationData.coords);
  }, [pickupLocationData, setPickup, setPickupCoords]);

  useEffect(() => {
    setDestination(destinationLocationData.name);
    setDestinationCoords(destinationLocationData.coords);
  }, [destinationLocationData, setDestination, setDestinationCoords]);

  // Fare estimate mock (replace with API later)
  useEffect(() => {
    if (pickupLocationData.name && destinationLocationData.name) {
      const estimate = 4500 + Math.floor(Math.random() * 2000);
      setFareEstimate(estimate);
    } else {
      setFareEstimate(null);
    }
  }, [pickupLocationData, destinationLocationData, setFareEstimate]);

  // Reset fetching state when trip request ends
  useEffect(() => {
    if (tripRequestStatus !== "loading") {
      setIsFetchingLocation(false);
    }
  }, [tripRequestStatus]);

  const showFetchingUI = isFetchingLocation || hookLoading;

  // Stable debounced handler
  const debouncedDestinationInput = useDebounceCallback((value: string) => {
    console.log("Destination input settled:", value);
    // Add custom logic here if needed (e.g. fallback API search)
  }, 300);

  // Stable change handler
  const handleDestinationChanged = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;
    setDestinationLocationData(prev => ({ ...prev, name: value }));
    if (value.trim()) {
      setDestOpen(true);
    }
    debouncedDestinationInput(value);
  }, [debouncedDestinationInput]);

  // Stable place selection handler
  const handlePlaceChanged = useCallback(() => {
    if (!searchBoxRef.current) return;

    const places = searchBoxRef.current.getPlaces();
    if (!places || places.length === 0) return;

    const place = places[0];
    if (place.geometry?.location) {
      const lat = place.geometry.location.lat();
      const lng = place.geometry.location.lng();
      const formattedAddress = place.formatted_address || place.name || "";

      setDestinationLocationData({
        name: formattedAddress,
        coords: [lng, lat],
      });
      setDestOpen(false);
    }
  }, []);

  const handleClearDestination = useCallback(() => {
    setDestinationLocationData({ name: "", coords: null });
    setDestOpen(false);
    destinationInputRef.current?.focus();
  }, []);

  const handleUseCurrentLocation = useCallback(async () => {
    if (error?.includes("denied")) {
      setShowLocationSettingsModal(true);
      setPickupOpen(false);
      return;
    }

    setIsFetchingLocation(true);
    setPickupOpen(false);

    try {
      const position = await requestPermission();
      if (!position) throw new Error("No coordinates");

      const { longitude, latitude } = position;
      const airports = await findNearestAirport(longitude, latitude);

      if (airports && airports.length > 0) {
        if (airports.length === 1) {
          setPickupLocationData({
            name: airports[0].name,
            coords: [longitude, latitude],
          });
        } else {
          setAirportsToSelect(airports);
          setShowAirportSelectionModal(true);
        }
      } else {
        setShowOutsideServiceModal(true);
      }
    } catch (err) {
      console.error("Location fetch failed:", err);
    } finally {
      setIsFetchingLocation(false);
    }
  }, [error, requestPermission]);

  const handleAirportSelectedFromModal = useCallback((airport: Airport) => {
    setPickupLocationData(prev => ({
      name: airport.name,
      coords: prev.coords, // retain geolocation coords
    }));
    setShowAirportSelectionModal(false);
  }, []);

  const handleAirportSelect = useCallback((airportId: string) => {
    const map: Record<string, { name: string; coords: [number, number] }> = {
      los: { name: "Murtala Muhammed Int'l Airport (LOS)", coords: losCoords },
      abv: { name: "Nnamdi Azikiwe Int'l Airport (ABV)", coords: abvCoords },
    };

    const selected = map[airportId];
    if (selected) {
      setPickupLocationData({
        name: selected.name,
        coords: selected.coords,
      });
    }
    setPickupOpen(false);
  }, []);

  return (
    <div className="h-screen bg-achrams-bg-primary flex flex-col">
      <AirportSelectionModal
        isOpen={showAirportSelectionModal}
        onClose={() => setShowAirportSelectionModal(false)}
        airports={airportsToSelect}
        onSelect={handleAirportSelectedFromModal}
      />
      <OutsideServiceAreaModal
        isOpen={showOutsideServiceModal}
        onClose={() => setShowOutsideServiceModal(false)}
      />

      <div className="bg-achrams-primary-solid text-achrams-text-light px-0 py-4">
        <div className="px-6">
          <ACHRAMSHeader title="" />
        </div>
      </div>

      {error?.includes("denied") && (
        <div className="bg-blue-600 text-achrams-text-light p-3 flex items-center justify-between">
          <div className="flex items-center gap-2">
            <Navigation className="w-5 h-5" />
            <span>This app requires your location access to work</span>
          </div>
          <button
            onClick={() => setShowLocationSettingsModal(true)}
            className="bg-white text-achrams-text-primary px-4 py-1 rounded-full text-sm font-medium hover:bg-achrams-bg-primary"
          >
            Grant access
          </button>
        </div>
      )}

      {showLocationSettingsModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg p-6 max-w-md w-full">
            <h3 className="text-lg font-semibold mb-2">Enable Location Access</h3>
            <p className="mb-4">Please allow location access in your browser settings.</p>
            <ol className="list-decimal list-inside mb-4 space-y-1 text-sm">
              <li>Click the lock/info icon in the address bar</li>
              <li>Go to "Site settings"  "Location"  Allow</li>
              <li>Refresh the page</li>
            </ol>
            <button
              onClick={() => setShowLocationSettingsModal(false)}
              className="w-full bg-achrams-primary-solid text-white py-2 rounded-lg"
            >
              Close
            </button>
          </div>
        </div>
      )}

      <div className="flex-1 px-6 py-8 overflow-y-auto">
        <h2 className="text-2xl font-semibold tracking-tight text-achrams-text-primary pb-4">
          Book Your Airport Ride
        </h2>

        <div className="space-y-4">
          {/* Pickup */}
          <div className="relative">
            <div className="flex items-center gap-3 bg-achrams-bg-secondary rounded-xl px-4 py-4 border border-achrams-border">
              <div className="w-2 h-2 bg-achrams-primary-solid rounded-full" />
              <input
                type="text"
                placeholder="Airport pickup location"
                value={showFetchingUI ? "Getting your location..." : pickupLocationData.name}
                onChange={(e) => !showFetchingUI && setPickupLocationData(prev => ({ ...prev, name: e.target.value }))}
                onFocus={() => !showFetchingUI && setPickupOpen(true)}
                readOnly={showFetchingUI}
                className={`flex-1 bg-transparent outline-none text-base ${
                  showFetchingUI ? "text-achrams-text-secondary italic" : "text-achrams-text-primary"
                }`}
              />
              <button
                onClick={() => !showFetchingUI && setPickupOpen(!pickupOpen)}
                disabled={showFetchingUI}
                className={`p-2 transition-colors ${
                  showFetchingUI
                    ? "text-achrams-text-secondary opacity-50 cursor-not-allowed"
                    : "text-achrams-text-secondary hover:text-achrams-text-primary"
                }`}
              >
                {showFetchingUI ? (
                  <Loader className="w-5 h-5 animate-spin text-achrams-primary-solid" />
                ) : pickupOpen ? (
                  <ChevronDown className="w-5 h-5" />
                ) : (
                  <Navigation className="w-5 h-5" />
                )}
              </button>
            </div>

            {pickupOpen && (
              <div className="absolute top-full left-0 right-0 mt-1 bg-white rounded-xl shadow-lg border border-achrams-border z-50 max-h-64 overflow-y-auto">
                {showFetchingUI ? (
                  <div className="px-4 py-3 flex items-center gap-3 text-achrams-text-secondary">
                    <Loader className="w-5 h-5 animate-spin" />
                    <span>Locating you...</span>
                  </div>
                ) : (
                  <>
                    <button
                      onClick={handleUseCurrentLocation}
                      className="w-full px-4 py-3 flex items-center gap-3 hover:bg-achrams-bg-secondary border-b border-achrams-border text-left"
                    >
                      <MapPin className="w-5 h-5 text-achrams-primary-solid" />
                      <span>Use my current location</span>
                    </button>
                    {airports.slice(1).map((a) => (
                      <button
                        key={a.id}
                        onClick={() => handleAirportSelect(a.id)}
                        className="w-full px-4 py-3 flex items-start gap-3 hover:bg-achrams-bg-secondary border-b border-achrams-border text-left"
                      >
                        <Plane className="w-5 h-5 text-achrams-primary-solid mt-0.5" />
                        <div>
                          <div className="font-medium text-sm">{a.name}</div>
                          <div className="text-xs text-achrams-text-secondary">{a.city}</div>
                        </div>
                      </button>
                    ))}
                  </>
                )}
              </div>
            )}
          </div>

          <div className="flex justify-center py-1">
            <div className="w-0.5 h-6 bg-achrams-border" />
          </div>

          {/* Destination */}
          <div className="relative">
            <LoadScript googleMapsApiKey={GOOGLE_MAPS_API_KEY} libraries={libraries}>
              <StandaloneSearchBox
                onLoad={(ref) => (searchBoxRef.current = ref)}
                onPlacesChanged={handlePlaceChanged}
              >
                <div className="flex items-center gap-3 bg-achrams-bg-secondary rounded-xl px-4 py-4 border border-achrams-border">
                  <div className="w-2 h-2 bg-achrams-primary-solid rounded-full" />
                  <input
                    ref={destinationInputRef}
                    type="text"
                    placeholder="Enter destination"
                    value={destinationLocationData.name}
                    onChange={handleDestinationChanged}
                    onFocus={() => destinationLocationData.name && setDestOpen(true)}
                    className="flex-1 bg-transparent outline-none text-base text-achrams-text-primary"
                  />
                  {destOpen && destinationLocationData.name && (
                    <button
                      onClick={handleClearDestination}
                      className="p-2 text-achrams-text-secondary hover:text-achrams-text-primary"
                    >
                      <X className="w-5 h-5" />
                    </button>
                  )}
                </div>
              </StandaloneSearchBox>
            </LoadScript>
          </div>
        </div>

        {fareEstimate && (
          <div className="mt-6 p-4 bg-achrams-bg-secondary rounded-xl border border-achrams-border">
            <div className="flex justify-between items-center">
              <span className="text-achrams-text-secondary">Estimated fare</span>
              <span className="text-xl font-bold text-achrams-text-primary">
                {fareEstimate.toLocaleString()}
              </span>
            </div>
          </div>
        )}
      </div>

      <div className="p-6">
        <button
          onClick={onProceed}
          disabled={!fareEstimate}
          className={`w-full py-4 rounded-xl text-lg font-bold text-achrams-text-light transition-all ${
            fareEstimate
              ? "bg-achrams-gradient-primary hover:opacity-95 active:scale-[0.98] shadow-md"
              : "bg-achrams-secondary-solid opacity-75 cursor-not-allowed"
          }`}
        >
          {fareEstimate ? `Proceed  ${fareEstimate.toLocaleString()}` : "Enter destinations"}
        </button>
      </div>
    </div>
  );
}


// // src/components/app/screens/BookingScreen.tsx
// "use client";

// import { useState, useEffect, useRef } from "react";
// import {
//   MapPin,
//   Navigation,
//   Plane,
//   ChevronDown,
//   X,
//   Loader,
// } from "lucide-react";
// import { useGeolocation } from "@/hooks/useGeolocation";
// import ACHRAMSHeader from "@/components/ui/ACHRAMSHeader";
// import { findNearestAirport, Airport } from "@/lib/airports"; // NEW: Import Airport type
// import { LoadScript, StandaloneSearchBox } from "@react-google-maps/api"; // NEW: Import Google Maps components
// import AirportSelectionModal from "@/components/app/modals/AirportSelectionModal"; // NEW: Import the new modal
// import OutsideServiceAreaModal from "@/components/app/modals/OutsideServiceAreaModal"; // NEW: Import the new modal

// // NEW: Define type for location data
// interface LocationData {
//   name: string;
//   coords: [number, number] | null; // [lng, lat]
// }

// interface BookingScreenProps {
//   pickup: string;
//   setPickup: (val: string) => void;
//   destination: string;
//   setDestination: (val: string) => void;
//   fareEstimate: number | null;
//   setFareEstimate: (val: number | null) => void;
//   onProceed: () => void;
//   setShowPassengerDetails: (val: boolean) => void;
//   passengerData: any;
//   setPassengerData: (val: any) => void;
//   showPassengerDetails: boolean;
//   requirements: any;
//   setRequirements: (val: any) => void;
//   // NEW: Prop to set pickup coordinates in parent (page.tsx)
//   setPickupCoords: (coords: [number, number] | null) => void;
//   // NEW: Prop to set destination coordinates in parent (page.tsx)
//   setDestinationCoords: (coords: [number, number] | null) => void;
// }

// // NEW: Define coordinates for airports (replace with actual coordinates)
// const losCoords: [number, number] = [3.330058, 6.568287]; // Actual coord from API doc
// const abvCoords: [number, number] = [7.2667, 9.0167]; // Placeholder, find actual

// const airports = [
//   { id: "current", name: "Use my current location", special: true },
//   { id: "los", name: "Murtala Muhammed Int'l Airport (LOS)", city: "Lagos" },
//   { id: "abv", name: "Nnamdi Azikiwe Int'l Airport (ABV)", city: "Abuja" },
// ];

// // NEW: Placeholder coordinates for common destinations (find actual coords)
// // This map is now primarily used for the simple destination dropdown suggestions.
// // For real coordinates, Google Maps Autocomplete is preferred.
// const destinationCoordsMap: Record<string, [number, number] | null> = {
//   "Victoria Island, Lagos": [3.4084, 6.4397],
//   "Lekki Phase 1, Lagos": [3.9942, 6.4253],
//   "Ikeja GRA, Lagos": [3.3519, 6.555],
//   "Ikorodu, Lagos": [3.504145, 6.620891], // From API doc
//   // Add more as needed
// };

// // NEW: Google Maps API Key (ensure it's available in environment)
// const GOOGLE_MAPS_API_KEY = process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY!;

// export default function BookingScreen({
//   pickup,
//   setPickup,
//   destination,
//   setDestination,
//   fareEstimate,
//   setFareEstimate,
//   onProceed,
//   setShowPassengerDetails,
//   passengerData,
//   setPassengerData,
//   showPassengerDetails,
//   requirements,
//   setRequirements,
//   setPickupCoords,
//   setDestinationCoords,
//   onShowLocationModal, // NEW: Destructure the prop
// }: BookingScreenProps) {
//   const [pickupOpen, setPickupOpen] = useState(false);
//   const [destOpen, setDestOpen] = useState(false);
//   // NEW: State for airport selection modal
//   const [showAirportSelectionModal, setShowAirportSelectionModal] = useState(false);
//   const [airportsToSelect, setAirportsToSelect] = useState<Airport[]>([]);
//   // NEW: State for outside service area modal
//   const [showOutsideServiceModal, setShowOutsideServiceModal] = useState(false); // NEW
//   // NEW: Ref for the destination search box
//   const searchBoxRef = useRef<google.maps.places.SearchBox | null>(null);
//   const [showLocationSettingsModal, setShowLocationSettingsModal] = useState(false); // NEW: State for instructions modal

//   // NEW: Destructure loading state from the hook
//   const {
//     coords,
//     error,
//     requestPermission,
//     loading: hookLoading,
//   } = useGeolocation();

//   // NEW: State to track if location is being fetched (combines hook loading and UI state)
//   const [isFetchingLocation, setIsFetchingLocation] = useState(false);

//   // NEW: State to hold full pickup location data including coordinates
//   const [pickupLocationData, setPickupLocationData] = useState<LocationData>({
//     name: pickup,
//     coords: null,
//   });

//   // NEW: State to hold full destination location data including coordinates
//   const [destinationLocationData, setDestinationLocationData] =
//     useState<LocationData>({
//       name: destination,
//       coords: null,
//     });


//   // NEW: Effect to watch for geolocation errors and trigger the banner display


//   // NEW: Sync pickupLocationData.name with the parent's pickup state if it changes externally
//   useEffect(() => {
//     setPickupLocationData((prev) => ({ ...prev, name: pickup }));
//   }, [pickup]);

//   // NEW: Sync destinationLocationData.name with the parent's destination state if it changes externally
//   useEffect(() => {
//     setDestinationLocationData((prev) => ({ ...prev, name: destination }));
//   }, [destination]);

//   // NEW: Sync parent's pickup and pickupCoords states when pickupLocationData changes
//   useEffect(() => {
//     setPickup(pickupLocationData.name);
//     setPickupCoords(pickupLocationData.coords);
//   }, [pickupLocationData, setPickup, setPickupCoords]);

//   // NEW: Sync parent's destination and destinationCoords states when destinationLocationData changes
//   useEffect(() => {
//     setDestination(destinationLocationData.name);
//     setDestinationCoords(destinationLocationData.coords);
//   }, [destinationLocationData, setDestination, setDestinationCoords]);

//   // NEW: Sync parent's fareEstimate when pickupLocationData or destinationLocationData changes
//   // This is a placeholder. In a real implementation, you would call GET /v1/fares/lookup here.
//   useEffect(() => {
//     if (destinationLocationData.name && pickupLocationData.name) {
//       // Example: Call fare lookup API when both locations are set
//       // fetchFareEstimate(pickupLocationData, destinationLocationData).then(setFareEstimate);
//       // For now, keep the existing mock logic or remove it if using API call exclusively
//       const estimate = 4500 + Math.floor(Math.random() * 2000);
//       setFareEstimate(estimate);
//     } else {
//       setFareEstimate(null);
//     }
//   }, [destinationLocationData, pickupLocationData, setFareEstimate]);

//   // NEW: Updated handleUseCurrentLocation function
//   const handleUseCurrentLocation = async () => {
//     // NEW: Check if permission was previously denied or if error indicates need for modal
//     if (error && (error.includes("denied") || error.includes("Permission denied"))) {
//       console.log(error);
//       console.log("Location permission denied, showing modal.");
//     // Trigger parent to show the modal
//       setPickupOpen(false); // Close dropdown
//       return;
//     }

    

//     // NEW: Set fetching state and close dropdown immediately
//     setIsFetchingLocation(true);
//     setPickupOpen(false); // Close dropdown when fetching starts

   

//     try {
//       // NEW: Await the result of requestPermission
//       const fetchedCoords = await requestPermission();
//       // NEW: Check if coords were successfully obtained
//       if (fetchedCoords) {
//         // NEW: Call /v1/airports/by-location to resolve the airport
//         const foundAirports = await findNearestAirport(
//           fetchedCoords.longitude,
//           fetchedCoords.latitude
//         );

//         if (foundAirports && Array.isArray(foundAirports) && foundAirports.length > 0) {
//             if (foundAirports.length === 1) {
//                 // If only one airport found, use it directly
//                 setPickupLocationData({
//                     name: foundAirports[0].name, // e.g., "Murtala Muhammed International Airport"
//                     coords: [fetchedCoords.longitude, fetchedCoords.latitude],
//                 });
//             } else {
//                 // If multiple airports found, show the selection modal
//                 setAirportsToSelect(foundAirports);
//                 setShowAirportSelectionModal(true);
//             }
//         } else {
//           // Handle case where no airport is found near the location (foundAirports is null or [])
//           console.warn("No ACHRAMS airport found near the current location.");
//           // NEW: Show the specific modal for this scenario
//           setShowOutsideServiceModal(true);
//           // NEW: Do NOT clear pickupLocationData here, let the modal handle user dismissal
//           // setPickupLocationData({ name: "", coords: null }); // Remove this line
//         }
//       } else {
//         // NEW: Handle case where request was granted but coords were null (unlikely but possible)
//         console.warn(
//           "Geolocation request granted but no coordinates returned."
//         );
//         // Optionally update UI to show a generic error or retry option
//         // setPickupLocationData({ name: "", coords: null }); // Or clear if needed for other errors
//       }
//     } catch (err) {
//       console.error("Geolocation request or API call failed:", err);
//       // NEW: Optionally update UI to show the error from the hook or a generic message
//       // setErrorState("Failed to get location: " + err);
//       // setPickupLocationData({ name: "", coords: null }); // Or clear on generic error
//     } finally {
//       // NEW: Always stop fetching state when done (success or failure)
//       setIsFetchingLocation(false);
//     }
//   };

//   // NEW: Handle airport selection from the modal
//   const handleAirportSelectedFromModal = (selectedAirport: Airport) => {
//     // Use the coordinates from the geolocation request and the name/ID from the selected airport
//     setPickupLocationData({
//       name: selectedAirport.name,
//       coords: pickupLocationData.coords, // Use the coords obtained from geolocation
//     });
//     // The airport ID (selectedAirport.id) is now resolved and can be used
//     // in handleRequestRide in page.tsx for the booking API call.
//   };

//   const handleAirportSelect = (airportId: string) => {
//     let selectedCoords: [number, number] | null = null;
//     let selectedName = "";

//     switch (airportId) {
//       case "los":
//         selectedCoords = losCoords;
//         selectedName = "Murtala Muhammed Int'l Airport (LOS)";
//         break;
//       case "abv":
//         selectedCoords = abvCoords;
//         selectedName = "Nnamdi Azikiwe Int'l Airport (ABV)";
//         break;
//       default:
//         selectedName = "Unknown Airport";
//     }

//     if (selectedCoords) {
//       setPickupLocationData({
//         name: selectedName,
//         coords: selectedCoords,
//       });
//     }
//     setPickupOpen(false);
//   };

//   // NEW: Handle destination selection from simple dropdown (fallback)
//   const handleDestinationSelect = (selectedDestination: string) => {
//     // NEW: In a real implementation with autocomplete, the coordinates would come from the autocomplete result
//     // For now, use the map or set to null if not found
//     const selectedCoords = destinationCoordsMap[selectedDestination] || null;
//     setDestinationLocationData({
//       name: selectedDestination,
//       coords: selectedCoords,
//     });
//     setDestOpen(false);
//   };

//   // NEW: Handle destination changes from Google Maps Autocomplete
//   const handleDestinationChanged = (e: any) => { // 'e' is the event from StandaloneSearchBox
//     // Update local state name immediately as user types
//     setDestinationLocationData((prev) => ({ ...prev, name: e.target.value }));
//     setDestOpen(true); // Keep dropdown open while typing/searching
//   };

//   // NEW: Handle when a place is selected from the autocomplete dropdown
//   const handlePlaceChanged = () => {
//     if (searchBoxRef.current) {
//       const places = searchBoxRef.current.getPlaces();
//       if (places && places.length > 0) {
//         const place = places[0];
//         if (place.geometry && place.geometry.location) {
//           const lat = place.geometry.location.lat();
//           const lng = place.geometry.location.lng();
//           setDestinationLocationData({
//             name: place.formatted_address || place.name || "", // Prefer formatted address, fallback to name
//             coords: [lng, lat], // [longitude, latitude]
//           });
//           setDestOpen(false); // Close the dropdown after selection
//         } else {
//           console.error("Place selected but no geometry.location found.");
//         }
//       } else {
//           console.log("No places found from search box.");
//           // Optionally clear coordinates if user clears the input and presses enter/selects nothing
//           // setDestinationLocationData(prev => ({ ...prev, coords: null }));
//       }
//     }
//   };

//     const handleGrantAccessClick = () => {
//     // The browser prompt won't show again if previously denied.
//     // Show an instruction modal to guide the user.
//     setShowLocationSettingsModal(true);
//   }

//   // NEW: Combine internal fetching state with hook's loading state for UI
//   const showFetchingUI = isFetchingLocation || hookLoading;

//   return (
//     <div className="h-screen bg-achrams-bg-primary flex flex-col">
//       {/* NEW: Airport Selection Modal */}
//       <AirportSelectionModal
//         isOpen={showAirportSelectionModal}
//         onClose={() => setShowAirportSelectionModal(false)}
//         airports={airportsToSelect}
//         onSelect={handleAirportSelectedFromModal}
//       />
//       {/* NEW: Outside Service Area Modal */}
//       <OutsideServiceAreaModal
//         isOpen={showOutsideServiceModal}
//         onClose={() => setShowOutsideServiceModal(false)} // Close the modal
//       />


//       {/* Header container now spans full width with no horizontal padding */}
//       <div className="bg-achrams-primary-solid text-achrams-text-light px-0 py-4">
//         <div className="px-6">
//           <ACHRAMSHeader title="" />
//         </div>
//       </div>
//      {error && (error.includes("denied") || error.includes("Permission denied")) && (
//   // NEW BASED ON LATEST PROMPT: Use bg-amber-500 instead of bg-blue-600 or bg-achrams-primary-solid to avoid header clash
//   <div className="bg-blue-600 text-achrams-text-light p-3 flex items-center justify-between"> 
//     <div className="flex items-center gap-2">
//       <Navigation className="w-5 h-5" />
//       <span>This app requires your location access to work</span>
//     </div>
//     {/* NEW BASED ON LATEST PROMPT: Use achrams-bg-secondary and achrams-text-light for the button */}
//     <button
//       onClick={handleGrantAccessClick} 
//       className="bg-white text-achrams-text-primary px-4 py-1 rounded-full text-sm font-medium hover:bg-achrams-bg-primary" // NEW BASED ON LATEST PROMPT: Adjusted button style for contrast
//     >
//       Grant access
//     </button>
//   </div>
// )}

//        {showLocationSettingsModal && (
//         <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
//           <div className="bg-white rounded-lg p-6 max-w-md w-full">
//             <h3 className="text-lg font-semibold mb-2">Enable Location Access</h3>
//             <p className="mb-4">
//               To use this feature, please allow location access in your browser settings.
//             </p>
//             <ol className="list-decimal list-inside mb-4 space-y-1 text-sm">
//               <li>Click the lock icon or info icon in the address bar.</li>
//               <li>Select "Site settings" or "Permissions".</li>
//               <li>Find "Location" and change it to "Allow".</li>
//               <li>Refresh the page or try again.</li>
//             </ol>
//             <button
//               onClick={() => setShowLocationSettingsModal(false)}
//               className="w-full bg-achrams-primary-solid text-white py-2 rounded-lg"
//             >
//               Close
//             </button>
//           </div>
//         </div>
//       )}
//       <div className="flex-1 px-6 py-8 overflow-y-auto">
//         <h2 className="text-2xl font-semibold tracking-tight text-achrams-text-primary pb-4">
//           Book Your Airport Ride
//         </h2>

//         <div className="space-y-4">
//           {/* Pickup */}
//           <div className="relative">
//             {/* Main Input Field */}
//             <div className="flex items-center gap-3 bg-achrams-bg-secondary rounded-xl px-4 py-4 border border-achrams-border">
//               <div className="w-2 h-2 bg-achrams-primary-solid rounded-full" />
//               <input
//                 type="text"
//                 placeholder="Airport pickup location"
//                 // NEW: Show fetching message or actual name, make read-only if fetching
//                 value={
//                   showFetchingUI
//                     ? "Getting your location..."
//                     : pickupLocationData.name
//                 }
//                 // NEW: Disable input while fetching
//                 onChange={(e) => {
//                   if (!showFetchingUI) {
//                     setPickupLocationData((prev) => ({
//                       ...prev,
//                       name: e.target.value,
//                     }));
//                   }
//                 }}
//                 onFocus={() => {
//                   if (!showFetchingUI) {
//                     setPickupOpen(true);
//                   }
//                 }}
//                 // NEW: Show read-only state while fetching
//                 readOnly={showFetchingUI}
//                 className={`flex-1 bg-transparent outline-none text-base ${
//                   // NEW: Apply different text color when fetching to indicate disabled state
//                   showFetchingUI
//                     ? "text-achrams-text-secondary italic"
//                     : "text-achrams-text-primary"
//                 }`}
//               />
//               {/* Dropdown/Open Button */}
//               <div className="flex items-center">
//                 {/* NEW: Show loader next to dropdown button while fetching, disable button */}
//                 {showFetchingUI && (
//                   <Loader className="w-5 h-5 animate-spin text-achrams-primary-solid mr-1" />
//                 )}
//                 <button
//                   onClick={() => {
//                     if (!showFetchingUI) {
//                       setPickupOpen(!pickupOpen);
//                     }
//                   }}
//                   disabled={showFetchingUI} // NEW: Disable button while fetching
//                   className={`p-2 ${
//                     // NEW: Apply different text color and cursor when disabled
//                     showFetchingUI
//                       ? "text-achrams-text-secondary opacity-50 cursor-not-allowed"
//                       : "text-achrams-text-secondary hover:text-achrams-text-primary"
//                   } transition-colors`}
//                 >
//                   {/* NEW: Show spinner inside button instead of Navigation icon while fetching */}
//                   {showFetchingUI ? (
//                     <Loader className="w-5 h-5 animate-spin text-achrams-primary-solid" />
//                   ) : pickupOpen ? (
//                     <ChevronDown className="w-5 h-5" />
//                   ) : (
//                     <Navigation className="w-5 h-5" />
//                   )}
//                 </button>
//               </div>
//             </div>

//             {/* Dropdown Content */}
//             {pickupOpen && (
//               <div className="absolute top-full left-0 right-0 mt-1 bg-white rounded-xl shadow-lg border border-achrams-border z-50 max-h-64 overflow-y-auto">
//                 {/* NEW: Show fetching indicator if loading, otherwise show options */}
//                 {showFetchingUI ? (
//                   <div className="w-full px-4 py-3 flex items-center gap-3 justify-center text-achrams-text-secondary">
//                     <Loader className="w-5 h-5 animate-spin mr-2" />
//                     <span>Locating you...</span>{" "}
//                     {/* NEW: Professional message */}
//                   </div>
//                 ) : (
//                   <>
//                     <button
//                       onClick={handleUseCurrentLocation}
//                       disabled={showFetchingUI} // NEW: Disable button while fetching (shouldn't be reachable here, but good practice)
//                       className="w-full px-4 py-3 flex items-center gap-3 hover:bg-achrams-bg-secondary border-b border-achrams-border text-left disabled:opacity-50 disabled:cursor-not-allowed" // NEW: Add disabled styles
//                     >
//                       <MapPin className="w-5 h-5 text-achrams-primary-solid flex-shrink-0" />
//                       <span>Use my current location</span>
//                     </button>
//                     {/* ... Other Airport Buttons ... */}
//                     {airports.slice(1).map((a) => (
//                       <button
//                         key={a.id}
//                         onClick={() => handleAirportSelect(a.id)} // Use new handler
//                         className="w-full px-4 py-3 flex items-start gap-3 hover:bg-achrams-bg-secondary border-b border-achrams-border text-left"
//                       >
//                         <Plane className="w-5 h-5 text-achrams-primary-solid flex-shrink-0 mt-0.5" />
//                         <div>
//                           <div className="font-medium text-achrams-text-primary text-sm">
//                             {a.name}
//                           </div>
//                           <div className="text-xs text-achrams-text-secondary">
//                             {a.city}
//                           </div>
//                         </div>
//                       </button>
//                     ))}
//                   </>
//                 )}
//               </div>
//             )}
//           </div>

//           <div className="flex items-center justify-center py-1">
//             <div className="w-0.5 h-6 bg-achrams-border" />
//           </div>

//           {/* Destination */}
//           <div className="relative">
//             {/* NEW: Wrap destination input with LoadScript and StandaloneSearchBox */}
//             <LoadScript
//               googleMapsApiKey={GOOGLE_MAPS_API_KEY}
//               libraries={["places"]}
//             >
//               <StandaloneSearchBox
//                 onLoad={(ref) => {
//                   searchBoxRef.current = ref; // Store the reference
//                 }}
//                 onUnmount={() => {
//                   searchBoxRef.current = null; // Clean up reference
//                 }}
//                 onPlacesChanged={handlePlaceChanged} // Handle place selection
//               >
//                 <div className="flex items-center gap-3 bg-achrams-bg-secondary rounded-xl px-4 py-4 border border-achrams-border">
//                   <div className="w-2 h-2 bg-achrams-primary-solid rounded-full" />
//                   <input
//                     type="text"
//                     placeholder="Enter destination"
//                     value={destinationLocationData.name} // NEW: Use name from local state
//                     onChange={handleDestinationChanged} // NEW: Handle input change for autocomplete
//                     onFocus={() => setDestOpen(true)} // NEW: Open dropdown on focus
//                     className="flex-1 bg-transparent outline-none text-base text-achrams-text-primary"
//                   />
//                   {destOpen &&
//                     destinationLocationData.name && ( // NEW: Use local state
//                       <button
//                         onClick={() => {
//                           setDestinationLocationData({ name: "", coords: null }); // NEW: Clear local state
//                           setDestination(""); // NEW: Clear parent state
//                         }}
//                         className="p-2 text-achrams-text-secondary hover:text-achrams-text-primary transition-colors"
//                       >
//                         <X className="w-5 h-5" />
//                       </button>
//                     )}
//                 </div>
//               </StandaloneSearchBox>
//             </LoadScript>
//             {/* NEW: Dropdown for simple destination suggestions (fallback if autocomplete not used) */}
//             {/* This is now hidden when the search box is active, but could be shown if needed */}
//             {destOpen &&
//               destinationLocationData.name &&
//               !searchBoxRef.current && ( // NEW: Only show if search box ref is not active (fallback logic)
//                 <div className="absolute top-full left-0 right-0 mt-1 bg-white rounded-xl shadow-lg border border-achrams-border z-50 max-h-64 overflow-y-auto">
//                   {Object.keys(destinationCoordsMap)
//                     .filter((d) =>
//                       d
//                         .toLowerCase()
//                         .includes(destinationLocationData.name.toLowerCase())
//                     )
//                     .map((d, i) => (
//                       <button
//                         key={i}
//                         onClick={() => handleDestinationSelect(d)} // NEW: Use new handler
//                         className="w-full px-4 py-3 flex items-center gap-3 hover:bg-achrams-bg-secondary border-b border-achrams-border text-left"
//                       >
//                         <MapPin className="w-5 h-5 text-achrams-primary-solid flex-shrink-0" />
//                         <div className="text-achrams-text-primary text-sm">
//                           {d}
//                         </div>
//                       </button>
//                     ))}
//                 </div>
//               )}
//           </div>
//         </div>

//         {fareEstimate && (
//           <div className="mt-6 p-4 bg-achrams-bg-secondary rounded-xl border border-achrams-border">
//             <div className="flex justify-between items-center">
//               <span className="text-achrams-text-secondary">
//                 Estimated fare
//               </span>
//               <span className="text-xl font-bold text-achrams-text-primary">
//                 {fareEstimate.toLocaleString()}
//               </span>
//             </div>
//           </div>
//         )}
//       </div>
//       <div className="p-6">
//         <button
//           onClick={onProceed}
//           disabled={!fareEstimate}
//           className={`w-full py-4 rounded-xl text-lg font-bold text-achrams-text-light transition-all ${
//             fareEstimate
//               ? "bg-achrams-gradient-primary hover:opacity-95 active:scale-[0.98] shadow-md"
//               : "bg-achrams-secondary-solid opacity-75 cursor-not-allowed"
//           }`}
//         >
//           {fareEstimate
//             ? `Proceed  ${fareEstimate.toLocaleString()}`
//             : "Enter destinations"}
//         </button>
//       </div>

//       {/* Modals handled by parent */}
//     </div>
//   );
// }


----- FILE: src/components/app/screens/DriverAssignedScreen.tsx -----
// src/components/app/screens/DriverAssignedScreen.tsx
'use client';

import { MapPin, MessageCircle, Phone, X, CheckCircle, Shield } from 'lucide-react'; // Added CheckCircle
import { Driver } from '@/types/passenger';
import { useState, useEffect } from 'react'; // Add useEffect if not already present




interface DriverAssignedScreenProps {
  pickup: string;
  destination: string;
  driver: Driver;
  verificationCode: string; // NEW: Prop for verification code
  onShowDirections: () => void;
  onShowDriverVerification: () => void; // NEW: Handler for verification modal
  onStartTrip: () => void;
  onBack: () => void;
}

export default function DriverAssignedScreen({
  pickup,
  destination,
  driver,
  verificationCode, // NEW: Destructure prop
  onShowDirections,
  onShowDriverVerification, // NEW: Destructure handler
  onStartTrip,
  onBack,
}: DriverAssignedScreenProps) {
  // NEW: State to track if driver is verified (mock for now)
  const [isVerified, setIsVerified] = useState(false);

  // NEW: Simulate verification after 5 seconds for demo
  useEffect(() => {
    const timer = setTimeout(() => {
      setIsVerified(true);
    }, 5000);

    return () => clearTimeout(timer);
  }, []);

  return (
    <div className="h-screen bg-achrams-bg-primary flex flex-col relative">
      <div className="bg-achrams-primary-solid text-achrams-text-light px-6 py-4 flex items-center justify-between">
        <h1 className="text-xl font-bold">Driver Assigned</h1>
        <button onClick={onBack}>
          <X className="w-6 h-6" />
        </button>
      </div>
      <div className="flex-1 overflow-y-auto px-6 py-6">
        {/* Trip Details */}
        <div className="bg-achrams-bg-secondary rounded-xl p-4 mb-6 border border-achrams-border">
          <div className="flex items-start gap-3 mb-3">
            <div className="w-2 h-2 bg-achrams-primary-solid rounded-full mt-2"></div>
            <div className="flex-1">
              <div className="text-xs text-achrams-text-secondary mb-1">PICKUP</div>
              <div className="font-medium text-achrams-text-primary">{pickup}</div>
            </div>
          </div>
          <div className="ml-3 w-0.5 h-6 bg-achrams-border"></div>
          <div className="flex items-start gap-3">
            <div className="w-2 h-2 bg-achrams-primary-solid rounded-full mt-2"></div>
            <div className="flex-1">
              <div className="text-xs text-achrams-text-secondary mb-1">DESTINATION</div>
              <div className="font-medium text-achrams-text-primary">{destination}</div>
            </div>
          </div>
        </div>

        {/* Driver Card */}
        <div className="bg-achrams-bg-secondary border border-achrams-border rounded-xl p-6 mb-4">
          <div className="flex items-center gap-4 mb-6">
            <div className="w-20 h-20 bg-gradient-to-br from-achrams-primary-solid to-achrams-secondary-solid rounded-full flex items-center justify-center text-achrams-text-light text-2xl font-bold">
              {driver.initials || driver.name?.charAt(0) || 'D'}
            </div>
            <div className="flex-1">
              <h3 className="text-xl font-bold mb-1 text-achrams-text-primary">{driver.name}</h3>
              <div className="flex items-center gap-1 text-sm text-achrams-text-secondary">
                <span className="font-medium text-achrams-text-primary">{driver.rating}</span>
                <span className="text-achrams-text-secondary"> {driver.trips} trips</span>
              </div>
            </div>
          </div>
          <div className="bg-achrams-bg-primary rounded-lg p-4 mb-4 border border-achrams-border">
            <div className="text-sm text-achrams-text-secondary mb-2">{driver.car_type || "Toyota  Camry"}  {driver.car_color || "Red"}</div>
            <div className="text-3xl font-mono font-bold text-achrams-text-primary">{driver.plate_number || "XYZ-ABJ-14"}</div>
          </div>
          <div className="grid grid-cols-2 gap-3">
            <button className="flex items-center justify-center gap-2 py-3 bg-achrams-bg-primary border border-achrams-border rounded-xl font-medium text-achrams-text-primary hover:bg-achrams-bg-secondary transition-colors">
              <MessageCircle className="w-5 h-5" />
              Message
            </button>
            <button className="flex items-center justify-center gap-2 py-3 bg-achrams-bg-primary border border-achrams-border rounded-xl font-medium text-achrams-text-primary hover:bg-achrams-bg-secondary transition-colors">
              <Phone className="w-5 h-5" />
              Call
            </button>
          </div>
        </div>

        {/* NEW: Verify Driver Link/Button */}
        <button
          onClick={onShowDriverVerification}
          className="w-full flex items-center justify-center gap-2 py-3 mb-3 bg-achrams-bg-primary border border-achrams-border rounded-xl font-medium text-achrams-text-primary hover:bg-achrams-bg-secondary transition-colors"
        >
          {isVerified ? <CheckCircle className="w-5 h-5 text-green-500" /> : <Shield className="w-5 h-5" />}
          {isVerified ? 'Driver Verified' : 'Verify Driver'}
        </button>

        <button
          onClick={onShowDirections}
          className="w-full border border-achrams-primary-solid text-achrams-primary-solid bg-transparent py-4 rounded-xl font-semibold mb-3 hover:bg-achrams-bg-secondary transition-colors"
        >
          Get directions to pickup
        </button>
        <button
          onClick={onStartTrip}
          disabled={!isVerified} // NEW: Disable until verified (mock logic)
          className={`w-full py-4 rounded-xl font-semibold transition-all ${
            isVerified
              ? 'bg-achrams-gradient-primary text-achrams-text-light hover:opacity-90 active:scale-[0.98]'
              : 'bg-achrams-secondary-solid text-achrams-text-light opacity-75 cursor-not-allowed'
          }`}
        >
          Start trip
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/screens/AssigningScreen.tsx -----
// src/components/app/screens/AssigningScreen.tsx
'use client';

import { Loader } from 'lucide-react';


interface RequestStatusProp {
  status: 'loading' | 'accepted' | 'no-driver' | 'error' | null;
}
export default function AssigningScreen({status,}: RequestStatusProp) {
    const isNoDriver = status === "no-driver";
    const error = status === "error";
  //if (status == 'no-driver') // I want to change the spinner to stop spinning 
  return (
    <div className="h-screen bg-achrams-bg-primary flex flex-col items-center justify-center px-6">
      {/* Spinner using ACHRAMS primary color */
      }
      <div className="h-screen bg-achrams-bg-primary flex flex-col items-center justify-center px-6">
      {/* Spinner */}
      <div
        className={`w-20 h-20 border-4 border-achrams-primary-solid border-t-transparent rounded-full mb-8 ${
          isNoDriver || error ? "" : "animate-spin"
        }` 
      
      } 
      ></div>

      <h2 className="text-2xl font-bold mb-2 text-achrams-text-primary">
        {isNoDriver ? "No Driver Available" : "Please hold on"}
        {error ? status : "" }
      </h2>

      <p className="text-achrams-text-secondary">
        {isNoDriver || error ? "Try again shortly" : "Assigning a driver"}
      </p>
    </div>
    </div>
  );
}

----- FILE: src/components/app/screens/TripHistoryScreen.tsx -----
// src/components/app/screens/TripHistoryScreen.tsx
import { useState, useEffect } from 'react';
import { MapPin, Clock, Star, Calendar, ChevronRight } from 'lucide-react';
import { apiClient } from '@/services/apiClient'; // Assuming you create this service

interface Trip {
  id: string;
  amount: {
    formatted: string;
  };
  status: {
    label: string;
    value: string;
  };
  pickup_address: string;
  destination_address: string;
  created_at: string; // ISO date string
  rating?: {
    score: number;
    comment?: string;
  } | null;
  // Add other fields as needed from the API response
}

export default function TripHistoryScreen({ onBack, onSelectTrip }: { onBack: () => void; onSelectTrip: (tripId: string) => void }) {
  const [trips, setTrips] = useState<Trip[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchTrips = async () => {
      try {
        setLoading(true);
        setError(null);
        // NEW: Call the trips API using apiClient
        // Example: GET /trips?page=1&limit=20 (pagination might be needed)
        // Example: GET /trips?status=completed (filtering might be needed)
        const response = await apiClient.get('/trips'); // Use correct endpoint and params from Postman doc

        console.log("Trip History Response:", response); // Debug log
        if (response.status === 200 && response.data && Array.isArray(response.data.data)) {
          setTrips(response.data.data);
        } else {
          setError('Failed to load trip history.');
        }
      } catch (err) {
        console.error("Trip History Fetch Error:", err);
        let errorMessage = 'An unexpected error occurred.';
        if (err instanceof Error) {
          errorMessage = err.message;
        }
        setError(errorMessage);
      } finally {
        setLoading(false);
      }
    };

    fetchTrips();
  }, []); // Fetch on mount


  if (loading) {
    return (
      <div className="h-screen bg-achrams-bg-primary flex items-center justify-center">
        <div className="text-center">
          <div className="w-16 h-16 border-4 border-achrams-primary-solid border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p className="text-achrams-text-secondary">Loading trips...</p>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="h-screen bg-achrams-bg-primary flex flex-col items-center justify-center p-6">
        <p className="text-red-500 text-center mb-6">{error}</p>
        <button
          onClick={() => window.location.reload()} // Simple retry for now
          className="bg-achrams-gradient-primary text-achrams-text-light py-3 px-6 rounded-xl font-semibold"
        >
          Retry
        </button>
      </div>
    );
  }

  return (
    <div className="h-screen bg-achrams-bg-primary flex flex-col">
      {/* Header */}
      <div className="bg-achrams-primary-solid text-achrams-text-light px-6 py-4 flex items-center">
        <button onClick={onBack} className="mr-4">
          <ChevronLeft className="w-6 h-6" />
        </button>
        <h1 className="text-xl font-bold">Trip History</h1>
      </div>

      {/* Content */}
      <div className="flex-1 overflow-y-auto p-6">
        {trips.length === 0 ? (
          <div className="text-center py-12">
            <p className="text-achrams-text-secondary">No trips found.</p>
          </div>
        ) : (
          <div className="space-y-4">
            {trips.map((trip) => (
              <div
                key={trip.id}
                onClick={() => onSelectTrip(trip.id)} // NEW: Navigate to TripDetailsScreen
                className="bg-achrams-bg-secondary rounded-2xl p-5 shadow-sm border border-achrams-border flex items-center justify-between cursor-pointer hover:bg-achrams-bg-primary transition-colors"
              >
                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2 mb-1">
                    <Calendar className="w-4 h-4 text-achrams-text-tertiary flex-shrink-0" />
                    <span className="text-xs text-achrams-text-tertiary">
                      {new Date(trip.created_at).toLocaleDateString()}
                    </span>
                  </div>
                  <div className="flex items-start gap-2 mb-2">
                    <MapPin className="w-4 h-4 text-achrams-text-secondary mt-0.5 flex-shrink-0" />
                    <div className="text-sm text-achrams-text-primary truncate">{trip.pickup_address}</div>
                  </div>
                  <div className="flex items-start gap-2 mb-2">
                    <MapPin className="w-4 h-4 text-achrams-text-secondary mt-0.5 flex-shrink-0" />
                    <div className="text-sm text-achrams-text-primary truncate">{trip.destination_address}</div>
                  </div>
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-1">
                      <span className="text-sm font-medium text-achrams-text-primary">{trip.amount.formatted}</span>
                      <span className={`text-xs px-2 py-0.5 rounded-full ${
                        trip.status.value === 'completed' ? 'bg-green-100 text-green-800' :
                        trip.status.value === 'cancelled' ? 'bg-red-100 text-red-800' :
                        'bg-yellow-100 text-yellow-800' // For statuses like 'driver not found', 'searching', etc.
                      }`}>
                        {trip.status.label}
                      </span>
                    </div>
                    {trip.rating && (
                      <div className="flex items-center gap-1">
                        <Star className="w-4 h-4 fill-yellow-400 text-yellow-400" />
                        <span className="text-xs text-achrams-text-secondary">{trip.rating.score}</span>
                      </div>
                    )}
                  </div>
                </div>
                <ChevronRight className="w-5 h-5 text-achrams-text-secondary flex-shrink-0 ml-2" />
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}

----- FILE: src/components/app/screens/TripCompleteScreen.tsx -----
// src/components/app/screens/TripCompleteScreen.tsx
'use client';

import { Check } from 'lucide-react';
import { Driver } from '@/types/passenger';

// NEW: Define the type for the onDone prop
type OnDoneHandler = () => void;

interface TripCompleteScreenProps {
  fareEstimate: number | null;
  driver: Driver;
  onRate?: () => void;
  // NEW: Add onDone prop
  onDone: OnDoneHandler;
}

export default function TripCompleteScreen({
  fareEstimate,
  driver,
  onRate,
  onDone, // NEW: Destructure the onDone prop
}: TripCompleteScreenProps) {
  return (
    <div className="h-screen bg-achrams-bg-primary flex flex-col">
      <div className="bg-achrams-primary-solid text-achrams-text-light px-6 py-4">
        <h1 className="text-xl font-bold">Trip completed</h1>
      </div>
      <div className="flex-1 overflow-y-auto px-6 py-8">
        <div className="text-center mb-8">
          <div className="w-20 h-20 bg-achrams-bg-secondary rounded-full flex items-center justify-center mx-auto mb-4 border border-achrams-border">
            <Check className="w-10 h-10 text-achrams-primary-solid" />
          </div>
          <h2 className="text-2xl font-bold mb-2 text-achrams-text-primary">You've arrived!</h2>
          <p className="text-achrams-text-secondary">How was your trip?</p>
        </div>

        <div className="bg-achrams-bg-secondary rounded-xl p-6 mb-6 border border-achrams-border">
          <div className="flex justify-between items-center mb-4">
            <span className="text-achrams-text-secondary">Total Fare</span>
            <span className="text-3xl font-bold text-achrams-text-primary">
              {fareEstimate?.toLocaleString() || '0'}
            </span>
          </div>
          <div className="text-sm text-achrams-text-secondary">Paid via Cash</div>
        </div>

        {onRate && (
          <button
            onClick={onRate} // Keep existing rate button
            className="w-full py-4 rounded-xl font-semibold mb-3 bg-achrams-gradient-primary text-achrams-text-light hover:opacity-90 active:scale-[0.98] transition-all"
          >
            Rate your ride
          </button>
        )}

        {/* NEW: Button that triggers the onDone handler passed from page.tsx */}
        <button
          onClick={onDone} // NEW: Call the onDone function passed as a prop
          className="w-full py-4 rounded-xl font-semibold bg-achrams-gradient-primary text-achrams-text-light hover:opacity-90 active:scale-[0.98] transition-all"
        >
          Done
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/screens/SettingsScreen.tsx -----
// src/components/app/screens/SettingsScreen.tsx
import { ChevronLeft, Shield, User, CreditCard, Bell, Globe, HelpCircle, LogOut, ChevronRight } from 'lucide-react';

export default function SettingsScreen({ onBack, onShowProfile, onShowSecurity, onShowPayment, onShowNotifications, onShowLanguage, onShowHelp, onLogout }: { onBack: () => void; onShowProfile: () => void; onShowSecurity: () => void; onShowPayment: () => void; onShowNotifications: () => void; onShowLanguage: () => void; onShowHelp: () => void; onLogout: () => void }) {
  return (
    <div className="h-screen bg-achrams-bg-primary flex flex-col">
      {/* Header */}
      <div className="bg-achrams-primary-solid text-achrams-text-light px-6 py-4 flex items-center">
        <button onClick={onBack} className="mr-4">
          <ChevronLeft className="w-6 h-6" />
        </button>
        <h1 className="text-xl font-bold">Settings</h1>
      </div>

      {/* Content */}
      <div className="flex-1 overflow-y-auto p-6 space-y-6">
        {/* Account */}
        <div className="bg-achrams-bg-secondary rounded-xl border border-achrams-border">
          <h3 className="text-lg font-semibold px-4 py-3 text-achrams-text-primary">Account</h3>
          <button
            onClick={onShowProfile}
            className="w-full flex items-center justify-between px-4 py-3 hover:bg-achrams-bg-primary border-b border-achrams-border text-left"
          >
            <div className="flex items-center gap-3">
              <User className="w-5 h-5 text-achrams-text-secondary" />
              <span>Edit Profile</span>
            </div>
            <ChevronRight className="w-5 h-5 text-achrams-text-secondary" />
          </button>
          <button
            onClick={onShowSecurity}
            className="w-full flex items-center justify-between px-4 py-3 hover:bg-achrams-bg-primary border-b border-achrams-border text-left"
          >
            <div className="flex items-center gap-3">
              <Shield className="w-5 h-5 text-achrams-text-secondary" />
              <span>Security</span>
            </div>
            <ChevronRight className="w-5 h-5 text-achrams-text-secondary" />
          </button>
          <button
            onClick={onShowPayment}
            className="w-full flex items-center justify-between px-4 py-3 hover:bg-achrams-bg-primary text-left"
          >
            <div className="flex items-center gap-3">
              <CreditCard className="w-5 h-5 text-achrams-text-secondary" />
              <span>Payment Methods</span>
            </div>
            <ChevronRight className="w-5 h-5 text-achrams-text-secondary" />
          </button>
        </div>

        {/* Preferences */}
        <div className="bg-achrams-bg-secondary rounded-xl border border-achrams-border">
          <h3 className="text-lg font-semibold px-4 py-3 text-achrams-text-primary">Preferences</h3>
          <button
            onClick={onShowNotifications}
            className="w-full flex items-center justify-between px-4 py-3 hover:bg-achrams-bg-primary border-b border-achrams-border text-left"
          >
            <div className="flex items-center gap-3">
              <Bell className="w-5 h-5 text-achrams-text-secondary" />
              <span>Notifications</span>
            </div>
            <ChevronRight className="w-5 h-5 text-achrams-text-secondary" />
          </button>
          <button
            onClick={onShowLanguage}
            className="w-full flex items-center justify-between px-4 py-3 hover:bg-achrams-bg-primary text-left"
          >
            <div className="flex items-center gap-3">
              <Globe className="w-5 h-5 text-achrams-text-secondary" />
              <span>Language</span>
            </div>
            <ChevronRight className="w-5 h-5 text-achrams-text-secondary" />
          </button>
        </div>

        {/* Support */}
        <div className="bg-achrams-bg-secondary rounded-xl border border-achrams-border">
          <h3 className="text-lg font-semibold px-4 py-3 text-achrams-text-primary">Support</h3>
          <button
            onClick={onShowHelp}
            className="w-full flex items-center justify-between px-4 py-3 hover:bg-achrams-bg-primary border-b border-achrams-border text-left"
          >
            <div className="flex items-center gap-3">
              <HelpCircle className="w-5 h-5 text-achrams-text-secondary" />
              <span>Help Center</span>
            </div>
            <ChevronRight className="w-5 h-5 text-achrams-text-secondary" />
          </button>
          <button
            onClick={onLogout}
            className="w-full flex items-center justify-between px-4 py-3 hover:bg-red-50 text-left text-red-600"
          >
            <div className="flex items-center gap-3">
              <LogOut className="w-5 h-5" />
              <span>Log Out</span>
            </div>
          </button>
        </div>
      </div>
    </div>
  );
}

----- FILE: src/components/app/screens/WalletScreen.tsx -----
// src/components/app/screens/WalletScreen.tsx
import { useState, useEffect } from 'react';
import { Wallet, TrendingUp, TrendingDown, Calendar, Clock } from 'lucide-react';
import { apiClient } from '@/services/apiClient'; // Assuming you create this service

interface Transaction {
  id: string;
  reference: string;
  amount: {
    formatted: string;
    currency: string;
    amount: number;
  };
  status: {
    label: string;
    value: string;
  };
  entry_type: {
    label: string; // e.g., "Credit", "Debit"
    value: string; // e.g., "credit", "debit"
  };
  narration: string;
  created_at: string; // ISO date string
  // Add other fields as needed from the API response
}

export default function WalletScreen({ onBack }: { onBack: () => void }) {
  const [balance, setBalance] = useState({ formatted: '0.00', currency: 'NGN', amount: 0 });
  const [transactions, setTransactions] = useState<Transaction[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchWalletData = async () => {
      try {
        setLoading(true);
        setError(null);
        // NEW: Call the wallet details API using apiClient
        // Example: GET /wallets (to get balance)
        const balanceResponse = await apiClient.get('/wallets'); // Use correct endpoint from Postman doc
        // Example: GET /wallets/history (to get history)
        const historyResponse = await apiClient.get('/wallets/history'); // Use correct endpoint from Postman doc

        console.log("Wallet Balance Response:", balanceResponse); // Debug log
        console.log("Wallet History Response:", historyResponse); // Debug log

        if (balanceResponse.status === 200 && balanceResponse.data && balanceResponse.data.data) {
          setBalance(balanceResponse.data.data.balance); // Adjust based on actual API response structure for balance
        } else {
          setError('Failed to load wallet balance.');
        }

        if (historyResponse.status === 200 && historyResponse.data && Array.isArray(historyResponse.data.data)) {
          setTransactions(historyResponse.data.data);
        } else {
          setError('Failed to load transaction history.');
        }
      } catch (err) {
        console.error("Wallet Data Fetch Error:", err);
        let errorMessage = 'An unexpected error occurred.';
        if (err instanceof Error) {
          errorMessage = err.message;
        }
        setError(errorMessage);
      } finally {
        setLoading(false);
      }
    };

    fetchWalletData();
  }, []); // Fetch on mount


  if (loading) {
    return (
      <div className="h-screen bg-achrams-bg-primary flex items-center justify-center">
        <div className="text-center">
          <div className="w-16 h-16 border-4 border-achrams-primary-solid border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p className="text-achrams-text-secondary">Loading wallet...</p>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="h-screen bg-achrams-bg-primary flex flex-col items-center justify-center p-6">
        <p className="text-red-500 text-center mb-6">{error}</p>
        <button
          onClick={() => window.location.reload()} // Simple retry for now
          className="bg-achrams-gradient-primary text-achrams-text-light py-3 px-6 rounded-xl font-semibold"
        >
          Retry
        </button>
      </div>
    );
  }

  return (
    <div className="h-screen bg-achrams-bg-primary flex flex-col">
      {/* Header */}
      <div className="bg-achrams-primary-solid text-achrams-text-light px-6 py-4 flex items-center">
        <button onClick={onBack} className="mr-4">
          <ChevronLeft className="w-6 h-6" />
        </button>
        <h1 className="text-xl font-bold">My Wallet</h1>
      </div>

      {/* Content */}
      <div className="flex-1 overflow-y-auto">
        {/* Balance Card */}
        <div className="bg-gradient-to-r from-achrams-primary-solid to-achrams-secondary-solid text-achrams-text-light p-6 m-6 rounded-2xl shadow-md">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm opacity-80">Available Balance</p>
              <p className="text-3xl font-bold">{balance.formatted}</p>
            </div>
            <Wallet className="w-12 h-12 opacity-80" />
          </div>
        </div>

        {/* Transactions List */}
        <div className="mx-6 mb-6">
          <h2 className="text-lg font-semibold mb-4 text-achrams-text-primary">Transaction History</h2>
          {transactions.length === 0 ? (
            <div className="text-center py-8">
              <p className="text-achrams-text-secondary">No transactions found.</p>
            </div>
          ) : (
            <div className="space-y-4">
              {transactions.map((tx) => (
                <div key={tx.id} className="bg-achrams-bg-secondary rounded-xl p-4 border border-achrams-border flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <div className={`p-2 rounded-full ${
                      tx.entry_type.value === 'credit' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'
                    }`}>
                      {tx.entry_type.value === 'credit' ? <TrendingUp className="w-5 h-5" /> : <TrendingDown className="w-5 h-5" />}
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="font-medium text-achrams-text-primary truncate">{tx.narration || tx.reference}</p>
                      <div className="flex items-center gap-2 text-xs text-achrams-text-tertiary">
                        <Calendar className="w-3 h-3" />
                        <span>{new Date(tx.created_at).toLocaleDateString()}</span>
                        <Clock className="w-3 h-3" />
                        <span>{new Date(tx.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                      </div>
                    </div>
                  </div>
                  <div className="text-right">
                    <p className={`font-semibold ${
                      tx.entry_type.value === 'credit' ? 'text-green-600' : 'text-red-600'
                    }`}>
                      {tx.entry_type.value === 'credit' ? '+' : '-'}{tx.amount.formatted}
                    </p>
                    <span className={`text-xs px-2 py-0.5 rounded-full ${
                      tx.status.value === 'successful' ? 'bg-green-100 text-green-800' :
                      tx.status.value === 'failed' ? 'bg-red-100 text-red-800' :
                      'bg-yellow-100 text-yellow-800'
                    }`}>
                      {tx.status.label}
                    </span>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

----- FILE: src/components/app/screens/DashboardScreen.tsx -----
// src/components/app/screens/DashboardScreen.tsx
'use client';

import { useEffect, useState } from 'react';
import { MapPin, Plus, CreditCard, ShieldAlert, Settings, Bell, Clock, Wallet, User } from 'lucide-react'; // NEW: Add icons
import BottomNavBar from '../ui/BottomNavBar'; // NEW: Import BottomNavBar
import { Driver } from '@/types/passenger'; // Assuming this type exists or define it

interface DashboardScreenProps {
  passengerData: { name: string; phone: string; email: string };
  walletBalance: number; // NEW: Pass wallet balance from parent
  activeTrip?: { id: string; status: string; driver?: Driver; destination: string }; // NEW: Pass active trip data if any
  onShowProfile: () => void;
  onBookNewTrip: () => void;
  onShowTripHistory: () => void; // NEW: Handler to trigger trip history view
  onShowWallet: () => void; // NEW: Handler to trigger wallet view
  onShowSettings: () => void; // NEW: Handler to trigger settings view
  onShowActiveTrip: () => void; // NEW: Handler if active trip card is clicked
}

export default function DashboardScreen({
  passengerData,
  walletBalance, // NEW: Destructure balance
  activeTrip, // NEW: Destructure active trip data
  onShowProfile,
  onBookNewTrip,
  onShowTripHistory, // NEW: Destructure handler
  onShowWallet, // NEW: Destructure handler
  onShowSettings, // NEW: Destructure handler
  onShowActiveTrip, // NEW: Destructure handler
}: DashboardScreenProps) {
  const hour = new Date().getHours();
  const greeting = hour < 12 ? 'Good morning' : hour < 18 ? 'Good afternoon' : 'Good evening';
  const firstName = passengerData.name.split(' ')[0] || 'Passenger';

  // NEW: State for weather (could be fetched from an API)
  const [weather, setWeather] = useState({ temp: 28, condition: 'sunny', location: 'Lagos' });

  // NEW: Example recent trip data (could come from props or fetched)
  const recentTrip = {
    id: 'recent_1',
    pickup: 'Murtala Muhammed Airport',
    destination: 'VI, Lagos',
    fare: 4500,
    status: 'completed',
    date: 'Today',
  };

  return (
    <div className="h-screen bg-achrams-bg-primary flex flex-col pb-20"> {/* pb-20 to account for fixed BottomNavBar */}
      {/* Header */}
      <div className="bg-achrams-primary-solid text-achrams-text-light px-6 py-4 flex items-center justify-between">
        <h1 className="text-2xl font-bold">ACHRAM</h1>
        <button
          onClick={onShowProfile}
          className="w-10 h-10 bg-gradient-to-br from-achrams-primary-solid to-achrams-secondary-solid rounded-full flex items-center justify-center text-sm font-bold shadow-lg"
        >
          {passengerData.name
            .split(' ')
            .map((n) => n[0])
            .join('')}
        </button>
      </div>

      {/* Scrollable Content Area */}
      <div className="flex-1 overflow-y-auto px-6 py-8">
        {/* Weather & Greeting */}
        <div className="bg-gradient-to-br from-achrams-accent-primary/10 to-achrams-accent-secondary/10 px-6 py-8 rounded-2xl mb-6">
          <h2 className="text-2xl font-bold mb-1 text-achrams-text-primary">{greeting}, {firstName}!</h2>
          <p className="text-achrams-text-secondary mb-4">Ready for your next journey?</p>
          <div className="bg-achrams-bg-secondary rounded-xl p-4 flex items-center justify-between border border-achrams-border">
            <div>
              <div className="text-3xl font-bold text-achrams-text-primary">{weather.temp}C</div>
              <div className="text-achrams-text-secondary capitalize">{weather.condition}</div>
              <div className="text-xs text-achrams-text-tertiary">{weather.location}, Nigeria</div>
            </div>
            <div className="text-5xl">
              {weather.condition === 'sunny' && ''}
              {weather.condition === 'cloudy' && ''}
              {weather.condition === 'rainy' && ''}
            </div>
          </div>
        </div>

        {/* Active Trip Card (if applicable) */}
        {activeTrip && (
          <div
            onClick={onShowActiveTrip} // NEW: Click handler to view active trip
            className="bg-achrams-bg-secondary rounded-2xl p-5 mb-6 shadow-sm border border-achrams-border cursor-pointer hover:bg-achrams-bg-primary transition-colors"
          >
            <div className="flex items-center justify-between mb-3">
              <h3 className="font-semibold text-achrams-text-primary">Active Trip</h3>
              <span className="text-xs bg-achrams-warning-light text-achrams-warning-dark px-2 py-1 rounded-full">{activeTrip.status}</span>
            </div>
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 bg-gradient-to-br from-achrams-primary-solid to-achrams-secondary-solid rounded-full flex items-center justify-center text-achrams-text-light font-bold">
                {activeTrip.driver?.name?.charAt(0) || 'D'}
              </div>
              <div className="flex-1 min-w-0">
                <p className="text-sm font-medium truncate text-achrams-text-primary">{activeTrip.driver?.name || 'Driver Assigned'}</p>
                <p className="text-xs text-achrams-text-secondary truncate">To {activeTrip.destination}</p>
              </div>
              <button className="text-achrams-primary-solid">
                <ChevronRight className="w-5 h-5" />
              </button>
            </div>
          </div>
        )}

        {/* Book Button */}
        <button
          onClick={onBookNewTrip}
          className="w-full bg-achrams-gradient-primary text-achrams-text-light py-5 rounded-2xl text-lg font-semibold shadow-md hover:opacity-95 active:scale-[0.98] transition-all mb-6"
        >
          Book your airport ride
        </button>

        {/* Quick Actions */}
        <div className="grid grid-cols-4 gap-3 mb-6">
          <button
            onClick={onShowTripHistory} // NEW: Click handler
            className="flex flex-col items-center justify-center gap-2 bg-achrams-bg-secondary rounded-xl p-4 border border-achrams-border hover:bg-achrams-bg-primary transition-colors"
          >
            <Clock className="w-6 h-6 text-achrams-primary-solid" />
            <span className="text-xs text-achrams-text-primary">History</span>
          </button>
          <button
            onClick={onShowWallet} // NEW: Click handler
            className="flex flex-col items-center justify-center gap-2 bg-achrams-bg-secondary rounded-xl p-4 border border-achrams-border hover:bg-achrams-bg-primary transition-colors"
          >
            <Wallet className="w-6 h-6 text-achrams-primary-solid" />
            <span className="text-xs text-achrams-text-primary">Wallet</span>
          </button>
          <button
            onClick={onShowSettings} // NEW: Click handler
            className="flex flex-col items-center justify-center gap-2 bg-achrams-bg-secondary rounded-xl p-4 border border-achrams-border hover:bg-achrams-bg-primary transition-colors"
          >
            <Settings className="w-6 h-6 text-achrams-primary-solid" />
            <span className="text-xs text-achrams-text-primary">Settings</span>
          </button>
          <button
            onClick={onShowProfile} // NEW: Could also link to profile
            className="flex flex-col items-center justify-center gap-2 bg-achrams-bg-secondary rounded-xl p-4 border border-achrams-border hover:bg-achrams-bg-primary transition-colors"
          >
            <User className="w-6 h-6 text-achrams-primary-solid" />
            <span className="text-xs text-achrams-text-primary">Profile</span>
          </button>
        </div>

        {/* Recent Trip */}
        <div className="mb-6">
          <h3 className="font-bold text-lg mb-3 text-achrams-text-primary">Recent trip</h3>
          <div className="bg-achrams-bg-secondary rounded-2xl p-5 shadow-sm border border-achrams-border">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <MapPin className="w-4 h-4 text-achrams-text-secondary flex-shrink-0" />
                <span className="text-sm truncate text-achrams-text-primary">{recentTrip.pickup}  {recentTrip.destination}</span>
              </div>
              <span className="text-lg font-bold text-achrams-text-primary">{recentTrip.fare.toLocaleString()}</span>
            </div>
            <div className="flex justify-between mt-2 text-xs text-achrams-text-tertiary">
              <span>{recentTrip.date}</span>
              <span className="capitalize">{recentTrip.status}</span>
            </div>
          </div>
        </div>

        {/* Promotion Banner */}
        <div className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl p-5 shadow-sm mb-6 border border-achrams-border">
          <div className="flex items-start gap-3">
            <div className="text-2xl"></div>
            <div>
              <h4 className="font-semibold mb-1 text-achrams-text-primary">Flight Delay?</h4>
              <p className="text-sm text-achrams-text-secondary">Well wait for you  no extra charge.</p>
            </div>
          </div>
        </div>

        {/* Stats */}
        <div className="grid grid-cols-3 gap-3">
          <div className="bg-achrams-bg-secondary rounded-2xl p-4 shadow-sm border border-achrams-border text-center">
            <div className="text-xl font-bold mb-1 text-achrams-text-primary">1</div>
            <div className="text-xs text-achrams-text-tertiary">Trips</div>
          </div>
          <div className="bg-achrams-bg-secondary rounded-2xl p-4 shadow-sm border border-achrams-border text-center">
            <div className="text-xl font-bold mb-1 text-achrams-text-primary">5.0</div>
            <div className="text-xs text-achrams-text-tertiary">Rating</div>
          </div>
          <div className="bg-achrams-bg-secondary rounded-2xl p-4 shadow-sm border border-achrams-border text-center">
            <div className="text-xl font-bold mb-1 text-achrams-text-primary">{walletBalance?.toLocaleString() || '0'}</div> {/* NEW: Display balance */}
            <div className="text-xs text-achrams-text-tertiary">Wallet</div>
          </div>
        </div>
      </div>

      {/* NEW: Bottom Navigation Bar */}
      <BottomNavBar
        onProfileClick={onShowProfile}
        walletBalance={walletBalance} // Pass balance to navbar if needed for icon badge
        onHomeClick={onBookNewTrip} // Example: Home click could book new trip
        onWalletClick={onShowWallet} // NEW: Link wallet click
        onSearchClick={onShowTripHistory} // Example: Link search to history
      />
    </div>
  );
}

----- FILE: src/app/pbk.tsx -----
// src/app/page.tsx
"use client";

import { useEffect, useState } from "react";
import { useAuth } from "@/contexts/AuthContext";
import BookingScreen from "@/components/app/screens/BookingScreen";
import AssigningScreen from "@/components/app/screens/AssigningScreen";
import DriverAssignedScreen from "@/components/app/screens/DriverAssignedScreen";
// NEW: Import TripProgressScreen statically
import TripProgressScreen from "@/components/app/screens/TripProgressScreen";
import TripCompleteScreen from "@/components/app/screens/TripCompleteScreen";
// NEW: Import new dashboard-related screens
import TripHistoryScreen from "@/components/app/screens/TripHistoryScreen";
import TripDetailsScreen from "@/components/app/screens/TripDetailsScreen";
import WalletScreen from "@/components/app/screens/WalletScreen";
import SettingsScreen from "@/components/app/screens/SettingsScreen";

// NEW: Import the dashboard screen (assuming it's updated to handle new features)
import DashboardScreen from "@/components/app/screens/DashboardScreen";

// Modals - Dynamically import map-dependent modals like DirectionsModal
import dynamic from "next/dynamic";
const DirectionsModal = dynamic(
  () => import("@/components/app/modals/DirectionsModal"),
  { ssr: false }
);

// Modals - Imported normally
import PassengerDetailsModal from "@/components/app/modals/PassengerDetailsModal";
import PanicModal from "@/components/app/modals/PanicModal";
import SignupPromptModal from "@/components/app/modals/SignupPromptModal";
import OTPModal from "@/components/app/modals/OTPModal";
import ProfileModal from "@/components/app/modals/ProfileModal";
import CancelModal from "@/components/app/modals/CancelModal";
import RateModal from "@/components/app/modals/RateModal";
import MessageWindowModal from "@/components/app/modals/MessageWindowModal";
import TripRequestStatusModal from "@/components/app/modals/TripRequestStatusModal";
import DriverVerificationModal from "@/components/app/modals/DriverVerificationModal";
import LoginModal from "@/components/app/modals/LoginModal";
// NEW: Import new modals
import Enable2FAModal from "@/components/app/modals/Enable2FAModal";
import Disable2FAModal from "@/components/app/modals/Disable2FAModal";
import UpdateProfileModal from "@/components/app/modals/UpdateProfileModal";


import Image from "next/image";
import { apiClient } from "@/lib/api";

// UI
import TripUpdateNotification from "@/components/app/ui/TripUpdateNotification";
// NEW: Import BottomNavBar
import BottomNavBar from "@/components/app/ui/BottomNavBar";
import { findNearestAirport, KNOWN_AIRPORTS } from "@/lib/airports";
import ReconnectingWebSocket from "reconnecting-websocket";
import LocationPermissionModal from '@/components/app/modals/LocationPermissionModal'; // NEW: Import the new modal

type TripStatusValue =
  | "searching"
  | "driver_assigned"
  | "accepted"
  | "active"
  | "completed"
  | "cancelled"
  | "driver not found"; // Added "driver not found"

  type TripStatus = {
  label: string;
  value: TripStatusValue;
};

// NEW: Define types for the WebSocket message
type WebSocketMessage = {
  event: "trip:assigned" | "trip:status:update" | string; // Add other potential events
  any; // This will be the trip object
};

// Types
type ScreenState =
  | "booking"
  | "assigning"
  | "driver-assigned"
  | "trip-progress"
  | "trip-complete"
  | "dashboard";
// NEW: Add any new screen states if necessary, though most new features will be modals/screens on top of 'dashboard'

type Requirements = {
  luggage: boolean;
  wheelchair: boolean;
  elderly: boolean;
};

type PassengerData = {
  name: string;
  phone: string;
  email: string;
};

// NEW: Define type for the state you want to persist
interface PersistedState {
  screen: ScreenState;
  pickup: string;
  destination: string;
  fareEstimate: number | null;
  driver: any | null;
  tripProgress: number;
  pickupCoords: [number, number] | null;
  destinationCoords: [number, number] | null;
  verificationCode: string | null;
  // NEW: Add other critical states you want to persist across refresh
  // e.g., walletBalance, is2FAEnabled (though these might be fetched fresh from API on load)
  // Add other critical states as needed
}

// NEW: Function to save state to sessionStorage - only runs on client
const saveAppState = (state: PersistedState) => {
  if (typeof window !== "undefined" && window.sessionStorage) {
    try {
      sessionStorage.setItem("achrams_app_state", JSON.stringify(state));
      console.log("App state saved to sessionStorage"); // Optional: For debugging
    } catch (e) {
      console.error("Failed to save app state to sessionStorage", e);
    }
  }
};

// NEW: Function to load state from sessionStorage - only runs on client
const loadAppState = (): PersistedState | null => {
  if (typeof window !== "undefined" && window.sessionStorage) {
    try {
      const savedStateStr = sessionStorage.getItem("achrams_app_state");
      if (savedStateStr) {
        const savedState = JSON.parse(savedStateStr) as PersistedState;
        console.log("App state loaded from sessionStorage", savedState); // Optional: For debugging
        return savedState;
      }
    } catch (e) {
      console.error("Failed to load app state from sessionStorage", e);
    }
  }
  return null; // Return null if sessionStorage is not available or error occurred
};

export default function ACHRAMApp() {
  const { token } = useAuth();

  // NEW: Use a state variable to track if we have checked sessionStorage on the client
  const [hasHydrated, setHasHydrated] = useState(false);

  // NEW: Define state variables without initial values from loadAppState here
  const [screen, setScreen] = useState<ScreenState>("booking"); // Will be set after hydration
  const [pickup, setPickup] = useState<string>("");
  const [destination, setDestination] = useState<string>("");
  const [fareEstimate, setFareEstimate] = useState<number | null>(null);
  const [driver, setDriver] = useState<any>(null);
  const [tripProgress, setTripProgress] = useState<number>(0);
  const [pickupCoords, setPickupCoords] = useState<[number, number] | null>(
    null
  );
  const [destinationCoords, setDestinationCoords] = useState<
    [number, number] | null
  >(null);
  const [verificationCode, setVerificationCode] = useState<string | null>(null);
  const [guestId, setGuestId] = useState<string | null>(null); // NEW: Store guest ID
  const [activeTripId, setActiveTripId] = useState<string | null>(null); // NEW: Store active trip ID (from booking response)
  // NEW: State for WebSocket connection
  const [webSocketConnection, setWebSocketConnection] =
    useState<ReconnectingWebSocket | null>(null);
  const [webSocketStatus, setWebSocketStatus] = useState<
    "connecting" | "open" | "closed" | "reconnecting"
  >("closed");
  // NEW: State for polling fallback
  const [pollingIntervalId, setPollingIntervalId] =
    useState<NodeJS.Timeout | null>(null);

  // NEW: State for new dashboard features (these might be fetched from API on load)
  const [walletBalance, setWalletBalance] = useState<number>(0); // NEW: State for wallet balance
  const [is2FAEnabled, setIs2FAEnabled] = useState<boolean>(false); // NEW: State for 2FA status
  // const [activeTripId, setActiveTripId] = useState<string | null>(null); // NEW: State for active trip ID (if any)

  // NEW: State for modals (these can be initialized normally)
  const [showPassengerDetails, setShowPassengerDetails] = useState(false);
  const [showDirections, setShowDirections] = useState(false);
  const [showPanic, setShowPanic] = useState(false);
  const [showSignup, setShowSignup] = useState(false); // NEW: Use this state instead of screen === 'signup-prompt'
  const [showOTP, setShowOTP] = useState(false);
  const [showProfile, setShowProfile] = useState(false);
  const [showCancel, setShowCancel] = useState(false);
  const [showRate, setShowRate] = useState(false);
  const [showMessage, setShowMessage] = useState(false);

  // NEW: State for new modals/screens
  const [showTripHistory, setShowTripHistory] = useState(false);
  const [showTripDetails, setShowTripDetails] = useState(false);
  const [selectedTripId, setSelectedTripId] = useState<string | null>(null);
  const [showWallet, setShowWallet] = useState(false);
  const [showSettings, setShowSettings] = useState(false);
  const [showEnable2FA, setShowEnable2FA] = useState(false);
  const [showDisable2FA, setShowDisable2FA] = useState(false);
  const [showUpdateProfile, setShowUpdateProfile] = useState(false);

  // NEW: State for Login Modal
  const [showLogin, setShowLogin] = useState(false); // NEW: Add state for login modal

  // NEW: State for trip request status modal
  const [tripRequestStatus, setTripRequestStatus] = useState<
    "loading" | "accepted" | "no-driver" | "error" | null
  >(null);
  const [tripRequestError, setTripRequestError] = useState<string | null>(null);

  // NEW: State for driver verification modal
  const [showDriverVerification, setShowDriverVerification] = useState(false);

  const [showLocationModal, setShowLocationModal] = useState(false);



  // NEW: State for trip update notifications
  const [currentNotification, setCurrentNotification] = useState<{
    message: string;
    type: "info" | "success" | "warning" | "error";
  } | null>(null);

  // NEW: Effect to run only on the client after mount to load state and set initial values
  useEffect(() => {
    // Check if we are on the client
    if (typeof window !== "undefined") {
      const savedState = loadAppState();
      if (savedState) {
        // Set state using the loaded values
        setScreen(savedState.screen);
        setPickup(savedState.pickup);
        setDestination(savedState.destination);
        setFareEstimate(savedState.fareEstimate);
        setDriver(savedState.driver);
        setTripProgress(savedState.tripProgress);
        setPickupCoords(savedState.pickupCoords);
        setDestinationCoords(savedState.destinationCoords);
        setVerificationCode(savedState.verificationCode);
        // NEW: Load other persisted states if added
        // setWalletBalance(savedState.walletBalance); // Example
        // setIs2FAEnabled(savedState.is2FAEnabled); // Example
      } else {
        // Set default initial state based on token
        setScreen(token ? "dashboard" : "booking");
      }
      // Mark as hydrated after loading/saving defaults
      setHasHydrated(true);
    } else {
      // Fallback if somehow this runs on server (shouldn't with 'use client')
      setScreen(token ? "dashboard" : "booking");
      setHasHydrated(true);
    }
  }, [token]); // Depend on token if initial screen logic depends on it

  // NEW: Effect to fetch user profile data (including 2FA status, wallet, active trip) on initial load or token change
  useEffect(() => {
    if (hasHydrated && token) {
      const fetchUserProfile = async () => {
        try {
          // NEW: Call the API to get user profile using apiClient
          // Example: const response = await apiClient.get('/auth/passenger/me');
          // Example structure based on passenger postman DOC.txt:
          // const profileData = response.data.data;
          // setWalletBalance(profileData.profile.wallet.balance.amount);
          // setIs2FAEnabled(profileData.is_2fa_enabled);
          // if (profileData.profile.active_trip) {
          //    setActiveTripId(profileData.profile.active_trip.id);
          //    // Potentially set screen to 'driver-assigned' or 'trip-progress' if active trip exists
          //    // This logic depends on your desired UX for resuming active trips
          // }

          // For now, simulate with mock data after a short delay
          setTimeout(() => {
            setWalletBalance(5000); // Mock balance
            setIs2FAEnabled(false); // Mock 2FA status
            // setActiveTripId(null); // Mock active trip ID - assume no active trip for this example
          }, 500); // Simulate API delay
        } catch (err) {
          console.error("Failed to fetch user profile:", err);
          // NEW: Optionally show an error notification
          setCurrentNotification({
            message: "Failed to load profile data.",
            type: "error",
          });
          setTimeout(() => setCurrentNotification(null), 5000);
        }
      };

      fetchUserProfile();
    }
  }, [hasHydrated, token]); // Run when hydrated state is true and token changes

  // NEW: Effect to handle navigation after trip completion and set showSignup
  useEffect(() => {
    if (screen === "trip-complete") {
      // Check if user is authenticated
      if (token) {
        // If authenticated, maybe show rate modal (if not already shown) and then go to dashboard
        // Or, if rating is handled elsewhere, just go to dashboard after a delay or user action
        // For now, let's assume the user can click a button or it happens automatically after a short delay
        // Or, the TripCompleteScreen itself could trigger this.
        // Let's simulate a delay and then transition to dashboard if authenticated.
        // This is just a simulation, the real trigger might be clicking 'Done' in TripCompleteScreen.
        // We'll add a specific state to manage this transition cleanly.
        // Let's assume the TripCompleteScreen has a button that calls a handler passed from page.tsx.
        // For now, let's just add the logic here that *would* happen when the user wants to leave the trip-complete screen.
        // The key is to clear trip data and set screen to dashboard *before* the save effect runs.
      } else {
        // If not authenticated (guest), show signup prompt after a delay
        const timer = setTimeout(() => {
          // NEW: Clear specific trip-related state before navigating to signup
          // Note: This clearing is now handled in the onDone handler in TripCompleteScreen render block
          // We set showSignup here, which triggers the modal.
          setShowSignup(true); // NEW: Trigger the signup modal
        }, 1500); // Delay matches the original effect

        return () => clearTimeout(timer);
      }
    }
  }, [screen, token]); // Depend on screen and token only

  // Data state
  const [passengerData, setPassengerData] = useState<PassengerData>({
    name: "",
    phone: "",
    email: "",
  });
  const [requirements, setRequirements] = useState<Requirements>({
    luggage: false,
    wheelchair: false,
    elderly: false,
  });

  // NEW: Function to show notifications
  const showNotification = (
    message: string,
    type: "info" | "success" | "warning" | "error"
  ) => {
    setCurrentNotification({ message, type });
    setTimeout(() => {
      setCurrentNotification(null);
    }, 5000); // Auto-dismiss after 5 seconds
  };

  // NEW: Effect to trigger notifications based on screen changes (simulated)
  useEffect(() => {
    if (screen === "driver-assigned" && driver) {
      // Simulate driver found notification
      showNotification("Driver assigned successfully!", "success");
      // Simulate trip updates after some delay
      const timer1 = setTimeout(
        () => showNotification("Driver is 7 mins from pickup location", "info"),
        3000
      );
      const timer2 = setTimeout(
        () =>
          showNotification("Driver has arrived at pickup location", "success"),
        10000
      );

      return () => {
        clearTimeout(timer1);
        clearTimeout(timer2);
      };
    }
    if (screen === "trip-progress") {
      // Simulate ongoing trip updates
      const timer = setInterval(() => {
        setTripProgress((prev) => {
          if (prev >= 100) {
            clearInterval(timer);
            setScreen("trip-complete");
            return 100;
          }
          return prev + 2; // Simulate progress
        });
      }, 1000); // Update every second for simulation

      return () => clearInterval(timer);
    }
  }, [screen, driver]); // Depend on screen and driver

  // NEW: Effect to save state whenever it changes (only runs on client after hydration)
  useEffect(() => {
    if (hasHydrated) {
      // Only save after initial state has been loaded/set
      const stateToSave: PersistedState = {
        screen,
        pickup,
        destination,
        fareEstimate,
        driver,
        tripProgress,
        pickupCoords,
        destinationCoords,
        verificationCode,
        // NEW: Add other states you want to persist
        // walletBalance, // Example - might be fetched fresh from API
        // is2FAEnabled, // Example - might be fetched fresh from API
        // Add other states...
      };
      saveAppState(stateToSave);
    }
  }, [
    screen,
    pickup,
    destination,
    fareEstimate,
    driver,
    tripProgress,
    pickupCoords,
    destinationCoords,
    verificationCode,
    // NEW: Add other states to dependency array if they are included in stateToSave
    // walletBalance,
    // is2FAEnabled,
    hasHydrated, // Include hydration flag to prevent saving before state is loaded
  ]);

  // NEW: Handler passed to SignupPromptModal for successful registration (e.g., open OTP)
  const handleRegistrationSuccess = (email: string) => {
    // For now, simulate OTP verification success and move to dashboard
    // In reality, you'd open OTPModal here
    // setShowOTP(true); // Assuming OTPModal exists and handles verification
    // If OTP verification is successful within OTPModal, it would then trigger navigation to dashboard
    // OR, if registration API directly logs in (less common), update token and screen here.
    // Let's assume it leads to OTP first, then dashboard.
    // For this mock, let's just move to dashboard after "registration"
    setScreen("dashboard");
    setShowSignup(false); // Close signup prompt modal
    // setShowOTP(true); // Uncomment if implementing OTP flow
  };

  // NEW: Handler passed to LoginModal for successful login
  const handleLoginSuccess = () => {
    // The useAuth context should now have the token
    // page.tsx relies on the `token` from useAuth to determine initial screen and rendering logic
    // If token exists, screen should be 'dashboard' (handled by initial load or subsequent logic)
    // Ensure screen is set correctly, maybe explicitly if needed after login
    // setScreen('dashboard'); // Often not needed if initial load logic handles it based on token
    // onClose in LoginModal should be sufficient if screen logic in render is correct
    // No explicit action needed here if state management is correct, just let the parent re-render based on updated token.
    // If token changes and initial screen logic in useEffect isn't catching it, maybe force update screen here.
    // For now, assume token update in context triggers correct re-render.
    // NEW: Optionally refetch profile data after login
    // setHasHydrated(false); // Trigger re-fetch logic in profile effect by resetting hydration state slightly
    // OR, rely on the token change triggering the profile fetch effect naturally.
  };

  // NEW: Handler passed to Enable2FAModal on success
  const handle2FAEnabled = () => {
    setIs2FAEnabled(true); // Update local state
    setShowEnable2FA(false); // Close the modal
    // NEW: Optionally show a success notification
    showNotification(
      "Two-factor authentication enabled successfully!",
      "success"
    );
  };

  // NEW: Handler passed to Disable2FAModal on success
  const handle2FADisabled = () => {
    setIs2FAEnabled(false); // Update local state
    setShowDisable2FA(false); // Close the modal
    // NEW: Optionally show a success notification
    showNotification("Two-factor authentication disabled.", "info");
  };

  // NEW: Handler passed to UpdateProfileModal on success
  const handleProfileUpdated = (updatedData: any) => {
    // Update local passengerData state with the new data
    setPassengerData(updatedData);
    setShowUpdateProfile(false); // Close the modal
    // NEW: Optionally show a success notification
    showNotification("Profile updated successfully!", "success");
  };

  const handleProceed = () => {
    if (fareEstimate && pickup && destination) {
      setShowPassengerDetails(true);
    }
  };

  // src/app/page.tsx

  // Add this helper function inside your component
  const formatPhoneNumber = (input: string): string => {
    // Remove any non-digit characters (like spaces, dashes, parentheses)
    const digitsOnly = input.replace(/\D/g, "");

    // If it starts with '0', remove the '0' and prepend '+234'
    if (digitsOnly.startsWith("0")) {
      return `+234${digitsOnly.slice(1)}`;
    }

    // If it starts with '234', prepend '+'
    if (digitsOnly.startsWith("234")) {
      return `+${digitsOnly}`;
    }

    // If it already starts with '+', return as is
    if (digitsOnly.startsWith("+")) {
      return digitsOnly;
    }

    // If it's a bare number without a country code, assume it's a Nigerian number starting with '0'
    // This is a fallback; ideally, your input validation should enforce a format.
    if (digitsOnly.length === 11) {
      return `+234${digitsOnly.slice(1)}`;
    }

    // If none of the above, return as is (might cause API error)
    return digitsOnly;
  };

  // NEW: Modified handleRequestRide with mock API call simulation and state persistence
  // NEW: Modified handleRequestRide with real API call integration and state persistence
  const handleRequestRide = async () => {
  if (!passengerData.name || !passengerData.phone || !passengerData.email) {
    showNotification("Please fill all passenger details.", "error");
    return;
  }

  if (!pickupCoords || !destinationCoords) {
    showNotification(
      "Pickup and destination locations are required.",
      "error"
    );
    return;
  }

  setShowPassengerDetails(false);
  setTripRequestStatus("loading"); // Shows "Finding a driver..." modal

  try {
    // === Step A: Resolve airport ID ===
    let airportId: string | null = null;

    if (pickup.startsWith("Use my current location")) {
      // NEW: This branch might now be less likely to be triggered if BookingScreen
      // correctly sets the `pickup` state to the *resolved name* (e.g., "Murtala Muhammed International Airport")
      // and `pickupCoords` to the geolocation coords, because `pickup` no longer literally starts with "Use my current location".
      // However, keep it as a potential fallback or if the naming logic in BookingScreen changes slightly.
      // The critical part is that `pickupCoords` contains the coordinates used for the API call,
      // and `pickup` contains the *name* of the *selected* airport.

      // Fetch airports based on the coordinates stored in pickupCoords
      const nearestAirports = await findNearestAirport(pickupCoords[0], pickupCoords[1]);

      if (!nearestAirports || !nearestAirports.length) {
        setTripRequestStatus("error");
        setTripRequestError("Youre outside our service area. Booking not available from this location.");
        return;
      }

      // NEW: Find the specific airport ID based on the `pickup` name state
      // This assumes the name set by BookingScreen matches the `name` field from the API exactly.
      // This is the crucial change: match the name stored in state to the array returned by the API.
      const selectedAirport = nearestAirports.find(apt => apt.name === pickup);
      if (!selectedAirport) {
          console.error("Selected pickup name does not match any fetched airport:", pickup, nearestAirports);
          setTripRequestStatus("error");
          setTripRequestError("Could not confirm selected pickup location. Please try again.");
          return;
      }
      airportId = selectedAirport.id;

    } else if (pickup in KNOWN_AIRPORTS) {
      // Handle selection from the hardcoded list in BookingScreen
      airportId = KNOWN_AIRPORTS[pickup];
    } else {
      // Handle a custom pickup name typed by the user (e.g., via Google Autocomplete or manual entry).
      // The `pickupCoords` should now be the coordinates resolved from the *typed* destination name
      // by the Google Autocomplete component integrated into BookingScreen.
      // Call the API again to ensure the coordinates map to a valid ACHRAMS airport.
      const nearestAirports = await findNearestAirport(pickupCoords[0], pickupCoords[1]);

      if (!nearestAirports || !nearestAirports.length) {
        setTripRequestStatus("error");
        setTripRequestError("Pickup location is not near a supported airport.");
        return;
      }

      // NEW: Similar to the "Use my current location" case, find the ID based on the name stored in state.
      // For a custom name, `pickup` is the typed name, and `pickupCoords` are its resolved coordinates.
      // The API might return airports near those coordinates.
      // This logic assumes that for a custom name, the intention is to find *an* ACHRAMS airport near the *typed* location.
      // If the user types "Some Random Street", and it resolves to coordinates not near an ACHRAMS airport,
      // `findNearestAirport` should return null, and the check above (`!nearestAirports`) handles it.
      // If it *does* resolve near an airport, this code finds the ID for that airport.
      // However, if the user typed "Murtala Muhammed Int'l Airport", it should ideally resolve coordinates
      // that `findNearestAirport` matches back to the ACHRAMS entry for that airport.
      // The name matching logic here is primarily for the "Use my current location" case where the name is explicitly selected.
      // For custom names, if the coordinates are accurate, `findNearestAirport` should ideally return the relevant airport.
      // If the typed name doesn't correspond to a specific ACHRAMS airport boundary but is nearby,
      // the backend might expect the ID of the nearest ACHRAMS airport.
      // The safest bet is still to match the name if possible, or default to the first result if names don't match perfectly.
      // Let's try name matching first, then fall back.
      const selectedAirport = nearestAirports.find(apt => apt.name === pickup);
      if (selectedAirport) {
          airportId = selectedAirport.id;
      } else {
          // Fallback: if the typed name doesn't exactly match an API result name,
          // use the first result from the API call (assuming it's the nearest one).
          // This covers cases where the user types a location close to an airport but not the airport name itself,
          // and the system correctly identifies the nearest airport boundary.
          console.warn("Typed pickup name did not match any fetched airport name, using first result.", pickup, nearestAirports);
          airportId = nearestAirports[0].id;
      }
    }

    // === Step B: Prepare request body (amount, guest details, requirements, locations) ===
    // (This part remains largely the same, using fareEstimate, passengerData, requirements, pickupCoords, destinationCoords)
    const tripData = {
      amount: {
        amount: fareEstimate?.toString() || "0",
        currency: "NGN",
      },
      airport: airportId, // Use the resolved ID
      guest_name: passengerData.name,
      guest_email: passengerData.email,
      guest_phone: formatPhoneNumber(passengerData.phone),
      has_extra_leg_room: requirements.elderly,
      has_extra_luggage: requirements.luggage,
      has_wheel_chair_access: requirements.wheelchair,
      pickup_address: pickup, // The resolved/typed pickup name
      pickup_location: pickupCoords, // [lng, lat] from state
      destination_address: destination, // The typed destination name
      destination_location: destinationCoords, // [lng, lat] from state (resolved by Google Autocomplete in BookingScreen)
    };

    console.log("Request Data:", tripData);

    // === Step C: Make API call ===
    const response = await apiClient.post("/trips/guest-booking", tripData);

    console.log("Raw API Response:", response);

    if (response.status === "success" && response.data) {
      const trip = response.data;
      const extractedGuestId = trip.guest?.id;

      if (!extractedGuestId) {
        console.error("Guest ID not found in booking response, cannot start WebSocket.");
        setTripRequestStatus('error');
        setTripRequestError('Failed to get guest session. Booking cancelled.');
        return;
      }

      console.log("Trip data received:", trip);
      console.log("Guest ID received:", extractedGuestId);

      setVerificationCode(trip.verification_code || "");
      setActiveTripId(trip.id);
      setGuestId(extractedGuestId);

      if (trip.status.value === "searching") {
        setTripRequestStatus(null);
        setScreen("assigning");
        startWebSocketConnection(extractedGuestId, trip.id);
      } else if (trip.status.value === "driver_assigned" && trip.driver) {
        setDriver(trip.driver);
        setTripRequestStatus(null);
        setScreen("driver-assigned");
        // No need to start WebSocket or polling if driver is already assigned
      } else {
        console.warn("Unexpected trip status after booking:", trip.status);
        setTripRequestStatus("error");
        setTripRequestError(`Unexpected booking state: ${trip.status.label}`);
      }
    } else {
      console.error(
        "API responded with non-success status or missing data:",
        response
      );
      let errorMessage = "Failed to book your trip. Server responded unexpectedly.";
      if (response.message) {
        errorMessage = response.message;
        if (response.details) {
          const fieldErrors = [];
          for (const [field, messages] of Object.entries(response.details)) {
            if (Array.isArray(messages)) {
              fieldErrors.push(`${field}: ${messages.join(", ")}`);
            }
          }
          if (fieldErrors.length > 0) {
            errorMessage += ` Details: ${fieldErrors.join("; ")}`;
          }
        }
      }
      throw new Error(errorMessage);
    }
  } catch (err: any) {
    console.error("Guest booking error:", err);
    setTripRequestStatus("error");

    let errorMessage = "Failed to book your trip. Please check your connection and try again.";

    if (err instanceof Error) {
      errorMessage = err.message;
    } else {
      console.error("Unexpected error type caught:", typeof err, err);
      errorMessage = 'An unexpected error occurred during booking.';
    }

    setTripRequestError(errorMessage);
  }
};

 const handleShowLocationModal = () => {
    setShowLocationModal(true);
  };
const handleLocationModalClose = () => {
    setShowLocationModal(false);
  };


const handleGrantLocationAccess = () => {
  console.log("location access granted button clicked in modal. The BookingScreen will handle the requestPermission call")
}

  const startWebSocketConnection = (guestId: string, tripId: string) => {
    if (webSocketConnection) {
      // Close any existing connection before starting a new one
      console.log("Closing existing WebSocket connection.");
      webSocketConnection.close();
      // Note: The onclose handler will fire, potentially starting polling if trip is still active.
      // We might want to prevent that if we are intentionally reconnecting.
      // For now, the logic in onclose checks the screen state or activeTripId to decide.
    }

    // Construct the WebSocket URL using the guest ID
    const wsUrl = `wss://api.achrams.com.ng/ws/v1/app?guest_id=${guestId}`;

    console.log(`Attempting to connect to WebSocket: ${wsUrl}`);

    // Create the ReconnectingWebSocket instance
    const rws = new ReconnectingWebSocket(wsUrl, [], {
      // Optional configuration for ReconnectingWebSocket
      connectionTimeout: 10000, // Timeout for individual connection attempts
      maxRetries: 10, // Maximum number of reconnection attempts (or Number.MAX_VALUE for unlimited)
      maxReconnectionDelay: 10000, // Maximum delay between reconnections
      // Add other options as needed from the library's documentation
    });

    // Set up event handlers
    rws.onopen = () => {
      console.log("WebSocket connection opened.");
      setWebSocketStatus("open");
      // If polling was running as a fallback, stop it now that WS is open
      stopPollingTripStatus();
    };

    rws.onmessage = (event) => {
      try {
        const messageData: WebSocketMessage = JSON.parse(event.data);
        console.log("Received WebSocket message:", messageData);

        const { event: eventType, data: tripData } = messageData;

        // Check if it's a relevant trip update event
        if (eventType === 'trip:assigned' || eventType === 'trip:status:update') {
      // Update UI state based on the received trip data

      // NEW: Check for 'driver not found' status
      if (tripData.status.value === 'driver not found') { // Use the exact string from backend/Postman
        console.log("Driver not found via WebSocket, updating UI.");
        // Stop both WebSocket and polling
        stopWebSocketConnection();
        stopPollingTripStatus();
        // Set status to show 'no-driver' modal
        setTripRequestStatus('no-driver');
        // Optionally set a specific error message
        setTripRequestError(`No drivers available for your trip.`);
        // Do NOT change the screen here, let the modal handle the user interaction.
        // The screen might still be 'assigning', which is okay until the user retries/cancels.
        return; // Exit handler after handling 'driver not found'
      }

      // NEW: Check for 'accepted' OR 'driver_assigned' status when a driver is present
      if ((tripData.status.value === 'accepted' || tripData.status.value === 'driver_assigned') && tripData.driver) {
        // Driver found or assigned!
        console.log(`${tripData.status.label} via WebSocket, updating UI with driver.`);
        setDriver(tripData.driver);
        setScreen('driver-assigned'); // Transition to the driver-assigned screen
        stopWebSocketConnection(); // Stop WebSocket as trip is assigned/accepted
        stopPollingTripStatus(); // Ensure polling is also stopped
        // No need to start polling here, as trip is assigned/accepted.
      } else if (tripData.status.value === 'cancelled' || tripData.status.value === 'completed') {
        // Trip is no longer active, stop polling and handle accordingly
        console.log(`Trip ${tripData.id} is now ${tripData.status.value} via WebSocket.`);
        setTripRequestStatus('error'); // Or a specific status like 'trip-cancelled'
        setTripRequestError(`Trip ${tripData.status.label}.`); // Show status message
        stopWebSocketConnection(); // Stop WebSocket as trip is finished
        stopPollingTripStatus(); // Ensure polling is also stopped
        // No need to start polling here, as trip is finished.
      } else {
        // Handle other statuses if needed, or just log/update state if necessary
        // e.g., update verification code, status label, etc., if relevant
        console.log(`Received trip status update via WebSocket: ${tripData.status.value}`);
        // You might want to update activeTripId if it changed, though unlikely after initial booking
        // setActiveTripId(tripData.id);
        // setVerificationCode(tripData.verification_code || '');
        // setTripStatus(tripData.status); // If you have a separate state for trip status
      }
    } else {
      // Handle other event types if the backend sends them
      console.log(`Received other WebSocket event: ${eventType}`);
    }
  } catch (error) {
    console.error('Error parsing WebSocket message:', error, event.data);
  }
    };

    // Inside startWebSocketConnection setup
rws.onclose = (event) => {
  console.log('WebSocket connection closed:', event.code, event.reason);
  setWebSocketStatus('closed');
  // IMPORTANT: The WebSocket closed. If the trip is *not* in a final state,
  // we need to start the polling fallback.
  // Check current screen or potentially fetch latest status via API first before polling.
  // For now, if screen is still 'assigning' or related to searching/active, and we have an active trip ID, start polling.
  // We'll pass the activeTripId to the polling function.
  // NEW: Only start polling if we are still in an intermediate state and polling isn't already active.
  if (activeTripId && !['driver-assigned', 'completed', 'cancelled', 'driver not found'].includes(screen) && !pollingIntervalId) { // NEW: Check pollingIntervalId
     console.log(`WebSocket closed, starting polling for trip ${activeTripId} as fallback.`);
     startPollingTripStatus(activeTripId);
  } else {
     console.log(`WebSocket closed, but not starting polling. Trip ID: ${activeTripId}, Screen: ${screen}, Polling Active: ${!!pollingIntervalId}`);
     // If screen is a final state, ensure polling is definitely stopped just in case.
     if (['driver-assigned', 'completed', 'cancelled', 'driver not found'].includes(screen)) {
         console.log("Screen indicates final state, ensuring polling is stopped.");
         stopPollingTripStatus(); // NEW: Ensure polling stops if closed event happens after final state
     }
  }
};

    rws.onerror = (error) => {
      console.error("WebSocket error:", error);
      // Error doesn't necessarily mean the connection is closed, but log it.
      // The library handles reconnection attempts.
      // You might want to update a UI status indicator if needed.
      // setWebSocketStatus('reconnecting'); // The library handles this internally, but you can track if desired.
    };

    // Store the connection instance
    setWebSocketConnection(rws);
    setWebSocketStatus("connecting"); // Update status while connecting
  };

  // NEW: Function to stop the WebSocket connection
  const stopWebSocketConnection = () => {
    if (webSocketConnection) {

      stopPollingTripStatus();
      console.log("Manually stopping WebSocket connection.");
      webSocketConnection.close(); // This will trigger the onclose handler
      setWebSocketConnection(null);
      setWebSocketStatus("closed");
    }
  };

  const fetchTripStatus = async (tripId: string) => {
    if (!tripId || !guestId) {
      // Ensure both tripId and guestId are available
      console.warn("fetchTripStatus called without a tripId or guestId");
      return;
    }
    try {
      console.log(
        `Polling trip status for ID: ${tripId} using guestId: ${guestId}`
      );
      // Use apiClient to call GET /trips/{id}
      // The apiClient (from src/lib/api.ts) is designed to add X-Guest-Id header if guestId is provided
      const response = await apiClient.get(`/trips/${tripId}`, true, guestId); // Pass isGuest=true and guestId

      // Remember, apiClient returns the JSON body directly for success
      if (response.status === "success" && response.data) {
        const trip = response.data; // This is the trip object from the API's { status: "...",  {...} }

        console.log(
          `Polled trip status: ${
            trip.status.value
          }, has driver: ${!!trip.driver}`
        );

        // Check the status and handle accordingly
        if (trip.status.value === "driver_assigned" && trip.driver) {
          // Driver found!
          console.log("Driver assigned via polling, updating UI.");
          setDriver(trip.driver);
          setScreen("driver-assigned"); // Transition to the next screen
          stopPollingTripStatus(); // Stop polling
          stopWebSocketConnection(); // Stop WebSocket if it was re-established during polling
        } else if (
          trip.status.value === "cancelled" ||
          trip.status.value === "completed"
        ) {
          // Trip is no longer active, stop polling and handle accordingly
          console.log(
            `Trip ${tripId} is now ${trip.status.value} via polling, stopping polling.`
          );
          setTripRequestStatus("error"); // Or a specific status like 'trip-cancelled'
          setTripRequestError(`Trip ${trip.status.label}.`); // Show status message
          stopPollingTripStatus(); // Stop polling
          stopWebSocketConnection(); // Stop WebSocket if it was re-established during polling
          // You might want to clear trip details and go back to booking or dashboard
        } else {
          // Trip is still searching or in another intermediate state via polling
          console.log(
            `Trip ${tripId} is still ${trip.status.value} via polling.`
          );
          // Continue polling
        }
      } else {
        // Handle API error response (e.g., status not "success"), e.g., trip not found (404)
        console.error(
          "Polling API responded with non-success status or missing ",
          response
        );
        // Decide: Stop polling? Retry? Log and continue?
        // For a 404 (trip not found), it might imply cancellation.
        // For other errors (500, etc.), maybe continue polling briefly.
        // For now, log and continue polling (assuming temporary issue or trip not yet visible).
        // You could add logic here to stop polling after N consecutive errors.
      }
    } catch (err) {
      // Handle network error or apiClient throwing an error
      console.error("Error polling trip status:", err);
      // Decide: Stop polling after a few errors? Or continue? Add retry logic?
      // For now, log and continue polling (assuming temporary network glitch).
      // Optionally, add retry logic or error count here.
    }
  };

  const startPollingTripStatus = (tripId: string) => {
    if (pollingIntervalId) {
      // Clear any existing polling interval to avoid duplicates
      clearInterval(pollingIntervalId);
    }

    console.log(
      `Starting polling for trip ${tripId} every 5 seconds (fallback).`
    );
    const interval = setInterval(() => {
      fetchTripStatus(tripId); // Pass the tripId to the fetch function
    }, 5000); // Poll every 5 seconds

    setPollingIntervalId(interval);
  };

  // NEW: Function to stop polling
  const stopPollingTripStatus = () => {
    if (pollingIntervalId) {
      console.log("Stopping trip status polling.");
      clearInterval(pollingIntervalId);
      setPollingIntervalId(null);
    }
  };

  useEffect(() => {
    return () => {
      console.log("Cleaning up WebSocket and polling intervals on unmount.");
      stopWebSocketConnection();
      stopPollingTripStatus();
    };
  }, []);

  const handleTripStart = () => {
    setScreen("trip-progress");
  };

  const handleRateSubmit = () => {
    setScreen("trip-complete");
  };

  const handleTripComplete = () => {
    setScreen("trip-complete");
  };

  // NEW: Wait for hydration before rendering main content to avoid SSR/client mismatch
  if (!hasHydrated) {
    return (
      <div className="flex items-center justify-center h-screen w-full bg-white animate-fadeIn">
        <div className="relative">
          {/* Soft pulsing glow */}
          <div className="absolute inset-0 rounded-2xl bg-achrams-gradient-primary opacity-40 blur-xl animate-pulse"></div>

          {/* Main Logo Container */}
          <div className="w-16 h-16 bg-achrams-gradient-primary rounded-2xl flex items-center justify-center shadow-xl animate-scaleIn relative overflow-hidden">
            {/* Subtle rotating light sweep */}
            <div className="absolute inset-0 bg-white/20 animate-sweep pointer-events-none"></div>

            <Image
              src="/images/logo.png"
              alt="ACHRAMS Logo"
              width={30}
              height={30}
              className="object-contain animate-popIn"
            />
          </div>
        </div>
      </div>
    ); // Or a skeleton loader
  }

  // === Render current screen as main content ===
  let mainContent = null;

  if (screen === "booking") {
    mainContent = (
      <BookingScreen
        pickup={pickup}
        setPickup={setPickup}
        destination={destination}
        setDestination={setDestination}
        fareEstimate={fareEstimate}
        setFareEstimate={setFareEstimate}
        onProceed={handleProceed}
        setShowPassengerDetails={setShowPassengerDetails}
        passengerData={passengerData}
        setPassengerData={setPassengerData}
        showPassengerDetails={showPassengerDetails}
        requirements={requirements}
        setRequirements={setRequirements}
        setPickupCoords={setPickupCoords} // NEW
        setDestinationCoords={setDestinationCoords} // NEW
        onShowLocationModal={handleShowLocationModal}


      />
    );
  } else if (screen === "assigning") {
    mainContent = <AssigningScreen 
    status={tripRequestStatus}
    />;
  } else if (screen === "driver-assigned") {
    mainContent = (
      <DriverAssignedScreen
        pickup={pickup}
        destination={destination}
        driver={driver}
        verificationCode={verificationCode || ""} // NEW: Pass verification code
        onShowDirections={() => setShowDirections(true)}
        onShowDriverVerification={() => setShowDriverVerification(true)} // NEW: Handler for verification modal
        onStartTrip={handleTripStart}
        onBack={() => setScreen("booking")}
      />
    );
  } else if (screen === "trip-progress") {
    // NEW: Use the statically imported TripProgressScreen
    mainContent = (
      <TripProgressScreen
        driver={driver}
        onPanic={() => setShowPanic(true)}
        onComplete={handleTripComplete}
        pickupCoords={pickupCoords} // NEW: Pass coordinates
        destinationCoords={destinationCoords} // NEW: Pass coordinates
        tripProgress={tripProgress} // NEW: Pass progress
        // Remove canRenderMaps prop as it's no longer needed if using dynamic import for the screen was the main strategy
      />
    );
  } else if (screen === "trip-complete") {
    mainContent = (
      <TripCompleteScreen
        fareEstimate={fareEstimate}
        driver={driver}
        onRate={() => setShowRate(true)}
        onDone={() => {
          // NEW: Clear specific trip-related state before navigating
          setPickup("");
          setDestination("");
          setFareEstimate(null);
          setDriver(null);
          setTripProgress(0);
          setPickupCoords(null);
          setDestinationCoords(null);
          setVerificationCode(null); // NEW: Clear verification code
          // alert('was called');
          setGuestId(null); // NEW: Clear guest ID
          // Stop any potential polling/WebSocket if they were still running due to timing
          stopPollingTripStatus();
          stopWebSocketConnection();
          if (!token) {
            setScreen("dashboard");
          } else {
            // NEW: Instead of setting screen to 'signup-prompt', just set the showSignup state
            setScreen("booking");
            // setShowSignup(true);
          }
        }}
      />
    );
  } else if (screen === "dashboard") {
    // NEW: Render the DashboardScreen component
    mainContent = (
      <DashboardScreen
        passengerData={passengerData}
        walletBalance={walletBalance} // NEW: Pass wallet balance
        is2FAEnabled={is2FAEnabled} // NEW: Pass 2FA status
        onShowProfile={() => setShowProfile(true)}
        onBookNewTrip={() => {
          setScreen("booking");
          setPickup("");
          setDestination("");
          setFareEstimate(null);
          setPickupCoords(null);
          setDestinationCoords(null);
          setDriver(null);
          setTripProgress(0); // NEW: Reset trip progress
          setVerificationCode(null); // NEW: Reset verification code
        }}
        // NEW: Pass handlers for new dashboard features
        onShowTripHistory={() => setShowTripHistory(true)}
        onShowWallet={() => setShowWallet(true)}
        onShowSettings={() => setShowSettings(true)}
        onShowEnable2FA={() => setShowEnable2FA(true)} // NEW: Handler for enabling 2FA
        onShowUpdateProfile={() => setShowUpdateProfile(true)} // NEW: Handler for updating profile
        onBookRide={() => setScreen("booking")}
        onProfile={() => setShowProfile(true)}
        onLogout={() => {}}
      />
    );
  }
  // NEW: Render new screens if their state is active (overlaying the dashboard or other screens if needed)
  // These are rendered *instead of* the main screen content when active.
  else if (showTripHistory) {
    mainContent = (
      <TripHistoryScreen
        onBack={() => setShowTripHistory(false)} // NEW: Handler to go back to dashboard
        onSelectTrip={(tripId) => {
          setSelectedTripId(tripId);
          setShowTripHistory(false); // Close history
          setShowTripDetails(true); // Open details
        }}
      />
    );
  } else if (showTripDetails && selectedTripId) {
    mainContent = (
      <TripDetailsScreen
        tripId={selectedTripId}
        onBack={() => {
          setShowTripDetails(false);
          setSelectedTripId(null); // Clear selected ID
          setShowTripHistory(true); // Optionally go back to history
        }}
      />
    );
  } else if (showWallet) {
    mainContent = (
      <WalletScreen
        balance={walletBalance} // NEW: Pass current balance
        onBack={() => setShowWallet(false)} // NEW: Handler to go back to dashboard
      />
    );
  } else if (showSettings) {
    mainContent = (
      <SettingsScreen
        onBack={() => setShowSettings(false)} // NEW: Handler to go back to dashboard
        onShowProfile={() => {
          setShowSettings(false);
          setShowProfile(true);
        }} // NEW: Navigate to profile from settings
        onShowEnable2FA={() => {
          setShowSettings(false);
          setShowEnable2FA(true);
        }} // NEW: Navigate to 2FA enable from settings
        onShowUpdateProfile={() => {
          setShowSettings(false);
          setShowUpdateProfile(true);
        }} // NEW: Navigate to profile update from settings
        // Add other handlers for settings options (notifications, help, etc.)
      />
    );
  }
  // Note: Removed the 'signup-prompt' screen render block as it's handled by the showSignup state and modal

  // === Return full UI tree including modals and notifications ===
  return (
    <>
      <div className="min-h-screen flex items-center justify-center">
        <div
          className="
  min-h-screen h-dvh
  w-full max-w-[430px] mx-auto
  bg-white
  flex flex-col
  /* Critical for header/body/footer layouts */
  text-sm
  antialiased
  [font-feature-settings:'ss01']
"
        >
          {/* NEW: Render notification if available */}
          {currentNotification && (
            <TripUpdateNotification
              message={currentNotification.message}
              type={currentNotification.type}
              onDismiss={() => setCurrentNotification(null)}
            />
          )}

          {mainContent}

          {/* Modals  all rendered as overlays */}
          <PassengerDetailsModal
            isOpen={showPassengerDetails}
            onClose={() => setShowPassengerDetails(false)}
            passengerData={passengerData}
            setPassengerData={setPassengerData}
            requirements={requirements}
            setRequirements={setRequirements}
            onRequestRide={handleRequestRide}
            isLoading={tripRequestStatus === "loading"}
          />

           <LocationPermissionModal
              isOpen={showLocationModal}
              onClose={handleLocationModalClose}
              onGrantAccess={handleGrantLocationAccess}
            />

          {/* NEW: Dynamically imported DirectionsModal */}
          {hasHydrated && (
            <DirectionsModal
              isOpen={showDirections}
              onClose={() => setShowDirections(false)}
              pickup={pickup}
              pickupCoords={pickupCoords}
              destination={destination} // NEW
              destinationCoords={destinationCoords} // NEW
            />
          )}

          <PanicModal
            isOpen={showPanic}
            onClose={() => setShowPanic(false)}
            onComplete={() => {
              setShowPanic(false);
              alert("Safety team notified");
            }}
          />

          {!token &&
            showSignup && ( // Ensure it only shows for unauthenticated users
              <SignupPromptModal
                isOpen={showSignup} // Use showSignup state
                passengerData={passengerData}
                onClose={() => setShowSignup(false)} // Close the modal state
                onVerifyEmail={() => setShowOTP(true)} // Keep existing link to OTP
                onRegistrationSuccess={handleRegistrationSuccess} // NEW: Pass success handler
                onOpenLoginModal={() => setShowLogin(true)} // NEW: Pass handler to open login modal
                onSignup={() => {
                  // NEW: Handler for signup button in modal (e.g., navigate to register)
                  setShowSignup(false);
                  // You could navigate to a registration page or open the registration modal here
                  // For now, just close the prompt.
                }}
                onLogin={() => {
                  // NEW: Handler for login button in modal (e.g., open login modal)
                  setShowSignup(false);
                  // You could open a login modal here
                  // For now, just close the prompt.
                }}
                onContinueAsGuest={() => {
                  // NEW: Handler for continue as guest button (e.g., close modal, maybe navigate to dashboard)
                  setShowSignup(false);
                  setScreen("dashboard"); // Example: go to dashboard after trip
                }}
                // NEW: Pass registration success handler
              />
            )}

          <OTPModal
            isOpen={showOTP}
            email={passengerData.email}
            onComplete={() => {
              setTimeout(() => {
                setScreen("dashboard");
                setShowOTP(false);
                setShowSignup(false);
              }, 1000);
            }}
            onClose={() => setShowOTP(false)}
          />

          <ProfileModal
            isOpen={showProfile}
            passengerData={passengerData}
            onClose={() => setShowProfile(false)}
            onLogout={() => {
              // Clear saved state on logout
              if (typeof window !== "undefined" && window.sessionStorage) {
                sessionStorage.removeItem("achrams_app_state");
              }
              window.location.href = "/auth/login";
            }}
          />

          {/* NEW: Trip Request Status Modal */}
          <TripRequestStatusModal
            isOpen={!!tripRequestStatus}
            status={tripRequestStatus}
            message={tripRequestError}
            onClose={() => {setTripRequestStatus(null)
              setScreen("booking")
            }}
            onConfirm={() => {
                if (tripRequestStatus === 'no-driver' || tripRequestStatus === 'error') {
                  // NEW: If status is 'no-driver' or 'error', retry the booking process
                  console.log("Retrying booking process...");
                  setTripRequestStatus(null); // Close the modal first
                  // NEW: Call the main booking function again to restart the flow
                  handleRequestRide();
                } else {
                  // For 'loading' or 'accepted' states, just close the modal
                  setTripRequestStatus(null);
                }}}
          />

          {/* NEW: Driver Verification Modal */}
          <DriverVerificationModal
            isOpen={showDriverVerification}
            securityCode={verificationCode || ""}
            onClose={() => setShowDriverVerification(false)}
          />

          {/* NEW: Login Modal */}
          <LoginModal
            isOpen={showLogin}
            onClose={() => setShowLogin(false)}
            onLoginSuccess={handleLoginSuccess} // NEW: Pass success handler
          />

          {/* NEW: Modals for dashboard features */}
          {showEnable2FA && (
            <Enable2FAModal
              isOpen={showEnable2FA}
              onClose={() => setShowEnable2FA(false)}
              onSuccess={handle2FAEnabled} // NEW: Pass success handler
            />
          )}
          {showDisable2FA && (
            <Disable2FAModal
              isOpen={showDisable2FA}
              onClose={() => setShowDisable2FA(false)}
              onSuccess={handle2FADisabled} // NEW: Pass success handler
            />
          )}
          {showUpdateProfile && (
            <UpdateProfileModal
              isOpen={showUpdateProfile}
              initialData={passengerData} // Pass current data as initial values
              onClose={() => setShowUpdateProfile(false)}
              onSuccess={handleProfileUpdated} // NEW: Pass success handler
            />
          )}

          {/* Future: Uncomment when implemented */}
          <CancelModal
            isOpen={showCancel}
            onClose={() => setShowCancel(false)}
            onConfirm={() => {}}
          />
          {showRate && (
            <RateModal
              isOpen={showRate}
              onClose={() => setShowRate(false)}
              onRate={handleRateSubmit} // Assuming you have a function to handle API call
              driverName={driver?.name}
              // NEW: Pass the notification setter as setNotification
              setNotification={setCurrentNotification} // Use setCurrentNotification
            />
          )}
          <MessageWindowModal
            isOpen={showMessage}
            onClose={() => setShowMessage(false)}
            recipientName={driver?.name || "Driver"}
          />
        </div>
      </div>
      {/* NEW: Bottom Navigation Bar - Rendered only on dashboard screen */}
      {screen === "dashboard" && (
        <BottomNavBar
          onProfileClick={() => setShowProfile(true)}
          walletBalance={walletBalance} // Pass balance for potential icon badge
          onHomeClick={() => setScreen("booking")} // Example: Home click books new trip
          onWalletClick={() => setShowWallet(true)} // NEW: Link wallet click
          onSearchClick={() => setShowTripHistory(true)} // Example: Link search to history
          // Add other handlers for new nav items if needed
        />
      )}
    </>
  );
}


----- FILE: src/app/globals.css -----
/* src/app/globals.css */
@import "tailwindcss";
/* Define ACHRAMS theme tokens using @theme */


@utility bg-achrams-gradient-primary {
  background: linear-gradient(
    135deg,
    #06b27c 0%,
    #059669 40%,
    #0d9488 100%
  );
}

@utility bg-achrams-gradient-secondary {
  background: linear-gradient(
    135deg,
    #0da9a0 0%,
    #0d9488 45%,
    #0891b2 100%
  );
}

@theme {

  /* Solid Colors */
  --color-achrams-primary-solid: #059669;
  --color-achrams-secondary-solid: #0d9488;
  --color-achrams-accent: #0891b2;
  --color-achrams-text-primary: #1f2937;
  --color-achrams-text-secondary: #6b7280;
  --color-achrams-text-light: #f9fafb;
  --color-achrams-background-primary: #ffffff;
  --color-achrams-background-secondary: #f3f4f6;
  --color-achrams-background-card: #ffffff;
  --color-achrams-border: #e5e7eb;
}

/* Your existing default theme variables can remain if needed */
:root {
  --background: #ffffff; /* Aligns with achrams-background-primary */
  --foreground: #171717;
}

/* @media (prefers-color-scheme: dark) {
  :root {
    --background: #0a0a0a;
    --foreground: #ededed;
  }
} */

/* Your existing body styles */
body {
  background: var(--background);
  color: var(--foreground);
  font-family: Arial, Helvetica, sans-serif;
  margin: 0;
  padding: 0;
  height: 100%;
}

#__next,
html,
body {
  height: 100%;
}

/* 3. Mobile viewport height fix (very important on iOS/Android) */
@viewport {
  width: device-width;
  height: device-height;
}

/* 4. Optional: respect safe-area on notched devices */
@layer utilities {
  .pt-safe {
    padding-top: env(safe-area-inset-top);
  }
  .pb-safe {
    padding-bottom: env(safe-area-inset-bottom);
  }
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
@keyframes scaleIn {
  from { transform: scale(0.8); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}
@keyframes fadeInScale {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

.animate-fadeIn {
  animation: fadeIn 0.3s ease-out forwards;
}
.animate-fadeInUp {
  animation: fadeInUp 0.4s ease-out forwards;
}
.animate-scaleIn {
  animation: scaleIn 0.3s ease-out forwards;
}
.animate-fadeInScale {
  animation: fadeInScale 0.3s ease-out forwards;
}

----- FILE: src/app/page.tsx -----
// src/app/page.tsx
"use client";

import { useEffect, useState } from "react";
import { useAuth } from "@/contexts/AuthContext";
import BookingScreen from "@/components/app/screens/BookingScreen";
import AssigningScreen from "@/components/app/screens/AssigningScreen";
import DriverAssignedScreen from "@/components/app/screens/DriverAssignedScreen";
// NEW: Import TripProgressScreen statically
import TripProgressScreen from "@/components/app/screens/TripProgressScreen";
import TripCompleteScreen from "@/components/app/screens/TripCompleteScreen";
// NEW: Import new dashboard-related screens
import TripHistoryScreen from "@/components/app/screens/TripHistoryScreen";
import TripDetailsScreen from "@/components/app/screens/TripDetailsScreen";
import WalletScreen from "@/components/app/screens/WalletScreen";
import SettingsScreen from "@/components/app/screens/SettingsScreen";

// NEW: Import the dashboard screen (assuming it's updated to handle new features)
import DashboardScreen from "@/components/app/screens/DashboardScreen";

// Modals - Dynamically import map-dependent modals like DirectionsModal
import dynamic from "next/dynamic";
const DirectionsModal = dynamic(
  () => import("@/components/app/modals/DirectionsModal"),
  { ssr: false }
);

// Modals - Imported normally
import PassengerDetailsModal from "@/components/app/modals/PassengerDetailsModal";
import PanicModal from "@/components/app/modals/PanicModal";
import SignupPromptModal from "@/components/app/modals/SignupPromptModal";
import OTPModal from "@/components/app/modals/OTPModal";
import ProfileModal from "@/components/app/modals/ProfileModal";
import CancelModal from "@/components/app/modals/CancelModal";
import RateModal from "@/components/app/modals/RateModal";
import MessageWindowModal from "@/components/app/modals/MessageWindowModal";
import TripRequestStatusModal from "@/components/app/modals/TripRequestStatusModal";
import DriverVerificationModal from "@/components/app/modals/DriverVerificationModal";
import LoginModal from "@/components/app/modals/LoginModal";
// NEW: Import new modals
import Enable2FAModal from "@/components/app/modals/Enable2FAModal";
import Disable2FAModal from "@/components/app/modals/Disable2FAModal";
import UpdateProfileModal from "@/components/app/modals/UpdateProfileModal";


import Image from "next/image";
import { apiClient } from "@/lib/api";

// UI
import TripUpdateNotification from "@/components/app/ui/TripUpdateNotification";
// NEW: Import BottomNavBar
import BottomNavBar from "@/components/app/ui/BottomNavBar";
import { findNearestAirport, KNOWN_AIRPORTS } from "@/lib/airports";
import ReconnectingWebSocket from "reconnecting-websocket";

type TripStatusValue =
  | "searching"
  | "driver_assigned"
  | "accepted"
  | "active"
  | "completed"
  | "cancelled"
  | "driver not found"; // Added "driver not found"

  type TripStatus = {
  label: string;
  value: TripStatusValue;
};

// NEW: Define types for the WebSocket message
type WebSocketMessage = {
  event: "trip:assigned" | "trip:status:update" | string; // Add other potential events
  any; // This will be the trip object
};

// Types
type ScreenState =
  | "booking"
  | "assigning"
  | "driver-assigned"
  | "trip-progress"
  | "trip-complete"
  | "dashboard";
// NEW: Add any new screen states if necessary, though most new features will be modals/screens on top of 'dashboard'

type Requirements = {
  luggage: boolean;
  wheelchair: boolean;
  elderly: boolean;
};

type PassengerData = {
  name: string;
  phone: string;
  email: string;
};

// NEW: Define type for the state you want to persist
interface PersistedState {
  screen: ScreenState;
  pickup: string;
  destination: string;
  fareEstimate: number | null;
  driver: any | null;
  tripProgress: number;
  pickupCoords: [number, number] | null;
  destinationCoords: [number, number] | null;
  verificationCode: string | null;
  // NEW: Add other critical states you want to persist across refresh
  // e.g., walletBalance, is2FAEnabled (though these might be fetched fresh from API on load)
  // Add other critical states as needed
}

// NEW: Function to save state to sessionStorage - only runs on client
const saveAppState = (state: PersistedState) => {
  if (typeof window !== "undefined" && window.sessionStorage) {
    try {
      sessionStorage.setItem("achrams_app_state", JSON.stringify(state));
      console.log("App state saved to sessionStorage"); // Optional: For debugging
    } catch (e) {
      console.error("Failed to save app state to sessionStorage", e);
    }
  }
};

// NEW: Function to load state from sessionStorage - only runs on client
const loadAppState = (): PersistedState | null => {
  if (typeof window !== "undefined" && window.sessionStorage) {
    try {
      const savedStateStr = sessionStorage.getItem("achrams_app_state");
      if (savedStateStr) {
        const savedState = JSON.parse(savedStateStr) as PersistedState;
        console.log("App state loaded from sessionStorage", savedState); // Optional: For debugging
        return savedState;
      }
    } catch (e) {
      console.error("Failed to load app state from sessionStorage", e);
    }
  }
  return null; // Return null if sessionStorage is not available or error occurred
};

export default function ACHRAMApp() {
  const { token } = useAuth();

  // NEW: Use a state variable to track if we have checked sessionStorage on the client
  const [hasHydrated, setHasHydrated] = useState(false);

  // NEW: Define state variables without initial values from loadAppState here
  const [screen, setScreen] = useState<ScreenState>("booking"); // Will be set after hydration
  const [pickup, setPickup] = useState<string>("");
  const [destination, setDestination] = useState<string>("");
  const [fareEstimate, setFareEstimate] = useState<number | null>(null);
  const [driver, setDriver] = useState<any>(null);
  const [tripProgress, setTripProgress] = useState<number>(0);
  const [pickupCoords, setPickupCoords] = useState<[number, number] | null>(
    null
  );
  const [destinationCoords, setDestinationCoords] = useState<
    [number, number] | null
  >(null);
  const [verificationCode, setVerificationCode] = useState<string | null>(null);
  const [guestId, setGuestId] = useState<string | null>(null); // NEW: Store guest ID
  const [activeTripId, setActiveTripId] = useState<string | null>(null); // NEW: Store active trip ID (from booking response)
  // NEW: State for WebSocket connection
  const [webSocketConnection, setWebSocketConnection] =
    useState<ReconnectingWebSocket | null>(null);
  const [webSocketStatus, setWebSocketStatus] = useState<
    "connecting" | "open" | "closed" | "reconnecting"
  >("closed");
  // NEW: State for polling fallback
  const [pollingIntervalId, setPollingIntervalId] =
    useState<NodeJS.Timeout | null>(null);

  // NEW: State for new dashboard features (these might be fetched from API on load)
  const [walletBalance, setWalletBalance] = useState<number>(0); // NEW: State for wallet balance
  const [is2FAEnabled, setIs2FAEnabled] = useState<boolean>(false); // NEW: State for 2FA status
  // const [activeTripId, setActiveTripId] = useState<string | null>(null); // NEW: State for active trip ID (if any)

  // NEW: State for modals (these can be initialized normally)
  const [showPassengerDetails, setShowPassengerDetails] = useState(false);
  const [showDirections, setShowDirections] = useState(false);
  const [showPanic, setShowPanic] = useState(false);
  const [showSignup, setShowSignup] = useState(false); // NEW: Use this state instead of screen === 'signup-prompt'
  const [showOTP, setShowOTP] = useState(false);
  const [showProfile, setShowProfile] = useState(false);
  const [showCancel, setShowCancel] = useState(false);
  const [showRate, setShowRate] = useState(false);
  const [showMessage, setShowMessage] = useState(false);

  // NEW: State for new modals/screens
  const [showTripHistory, setShowTripHistory] = useState(false);
  const [showTripDetails, setShowTripDetails] = useState(false);
  const [selectedTripId, setSelectedTripId] = useState<string | null>(null);
  const [showWallet, setShowWallet] = useState(false);
  const [showSettings, setShowSettings] = useState(false);
  const [showEnable2FA, setShowEnable2FA] = useState(false);
  const [showDisable2FA, setShowDisable2FA] = useState(false);
  const [showUpdateProfile, setShowUpdateProfile] = useState(false);

  // NEW: State for Login Modal
  const [showLogin, setShowLogin] = useState(false); // NEW: Add state for login modal

  // NEW: State for trip request status modal
  const [tripRequestStatus, setTripRequestStatus] = useState<
    "loading" | "accepted" | "no-driver" | "error" | null
  >(null);
  const [tripRequestError, setTripRequestError] = useState<string | null>(null);

  // NEW: State for driver verification modal
  const [showDriverVerification, setShowDriverVerification] = useState(false);

 


  // NEW: State for trip update notifications
  const [currentNotification, setCurrentNotification] = useState<{
    message: string;
    type: "info" | "success" | "warning" | "error";
  } | null>(null);

  // NEW: Effect to run only on the client after mount to load state and set initial values
  useEffect(() => {
    // Check if we are on the client
    if (typeof window !== "undefined") {
      const savedState = loadAppState();
      if (savedState) {
        // Set state using the loaded values
        setScreen(savedState.screen);
        setPickup(savedState.pickup);
        setDestination(savedState.destination);
        setFareEstimate(savedState.fareEstimate);
        setDriver(savedState.driver);
        setTripProgress(savedState.tripProgress);
        setPickupCoords(savedState.pickupCoords);
        setDestinationCoords(savedState.destinationCoords);
        setVerificationCode(savedState.verificationCode);
        // NEW: Load other persisted states if added
        // setWalletBalance(savedState.walletBalance); // Example
        // setIs2FAEnabled(savedState.is2FAEnabled); // Example
      } else {
        // Set default initial state based on token
        setScreen(token ? "dashboard" : "booking");
      }
      // Mark as hydrated after loading/saving defaults
      setHasHydrated(true);
    } else {
      // Fallback if somehow this runs on server (shouldn't with 'use client')
      setScreen(token ? "dashboard" : "booking");
      setHasHydrated(true);
    }
  }, [token]); // Depend on token if initial screen logic depends on it

  // NEW: Effect to fetch user profile data (including 2FA status, wallet, active trip) on initial load or token change
  useEffect(() => {
    if (hasHydrated && token) {
      const fetchUserProfile = async () => {
        try {
          // NEW: Call the API to get user profile using apiClient
          // Example: const response = await apiClient.get('/auth/passenger/me');
          // Example structure based on passenger postman DOC.txt:
          // const profileData = response.data.data;
          // setWalletBalance(profileData.profile.wallet.balance.amount);
          // setIs2FAEnabled(profileData.is_2fa_enabled);
          // if (profileData.profile.active_trip) {
          //    setActiveTripId(profileData.profile.active_trip.id);
          //    // Potentially set screen to 'driver-assigned' or 'trip-progress' if active trip exists
          //    // This logic depends on your desired UX for resuming active trips
          // }

          // For now, simulate with mock data after a short delay
          setTimeout(() => {
            setWalletBalance(5000); // Mock balance
            setIs2FAEnabled(false); // Mock 2FA status
            // setActiveTripId(null); // Mock active trip ID - assume no active trip for this example
          }, 500); // Simulate API delay
        } catch (err) {
          console.error("Failed to fetch user profile:", err);
          // NEW: Optionally show an error notification
          setCurrentNotification({
            message: "Failed to load profile data.",
            type: "error",
          });
          setTimeout(() => setCurrentNotification(null), 5000);
        }
      };

      fetchUserProfile();
    }
  }, [hasHydrated, token]); // Run when hydrated state is true and token changes

  // NEW: Effect to handle navigation after trip completion and set showSignup
  useEffect(() => {
    if (screen === "trip-complete") {
      // Check if user is authenticated
      if (token) {
        // If authenticated, maybe show rate modal (if not already shown) and then go to dashboard
        // Or, if rating is handled elsewhere, just go to dashboard after a delay or user action
        // For now, let's assume the user can click a button or it happens automatically after a short delay
        // Or, the TripCompleteScreen itself could trigger this.
        // Let's simulate a delay and then transition to dashboard if authenticated.
        // This is just a simulation, the real trigger might be clicking 'Done' in TripCompleteScreen.
        // We'll add a specific state to manage this transition cleanly.
        // Let's assume the TripCompleteScreen has a button that calls a handler passed from page.tsx.
        // For now, let's just add the logic here that *would* happen when the user wants to leave the trip-complete screen.
        // The key is to clear trip data and set screen to dashboard *before* the save effect runs.
      } else {
        // If not authenticated (guest), show signup prompt after a delay
        const timer = setTimeout(() => {
          // NEW: Clear specific trip-related state before navigating to signup
          // Note: This clearing is now handled in the onDone handler in TripCompleteScreen render block
          // We set showSignup here, which triggers the modal.
          setShowSignup(true); // NEW: Trigger the signup modal
        }, 1500); // Delay matches the original effect

        return () => clearTimeout(timer);
      }
    }
  }, [screen, token]); // Depend on screen and token only

  // Data state
  const [passengerData, setPassengerData] = useState<PassengerData>({
    name: "",
    phone: "",
    email: "",
  });
  const [requirements, setRequirements] = useState<Requirements>({
    luggage: false,
    wheelchair: false,
    elderly: false,
  });

  // NEW: Function to show notifications
  const showNotification = (
    message: string,
    type: "info" | "success" | "warning" | "error"
  ) => {
    setCurrentNotification({ message, type });
    setTimeout(() => {
      setCurrentNotification(null);
    }, 5000); // Auto-dismiss after 5 seconds
  };

  // NEW: Effect to trigger notifications based on screen changes (simulated)
  useEffect(() => {
    if (screen === "driver-assigned" && driver) {
      // Simulate driver found notification
      showNotification("Driver assigned successfully!", "success");
      // Simulate trip updates after some delay
      const timer1 = setTimeout(
        () => showNotification("Driver is 7 mins from pickup location", "info"),
        3000
      );
      const timer2 = setTimeout(
        () =>
          showNotification("Driver has arrived at pickup location", "success"),
        10000
      );

      return () => {
        clearTimeout(timer1);
        clearTimeout(timer2);
      };
    }
    if (screen === "trip-progress") {
      // Simulate ongoing trip updates
      const timer = setInterval(() => {
        setTripProgress((prev) => {
          if (prev >= 100) {
            clearInterval(timer);
            setScreen("trip-complete");
            return 100;
          }
          return prev + 2; // Simulate progress
        });
      }, 1000); // Update every second for simulation

      return () => clearInterval(timer);
    }
  }, [screen, driver]); // Depend on screen and driver

  // NEW: Effect to save state whenever it changes (only runs on client after hydration)
  useEffect(() => {
    if (hasHydrated) {
      // Only save after initial state has been loaded/set
      const stateToSave: PersistedState = {
        screen,
        pickup,
        destination,
        fareEstimate,
        driver,
        tripProgress,
        pickupCoords,
        destinationCoords,
        verificationCode,
        // NEW: Add other states you want to persist
        // walletBalance, // Example - might be fetched fresh from API
        // is2FAEnabled, // Example - might be fetched fresh from API
        // Add other states...
      };
      saveAppState(stateToSave);
    }
  }, [
    screen,
    pickup,
    destination,
    fareEstimate,
    driver,
    tripProgress,
    pickupCoords,
    destinationCoords,
    verificationCode,
    // NEW: Add other states to dependency array if they are included in stateToSave
    // walletBalance,
    // is2FAEnabled,
    hasHydrated, // Include hydration flag to prevent saving before state is loaded
  ]);

  // NEW: Handler passed to SignupPromptModal for successful registration (e.g., open OTP)
  const handleRegistrationSuccess = (email: string) => {
    // For now, simulate OTP verification success and move to dashboard
    // In reality, you'd open OTPModal here
    // setShowOTP(true); // Assuming OTPModal exists and handles verification
    // If OTP verification is successful within OTPModal, it would then trigger navigation to dashboard
    // OR, if registration API directly logs in (less common), update token and screen here.
    // Let's assume it leads to OTP first, then dashboard.
    // For this mock, let's just move to dashboard after "registration"
    setScreen("dashboard");
    setShowSignup(false); // Close signup prompt modal
    // setShowOTP(true); // Uncomment if implementing OTP flow
  };

  // NEW: Handler passed to LoginModal for successful login
  const handleLoginSuccess = () => {
    // The useAuth context should now have the token
    // page.tsx relies on the `token` from useAuth to determine initial screen and rendering logic
    // If token exists, screen should be 'dashboard' (handled by initial load or subsequent logic)
    // Ensure screen is set correctly, maybe explicitly if needed after login
    // setScreen('dashboard'); // Often not needed if initial load logic handles it based on token
    // onClose in LoginModal should be sufficient if screen logic in render is correct
    // No explicit action needed here if state management is correct, just let the parent re-render based on updated token.
    // If token changes and initial screen logic in useEffect isn't catching it, maybe force update screen here.
    // For now, assume token update in context triggers correct re-render.
    // NEW: Optionally refetch profile data after login
    // setHasHydrated(false); // Trigger re-fetch logic in profile effect by resetting hydration state slightly
    // OR, rely on the token change triggering the profile fetch effect naturally.
  };

  // NEW: Handler passed to Enable2FAModal on success
  const handle2FAEnabled = () => {
    setIs2FAEnabled(true); // Update local state
    setShowEnable2FA(false); // Close the modal
    // NEW: Optionally show a success notification
    showNotification(
      "Two-factor authentication enabled successfully!",
      "success"
    );
  };

  // NEW: Handler passed to Disable2FAModal on success
  const handle2FADisabled = () => {
    setIs2FAEnabled(false); // Update local state
    setShowDisable2FA(false); // Close the modal
    // NEW: Optionally show a success notification
    showNotification("Two-factor authentication disabled.", "info");
  };

  // NEW: Handler passed to UpdateProfileModal on success
  const handleProfileUpdated = (updatedData: any) => {
    // Update local passengerData state with the new data
    setPassengerData(updatedData);
    setShowUpdateProfile(false); // Close the modal
    // NEW: Optionally show a success notification
    showNotification("Profile updated successfully!", "success");
  };

  const handleProceed = () => {
    if (fareEstimate && pickup && destination) {
      setShowPassengerDetails(true);
    }
  };

  // src/app/page.tsx

  // Add this helper function inside your component
  const formatPhoneNumber = (input: string): string => {
    // Remove any non-digit characters (like spaces, dashes, parentheses)
    const digitsOnly = input.replace(/\D/g, "");

    // If it starts with '0', remove the '0' and prepend '+234'
    if (digitsOnly.startsWith("0")) {
      return `+234${digitsOnly.slice(1)}`;
    }

    // If it starts with '234', prepend '+'
    if (digitsOnly.startsWith("234")) {
      return `+${digitsOnly}`;
    }

    // If it already starts with '+', return as is
    if (digitsOnly.startsWith("+")) {
      return digitsOnly;
    }

    // If it's a bare number without a country code, assume it's a Nigerian number starting with '0'
    // This is a fallback; ideally, your input validation should enforce a format.
    if (digitsOnly.length === 11) {
      return `+234${digitsOnly.slice(1)}`;
    }

    // If none of the above, return as is (might cause API error)
    return digitsOnly;
  };

  // NEW: Modified handleRequestRide with mock API call simulation and state persistence
  // NEW: Modified handleRequestRide with real API call integration and state persistence
  const handleRequestRide = async () => {
  if (!passengerData.name || !passengerData.phone || !passengerData.email) {
    showNotification("Please fill all passenger details.", "error");
    return;
  }

  if (!pickupCoords || !destinationCoords) {
    showNotification(
      "Pickup and destination locations are required.",
      "error"
    );
    return;
  }

  setShowPassengerDetails(false);
  setTripRequestStatus("loading"); // Shows "Finding a driver..." modal

  try {
    // === Step A: Resolve airport ID ===
    let airportId: string | null = null;

    if (pickup.startsWith("Use my current location")) {
      // NEW: This branch might now be less likely to be triggered if BookingScreen
      // correctly sets the `pickup` state to the *resolved name* (e.g., "Murtala Muhammed International Airport")
      // and `pickupCoords` to the geolocation coords, because `pickup` no longer literally starts with "Use my current location".
      // However, keep it as a potential fallback or if the naming logic in BookingScreen changes slightly.
      // The critical part is that `pickupCoords` contains the coordinates used for the API call,
      // and `pickup` contains the *name* of the *selected* airport.

      // Fetch airports based on the coordinates stored in pickupCoords
      const nearestAirports = await findNearestAirport(pickupCoords[0], pickupCoords[1]);

      if (!nearestAirports || !nearestAirports.length) {
        setTripRequestStatus("error");
        setTripRequestError("Youre outside our service area. Booking not available from this location.");
        return;
      }

      // NEW: Find the specific airport ID based on the `pickup` name state
      // This assumes the name set by BookingScreen matches the `name` field from the API exactly.
      // This is the crucial change: match the name stored in state to the array returned by the API.
      const selectedAirport = nearestAirports.find(apt => apt.name === pickup);
      if (!selectedAirport) {
          console.error("Selected pickup name does not match any fetched airport:", pickup, nearestAirports);
          setTripRequestStatus("error");
          setTripRequestError("Could not confirm selected pickup location. Please try again.");
          return;
      }
      airportId = selectedAirport.id;

    } else if (pickup in KNOWN_AIRPORTS) {
      // Handle selection from the hardcoded list in BookingScreen
      airportId = KNOWN_AIRPORTS[pickup];
    } else {
      // Handle a custom pickup name typed by the user (e.g., via Google Autocomplete or manual entry).
      // The `pickupCoords` should now be the coordinates resolved from the *typed* destination name
      // by the Google Autocomplete component integrated into BookingScreen.
      // Call the API again to ensure the coordinates map to a valid ACHRAMS airport.
      const nearestAirports = await findNearestAirport(pickupCoords[0], pickupCoords[1]);

      if (!nearestAirports || !nearestAirports.length) {
        setTripRequestStatus("error");
        setTripRequestError("Pickup location is not near a supported airport.");
        return;
      }

      // NEW: Similar to the "Use my current location" case, find the ID based on the name stored in state.
      // For a custom name, `pickup` is the typed name, and `pickupCoords` are its resolved coordinates.
      // The API might return airports near those coordinates.
      // This logic assumes that for a custom name, the intention is to find *an* ACHRAMS airport near the *typed* location.
      // If the user types "Some Random Street", and it resolves to coordinates not near an ACHRAMS airport,
      // `findNearestAirport` should return null, and the check above (`!nearestAirports`) handles it.
      // If it *does* resolve near an airport, this code finds the ID for that airport.
      // However, if the user typed "Murtala Muhammed Int'l Airport", it should ideally resolve coordinates
      // that `findNearestAirport` matches back to the ACHRAMS entry for that airport.
      // The name matching logic here is primarily for the "Use my current location" case where the name is explicitly selected.
      // For custom names, if the coordinates are accurate, `findNearestAirport` should ideally return the relevant airport.
      // If the typed name doesn't correspond to a specific ACHRAMS airport boundary but is nearby,
      // the backend might expect the ID of the nearest ACHRAMS airport.
      // The safest bet is still to match the name if possible, or default to the first result if names don't match perfectly.
      // Let's try name matching first, then fall back.
      const selectedAirport = nearestAirports.find(apt => apt.name === pickup);
      if (selectedAirport) {
          airportId = selectedAirport.id;
      } else {
          // Fallback: if the typed name doesn't exactly match an API result name,
          // use the first result from the API call (assuming it's the nearest one).
          // This covers cases where the user types a location close to an airport but not the airport name itself,
          // and the system correctly identifies the nearest airport boundary.
          console.warn("Typed pickup name did not match any fetched airport name, using first result.", pickup, nearestAirports);
          airportId = nearestAirports[0].id;
      }
    }

    // === Step B: Prepare request body (amount, guest details, requirements, locations) ===
    // (This part remains largely the same, using fareEstimate, passengerData, requirements, pickupCoords, destinationCoords)
    const tripData = {
      amount: {
        amount: fareEstimate?.toString() || "0",
        currency: "NGN",
      },
      airport: airportId, // Use the resolved ID
      guest_name: passengerData.name,
      guest_email: passengerData.email,
      guest_phone: formatPhoneNumber(passengerData.phone),
      has_extra_leg_room: requirements.elderly,
      has_extra_luggage: requirements.luggage,
      has_wheel_chair_access: requirements.wheelchair,
      pickup_address: pickup, // The resolved/typed pickup name
      pickup_location: pickupCoords, // [lng, lat] from state
      destination_address: destination, // The typed destination name
      destination_location: destinationCoords, // [lng, lat] from state (resolved by Google Autocomplete in BookingScreen)
    };

    console.log("Request Data:", tripData);

    // === Step C: Make API call ===
    const response = await apiClient.post("/trips/guest-booking", tripData);

    console.log("Raw API Response:", response);

    if (response.status === "success" && response.data) {
      const trip = response.data;
      const extractedGuestId = trip.guest?.id;

      if (!extractedGuestId) {
        console.error("Guest ID not found in booking response, cannot start WebSocket.");
        setTripRequestStatus('error');
        setTripRequestError('Failed to get guest session. Booking cancelled.');
        return;
      }

      console.log("Trip data received:", trip);
      console.log("Guest ID received:", extractedGuestId);

      setVerificationCode(trip.verification_code || "");
      setActiveTripId(trip.id);
      setGuestId(extractedGuestId);

      if (trip.status.value === "searching") {
        setTripRequestStatus(null);
        setScreen("assigning");
        startWebSocketConnection(extractedGuestId, trip.id);
      } else if (trip.status.value === "driver_assigned" && trip.driver) {
        setDriver(trip.driver);
        setTripRequestStatus(null);
        setScreen("driver-assigned");
        // No need to start WebSocket or polling if driver is already assigned
      } else {
        console.warn("Unexpected trip status after booking:", trip.status);
        setTripRequestStatus("error");
        setTripRequestError(`Unexpected booking state: ${trip.status.label}`);
      }
    } else {
      console.error(
        "API responded with non-success status or missing data:",
        response
      );
      let errorMessage = "Failed to book your trip. Server responded unexpectedly.";
      if (response.message) {
        errorMessage = response.message;
        if (response.details) {
          const fieldErrors = [];
          for (const [field, messages] of Object.entries(response.details)) {
            if (Array.isArray(messages)) {
              fieldErrors.push(`${field}: ${messages.join(", ")}`);
            }
          }
          if (fieldErrors.length > 0) {
            errorMessage += ` Details: ${fieldErrors.join("; ")}`;
          }
        }
      }
      throw new Error(errorMessage);
    }
  } catch (err: any) {
    console.error("Guest booking error:", err);
    setTripRequestStatus("error");

    let errorMessage = "Failed to book your trip. Please check your connection and try again.";

    if (err instanceof Error) {
      errorMessage = err.message;
    } else {
      console.error("Unexpected error type caught:", typeof err, err);
      errorMessage = 'An unexpected error occurred during booking.';
    }

    setTripRequestError(errorMessage);
  }
};

 const handleShowLocationModal = () => {
    setShowLocationModal(true);
  };
const handleLocationModalClose = () => {
    setShowLocationModal(false);
  };


const handleGrantLocationAccess = () => {
  console.log("location access granted button clicked in modal. The BookingScreen will handle the requestPermission call")
}

  const startWebSocketConnection = (guestId: string, tripId: string) => {
    if (webSocketConnection) {
      // Close any existing connection before starting a new one
      console.log("Closing existing WebSocket connection.");
      webSocketConnection.close();
      // Note: The onclose handler will fire, potentially starting polling if trip is still active.
      // We might want to prevent that if we are intentionally reconnecting.
      // For now, the logic in onclose checks the screen state or activeTripId to decide.
    }

    // Construct the WebSocket URL using the guest ID
    const wsUrl = `wss://api.achrams.com.ng/ws/v1/app?guest_id=${guestId}`;

    console.log(`Attempting to connect to WebSocket: ${wsUrl}`);

    // Create the ReconnectingWebSocket instance
    const rws = new ReconnectingWebSocket(wsUrl, [], {
      // Optional configuration for ReconnectingWebSocket
      connectionTimeout: 10000, // Timeout for individual connection attempts
      maxRetries: 10, // Maximum number of reconnection attempts (or Number.MAX_VALUE for unlimited)
      maxReconnectionDelay: 10000, // Maximum delay between reconnections
      // Add other options as needed from the library's documentation
    });

    // Set up event handlers
    rws.onopen = () => {
      console.log("WebSocket connection opened.");
      setWebSocketStatus("open");
      // If polling was running as a fallback, stop it now that WS is open
      stopPollingTripStatus();
    };

    rws.onmessage = (event) => {
      try {
        const messageData: WebSocketMessage = JSON.parse(event.data);
        console.log("Received WebSocket message:", messageData);

        const { event: eventType, data: tripData } = messageData;

        // Check if it's a relevant trip update event
        if (eventType === 'trip:assigned' || eventType === 'trip:status:update') {
      // Update UI state based on the received trip data

      // NEW: Check for 'driver not found' status
      if (tripData.status.value === 'driver not found') { // Use the exact string from backend/Postman
        console.log("Driver not found via WebSocket, updating UI.");
        // Stop both WebSocket and polling
        stopWebSocketConnection();
        stopPollingTripStatus();
        // Set status to show 'no-driver' modal
        setTripRequestStatus('no-driver');
        // Optionally set a specific error message
        setTripRequestError(`No drivers available for your trip.`);
        // Do NOT change the screen here, let the modal handle the user interaction.
        // The screen might still be 'assigning', which is okay until the user retries/cancels.
        return; // Exit handler after handling 'driver not found'
      }

      // NEW: Check for 'accepted' OR 'driver_assigned' status when a driver is present
      if ((tripData.status.value === 'accepted' || tripData.status.value === 'driver_assigned') && tripData.driver) {
        // Driver found or assigned!
        console.log(`${tripData.status.label} via WebSocket, updating UI with driver.`);
        setDriver(tripData.driver);
        setScreen('driver-assigned'); // Transition to the driver-assigned screen
        stopWebSocketConnection(); // Stop WebSocket as trip is assigned/accepted
        stopPollingTripStatus(); // Ensure polling is also stopped
        // No need to start polling here, as trip is assigned/accepted.
      } else if (tripData.status.value === 'cancelled' || tripData.status.value === 'completed') {
        // Trip is no longer active, stop polling and handle accordingly
        console.log(`Trip ${tripData.id} is now ${tripData.status.value} via WebSocket.`);
        setTripRequestStatus('error'); // Or a specific status like 'trip-cancelled'
        setTripRequestError(`Trip ${tripData.status.label}.`); // Show status message
        stopWebSocketConnection(); // Stop WebSocket as trip is finished
        stopPollingTripStatus(); // Ensure polling is also stopped
        // No need to start polling here, as trip is finished.
      } else {
        // Handle other statuses if needed, or just log/update state if necessary
        // e.g., update verification code, status label, etc., if relevant
        console.log(`Received trip status update via WebSocket: ${tripData.status.value}`);
        // You might want to update activeTripId if it changed, though unlikely after initial booking
        // setActiveTripId(tripData.id);
        // setVerificationCode(tripData.verification_code || '');
        // setTripStatus(tripData.status); // If you have a separate state for trip status
      }
    } else {
      // Handle other event types if the backend sends them
      console.log(`Received other WebSocket event: ${eventType}`);
    }
  } catch (error) {
    console.error('Error parsing WebSocket message:', error, event.data);
  }
    };

    // Inside startWebSocketConnection setup
rws.onclose = (event) => {
  console.log('WebSocket connection closed:', event.code, event.reason);
  setWebSocketStatus('closed');
  // IMPORTANT: The WebSocket closed. If the trip is *not* in a final state,
  // we need to start the polling fallback.
  // Check current screen or potentially fetch latest status via API first before polling.
  // For now, if screen is still 'assigning' or related to searching/active, and we have an active trip ID, start polling.
  // We'll pass the activeTripId to the polling function.
  // NEW: Only start polling if we are still in an intermediate state and polling isn't already active.
  if (activeTripId && !['driver-assigned', 'completed', 'cancelled', 'driver not found'].includes(screen) && !pollingIntervalId) { // NEW: Check pollingIntervalId
     console.log(`WebSocket closed, starting polling for trip ${activeTripId} as fallback.`);
     startPollingTripStatus(activeTripId);
  } else {
     console.log(`WebSocket closed, but not starting polling. Trip ID: ${activeTripId}, Screen: ${screen}, Polling Active: ${!!pollingIntervalId}`);
     // If screen is a final state, ensure polling is definitely stopped just in case.
     if (['driver-assigned', 'completed', 'cancelled', 'driver not found'].includes(screen)) {
         console.log("Screen indicates final state, ensuring polling is stopped.");
         stopPollingTripStatus(); // NEW: Ensure polling stops if closed event happens after final state
     }
  }
};

    rws.onerror = (error) => {
      console.error("WebSocket error:", error);
      // Error doesn't necessarily mean the connection is closed, but log it.
      // The library handles reconnection attempts.
      // You might want to update a UI status indicator if needed.
      // setWebSocketStatus('reconnecting'); // The library handles this internally, but you can track if desired.
    };

    // Store the connection instance
    setWebSocketConnection(rws);
    setWebSocketStatus("connecting"); // Update status while connecting
  };

  // NEW: Function to stop the WebSocket connection
  const stopWebSocketConnection = () => {
    if (webSocketConnection) {

      stopPollingTripStatus();
      console.log("Manually stopping WebSocket connection.");
      webSocketConnection.close(); // This will trigger the onclose handler
      setWebSocketConnection(null);
      setWebSocketStatus("closed");
    }
  };

  const fetchTripStatus = async (tripId: string) => {
    if (!tripId || !guestId) {
      // Ensure both tripId and guestId are available
      console.warn("fetchTripStatus called without a tripId or guestId");
      return;
    }
    try {
      console.log(
        `Polling trip status for ID: ${tripId} using guestId: ${guestId}`
      );
      // Use apiClient to call GET /trips/{id}
      // The apiClient (from src/lib/api.ts) is designed to add X-Guest-Id header if guestId is provided
      const response = await apiClient.get(`/trips/${tripId}`, true, guestId); // Pass isGuest=true and guestId

      // Remember, apiClient returns the JSON body directly for success
      if (response.status === "success" && response.data) {
        const trip = response.data; // This is the trip object from the API's { status: "...",  {...} }

        console.log(
          `Polled trip status: ${
            trip.status.value
          }, has driver: ${!!trip.driver}`
        );

        // Check the status and handle accordingly
        if (trip.status.value === "driver_assigned" && trip.driver) {
          // Driver found!
          console.log("Driver assigned via polling, updating UI.");
          setDriver(trip.driver);
          setScreen("driver-assigned"); // Transition to the next screen
          stopPollingTripStatus(); // Stop polling
          stopWebSocketConnection(); // Stop WebSocket if it was re-established during polling
        } else if (
          trip.status.value === "cancelled" ||
          trip.status.value === "completed"
        ) {
          // Trip is no longer active, stop polling and handle accordingly
          console.log(
            `Trip ${tripId} is now ${trip.status.value} via polling, stopping polling.`
          );
          setTripRequestStatus("error"); // Or a specific status like 'trip-cancelled'
          setTripRequestError(`Trip ${trip.status.label}.`); // Show status message
          stopPollingTripStatus(); // Stop polling
          stopWebSocketConnection(); // Stop WebSocket if it was re-established during polling
          // You might want to clear trip details and go back to booking or dashboard
        } else {
          // Trip is still searching or in another intermediate state via polling
          console.log(
            `Trip ${tripId} is still ${trip.status.value} via polling.`
          );
          // Continue polling
        }
      } else {
        // Handle API error response (e.g., status not "success"), e.g., trip not found (404)
        console.error(
          "Polling API responded with non-success status or missing ",
          response
        );
        // Decide: Stop polling? Retry? Log and continue?
        // For a 404 (trip not found), it might imply cancellation.
        // For other errors (500, etc.), maybe continue polling briefly.
        // For now, log and continue polling (assuming temporary issue or trip not yet visible).
        // You could add logic here to stop polling after N consecutive errors.
      }
    } catch (err) {
      // Handle network error or apiClient throwing an error
      console.error("Error polling trip status:", err);
      // Decide: Stop polling after a few errors? Or continue? Add retry logic?
      // For now, log and continue polling (assuming temporary network glitch).
      // Optionally, add retry logic or error count here.
    }
  };

  const startPollingTripStatus = (tripId: string) => {
    if (pollingIntervalId) {
      // Clear any existing polling interval to avoid duplicates
      clearInterval(pollingIntervalId);
    }

    console.log(
      `Starting polling for trip ${tripId} every 5 seconds (fallback).`
    );
    const interval = setInterval(() => {
      fetchTripStatus(tripId); // Pass the tripId to the fetch function
    }, 5000); // Poll every 5 seconds

    setPollingIntervalId(interval);
  };

  // NEW: Function to stop polling
  const stopPollingTripStatus = () => {
    if (pollingIntervalId) {
      console.log("Stopping trip status polling.");
      clearInterval(pollingIntervalId);
      setPollingIntervalId(null);
    }
  };

  useEffect(() => {
    return () => {
      console.log("Cleaning up WebSocket and polling intervals on unmount.");
      stopWebSocketConnection();
      stopPollingTripStatus();
    };
  }, []);

  const handleTripStart = () => {
    setScreen("trip-progress");
  };

  const handleRateSubmit = () => {
    setScreen("trip-complete");
  };

  const handleTripComplete = () => {
    setScreen("trip-complete");
  };

  // NEW: Wait for hydration before rendering main content to avoid SSR/client mismatch
  if (!hasHydrated) {
    return (
      <div className="flex items-center justify-center h-screen w-full bg-white animate-fadeIn">
        <div className="relative">
          {/* Soft pulsing glow */}
          <div className="absolute inset-0 rounded-2xl bg-achrams-gradient-primary opacity-40 blur-xl animate-pulse"></div>

          {/* Main Logo Container */}
          <div className="w-16 h-16 bg-achrams-gradient-primary rounded-2xl flex items-center justify-center shadow-xl animate-scaleIn relative overflow-hidden">
            {/* Subtle rotating light sweep */}
            <div className="absolute inset-0 bg-white/20 animate-sweep pointer-events-none"></div>

            <Image
              src="/images/logo.png"
              alt="ACHRAMS Logo"
              width={30}
              height={30}
              className="object-contain animate-popIn"
            />
          </div>
        </div>
      </div>
    ); // Or a skeleton loader
  }

  // === Render current screen as main content ===
  let mainContent = null;

  if (screen === "booking") {
    mainContent = (
      <BookingScreen
        pickup={pickup}
        setPickup={setPickup}
        destination={destination}
        setDestination={setDestination}
        fareEstimate={fareEstimate}
        setFareEstimate={setFareEstimate}
        onProceed={handleProceed}
        setShowPassengerDetails={setShowPassengerDetails}
        passengerData={passengerData}
        setPassengerData={setPassengerData}
        showPassengerDetails={showPassengerDetails}
        requirements={requirements}
        setRequirements={setRequirements}
        setPickupCoords={setPickupCoords} // NEW
        setDestinationCoords={setDestinationCoords} // NEW
       


      />
    );
  } else if (screen === "assigning") {
    mainContent = <AssigningScreen 
    status={tripRequestStatus}
    />;
  } else if (screen === "driver-assigned") {
    mainContent = (
      <DriverAssignedScreen
        pickup={pickup}
        destination={destination}
        driver={driver}
        verificationCode={verificationCode || ""} // NEW: Pass verification code
        onShowDirections={() => setShowDirections(true)}
        onShowDriverVerification={() => setShowDriverVerification(true)} // NEW: Handler for verification modal
        onStartTrip={handleTripStart}
        onBack={() => setScreen("booking")}
      />
    );
  } else if (screen === "trip-progress") {
    // NEW: Use the statically imported TripProgressScreen
    mainContent = (
      <TripProgressScreen
        driver={driver}
        onPanic={() => setShowPanic(true)}
        onComplete={handleTripComplete}
        pickupCoords={pickupCoords} // NEW: Pass coordinates
        destinationCoords={destinationCoords} // NEW: Pass coordinates
        tripProgress={tripProgress} // NEW: Pass progress
        // Remove canRenderMaps prop as it's no longer needed if using dynamic import for the screen was the main strategy
      />
    );
  } else if (screen === "trip-complete") {
    mainContent = (
      <TripCompleteScreen
        fareEstimate={fareEstimate}
        driver={driver}
        onRate={() => setShowRate(true)}
        onDone={() => {
          // NEW: Clear specific trip-related state before navigating
          setPickup("");
          setDestination("");
          setFareEstimate(null);
          setDriver(null);
          setTripProgress(0);
          setPickupCoords(null);
          setDestinationCoords(null);
          setVerificationCode(null); // NEW: Clear verification code
          // alert('was called');
          setGuestId(null); // NEW: Clear guest ID
          // Stop any potential polling/WebSocket if they were still running due to timing
          stopPollingTripStatus();
          stopWebSocketConnection();
          if (!token) {
            setScreen("dashboard");
          } else {
            // NEW: Instead of setting screen to 'signup-prompt', just set the showSignup state
            setScreen("booking");
            // setShowSignup(true);
          }
        }}
      />
    );
  } else if (screen === "dashboard") {
    // NEW: Render the DashboardScreen component
    mainContent = (
      <DashboardScreen
        passengerData={passengerData}
        walletBalance={walletBalance} // NEW: Pass wallet balance
        is2FAEnabled={is2FAEnabled} // NEW: Pass 2FA status
        onShowProfile={() => setShowProfile(true)}
        onBookNewTrip={() => {
          setScreen("booking");
          setPickup("");
          setDestination("");
          setFareEstimate(null);
          setPickupCoords(null);
          setDestinationCoords(null);
          setDriver(null);
          setTripProgress(0); // NEW: Reset trip progress
          setVerificationCode(null); // NEW: Reset verification code
        }}
        // NEW: Pass handlers for new dashboard features
        onShowTripHistory={() => setShowTripHistory(true)}
        onShowWallet={() => setShowWallet(true)}
        onShowSettings={() => setShowSettings(true)}
        onShowEnable2FA={() => setShowEnable2FA(true)} // NEW: Handler for enabling 2FA
        onShowUpdateProfile={() => setShowUpdateProfile(true)} // NEW: Handler for updating profile
        onBookRide={() => setScreen("booking")}
        onProfile={() => setShowProfile(true)}
        onLogout={() => {}}
      />
    );
  }
  // NEW: Render new screens if their state is active (overlaying the dashboard or other screens if needed)
  // These are rendered *instead of* the main screen content when active.
  else if (showTripHistory) {
    mainContent = (
      <TripHistoryScreen
        onBack={() => setShowTripHistory(false)} // NEW: Handler to go back to dashboard
        onSelectTrip={(tripId) => {
          setSelectedTripId(tripId);
          setShowTripHistory(false); // Close history
          setShowTripDetails(true); // Open details
        }}
      />
    );
  } else if (showTripDetails && selectedTripId) {
    mainContent = (
      <TripDetailsScreen
        tripId={selectedTripId}
        onBack={() => {
          setShowTripDetails(false);
          setSelectedTripId(null); // Clear selected ID
          setShowTripHistory(true); // Optionally go back to history
        }}
      />
    );
  } else if (showWallet) {
    mainContent = (
      <WalletScreen
        balance={walletBalance} // NEW: Pass current balance
        onBack={() => setShowWallet(false)} // NEW: Handler to go back to dashboard
      />
    );
  } else if (showSettings) {
    mainContent = (
      <SettingsScreen
        onBack={() => setShowSettings(false)} // NEW: Handler to go back to dashboard
        onShowProfile={() => {
          setShowSettings(false);
          setShowProfile(true);
        }} // NEW: Navigate to profile from settings
        onShowEnable2FA={() => {
          setShowSettings(false);
          setShowEnable2FA(true);
        }} // NEW: Navigate to 2FA enable from settings
        onShowUpdateProfile={() => {
          setShowSettings(false);
          setShowUpdateProfile(true);
        }} // NEW: Navigate to profile update from settings
        // Add other handlers for settings options (notifications, help, etc.)
      />
    );
  }
  // Note: Removed the 'signup-prompt' screen render block as it's handled by the showSignup state and modal

  // === Return full UI tree including modals and notifications ===
  return (
    <>
      <div className="min-h-screen flex items-center justify-center">
        <div
          className="
  min-h-screen h-dvh
  w-full max-w-[430px] mx-auto
  bg-white
  flex flex-col
  /* Critical for header/body/footer layouts */
  text-sm
  antialiased
  [font-feature-settings:'ss01']
"
        >
          {/* NEW: Render notification if available */}
          {currentNotification && (
            <TripUpdateNotification
              message={currentNotification.message}
              type={currentNotification.type}
              onDismiss={() => setCurrentNotification(null)}
            />
          )}

          {mainContent}

          {/* Modals  all rendered as overlays */}
          <PassengerDetailsModal
            isOpen={showPassengerDetails}
            onClose={() => setShowPassengerDetails(false)}
            passengerData={passengerData}
            setPassengerData={setPassengerData}
            requirements={requirements}
            setRequirements={setRequirements}
            onRequestRide={handleRequestRide}
            isLoading={tripRequestStatus === "loading"}
          />

      

          {/* NEW: Dynamically imported DirectionsModal */}
          {hasHydrated && (
            <DirectionsModal
              isOpen={showDirections}
              onClose={() => setShowDirections(false)}
              pickup={pickup}
              pickupCoords={pickupCoords}
              destination={destination} // NEW
              destinationCoords={destinationCoords} // NEW
            />
          )}

          <PanicModal
            isOpen={showPanic}
            onClose={() => setShowPanic(false)}
            onComplete={() => {
              setShowPanic(false);
              alert("Safety team notified");
            }}
          />

          {!token &&
            showSignup && ( // Ensure it only shows for unauthenticated users
              <SignupPromptModal
                isOpen={showSignup} // Use showSignup state
                passengerData={passengerData}
                onClose={() => setShowSignup(false)} // Close the modal state
                onVerifyEmail={() => setShowOTP(true)} // Keep existing link to OTP
                onRegistrationSuccess={handleRegistrationSuccess} // NEW: Pass success handler
                onOpenLoginModal={() => setShowLogin(true)} // NEW: Pass handler to open login modal
                onSignup={() => {
                  // NEW: Handler for signup button in modal (e.g., navigate to register)
                  setShowSignup(false);
                  // You could navigate to a registration page or open the registration modal here
                  // For now, just close the prompt.
                }}
                onLogin={() => {
                  // NEW: Handler for login button in modal (e.g., open login modal)
                  setShowSignup(false);
                  // You could open a login modal here
                  // For now, just close the prompt.
                }}
                onContinueAsGuest={() => {
                  // NEW: Handler for continue as guest button (e.g., close modal, maybe navigate to dashboard)
                  setShowSignup(false);
                  setScreen("dashboard"); // Example: go to dashboard after trip
                }}
                // NEW: Pass registration success handler
              />
            )}

          <OTPModal
            isOpen={showOTP}
            email={passengerData.email}
            onComplete={() => {
              setTimeout(() => {
                setScreen("dashboard");
                setShowOTP(false);
                setShowSignup(false);
              }, 1000);
            }}
            onClose={() => setShowOTP(false)}
          />

          <ProfileModal
            isOpen={showProfile}
            passengerData={passengerData}
            onClose={() => setShowProfile(false)}
            onLogout={() => {
              // Clear saved state on logout
              if (typeof window !== "undefined" && window.sessionStorage) {
                sessionStorage.removeItem("achrams_app_state");
              }
              window.location.href = "/auth/login";
            }}
          />

          {/* NEW: Trip Request Status Modal */}
          <TripRequestStatusModal
            isOpen={!!tripRequestStatus}
            status={tripRequestStatus}
            message={tripRequestError}
            onClose={() => {setTripRequestStatus(null)
              setScreen("booking")
            }}
            onConfirm={() => {
                if (tripRequestStatus === 'no-driver' || tripRequestStatus === 'error') {
                  // NEW: If status is 'no-driver' or 'error', retry the booking process
                  console.log("Retrying booking process...");
                  setTripRequestStatus(null); // Close the modal first
                  // NEW: Call the main booking function again to restart the flow
                  handleRequestRide();
                } else {
                  // For 'loading' or 'accepted' states, just close the modal
                  setTripRequestStatus(null);
                }}}
          />

          {/* NEW: Driver Verification Modal */}
          <DriverVerificationModal
            isOpen={showDriverVerification}
            securityCode={verificationCode || ""}
            onClose={() => setShowDriverVerification(false)}
          />

          {/* NEW: Login Modal */}
          <LoginModal
            isOpen={showLogin}
            onClose={() => setShowLogin(false)}
            onLoginSuccess={handleLoginSuccess} // NEW: Pass success handler
          />

          {/* NEW: Modals for dashboard features */}
          {showEnable2FA && (
            <Enable2FAModal
              isOpen={showEnable2FA}
              onClose={() => setShowEnable2FA(false)}
              onSuccess={handle2FAEnabled} // NEW: Pass success handler
            />
          )}
          {showDisable2FA && (
            <Disable2FAModal
              isOpen={showDisable2FA}
              onClose={() => setShowDisable2FA(false)}
              onSuccess={handle2FADisabled} // NEW: Pass success handler
            />
          )}
          {showUpdateProfile && (
            <UpdateProfileModal
              isOpen={showUpdateProfile}
              initialData={passengerData} // Pass current data as initial values
              onClose={() => setShowUpdateProfile(false)}
              onSuccess={handleProfileUpdated} // NEW: Pass success handler
            />
          )}

          {/* Future: Uncomment when implemented */}
          <CancelModal
            isOpen={showCancel}
            onClose={() => setShowCancel(false)}
            onConfirm={() => {}}
          />
          {showRate && (
            <RateModal
              isOpen={showRate}
              onClose={() => setShowRate(false)}
              onRate={handleRateSubmit} // Assuming you have a function to handle API call
              driverName={driver?.name}
              // NEW: Pass the notification setter as setNotification
              setNotification={setCurrentNotification} // Use setCurrentNotification
            />
          )}
          <MessageWindowModal
            isOpen={showMessage}
            onClose={() => setShowMessage(false)}
            recipientName={driver?.name || "Driver"}
          />
        </div>
      </div>
      {/* NEW: Bottom Navigation Bar - Rendered only on dashboard screen */}
      {screen === "dashboard" && (
        <BottomNavBar
          onProfileClick={() => setShowProfile(true)}
          walletBalance={walletBalance} // Pass balance for potential icon badge
          onHomeClick={() => setScreen("booking")} // Example: Home click books new trip
          onWalletClick={() => setShowWallet(true)} // NEW: Link wallet click
          onSearchClick={() => setShowTripHistory(true)} // Example: Link search to history
          // Add other handlers for new nav items if needed
        />
      )}
    </>
  );
}


----- FILE: src/app/layout.tsx -----
// src/app/layout.tsx
import type { Metadata } from "next";
import "./globals.css";
import ClientProviders from "@/components/ClientProviders"; // We'll create this

export const metadata: Metadata = {
  title: "ACHRAMS Passenger App",
  description: "Book your airport transfer with ACHRAMS.",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en" suppressHydrationWarning={true}>
      <body className="bg-achrams-background-primary" suppressHydrationWarning={true}>
        <ClientProviders>
          {children}
        </ClientProviders>
      </body>
    </html>
  );
}

----- FILE: src/lib/api.ts -----
// src/lib/api.ts
const API_BASE = 'https://api.achrams.com.ng/v1';

// Define the generic API response structure
interface ApiResponse<T = unknown> {
  status: 'success' | 'error';
  message: string;
   T;
}

const buildHeaders = (token?: string, isGuest = false, guestId?: string) => {
  const headers: Record<string, string> = {
    'Content-Type': 'application/json',
  };
  if (token) {
    headers['Authorization'] = `Bearer ${token}`;
  }
  if (isGuest && guestId) {
    headers['X-Guest-Id'] = guestId;
  }
  return headers;
};

export const apiClient = {
  post: async <T = unknown>(
    endpoint: string,
    data: unknown,
    token?: string,
    guestId?: string
  ): Promise<ApiResponse<T>> => {
    const isGuestRequest = endpoint.includes('/guest-booking') || guestId !== undefined;
    const res = await fetch(`${API_BASE}${endpoint}`, {
      method: 'POST',
      headers: buildHeaders(token, isGuestRequest, guestId),
      body: JSON.stringify(data),
    });

    if (!res.ok) {
      const errorData = await res.json().catch(() => ({ message: 'Network or server error' }));
      console.log(`Data: ${data} \n Result: ${res}`)
      throw new Error(errorData.message || `HTTP error! status: ${res.status}`);
      
    }

    return res.json();
  },

  get: async <T = unknown>(endpoint: string, token?: string, guestId?: string): Promise<ApiResponse<T>> => {
    const isGuestRequest = guestId !== undefined;
    const res = await fetch(`${API_BASE}${endpoint}`, {
      headers: buildHeaders(token, isGuestRequest, guestId),
    });

    if (!res.ok) {
      const errorData = await res.json().catch(() => ({ message: 'Network or server error' }));
      throw new Error(errorData.message || `HTTP error! status: ${res.status}`);
    }

    return res.json();
  },

  patch: async <T = unknown>(endpoint: string, formData: FormData, token?: string): Promise<ApiResponse<T>> => {
    const res = await fetch(`${API_BASE}${endpoint}`, {
      method: 'PATCH',
      headers: {
        Authorization: `Bearer ${token}`, // Token passed in
      },
      body: formData,
    });

    if (!res.ok) {
      const errorData = await res.json().catch(() => ({ message: 'Network or server error' }));
      throw new Error(errorData.message || `HTTP error! status: ${res.status}`);
    }

    return res.json();
  },
};

----- FILE: src/lib/airports.ts -----
// // src/lib/airports.ts
// import { apiClient } from '@/services/apiClient';

// export interface Airport {
//   id: string;
//   name: string;
//   codename: string;
//   map_data: any; // or define GeoJSON type if needed
// }

// // Reverse geocode coords  nearest ACHRAMS airport
// export const findNearestAirport = async (
//   longitude: number,
//   latitude: number
// ): Promise<Airport | null> => {
//   try {
//     const response = await apiClient.get(`/v1/airports/by-location/?lon=${longitude}&lat=${latitude}`);
//     if (response.data?.data?.length > 0) {
//       return response.data.data[0]; // assume first is nearest
//     }
//     return null;
//   } catch (err) {
//     console.error('Failed to find airport by location:', err);
//     return null;
//   }
// };

// // Map known airport name  UUID (for when user selects from list)
// export const KNOWN_AIRPORTS: Record<string, string> = {
//   'Murtala Muhammed Int\'l Airport (LOS)': '0199de42-10b4-7f53-b670-42f107897a1d',
//   // Add others as needed from /choices or /airports list
// };


// src/lib/airports.ts
import { apiClient } from '@/services/apiClient';

export interface Airport {
  id: string;
  name: string;
  codename: string;
  map_data: any; // or define GeoJSON type if needed
  is_active: boolean; // Add this based on the API response structure
}

// Reverse geocode coords  nearest ACHRAMS airport(s)
// Returns an array of airports found, or null if none or on error.
export const findNearestAirport = async (
  longitude: number,
  latitude: number
): Promise<Airport[] | null> => {
  try {
    const response = await apiClient.get(`/v1/airports/by-location/?lon=${longitude}&lat=${latitude}`);
    console.log("API Response for airports by location:", response); // Optional: For debugging
    if (response.data?.data && Array.isArray(response.data.data) && response.data.data.length > 0) {
      return response.data.data; // Return the full array of airports
    }
    console.log("No airports found near coordinates:", longitude, latitude); // Optional: For debugging
    return null;
  } catch (err) {
    console.error('Failed to find airport by location:', err);
    return null;
  }
};

// Map known airport name  UUID (for when user selects from list)
export const KNOWN_AIRPORTS: Record<string, string> = {
  'Murtala Muhammed Int\'l Airport (LOS)': '0199de42-10b4-7f53-b670-42f107897a1d',
  // Add others as needed from /choices or /airports list
};

----- FILE: src/services/apiClient.ts -----
// src/services/apiClient.ts
import axios, { AxiosRequestConfig } from 'axios';

// NEW: Create an axios instance
const apiClient = axios.create({
  baseURL: 'https://api.achrams.com.ng', // NEW: Use the correct base URL from passenger postman DOC.txt
  timeout: 10000, // 10 seconds timeout
  headers: {
    'Content-Type': 'application/json',
  },
});

// NEW: Request interceptor to add Bearer token if available
apiClient.interceptors.request.use(
  (config) => {
    // NEW: Get token from where you store it (e.g., localStorage, cookie via httpOnly)
    // For this example, assuming it's in localStorage under 'auth_token'
    // For better security, consider storing the token in an httpOnly cookie.
    const token = typeof window !== 'undefined' ? localStorage.getItem('auth_token') : null;
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
  },
  (error) => {
    return Promise.reject(error);
  }
);

// NEW: Response interceptor (optional, for handling errors globally)
apiClient.interceptors.response.use(
  (response) => response,
  (error) => {
    // Handle specific status codes (e.g., 401 for unauthorized)
    if (error.response?.status === 401) {
      // NEW: Clear token and potentially redirect
      if (typeof window !== 'undefined') {
          localStorage.removeItem('auth_token');
      }
      // Dispatch an action to update auth state if using a global state manager
      // Or use router.push('/auth/login') if using Next.js router
      // window.location.href = '/auth/login'; // Or dispatch an action to update auth state
    }
    return Promise.reject(error);
  }
);

export default apiClient;
// Export the instance to be used in components
export { apiClient };

----- FILE: src/hooks/useAuth.ts -----
// src/hooks/useAuth.ts
import { useState, useEffect } from 'react';

const TOKEN_KEY = 'achrams_passenger_token';

export const useAuth = () => {
  const [token, setToken] = useState<string | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const stored = typeof window !== 'undefined' ? localStorage.getItem(TOKEN_KEY) : null;
    if (stored) setToken(stored);
    setLoading(false);
  }, []);

  const login = (newToken: string) => {
    localStorage.setItem(TOKEN_KEY, newToken);
    setToken(newToken);
  };

  const logout = () => {
    localStorage.removeItem(TOKEN_KEY);
    setToken(null);
  };

  return { token, login, logout, isLoading: loading };
};

----- FILE: src/hooks/useGeolocation.ts -----
// src/hooks/useGeolocation.ts
import { useState, useRef, useCallback } from 'react';

export interface GeolocationCoordinates {
  latitude: number;
  longitude: number;
}

export interface GeolocationResult {
  coords: GeolocationCoordinates | null;
  error: string | null;
  loading: boolean;
  requestPermission: () => Promise<GeolocationCoordinates | null>;
}

export const useGeolocation = (): GeolocationResult => {
  const [coords, setCoords] = useState<GeolocationCoordinates | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [loading, setLoading] = useState<boolean>(false);
  
  // Prevent multiple simultaneous requests
  const requestInProgress = useRef<boolean>(false);
  const pendingRequest = useRef<Promise<GeolocationCoordinates | null> | null>(null);

  /**
   * Fallback to IP-based geolocation
   */
  const getIPBasedLocation = async (): Promise<GeolocationCoordinates | null> => {
    try {
      console.log('Attempting IP-based location fallback...');
      
      const response = await fetch('https://ipapi.co/json/', {
        signal: AbortSignal.timeout(5000), // 5 second timeout
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      
      const data = await response.json();
      
      // Validate coordinates
      if (
        typeof data.latitude === 'number' &&
        typeof data.longitude === 'number' &&
        !isNaN(data.latitude) &&
        !isNaN(data.longitude)
      ) {
        console.log('IP-based location obtained:', data.latitude, data.longitude);
        return {
          latitude: data.latitude,
          longitude: data.longitude,
        };
      }
      
      throw new Error('Invalid coordinates from IP service');
    } catch (err: any) {
      console.error('IP-based location failed:', err.message);
      return null;
    }
  };

  const requestPermission = useCallback((): Promise<GeolocationCoordinates | null> => {
    // If a request is already in progress, return the existing promise
    if (requestInProgress.current && pendingRequest.current) {
      console.log('Location request already in progress');
      return pendingRequest.current;
    }

    requestInProgress.current = true;
    setLoading(true);
    setError(null);

    const promise = new Promise<GeolocationCoordinates | null>(async (resolve) => {
      // Check browser support
      if (!navigator.geolocation) {
        console.warn('Geolocation not supported, trying IP fallback...');
        const ipLocation = await getIPBasedLocation();
        
        if (ipLocation) {
          setCoords(ipLocation);
          setError(null);
          resolve(ipLocation);
        } else {
          const errorMsg = 'Geolocation is not supported and IP fallback failed.';
          setError(errorMsg);
          setCoords(null);
          resolve(null);
        }
        
        setLoading(false);
        requestInProgress.current = false;
        pendingRequest.current = null;
        return;
      }

      let hasResolved = false;

      const handleSuccess = (position: GeolocationPosition) => {
        if (hasResolved) return;
        hasResolved = true;

        const { latitude, longitude } = position.coords;
        const newCoords = { latitude, longitude };
        
        setCoords(newCoords);
        setError(null);
        setLoading(false);
        requestInProgress.current = false;
        pendingRequest.current = null;
        
        console.log('GPS location obtained:', newCoords);
        resolve(newCoords);
      };

      const handleError = async (err: GeolocationPositionError) => {
        if (hasResolved) return;
        hasResolved = true;

        console.warn('GPS location failed, trying IP fallback...', err.message);
        
        // Try IP-based fallback
        const ipLocation = await getIPBasedLocation();
        
        if (ipLocation) {
          setCoords(ipLocation);
          setError(null);
          resolve(ipLocation);
        } else {
          let message = 'Unable to retrieve your location.';
          
          switch (err.code) {
            case 1:
              message = 'Location access denied.';
              break;
            case 2:
              message = 'Location unavailable.';
              break;
            case 3:
              message = 'Location request timed out.';
              break;
          }
          
          setError(message);
          setCoords(null);
          resolve(null);
        }

        setLoading(false);
        requestInProgress.current = false;
        pendingRequest.current = null;
      };

      // Request GPS location
      navigator.geolocation.getCurrentPosition(
        handleSuccess,
        handleError,
        {
          enableHighAccuracy: true,
          timeout: 15000,
          maximumAge: 5000,
        }
      );
    });

    pendingRequest.current = promise;
    return promise;
  }, []);

  return { coords, error, loading, requestPermission };
};



// // src/hooks/useGeolocation.ts
// import { useState, useEffect } from 'react';

// export interface GeolocationCoordinates {
//   latitude: number;
//   longitude: number;
// }

// export interface GeolocationResult {
//   coords: GeolocationCoordinates | null;
//   error: string | null;
//   loading: boolean; 
//   requestPermission: () => Promise<GeolocationCoordinates | null>;
// }

// export const useGeolocation = (): GeolocationResult => {
//   const [coords, setCoords] = useState<GeolocationCoordinates | null>(null);
//   const [error, setError] = useState<string | null>(null);
//   const [loading, setLoading] = useState<boolean>(false); 

//   const requestPermission = (): Promise<GeolocationCoordinates | null> => {
  
//     return new Promise((resolve, reject) => {
//       if (!navigator.geolocation) {
//         const errorMsg = 'Geolocation is not supported by this browser.';
//         setError(errorMsg);
//         setLoading(false); 
//         reject(errorMsg);
//         return;
//       }

      
//       setLoading(true);
//       setError(null); 
//       setCoords(null); 

//       navigator.geolocation.getCurrentPosition(
//         (position) => {
          
//           const { latitude, longitude } = position.coords;
//           const newCoords = { latitude, longitude };
//           setCoords(newCoords);
//           setError(null); 
//           setLoading(false); 
//           resolve(newCoords); 
//         },
//         (err) => {
         
//           let message = 'Unable to retrieve your location.';
//           if (err.code === 1) message = 'Location access denied.';
//           else if (err.code === 2) message = 'Location unavailable.';
//           else if (err.code === 3) message = 'Location request timed out.';

//           setError(message);
//           setLoading(false); 
//           console.error("Geolocation error:", message); 
//           reject(message); 
//         },
//         {
//           enableHighAccuracy: true,
//           timeout: 10000,
//           maximumAge: 0,
//         }
//       );
//     });
//   };

  
//   return { coords, error, loading, requestPermission };
// };

----- FILE: src/contexts/AuthContext.tsx -----
'use client';

import { createContext, useContext, useState, useEffect, ReactNode, useCallback } from 'react';
import { apiClient } from '@/lib/api';

interface AuthContextType {
  user: any | null;
  token: string | null; // Potentially still useful if the backend also returns a token alongside the cookie
  isAuthenticated: boolean;
  isLoading: boolean;
  login: (email: string, password: string) => Promise<boolean>;
  logout: () => void;
  checkAuthStatus: () => Promise<void>;
}

const AuthContext = createContext<AuthContextType | undefined>(undefined);

export const AuthProvider = ({ children }: { children: ReactNode }) => {
  const [user, setUser] = useState<any | null>(null);
  const [token, setToken] = useState<string | null>(null); // Store token if backend provides one
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [isLoading, setIsLoading] = useState(true);


interface LoginResult {
  success: boolean;
  requires2FA?: boolean;
  message?: string; // Add an optional message field for errors
}



  
    
  const checkAuthStatus = async () => {
    console.log("AuthContext: Checking authentication status via API call to /auth/passenger/authenticated...");
    // setIsLoading(true); // Don't set loading here if login function already handles it, or manage carefully to avoid conflicts
    try {
      // Call the authenticated check API using apiClient, indicating it's an auth request relying on cookies
      const response = await apiClient.get('/auth/passenger/authenticated', undefined, false, undefined, true); // isAuthRequest = true

      if (response.status === 'success') {
        console.log("AuthContext: Authentication verified via API call. User is logged in.");
        setIsAuthenticated(true);
        // Optional: Fetch user details here if needed, or rely on initial state from login
        // setUser(response.data.user);
        // setToken(response.data.token); // Store if returned
      } else {
        console.log("AuthContext: API responded with non-success status during auth check (likely 401). User is not authenticated.", response);
        setIsAuthenticated(false);
        setUser(null);
        setToken(null);
      }
    } catch (err: any) {
      console.error("AuthContext: Error checking authentication status via API call:", err);
      // Consider the user unauthenticated on error
      setIsAuthenticated(false);
      setUser(null);
      setToken(null);
    } finally {
      setIsLoading(false); // Stop loading state after auth check completes
    }
  };

  // const login = async (email: string, password: string): Promise<boolean> => {
  //   console.log("AuthContext: Attempting login for user:", email);
  //   setIsLoading(true); // Set loading state at the start of login
  //   try {
  //     // Call the login API using apiClient
  //     const loginResponse = await apiClient.post('/auth/passenger/login', {
  //       email,
  //       password,
  //     }, undefined, undefined, true);

  //     console.log("AuthContext: Login API Response:", loginResponse);

  //     if (loginResponse.status === 'success' && loginResponse.data && loginResponse.data.token) {
  //       console.log("AuthContext: Login successful via API call. Token received (though cookie is primary auth).");
  //       // Store the token if the backend returns one (might be for other purposes)
  //       // setToken(loginResponse.data.token);
  //       // The backend should have set the httpOnly cookie here.
  //       // Now, check the auth status using the cookie to update context state.
  //       await new Promise(resolve => setTimeout(resolve, 500));
  //       await checkAuthStatus(); // This will call the authenticated endpoint and update context
  //       return true; // Indicate success
  //     } else {

        
  //       console.error("AuthContext: Login API responded with non-success status or missing token/data:", loginResponse);
  //       setIsLoading(false); // Ensure loading is stopped on failure
  //       return false; // Indicate failure
  //     }
  //   } catch (err: any) {
  //     console.error("AuthContext: Error during login API call:", err);
  //     setIsLoading(false); // Ensure loading is stopped on error
  //     return false; // Indicate failure
  //   }
  //   // Note: The loading state is managed by setIsLoading in this function and the checkAuthStatus function called within.
  //   // Be careful not to conflict with the initial useEffect loading state.
  // };

  const login = async (email: string, password: string): Promise<LoginResult> => { // Change return type to Promise<LoginResult>
  console.log("AuthContext: Attempting login for user:", email);
  setIsLoading(true);
  try {
    const loginResponse = await apiClient.post('/auth/passenger/login', {
      email,
      password,
    }, undefined, undefined, true);

    console.log("AuthContext: Login API Response:", loginResponse);

    if (loginResponse.status === 'success' && loginResponse.data && loginResponse.data.token) {
      console.log("AuthContext: Login successful via API call. Token received (though cookie is primary auth).");
      await new Promise(resolve => setTimeout(resolve, 500));
      await checkAuthStatus();
      return { success: true }; // Return success object
    } else if(loginResponse.status === 'success' && loginResponse.data?.two_factor === true){
      console.log("Authcontext: login successful, but 2FA verification is required");
      setIsLoading(false);
      return {success: true, requires2FA: true};
    }
    
    else {
      // NEW: Extract error message from API response
      let errorMessage = "Login failed. Please try again."; // Default message
      if (loginResponse.message) {
          errorMessage = loginResponse.message; // Use top-level message if available
      } 
      
      if (loginResponse.details && loginResponse.details.non_field_errors && Array.isArray(loginResponse.details.non_field_errors)) {
          // Attempt to get the first specific error from details
          const specificError = loginResponse.details.non_field_errors[0];
          if (specificError) {
              errorMessage = specificError;
          }
      }
      // NEW: Use the extracted or default error message
      console.error("AuthContext: Login API responded with non-success status or missing token/data:", loginResponse);
      setIsLoading(false);
      // Do NOT call showNotification here, let the caller (page.tsx) handle it
      return { success: false, message: errorMessage }; // Return failure object with message
    }
  } catch (err: any) {
    console.error("AuthContext: Error during login API call:", err);
    setIsLoading(false);
    // NEW: Provide a generic error message for network/other errors
    return { success: false, message: "An error occurred during login. Please check your connection." };
  }
};
  const logout = async () => {
    console.log("AuthContext: Attempting logout...");
    try {
      // If there's a backend logout endpoint, call it.
      // await apiClient.post('/auth/logout', {}, token, undefined, true); // Example, if needed
      console.log("AuthContext: Logout request sent (or session assumed invalidated by server). Clearing frontend state.");
      // Clear context state
      setUser(null);
      setToken(null);
      setIsAuthenticated(false);
    } catch (err) {
      console.error("AuthContext: Error during logout API call:", err);
      // Clear frontend state anyway on error
      setUser(null);
      setToken(null);
      setIsAuthenticated(false);
    }
  };

  // Effect to check auth status on initial load
  useEffect(() => {
    console.log("AuthContext: Initializing - Checking authentication status...");
    checkAuthStatus(); // Initial check on mount
  }, []); // Empty dependency array means this runs once on mount

  const contextValue: AuthContextType = {
    user,
    token,
    isAuthenticated,
    isLoading,
    login,
    logout,
    checkAuthStatus,
  };

  return (
    <AuthContext.Provider value={contextValue}>
      {children}
    </AuthContext.Provider>
  );
};

export const useAuth = () => {
  const context = useContext(AuthContext);
  if (context === undefined) {
    throw new Error('useAuth must be used within an AuthProvider');
  }
  return context;
};



// 'use client';

// import { createContext, useContext, useState, useEffect, ReactNode } from 'react';

// import { apiClient } from '@/lib/api';


// interface AuthContextType {
//   user: any | null; 
//   token: string | null; 
//   isAuthenticated: boolean;
//   isLoading: boolean; 
//   login: (email: string, password: string) => Promise<boolean>; 
//   logout: () => void; 
//   checkAuthStatus: () => Promise<void>; 
// }


// const AuthContext = createContext<AuthContextType | undefined>(undefined);


// export const AuthProvider = ({ children }: { children: ReactNode }) => {
//   const [user, setUser] = useState<any | null>(null); 
//   const [token, setToken] = useState<string | null>(null); 
//   const [isAuthenticated, setIsAuthenticated] = useState(false); 
//   const [isLoading, setIsLoading] = useState(true); 
//   const [count, setCount] = useState(0);
  
//   const checkAuthStatus = async () => {
//     console.log("Checking authentication status via API call to /auth/passenger/authenticated...");
//     setIsLoading(true); 
//     try {
      
      
//       const response = await apiClient.get('/auth/passenger/authenticated', undefined, false, undefined, true); 

//       if (response.status === 'success') {
//         console.log("Authentication verified via API call. User is logged in.");
        
//         setIsAuthenticated(true);
        
//       } else {
        
//         console.log("API responded with non-success status during auth check (likely 401). User is not authenticated.", response);
//         setIsAuthenticated(false);
//         setUser(null);
//         setToken(null); 
//       }
//     } catch (err) {
      
//       console.error("Error checking authentication status via API call:", err);
      
//       setIsAuthenticated(false);
//       setUser(null);
//       setToken(null); 
//     } finally {
      
//       setIsLoading(false);
//     }
//   };

  
//   const login = async (email: string, password: string): Promise<boolean> => {
//     console.log("Attempting login for user with email:", email);
//     try {
      
      
//       const loginResponse = await apiClient.post('/auth/passenger/login', {
//         email,
//         password,
        
//       });

//       if (loginResponse.status === 'success' && loginResponse.data && loginResponse.data.token) {
        
//         console.log("Login successful via API call. Token received (though cookie is primary auth).");

//         setCount((prev) => prev + 1)
//         await checkAuthStatus(); 
//         console.log(`Login attempt number ${count} made`);
//         return true; 
//       } else {
        
//         console.error("Login API responded with non-success status or missing token/data:", loginResponse);
        
//         return false; 
//       }
//     } catch (err) {
      
//       console.error("Error during login API call:", err);
//       return false; 
//     }
//   };

  
//   const logout = async () => {
//     console.log("Attempting logout...");
//     try {
      
//       console.log("Logout request sent (or session assumed invalidated). Clearing frontend state.");
      
//       setUser(null);
//       setToken(null);
//       setIsAuthenticated(false)

//     } catch (err) {
      
//       console.error("Error during logout API call:", err);
      
      
//       setUser(null);
//       setToken(null);
//       setIsAuthenticated(false);
//     }
//   };

  
//   useEffect(() => {
//     console.log("AuthContext: Initializing - Checking authentication status...");
    
//     checkAuthStatus();
//   }, []); 

  
//   const contextValue: AuthContextType = {
//     user,
//     token,
//     isAuthenticated,
//     isLoading, 
//     login, 
//     logout, 
//     checkAuthStatus, 
//   };

//   return (
//     <AuthContext.Provider value={contextValue}>
//       {children}
//     </AuthContext.Provider>
//   );
// };


// export const useAuth = () => {
//   const context = useContext(AuthContext);
//   if (context === undefined) {
//     throw new Error('useAuth must be used within an AuthProvider');
//   }
//   return context;
// };






























----- FILE: src/types/passenger.ts -----
// src/types/passenger.ts

export interface Passenger {
  id: string;
  name: string;
  initials: string;
  email: string;
  first_name: string;
  last_name: string;
  phone_number: string;
  profile_photo?: string;
  is_2fa_enabled: boolean;
  verified_at?: string;
  last_login?: string;
  created_at: string;
  updated_at: string;
  profile: {
    status: { label: string; value: string };
    wallet: {
      balance: {
        formatted: string;
        currency: string;
        amount: number;
      };
    };
    active_trip: Trip | null;
  };
}


export interface PassengerAccount {
  id: string;
  first_name: string;
  last_name: string;
  email: string;
  phone_number: string;
  is_2fa_enabled: boolean;
  profile?: {
    wallet?: {
      balance: {
        formatted: string;
        amount: number;
        currency: string;
      };
    };
  };
}


export interface Trip {
  id: string;
  amount: Money;
  status: Status;
  pickup_address: string;
  destination_address: string;
  verification_code: string;
  rating: Rating | null;
  map_ MapData;
  driver: Driver | null;
  guest?: Guest;
}

export interface Money {
  formatted: string;
  currency: string;
  amount: number;
}

export interface Status {
  label: string;
  value: string;
}

export interface Rating {
  score: number;
  comment: string;
}

export interface MapData {
  pickup_location: GeoFeature;
  destination_location: GeoFeature;
}

export interface GeoFeature {
  type: 'Feature';
  geometry: {
    type: 'Point';
    coordinates: [number, number]; // [longitude, latitude]
  };
  properties: {
    name: string;
    description: string;
  };
}

export interface Driver {
  id: string;
  name: string;
  details: {
    
    car_type: string;
    car_color: string;
    car_photo?: string;
    plate_number: string;
  }
  profile_photo?: string;
  has_extra_leg_room: boolean;
  has_extra_trunk_space: boolean;
  has_wheel_chair_access: boolean;
  rating: string;
}

export interface Guest {
  id: string;
  name: string;
  email: string;
  phone_number: string;
  expires_at: string;
  url: string;
}

export interface AuthResponse {
  token: string;
}

export interface ApiResponse<T = unknown> {
  status: 'success' | 'error';
  message: string;
   T;
}

----- FILE: src/components/ClientProviders.tsx -----
// src/components/ClientProviders.tsx
'use client';

import { AuthProvider } from '@/contexts/AuthContext';
import QueryProvider from './QueryProvider'; // Assume this exists

interface ClientProvidersProps {
  children: React.ReactNode;
}

export default function ClientProviders({ children }: ClientProvidersProps) {
  return (
    <AuthProvider>
      <QueryProvider>
        {children}
      </QueryProvider>
    </AuthProvider>
  );
}

----- FILE: src/components/ui/Input.tsx -----
// src/components/ui/Input.tsx
import { InputHTMLAttributes } from 'react';
import { twMerge } from 'tailwind-merge';

interface InputProps extends InputHTMLAttributes<HTMLInputElement> {
  label?: string;
  error?: string;
  icon?: React.ReactNode;
}

const Input: React.FC<InputProps> = ({
  label,
  error,
  icon,
  className,
  ...props
}) => {
  const containerClasses = twMerge(
    'w-full',
    className
  );

  const inputClasses = twMerge(
    'w-full pl-10 pr-4 py-3 bg-achrams-background-card rounded-xl border border-achrams-border focus:outline-none focus:ring-2 focus:ring-achrams-primary-solid',
    error ? 'border-red-500 focus:ring-red-500' : '',
    icon ? 'pl-10' : 'pl-4'
  );

  return (
    <div className={containerClasses}>
      {label && <label className="block text-sm font-medium text-achrams-text-primary mb-1">{label}</label>}
      <div className="relative">
        {icon && <div className="absolute left-3 top-1/2 transform -translate-y-1/2 text-achrams-text-secondary">{icon}</div>}
        <input
          className={inputClasses}
          {...props}
        />
      </div>
      {error && <p className="mt-1 text-sm text-red-600">{error}</p>}
    </div>
  );
};

export default Input;

----- FILE: src/components/ui/OTPInput.tsx -----
// src/components/ui/OTPInput.tsx
import React, { useState, useRef, useEffect } from 'react';
import { twMerge } from 'tailwind-merge';

interface OTPInputProps {
  length?: number;
  onChange: (otp: string) => void;
  onComplete?: (otp: string) => void;
  autoFocus?: boolean;
  containerClassName?: string;
  inputClassName?: string;
  error?: string; // Add error prop
}

const OTPInput: React.FC<OTPInputProps> = ({
  length = 5,
  onChange,
  onComplete,
  autoFocus = true,
  containerClassName,
  inputClassName,
  error,
}) => {
  const [otp, setOtp] = useState<string[]>(Array(length).fill(''));
  const inputRefs = useRef<Array<HTMLInputElement | null>>([]);

  useEffect(() => {
    if (autoFocus && inputRefs.current[0]) {
      inputRefs.current[0]?.focus();
    }
  }, [autoFocus]);

  const handleChange = (index: number, value: string) => {
    if (/^\d*$/.test(value) && value.length <= 1) {
      const newOtp = [...otp];
      newOtp[index] = value;
      setOtp(newOtp);

      onChange(newOtp.join(''));

      // Auto-focus next input
      if (value && index < length - 1) {
        inputRefs.current[index + 1]?.focus();
      }

      // Auto-submit if all filled
      const allFilled = newOtp.every(digit => digit !== '');
      if (allFilled && newOtp.join('').length === length) {
        onComplete?.(newOtp.join(''));
      }
    }
  };

  const handleKeyDown = (index: number, e: React.KeyboardEvent<HTMLInputElement>) => {
    // Allow backspace to clear current and move to previous
    if (e.key === 'Backspace' && !otp[index] && index > 0) {
      inputRefs.current[index - 1]?.focus();
    }
  };

  const containerClasses = twMerge(
    'flex gap-3 justify-center bg-achrams-secondary-solid/50 ',
    containerClassName
  );

  const inputClasses = twMerge(
    'w-14 h-14 text-center text-2xl font-bold border-2 border-achrams-border rounded-xl focus:outline-none focus:ring-2 focus:ring-achrams-primary-solid bg-achrams-background-card',
    error ? 'border-red-500 focus:ring-red-500' : 'focus:border-achrams-primary-solid',
    inputClassName
  );

  return (
    <div className={containerClasses}>
      {otp.map((digit, index) => (
        <input
          key={index}
          ref={(el) => (inputRefs.current[index] = el)}
          type="text"
          inputMode="numeric"
          maxLength={1}
          value={digit}
          onChange={(e) => handleChange(index, e.target.value)}
          onKeyDown={(e) => handleKeyDown(index, e)}
          className={inputClasses}
        />
      ))}
      {error && <p className="mt-2 text-sm text-red-600 w-full text-center">{error}</p>}
    </div>
  );
};

export default OTPInput;

----- FILE: src/components/ui/ACHRAMSHeader.tsx -----
import React from 'react';
import { X } from 'lucide-react';
import { twMerge } from 'tailwind-merge';
import Image from "next/image"

interface ACHRAMSHeaderProps {
  title: string;
  showBackButton?: boolean;
  onBackClick?: () => void;
  showLogo?: boolean; // New prop to control logo visibility
  className?: string;
}

const ACHRAMSHeader: React.FC<ACHRAMSHeaderProps> = ({
  title,
  showBackButton = false,
  onBackClick,
  showLogo = true, // Default to true to maintain existing behavior on other screens
  className = "",
}) => {
  return (
    <div
      className={twMerge(
        " text-achrams-text-light  flex items-center gap-4 ",
        className
      )}
    >
      {/* Conditionally render the Logo Container */}
      {showLogo && (<>
        <div className="max-w-7xl mx-auto">
  <div className="flex items-center h-20 space-x-3">
    {/* Logo Box */}
    <div className="w-12 h-12 bg-achrams-gradient-primary rounded-xl flex items-center justify-center shadow-lg">
      <Image
        src="/images/logo.png"
        alt="ACHRAMS Logo"
        width={25}
        height={25}
        className="object-contain"
      />
    </div>

    {/* Title + Subtitle */}
    <div className="text-left flex flex-col items-start">
      <h1 className="text-2xl font-bold text-white ">
        ACHRAMS
      </h1>
      {/* text-achrams-primary-solid */}
      <p className="text-xs text-gray-300">
        Official Airport Car Hire
      </p>
    </div>
  </div>
</div>


      
      </>
      )}

      {showBackButton && (
        <button
          onClick={onBackClick}
          aria-label="Go back"
          className="p-1" // Add padding for touch target size
        >
          <X className="w-6 h-6" />
        </button>
      )}
      <h2 className="text-lg font-bold flex-1 text-center">
        {title}
      </h2>
    </div>
  );
};

export default ACHRAMSHeader;

----- FILE: src/components/ui/Button.tsx -----
// src/components/ui/Button.tsx
import { ButtonHTMLAttributes } from 'react';
import { twMerge } from 'tailwind-merge';

interface ButtonProps extends ButtonHTMLAttributes<HTMLButtonElement> {
  variant?: 'primary' | 'secondary' | 'outline' | 'ghost';
  size?: 'sm' | 'md' | 'lg';
  isLoading?: boolean;
}

const Button: React.FC<ButtonProps> = ({
  children,
  className,
  variant = 'primary',
  size = 'md',
  isLoading = false,
  disabled,
  ...props
}) => {
  const baseClasses = 'font-semibold rounded-xl transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2';
  const sizeClasses = {
    sm: 'text-xs py-2 px-4',
    md: 'text-sm py-3 px-6',
    lg: 'text-base py-4 px-8',
  };
  const variantClasses = {
    primary: 'bg-achrams-gradient-primary text-achrams-text-light hover:opacity-90 focus:ring-achrams-primary-solid',
    secondary: 'bg-achrams-secondary-solid text-achrams-text-light hover:bg-opacity-90 focus:ring-achrams-secondary-solid',
    outline: 'border border-achrams-border text-achrams-text-primary bg-transparent hover:bg-achrams-background-secondary focus:ring-achrams-border',
    ghost: 'text-achrams-text-primary hover:bg-achrams-background-secondary focus:ring-achrams-border',
  };

  const disabledClasses = disabled || isLoading ? 'opacity-60 cursor-not-allowed' : '';

  const classes = twMerge(
    baseClasses,
    sizeClasses[size],
    variantClasses[variant],
    disabledClasses,
    className
  );

  return (
    <button
      className={classes}
      disabled={disabled || isLoading}
      {...props}
    >
      {isLoading ? (
        <span className="flex items-center justify-center">
          <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-current" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          Loading...
        </span>
      ) : (
        children
      )}
    </button>
  );
};

export default Button;

----- FILE: src/components/QueryProvider.tsx -----
// src/components/QueryProvider.tsx
"use client"; // This marks the entire file as a Client Component

import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import { ReactNode, useState } from "react";

const QueryProvider = ({ children }: { children: ReactNode }) => {
  // Use useState to create the QueryClient instance only on the client side
  const [queryClient] = useState(
    () =>
      new QueryClient({
        defaultOptions: {
          queries: {
            staleTime: 5 * 60 * 1000, // 5 minutes
          },
        },
      })
  );

  return (
    <QueryClientProvider client={queryClient}>
      {children}
    </QueryClientProvider>
  );
};

export default QueryProvider;

----- FILE: src/components/icons/GoogleColor.tsx -----
export default function GoogleIconColor({ size = 24 }) {
  return (
    <svg
      width={size}
      height={size}
      viewBox="0 0 533.5 544.3"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path fill="#4285F4" d="M533.5 278.4c0-18.6-1.5-37.3-4.8-55.6H272v105.2h147.7c-6.4 35.6-26.1 65.7-55.3 85.9l89.3 69.2c52-48 82-118.6 82-204.7z"/>
      <path fill="#34A853" d="M272 544.3c74.7 0 137.4-24.7 183.1-67.2l-89.3-69.2c-24.8 16.8-56.6 26.6-93.8 26.6-72.2 0-133.4-48.8-155.3-114.2H25.8v71.9c45.8 90.8 139.3 152.1 246.2 152.1z"/>
      <path fill="#FBBC05" d="M116.7 320.3c-5.8-17.3-9-35.7-9-54.3s3.2-37 9-54.3V139.8H25.8C9.3 174.6 0 214.4 0 266c0 51.6 9.3 91.4 25.8 126.2l90.9-71.9z"/>
      <path fill="#EA4335" d="M272 107.1c40.7 0 77.3 14 106 41.4l79.3-79.3C409.3 24.7 346.6 0 272 0 165.1 0 71.6 61.3 25.8 152.1l90.9 71.9C138.6 155.9 199.8 107.1 272 107.1z"/>
    </svg>
  );
}


----- FILE: src/components/app/modals/UpdateProfileModal.tsx -----
// src/components/app/modals/UpdateProfileModal.tsx
import { X, User, Mail, Phone, Globe, Loader } from 'lucide-react';
import { useState, useEffect } from 'react';
import { apiClient } from '@/services/apiClient'; // Assuming you create this service

interface UpdateProfileModalProps {
  isOpen: boolean;
  initialData: { name: string; email: string; phone: string; preferred_language: string }; // NEW: Pass initial data
  onClose: () => void;
  onSuccess: (updatedData: any) => void; // NEW: Callback after successful update
}

export default function UpdateProfileModal({
  isOpen,
  initialData,
  onClose,
  onSuccess,
}: UpdateProfileModalProps) {
  if (!isOpen) return null;

  // NEW: State for form data, loading, error
  const [formData, setFormData] = useState(initialData); // NEW: Initialize with initial data
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  // NEW: Reset form when initialData changes (e.g., if modal is reused)
  useEffect(() => {
    if (isOpen) {
        setFormData(initialData);
        setError('');
    }
  }, [initialData, isOpen]);


  const handleChange = (field: keyof typeof formData, value: string) => {
    setFormData(prev => ({ ...prev, [field]: value }));
  };

  const handleSubmit = async () => {
    setError(''); // Clear previous errors
    // Basic validation can be added here if needed

    setLoading(true);
    try {
      // NEW: Call the update profile API using apiClient
      // Use PATCH /auth/passenger/me as per Postman doc
      const response = await apiClient.patch('/auth/passenger/me', formData);

      console.log("Profile Update Response:", response); // Debug log
      if (response.status === 200 && response.data && response.data.data) { // Assuming 200 for success
        // NEW: On success, close modal and trigger success handler with updated data
        onClose();
        onSuccess(response.data.data); // Pass the updated user data back
      } else {
          setError('Failed to update profile. Please try again.');
      }
    } catch (err: any) {
        console.error("Profile Update Error:", err);
        let errorMessage = 'An unexpected error occurred.';
        if (err.response && err.response.data && err.response.data.message) {
            errorMessage = err.response.data.message;
        } else if (err.message) {
            errorMessage = err.message;
        }
        setError(errorMessage);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 bg-opacity-70 flex items-end z-50">
      <div className="bg-achrams-bg-primary w-full max-w-sm mx-auto rounded-t-3xl p-6 animate-slideUp max-h-[85vh] overflow-y-auto border-t border-achrams-border">
        <div className="flex justify-between items-center mb-6">
          <h3 className="text-xl font-bold text-achrams-text-primary">Edit Profile</h3>
          <button
            onClick={onClose}
            disabled={loading} // NEW: Disable close button while loading
            className="text-achrams-text-secondary hover:text-achrams-text-primary transition-colors disabled:opacity-50"
          >
            <X className="w-6 h-6" />
          </button>
        </div>

        <div className="space-y-4 mb-6">
          <div className="relative">
            <User className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-achrams-text-secondary" />
            <input
              type="text"
              placeholder="Full name"
              value={formData.name}
              onChange={(e) => handleChange('name', e.target.value)}
              disabled={loading} // NEW: Disable input while loading
              className="w-full pl-10 pr-4 py-4 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border border-achrams-border"
            />
          </div>
          <div className="relative">
            <Mail className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-achrams-text-secondary" />
            <input
              type="email"
              placeholder="Email"
              value={formData.email}
              onChange={(e) => handleChange('email', e.target.value)}
              disabled={loading} // NEW: Disable input while loading
              className="w-full pl-10 pr-4 py-4 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border border-achrams-border"
            />
          </div>
          <div className="relative">
            <Phone className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-achrams-text-secondary" />
            <input
              type="tel"
              placeholder="Phone number"
              value={formData.phone}
              onChange={(e) => handleChange('phone', e.target.value)} // NEW: Handle phone change
              disabled={loading} // NEW: Disable input while loading
              className="w-full pl-10 pr-4 py-4 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border border-achrams-border"
            />
          </div>
          <div className="relative">
            <Globe className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-achrams-text-secondary" />
            <select // NEW: Use select for language
              value={formData.preferred_language}
              onChange={(e) => handleChange('preferred_language', e.target.value)}
              disabled={loading} // NEW: Disable input while loading
              className="w-full pl-10 pr-4 py-4 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border border-achrams-border appearance-none"
            >
              <option value="en">English</option>
              <option value="es">Spanish</option>
              <option value="fr">French</option>
              {/* Add more options as needed based on API support */}
            </select>
          </div>
        </div>

        {/* NEW: Error Message Display */}
        {error && (
          <p className="text-red-500 text-sm mb-4">{error}</p>
        )}

        <button
          onClick={handleSubmit}
          disabled={loading} // NEW: Disable based on loading
          className={`w-full py-4 rounded-xl font-semibold mb-3 transition-all ${
            loading
              ? 'bg-achrams-secondary-solid text-achrams-text-light opacity-75 cursor-not-allowed'
              : 'bg-achrams-gradient-primary text-achrams-text-light hover:opacity-90 active:scale-[0.98]'
          }`}
        >
          {loading ? ( // NEW: Show spinner while loading
            <div className="flex items-center justify-center">
              <Loader className="w-5 h-5 animate-spin mr-2" />
              Saving...
            </div>
          ) : (
            'Save Changes'
          )}
        </button>

        <button
          onClick={onClose}
          disabled={loading} // NEW: Disable "Cancel" while loading
          className="w-full text-achrams-text-secondary font-medium hover:text-achrams-text-primary transition-colors disabled:opacity-50"
        >
          Cancel
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/ProfileModal.tsx -----
// src/components/app/modals/ProfileModal.tsx
import { X, Phone, Mail, Shield, ChevronRight, Wallet, CreditCard, History, Settings, LogOut, User, Camera, Edit3, Save, ArrowLeft, Loader2 , Key, Trash2} from 'lucide-react';
import Image from 'next/image';
import { useState, useRef, useEffect } from 'react';
import { apiClient } from '@/lib/api'; // Assuming apiClient is available or passed down
import PasswordResetModal from "@/components/app/modals/PasswordResetModal"
import AccountDeletionModal from "@/components/app/modals/AccountDeletionModal"



interface ProfileModalProps {
  isOpen: boolean;
  onClose: () => void;
  accountData: any; // Consider defining a more specific type for account data
  onLogout: () => void;
  onShowTripHistory?: () => void;
  onShowWallet?: () => void;
  onShowSettings?: () => void;
  // NEW: Prop to update account data after successful API call
  onUpdateAccountData: (updatedData: any) => void;
  // NEW: Prop to show notification
  showNotification: (message: string, type: "info" | "success" | "warning" | "error") => void;
  setShowPasswordResetModal: (val: boolean) => void;
  setShowAccountDeletionModal: (val: boolean) => void
}

export default function ProfileModal({
  isOpen,
  onClose,
  accountData,
  onLogout,
  onShowTripHistory,
  onShowWallet,
  onShowSettings,
  onUpdateAccountData, // NEW: Function to update parent state
  showNotification, // NEW: Function to show notifications
  setShowPasswordResetModal,
  setShowAccountDeletionModal,
}: ProfileModalProps) {
  // NEW: State for editing mode and form data
  const [isEditing, setIsEditing] = useState(false);
  const [editForm, setEditForm] = useState({
    first_name: accountData?.first_name || '',
    last_name: accountData?.last_name || '',
    email: accountData?.email || '',
    phone_number: accountData?.phone_number || '',
    profile_photo: accountData?.profile_photo || null,
    // NEW: Include is_2fa_enabled in form state
    is_2fa_enabled: accountData?.is_2fa_enabled || false,
    preferred_language: accountData?.preferred_language?.value || 'en',
  });
  

  const [isSaving, setIsSaving] = useState(false);
  const [profilePhotoPreview, setProfilePhotoPreview] = useState<string | null>(accountData?.profile_photo || null);

  // NEW: Ref for file input
  const fileInputRef = useRef<HTMLInputElement>(null);

  // NEW: Reset form when modal closes or accountData changes while not editing
  useEffect(() => {
    if (!isOpen || !isEditing) {
      setEditForm({
        first_name: accountData?.first_name || '',
        last_name: accountData?.last_name || '',
        email: accountData?.email || '',
        phone_number: accountData?.phone_number || '',
        profile_photo: accountData?.profile_photo || null,
        is_2fa_enabled: accountData?.is_2fa_enabled || false, // Sync with accountData
        preferred_language: accountData?.preferred_language?.value || 'en',
      });
      setProfilePhotoPreview(accountData?.profile_photo || null);
    }
  }, [isOpen, accountData, isEditing]);

  // NEW: Handler for form input changes (including checkbox)
  const handleEditChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
    const { name, value, type } = e.target;
    if (type === 'checkbox') {
      // Cast target to HTMLInputElement to access checked property
      const target = e.target as HTMLInputElement;
      setEditForm(prev => ({ ...prev, [name]: target.checked }));
    } else {
      setEditForm(prev => ({ ...prev, [name]: value }));
    }
  };

  // NEW: Handler for profile photo selection
  const handlePhotoChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files && e.target.files[0]) {
      const file = e.target.files[0];
      // Basic validation could be added here (e.g., file type, size)
      setEditForm(prev => ({ ...prev, profile_photo: file })); // Store the File object
      // Create a preview URL for the selected file
      const reader = new FileReader();
      reader.onloadend = () => {
        setProfilePhotoPreview(reader.result as string);
      };
      reader.readAsDataURL(file);
    }
  };

  // NEW: Handler for clicking the camera icon to trigger file input
  const triggerFileInput = () => {
    fileInputRef.current?.click();
  };

  // NEW: Handler for saving the profile (PATCH request) - Handles everything
  const handleSaveProfile = async () => {
    if (!accountData) return;

    setIsSaving(true);
    try {
      // Prepare form data for API call
      const formData = new FormData();
      formData.append('first_name', editForm.first_name);
      formData.append('last_name', editForm.last_name);
      formData.append('email', editForm.email);
      formData.append('phone_number', editForm.phone_number);
      // NEW: Append is_2fa_enabled to the form data
      formData.append('is_2fa_enabled', editForm.is_2fa_enabled.toString());
      formData.append('preferred_language', editForm.preferred_language);

      // Append profile photo if it's a File object (newly selected)
      if (editForm.profile_photo instanceof File) {
        formData.append('profile_photo', editForm.profile_photo);
      }

      console.log("Sending profile update request with form data keys:", Array.from(formData.keys()));

      // Use apiClient.patch with form data
      const response = await apiClient.patch('/auth/passenger/me', formData, undefined, true); // isAuthRequest = true

      console.log("Profile update API response:", response);

      if (response.status === "success" && response.data) {
        showNotification("Profile updated successfully!", "success");
        // Update parent state with the new data from the API response
        // This response should contain the updated is_2fa_enabled status and profile photo
        onUpdateAccountData(response.data);
        // Exit edit mode
        setIsEditing(false);
      } else {
        console.error("Profile update failed:", response);
        showNotification(response?.details?.profile_photo?.[0] || response.message || "Failed to update profile.", "error");
      }
    } catch (error) {
      console.error("Error updating profile:", error);
      showNotification("An error occurred while updating your profile.", "error");
    } finally {
      setIsSaving(false);
    }
  };

  // NEW: Handler to cancel editing
  const handleCancelEdit = () => {
    // Reset form to original values
    setEditForm({
      first_name: accountData?.first_name || '',
      last_name: accountData?.last_name || '',
      email: accountData?.email || '',
      phone_number: accountData?.phone_number || '',
      profile_photo: accountData?.profile_photo || null,
      is_2fa_enabled: accountData?.is_2fa_enabled || false,
      preferred_language: accountData?.preferred_language?.value || 'en',
    });
    setProfilePhotoPreview(accountData?.profile_photo || null);
    setIsEditing(false);
  };

  const handleOpenPasswordReset = () => {
    onClose();
    setShowPasswordResetModal(true);
  }

  const handleOpenAccountDeletion = () => {
    onClose();
    setShowAccountDeletionModal(true);
  }

 

  if (!isOpen || !accountData) return null;

  const initials = accountData.initials || `${accountData.first_name?.charAt(0) || ''}${accountData.last_name?.charAt(0) || ''}`.toUpperCase();
  const profilePhoto = profilePhotoPreview; // Use preview if set, else original
  const fullName = `${accountData.first_name || ''} ${accountData.last_name || ''}`.trim();

  return (
    <div className="fixed inset-0 z-50 flex items-end justify-center">
      {/* Backdrop */}
      <div
        className="absolute inset-0 bg-black/50"
        onClick={onClose}
      />
      
      {/* Modal Content */}
      <div className="relative bg-white w-full max-w-md h-[85vh] rounded-t-3xl border-t border-achrams-border shadow-lg overflow-hidden flex flex-col">
        
        {/* Header with Profile - Made more compact */}
        <div className="bg-gradient-to-r from-emerald-600 via-teal-600 to-cyan-600 text-white px-6 pt-6 pb-4 shadow-md">
          {/* Header Row with Title and Close Button */}
          <div className="flex items-center justify-between mb-4">
            {/* NEW: Show Edit/Save/Cancel buttons based on mode */}
            {isEditing ? (
              <button
                onClick={handleCancelEdit}
                className="text-white hover:text-white/80 p-2 hover:bg-white/10 rounded-lg transition-colors flex items-center gap-1"
                aria-label="Cancel Edit"
              >
                <ArrowLeft className="w-5 h-5" />
                <span>Cancel</span>
              </button>
            ) : (
              <h2 className="text-xl font-bold">My Profile</h2>
            )}
            <div className="flex items-center gap-2">
              {isEditing && (
                <button
                  onClick={handleSaveProfile}
                  disabled={isSaving}
                  className="text-white hover:text-white/80 p-2 hover:bg-white/10 rounded-lg transition-colors flex items-center gap-1 disabled:opacity-50"
                  aria-label="Save Profile"
                >
                  <Save className={`w-5 h-5 ${isSaving ? 'animate-spin' : ''}`} />
                  {isSaving ? 'Saving...' : 'Save'}
                </button>
              )}
              <button
                onClick={onClose}
                className="text-white hover:text-white/80 p-2 hover:bg-white/10 rounded-lg transition-colors"
                aria-label="Close"
              >
                <X className="w-6 h-6" />
              </button>
            </div>
          </div>

          {/* Profile Info Row - Reduced vertical spacing */}
          <div className="flex items-center gap-4">
            <div className="relative">
              {/* Profile Image/Initials - Slightly smaller */}
              <div className="w-16 h-16 bg-gradient-to-br from-achrams-primary-light to-achrams-secondary-light rounded-xl flex items-center justify-center text-xl font-bold shadow-md ring-2 ring-white/30 relative overflow-hidden">
                {profilePhoto ? (
                  <Image
                    src={profilePhoto}
                    alt={`${fullName}'s profile`}
                    fill // Use fill to cover the container
                    className="rounded-xl object-cover"
                    unoptimized
                  />
                ) : (
                  <span className="text-achrams-text-light">{initials}</span>
                )}
                {/* NEW: Camera icon overlay for editing */}
                {isEditing && (
                  <button
                    onClick={triggerFileInput}
                    className="absolute inset-0 bg-black/30 flex items-center justify-center rounded-xl opacity-0 hover:opacity-100 transition-opacity"
                    aria-label="Change profile photo"
                  >
                    <Camera className="w-6 h-6 text-white" />
                  </button>
                )}
              </div>
              {/* NEW: 2FA Indicator - Updated to reflect form state during edit, original state otherwise */}
              {isEditing ? (
                  <div className={`absolute -bottom-1 -right-1 w-5 h-5 rounded-full border-2 border-white flex items-center justify-center shadow-sm ${
                      editForm.is_2fa_enabled ? 'bg-green-500' : 'bg-gray-300' // Green if enabled, gray if disabled in form
                  }`}>
                    <Shield className="w-2.5 h-2.5 text-white" />
                  </div>
              ) : (
                  accountData.is_2fa_enabled && (
                  <div className="absolute -bottom-1 -right-1 w-5 h-5 bg-green-500 rounded-full border-2 border-white flex items-center justify-center shadow-sm">
                    <Shield className="w-2.5 h-2.5 text-white" />
                  </div>
                  )
              )}
            </div>
            <div className="flex-1 min-w-0">
              {/* NEW: Show input fields in edit mode, otherwise show text */}
              {isEditing ? (
                <>
                  <input
                    type="text"
                    name="first_name"
                    value={editForm.first_name}
                    onChange={handleEditChange}
                    className="text-lg font-bold mb-1 bg-transparent border-b border-white/30 text-achrams-text-light placeholder-white/50 focus:outline-none focus:border-white w-full"
                    placeholder="First Name"
                  />
                  <input
                    type="text"
                    name="last_name"
                    value={editForm.last_name}
                    onChange={handleEditChange}
                    className="text-lg font-bold mb-1 bg-transparent border-b border-white/30 text-achrams-text-light placeholder-white/50 focus:outline-none focus:border-white w-full"
                    placeholder="Last Name"
                  />
                </>
              ) : (
                <>
                  <h3 className="text-lg font-bold mb-1 truncate text-achrams-text-light">{fullName}</h3>
                  {/* 2FA Status - More prominent and clear (outside edit mode) */}
                  {accountData.is_2fa_enabled && (
                    <div className="inline-flex items-center gap-1 text-xs bg-green-600/20 text-green-200 px-2 py-1 rounded-full">
                      <Shield className="w-3 h-3" />
                      <span>2FA Enabled</span>
                    </div>
                  )}
                </>
              )}
            </div>
            {/* NEW: Edit button when not editing */}
            {!isEditing && (
              <button
                onClick={() => setIsEditing(true)}
                className="p-2 text-white hover:bg-white/10 rounded-lg transition-colors"
                aria-label="Edit Profile"
              >
                <Edit3 className="w-5 h-5" />
              </button>
            )}
          </div>
        </div>

        {/* NEW: Hidden file input for profile photo */}
        <input
          type="file"
          ref={fileInputRef}
          onChange={handlePhotoChange}
          accept="image/*"
          className="hidden"
          aria-hidden="true"
        />

        {/* Scrollable Content */}
        <div className="flex-1 overflow-y-auto px-6 py-4">
          {/* NEW: Edit Form Section - Only show when editing */}
          {isEditing ? (
            <div className="space-y-4 mb-6">
              {/* Email Field */}
              <div className="p-3 bg-gray-50 rounded-xl border border-achrams-border">
                <label className="block text-xs text-achrams-text-secondary font-medium mb-1">Email</label>
                <input
                  type="email"
                  name="email"
                  value={editForm.email}
                  onChange={handleEditChange}
                  className="w-full bg-transparent text-achrams-text-primary font-semibold focus:outline-none"
                  placeholder="your.email@example.com"
                />
              </div>

              {/* Phone Field */}
              <div className="p-3 bg-gray-50 rounded-xl border border-achrams-border">
                <label className="block text-xs text-achrams-text-secondary font-medium mb-1">Phone</label>
                <input
                  type="tel"
                  name="phone_number"
                  value={editForm.phone_number}
                  onChange={handleEditChange}
                  className="w-full bg-transparent text-achrams-text-primary font-semibold focus:outline-none"
                  placeholder="+234 000 000 0000"
                />
              </div>

              {/* Preferred Language Field */}
              <div className="p-3 bg-gray-50 rounded-xl border border-achrams-border">
                <label className="block text-xs text-achrams-text-secondary font-medium mb-1">Language</label>
                <select
                  name="preferred_language"
                  value={editForm.preferred_language}
                  onChange={handleEditChange}
                  className="w-full bg-transparent text-achrams-text-primary font-semibold focus:outline-none"
                >
                  <option value="en">English</option>
                  {/* Add other language options as needed */}
                  <option value="es">Spanish</option>
                  <option value="fr">French</option>
                </select>
              </div>

              {/* NEW: 2FA Toggle Field */}
              <div className="p-3 bg-gray-50 rounded-xl border border-achrams-border flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className="w-9 h-9 bg-indigo-100 rounded-lg flex items-center justify-center flex-shrink-0">
                    <Shield className="w-4 h-4 text-indigo-600" />
                  </div>
                  <div>
                    <div className="text-xs text-achrams-text-secondary font-medium mb-0.5">Two-Factor Authentication</div>
                    <div className="text-sm font-semibold text-achrams-text-primary">
                      {editForm.is_2fa_enabled ? "Enabled" : "Disabled"}
                    </div>
                  </div>
                </div>
                <label className="relative inline-flex h-6 w-11 items-center rounded-full cursor-pointer">
                  <input
                    type="checkbox"
                    name="is_2fa_enabled"
                    checked={editForm.is_2fa_enabled}
                    onChange={handleEditChange}
                    className="sr-only peer"
                  />
                  <span className={`block w-11 h-6 rounded-full transition-colors ${
                    editForm.is_2fa_enabled ? 'bg-indigo-600' : 'bg-gray-300'
                  }`}></span>
                  <span className={`absolute left-1 top-1 bg-white rounded-full w-4 h-4 transition-transform ${
                    editForm.is_2fa_enabled ? 'translate-x-6' : 'translate-x-0'
                  }`}></span>
                </label>
              </div>
            </div>
          ) : (
            // OLD: Contact Information Section - Only show when not editing
            <>
            {/* Contact Information */}
            <div className="mb-6">
              <h4 className="font-bold text-achrams-text-primary mb-3 text-sm">Contact Information</h4>
              <div className="space-y-2">
                <div className="flex items-center gap-3 p-3 bg-gray-50 rounded-xl border border-achrams-border">
                  <div className="w-9 h-9 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0">
                    <Phone className="w-4 h-4 text-blue-600" />
                  </div>
                  <div className="flex-1 min-w-0">
                    <div className="text-xs text-achrams-text-secondary font-medium mb-0.5">Phone</div>
                    <div className="text-sm font-semibold text-achrams-text-primary truncate">
                      {accountData.phone_number}
                    </div>
                  </div>
                </div>
                
                <div className="flex items-center gap-3 p-3 bg-gray-50 rounded-xl border border-achrams-border">
                  <div className="w-9 h-9 bg-purple-100 rounded-lg flex items-center justify-center flex-shrink-0">
                    <Mail className="w-4 h-4 text-purple-600" />
                  </div>
                  <div className="flex-1 min-w-0">
                    <div className="text-xs text-achrams-text-secondary font-medium mb-0.5">Email</div>
                    <div className="text-sm font-semibold text-achrams-text-primary truncate">
                      {accountData.email}
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {/* NEW: 2FA Status Card when not editing */}
            <div className="mb-6">
              <h4 className="font-bold text-achrams-text-primary mb-3 text-sm">Security</h4>
              <div className="p-3 bg-gray-50 rounded-xl border border-achrams-border flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className="w-9 h-9 bg-indigo-100 rounded-lg flex items-center justify-center flex-shrink-0">
                    <Shield className="w-4 h-4 text-indigo-600" />
                  </div>
                  <div>
                    <div className="text-sm font-semibold text-achrams-text-primary">Two-Factor Authentication</div>
                    <div className="text-xs text-achrams-text-secondary">
                      {accountData.is_2fa_enabled ? "Enabled" : "Disabled"}
                    </div>
                  </div>
                </div>
                {/* Optionally, show an 'Edit' button here to trigger the 2FA toggle directly, or keep it in edit mode */}
              </div>
            </div>
            </>
          )}

          {/* Wallet Balance */}
          {/* {accountData.profile?.wallet && (
            <div className="mb-6">
              <h4 className="font-bold text-achrams-text-primary mb-3 text-sm">Wallet</h4>
              <div 
                className="p-4 bg-gradient-to-br from-achrams-primary-solid to-achrams-secondary-solid rounded-xl text-white cursor-pointer hover:shadow-lg transition-shadow"
                onClick={onShowWallet}
              >
                <div className="flex items-center justify-between">
                  <div>
                    <div className="text-xs text-white/80 mb-1">Available Balance</div>
                    <div className="text-2xl font-bold">
                      {accountData.profile.wallet.balance.formatted || `${accountData.profile.wallet.balance.amount?.toLocaleString()}`}
                    </div>
                  </div>
                  <div className="w-12 h-12 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center">
                    <Wallet className="w-6 h-6" />
                  </div>
                </div>
              </div>
            </div>
          )} */}

          {/* Quick Actions */}
          <div className="mb-6">
            <h4 className="font-bold text-achrams-text-primary mb-3 text-sm">Quick Actions</h4>
            <div className="space-y-2">
              {onShowTripHistory && (
                <button
                  onClick={() => {
                    onShowTripHistory();
                    onClose();
                  }}
                  className="w-full flex items-center justify-between p-3 bg-white border border-achrams-border rounded-xl hover:bg-gray-50 hover:shadow-sm transition-all"
                >
                  <div className="flex items-center gap-3">
                    <div className="w-9 h-9 bg-indigo-100 rounded-lg flex items-center justify-center">
                      <History className="w-4 h-4 text-indigo-600" />
                    </div>
                    <span className="font-medium text-achrams-text-primary">Trip History</span>
                  </div>
                  <ChevronRight className="w-5 h-5 text-achrams-text-secondary" />
                </button>
              )}

              {/* {onShowWallet && (
                <button
                  onClick={() => {
                    onShowWallet();
                    onClose();
                  }}
                  className="w-full flex items-center justify-between p-3 bg-white border border-achrams-border rounded-xl hover:bg-gray-50 hover:shadow-sm transition-all"
                >
                  <div className="flex items-center gap-3">
                    <div className="w-9 h-9 bg-green-100 rounded-lg flex items-center justify-center">
                      <Wallet className="w-4 h-4 text-green-600" />
                    </div>
                    <span className="font-medium text-achrams-text-primary">Wallet & Payments</span>
                  </div>
                  <ChevronRight className="w-5 h-5 text-achrams-text-secondary" />
                </button>
              )} */}

              {/* <button
                className="w-full flex items-center justify-between p-3 bg-white border border-achrams-border rounded-xl hover:bg-gray-50 hover:shadow-sm transition-all"
              >
                <div className="flex items-center gap-3">
                  <div className="w-9 h-9 bg-amber-100 rounded-lg flex items-center justify-center">
                    <CreditCard className="w-4 h-4 text-amber-600" />
                  </div>
                  <span className="font-medium text-achrams-text-primary">Payment Methods</span>
                </div>
                <ChevronRight className="w-5 h-5 text-achrams-text-secondary" />
              </button> */}

              {onShowSettings && (
                <button
                  onClick={() => {
                    onShowSettings();
                    onClose();
                  }}
                  className="w-full flex items-center justify-between p-3 bg-white border border-achrams-border rounded-xl hover:bg-gray-50 hover:shadow-sm transition-all"
                >
                  <div className="flex items-center gap-3">
                    <div className="w-9 h-9 bg-gray-100 rounded-lg flex items-center justify-center">
                      <Settings className="w-4 h-4 text-gray-600" />
                    </div>
                    <span className="font-medium text-achrams-text-primary">Settings & Security</span>
                  </div>
                  <ChevronRight className="w-5 h-5 text-achrams-text-secondary" />
                </button>
              )}

               {/* NEW: Password Reset Action */}
              <button
                onClick={handleOpenPasswordReset}
                className="w-full flex items-center justify-between p-3 bg-white border border-achrams-border rounded-xl hover:bg-gray-50 hover:shadow-sm transition-all"
              >
                <div className="flex items-center gap-3">
                  <div className="w-9 h-9 bg-amber-100 rounded-lg flex items-center justify-center">
                    <Key className="w-4 h-4 text-amber-600" />
                  </div>
                  <span className="font-medium text-achrams-text-primary">Reset Password</span>
                </div>
                <ChevronRight className="w-5 h-5 text-achrams-text-secondary" />
              </button>



              {/* NEW: Account Deletion Action */}
              <button
                onClick={handleOpenAccountDeletion}
                className="w-full flex items-center justify-between p-3 bg-white border border-achrams-border rounded-xl hover:bg-red-50 hover:shadow-sm transition-all text-red-600"
              >
                <div className="flex items-center gap-3">
                  <div className="w-9 h-9 bg-red-100 rounded-lg flex items-center justify-center">
                    <Trash2 className="w-4 h-4 text-red-600" />
                  </div>
                  <span className="font-medium">Delete Account</span>
                </div>
                <ChevronRight className="w-5 h-5 text-red-600" />
              </button>
           

            </div>
          </div>

          {/* Logout Button */}
          <button
            onClick={onLogout}
            className="w-full flex items-center justify-center gap-2 py-3 text-center text-red-600 font-medium bg-red-50 hover:bg-red-100 rounded-xl border border-red-200 transition-all mb-4"
          >
            <LogOut className="w-5 h-5" />
            <span>Log Out</span>
          </button>
        </div>
      </div>
      
    </div>
  );
}



----- FILE: src/components/app/modals/LocationPermissionModal.tsx -----
// src/components/app/modals/LocationPermissionModal.tsx
import { X } from 'lucide-react';

interface LocationPermissionModalProps {
  isOpen: boolean;
  onClose: () => void;
  onGrantAccess: () => void; // Function to trigger browser permission request
}

export default function LocationPermissionModal({
  isOpen,
  onClose,
  onGrantAccess,
}: LocationPermissionModalProps) {
  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 bg-opacity-70 flex items-end z-100">
      <div className="bg-white w-full rounded-t-3xl p-6 max-w-sm mx-auto animate-slideUp max-h-[85vh] overflow-y-auto border-t border-achrams-border">
        <div className="flex justify-between items-center mb-6">
          <h3 className="text-xl font-bold text-achrams-text-primary">Location Access Required</h3>
          <button
            onClick={onClose}
            className="text-achrams-text-secondary hover:text-achrams-text-primary transition-colors"
          >
            <X className="w-6 h-6" />
          </button>
        </div>
        <div className="flex flex-col items-center gap-4 mb-6">
          <p className="text-center text-achrams-text-secondary">
            This app requires your location access to work. Please grant access to find nearby pickup locations.
          </p>
        </div>
        <button
          onClick={() => {
            onGrantAccess(); // Trigger the geolocation permission request
            onClose(); // Close the modal after triggering
          }}
          className={`w-full py-4 rounded-xl font-semibold transition-all bg-achrams-gradient-primary text-achrams-text-light hover:opacity-90 active:scale-[0.98]`}
        >
          Grant Access
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/PassengerDetailsModal.tsx -----
// src/components/app/modals/PassengerDetailsModal.tsx
import { X, Package, Users, Accessibility } from 'lucide-react'; // Added Wheelchair icon
import { useState, useEffect } from 'react';


interface PassengerDetailsModalProps {
  isOpen: boolean;
  onClose: () => void;
  passengerData: { name: string; phone: string; email: string };
  setPassengerData: (data: any) => void;
  requirements: { luggage: boolean; wheelchair: boolean; elderly: boolean };
  setRequirements: (req: any) => void;
  onRequestRide: () => void;
  isAuthenticated: boolean;
  setBookAsGuest: (val: boolean) => void;
  isLoading? : boolean;
  bookAsGuest: boolean;
  getBookingFieldError: (fieldName: string) => string | undefined;
  setTripRequestStatus: (status: string | null) => void;
  setTripRequestError: (error: string | null) => void;


}

export default function PassengerDetailsModal({
  isOpen,
  onClose,
  passengerData,
  setPassengerData,
  requirements,
  setRequirements,
  onRequestRide,
  isLoading,
  isAuthenticated,
  setBookAsGuest,
  bookAsGuest,
  getBookingFieldError,
  setTripRequestStatus,
  setTripRequestError,
}: PassengerDetailsModalProps) {
  const [showRequirements, setShowRequirements] = useState(false);

  useEffect(() => {
    // Check if any of the relevant field errors exist using the passed getter function
    const hasFieldError = !!(
      getBookingFieldError('guest_name') ||
      getBookingFieldError('name') ||
      getBookingFieldError('guest_phone') ||
      getBookingFieldError('phone_number') ||
      getBookingFieldError('guest_email') ||
      getBookingFieldError('email')
    );

    if (hasFieldError) {
      console.log("Detected field error in PassengerDetailsModal, updating parent status.");
      setTripRequestStatus(null); 
      setTripRequestError(null); 
    }

  }, [
    getBookingFieldError,
    setTripRequestStatus,
    setTripRequestError,
  ]);

  if (!isOpen) return null;
  const isGuestFormIncomplete =
  bookAsGuest &&
  (!passengerData.name ||
   !passengerData.phone ||
   !passengerData.email);

  return (
    // Fixed background: use bg-achrams-bg-primary with opacity
    // Ensure it covers the whole screen behind the modal
    <div className=" fixed inset-0 bg-achrams-secondary-solid/50 flex items-end z-50"> 
      {/* The modal content */}
      <div className="bg-white w-full max-w-sm mx-auto rounded-t-3xl p-6 animate-slideUp max-h-[85vh] overflow-y-auto border-t border-achrams-border ">
        <div className="flex justify-between items-center mb-6">
          <h3 className="text-xl font-bold text-achrams-text-primary">Passenger details</h3>
          <button 
            onClick={onClose}
            className="text-achrams-text-secondary hover:text-achrams-text-primary transition-colors"
          >
            <X className="w-6 h-6" />
          </button>
        </div>

        {isAuthenticated && (


      <div className="flex items-center gap-3 mb-4">
        <input
          type="checkbox"
          checked={bookAsGuest}
          onChange={(e) => {
            console.log("bookAsGuest old state: ", bookAsGuest)
            console.log(
              "bookAsGuest New State: ", e.target.checked
            )
            setBookAsGuest(e.target.checked)}}
          className="w-5 h-5 text-achrams-primary-solid rounded focus:ring-achrams-primary-solid focus:ring-offset-0"
        />
        <span className="text-achrams-text-primary">Book as Guest</span>
      </div>

        )}


        {(bookAsGuest || !isAuthenticated) && (

        <div className="space-y-4 mb-6">
          <div className="relative">
          <input
            type="text"
            placeholder="Full name"
            value={passengerData.name}
            onChange={(e) => setPassengerData({ ...passengerData, name: e.target.value })}
            // Apply ACHRAMS styling to input
            className={`w-full px-4 py-4 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border ${getBookingFieldError('guest_name') || getBookingFieldError('name') ? 'border-red-500' : 'border-achrams-border'}`}
          />

           {/* NEW: Display field error for name */}
              {(getBookingFieldError('guest_name') || getBookingFieldError('name')) && (
                <p className="text-red-500 text-xs mt-1">
                  {getBookingFieldError('guest_name') || getBookingFieldError('name')}
                </p>
              )}

          </div>

          <div className="relative">

          <input
            type="tel"
            placeholder="Phone number"
            value={passengerData.phone}
            onChange={(e) => setPassengerData({ ...passengerData, phone: e.target.value })}
            // Apply ACHRAMS styling to input
            className={`w-full px-4 py-4 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border ${getBookingFieldError('guest_phone') || getBookingFieldError('phone_number') ? 'border-red-500' : 'border-achrams-border'}`}
          />
          {/* NEW: Display field error for phone */}
              {(getBookingFieldError('guest_phone') || getBookingFieldError('phone_number')) && (
                <p className="text-red-500 text-xs mt-1">
                  {getBookingFieldError('guest_phone') || getBookingFieldError('phone_number')}
                </p>
              )}
          </div>

          <div className="relative">

          <input
            type="email"
            placeholder="Email address"
            value={passengerData.email}
            onChange={(e) => setPassengerData({ ...passengerData, email: e.target.value })}
            // Apply ACHRAMS styling to input
            className={`w-full px-4 py-4 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border ${getBookingFieldError('guest_email') || getBookingFieldError('email') ? 'border-red-500' : 'border-achrams-border'}`}
          />
             {/* NEW: Display field error for email */}
              {(getBookingFieldError('guest_email') || getBookingFieldError('email')) && (
                <p className="text-red-500 text-xs mt-1">
                  {getBookingFieldError('guest_email') || getBookingFieldError('email')}
                </p>
              )}
          </div>
        </div>

        )}

        <button
          onClick={() => setShowRequirements(!showRequirements)}
          // Apply ACHRAMS styling to button
          className="w-full flex items-center justify-between py-4 border-t border-b border-achrams-border text-achrams-text-primary hover:bg-achrams-bg-secondary transition-colors"
        >
          <span className="font-medium">Special requirements</span>
          {/* Use ChevronDown/Up instead of X for consistency */}
          {showRequirements ? <X className="w-5 h-5" /> : <span className="text-achrams-text-secondary">+ Add</span>}
        </button>
        {showRequirements && (
          <div className="space-y-3 py-4">
            <label className="flex items-center gap-3 p-3 bg-achrams-bg-secondary rounded-xl cursor-pointer border border-achrams-border">
              <input
                type="checkbox"
                checked={requirements.luggage}
                onChange={(e) => setRequirements({ ...requirements, luggage: e.target.checked })}
                className="w-5 h-5 text-achrams-primary-solid rounded focus:ring-achrams-primary-solid focus:ring-offset-0"
              />
              <Package className="w-5 h-5 text-achrams-text-secondary flex-shrink-0" />
              <span className="text-achrams-text-primary">Extra luggage</span>
            </label>
            <label className="flex items-center gap-3 p-3 bg-achrams-bg-secondary rounded-xl cursor-pointer border border-achrams-border">
              <input
                type="checkbox"
                checked={requirements.wheelchair}
                onChange={(e) => setRequirements({ ...requirements, wheelchair: e.target.checked })}
                className="w-5 h-5 text-achrams-primary-solid rounded focus:ring-achrams-primary-solid focus:ring-offset-0"
              />
              {/* Replaced emoji with Wheelchair icon */}
              <Accessibility className="w-5 h-5 text-achrams-text-secondary flex-shrink-0" />
              <span className="text-achrams-text-primary">Wheelchair accessible</span>
            </label>
            <label className="flex items-center gap-3 p-3 bg-achrams-bg-secondary rounded-xl cursor-pointer border border-achrams-border">
              <input
                type="checkbox"
                checked={requirements.elderly}
                onChange={(e) => setRequirements({ ...requirements, elderly: e.target.checked })}
                className="w-5 h-5 text-achrams-primary-solid rounded focus:ring-achrams-primary-solid focus:ring-offset-0"
              />
              <Users className="w-5 h-5 text-achrams-text-secondary flex-shrink-0" />
              <span className="text-achrams-text-primary">Elderly passenger</span>
            </label>
          </div>
        )}
        <button
          onClick={onRequestRide}
          disabled={isGuestFormIncomplete || isLoading }
          // Apply ACHRAMS gradient button styling
          className={`w-full py-4 rounded-xl font-semibold mt-6 transition-all ${
            !isGuestFormIncomplete && !isLoading
              ? 'bg-achrams-gradient-primary text-achrams-text-light hover:opacity-90 active:scale-[0.98]' // Enabled state
              : 'bg-achrams-secondary-solid text-achrams-text-light opacity-75 cursor-not-allowed' // Disabled state
          }`}
        >
          {isLoading ? 'Requesting...': 'Request a ride'}
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/Enable2FAModal.tsx -----
// src/components/app/modals/Enable2FAModal.tsx
import { X, QrCode, Loader } from 'lucide-react';
import { useState, useEffect } from 'react';
import { apiClient } from '@/services/apiClient'; // Assuming you create this service

interface Enable2FAModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSuccess: () => void; // NEW: Callback after successful enablement
}

export default function Enable2FAModal({
  isOpen,
  onClose,
  onSuccess,
}: Enable2FAModalProps) {
  if (!isOpen) return null;

  // NEW: State for QR code data, OTP input, loading, error
  const [qrDataUrl, setQrDataUrl] = useState<string | null>(null);
  const [secret, setSecret] = useState<string | null>(null); // NEW: Store secret if needed for manual entry
  const [otp, setOtp] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);
  const [loadingSetup, setLoadingSetup] = useState(true); // NEW: Loading for initial setup

  // NEW: Fetch QR code and secret on modal open
  useEffect(() => {
    if (isOpen) {
      const fetchSetupData = async () => {
        setLoadingSetup(true);
        setError('');
        try {
          const response = await apiClient.post('/auth/passenger/2fa/setup'); // Use correct endpoint from Postman
          if (response.status === 200 && response.data && response.data.data) {
            setQrDataUrl(response.data.data.qr_code_url); // Adjust based on actual API response structure
            setSecret(response.data.data.secret); // Adjust based on actual API response structure
          } else {
            setError('Failed to get setup data. Please try again.');
          }
        } catch (err) {
          console.error("2FA Setup Error:", err);
          let errorMessage = 'An unexpected error occurred.';
          if (err instanceof Error) {
            errorMessage = err.message;
          }
          setError(errorMessage);
        } finally {
          setLoadingSetup(false);
        }
      };

      fetchSetupData();
    } else {
        // NEW: Reset state when modal closes
        setQrDataUrl(null);
        setSecret(null);
        setOtp('');
        setError('');
        setLoading(false);
        setLoadingSetup(false);
    }
  }, [isOpen]);


  const handleEnable = async () => {
    setError(''); // Clear previous errors
    if (!otp) {
      setError('Please enter the OTP from your authenticator app.');
      return;
    }

    setLoading(true);
    try {
      // NEW: Call the enable API using apiClient
      const response = await apiClient.post('/auth/passenger/2fa/enable', { // Use correct endpoint from Postman
        token: otp, // Or 'otp' depending on API expectation
      });

      console.log("2FA Enable Response:", response); // Debug log
      if (response.status === 200) { // Assuming 200 for success
        // NEW: On success, close modal and trigger success handler (e.g., update profile info in parent)
        onClose();
        onSuccess();
      } else {
          setError('Failed to enable 2FA. Please check the code and try again.');
      }
    } catch (err: any) {
        console.error("2FA Enable Error:", err);
        let errorMessage = 'An unexpected error occurred.';
        if (err.response && err.response.data && err.response.data.message) {
            errorMessage = err.response.data.message;
        } else if (err.message) {
            errorMessage = err.message;
        }
        setError(errorMessage);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 bg-opacity-70 flex items-end z-50">
      <div className="bg-white w-full rounded-t-3xl p-6 animate-slideUp max-h-[90vh] overflow-y-auto border-t border-achrams-border max-w-sm mx-auto">
        <div className="flex justify-between items-center mb-6">
          <h3 className="text-xl font-bold text-achrams-text-primary">Enable Two-Factor Authentication</h3>
          <button
            onClick={onClose}
            disabled={loading} // NEW: Disable close button while loading
            className="text-achrams-text-secondary hover:text-achrams-text-primary transition-colors disabled:opacity-50"
          >
            <X className="w-6 h-6" />
          </button>
        </div>

        {loadingSetup ? (
          <div className="flex flex-col items-center justify-center py-8">
            <Loader className="w-8 h-8 animate-spin text-achrams-primary-solid mb-4" />
            <p className="text-achrams-text-secondary">Setting up...</p>
          </div>
        ) : (
          <>
            <p className="text-achrams-text-secondary mb-6">
              Scan the QR code below with your authenticator app (like Google Authenticator or Authy) to link your account.
            </p>

            {qrDataUrl ? (
              <div className="flex flex-col items-center mb-6">
                <img src={qrDataUrl} alt="2FA QR Code" className="w-48 h-48 bg-achrams-bg-secondary p-4 rounded-lg border border-achrams-border" />
                {secret && (
                  <p className="text-xs text-achrams-text-tertiary mt-2">
                    Secret: <span className="font-mono">{secret}</span> (For manual entry if QR scan fails)
                  </p>
                )}
              </div>
            ) : (
              <p className="text-red-500 text-sm text-center mb-6">Failed to load QR code.</p>
            )}

            <input
              type="text"
              placeholder="Enter 6-digit code from app"
              value={otp}
              onChange={(e) => setOtp(e.target.value.replace(/\D/g, '').slice(0, 6))} // NEW: Allow only digits, max 6
              disabled={loading} // NEW: Disable input while loading
              className="w-full px-4 py-4 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border border-achrams-border mb-4"
            />

            {/* NEW: Error Message Display */}
            {error && (
              <p className="text-red-500 text-sm mb-4">{error}</p>
            )}

            <button
              onClick={handleEnable}
              disabled={loading || !otp} // NEW: Disable based on loading and OTP field
              className={`w-full py-4 rounded-xl font-semibold mb-3 transition-all ${
                loading || !otp
                  ? 'bg-achrams-secondary-solid text-achrams-text-light opacity-75 cursor-not-allowed'
                  : 'bg-achrams-gradient-primary text-achrams-text-light hover:opacity-90 active:scale-[0.98]'
              }`}
            >
              {loading ? ( // NEW: Show spinner while loading
                <div className="flex items-center justify-center">
                  <Loader className="w-5 h-5 animate-spin mr-2" />
                  Enabling...
                </div>
              ) : (
                'Enable 2FA'
              )}
            </button>
          </>
        )}

        <button
          onClick={onClose}
          disabled={loading} // NEW: Disable "Cancel" while loading
          className="w-full text-achrams-text-secondary font-medium hover:text-achrams-text-primary transition-colors disabled:opacity-50"
        >
          Cancel
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/TripDetailModal.tsx -----

// src/components/app/modals/TripDetailsModal.tsx

import { useEffect, useState } from "react";
import { Clock, MapPin, Wallet, Star, User, X, Plane, Loader } from "lucide-react";
import { apiClient } from "@/lib/api";
import { Driver } from "@/types/passenger";

interface Trip {
  id: string;
  amount: {
    formatted: string;
    currency: string;
    amount: number;
  };
  status: {
    label: string;
    value: string;
  };
  pickup_address: string;
  destination_address: string;
  verification_code: string;
  rating: { score: number; comment: string } | null;
  map_data?: any;
  driver?: Driver;
  created_at: string;
}

interface TripDetailsModalProps {
  isOpen: boolean;
  tripId: string | null;
  onClose: () => void;
  showNotification: (message: string, type: "info" | "success" | "warning" | "error") => void;
}

export default function TripDetailsModal({
  isOpen,
  tripId,
  onClose,
  showNotification,
}: TripDetailsModalProps) {
  const [trip, setTrip] = useState<Trip | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  //  FIX: Simplified effect without useCallback
  useEffect(() => {
    // Early return if modal is closed or no tripId
    if (!isOpen || !tripId) {
      setTrip(null);
      setLoading(true);
      setError(null);
      return;
    }

    //  Reset state when starting a new fetch
    setLoading(true);
    setError(null);
    //  DON'T clear trip immediately - keeps previous data visible during load
    // setTrip(null); //  Remove this line

    const fetchTripDetails = async () => {
      try {
        console.log("Fetching details for trip ID:", tripId);
        const response = await apiClient.get(`/trips/${tripId}`, undefined, false, undefined, true);
        console.log("Trip details API response:", response);

        if (response.status === "success" && response.data) {
          setTrip(response.data);
          setError(null);
        } else {
          console.error("API response was not successful for trip details:", response);
          setError("Failed to fetch trip details.");
          setTrip(null);
          showNotification("Failed to fetch trip details.", "error");
        }
      } catch (err) {
        console.error("Error fetching trip details:", err);
        setError("An error occurred while fetching trip details.");
        setTrip(null);
        showNotification("Failed to fetch trip details. Please check your connection.", "error");
      } finally {
        setLoading(false);
      }
    };

    fetchTripDetails();
  }, [isOpen, tripId]); //  Only depend on values that actually change

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-end justify-center">
      <div
        className="absolute inset-0 bg-black/50"
        onClick={onClose}
      />
      
      <div className="relative bg-white w-full max-w-md h-[85vh] rounded-t-3xl border-t border-achrams-border shadow-lg overflow-hidden flex flex-col">
        
        {/* Header */}
        <div className="bg-achrams-primary-solid text-achrams-text-light px-6 py-4 flex items-center justify-between shadow-md">
          <h2 className="text-xl font-bold">Trip Details</h2>
          <button
            onClick={onClose}
            className="text-achrams-text-light hover:text-achrams-text-light/80 p-2 hover:bg-white/10 rounded-lg transition-colors"
            aria-label="Close"
          >
            <X className="w-6 h-6" />
          </button>
        </div>

        {/* Content Area */}
        <div className="flex-1 overflow-y-auto px-6 py-6">
          {loading ? ( //  Only show loading if we don't have data yet
            <div className="flex items-center justify-center h-full">
              <div className="text-center">
                <Loader className="w-12 h-12 text-achrams-primary-solid mx-auto mb-4 animate-spin" />
                <p className="text-achrams-text-secondary">Loading trip details...</p>
              </div>
            </div>
          ) : error ? (
            <div className="flex items-center justify-center h-full">
              <div className="text-center px-6">
                <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                  <X className="w-8 h-8 text-red-500" />
                </div>
                <h3 className="text-lg font-bold text-achrams-text-primary mb-2">Trip Not Found</h3>
                <p className="text-achrams-text-secondary mb-6">{error || "Unable to load trip details."}</p>
                <button
                  onClick={onClose}
                  className="w-full py-3 bg-achrams-primary-solid text-white rounded-xl font-medium hover:opacity-90 active:scale-[0.98] transition-all"
                >
                  Close
                </button>
              </div>
            </div>
          ) : trip ? (
            <div className="space-y-4">
              {/* Trip Status Card */}
              <div className="bg-white rounded-xl p-4 border border-achrams-border hover:shadow-md transition-shadow">
                <div className="flex justify-between items-center mb-2">
                  <h3 className="font-bold text-lg text-achrams-text-primary">Trip Status</h3>
                  <span className={`text-xs px-3 py-1.5 rounded-full font-semibold ${
                    trip.status.value === "completed"
                      ? "bg-green-100 text-green-700"
                      : trip.status.value === "cancelled"
                      ? "bg-gray-100 text-gray-700"
                      : "bg-amber-100 text-amber-700"
                  }`}>
                    {trip.status.label}
                  </span>
                </div>
                <p className="text-sm text-achrams-text-secondary">Trip ID: {trip.id}</p>
              </div>

              {/* Driver Info */}
              {trip.driver && (
                <div className="bg-white rounded-xl p-4 border border-achrams-border hover:shadow-md transition-shadow">
                  <h3 className="font-bold text-lg mb-3 text-achrams-text-primary flex items-center gap-2">
                    <div className="w-8 h-8 bg-indigo-100 rounded-lg flex items-center justify-center">
                      <User className="w-4 h-4 text-indigo-600" />
                    </div>
                    Driver Information
                  </h3>
                  <div className="flex items-center gap-4">
                    <div className="w-14 h-14 bg-gradient-to-br from-achrams-primary-solid to-achrams-secondary-solid rounded-2xl flex items-center justify-center text-white font-bold text-xl shadow-md">
                      {trip.driver.name?.charAt(0) || "D"}
                    </div>
                    <div>
                      <p className="font-semibold text-achrams-text-primary text-lg">{trip.driver.name}</p>
                      <div className="flex items-center gap-1 mt-1">
                        <Star className="w-4 h-4 fill-yellow-500 text-yellow-500" />
                        <span className="text-sm font-medium text-achrams-text-primary">{trip.driver.rating || "N/A"}</span>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Trip Summary */}
              <div className="bg-white rounded-xl p-4 border border-achrams-border hover:shadow-md transition-shadow">
                <h3 className="font-bold text-lg mb-4 text-achrams-text-primary flex items-center gap-2">
                  <div className="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                    <MapPin className="w-4 h-4 text-blue-600" />
                  </div>
                  Route
                </h3>
                <div className="space-y-4">
                  {/* Pickup */}
                  <div className="flex items-start gap-3">
                    <div className="w-3 h-3 rounded-full bg-achrams-primary-solid flex-shrink-0 mt-1"></div>
                    <div>
                      <div className="text-xs text-achrams-text-secondary mb-1 font-medium">PICKUP</div>
                      <div className="font-medium text-achrams-text-primary">{trip.pickup_address}</div>
                    </div>
                  </div>

                  {/* Connection Line */}
                  <div className="flex items-start gap-3">
                    <div className="w-0.5 h-6 bg-achrams-border ml-[5px]"></div>
                  </div>

                  {/* Destination */}
                  <div className="flex items-start gap-3">
                    <MapPin className="w-4 h-4 text-red-500 flex-shrink-0 mt-0.5" />
                    <div>
                      <div className="text-xs text-achrams-text-secondary mb-1 font-medium">DESTINATION</div>
                      <div className="font-medium text-achrams-text-primary">{trip.destination_address}</div>
                    </div>
                  </div>

                  {/* Verification Code */}
                  {trip.verification_code && (
                    <div className="pt-3 border-t border-achrams-border">
                      <div className="text-xs text-achrams-text-secondary mb-1 font-medium">VERIFICATION CODE</div>
                      <div className="font-mono font-bold text-achrams-primary-solid text-2xl tracking-wider">{trip.verification_code}</div>
                    </div>
                  )}
                </div>
              </div>

              {/* Fare & Date */}
              <div className="bg-white rounded-xl p-4 border border-achrams-border hover:shadow-md transition-shadow">
                <h3 className="font-bold text-lg mb-4 text-achrams-text-primary flex items-center gap-2">
                  <div className="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                    <Wallet className="w-4 h-4 text-green-600" />
                  </div>
                  Payment Details
                </h3>
                <div className="space-y-3">
                  <div className="flex justify-between items-center">
                    <span className="text-achrams-text-secondary">Total Fare</span>
                    <span className="text-2xl font-bold text-achrams-primary-solid">
                      {trip.amount.formatted}
                    </span>
                  </div>
                  <div className="flex justify-between items-center pt-3 border-t border-achrams-border">
                    <span className="text-achrams-text-secondary flex items-center gap-1.5">
                      <Clock className="w-4 h-4" />
                      Date & Time
                    </span>
                    <span className="text-achrams-text-primary font-medium">
                      {new Date(trip.created_at || '').toLocaleString() || "N/A"}
                    </span>
                  </div>
                </div>
              </div>

              {/* Rating if available */}
              {trip.rating && (
                <div className="bg-white rounded-xl p-4 border border-achrams-border hover:shadow-md transition-shadow">
                  <h3 className="font-bold text-lg mb-3 text-achrams-text-primary flex items-center gap-2">
                    <div className="w-8 h-8 bg-yellow-100 rounded-lg flex items-center justify-center">
                      <Star className="w-4 h-4 text-yellow-600" />
                    </div>
                    Your Rating
                  </h3>
                  <div className="flex items-center gap-2">
                    {[1, 2, 3, 4, 5].map((star) => (
                      <Star
                        key={star}
                        className={`w-6 h-6 ${
                          star <= trip.rating!.score
                            ? "fill-yellow-500 text-yellow-500"
                            : "text-gray-300"
                        }`}
                      />
                    ))}
                    <span className="ml-2 font-semibold text-achrams-text-primary">{trip.rating.score}/5</span>
                  </div>
                  {trip.rating.comment && (
                    <p className="mt-3 text-sm text-achrams-text-secondary italic">"{trip.rating.comment}"</p>
                  )}
                </div>
              )}
            </div>
          ): null}
        </div>
      </div>
    </div>
  );
}




----- FILE: src/components/app/modals/PanicModal.tsx -----
// src/components/app/modals/PanicModal.tsx
import { AlertCircle, X, Check, Loader, PlusCircle } from 'lucide-react'; // Added PlusCircle icon
import { useState, useEffect } from 'react';
import { apiClient } from '@/lib/api';

const panicOptions = [
  { label: "Panic", value: "panic" },
  { label: "Assault", value: "assault" },
  { label: "Dispute", value: "dispute" },
  { label: "Accident", value: "accident" },
  { label: "Lost Item", value: "lost_item" },
  { label: "Harassment", value: "harassment" },
  { label: "Vehicle Issue", value: "vehicle_issue" },
  { label: "Medical Emergency", value: "medical_emergency" },
  { label: "Suspicious Activity", value: "suspicious_activity" },
  { label: "Unresponsive Driver", value: "unresponsive_driver" },
  // NEW: Add an "Other" option
  { label: "Other", value: "other" },
];

interface PanicModalProps {
  isOpen: boolean;
  onClose: () => void;
  guestId: string | null;
  currentLocationAddress: string;
  currentLocationCoords: [number, number];
  tripId: string;
  isAuthenticated: boolean;
  bookAsGuest: boolean;
}

export default function PanicModal({
  isOpen,
  onClose,
  guestId,
  currentLocationAddress,
  currentLocationCoords,
  tripId,
  isAuthenticated,
  bookAsGuest,
}: PanicModalProps) {
  const [selected, setSelected] = useState<string | null>(null);
  // NEW: State for the custom reason when "Other" is selected
  const [customReason, setCustomReason] = useState<string>('');
  const [sent, setSent] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [submitError, setSubmitError] = useState<string | null>(null);

  // Reset state when modal closes
  useEffect(() => {
    if (!isOpen) {
      setSelected(null);
      setCustomReason(''); // NEW: Reset custom reason
      setSent(false);
      setSubmitError(null);
      setIsSubmitting(false);
    }
  }, [isOpen]);

  const submitAlert = async () => {
    // NEW: Use custom reason if "other" is selected and custom reason is provided
    const alertTypeToSend = selected === 'other' && customReason.trim() ? "panic" : selected;

    if (!alertTypeToSend || !currentLocationCoords || !currentLocationAddress || !tripId) {
      setSubmitError("Missing required data.");
      return;
    }

    setIsSubmitting(true);
    setSubmitError(null);

    try {
      let response;
      if (!bookAsGuest && isAuthenticated) {
        console.log("Raising panic alert as an authenticated user");
        console.log({
          alert_type: alertTypeToSend, // Send the selected type or custom reason
          address: currentLocationAddress,
          location: [currentLocationCoords[0], currentLocationCoords[1]],
          trip: tripId,
          message: customReason.trim()
        });
        response = await apiClient.post(
          "/trip-alerts",
          {
            alert_type: alertTypeToSend, // Send the selected type or custom reason
            address: currentLocationAddress,
            location: [currentLocationCoords[0], currentLocationCoords[1]],
            trip: tripId,
            message: customReason.trim()
          },
          undefined,
          undefined,
          true
        );
      } else {
        console.log('guest Id for alert', guestId);
        response = await apiClient.post('/trip-alerts', {
          alert_type: alertTypeToSend, // Send the selected type or custom reason
          address: currentLocationAddress,
          location: [currentLocationCoords[0], currentLocationCoords[1]],
        }, undefined, guestId);
      }

      console.log("panic modal data", {
        alert_type: alertTypeToSend, // Send the selected type or custom reason
        address: currentLocationAddress,
        location: [currentLocationCoords[0], currentLocationCoords[1]],
      });

      if (response.status === 'success') {
        setSent(true);
        setTimeout(() => {
          onClose();
        }, 1800);
      } else {
        console.log(response);
        setSubmitError(response.details?.non_field_errors?.[0] || response.message || "Failed to send alert. Please try again.");
      }
    } catch (err) {
      setSubmitError("Network error. Please check your connection.");
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleSubmit = () => {
    // NEW: Check if "other" is selected but no custom reason is provided
    if (selected === 'other' && !customReason.trim()) {
        setSubmitError("Please specify the reason under 'Other'.");
        return;
    }
    if (selected) submitAlert();
  };

  if (!isOpen) return null;

  return (
    <div
      className="fixed inset-0 z-50 flex items-end justify-center sm:items-center p-4 sm:p-6 bg-black/40 backdrop-blur-sm animate-fadeIn"
      onClick={onClose}
    >
      {/* Click outside to close */}
      <div
        className="w-full max-w-md bg-white rounded-2xl shadow-lg overflow-hidden sm:rounded-3xl transform transition-all duration-300"
        onClick={(e) => e.stopPropagation()} // prevent closing on inner click
      >
        {sent ? (
          //  Success State: Minimal & Reassuring
          <div className="p-6 text-center">
            <div className="w-14 h-14 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <Check className="w-7 h-7 text-emerald-600" />
            </div>
            <h3 className="text-lg font-semibold text-gray-900 mb-2">Alert Sent</h3>
            <p className="text-gray-600 text-sm">
              Our safety team has been notified and is responding.
            </p>
          </div>
        ) : (
          //  Main Form: Compact & Focused
          <>
            <div className="px-5 py-4 flex items-center justify-between border-b border-gray-100">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
                  <AlertCircle className="w-5 h-5 text-red-600" />
                </div>
                <h3 className="font-semibold text-gray-900">Report an Issue</h3>
              </div>
              <button
                onClick={onClose}
                disabled={isSubmitting}
                className="text-gray-500 hover:text-gray-700 disabled:opacity-40"
              >
                <X className="w-5 h-5" />
              </button>
            </div>

            <div className="p-5">
              <p className="text-gray-600 text-sm mb-4">
                Select the most relevant issue to notify our safety team.
              </p>

              <div className="grid grid-cols-2 gap-2 max-h-60 overflow-y-auto pr-1">
                {panicOptions.map((option) => (
                  <button
                    key={option.value}
                    onClick={() => {
                        setSelected(option.value);
                        // NEW: Clear custom reason when selecting a predefined option
                        if (option.value !== 'other') {
                            setCustomReason('');
                        }
                    }}
                    disabled={isSubmitting}
                    className={`text-xs px-3 py-2.5 rounded-lg text-gray-700 transition-colors ${
                      selected === option.value
                        ? 'bg-red-100 text-red-800 border border-red-200'
                        : 'bg-gray-100 hover:bg-gray-200'
                    } disabled:opacity-50 disabled:cursor-not-allowed`}
                  >
                    {option.label}
                  </button>
                ))}
              </div>

              {/* NEW: Input field for custom reason, shown only when "Other" is selected */}
              {selected === 'other' && (
                <div className="mt-4">
                  <label htmlFor="customReason" className="block text-sm font-medium text-gray-700 mb-1">
                    Please specify:
                  </label>
                  <input
                    type="text"
                    id="customReason"
                    value={customReason}
                    onChange={(e) => setCustomReason(e.target.value)}
                    placeholder="Describe the issue..."
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 text-sm"
                    disabled={isSubmitting}
                  />
                </div>
              )}

              {submitError && (
                <div className="mt-4 p-2.5 bg-red-50 text-red-700 text-xs rounded-lg">
                  {submitError}
                </div>
              )}

              <button
                onClick={handleSubmit}
                disabled={!selected || isSubmitting} // Disable if no option selected
                className="w-full mt-5 py-3 bg-red-600 text-white rounded-xl font-medium text-sm disabled:bg-gray-300 disabled:text-gray-500 flex items-center justify-center gap-2"
              >
                {isSubmitting ? (
                  <>
                    <Loader className="w-4 h-4 animate-spin" /> Sending...
                  </>
                ) : (
                  "Send Alert"
                )}
              </button>
            </div>
          </>
        )}
      </div>
    </div>
  );
}



----- FILE: src/components/app/modals/RateModal.tsx -----
// src/components/app/modals/RateModal.tsx
import { X, Star, Check, Loader } from 'lucide-react';
import { useState } from 'react';
// NEW: Import apiClient
import { apiClient } from '@/lib/api';

interface RateModalProps {
  isOpen: boolean;
  onClose: () => void;
  // NEW: The onRate prop will now be used to potentially trigger a parent state update after API success, but the main logic is here
  onRate: (score: number, comment: string) => void;
  driverName?: string;
  // NEW: Prop to update the parent's notification state
  setNotification: (notification: { message: string; type: 'info' | 'success' | 'warning' | 'error' } | null) => void;
  // NEW: Props to receive trip ID and guest ID for the API call
  tripId: string | null;
  guestId: string | null;
  bookAsGuest: boolean;
  isAuthenticated: boolean;
}

export default function RateModal({
  isOpen,
  onClose,
  onRate, // This might be called after successful API call if parent needs to do something
  driverName = 'your driver',
  setNotification, // NEW: Destructure the new prop
  // NEW: Destructure the trip and guest ID props
  tripId,
  guestId,
  bookAsGuest,
  isAuthenticated,
}: RateModalProps) {
  const [rating, setRating] = useState(0);
  const [comment, setComment] = useState('');
  // NEW: State for submission status
  const [isSubmitting, setIsSubmitting] = useState(false);

  // NEW: Function to handle the actual API submission
  const submitRating = async () => {
    console.log("Rating: ", rating, "Trip ID: ", tripId, 'Guest ID:', guestId)

    if (rating <= 0 || !tripId || (bookAsGuest && !guestId)) {
      console.error("Cannot submit rating: missing score, tripId, or guestId.");
      setNotification({
        message: 'Missing required information. Cannot submit rating.',
        type: 'error'
      });
      return;
    }

    setIsSubmitting(true);
    try {
      // Prepare the request body
      const ratingRequestBody = {
        score: rating,
        comment: comment, // Comment is optional, so it can be an empty string
      };

      console.log("Submitting rating for trip ID:", tripId, "with payload:", ratingRequestBody);

      // NEW: Call the API using apiClient
      // Endpoint: POST /trips/{tripId}/rate
      // Requires X-Guest-Id header, so pass guestId as the fourth argument (isGuest=true is inferred by presence of guestId)
      let response;
      if(!bookAsGuest && isAuthenticated){
        response = await apiClient.post(
                  `/trips/${tripId}/rate`,
                  ratingRequestBody,
                  undefined,
                  undefined,
                  true
                );

      } else{

        response = await apiClient.post(`/trips/${guestId}/rate`, ratingRequestBody, undefined, guestId);

      }


      if (response.status === 'success') {
        console.log("Trip rated successfully:", response);
        // NEW: Close the modal
        onClose();
        // NEW: Set the success notification in the parent component via the prop
        setNotification({
          message: 'Thank you for your feedback!',
          type: 'success'
        });
        // NEW: Optionally call the parent's onRate handler if it needs to do something else (e.g., update local state, trigger other effects)
        onRate(rating, comment);
      } else {
        // Handle API error response structure (e.g., status not "success")
        console.error("Trip rating API responded with non-success status:", response);
        let errorMessage = "Failed to submit rating. Server responded unexpectedly.";
        if (response.message) {
          errorMessage = response.message;
          if (response.details) {
            const fieldErrors = [];
            for (const [field, messages] of Object.entries(response.details)) {
              if (Array.isArray(messages)) {
                fieldErrors.push(`${field}: ${messages.join(", ")}`);
              }
            }
            if (fieldErrors.length > 0) {
              errorMessage += ` Details: ${fieldErrors.join("; ")}`;
            }
          }
        }
        setNotification({
          message: response?.details?.non_field_errors?.[0] || errorMessage,
          type: 'error'
        });
      }
    } catch (err: any) {
      console.error("Error submitting trip rating:", err);
      let errorMessage = "Failed to submit rating. Please check your connection and try again.";

      if (err instanceof Error) {
        errorMessage = err.message;
      } else {
        console.error("Unexpected error type caught:", typeof err, err);
        errorMessage = 'An unexpected error occurred.';
      }
      setNotification({
        message: errorMessage,
        type: 'error'
      });
    } finally {
      setIsSubmitting(false); // Stop loading state regardless of success/error
    }
  };

  const handleSubmit = () => {
    if (rating > 0) {
      // NEW: Call the async submitRating function instead of immediately closing
      submitRating();
    }
  };

  if (!isOpen) return null;

  return (
    <div className="fixed bg-achrams-secondary-solid/50 inset-0 bg-opacity-50 flex items-end z-50 animate-fadeIn ">
      <div className="bg-white w-full max-w-sm mx-auto rounded-t-3xl p-6 animate-slideUp max-h-[90vh] overflow-y-auto">
        <div className="flex justify-between items-center mb-6">
          <h3 className="text-2xl font-bold">Rate {driverName}</h3>
          <button
            onClick={onClose}
            disabled={isSubmitting} // NEW: Disable close button while submitting
            className="disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <X className="w-6 h-6" />
          </button>
        </div>

        <div className="flex justify-center gap-2 mb-6">
          {[1, 2, 3, 4, 5].map((star) => (
            <button
              key={star}
              onClick={() => setRating(star)}
              disabled={isSubmitting} // NEW: Disable stars while submitting
              className={`transform hover:scale-110 transition ${isSubmitting ? 'cursor-not-allowed' : ''}`} // NEW: Add cursor style
            >
              <Star
                className={`w-12 h-12 ${
                  star <= rating
                    ? 'fill-yellow-400 text-yellow-400'
                    : 'text-gray-300'
                }`}
              />
            </button>
          ))}
        </div>

        <textarea
          placeholder="Share your experience (optional)"
          value={comment}
          onChange={(e) => setComment(e.target.value)}
          className="w-full px-4 py-3 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary resize-none mb-6 border border-achrams-border"
          rows={3}
          disabled={isSubmitting} // NEW: Disable textarea while submitting
        />

        <button
          onClick={handleSubmit}
          disabled={rating === 0 || isSubmitting} // NEW: Disable button while submitting or no rating selected
          className="w-full bg-achrams-primary-solid text-achrams-text-light py-4 rounded-xl font-semibold disabled:bg-gray-300 flex items-center justify-center gap-2" // NEW: Add flex classes for loader
        >
          {/* NEW: Show loader while submitting */}
          {isSubmitting ? (
            <>
              <Loader className="w-5 h-5 animate-spin" /> Submitting...
            </>
          ) : (
            "Submit"
          )}
        </button>
      </div>
    </div>
  );
}



----- FILE: src/components/app/modals/SignupPromptModal.tsx -----
// components/app/modals/SignupPromptModal.tsx
"use client"

import { X, Loader } from 'lucide-react';
import { useState, useEffect } from 'react';
import { apiClient } from '@/lib/api'; // Adjust import path as needed
import { useApiErrorHandler } from "@/lib/errors/apiErrorHandler"


// Define the type for the full signup data, including password
interface FullSignupData {
  name: string;
  email: string;
  phone: string;
  password: string;
}

interface SignupPromptModalProps {
  isOpen: boolean;
  passengerData: { name: string; email: string; phone: string }; // Initial data from booking
  onClose: () => void;
  // NEW: Prop now receives full signup data (including password) and countdown
  onVerifyEmail: (data: FullSignupData, countdown: number) => void;
  onOpenLoginModal: () => void;
}

export default function SignupPromptModal({
  isOpen,
  passengerData,
  onClose,
  onVerifyEmail, // Renamed to reflect its new purpose
  onOpenLoginModal,
}: SignupPromptModalProps) {

  const { generalError, fieldErrors, handleApiError, clearErrors } = useApiErrorHandler();

  if (!isOpen) return null;

  // --- State for user inputs ---
  const [name, setName] = useState<string>('');
  const [email, setEmail] = useState<string>('');
  const [phone, setPhone] = useState<string>('');
  const [password, setPassword] = useState<string>('');
  const [confirmPassword, setConfirmPassword] = useState<string>('');
  
  // --- State for validation errors ---
  const [nameError, setNameError] = useState<string>('');
  const [emailError, setEmailError] = useState<string>('');
  const [phoneError, setPhoneError] = useState<string>('');
  const [passwordError, setPasswordError] = useState<string>('');
  const [confirmPasswordError, setConfirmPasswordError] = useState<string>('');

  const [error, setError] = useState<string>(''); // General error
  const [loading, setLoading] = useState<boolean>(false);

  // --- Initialize local state from passengerData when modal opens ---
  useEffect(() => {
    if (isOpen) {
      setName(passengerData.name || '');
      setEmail(passengerData.email || '');
      setPhone(passengerData.phone || '');
      // Reset fields and errors when opening
      setPassword('');
      setConfirmPassword('');
      setError('');
      setNameError('');
      setEmailError('');
      setPhoneError('');
      setPasswordError('');
      setConfirmPasswordError('');
    }
  }, [isOpen, passengerData]);

  // --- Validation Functions ---
  const validateName = (input: string): string => {
    if (!input.trim()) {
      return 'Full name is required.';
    }
    if (input.trim().length < 2) {
      return 'Name must be at least 2 characters long.';
    }
    return '';
  };

  const validateEmail = (input: string): string => {
    if (!input) {
      return 'Email is required.';
    }
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(input)) {
      return 'Please enter a valid email address.';
    }
    return '';
  };

  const validatePhone = (input: string): string => {
    if (!input) {
      return 'Phone number is required.';
    }
    const digitsOnly = input.replace(/\D/g, '');
    const phoneRegex = /^(\+?234|0)?[789]\d{9}$/;
    if (!phoneRegex.test(digitsOnly)) {
      return 'Please enter a valid Nigerian phone number.';
    }
    return '';
  };

  const validatePassword = (input: string): string => {
    if (!input) {
      return 'Password is required.';
    }
    if (input.length < 8) {
      return 'Password must be at least 8 characters long.';
    }
    return '';
  };

  const validateConfirmPassword = (input: string, passwordInput: string): string => {
    if (!input) {
      return 'Please confirm your password.';
    }
    if (input !== passwordInput) {
      return 'Passwords do not match.';
    }
    return '';
  };

  // --- Handle Blur Events for validation ---
  const handleNameBlur = () => setNameError(validateName(name));
  const handleEmailBlur = () => setEmailError(validateEmail(email));
  const handlePhoneBlur = () => setPhoneError(validatePhone(phone));
  const handlePasswordBlur = () => {
    setPasswordError(validatePassword(password));
    if (confirmPassword) setConfirmPasswordError(validateConfirmPassword(confirmPassword, password));
  };
  const handleConfirmPasswordBlur = () => setConfirmPasswordError(validateConfirmPassword(confirmPassword, password));

  // --- Handle Input Changes ---
  const handleNameChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setName(e.target.value);
    if (nameError) setNameError('');
  };
  const handleEmailChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setEmail(e.target.value);
    if (emailError) setEmailError('');
  };
  const handlePhoneChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setPhone(e.target.value);
    if (phoneError) setPhoneError('');
  };
  const handlePasswordChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setPassword(e.target.value);
    if (passwordError) setPasswordError('');
    if (confirmPasswordError) setConfirmPasswordError('');
  };
  const handleConfirmPasswordChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setConfirmPassword(e.target.value);
    if (confirmPasswordError) setConfirmPasswordError('');
  };

  const handleRegister = async () => {
    setError('');
    setNameError('');
    setEmailError('');
    setPhoneError('');
    setPasswordError('');
    setConfirmPasswordError('');

    const nameErr = validateName(name);
    const emailErr = validateEmail(email);
    const phoneErr = validatePhone(phone);
    const passwordErr = validatePassword(password);
    const confirmPasswordErr = validateConfirmPassword(confirmPassword, password);

    setNameError(nameErr);
    setEmailError(emailErr);
    setPhoneError(phoneErr);
    setPasswordError(passwordErr);
    setConfirmPasswordError(confirmPasswordErr);

    if (nameErr || emailErr || phoneErr || passwordErr || confirmPasswordErr) {
      return;
    }
    
    clearErrors();

    setLoading(true);
    try {
      const nameParts = name.trim().split(/\s+/);
      const firstName = nameParts[0] || 'User';
      const lastName = nameParts.slice(1).join(' ') || '';

      const response = await apiClient.post('/auth/passenger/onboard/initiate', {
        email: email,
        phone_number: phone,
        first_name: firstName,
        last_name: lastName,
        password: password, // Include password in the request
      });

      console.log("Registration Initiate Response:", response);

      if (response.status === "success" && response.data) {
        const countdown = response.data.countdown;
        if (typeof countdown === 'number') {

          console.log('countdown :', response.data.countdown)
          console.log('Passenger Data ', {name, email,phone,password})

          //showNotification(response.message)
            // NEW: Call the prop with the full signup data (including password) and countdown
            onVerifyEmail({ name, email, phone, password }, countdown);
            onClose(); // Close this modal after calling the prop
        } else {

          handleApiError({status: "error", message: "Invalid countdown received from server."})
            // setError('Invalid countdown received from server.');
        }
      } else {
        handleApiError(response);
        // setError(response.details?.phone_number?.[0] ||response.details?.email?.[0] || response.message || 'Registration initiation failed. Please try again.');
      }
    } catch (err: any) {
      console.error("Registration Initiate Error:", err);

      handleApiError(err);
      // let errorMessage = 'An unexpected error occurred.';
      // if (err.response?.data?.message) {
      //   errorMessage = err.response.data.message;
      // } else if (err.message) {
      //   errorMessage = err.message;
      // }
      // setError(errorMessage);
    } finally {
      setLoading(false);
    }
  };

  const isSubmitDisabled = loading ||
                          !name || !email || !phone || !password || !confirmPassword ||
                          !!nameError || !!emailError || !!phoneError || !!passwordError || !!confirmPasswordError;

  return (
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 bg-opacity-70 flex items-end z-50">
      <div className="bg-white w-full max-w-sm mx-auto rounded-t-3xl p-6 animate-slideUp max-h-[85vh] overflow-y-auto border-t border-achrams-border">
        <div className="flex justify-between items-center mb-2">
          <h3 className="text-xl font-bold text-achrams-text-primary">Create your account</h3>
          <button
            onClick={onClose}
            disabled={loading}
            className="text-achrams-text-secondary hover:text-achrams-text-primary transition-colors disabled:opacity-50"
          >
            <X className="w-6 h-6" />
          </button>
        </div>
        <p className="text-achrams-text-secondary mb-6">Sign up to save your trips and preferences</p>

        {/* Editable Input Fields with Validation */}
        <div className="space-y-4 mb-4">
          <div className="relative">
            <input
              type="text"
              placeholder="Full Name"
              value={name}
              onChange={handleNameChange}
              onBlur={handleNameBlur}
              disabled={loading}
              className={`w-full px-4 py-3 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border ${
                nameError || fieldErrors.first_name?.[0] || fieldErrors.name?.[0] ? 'border-red-500' : 'border-achrams-border'
              }`}
            />
            {(fieldErrors.first_name?.[0] || fieldErrors.name?.[0]) && <p className="text-red-500 text-xs mt-1">{fieldErrors.first_name?.[0] || fieldErrors.name?.[0]}</p>}
            {nameError && !fieldErrors.first_name && !fieldErrors.name && <p className="text-red-500 text-xs mt-1">{nameError}</p>} {/* Show client-side only if no API error */}
            {/* {nameError && <p className="text-red-500 text-xs mt-1">{nameError}</p>} */}
          </div>
          <div className="relative">
            <input
              type="email"
              placeholder="Email Address"
              value={email}
              onChange={handleEmailChange}
              onBlur={handleEmailBlur}
              disabled={loading}
              className={`w-full px-4 py-3 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border ${
                emailError || fieldErrors.email?.[0] ? 'border-red-500' : 'border-achrams-border'
              }`}
            />
            {fieldErrors.email?.[0] && <p className="text-red-500 text-xs mt-1">{fieldErrors.email[0]}</p>}
            {emailError && !fieldErrors.email && <p className="text-red-500 text-xs mt-1">{emailError}</p>} {/* Show client-side only if no API error */}

            {/* {emailError && <p className="text-red-500 text-xs mt-1">{emailError}</p>} */}
          </div>
          <div className="relative">
            <input
              type="tel"
              placeholder="Phone Number"
              value={phone}
              onChange={handlePhoneChange}
              onBlur={handlePhoneBlur}
              disabled={loading}
              className={`w-full px-4 py-3 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border ${
                phoneError  || fieldErrors.phone_number?.[0]  ? 'border-red-500' : 'border-achrams-border'
              }`}
            />
            {fieldErrors.phone_number?.[0] && <p className="text-red-500 text-xs mt-1">{fieldErrors.phone_number[0]}</p>}
            {phoneError && !fieldErrors.phone_number && <p className="text-red-500 text-xs mt-1">{phoneError}</p>} 
            {/* {phoneError && <p className="text-red-500 text-xs mt-1">{phoneError}</p>} */}
          </div>
        </div>

        {/* Password Fields with Validation */}
        <div className="space-y-4 mb-4">
          <div className="relative">
            <input
              type="password"
              placeholder="Password"
              value={password}
              onChange={handlePasswordChange}
              onBlur={handlePasswordBlur}
              disabled={loading}
              className={`w-full px-4 py-3 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border ${
                passwordError || fieldErrors.password?.[0] ? 'border-red-500' : 'border-achrams-border'
              }`}
            />
            {fieldErrors.password?.[0] && <p className="text-red-500 text-xs mt-1">{fieldErrors.password[0]}</p>}
            {passwordError && !fieldErrors.password && <p className="text-red-500 text-xs mt-1">{passwordError}</p>} 

            {/* {passwordError && <p className="text-red-500 text-xs mt-1">{passwordError}</p>} */}
          </div>
          <div className="relative">
            <input
              type="password"
              placeholder="Confirm Password"
              value={confirmPassword}
              onChange={handleConfirmPasswordChange}
              onBlur={handleConfirmPasswordBlur}
              disabled={loading}
              className={`w-full px-4 py-3 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border ${
                confirmPasswordError ? 'border-red-500' : 'border-achrams-border'
              }`}
            />
            {confirmPasswordError && <p className="text-red-500 text-xs mt-1">{confirmPasswordError}</p>}
          </div>
        </div>

        {/* General Error Message Display */}

        {generalError && (
          <p className="text-red-500 text-sm mb-2">{generalError}</p>
        )}

        {/* {error && (
          <p className="text-red-500 text-sm mb-2">{error}</p>
        )} */}

        <button
          onClick={handleRegister}
          disabled={isSubmitDisabled}
          className={`w-full py-4 rounded-xl font-semibold mt-2 transition-all ${
            isSubmitDisabled
              ? 'bg-achrams-secondary-solid text-achrams-text-light opacity-75 cursor-not-allowed'
              : 'bg-achrams-gradient-primary text-achrams-text-light hover:opacity-90 active:scale-[0.98]'
          }`}
        >
          {loading ? (
            <div className="flex items-center justify-center">
              <Loader className="w-5 h-5 animate-spin mr-2" />
              Creating...
            </div>
          ) : (
            'Create account'
          )}
        </button>

        {/* Sign In Link */}
        <div className="mt-4 text-center">
          <button
            onClick={() => {
              onClose();
              onOpenLoginModal();
            }}
            className="text-sm text-achrams-primary-solid hover:underline"
          >
            Already have an account? Sign In
          </button>
        </div>

        <button
          onClick={onClose}
          disabled={loading}
          className="w-full mt-4 text-achrams-text-secondary font-medium hover:text-achrams-text-primary transition-colors disabled:opacity-50"
        >
          Not now
        </button>
      </div>
    </div>
  );
}



----- FILE: src/components/app/modals/ComingSoonModal.tsx -----
// src/components/app/modals/ComingSoonModal.tsx
import { X, Phone, Mail, Plane, Utensils, Headphones, Bell, CreditCard, Shield } from 'lucide-react';


interface ComingSoonModalProps {
  isOpen: boolean;
  onClose: () => void;
  feature: 'hotels' | 'restaurant' | 'support' | 'alerts' | 'wallet' | 'payment' | 'security';
  showNotification?: (message: string, type: "info" | "success" | "warning" | "error") => void; // Optional, for wallet
}

export default function ComingSoonModal({
  isOpen,
  onClose,
  feature,
  showNotification,
}: ComingSoonModalProps) {
  if (!isOpen) return null;

  // Determine title, icon, and description based on the feature
  let title = '';
  let IconComponent: React.FC<{ className?: string }> = () => null; // Placeholder
  let description = '';
  let contactInfo = '';

  console.log(feature);
  switch (feature) {
    
    case 'hotels':
      title = 'Hotels';
      IconComponent = Plane; // Or consider a BedHotel icon if available
      description = 'Book your stay at premium hotels seamlessly through our platform.';
      break;
    case 'restaurant':
      title = 'Restaurant';
      IconComponent = Utensils;
      description = 'Order from top-rated restaurants and get it delivered.';
      break;
    case 'support':
      title = 'Support';
      IconComponent = Headphones;
      description = 'Need assistance? Get in touch with our support team.';
      contactInfo = `Phone: +234 800 ACHRAMS\nEmail: support@achrams.com.ng`;
      break;
    case 'alerts':
      title = 'Alerts';
      IconComponent = Bell;
      description = 'Stay informed with important updates and notifications.';
      break;
    case 'wallet':
      title = 'Wallet';
      IconComponent = CreditCard; // Or Wallet icon
      description = 'Manage your funds and view transaction history.';
      // Optionally, trigger a notification or redirect if showNotification is provided
      if (showNotification) {
        showNotification("Wallet feature coming soon!", "info");
        // Or potentially navigate to a wallet page if it exists but is under construction
        // router.push('/wallet'); // Example if wallet page exists but is under construction
      }
      break;
    case 'payment':
      title = 'Payment Methods';
      IconComponent = CreditCard;
      description = 'Add and manage your preferred payment methods.';
      break;
    case 'security':
      title = 'Security Settings';
      IconComponent = Shield;
      description = 'Manage your account security and privacy settings.';
      break;
    default:
      title = 'Coming Soon';
      IconComponent = Plane; // Default icon
      description = 'This feature is coming soon!';
  }

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center">
      {/* Backdrop */}
      <div
        className="absolute inset-0 bg-black/50"
        onClick={onClose}
      />
      
      {/* Modal Content */}
      <div className="relative bg-white w-full max-w-sm mx-4 rounded-2xl shadow-xl overflow-hidden border border-achrams-border">
        {/* Header */}
        <div className="bg-gradient-to-r from-achrams-primary-solid to-achrams-secondary-solid text-achrams-text-light px-6 py-5 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center">
              <IconComponent className="w-6 h-6 text-achrams-text-light" />
            </div>
            <h2 className="text-xl font-bold">{title}</h2>
          </div>
          <button
            onClick={onClose}
            className="text-achrams-text-light hover:text-achrams-text-light/80 p-2 hover:bg-white/10 rounded-lg transition-colors"
            aria-label="Close"
          >
            <X className="w-6 h-6" />
          </button>
        </div>

        {/* Body */}
        <div className="p-6">
          <p className="text-achrams-text-secondary text-center mb-4">
            {description}
          </p>

          {contactInfo && (
            <div className="bg-achrams-bg-secondary rounded-xl p-4 border border-achrams-border mb-4">
              <h3 className="font-bold text-achrams-text-primary mb-2 text-center">Contact Support</h3>
              <div className="text-sm text-achrams-text-secondary space-y-1">
                <p className="flex items-center justify-center gap-2">
                  <Phone className="w-4 h-4" /> {/* Assuming Phone icon is imported */}
                  +234 800 ACHRAMS
                </p>
                <p className="flex items-center justify-center gap-2">
                  <Mail className="w-4 h-4" /> {/* Assuming Mail icon is imported */}
                  support@achrams.com.ng
                </p>
              </div>
            </div>
          )}
          {
            (feature === 'hotels' || feature === 'restaurant')
             &&(
                <div className="bg-achrams-primary-solid/10 border border-achrams-primary-solid/20 rounded-xl p-4 text-center">
            <p className="text-achrams-text-secondary text-sm">
              We're working hard to bring this feature to you. Stay tuned!
            </p>
          </div>
            )
          }
        
        </div>

        {/* Footer */}
        <div className="p-4 bg-achrams-bg-secondary border-t border-achrams-border">
          <button
            onClick={onClose}
            className="w-full py-3 bg-achrams-primary-solid text-achrams-text-light rounded-xl font-medium hover:opacity-90 active:scale-[0.98] transition-all"
          >
            Got it
          </button>
        </div>
      </div>
    </div>
  );
}

// Add imports for Phone and Mail if not already in the file


----- FILE: src/components/app/modals/OTPModal.tsx -----
// src/components/app/modals/OTPModal.tsx
import { useState, useEffect, useRef } from 'react';
import { X, Check, MailCheck, Loader } from 'lucide-react'; // Added MailCheck, Loader icons
import { apiClient } from '@/lib/api'; // Import your apiClient

// Define the type for the full signup data, including password
interface FullSignupData {
  name: string;
  email: string;
  phone: string;
  password: string;
}

export default function OTPModal({
  isOpen,
  // NEW: Receive the full signup data from page.tsx
  initialSignupData,
  // NEW: Receive the initial countdown from page.tsx
  initialOtpCountdown,
  // NEW: Receive the function to resend OTP from page.tsx
  onResendOtp,
  onComplete, // This should now trigger the success flow (e.g., setScreen('dashboard'))
  onClose,
}: {
  isOpen: boolean;
  initialSignupData: FullSignupData; // NEW: Initial data for confirmation/resend
  initialOtpCountdown: number; // NEW: Initial countdown value in seconds
  onResendOtp: (data: FullSignupData) => Promise<number>; // NEW: Function to call the initiate endpoint again
  onComplete: () => void;
  onClose: () => void;
}) {
  const [otp, setOtp] = useState(['', '', '', '', '', '']); // Changed to 6 digits
  const [verified, setVerified] = useState(false);
  const [loading, setLoading] = useState(false); // Loading state for API call
  const [apiError, setApiError] = useState(''); // Error state for API call
  // NEW: State for countdown
  const [timeLeft, setTimeLeft] = useState(initialOtpCountdown);
  const [isExpired, setIsExpired] = useState(false);
  // NEW: Store the signup data locally within the modal
  const [signupData] = useState(initialSignupData);
  const inputRefs = useRef<(HTMLInputElement | null)[]>([]);
  const countdownIntervalRef = useRef<NodeJS.Timeout | null>(null); // Ref to hold the interval ID

  // NEW: Function to format seconds into MM:SS
  const formatTime = (seconds: number): string => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  };

  // NEW: Effect to handle countdown logic
  useEffect(() => {
    if (isOpen && initialOtpCountdown > 0 && !verified && !isExpired) {
      // Reset timeLeft when modal opens with a new countdown
      setTimeLeft(initialOtpCountdown);
      setIsExpired(false);

      // Clear any existing interval
      if (countdownIntervalRef.current) {
        clearInterval(countdownIntervalRef.current);
      }

      // Start the countdown
      countdownIntervalRef.current = setInterval(() => {
        setTimeLeft(prev => {
          if (prev <= 1) {
            if (countdownIntervalRef.current) {
              clearInterval(countdownIntervalRef.current);
            }
            setIsExpired(true); // Set expired state
            setApiError('OTP has expired. Please request a new one.');
            return 0;
          }
          return prev - 1;
        });
      }, 1000);
    }

    // Cleanup on unmount, close, or when verified/expired
    return () => {
      if (countdownIntervalRef.current) {
        clearInterval(countdownIntervalRef.current);
        countdownIntervalRef.current = null;
      }
    };
  }, [isOpen, initialOtpCountdown, verified, isExpired]); // Depend on these values

  // Effect to reset state when modal closes
  useEffect(() => {
    if (!isOpen) {
      setOtp(['', '', '', '', '', '']); // Reset to 6 empty strings
      setVerified(false);
      setApiError('');
      setLoading(false);
      // Time state is managed by the main countdown effect
    }
  }, [isOpen]);

  // NEW: Function to submit the OTP
  const submitOtp = async (otpCode: string) => {
    if (isExpired || loading) { // Prevent submission if expired or already loading
        setApiError('OTP has expired or request is pending.');
        return;
    }
    setLoading(true);
    setApiError(''); // Clear previous errors
    try {
      const nameParts = initialSignupData.name.trim().split(/\s+/);
      const firstName = nameParts[0] || 'User';
      const lastName = nameParts.slice(1).join(' ') || '';

      console.log('Otp signupData declared in local state of otp modal from the initialSignupData prop: ', signupData)
      console.log('initial signup data passed down to otp modal', initialSignupData)

      const response = await apiClient.post('/auth/passenger/onboard/confirm', {
        email: initialSignupData.email, // Use data from stored signupData
        phone_number: initialSignupData.phone, // Use data from stored signupData
        first_name: firstName, // Use data from stored signupData
        last_name: lastName, // Use data from stored signupData
        password: initialSignupData.password, // Use data from stored signupData
        otp: otpCode, // Add the user-inputted OTP
      });

      console.log("OTP Confirmation Response:", response);

      if (response.status === "success" && response.data?.token) {
        // Store the received token in your auth context or local storage
        if (typeof window !== 'undefined') {
            localStorage.setItem('authToken', response.data.token);
            if(response.data.refresh) {
                localStorage.setItem('refreshToken', response.data.refresh);
            }
        }

        // Clear the countdown interval on success
        if (countdownIntervalRef.current) {
            clearInterval(countdownIntervalRef.current);
            countdownIntervalRef.current = null;
        }

        setVerified(true);
        setTimeout(() => {
          onComplete(); // This triggers the flow back in page.tsx
        }, 1000);
      } else {
        setApiError(response.message || 'OTP verification failed. Please try again.');
        setVerified(false);
      }
    } catch (err: any) {
      console.error("OTP Confirmation Error:", err);
      let errorMessage = 'An unexpected error occurred.';
      if (err.response?.data?.message) {
        errorMessage = err.response.data.message;
      } else if (err.message) {
        errorMessage = err.message;
      }
      setApiError(errorMessage);
      setVerified(false);
    } finally {
      setLoading(false);
    }
  };

  const handleOtpChange = (index: number, value: string) => {
    if (loading || isExpired) return; // Prevent input while loading or expired
    if (!/^\d*$/.test(value) || value.length > 1) return;

    const newOtp = [...otp];
    newOtp[index] = value;
    setOtp(newOtp);

    if (value && index < otp.length - 1) { // Focus next input, handle 6 digits
      inputRefs.current[index + 1]?.focus();
    }

    // Check if OTP is completely filled (6 digits now)
    if (newOtp.every((d) => d !== '') && newOtp.join('').length === 6) {
      console.log('newotp, ', newOtp)
      submitOtp(newOtp.join(''));
    }
  };

  // NEW: Function to handle OTP resend
  const handleResendOtp = async () => {
    if (loading || !isExpired) { // Only allow resend if expired or maybe always, depending on UX choice
        // If allowing resend anytime, remove the `!isExpired` check or add a cooldown timer
        if (!isExpired) {
            setApiError('A code is still active. Please wait for it to expire or try again later.');
            return;
        }
        // If expired, allow resend
    }
    setLoading(true);
    setApiError(''); // Clear previous errors
    try {
        console.log("Attempting to resend OTP for email:", signupData.email);
        // Call the parent function which handles the API call to initiate, passing the stored signupData
        const newCountdown = await onResendOtp(initialSignupData);

        if (typeof newCountdown === 'number' && newCountdown > 0) {
            // Reset the countdown state with the new value
            setTimeLeft(newCountdown);
            setIsExpired(false);
            setApiError('New OTP sent successfully.'); // Inform user
            setOtp(['', '', '', '', '', '']); // Clear the old OTP inputs

             // Clear any existing interval
            if (countdownIntervalRef.current) {
                clearInterval(countdownIntervalRef.current);
            }

            // Start the countdown again
            countdownIntervalRef.current = setInterval(() => {
                setTimeLeft(prev => {
                if (prev <= 1) {
                    if (countdownIntervalRef.current) {
                    clearInterval(countdownIntervalRef.current);
                    }
                    setIsExpired(true); // Set expired state
                    setApiError('OTP has expired. Please request a new one.');
                    return 0;
                }
                return prev - 1;
                });
            }, 1000);

        } else {
            setApiError('Failed to resend OTP. Please try again.');
        }
    } catch (err: any) {
        console.error("Resend OTP Error:", err);
        let errorMessage = 'An unexpected error occurred while resending OTP.';
        if (err.response?.data?.message) {
            errorMessage = err.response.data.message;
        } else if (err.message) {
            errorMessage = err.message;
        }
        setApiError(errorMessage);
    } finally {
        setLoading(false);
    }
  };

  if (!isOpen) return null;

  if (verified) {
    return (
      <div className="fixed inset-0 bg-achrams-secondary-solid/50 flex items-end z-50">
        <div className="bg-white  w-full max-w-sm mx-auto rounded-t-3xl p-6 animate-slideUp text-center border-t border-achrams-border">
          <div className="w-16 h-16 bg-achrams-bg-secondary rounded-full flex items-center justify-center mx-auto mb-4 border border-achrams-border">
            <Check className="w-8 h-8 text-achrams-primary-solid" />
          </div>
          <h3 className="text-xl font-bold mb-2 text-achrams-text-primary">Email verified!</h3>
          <p className="text-achrams-text-secondary">Setting up your account...</p>
        </div>
      </div>
    );
  }

  return (
    // Input state modal
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 flex items-end z-50">
      <div className="bg-white w-full max-w-sm mx-auto rounded-t-3xl p-6 animate-slideUp border-t border-achrams-border">
        <div className="flex justify-between items-center mb-2">
          <h3 className="text-xl font-bold text-achrams-text-primary text-center  mx-auto" >Verify your email</h3>
          <button
            onClick={onClose}
            disabled={loading || isExpired} // Disable during API call or if expired
            className="text-achrams-text-secondary hover:text-achrams-text-primary transition-colors disabled:opacity-50"
          >
            <X className="w-6 h-6" />
          </button>
        </div>
        <p className="text-achrams-text-secondary mb-8 mx-auto w-fit">Enter the 6-digit code sent to <span className="font-medium text-achrams-text-primary">{signupData.email}</span></p>

        {/* NEW: Display countdown timer */}
        <div className="text-center mb-4">
            <p className="text-achrams-text-secondary text-sm">
                Code expires in: <span className={`font-mono ${isExpired ? 'text-red-500' : 'text-achrams-text-primary'}`}>{formatTime(timeLeft)}</span>
            </p>
        </div>

        <div className="flex gap-3 justify-center mb-8">
          {otp.map((_, idx) => (
            <input
              key={idx}
              ref={(el) => (inputRefs.current[idx] = el)}
              type="text"
              inputMode="numeric"
              maxLength={1}
              value={otp[idx]}
              onChange={(e) => handleOtpChange(idx, e.target.value)}
              disabled={loading || isExpired} // Disable during API call or if expired
              className={`w-12 h-12 text-center text-2xl font-bold bg-achrams-bg-secondary border-2 rounded-xl outline-none text-achrams-text-primary focus:ring-1 focus:ring-achrams-primary-solid ${
                apiError ? 'border-red-500' : 'border-achrams-border focus:border-achrams-primary-solid'
              }`}
            />
          ))}
        </div>
        {/* Display API error or expiration error */}
        {(apiError || isExpired) && (
          <p className="text-red-500 text-sm mb-2 text-center">{apiError || 'OTP has expired.'}</p>
        )}
        <button
          onClick={handleResendOtp}
          disabled={loading} // Disable resend if loading, maybe also if not expired (depending on UX)
          className={`w-full text-center text-achrams-text-secondary font-medium hover:text-achrams-text-primary transition-colors ${
              loading ? 'opacity-50 cursor-not-allowed' : ''
          }`}
        >
          {loading ? ( // Show loading indicator while resending
            <div className="flex items-center justify-center">
              <Loader className="w-4 h-4 animate-spin mr-2" />
              Sending...
            </div>
          ) : (
            'Resend code'
          )}
        </button>
        <button
          onClick={onClose}
          disabled={loading || isExpired} // Disable during API call or if expired
          className="w-full mt-3 text-sm text-achrams-text-secondary font-medium hover:text-achrams-text-primary transition-colors disabled:opacity-50"
        >
          Cancel
        </button>
      </div>
    </div>
  );
}


----- FILE: src/components/app/modals/AccountDeletionModal.tsx -----
// src/components/app/modals/AccountDeletionModal.tsx
import { useState } from 'react';
import { X, AlertCircle, Loader2 } from 'lucide-react';
import { apiClient } from '@/lib/api';

interface AccountDeletionModalProps {
  isOpen: boolean;
  onClose: () => void;
  onConfirm: () => void; // Callback to handle successful deletion in parent
  showNotification: (message: string, type: "info" | "success" | "warning" | "error") => void;
}

export default function AccountDeletionModal({
  isOpen,
  onClose,
  onConfirm,
  showNotification,
}: AccountDeletionModalProps) {
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  const handleDeleteAccount = async () => {
    if (!password) {
      setError("Please enter your password to confirm.");
      return;
    }

    setLoading(true);
    setError('');
    try {
      // Note: The DELETE endpoint typically doesn't require a request body
      // but the API might require authentication via headers/cookies
      const response = await apiClient.delete('/auth/passenger/me', undefined, undefined, true); // isAuthRequest=true

      console.log("Delete account response:", response);
      if (response.status === "success") {
        showNotification("Account deleted successfully.", "success");
        onConfirm(); // Trigger parent logic (e.g., logout)
      } else {
        setError(response.message || "Failed to delete account.");
        showNotification(response.message || "Failed to delete account.", "error");
      }
    } catch (err: any) {
      console.error("Error deleting account:", err);
      setError(err.response?.data?.message || "An error occurred while deleting your account.");
      showNotification(err.response?.data?.message || "An error occurred while deleting your account.", "error");
    } finally {
      setLoading(false);
    }
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 flex items-center justify-center z-50">
      <div className="bg-white w-full max-w-sm mx-auto rounded-2xl p-6 border border-achrams-border shadow-lg">
        <div className="flex items-start gap-3 mb-4">
          <div className="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0">
            <AlertCircle className="w-5 h-5 text-red-600" />
          </div>
          <div>
            <h3 className="text-lg font-bold text-achrams-text-primary">Delete Account</h3>
            <p className="text-achrams-text-secondary text-sm">
              This action is permanent and cannot be undone. All your data will be lost.
            </p>
          </div>
        </div>

        <div className="p-3 bg-red-50 rounded-xl border border-red-200 mb-4">
          <p className="text-red-700 text-sm">
            To confirm, please enter your password below. This is to ensure you are the account owner.
          </p>
        </div>

        <div className="mb-4">
          <label className="block text-sm text-achrams-text-secondary font-medium mb-1">Password</label>
          <input
            type="password"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            className="w-full p-3 bg-achrams-bg-secondary border border-achrams-border rounded-xl outline-none text-achrams-text-primary focus:ring-1 focus:ring-achrams-primary-solid focus:border-achrams-primary-solid"
            placeholder="Enter your password"
            disabled={loading}
          />
          {error && <p className="text-red-500 text-sm mt-1">{error}</p>}
        </div>

        <div className="flex gap-3">
          <button
            onClick={onClose}
            disabled={loading}
            className="flex-1 py-3 bg-gray-100 text-achrams-text-primary rounded-xl font-medium hover:bg-gray-200 active:scale-[0.98] transition-all disabled:opacity-50"
          >
            Cancel
          </button>
          <button
            onClick={handleDeleteAccount}
            disabled={loading}
            className={`flex-1 py-3 bg-red-600 text-white rounded-xl font-medium hover:opacity-90 active:scale-[0.98] transition-all ${
              loading ? 'opacity-50 cursor-not-allowed' : ''
            }`}
          >
            {loading ? (
              <div className="flex items-center justify-center">
                <Loader2 className="w-4 h-4 animate-spin mr-2" />
                Deleting...
              </div>
            ) : (
              'Delete Account'
            )}
          </button>
        </div>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/MessageWindowModal.tsx -----
// src/components/app/modals/MessageWindowModal.tsx
import { X, Send } from 'lucide-react';
import { useState } from 'react';

interface MessageWindowModalProps {
  isOpen: boolean;
  onClose: () => void;
  recipientName: string;
}

export default function MessageWindowModal({
  isOpen,
  onClose,
  recipientName,
}: MessageWindowModalProps) {
  const [message, setMessage] = useState('');

  const sendMessage = () => {
    if (message.trim()) {
      // In real app: call /messages or WebSocket
      console.log('Message sent to', recipientName, ':', message);
      setMessage('');
    }
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 z-50 animate-fadeIn">
      <div className="h-full flex flex-col">
        <div className="bg-achrams-primary-solid text-white px-6 py-4 flex items-center justify-between">
          <h2 className="text-xl font-bold">Message {recipientName}</h2>
          <button onClick={onClose}>
            <X className="w-6 h-6" />
          </button>
        </div>

        <div className="flex-1 p-4 bg-gray-100 overflow-y-auto">
          {/* Example message history */}
          <div className="bg-white rounded-2xl p-4 mb-4 max-w-xs ml-auto">
            <p className="text-sm">Hi, Im outside!</p>
          </div>
          <div className="bg-gray-200 rounded-2xl p-4 mb-4 max-w-xs">
            <p className="text-sm">OK, coming down now.</p>
          </div>
        </div>

        <div className="p-4 border-t bg-white">
          <div className="flex gap-3">
            <input
              type="text"
              value={message}
              onChange={(e) => setMessage(e.target.value)}
              placeholder="Type a message..."
              className="flex-1 px-4 py-3 bg-gray-100 rounded-full outline-none"
              onKeyDown={(e) => e.key === 'Enter' && sendMessage()}
            />
            <button
              onClick={sendMessage}
              disabled={!message.trim()}
              className="p-3 bg-achrams-primary-solid text-white rounded-full disabled:opacity-50"
            >
              <Send className="w-5 h-5" />
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/LoginOTPModal.tsx -----
// src/components/app/modals/LoginOTPModal.tsx

import { useState, useEffect, useRef } from 'react';
import { X, Check, ShieldCheck, Loader } from 'lucide-react'; // Use ShieldCheck for 2FA

export default function LoginOTPModal({
  isOpen,
  onClose,
  onSubmit, // Function to call when OTP is submitted
  email, // Email to display in the modal
  showNotification,
}: {
  isOpen: boolean;
  onClose: () => void;
  onSubmit: (otp: string) => void; // Function to submit the OTP code
  email: string; // Email address for display
  showNotification: (message: string, type: "info" | "success" | "warning" | "error") => void;
}) {
  const [otp, setOtp] = useState(['', '', '', '', '', '']); // 6-digit OTP
  const [loading, setLoading] = useState(false); // Loading state for submission
  const [apiError, setApiError] = useState(''); // Error state for API call
  const inputRefs = useRef<(HTMLInputElement | null)[]>([]);

  // Effect to reset state when modal closes
  useEffect(() => {
    if (!isOpen) {
      setOtp(['', '', '', '', '', '']);
      setApiError('');
      setLoading(false);
    }
  }, [isOpen]);

  const handleOtpChange = (index: number, value: string) => {
    if (loading) return; // Prevent input while loading
    if (!/^\d*$/.test(value) || value.length > 1) return;

    const newOtp = [...otp];
    newOtp[index] = value;
    setOtp(newOtp);

    if (value && index < otp.length - 1) { // Focus next input
      inputRefs.current[index + 1]?.focus();
    }

    // Check if OTP is completely filled
    if (newOtp.every((d) => d !== '') && newOtp.join('').length === 6) {
      handleSubmitOtp(newOtp.join(''));
    }
  };

  const handleSubmitOtp = async (otpCode: string) => {
    if (loading) return; // Prevent double submission
    setLoading(true);
    setApiError(''); // Clear previous errors
    try {
      // Call the parent function to handle the submission
      await onSubmit(otpCode);
    } catch (err: any) {
      console.error("Login OTP Submission Error:", err);
      let errorMessage = 'An unexpected error occurred.';
      if (err.message) {
        errorMessage = err.message;
      }
      setApiError(errorMessage);
    } finally {
      setLoading(false);
    }
  };

  const handleResendOtp = () => {
    // 2FA codes are usually not resent easily, often require re-logging in or using backup codes
    // For simplicity in this flow, maybe just inform the user or allow re-login
    showNotification("OTP codes for login are typically not resent. Please try logging in again.", "info");
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 flex items-end z-50">
      <div className="bg-white w-full max-w-sm mx-auto rounded-t-3xl p-6 animate-slideUp border-t border-achrams-border">
        <div className="flex justify-between items-center mb-2">
          <h3 className="text-xl font-bold text-achrams-text-primary text-center mx-auto">Verify 2FA</h3>
          <button
            onClick={onClose}
            disabled={loading} // Disable during API call
            className="text-achrams-text-secondary hover:text-achrams-text-primary transition-colors disabled:opacity-50"
          >
            <X className="w-6 h-6" />
          </button>
        </div>
        <p className="text-achrams-text-secondary mb-8 mx-auto w-fit">
          Enter the 6-digit code from your authenticator app or sent to <span className="font-medium text-achrams-text-primary">{email}</span>
        </p>

        <div className="flex gap-3 justify-center mb-8">
          {otp.map((_, idx) => (
            <input
              key={idx}
              ref={(el) => (inputRefs.current[idx] = el)}
              type="text"
              inputMode="numeric"
              maxLength={1}
              value={otp[idx]}
              onChange={(e) => handleOtpChange(idx, e.target.value)}
              disabled={loading} // Disable during API call
              className={`w-12 h-12 text-center text-2xl font-bold bg-achrams-bg-secondary border-2 rounded-xl outline-none text-achrams-text-primary focus:ring-1 focus:ring-achrams-primary-solid ${
                apiError ? 'border-red-500' : 'border-achrams-border focus:border-achrams-primary-solid'
              }`}
            />
          ))}
        </div>
        {/* Display API error */}
        {apiError && (
          <p className="text-red-500 text-sm mb-2 text-center">{apiError}</p>
        )}
        <button
          onClick={() => handleSubmitOtp(otp.join(''))} // Submit current OTP
          disabled={loading || otp.some(d => d === '')} // Disable if loading or OTP not filled
          className={`w-full py-3 bg-achrams-primary-solid text-achrams-text-light rounded-xl font-medium hover:opacity-90 active:scale-[0.98] transition-all ${
            loading || otp.some(d => d === '') ? 'opacity-50 cursor-not-allowed' : ''
          }`}
        >
          {loading ? (
            <div className="flex items-center justify-center">
              <Loader className="w-4 h-4 animate-spin mr-2" />
              Verifying...
            </div>
          ) : (
            'Verify'
          )}
        </button>
        <button
          onClick={handleResendOtp}
          className="w-full mt-3 text-sm text-achrams-text-secondary font-medium hover:text-achrams-text-primary transition-colors"
        >
          Didn't receive a code?
        </button>
        <button
          onClick={onClose}
          disabled={loading} // Disable during API call
          className="w-full mt-3 text-sm text-achrams-text-secondary font-medium hover:text-achrams-text-primary transition-colors disabled:opacity-50"
        >
          Cancel
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/TripHistoryModal.tsx -----
// src/components/app/modals/TripHistoryModal.tsx
import { useState, useEffect } from "react";
import { Clock, MapPin, Wallet, Star, X, Loader } from "lucide-react";
import { apiClient } from "@/lib/api";
import { Driver } from "@/types/passenger";

interface Trip {
  id: string;
  amount: {
    formatted: string;
    currency: string;
    amount: number;
  };
  status: {
    label: string;
    value: string;
  };
  pickup_address: string;
  destination_address: string;
  verification_code: string;
  rating: { score: number; comment: string } | null;
  map_data?: {
    airport?: any;
    pickup_location?: any;
    destination_location?: any;
  };
  driver?: Driver;
  created_at: string;
}

interface TripHistoryModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSelectTrip?: (tripId: string) => void;
  showNotification: (message: string, type: "info" | "success" | "warning" | "error") => void;
}

export default function TripHistoryModal({
  isOpen,
  onClose,
  onSelectTrip,
  showNotification,
}: TripHistoryModalProps) {
  const [trips, setTrips] = useState<Trip[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [page, setPage] = useState(1);
  const [hasMore, setHasMore] = useState(true);
  const limit = 10;

  const fetchTrips = async (pageNum: number) => {
    if (!isOpen) return;

    setLoading(true);
    setError(null);
    try {
      console.log("Fetching trips from API, page:", pageNum);
      
      // Build query string with pagination params
      const queryParams = `?page=${pageNum}&page_size=${limit}`;
      
      const response = await apiClient.get(
        `/trips${queryParams}`,
        undefined,
        false,
        undefined,
        true
      );
      
      console.log("Trip history API response:", response);

      if (response.count > 0) {
        //  FIX: response.data IS the pagination object, not nested
        const paginationData = response;
        console.log(response.data)
        const newTrips: Trip[] = paginationData.results || [];
        const currentPage = paginationData.current_page;
        const pageCount = paginationData.page_count;
        const pageSize = paginationData.page_size;

        console.log(`Fetched ${newTrips.length} trips for page ${currentPage}/${pageCount}`);

        // Check if there are more pages
        setHasMore(currentPage < pageCount);

        if (pageNum === 1) {
          setTrips(newTrips);
        } else {
          setTrips(prev => [...prev, ...newTrips]);
        }
      } else {
        console.error("API response was not successful:", response);
        setError("Failed to fetch trip history.");
        showNotification("Failed to fetch trip history.", "error");
      }
    } catch (err) {
      console.error("Error fetching trip history:", err);
      setError("An error occurred while fetching trip history.");
      showNotification("Failed to fetch trip history. Please check your connection.", "error");
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    if (isOpen) {
      fetchTrips(page);
    }
    return () => {
      if (!isOpen) {
        setPage(1);
      }
    };
  }, [isOpen, page]);

  const handleClose = () => {
    setPage(1);
    setTrips([]);
    setHasMore(true);
    onClose();
  };

  const formatDate = (dateString?: string) => {
    if (!dateString) return "Date unknown";
    try {
      const date = new Date(dateString);
      const now = new Date();
      const diff = now.getTime() - date.getTime();
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));

      if (days === 0) {
        return `Today, ${date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}`;
      } else if (days === 1) {
        return `Yesterday, ${date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}`;
      } else if (days < 7) {
        return `${days} days ago`;
      } else {
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      }
    } catch (e) {
      return "Invalid date";
    }
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-end justify-center">
      <div
        className="absolute inset-0 bg-black/50"
        onClick={handleClose}
      />
      <div className="relative bg-white w-full max-w-md h-[80vh] rounded-t-3xl border-t border-achrams-border shadow-lg overflow-hidden flex flex-col">
        {/* Header */}
        <div className="bg-gradient-to-r from-emerald-600 via-teal-600 to-cyan-600 text-achrams-text-light px-6 py-4 flex items-center justify-between shadow-md">
          <h2 className="text-xl font-bold">Trip History</h2>
          <button
            onClick={handleClose}
            className="text-achrams-text-light hover:text-achrams-text-light/80 p-2 hover:bg-white/10 rounded-lg transition-colors"
            aria-label="Close"
          >
            <X className="w-6 h-6" />
          </button>
        </div>

        {/* Content Area */}
        <div className="flex-1 overflow-y-auto px-6 py-4">
          {error ? (
            <div className="text-center py-8">
              <p className="text-achrams-text-secondary mb-4">{error}</p>
              <button
                onClick={() => fetchTrips(page)}
                className="px-6 py-2 bg-achrams-primary-solid text-white rounded-lg font-medium hover:opacity-90"
              >
                Retry
              </button>
            </div>
          ) : loading && trips.length === 0 ? (
            <div className="flex justify-center items-center h-full">
              <div className="text-center">
                <Loader className="w-8 h-8 text-achrams-primary-solid animate-spin mx-auto mb-3" />
                <p className="text-sm text-achrams-text-secondary">Loading your trips...</p>
              </div>
            </div>
          ) : trips.length === 0 ? (
            <div className="text-center py-12">
              <Clock className="w-16 h-16 text-achrams-text-secondary mx-auto mb-4 opacity-50" />
              <p className="text-achrams-text-secondary text-lg font-medium mb-2">No trips yet</p>
              <p className="text-achrams-text-secondary text-sm">Your trip history will appear here</p>
            </div>
          ) : (
            <>
              <div className="space-y-3">
                {trips.map((trip) => (
                  <div
                    key={trip.id}
                    className="bg-white rounded-xl p-4 border border-achrams-border hover:shadow-md transition-shadow"
                  >
                    <div className="flex items-start justify-between">
                      <div className="flex-1 min-w-0">
                        {/* Status Badge & Rating */}
                        <div className="flex items-center gap-2 mb-2">
                          <span className={`text-xs px-2.5 py-1 rounded-full font-medium ${
                            trip.status.value === "completed"
                              ? "bg-green-100 text-green-700"
                              : "bg-gray-100 text-gray-700"
                          }`}>
                            {trip.status.label}
                          </span>
                          {trip.rating !== null && (
                            <div className="flex items-center gap-1 bg-yellow-50 px-2 py-1 rounded-full">
                              <Star className="w-3.5 h-3.5 fill-yellow-500 text-yellow-500" />
                              <span className="text-xs font-medium text-yellow-700">{trip.rating.score}</span>
                            </div>
                          )}
                        </div>

                        {/* Driver Info */}
                        {trip.driver?.name && (
                          <div className="text-sm font-semibold text-achrams-text-primary mb-2">
                            {trip.driver.name}
                          </div>
                        )}

                        {/* Route */}
                        <div className="space-y-1.5 mb-3">
                          <div className="flex items-start gap-2">
                            <div className="w-2 h-2 rounded-full bg-achrams-primary-solid flex-shrink-0 mt-1.5"></div>
                            <div className="text-sm text-achrams-text-primary truncate flex-1">
                              {trip.pickup_address}
                            </div>
                          </div>
                          <div className="flex items-start gap-2 pl-2">
                            <div className="w-0.5 h-4 bg-achrams-border ml-[3px]"></div>
                          </div>
                          <div className="flex items-start gap-2">
                            <MapPin className="w-4 h-4 text-red-500 flex-shrink-0 mt-0.5" />
                            <div className="text-sm text-achrams-text-secondary truncate flex-1">
                              {trip.destination_address}
                            </div>
                          </div>
                        </div>

                        {/* Footer: Date & Fare */}
                        <div className="flex justify-between items-center pt-3 border-t border-achrams-border">
                          <span className="text-xs text-achrams-text-secondary flex items-center gap-1">
                            <Clock className="w-3.5 h-3.5" />
                            {formatDate(trip.created_at)}
                          </span>
                          <div className="flex items-center gap-1.5 bg-achrams-primary-solid/5 px-3 py-1.5 rounded-lg">
                            <Wallet className="w-4 h-4 text-achrams-primary-solid" />
                            <span className="text-sm font-bold text-achrams-primary-solid">
                              {trip.amount.formatted}
                            </span>
                          </div>
                        </div>
                      </div>

                      {/* View Details Button */}
                      {onSelectTrip && (
                        <button
                          onClick={() => onSelectTrip(trip.id)}
                          className="ml-3 p-2 text-achrams-primary-solid hover:bg-achrams-primary-solid/10 rounded-lg transition-colors"
                          aria-label={`View details for trip ${trip.id}`}
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                            <polyline points="9 18 15 12 9 6"></polyline>
                          </svg>
                        </button>
                      )}
                    </div>
                  </div>
                ))}
              </div>

              {/* Loading More Indicator */}
              {loading && trips.length > 0 && (
                <div className="flex justify-center py-4">
                  <Loader className="w-6 h-6 text-achrams-primary-solid animate-spin" />
                </div>
              )}

              {/* End of List */}
              {!loading && !hasMore && trips.length > 0 && (
                <div className="text-center text-achrams-text-secondary py-4 text-sm">
                  That's all your trips!
                </div>
              )}

              {/* Load More Button */}
              {!loading && hasMore && (
                <button
                  onClick={() => setPage(prev => prev + 1)}
                  className="w-full py-3 mt-4 bg-achrams-primary-solid text-white rounded-xl font-medium hover:opacity-90 active:scale-[0.98] transition-all shadow-sm"
                >
                  Load More Trips
                </button>
              )}
            </>
          )}
        </div>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/LoginModal.tsx -----
// // src/components/app/modals/LoginModal.tsx
import { X, Loader, Mail, Chrome, Eye, EyeOff } from 'lucide-react';
import { useState } from 'react';
// import { apiClient } from '@/lib/api';
import { useAuth } from '@/contexts/AuthContext';
import GoogleColor from '@/components/icons/GoogleColor';

interface LoginModalProps {
  isOpen: boolean;
  onClose: () => void;
  onLoginSuccess: (loginResult?: any) => void; 
  onLoginError?: (errorMessage: string) => void; 
  onShowSignupPrompt: () => void;
  showNotification: (message: string, type: "info" | "success" | "warning" | "error") => void;
  onRequires2FA: (email: string, password: string) => void;
}

export default function LoginModal({
  isOpen,
  onClose,
  onRequires2FA,
  onLoginSuccess,
  onShowSignupPrompt,
  onLoginError,
  showNotification,

}: LoginModalProps) {
  if (!isOpen) return null;

  const { login: updateAuthContext } = useAuth(); // Get the login function from context

  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [showPassword, setShowPassword] = useState(false);
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);
  const [loadingGoogle, setLoadingGoogle] = useState(false);

  // const handleLogin = async () => {
  //   setError('');
  //   if (!email || !password) {
  //     setError('Please fill in all fields.');
  //     return;
  //   }

  //   setLoading(true);
  //   try {
  //     // Call the login function from AuthContext, which handles the API call and state updates
  //     const loginSuccessful = await updateAuthContext(email, password);

  //     if (loginSuccessful) {
  //       onClose();
  //       onLoginSuccess(); // Parent (page.tsx) can handle navigation or UI updates
  //     } else {
  //       // The login function in AuthContext should have handled setting an error,
  //       // or we can set a generic one here if needed.
  //       setError('Login failed. Please check your credentials.');
  //     }
  //   } catch (err: any) {
  //       console.error("Login Error caught in LoginModal:", err);
  //       let errorMessage = 'An unexpected error occurred.';
  //       if (err.message) {
  //           errorMessage = err.message;
  //       }
  //       setError(errorMessage);
  //   } finally {
  //     setLoading(false);
  //   }
  // };

  const handleLogin = async () => {
    setError('');
    if (!email || !password) {
      setError('Please fill in all fields.');
      return;
    }

    setLoading(true);
    try {
      // Call the login function from AuthContext, which handles the API call and state updates
      // NEW: Expect the result to be an object { success: boolean, message?: string }
      const loginResult = await updateAuthContext(email, password);
      if (loginResult.success){


        if (loginResult.requires2FA) {
          console.log("LoginModal: 2FA required. calling onRequires2FA handler");
          onRequires2FA(email, password);
          
        }  else {

          onClose();
          onLoginSuccess(); // Parent (page.tsx) can handle navigation or UI updates
          // Optionally, page.tsx can show a success notification here too if needed
        }
        

        
      }
      else {
        // NEW: Handle login failure by getting the specific error message
        const errorMessage = loginResult.message || 'Login failed. Please check your credentials.';
        // Option 1: Set error in the modal's local state (current behavior)
        setError(errorMessage);

        // Option 2: Call a parent handler to show a notification (NEW PREFERRED WAY)
        if (onLoginError) {
            onLoginError(errorMessage); // Pass the specific error message to parent
            showNotification(errorMessage, "error")
        }
      }
    } catch (err: any) {
        console.error("Login Error caught in LoginModal:", err);
        let errorMessage = 'An unexpected error occurred.';
        if (err.message) {
            errorMessage = err.message;
        }
        setError(errorMessage);
        showNotification(errorMessage, 'error')
        if (onLoginError) {
            onLoginError(errorMessage); // Pass the catch error message to parent
        }
    } finally {
      setLoading(false);
    }
  };

  // Placeholder for Google login function
  const handleGoogleLogin = () => {
      setLoadingGoogle(true);
      // Simulate Google login process (replace with actual Google SDK call)
      setTimeout(() => {
          setLoadingGoogle(false);
          alert('Google login functionality would be implemented here using Google SDK.');
      }, 2000);
  };

  return (
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 bg-opacity-70 flex items-end z-50">
      <div className="bg-white max-w-sm mx-auto w-full rounded-t-3xl p-6 animate-slideUp max-h-[85vh] overflow-y-auto border-t border-achrams-border">
        <div className="flex justify-between items-center mb-2">
          <h3 className="text-xl font-bold text-achrams-text-primary">Sign In to your account</h3>
          <button
            onClick={onClose}
            disabled={loading || loadingGoogle}
            className="text-achrams-text-secondary hover:text-achrams-text-primary transition-colors disabled:opacity-50"
          >
            <X className="w-6 h-6" />
          </button>
        </div>

        {/* Email/Password Login Form */}
        <div className="space-y-4 mb-6">
          <div className="relative">
            <Mail className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-achrams-text-secondary" />
            <input
              type="email"
              placeholder="Email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              disabled={loading || loadingGoogle}
              className="w-full pl-10 pr-4 py-3 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border border-achrams-border"
            />
          </div>
          <div className="relative">
            <input
              type={showPassword ? "text" : "password"}
              placeholder="Password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              disabled={loading || loadingGoogle}
              className="w-full px-4 py-3 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border border-achrams-border pr-10"
            />
            <button
              type="button"
              onClick={() => setShowPassword(!showPassword)}
              className="absolute right-3 top-1/2 transform -translate-y-1/2 text-achrams-text-secondary hover:text-achrams-text-primary"
            >
              {showPassword ? <EyeOff className="w-5 h-5" /> : <Eye className="w-5 h-5" />}
            </button>
          </div>
        </div>

        {/* Error Message Display */}
        {error && (
          <p className="text-red-500 text-sm mb-4">{error}</p>
        )}

        <button
          onClick={handleLogin}
          disabled={loading || loadingGoogle || !email || !password}
          className={`w-full py-4 rounded-xl font-semibold mb-4 transition-all ${
            loading || loadingGoogle || !email || !password
              ? 'bg-achrams-secondary-solid text-achrams-text-light opacity-75 cursor-not-allowed'
              : 'bg-achrams-gradient-primary text-achrams-text-light hover:opacity-90 active:scale-[0.98]'
          }`}
        >
          {loading ? (
            <div className="flex items-center justify-center">
              <Loader className="w-5 h-5 animate-spin mr-2" />
              Signing In...
            </div>
          ) : (
            'Sign In'
          )}
        </button>

        {/* Google Login Button */}
        <button
          onClick={handleGoogleLogin}
          disabled={loading || loadingGoogle}
          className={`w-full py-3 rounded-xl font-medium mb-4 transition-colors flex items-center justify-center gap-2 ${
            loadingGoogle
              ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
              : 'bg-white text-gray-800 border border-gray-300 hover:bg-gray-100'
          }`}
        >
          {loadingGoogle ? (
            <div className="flex items-center justify-center">
              <Loader className="w-5 h-5 animate-spin mr-2" />
              Signing In...
            </div>
          ) : (
            <>
              <GoogleColor className="w-5 h-5" />
              Sign In with Google
            </>
          )}
        </button>

        {/* Sign Up Link */}
        <div className="mt-4 text-center">
          <button
            onClick={() => {
              onClose();
              onShowSignupPrompt();
            }}
            className="text-sm text-achrams-primary-solid hover:underline"
          >
            Don't have an account? Sign Up
          </button>
        </div>

        <button
          onClick={onClose}
          disabled={loading || loadingGoogle}
          className="w-full mt-4 text-achrams-text-secondary font-medium hover:text-achrams-text-primary transition-colors disabled:opacity-50"
        >
          Cancel
        </button>
      </div>
    </div>
  );
}


----- FILE: src/components/app/modals/TripRequestStatusModal.tsx -----
// src/components/app/modals/TripRequestStatusModal.tsx
import { X, AlertCircle, CheckCircle, Loader } from 'lucide-react';

interface TripRequestStatusModalProps {
  isOpen: boolean;
  onClose: () => void;
  status: 'loading' | 'accepted' | 'no-driver' | 'error' | null;
  message?: string | null; // Optional custom message
  onConfirm?: () => void
}

export default function TripRequestStatusModal({
  isOpen,
  onClose,
  status,
  message,
  onConfirm,
}: TripRequestStatusModalProps) {
  if (!isOpen || !status) return null;

  let icon = null;
  let title = '';
  let description = '';
  let buttonText = 'OK';

  switch (status) {
    case 'loading':
      icon = <Loader className="w-8 h-8 animate-spin text-achrams-primary-solid" />;
      title = 'Finding a Driver...';
      description = 'Please wait while we connect you with a driver.';
      buttonText = 'Cancel'; // Or handle cancellation differently if needed
      break;
    case 'accepted':
      icon = <CheckCircle className="w-8 h-8 text-green-500" />;
      title = 'Driver Found!';
      description = message || 'Your ride has been confirmed.';
      buttonText = 'View Details';
      break;
    case 'no-driver':
      icon = <AlertCircle className="w-8 h-8 text-yellow-500" />;
      title = 'No Drivers Available';
      description = message || 'We couldn\'t find a driver at the moment. Please try again later.';
      buttonText = 'Try Again';
      break;
    case 'error':
      icon = <AlertCircle className="w-8 h-8 text-red-500" />;
      title = 'Something Went Wrong';
      description = message || 'An error occurred while processing your request. Please check your connection and try again.';
      buttonText = 'Retry';
      break;
  }

  return (
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 bg-opacity-70 flex items-end z-100">
      <div className="bg-white w-full max-w-sm mx-auto rounded-t-3xl p-6 animate-slideUp max-h-[85vh] overflow-y-auto border-t border-achrams-border">
        <div className="flex justify-between items-center mb-6">
          <h3 className="text-xl font-bold text-achrams-text-primary">{title}</h3>
          <button
            onClick={onClose}
            className="text-achrams-text-secondary hover:text-achrams-text-primary transition-colors"
          >
            <X className="w-6 h-6" />
          </button>
        </div>
        <div className="flex flex-col items-center gap-4 mb-6">
          {icon}
          <p className="text-center text-achrams-text-secondary">{description}</p>
        </div>
        <button
          onClick={() => {
            if (status === 'accepted') {
              // The parent (page.tsx) handles the transition after 'accepted' status is set
              onClose(); // Close the modal
            } else if (status === 'no-driver' || status === 'error') {
              // Retry logic or close - in this mock, just 
              if (onConfirm) {onConfirm()} else onClose();
            } else onClose();
          }}
          className={`w-full py-4 rounded-xl font-semibold transition-all ${
            status === 'accepted'
              ? 'bg-achrams-gradient-primary text-achrams-text-light hover:opacity-90 active:scale-[0.98]'
              : 'bg-achrams-secondary-solid text-achrams-text-light hover:bg-achrams-secondary-solid/90'
          }`}
        >
          {buttonText}
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/PasswordResetModal.tsx -----
// src/components/app/modals/PasswordResetModal.tsx
import { useState, useEffect } from 'react';
import { X, Mail, Loader2, CheckCircle } from 'lucide-react';
import { apiClient } from '@/lib/api';

interface PasswordResetModalProps {
  isOpen: boolean;
  onClose: () => void;
  showNotification: (message: string, type: "info" | "success" | "warning" | "error") => void;
  email: string; // Pass the user's email to pre-fill
}

export default function PasswordResetModal({
  isOpen,
  onClose,
  showNotification,
  email,
}: PasswordResetModalProps) {
  const [step, setStep] = useState<'email' | 'otp' | 'newPassword' | 'success'>('email');
  const [emailInput, setEmailInput] = useState(email ?? ''); // Pre-fill with user's email
  const [otp, setOtp] = useState('');
  const [newPassword, setNewPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [countdown, setCountdown] = useState(0);

  // Reset state when modal opens
  useEffect(() => {
    if (isOpen) {
      setStep('email');
      setEmailInput(email ?? '');
      setOtp('');
      setNewPassword('');
      setConfirmPassword('');
      setLoading(false);
      setCountdown(0);
    }
  }, [isOpen, email]);

  // Countdown for resend
  useEffect(() => {
    let timer: NodeJS.Timeout;
    if (countdown > 0) {
      timer = setTimeout(() => setCountdown(countdown - 1), 1000);
    }
    return () => clearTimeout(timer);
  }, [countdown]);

  const handleSendResetEmail = async () => {
    if (!emailInput || !/^\S+@\S+\.\S+$/.test(emailInput)) {
      showNotification("Please enter a valid email address.", "error");
      return;
    }
    setLoading(true);
    try {
      const response = await apiClient.post('/auth/passenger/reset', { email: emailInput }, undefined, undefined, true); // isAuthRequest=true
      console.log("Reset email response:", response);
      if (response.status === "success") {
        showNotification("Reset email sent successfully!", "success");
        setStep('otp');
        setCountdown(60); // 60 seconds before resend allowed
      } else {
        showNotification(response.message || "Failed to send reset email.", "error");
      }
    } catch (err: any) {
      console.error("Error sending reset email:", err);
      showNotification(err.response?.data?.message || "An error occurred while sending the reset email.", "error");
    } finally {
      setLoading(false);
    }
  };

  const handleVerifyOtp = () => {
    if (!otp || otp.length !== 6) {
      showNotification("Please enter a valid 6-digit OTP.", "error");
      return;
    }
    setStep('newPassword');
  };

  const handleResetPassword = async () => {
    if (!newPassword || newPassword.length < 8) {
      showNotification("Password must be at least 8 characters long.", "error");
      return;
    }
    if (newPassword !== confirmPassword) {
      showNotification("Passwords do not match.", "error");
      return;
    }

    setLoading(true);
    try {
      const response = await apiClient.post('/auth/passenger/confirm-reset', {
        otp,
        password: newPassword,
        email: emailInput,
      }, undefined, undefined, true); // isAuthRequest=true
      console.log("Confirm reset response:", response);
      if (response.status === "success") {
        showNotification("Password reset successfully!", "success");
        setStep('success');
        // Optionally log out user or navigate to login after a delay
        setTimeout(() => {
          setStep('email'); // Reset to initial state
          onClose(); // Close modal after success
        }, 2000);
      } else {
        showNotification(response.message || "Failed to reset password.", "error");
      }
    } catch (err: any) {
      console.error("Error resetting password:", err);
      showNotification(err.response?.data?.message || "An error occurred while resetting the password.", "error");
    } finally {
      setLoading(false);
    }
  };

  const handleResendOtp = async () => {
    if (countdown > 0) {
      showNotification("Please wait before requesting another OTP.", "info");
      return;
    }
    await handleSendResetEmail();
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 flex items-end z-50">
      <div className="bg-white w-full max-w-sm mx-auto rounded-t-3xl p-6 border-t border-achrams-border">
        <div className="flex justify-between items-center mb-4">
          <h3 className="text-xl font-bold text-achrams-text-primary">Reset Password</h3>
          <button
            onClick={onClose}
            disabled={loading}
            className="text-achrams-text-secondary hover:text-achrams-text-primary transition-colors disabled:opacity-50"
          >
            <X className="w-6 h-6" />
          </button>
        </div>

        {/* Step 1: Enter Email */}
        {step === 'email' && (
          <div className="space-y-4">
            <div className="p-3 bg-gray-50 rounded-xl border border-achrams-border">
              <label className="block text-xs text-achrams-text-secondary font-medium mb-1">Email</label>
              <input
                type="email"
                value={emailInput}
                onChange={(e) => setEmailInput(e.target.value)}
                className="w-full bg-transparent text-achrams-text-primary font-semibold focus:outline-none"
                placeholder="your.email@example.com"
                disabled={loading}
              />
            </div>
            <button
              onClick={handleSendResetEmail}
              disabled={loading}
              className={`w-full py-3 bg-achrams-primary-solid text-achrams-text-light rounded-xl font-medium hover:opacity-90 active:scale-[0.98] transition-all ${
                loading ? 'opacity-50 cursor-not-allowed' : ''
              }`}
            >
              {loading ? (
                <div className="flex items-center justify-center">
                  <Loader2 className="w-4 h-4 animate-spin mr-2" />
                  Sending...
                </div>
              ) : (
                'Send Reset Link'
              )}
            </button>
          </div>
        )}

        {/* Step 2: Enter OTP */}
        {step === 'otp' && (
          <div className="space-y-4">
            <p className="text-achrams-text-secondary mb-2">
              Enter the 6-digit code sent to <span className="font-medium text-achrams-text-primary">{emailInput}</span>
            </p>
            <div className="flex gap-2 justify-center mb-4">
              {Array.from({ length: 6 }).map((_, idx) => (
                <input
                  key={idx}
                  type="text"
                  inputMode="numeric"
                  maxLength={1}
                  value={otp[idx] || ''}
                  onChange={(e) => {
                    if (/^\d*$/.test(e.target.value) && e.target.value.length <= 1) {
                      const newOtp = otp.split('');
                      newOtp[idx] = e.target.value;
                      setOtp(newOtp.join(''));
                      if (e.target.value && idx < 5) {
                        const next = document.getElementById(`otp-${idx + 1}`);
                        if (next) (next as HTMLInputElement).focus();
                      }
                    }
                  }}
                  id={`otp-${idx}`}
                  disabled={loading}
                  className="w-10 h-10 text-center text-xl font-bold bg-achrams-bg-secondary border-2 rounded-xl outline-none text-achrams-text-primary focus:ring-1 focus:ring-achrams-primary-solid border-achrams-border focus:border-achrams-primary-solid"
                />
              ))}
            </div>
            <button
              onClick={handleVerifyOtp}
              disabled={loading || otp.length !== 6}
              className={`w-full py-3 bg-achrams-primary-solid text-achrams-text-light rounded-xl font-medium hover:opacity-90 active:scale-[0.98] transition-all ${
                loading || otp.length !== 6 ? 'opacity-50 cursor-not-allowed' : ''
              }`}
            >
              Verify OTP
            </button>
            <button
              onClick={handleResendOtp}
              disabled={loading || countdown > 0}
              className={`w-full text-sm text-achrams-text-secondary font-medium hover:text-achrams-text-primary transition-colors ${
                countdown > 0 ? 'opacity-50 cursor-not-allowed' : ''
              }`}
            >
              {countdown > 0 ? `Resend OTP in ${countdown}s` : 'Resend OTP'}
            </button>
          </div>
        )}

        {/* Step 3: Enter New Password */}
        {step === 'newPassword' && (
          <div className="space-y-4">
            <div className="p-3 bg-gray-50 rounded-xl border border-achrams-border">
              <label className="block text-xs text-achrams-text-secondary font-medium mb-1">New Password</label>
              <input
                type="password"
                value={newPassword}
                onChange={(e) => setNewPassword(e.target.value)}
                className="w-full bg-transparent text-achrams-text-primary font-semibold focus:outline-none"
                placeholder="Enter new password"
                disabled={loading}
              />
            </div>
            <div className="p-3 bg-gray-50 rounded-xl border border-achrams-border">
              <label className="block text-xs text-achrams-text-secondary font-medium mb-1">Confirm Password</label>
              <input
                type="password"
                value={confirmPassword}
                onChange={(e) => setConfirmPassword(e.target.value)}
                className="w-full bg-transparent text-achrams-text-primary font-semibold focus:outline-none"
                placeholder="Confirm new password"
                disabled={loading}
              />
            </div>
            <button
              onClick={handleResetPassword}
              disabled={loading}
              className={`w-full py-3 bg-achrams-primary-solid text-achrams-text-light rounded-xl font-medium hover:opacity-90 active:scale-[0.98] transition-all ${
                loading ? 'opacity-50 cursor-not-allowed' : ''
              }`}
            >
              {loading ? (
                <div className="flex items-center justify-center">
                  <Loader2 className="w-4 h-4 animate-spin mr-2" />
                  Resetting...
                </div>
              ) : (
                'Reset Password'
              )}
            </button>
          </div>
        )}

        {/* Step 4: Success */}
        {step === 'success' && (
          <div className="text-center py-8">
            <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <CheckCircle className="w-8 h-8 text-green-600" />
            </div>
            <h4 className="text-lg font-bold text-achrams-text-primary mb-2">Password Changed!</h4>
            <p className="text-achrams-text-secondary">Your password has been updated successfully.</p>
          </div>
        )}

        <button
          onClick={onClose}
          className="w-full mt-4 text-sm text-achrams-text-secondary font-medium hover:text-achrams-text-primary transition-colors"
        >
          Cancel
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/DirectionsModal.tsx -----
// src/components/app/modals/DirectionsModal.tsx
import { X, Navigation, MapPin, Car, User, Route, Clock } from 'lucide-react';
import { GoogleMap, Marker, Polygon, useJsApiLoader } from '@react-google-maps/api';
import { useState, useEffect, useCallback, useRef } from 'react';

interface DirectionsModalProps {
  isOpen: boolean;
  onClose: () => void;
  pickup: string;
  pickupCoords?: [number, number] | null; // Booking location (where request was made)
  destination: string;
  destinationCoords?: [number, number] | null;
  driverLocation?: [number, number] | null;
  passengerLocation?: [number, number] | null; // Passenger's current live location
  airportPickupArea?: any; // The polygon defining the pickup zone
  isGoogleMapsLoaded: boolean;
  googleMapsLoadError?: any;
}

interface RouteLeg {
  start_address: string;
  end_address: string;
  distance: { text: string; value: number };
  duration: { text: string; value: number };
}

const mapContainerStyle = {
  width: '100%',
  height: '100%',
};

const defaultCenter = {
  lat: 6.5244,
  lng: 3.3792,
};

// Clean map styles
const mapStyles = [
  {
    featureType: "poi.business",
    elementType: "labels",
    stylers: [{ visibility: "off" }]
  }
];

// Custom marker icons - using functions to avoid google dependency at load time
const getPassengerIcon = () => ({
  path: "M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z",
  fillColor: "#4F46E5",
  fillOpacity: 1,
  strokeColor: "#FFFFFF",
  strokeWeight: 2.5,
  scale: 2.2,
  anchor: { x: 12, y: 24 } as google.maps.Point,
});

const getDriverIcon = (isInPickupArea: boolean) => ({
  path: "M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.22.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z",
  fillColor: isInPickupArea ? "#10B981" : "#F59E0B",
  fillOpacity: 1,
  strokeColor: "#FFFFFF",
  strokeWeight: 2.5,
  scale: 2.2,
  anchor: { x: 12, y: 12 } as google.maps.Point,
});

const getPickupIcon = () => ({
  path: "M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z",
  fillColor: "#10B981",
  fillOpacity: 1,
  strokeColor: "#FFFFFF",
  strokeWeight: 2.5,
  scale: 2.2,
  anchor: { x: 12, y: 24 } as google.maps.Point,
});

const getDestinationIcon = () => ({
  path: "M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z",
  fillColor: "#EF4444",
  fillOpacity: 1,
  strokeColor: "#FFFFFF",
  strokeWeight: 2.5,
  scale: 2.2,
  anchor: { x: 12, y: 24 } as google.maps.Point,
});

// NEW: Helper function to calculate the centroid of a polygon
const calculatePolygonCentroid = (polygonCoords: number[][]): [number, number] | null => {
  if (!polygonCoords || polygonCoords.length === 0) return null;

  let totalX = 0;
  let totalY = 0;
  let count = 0;

  // Loop through the coordinates of the polygon
  for (let i = 0; i < polygonCoords.length; i++) {
    const [lng, lat] = polygonCoords[i];
    totalX += lng;
    totalY += lat;
    count++;
  }

  // Avoid division by zero
  if (count === 0) return null;

  // Calculate the average (centroid)
  const centroidLng = totalX / count;
  const centroidLat = totalY / count;

  return [centroidLng, centroidLat];
};

export default function DirectionsModal({
  isOpen,
  onClose,
  pickup,
  pickupCoords,
  destination,
  destinationCoords,
  driverLocation,
  passengerLocation, //  Use passengerLocation (live location) as the origin
  airportPickupArea,
  isGoogleMapsLoaded,
  googleMapsLoadError,
}: DirectionsModalProps) {
  const [map, setMap] = useState<google.maps.Map | null>(null);
  const [isDriverInPickupArea, setIsDriverInPickupArea] = useState(false);
  const [routePolylinePath, setRoutePolylinePath] = useState<google.maps.LatLngLiteral[]>([]);
  const [routeInfo, setRouteInfo] = useState<{ distance: string; duration: string } | null>(null); //  Reflects passenger -> pickup area centroid
  const [activeMarker, setActiveMarker] = useState<string | null>(null);

  // NEW: Refs to track user interaction and initial fitBounds status
  const userInteractionRef = useRef(false);
  const initialFitBoundsDoneRef = useRef(false);

  const directionsService = useRef<google.maps.DirectionsService | null>(null);
  const directionsRenderer = useRef<google.maps.DirectionsRenderer | null>(null);

  const getPolygonPaths = useCallback((): google.maps.LatLngLiteral[] => {
    if (!airportPickupArea?.geometry?.coordinates) return [];
    const coordinates = airportPickupArea.geometry.coordinates[0];
    return coordinates.map((coord: number[]) => ({
      lat: coord[1],
      lng: coord[0],
    }));
  }, [airportPickupArea]);

  //  UPDATED: Fetch directions from passenger's *current* location to the *centroid* of the pickup area
  const fetchDirections = useCallback(async () => {
    if (!isGoogleMapsLoaded || !passengerLocation || !airportPickupArea?.geometry?.coordinates || !map) {
      return;
    }

    if (!directionsService.current) {
      directionsService.current = new google.maps.DirectionsService();
    }
    if (!directionsRenderer.current) {
      directionsRenderer.current = new google.maps.DirectionsRenderer({
        map: map,
        suppressMarkers: true,
        suppressInfoWindows: true,
        polylineOptions: {
          strokeColor: "#3B82F6",
          strokeOpacity: 0.8,
          strokeWeight: 6,
        },
      });
    }

    //  Calculate the centroid of the pickup area polygon
    const pickupAreaCentroid = calculatePolygonCentroid(airportPickupArea.geometry.coordinates[0]);
    if (!pickupAreaCentroid) {
        console.error("Could not calculate centroid for pickup area polygon.");
        setRouteInfo(null);
        setRoutePolylinePath([]);
        directionsRenderer.current.setMap(null);
        return;
    }

    //  Set origin to passenger's *current* location (passengerLocation)
    //  Set destination to the calculated centroid of the pickup area
    const request: google.maps.DirectionsRequest = {
      origin: new google.maps.LatLng(passengerLocation[0], passengerLocation[1]), // [lng, lat] -> {lat, lng}
      destination: new google.maps.LatLng(pickupAreaCentroid[1], pickupAreaCentroid[0]), // [lng, lat] -> {lat, lng}
      travelMode: google.maps.TravelMode.DRIVING,
    };

    try {
      const result = await directionsService.current.route(request);
      if (result.status === "OK" && result.routes.length > 0) {
        const route = result.routes[0];
        const leg = route.legs[0]; // Leg from passenger's current location to pickup area centroid

        //  Update routeInfo with distance and duration for passenger -> pickup area centroid leg
        setRouteInfo({
          distance: leg.distance?.text || "N/A",
          duration: leg.duration?.text || "N/A",
        });

        directionsRenderer.current.setDirections(result);
        const path = route.overview_path.map((point) => ({ lat: point.lat(), lng: point.lng() }));
        setRoutePolylinePath(path);

      } else {
        console.error("Directions request failed due to status: " + result.status);
        setRouteInfo(null); //  Clear route info on failure
        setRoutePolylinePath([]);
        directionsRenderer.current.setMap(null);
      }
    } catch (e) {
      console.error("Error fetching directions", e);
      setRouteInfo(null); //  Clear route info on error
      setRoutePolylinePath([]);
      directionsRenderer.current.setMap(null);
    }
  }, [isGoogleMapsLoaded, passengerLocation, airportPickupArea, map]); //  Update dependencies

  // NEW: Effect to handle user interaction events
  useEffect(() => {
    if (!map) return;

    const handleMapInteraction = () => {
      // Set the flag to true when user interacts (pan, zoom, etc.)
      userInteractionRef.current = true;
    };

    // Listen for common user interaction events
    const centerListener = map.addListener('center_changed', handleMapInteraction);
    const zoomListener = map.addListener('zoom_changed', handleMapInteraction);

    // Cleanup listeners when component unmounts or map changes
    return () => {
      if (centerListener) centerListener.remove();
      if (zoomListener) zoomListener.remove();
    };
  }, [map]);

  // NEW: Effect to perform initial fitBounds only once, respecting user interaction
  useEffect(() => {
    if (!map || !isGoogleMapsLoaded || initialFitBoundsDoneRef.current || userInteractionRef.current) return;

    const bounds = new google.maps.LatLngBounds();
    let hasPoints = false;

    //  Include passenger's *current* location in fitBounds calculation
    if (passengerLocation) {
      bounds.extend({ lat: passengerLocation[0], lng: passengerLocation[1] });
      hasPoints = true;
    }

    //  Include pickup area polygon points in fitBounds calculation
    const polygonPaths = getPolygonPaths();
    if (polygonPaths.length > 0) {
      polygonPaths.forEach(point => bounds.extend(point));
      hasPoints = true;
    }

    if (driverLocation) {
      bounds.extend({ lat: driverLocation[1], lng: driverLocation[0] });
      hasPoints = true;
    }

    //  Include destination coords only if you want them visible initially
    if (destinationCoords) {
      bounds.extend({ lat: destinationCoords[1], lng: destinationCoords[0] });
      hasPoints = true;
    }

    if (routePolylinePath.length > 0) {
      routePolylinePath.forEach(point => bounds.extend(point));
      hasPoints = true;
    }

    if (hasPoints) {
      map.fitBounds(bounds, { top: 100, right: 50, bottom: 150, left: 50 });
      initialFitBoundsDoneRef.current = true; // Mark that the initial fitBounds has been done
    }
  }, [
    map,
    passengerLocation, //  Use passengerLocation for initial view
    getPolygonPaths, //  Use the helper to get polygon points
    driverLocation,
    destinationCoords,
    airportPickupArea, // Needed by getPolygonPaths
    isGoogleMapsLoaded, // Needed by getPolygonPaths
    routePolylinePath,
    // userInteractionRef.current and initialFitBoundsDoneRef.current are not deps
    // because we only read their *current* value inside.
  ]);

  // REMOVED: The old useEffect that constantly tried to fit bounds based on live data

  useEffect(() => {
    if (!isGoogleMapsLoaded || !driverLocation || !airportPickupArea) return;

    const polygonPaths = getPolygonPaths();
    if (polygonPaths.length === 0) return;

    const polygon = new google.maps.Polygon({ paths: polygonPaths });
    const driverPoint = new google.maps.LatLng(driverLocation[1], driverLocation[0]);

    const isInside = google.maps.geometry.poly.containsLocation(driverPoint, polygon);
    setIsDriverInPickupArea(isInside);
  }, [driverLocation, airportPickupArea, isGoogleMapsLoaded, getPolygonPaths]);

  useEffect(() => {
    fetchDirections(); //  Fetch passenger (live) -> pickup area centroid route
  }, [fetchDirections]);

  const onLoad = useCallback((map: google.maps.Map) => {
    setMap(map);
  }, []);

  const onUnmount = useCallback(() => {
    setMap(null);
    if (directionsRenderer.current) {
      directionsRenderer.current.setMap(null);
      directionsRenderer.current = null;
    }
    if (directionsService.current) {
      directionsService.current = null;
    }
  }, []);

  if (!isOpen) return null;

  if (googleMapsLoadError) {
    return (
      <div className="fixed inset-0 bg-achrams-bg-primary z-50 flex items-center justify-center">
        <p className="text-achrams-text-secondary">Error loading map: {googleMapsLoadError.message || googleMapsLoadError}</p>
      </div>
    );
  }

  // NEW: Determine initial center only if initial fitBounds hasn't happened and user hasn't interacted
  let mapCenter = defaultCenter;
  if (!initialFitBoundsDoneRef.current && !userInteractionRef.current) {
     if (passengerLocation) { //  Prefer passenger's *current* location first
        mapCenter = { lat: passengerLocation[0], lng: passengerLocation[1] };
      } else if (airportPickupArea) { //  Then the pickup area (use its first coordinate as a fallback if no centroid calc)
          const centroid = calculatePolygonCentroid(airportPickupArea.geometry.coordinates[0]);
          if (centroid) {
              mapCenter = { lat: centroid[1], lng: centroid[0] };
          } else if (airportPickupArea.geometry.coordinates[0] && airportPickupArea.geometry.coordinates[0].length > 0) {
              const [lng, lat] = airportPickupArea.geometry.coordinates[0][0];
              mapCenter = { lat, lng }; // Fallback to first point of polygon
          }
      }
  }
  // Otherwise, let the map use its current view (controlled by user interaction)

  const polygonPaths = getPolygonPaths();

  return (
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 z-50" suppressHydrationWarning={true}>
      <div className="h-full flex flex-col">
        {/* Header with brand colors - subtle enhancement */}
        <div className="bg-achrams-primary-solid text-achrams-text-light px-6 py-4 shadow-md">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2">
              <div className="w-10 h-10 bg-white/10 backdrop-blur-sm rounded-xl flex items-center justify-center">
                <Navigation className="w-5 h-5" />
              </div>
              <div>
                <h2 className="text-lg font-bold">Live Tracking</h2>
                {isDriverInPickupArea && (
                  <p className="text-xs text-white flex items-center gap-1 mt-0.5">
                    <Car className="w-3 h-3" /> Driver has arrived!
                  </p>
                )}
              </div>
            </div>
            <button
              onClick={onClose}
              className="text-achrams-text-light hover:text-achrams-text-light/80 transition-colors p-2 hover:bg-white/10 rounded-lg"
            >
              <X className="w-6 h-6" />
            </button>
          </div>
        </div>

        {/* Route Info Bar - Enhanced layout */}
        {routeInfo && (
          <div className="bg-white border-b border-achrams-border px-6 py-3 shadow-sm">
            <div className="flex items-center justify-between gap-4">
              <div className="flex items-center gap-2">
                <div className="w-9 h-9 bg-achrams-primary-solid/5 rounded-lg flex items-center justify-center">
                  <Route className="w-4 h-4 text-achrams-primary-solid" />
                </div>
                <div>
                  {/*  Updated label to reflect passenger (live) -> pickup area */}
                  <p className="text-xs text-achrams-text-secondary font-medium">To Pickup Area</p>
                  <p className="text-sm font-bold text-achrams-text-primary">{routeInfo.distance}</p>
                </div>
              </div>
              <div className="w-px h-10 bg-achrams-border"></div>
              <div className="flex items-center gap-2">
                <div className="w-9 h-9 bg-achrams-secondary-solid/5 rounded-lg flex items-center justify-center">
                  <Clock className="w-4 h-4 text-achrams-secondary-solid" />
                </div>
                <div>
                  {/*  Updated label to reflect passenger (live) -> pickup area */}
                  <p className="text-xs text-achrams-text-secondary font-medium">ETA to Pickup</p>
                  <p className="text-sm font-bold text-achrams-text-primary">{routeInfo.duration}</p>
                </div>
              </div>
            </div>
          </div>
        )}

        <div className="flex-1 relative">
          {isGoogleMapsLoaded ? (
            <GoogleMap
              mapContainerStyle={mapContainerStyle}
              // NEW: Only pass center and zoom if initial fitBounds hasn't happened and user hasn't interacted
              // This prevents the map from being forced back to the center prop.
              // The map will manage its own view after initial load/fitBounds/user interaction.
              center={(!initialFitBoundsDoneRef.current && !userInteractionRef.current) ? mapCenter : undefined}
              zoom={(!initialFitBoundsDoneRef.current && !userInteractionRef.current) ? 14 : undefined}
              onLoad={onLoad}
              onUnmount={onUnmount}
              options={{
                styles: mapStyles,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false,
                zoomControl: true,
                zoomControlOptions: {
                  position: google.maps.ControlPosition.RIGHT_CENTER,
                },
                // NEW: Ensure the map is draggable and user-controllable
                draggable: true,
                scrollwheel: true, // Allow scroll to zoom if desired
                disableDefaultUI: false, // Keep zoom controls
              }}
            >
              {/* Passenger's Current Location */}
              {passengerLocation && (
                <Marker
                  position={{ lat: passengerLocation[0], lng: passengerLocation[1] }}
                  icon={getPassengerIcon()}
                  title="Your Location"
                  zIndex={1000}
                  onClick={() => setActiveMarker('passenger')}
                />
              )}

              {/* Airport Pickup Area Polygon */}
              {polygonPaths.length > 0 && (
                <Polygon
                  paths={polygonPaths}
                  options={{
                    fillColor: '#10B981',
                    fillOpacity: 0.2,
                    strokeColor: '#10B981',
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                  }}
                />
              )}

              {/* Airport Pickup Point Marker (Optional: Show centroid) */}
              {/* You could optionally show a marker at the centroid used for routing */}
              {/* {airportPickupArea && calculatePolygonCentroid(airportPickupArea.geometry.coordinates[0]) && (
                <Marker
                  position={{
                      lat: calculatePolygonCentroid(airportPickupArea.geometry.coordinates[0])[1],
                      lng: calculatePolygonCentroid(airportPickupArea.geometry.coordinates[0])[0]
                  }}
                  icon={getPickupIcon()} // Could use a different icon
                  title={`Pickup Area Centroid: ${pickup}`}
                  zIndex={998} // Slightly below passenger/driver
                />
              )} */}

              {/* Driver's Current Location */}
              {driverLocation && (
                <Marker
                  position={{ lat: driverLocation[1], lng: driverLocation[0] }}
                  icon={getDriverIcon(isDriverInPickupArea)}
                  title="Driver Location"
                  zIndex={999}
                  onClick={() => setActiveMarker('driver')}
                />
              )}

              {/* Destination Marker */}
              {destinationCoords && (
                <Marker
                  position={{ lat: destinationCoords[1], lng: destinationCoords[0] }}
                  icon={getDestinationIcon()}
                  title={`Destination: ${destination}`}
                  onClick={() => setActiveMarker('destination')}
                />
              )}

              {/* Enhanced Info Popups */}
              {activeMarker === 'passenger' && passengerLocation && (
                <div className="absolute top-4 left-1/2 -translate-x-1/2 bg-white rounded-xl shadow-lg p-3 min-w-[180px] z-[1001] border border-achrams-border">
                  <div className="flex items-center gap-2 mb-1">
                    <div className="w-8 h-8 bg-indigo-100 rounded-lg flex items-center justify-center">
                      <User className="w-4 h-4 text-indigo-600" />
                    </div>
                    <span className="font-bold text-achrams-text-primary">Your Location</span>
                  </div>
                  <p className="text-xs text-achrams-text-secondary ml-10">{pickup}</p>
                </div>
              )}
              {activeMarker === 'driver' && driverLocation && (
                <div className="absolute top-4 left-1/2 -translate-x-1/2 bg-white rounded-xl shadow-lg p-3 min-w-[180px] z-[1001] border border-achrams-border">
                  <div className="flex items-center gap-2 mb-1">
                    <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${isDriverInPickupArea ? 'bg-green-100' : 'bg-amber-100'}`}>
                      <Car className={`w-4 h-4 ${isDriverInPickupArea ? 'text-green-600' : 'text-amber-600'}`} />
                    </div>
                    <span className="font-bold text-achrams-text-primary">Driver</span>
                  </div>
                  <p className="text-xs text-achrams-text-secondary ml-10">
                    {isDriverInPickupArea ? ' Arrived at pickup area' : 'En route to pickup'}
                  </p>
                </div>
              )}
              {activeMarker === 'pickup' && polygonPaths.length > 0 && airportPickupArea && (
                <div className="absolute top-4 left-1/2 -translate-x-1/2 bg-white rounded-xl shadow-lg p-3 min-w-[180px] z-[1001] border border-achrams-border">
                  <div className="flex items-center gap-2 mb-1">
                    <div className="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                      <MapPin className="w-4 h-4 text-green-600" />
                    </div>
                    <span className="font-bold text-achrams-text-primary">Pickup Area</span>
                  </div>
                  <p className="text-xs text-achrams-text-secondary ml-10">{pickup}</p>
                </div>
              )}
              {activeMarker === 'destination' && destinationCoords && (
                <div className="absolute top-4 left-1/2 -translate-x-1/2 bg-white rounded-xl shadow-lg p-3 min-w-[180px] z-[1001] border border-achrams-border">
                  <div className="flex items-center gap-2 mb-1">
                    <div className="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center">
                      <MapPin className="w-4 h-4 text-red-600" />
                    </div>
                    <span className="font-bold text-achrams-text-primary">Destination</span>
                  </div>
                  <p className="text-xs text-achrams-text-secondary ml-10">{destination}</p>
                </div>
              )}
            </GoogleMap>
          ) : (
            <div className="absolute inset-0 flex items-center justify-center bg-achrams-bg-secondary">
              <div className="text-center">
                <div className="w-12 h-12 border-4 border-achrams-primary-solid border-t-transparent rounded-full animate-spin mx-auto mb-3"></div>
                <p className="text-achrams-text-secondary text-sm">Loading map...</p>
              </div>
            </div>
          )}

          {/* Enhanced Legend */}
          <div className="absolute bottom-4 left-4 bg-white rounded-xl shadow-lg p-4 text-xs min-w-[160px] border border-achrams-border">
            <h3 className="font-bold text-achrams-text-primary border-b border-achrams-border pb-2 mb-3">Legend</h3>
            <div className="space-y-2.5">
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 rounded-full bg-[#4F46E5] border-2 border-white shadow-sm"></div>
                <span className="text-achrams-text-primary">Your Location</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 rounded-full bg-[#F59E0B] border-2 border-white shadow-sm"></div>
                <span className="text-achrams-text-primary">Driver</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 rounded-full bg-[#10B981] border-2 border-white shadow-sm"></div>
                <span className="text-achrams-text-primary">Pickup Area</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 rounded-full bg-[#EF4444] border-2 border-white shadow-sm"></div>
                <span className="text-achrams-text-primary">Destination</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}





----- FILE: src/components/app/modals/DriverVerificationModal.tsx -----
// src/components/app/modals/DriverVerificationModal.tsx
import { Shield, Check } from 'lucide-react';

interface DriverVerificationModalProps {
  isOpen: boolean;
  onClose: () => void;
  securityCode: string; // Pass the code from parent
}

export default function DriverVerificationModal({
  isOpen,
  onClose,
  securityCode,
}: DriverVerificationModalProps) {
  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 flex items-end z-50">
      <div className="bg-white w-full rounded-t-3xl p-6 animate-slideUp max-h-[90vh] max-w-sm mx-auto overflow-y-auto  shadow-sm">
        <div className="flex justify-center mb-6">
          <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center text-green-600">
            <Shield className="w-8 h-8" />
          </div>
        </div>
        <div className="text-center mb-6">
          <h3 className="text-xl font-bold text-achrams-text-primary">Verify Your Driver</h3>
          <p className="text-achrams-text-secondary mt-2">Share this code with your driver to confirm their identity</p>
        </div>
        <div className="bg-achrams-bg-secondary rounded-xl p-4 mb-6 text-center">
          <div className="text-xs text-achrams-text-secondary mb-2">SECURITY CODE</div>
          <div className="text-4xl font-bold text-achrams-text-primary">{securityCode}</div>
        </div>
        <button
          onClick={onClose}
          className="w-full py-4 rounded-xl font-semibold bg-achrams-gradient-primary text-achrams-text-light hover:opacity-90 active:scale-[0.98] transition-all"
        >
          OK
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/OutsideServiceAreaModal.tsx -----
// src/components/app/modals/OutsideServiceAreaModal.tsx
import { X } from 'lucide-react';

interface OutsideServiceAreaModalProps {
  isOpen: boolean;
  onClose: () => void; // Allows closing the modal
}

export default function OutsideServiceAreaModal({
  isOpen,
  onClose,
}: OutsideServiceAreaModalProps) {
  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 bg-opacity-70 flex items-end z-100">
      <div className="bg-white w-full mx-auto max-w-sm rounded-t-3xl p-6 animate-slideUp max-h-[85vh] overflow-y-auto border-t border-achrams-border">
        <div className="flex justify-between items-center mb-6">
          <h3 className="text-xl font-bold text-achrams-text-primary">Service Area Limitation</h3>
          <button
            onClick={onClose}
            className="text-achrams-text-secondary hover:text-achrams-text-primary transition-colors"
          >
            <X className="w-6 h-6" />
          </button>
        </div>
        <div className="flex flex-col items-center gap-4 mb-6">
          <p className="text-center text-achrams-text-secondary">
            You are currently outside our service area. Booking is not available from this location.
          </p>
        </div>
        <button
          onClick={onClose} // Close the modal when OK is clicked
          className={`w-full py-4 rounded-xl font-semibold transition-all bg-achrams-gradient-primary text-achrams-text-light hover:opacity-90 active:scale-[0.98]`}
        >
          OK
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/CancelModal.tsx -----
// src/components/app/modals/CancelModal.tsx
import { X, MapPin } from 'lucide-react';
import { useState } from 'react';

const cancelReasons = [
  'Driver is taking too long',
  'Changed my mind',
  'Found another ride',
  'Driver is unprofessional',
  'Other'
];

interface CancelModalProps {
  isOpen: boolean;
  onClose: () => void;
  onConfirm: (reason: string, location?: [number, number], address?: string) => void;
  pickupAddress?: string;
}

export default function CancelModal({
  isOpen,
  onClose,
  onConfirm,
  pickupAddress,
}: CancelModalProps) {
  const [selectedReason, setSelectedReason] = useState<string | null>(null);
  const [otherReason, setOtherReason] = useState('');

  const handleConfirm = () => {
    const reason = selectedReason === 'Other' ? otherReason : selectedReason;
    if (reason) {
      // In real app, get current coordinates via Geolocation
      onConfirm(reason, undefined, pickupAddress);
    }
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 flex items-end z-50 animate-fadeIn">
      <div className="bg-white w-full rounded-t-3xl p-6 animate-slideUp max-h-[90vh] overflow-y-auto max-w-sm mx-auto">
        <div className="flex justify-between items-center mb-6">
          <h3 className="text-2xl font-bold">Cancel trip</h3>
          <button onClick={onClose}>
            <X className="w-6 h-6" />
          </button>
        </div>

        <p className="text-gray-600 mb-6">Why do you want to cancel?</p>

        <div className="space-y-3 mb-6">
          {cancelReasons.map((reason, idx) => (
            <button
              key={idx}
              onClick={() => setSelectedReason(reason)}
              className={`w-full text-left px-4 py-4 rounded-xl transition-all ${
                selectedReason === reason
                  ? 'bg-achrams-primary-solid text-white'
                  : 'bg-gray-50 hover:bg-gray-100'
              }`}
            >
              {reason}
            </button>
          ))}
        </div>

        {selectedReason === 'Other' && (
          <div className="mb-6">
            <textarea
              placeholder="Please specify..."
              value={otherReason}
              onChange={(e) => setOtherReason(e.target.value)}
              className="w-full px-4 py-3 bg-gray-50 rounded-xl outline-none resize-none"
              rows={2}
            />
          </div>
        )}

        {pickupAddress && (
          <div className="flex items-center gap-3 mb-6 p-4 bg-gray-50 rounded-xl">
            <MapPin className="w-5 h-5 text-gray-600 flex-shrink-0" />
            <span className="text-sm">{pickupAddress}</span>
          </div>
        )}

        <button
          onClick={handleConfirm}
          disabled={!selectedReason || (selectedReason === 'Other' && !otherReason.trim())}
          className="w-full bg-red-600 text-white py-4 rounded-xl font-semibold disabled:bg-gray-300"
        >
          Confirm cancellation
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/Disable2FAModal.tsx -----
// src/components/app/modals/Disable2FAModal.tsx
import { X, ShieldAlert, Loader } from 'lucide-react';
import { useState } from 'react';
import { apiClient } from '@/services/apiClient'; // Assuming you create this service

interface Disable2FAModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSuccess: () => void; // NEW: Callback after successful disable
}

export default function Disable2FAModal({
  isOpen,
  onClose,
  onSuccess,
}: Disable2FAModalProps) {
  if (!isOpen) return null;

  // NEW: State for OTP input, loading, error
  const [otp, setOtp] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  const handleDisable = async () => {
    setError(''); // Clear previous errors
    if (!otp) {
      setError('Please enter the OTP from your authenticator app.');
      return;
    }

    setLoading(true);
    try {
      // NEW: Call the disable API using apiClient
      // The exact endpoint might vary (e.g., POST /auth/passenger/2fa/disable, DELETE /auth/passenger/2fa, or PUT/PATCH with flag)
      // Check passenger postman DOC.txt for the correct endpoint.
      // Example: Assuming POST /auth/passenger/2fa/disable
      const response = await apiClient.post('/auth/passenger/2fa/disable', { // Use correct endpoint from Postman
        token: otp, // Or 'otp' depending on API expectation
      });

      console.log("2FA Disable Response:", response); // Debug log
      if (response.status === 200) { // Assuming 200 for success
        // NEW: On success, close modal and trigger success handler (e.g., update profile info in parent)
        onClose();
        onSuccess();
      } else {
          setError('Failed to disable 2FA. Please check the code and try again.');
      }
    } catch (err: any) {
        console.error("2FA Disable Error:", err);
        let errorMessage = 'An unexpected error occurred.';
        if (err.response && err.response.data && err.response.data.message) {
            errorMessage = err.response.data.message;
        } else if (err.message) {
            errorMessage = err.message;
        }
        setError(errorMessage);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 bg-opacity-70 flex items-end z-50">
      <div className="bg-achrams-bg-primary w-full max-w-sm mx-auto rounded-t-3xl p-6 animate-slideUp max-h-[90vh] overflow-y-auto border-t border-achrams-border max-w-sm mx-auto">
        <div className="flex justify-between items-center mb-6">
          <h3 className="text-xl font-bold text-achrams-text-primary">Disable Two-Factor Authentication</h3>
          <button
            onClick={onClose}
            disabled={loading} // NEW: Disable close button while loading
            className="text-achrams-text-secondary hover:text-achrams-text-primary transition-colors disabled:opacity-50"
          >
            <X className="w-6 h-6" />
          </button>
        </div>

        <div className="flex items-center gap-3 p-4 bg-achrams-bg-secondary rounded-xl border border-achrams-border mb-6">
          <ShieldAlert className="w-6 h-6 text-achrams-warning-dark flex-shrink-0" />
          <p className="text-achrams-text-secondary text-sm">
            Disabling 2FA reduces the security of your account. Are you sure you want to proceed?
          </p>
        </div>

        <input
          type="text"
          placeholder="Enter 6-digit code from app"
          value={otp}
          onChange={(e) => setOtp(e.target.value.replace(/\D/g, '').slice(0, 6))} // NEW: Allow only digits, max 6
          disabled={loading} // NEW: Disable input while loading
          className="w-full px-4 py-4 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border border-achrams-border mb-4"
        />

        {/* NEW: Error Message Display */}
        {error && (
          <p className="text-red-500 text-sm mb-4">{error}</p>
        )}

        <button
          onClick={handleDisable}
          disabled={loading || !otp} // NEW: Disable based on loading and OTP field
          className={`w-full py-4 rounded-xl font-semibold mb-3 transition-all ${
            loading || !otp
              ? 'bg-achrams-secondary-solid text-achrams-text-light opacity-75 cursor-not-allowed'
              : 'bg-red-600 text-achrams-text-light hover:opacity-90 active:scale-[0.98]'
          }`}
        >
          {loading ? ( // NEW: Show spinner while loading
            <div className="flex items-center justify-center">
              <Loader className="w-5 h-5 animate-spin mr-2" />
              Disabling...
            </div>
          ) : (
            'Disable 2FA'
          )}
        </button>

        <button
          onClick={onClose}
          disabled={loading} // NEW: Disable "Cancel" while loading
          className="w-full text-achrams-text-secondary font-medium hover:text-achrams-text-primary transition-colors disabled:opacity-50"
        >
          Cancel
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/AirportSelectionModal.tsx -----
// src/components/app/modals/AirportSelectionModal.tsx
import { X } from 'lucide-react';
import { Airport } from '@/lib/airports'; // Assuming this is your Airport type from src/lib/airports.ts

interface AirportSelectionModalProps {
  isOpen: boolean;
  onClose: () => void;
  airports: Airport[]; // List of airports returned by the API
  onSelect: (airport: Airport) => void; // Callback when an airport is selected
}

export default function AirportSelectionModal({
  isOpen,
  onClose,
  airports,
  onSelect,
}: AirportSelectionModalProps) {
  if (!isOpen || airports.length === 0) return null;

  return (
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 bg-opacity-70 flex items-end z-100">
      <div className="bg-white w-full rounded-t-3xl p-6 animate-slideUp max-h-[90vh] overflow-y-auto border-t border-achrams-border max-w-sm mx-auto">
        <div className="flex justify-between items-center mb-6 max-w-sm mx-auto">
          <h3 className="text-xl font-bold text-achrams-text-primary">Select Airport</h3>
          <button
            onClick={onClose}
            className="text-achrams-text-secondary hover:text-achrams-text-primary transition-colors"
          >
            <X className="w-6 h-6" />
          </button>
        </div>
        <div className="flex flex-col gap-2">
          {airports.map((airport) => (
            <button
              key={airport.id}
              onClick={() => {
                onSelect(airport); // Pass the selected airport back to the parent
                onClose(); // Close the modal
              }}
              className="w-full px-4 py-3 flex items-start gap-3 hover:bg-achrams-bg-secondary border border-achrams-border rounded-lg text-left transition-colors"
            >
              <div className="mt-0.5">
                {/* You could add an icon here if needed */}
              </div>
              <div>
                <div className="font-medium text-achrams-text-primary text-sm">{airport.name}</div>
                <div className="text-xs text-achrams-text-secondary">{airport.codename}</div>
              </div>
            </button>
          ))}
        </div>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/CancelTripModal.tsx -----
// src/components/app/modals/CancelTripModal.tsx
import { X } from 'lucide-react';

interface CancelTripModalProps {
  isOpen: boolean;
  onClose: () => void;
  onCancel: (reason: string) => void; // Callback to parent with the selected reason
  isCancelling: boolean; // Flag to show loading state in the modal
}

const REASON_OPTIONS = [
  "Did not find driver",
  "Driver did not show up",
  "Changed my mind",
  "Found another ride",
  "Trip is taking too long",
  "Other"
];

export default function CancelTripModal({
  isOpen,
  onClose,
  onCancel,
  isCancelling,
}: CancelTripModalProps) {
  if (!isOpen) return null;

  const handleSelectReason = (reason: string) => {
    onCancel(reason);
  };

  return (
    <div className="fixed inset-0 bg-achrams-bg-primary z-50 flex items-center justify-center p-4">
      <div className="bg-white rounded-xl shadow-lg w-full max-w-md">
        <div className="flex items-center justify-between p-4 border-b border-achrams-border">
          <h3 className="text-lg font-semibold text-achrams-text-primary">Cancel Trip</h3>
          <button
            onClick={onClose}
            disabled={isCancelling} // Prevent closing while cancelling
            className="text-achrams-text-secondary hover:text-achrams-text-primary transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <X className="w-5 h-5" />
          </button>
        </div>
        <div className="p-4">
          <p className="text-achrams-text-secondary mb-4">
            Please select a reason for cancelling your trip.
          </p>
          <div className="space-y-2 max-h-60 overflow-y-auto">
            {REASON_OPTIONS.map((reason) => (
              <button
                key={reason}
                onClick={() => handleSelectReason(reason)}
                disabled={isCancelling}
                className={`w-full text-left px-4 py-3 rounded-lg hover:bg-achrams-bg-secondary transition-colors ${
                  isCancelling
                    ? 'opacity-50 cursor-not-allowed'
                    : 'hover:bg-achrams-bg-secondary'
                }`}
              >
                {reason}
              </button>
            ))}
          </div>
        </div>
        <div className="p-4 pt-0">
          <button
            onClick={onClose}
            disabled={isCancelling} // Prevent closing while cancelling
            className="w-full py-3 bg-achrams-secondary-solid text-achrams-text-light rounded-lg hover:opacity-95 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Keep Trip
          </button>
        </div>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/DirectionsMapWrapper.tsx -----

// src/components/app/modals/DirectionsMapWrapper.tsx
import { GoogleMap, Marker, useJsApiLoader } from '@react-google-maps/api';
import { useEffect, useState, useMemo } from 'react';
import { useGeolocation } from '@/hooks/useGeolocation'; // assuming you have this

interface DirectionsMapWrapperProps {
  pickupCoords: [number, number] | null;
  destinationCoords: [number, number] | null;
  pickup: string;
  destination: string;
  driverLocation: [number, number] | null;
  // Optional: force re-center when driver moves far
  isTripActive?: boolean;
}

const DirectionsMapWrapper: React.FC<DirectionsMapWrapperProps> = ({
  pickupCoords,
  destinationCoords,
  driverLocation,
  isTripActive = false,
}) => {
  const [hasMounted, setHasMounted] = useState(false);
  const [mapCenter, setMapCenter] = useState<{ lat: number; lng: number }>({ lat: 6.5244, lng: 3.3792 });

  // Track passenger's real-time location
  const { coords: passengerCoords } = useGeolocation();

  // Extract passenger [lng, lat] from geolocation
  const passengerCurrentLocation: [number, number] | null = passengerCoords
    ? [passengerCoords.longitude, passengerCoords.latitude]
    : null;

  // Side effect: update map center based on trip state
  useEffect(() => {
    let newCenter = { lat: 6.5244, lng: 3.3792 };

    if (isTripActive && driverLocation) {
      // During active trip: center on driver (or midpoint between driver & passenger)
      if (passengerCurrentLocation) {
        // Optional: midpoint (more engaging)
        newCenter = {
          lat: (driverLocation[1] + passengerCurrentLocation[1]) / 2,
          lng: (driverLocation[0] + passengerCurrentLocation[0]) / 2,
        };
      } else {
        // Fallback: center on driver
        newCenter = { lat: driverLocation[1], lng: driverLocation[0] };
      }
    } else if (pickupCoords) {
      // Before trip starts: center on pickup
      newCenter = { lat: pickupCoords[1], lng: pickupCoords[0] };
    } else if (destinationCoords) {
      newCenter = { lat: destinationCoords[1], lng: destinationCoords[0] };
    } else if (passengerCurrentLocation) {
      newCenter = { lat: passengerCurrentLocation[1], lng: passengerCurrentLocation[0] };
    }

    setMapCenter(newCenter);
  }, [isTripActive, pickupCoords, destinationCoords, driverLocation, passengerCurrentLocation]);

  // Ensure first render only after mount
  useEffect(() => {
    setHasMounted(true);
  }, []);

  const { isLoaded, loadError } = useJsApiLoader({
    id: 'google-map-script-directions',
    googleMapsApiKey: process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY!,
    skip: !hasMounted,
  });

  if (!hasMounted) {
    return (
      <div className="absolute inset-0 flex items-center justify-center bg-achrams-bg-secondary">
        <p className="text-achrams-text-secondary">Preparing map...</p>
      </div>
    );
  }

  if (loadError) {
    return (
      <div className="absolute inset-0 flex items-center justify-center bg-achrams-bg-secondary">
        <p className="text-achrams-text-secondary">Map failed to load</p>
      </div>
    );
  }

  if (!isLoaded) {
    return (
      <div className="absolute inset-0 flex items-center justify-center bg-achrams-bg-secondary">
        <p className="text-achrams-text-secondary">Loading map...</p>
      </div>
    );
  }

  return (
    <div className="flex-1 relative">
      <GoogleMap
        mapContainerStyle={{ width: '100%', height: '100%' }}
        center={mapCenter}
        zoom={14}
        options={{
          streetViewControl: false,
          mapTypeControl: false,
          fullscreenControl: false,
        }}
      >
        {/* Pickup (static after booking) */}
        {pickupCoords && (
          <Marker
            position={{ lat: pickupCoords[1], lng: pickupCoords[0] }}
            icon={{
              url: 'https://maps.google.com/mapfiles/ms/micons/green-dot.png',
              scaledSize: new window.google.maps.Size(32, 32),
            }}
            title="Pickup"
          />
        )}

        {/* Destination (static) */}
        {destinationCoords && (
          <Marker
            position={{ lat: destinationCoords[1], lng: destinationCoords[0] }}
            icon={{
              url: 'https://maps.google.com/mapfiles/ms/micons/red-dot.png',
              scaledSize: new window.google.maps.Size(32, 32),
            }}
            title="Destination"
          />
        )}

        {/* Driver (live) */}
        {driverLocation && (
          <Marker
            position={{ lat: driverLocation[1], lng: driverLocation[0] }}
            icon={{
              url: 'https://maps.google.com/mapfiles/ms/micons/blue-dot.png', // or use a car icon
              scaledSize: new window.google.maps.Size(36, 36),
            }}
            title="Driver"
          />
        )}

        {/* Passenger (live) */}
        {passengerCurrentLocation && (
          <Marker
            position={{ lat: passengerCurrentLocation[1], lng: passengerCurrentLocation[0] }}
            icon={{
              url: 'https://maps.google.com/mapfiles/ms/micons/yellow-dot.png',
              scaledSize: new window.google.maps.Size(32, 32),
            }}
            title="You"
          />
        )}
      </GoogleMap>
    </div>
  );
};

export default DirectionsMapWrapper;

----- FILE: src/components/app/ui/ACHRAMFooter.tsx -----
// src/components/app/ui/ACHRAMFooter.tsx
import Link from 'next/link'; // Import Link from next/link for client-side navigation if needed, or use plain <a>

export default function ACHRAMFooter() {
  return (
    <footer className="py-3 px-6 text-center text-xs text-achrams-text-secondary bg-achrams-bg-primary border-t border-achrams-border">
      <p>
        Designed, Built and Powered by{' '}
        <Link
          href="https://www.exceliantech.com" // Use the full URL for external links
          target="_blank" // Open in a new tab for external links
          rel="noopener noreferrer" // Security best practice for target="_blank"
          className="text-achrams-primary-solid hover:text-achrams-primary-dark transition-colors underline"
        >
          Excelian Technologies
        </Link>
      </p>
    </footer>
  );
}

----- FILE: src/components/app/ui/BottomNavBar.tsx -----
// src/components/app/ui/BottomNavBar.tsx
import { House, Search, Wallet, User, Clock } from 'lucide-react';
import { usePathname, useRouter } from 'next/navigation'; // Or your routing library

interface BottomNavBarProps {
  onProfileClick: () => void; // Handler to open profile modal/settings
  walletBalance?: number; // Optional: Display small badge/indicator on wallet icon
  // NEW: Add handlers for other nav items if needed, e.g., onHomeClick, onSearchClick, onWalletClick
  onHomeClick?: () => void;
  onSearchClick?: () => void;
  onWalletClick?: () => void;
  onShowTripHistory?: () => void;
}

export default function BottomNavBar({
  onProfileClick,
  walletBalance,
  onHomeClick,
  onSearchClick,
  onWalletClick,
  onShowTripHistory,
}: BottomNavBarProps) {
  const pathname = usePathname();
  const router = useRouter();

  // Helper to determine if a nav item is active
  const isActive = (path: string) => pathname === path;

  // Handlers for navigation clicks
  const handleHomeClick = () => {
    if (onHomeClick) {
      onHomeClick(); // Allow parent to handle logic (e.g., scroll to top)
    } else {
      // Default behavior: navigate to dashboard if not already there
      if (pathname !== '/dashboard') {
        router.push('/dashboard');
      } else {
        // If already on dashboard, maybe scroll to top
        window.scrollTo(0, 0);
      }
    }
  };

  const handleSearchClick = () => {
      console.log("Trip History button clicked in BottomNavBar. onShowTripHistory prop exists:", !!onShowTripHistory); // Debug log
      if (onShowTripHistory) {
        console.log("Calling onShowTripHistory prop from BottomNavBar.");
        onShowTripHistory(); 
      } else {
        console.warn("onShowTripHistory prop was not provided to BottomNavBar.");
      }
    };

  const handleWalletClick = () => {
    if (onWalletClick) {
      onWalletClick();
    } else {
      // Navigate to wallet screen - placeholder path
      router.push('/wallet'); // Replace with actual wallet screen path
    }
  };

  return (
    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-achrams-border z-40">
      <div className="flex justify-around items-center py-3 px-2 mx-auto max-w-sm">
        <button
          onClick={handleHomeClick}
          className={`flex flex-col items-center justify-center gap-1 p-2 rounded-lg transition-colors ${
            isActive('/dashboard') ? 'text-achrams-primary-solid' : 'text-achrams-text-secondary'
          } transition-all hover:bg-green-50 active:scale-95 cursor-pointer`}
        >
          <House className={`w-6 h-6 ${isActive('/dashboard') ? 'fill-current' : ''}`} />
          <span className="text-xs">Home</span>
        </button>
        <button
          onClick={handleSearchClick}
          className={`flex flex-col items-center justify-center gap-1 p-2 rounded-lg transition-colors ${
            isActive('/search') ? 'text-achrams-primary-solid' : 'text-achrams-text-secondary'
          }  transition-all hover:bg-green-50 active:scale-95 cursor-pointer`}
        >
          <Clock className={`w-6 h-6 ${isActive('/search') ? 'fill-current' : ''}`} />
          <span className="text-xs">History</span>
        </button>

        
        {/* <button
          onClick={handleWalletClick}
          className={`flex flex-col items-center justify-center gap-1 p-2 rounded-lg transition-colors relative ${
            isActive('/wallet') ? 'text-achrams-primary-solid' : 'text-achrams-text-secondary'
          }  transition-all hover:bg-green-50 active:scale-95 cursor-pointer`}
        >
          <Wallet className={`w-6 h-6 ${isActive('/wallet') ? 'fill-current' : ''}`} />
          
          {walletBalance != null && walletBalance > 0 && (
            <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
              {walletBalance}
            </span>
          )}
          <span className="text-xs">Wallet</span>
        </button> */}


        <button
          onClick={onProfileClick}
          className={`flex flex-col items-center justify-center gap-1 p-2 rounded-lg transition-colors ${
            isActive('/profile') ? 'text-achrams-primary-solid' : 'text-achrams-text-secondary' // Assuming profile page path
          }  transition-all hover:bg-green-50 active:scale-95 cursor-pointer`}
        >
          <User className={`w-6 h-6 ${isActive('/profile') ? 'fill-current' : ''}`} />
          <span className="text-xs">Profile</span>
        </button>
      </div>
    </nav>
  );
  
}

----- FILE: src/components/app/ui/TripUpdateNotification.tsx -----
// src/components/app/ui/TripUpdateNotification.tsx
import { useEffect } from 'react';
import { AlertTriangle, CheckCircle, Info, X } from 'lucide-react';

interface TripUpdateNotificationProps {
  message: string;
  type: 'info' | 'success' | 'warning' | 'error';
  onDismiss: () => void;
}

export default function TripUpdateNotification({
  message,
  type,
  onDismiss,
}: TripUpdateNotificationProps) {
  let icon = null;
  let bgColor = '';
  let textColor = '';
  let iconColor = '';

  switch (type) {
    case 'info':
      icon = <Info className="w-5 h-5" />;
      bgColor = 'bg-blue-100';
      textColor = 'text-blue-800';
      iconColor = 'text-blue-500';
      break;
    case 'success':
      icon = <CheckCircle className="w-5 h-5" />;
      bgColor = 'bg-green-100';
      textColor = 'text-green-800';
      iconColor = 'text-green-500';
      break;
    case 'warning':
      icon = <AlertTriangle className="w-5 h-5" />;
      bgColor = 'bg-yellow-100';
      textColor = 'text-yellow-800';
      iconColor = 'text-yellow-500';
      break;
    case 'error':
      icon = <AlertTriangle className="w-5 h-5" />;
      bgColor = 'bg-red-100';
      textColor = 'text-red-800';
      iconColor = 'text-red-500';
      break;
  }

  useEffect(()=>{
    const timer = setTimeout(()=>{
      onDismiss();
    }, 6000);

    return() => {
      clearTimeout(timer);
    }

  }, [onDismiss]);

  return (
    <div className={`fixed top-4 left-1/2 transform -translate-x-1/2 max-w-xs w-full p-4 rounded-lg shadow-lg ${bgColor} ${textColor} flex items-start gap-2 z-60 animate-fadeInUp`}>
      <div className={`flex-shrink-0 mt-0.5 ${iconColor}`}>{icon}</div>
      <div className="flex-1">
        <p className="text-sm">{message}</p>
      </div>
      <button
        onClick={onDismiss}
        className="flex-shrink-0 text-current hover:opacity-80"
      >
        <X className="w-4 h-4" />
      </button>
    </div>
  );
}

----- FILE: src/components/app/screens/TripDetailsScreen.tsx -----
// src/components/app/screens/TripDetailsScreen.tsx
import { useEffect, useState } from "react";
import { Clock, MapPin, Wallet, Star, User, X, Plane } from "lucide-react";
import { apiClient } from "@/lib/api";
import { Driver } from "@/types/passenger"; // Assuming this type exists
import ACHRAMSHeader from "@/components/ui/ACHRAMSHeader";

// Reuse the Trip type from the modal if it's shared
interface TripDetailsScreenProps {
  tripId: string;
  onBack: () => void;
  showNotification: (message: string, type: "info" | "success" | "warning" | "error") => void;
}

// Assuming the same Trip interface from TripHistoryModal
interface Trip {
  id: string;
  amount: {
    formatted: string;
    currency: string;
    amount: number;
  };
  status: {
    label: string;
    value: string;
  };
  pickup_address: string;
  destination_address: string;
  verification_code: string;
  rating: number | null;
  map_data?: any; // Or a more specific type
  driver?: Driver;
  created_at?: string;
  // Add other fields as needed
}

export default function TripDetailsScreen({
  tripId,
  onBack,
  showNotification,
}: TripDetailsScreenProps) {
  const [trip, setTrip] = useState<Trip | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchTripDetails = async () => {
      if (!tripId) return;

      setLoading(true);
      setError(null);
      try {
        console.log("Fetching details for trip ID:", tripId);
        const response = await apiClient.get(`/trips/${tripId}`, undefined , false, undefined , true);
        console.log("Trip details API response:", response);

        if (response.status === "success" && response.data) {
          setTrip(response.data);
        } else {
          console.error("API response was not successful for trip details:", response);
          setError("Failed to fetch trip details.");
          showNotification("Failed to fetch trip details.", "error");
        }
      } catch (err) {
        console.error("Error fetching trip details:", err);
        setError("An error occurred while fetching trip details.");
        showNotification("Failed to fetch trip details. Please check your connection.", "error");
      } finally {
        setLoading(false);
      }
    };

    fetchTripDetails();
  }, [tripId, showNotification]);

  if (loading) {
    return (
      <div className="h-screen bg-achrams-bg-primary flex flex-col">
        <div className="bg-achrams-primary-solid text-achrams-text-light px-6 py-4 flex items-center justify-between">
          <button onClick={onBack} className="text-achrams-text-light">
            <X className="w-6 h-6" />
          </button>
          <ACHRAMSHeader title="Trip Details" />
          <div className="w-6"></div> {/* Spacer for alignment */}
        </div>
        <div className="flex-1 flex items-center justify-center">
          <div className="text-center">
            <Plane className="w-12 h-12 text-achrams-primary-solid mx-auto mb-4 animate-pulse" />
            <p className="text-achrams-text-secondary">Loading trip details...</p>
          </div>
        </div>
      </div>
    );
  }

  if (error || !trip) {
    return (
      <div className="h-screen bg-achrams-bg-primary flex flex-col z-50">
        <div className="bg-achrams-primary-solid text-achrams-text-light px-6 py-4 flex items-center justify-between">
          <button onClick={onBack} className="text-achrams-text-light">
            <X className="w-6 h-6" />
          </button>
          <ACHRAMSHeader title="Trip Details" />
          <div className="w-6"></div> {/* Spacer for alignment */}
        </div>
        <div className="flex-1 flex items-center justify-center">
          <div className="text-center px-6">
            <div className="text-red-500 mb-4">
              <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
            </div>
            <p className="text-achrams-text-secondary mb-4">{error || "Trip details not found."}</p>
            <button
              onClick={onBack}
              className="w-full py-3 bg-achrams-primary-solid text-achrams-text-light rounded-xl font-medium hover:opacity-90 active:scale-[0.98] transition-all"
            >
              Go Back
            </button>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="h-screen bg-achrams-bg-primary flex flex-col">
      {/* Header */}
      <div className="bg-achrams-primary-solid text-achrams-text-light px-6 py-4 flex items-center justify-between">
        <button onClick={onBack} className="text-achrams-text-light">
          <X className="w-6 h-6" />
        </button>
        <ACHRAMSHeader title="Trip Details" />
        <div className="w-6"></div> {/* Spacer for alignment */}
      </div>

      {/* Scrollable Content Area */}
      <div className="flex-1 overflow-y-auto px-6 py-6">
        {/* Trip Status Card */}
        <div className="bg-achrams-bg-secondary rounded-xl p-4 mb-6 border border-achrams-border">
          <div className="flex justify-between items-center mb-2">
            <h3 className="font-bold text-lg text-achrams-text-primary">Trip Status</h3>
            <span className={`text-xs px-3 py-1.5 rounded-full font-semibold ${
              trip.status.value === "completed"
                ? "bg-emerald-100 text-emerald-800"
                : "bg-amber-100 text-amber-800" // Assuming cancelled or other
            }`}>
              {trip.status.label}
            </span>
          </div>
          <p className="text-sm text-achrams-text-secondary">ID: {trip.id}</p>
        </div>

        {/* Driver Info (if available) */}
        {trip.driver && (
          <div className="bg-achrams-bg-secondary rounded-xl p-4 mb-6 border border-achrams-border">
            <h3 className="font-bold text-lg mb-3 text-achrams-text-primary flex items-center gap-2">
              <User className="w-5 h-5 text-achrams-text-secondary" />
              Driver
            </h3>
            <div className="flex items-center gap-4">
              <div className="w-12 h-12 bg-achrams-primary-solid rounded-full flex items-center justify-center text-achrams-text-light font-bold">
                {trip.driver.name?.charAt(0) || "D"}
              </div>
              <div>
                <p className="font-semibold text-achrams-text-primary">{trip.driver.name}</p>
                <div className="flex items-center gap-1">
                  <Star className="w-4 h-4 fill-yellow-500 text-yellow-500" />
                  <span className="text-sm text-achrams-text-primary">{trip.driver.rating || "N/A"}</span>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Trip Summary */}
        <div className="bg-achrams-bg-secondary rounded-xl p-4 mb-6 border border-achrams-border">
          <h3 className="font-bold text-lg mb-3 text-achrams-text-primary">Trip Summary</h3>
          <div className="space-y-4">
            {/* Pickup */}
            <div>
              <div className="flex items-center gap-2 mb-1">
                <div className="w-2 h-2 bg-achrams-primary-solid rounded-full"></div>
                <div className="text-xs text-achrams-text-secondary mb-1">PICKUP</div>
              </div>
              <div className="font-medium text-achrams-text-primary">{trip.pickup_address}</div>
            </div>

            {/* Destination */}
            <div>
              <div className="flex items-center gap-2 mb-1">
                <div className="w-2 h-2 bg-achrams-primary-solid rounded-full"></div>
                <div className="text-xs text-achrams-text-secondary mb-1">DESTINATION</div>
              </div>
              <div className="font-medium text-achrams-text-primary">{trip.destination_address}</div>
            </div>

            {/* Verification Code (if relevant for completed trips) */}
            {trip.verification_code && (
              <div>
                <div className="text-xs text-achrams-text-secondary mb-1">VERIFICATION CODE</div>
                <div className="font-mono font-bold text-achrams-text-primary text-lg">{trip.verification_code}</div>
              </div>
            )}
          </div>
        </div>

        {/* Fare & Date */}
        <div className="bg-achrams-bg-secondary rounded-xl p-4 mb-6 border border-achrams-border">
          <h3 className="font-bold text-lg mb-3 text-achrams-text-primary">Fare & Date</h3>
          <div className="space-y-3">
            <div className="flex justify-between items-center">
              <span className="text-achrams-text-secondary">Total Fare</span>
              <span className="text-xl font-bold text-achrams-text-primary">
                {trip.amount.formatted}
              </span>
            </div>
            <div className="flex justify-between items-center pt-2 border-t border-achrams-border">
              <span className="text-achrams-text-secondary flex items-center gap-1">
                <Clock className="w-4 h-4" />
                Date & Time
              </span>
              <span className="text-achrams-text-primary">
                {new Date(trip.created_at || '').toLocaleString() || "N/A"}
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

----- FILE: src/components/app/screens/TripProgressScreen.tsx -----
// src/components/app/screens/TripProgressScreen.tsx
"use client";

import { Shield, Navigation, MapPin, Car, Clock, Route } from "lucide-react";
import { GoogleMap, Marker, DirectionsRenderer, Polygon } from "@react-google-maps/api"; // Use DirectionsRenderer
import ACHRAMFooter from "@/components/app/ui/ACHRAMFooter";
import { useEffect, useState, useRef, useCallback } from "react";
import { InfoWindow } from "@react-google-maps/api";

interface Driver {
  name: string;
  initials?: string;
  location?: [number, number] | null;
  vehicle?: {
    make?: string;
    model?: string;
    plate?: string;
    color?: string;
  };
}

interface TripProgressScreenProps {
  driver: Driver | null;
  onPanic: () => void;
  onComplete: () => void;
  pickupCoords: [number, number] | null;
  destinationCoords: [number, number] | null;
  isGoogleMapsLoaded: boolean;
  googleMapsLoadError?: any;
  airportPickupArea?: any;
  screenPaddingClass: string;
  isAuthenticated: boolean;
  driverLocation: [number, number] | null;
  setDriverLocation: (val: [number, number] | null) => void;
}

const mapStyles = [
  {
    featureType: "poi.business",
    elementType: "labels",
    stylers: [{ visibility: "off" }]
  }
];



export default function TripProgressScreen({
  driver,
  onPanic,
  onComplete,
  pickupCoords,
  destinationCoords,
  isGoogleMapsLoaded,
  googleMapsLoadError,
  airportPickupArea,
  screenPaddingClass,
  isAuthenticated,
  driverLocation,
  setDriverLocation,
}: TripProgressScreenProps) {
  //  Store route info as state
  const [routeInfo, setRouteInfo] = useState<{ distance: string; duration: string } | null>(null);
  const [selectedMarker, setSelectedMarker] = useState<string | null>(null);
  const [map, setMap] = useState<google.maps.Map | null>(null);

  //  Track user interaction
  const [hasUserInteracted, setHasUserInteracted] = useState(false);
  const userInteractionRef = useRef(false);

  //  Refs for Directions Service and Renderer
  const directionsServiceRef = useRef<google.maps.DirectionsService | null>(null);
  const directionsRendererRef = useRef<google.maps.DirectionsRenderer | null>(null);


  const getDriverIcon = useCallback(
  () => ({
    path: "M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.22.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z",
    fillColor: "#F59E0B",
    fillOpacity: 1,
    strokeColor: "#FFFFFF",
    strokeWeight: 2.5,
    scale: 2.2,
    anchor: { x: 12, y: 12 } as google.maps.Point,
  }),
  []
);

const getDestinationIcon = useCallback(
  () => ({
    path: "M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z",
    fillColor: "#EF4444",
    fillOpacity: 1,
    strokeColor: "#FFFFFF",
    strokeWeight: 2.5,
    scale: 2.2,
    anchor: { x: 12, y: 24 } as google.maps.Point,
  }),
  []
);

  const getPolygonPaths = useCallback((): google.maps.LatLngLiteral[] => {
    if (!airportPickupArea?.geometry?.coordinates) return [];
    const coordinates = airportPickupArea.geometry.coordinates[0];
    return coordinates.map((coord: number[]) => ({
      lat: coord[1],
      lng: coord[0],
    }));
  }, [airportPickupArea]);

  const polygonPaths = getPolygonPaths();

  useEffect(() => {
    if (driver?.location) {
      setDriverLocation(driver.location); // Persist driver location in parent state
    }
  }, [driver, setDriverLocation]);

  //  Effect to listen for user interactions
  useEffect(() => {
    if (!map || hasUserInteracted) return;

    const handleMapInteraction = () => {
      if (!userInteractionRef.current) {
        console.log('User interacted with map - disabling auto-center/zoom');
        userInteractionRef.current = true;
        setHasUserInteracted(true);
      }
    };

    const centerListener = map.addListener('center_changed', handleMapInteraction);
    const zoomListener = map.addListener('zoom_changed', handleMapInteraction);
    const dragListener = map.addListener('dragstart', handleMapInteraction);

    return () => {
      if (centerListener) centerListener.remove();
      if (zoomListener) zoomListener.remove();
      if (dragListener) dragListener.remove();
    };
  }, [map, hasUserInteracted]);

  //  FIX: Fetch directions and use DirectionsRenderer
  useEffect(() => {
    if (!isGoogleMapsLoaded || !destinationCoords || !driverLocation || !window.google?.maps || !map) {
      return;
    }

    // Ensure DirectionsRenderer exists
    if (!directionsRendererRef.current) {
      directionsRendererRef.current = new google.maps.DirectionsRenderer({
        suppressMarkers: true,
        suppressInfoWindows: true,
        polylineOptions: {
          strokeColor: "#3B82F6",
          strokeOpacity: 0.8,
          strokeWeight: 6,
        },
      });
    }

    // Attach the renderer to the current map instance
    directionsRendererRef.current.setMap(map);

    // Ensure DirectionsService exists
    if (!directionsServiceRef.current) {
      directionsServiceRef.current = new google.maps.DirectionsService();
    }

    const origin = new google.maps.LatLng(driverLocation[1], driverLocation[0]);
    const destination = new google.maps.LatLng(destinationCoords[1], destinationCoords[0]);

    const request: google.maps.DirectionsRequest = {
      origin: origin,
      destination: destination,
      travelMode: google.maps.TravelMode.DRIVING,
    };

    directionsServiceRef.current.route(request, (result, status) => {
      if (status === google.maps.DirectionsStatus.OK && result && result.routes.length > 0) {
        const route = result.routes[0];
        const leg = route.legs[0];

        setRouteInfo({
          distance: leg.distance?.text || "N/A",
          duration: leg.duration?.text || "N/A",
        });

        //  SET the new directions using the renderer - this replaces the old route
        directionsRendererRef.current?.setDirections(result);
        console.log('Route fetched and rendered via DirectionsRenderer:', route.overview_path.length, 'points');
      } else {
        console.warn("Directions request failed:", status);
        setRouteInfo(null);
        //  Clear the route from the renderer if request fails
        directionsRendererRef.current?.setMap(null);
        directionsRendererRef.current?.setMap(map); // Reattach to map
      }
    });

    // Cleanup: Remove renderer from map when dependencies change
    return () => {
        if (directionsRendererRef.current) {
            directionsRendererRef.current.setMap(null); // Detach from map
        }
    };

  }, [driverLocation, destinationCoords, isGoogleMapsLoaded, map]); // Depend on map so it can attach/detach correctly


  //  Effect for fitBounds (runs only once or when user hasn't interacted and map/coords change)
  useEffect(() => {
    if (!map || !isGoogleMapsLoaded || hasUserInteracted) {
      return;
    }

    const bounds = new google.maps.LatLngBounds();
    let hasPoints = false;

    if (driverLocation) {
      bounds.extend({ lat: driverLocation[1], lng: driverLocation[0] });
      hasPoints = true;
    }
    if (destinationCoords) {
      bounds.extend({ lat: destinationCoords[1], lng: destinationCoords[0] });
      hasPoints = true;
    }
    if (pickupCoords) {
      bounds.extend({ lat: pickupCoords[1], lng: pickupCoords[0] });
      hasPoints = true;
    }
    if (polygonPaths.length > 0) {
      polygonPaths.forEach(point => bounds.extend(point));
      hasPoints = true;
    }

    if (hasPoints) {
      console.log('Auto-fitting map bounds (initial view)');
      map.fitBounds(bounds, { top: 100, right: 50, bottom: 150, left: 50 });
    }
  }, [map, driverLocation, destinationCoords, pickupCoords, polygonPaths, isGoogleMapsLoaded, hasUserInteracted]);

  const onLoad = useCallback((map: google.maps.Map) => {
    setMap(map);
    //  Attach renderer to the map instance once it loads
    if (directionsRendererRef.current) {
        directionsRendererRef.current.setMap(map);
    }
  }, []);

  const onUnmount = useCallback(() => {
    setMap(null);
    setHasUserInteracted(false);
    userInteractionRef.current = false;
    //  Clean up directions renderer
    if (directionsRendererRef.current) {
        directionsRendererRef.current.setMap(null);
        directionsRendererRef.current = null;
    }
    if (directionsServiceRef.current) {
        directionsServiceRef.current = null;
    }
  }, []);

  // Determine initial center only if user hasn't interacted
  const initialMapCenter = !hasUserInteracted ? (
    driverLocation
      ? { lat: driverLocation[1], lng: driverLocation[0] }
      : destinationCoords
      ? { lat: destinationCoords[1], lng: destinationCoords[0] }
      : { lat: 6.5244, lng: 3.3792 }
  ) : undefined;

  if (googleMapsLoadError) {
    return (
      <div className="h-screen bg-achrams-bg-primary flex flex-col">
        <div className="bg-achrams-primary-solid text-achrams-text-light px-6 py-4">
          <h1 className="text-xl font-bold">Trip in progress</h1>
        </div>
        <div className="flex-1 flex items-center justify-center bg-achrams-bg-secondary">
          <p className="text-achrams-text-secondary">Error loading map</p>
        </div>
        <ACHRAMFooter />
      </div>
    );
  }

  return (
    <div className="flex-1 bg-achrams-bg-primary flex flex-col">
      {driver && (
        <>
          <div className="bg-achrams-primary-solid text-achrams-text-light px-6 py-4 flex items-center justify-between shadow-md">
            <div className="flex items-center gap-2">
              <div className="w-10 h-10 bg-white/10 backdrop-blur-sm rounded-xl flex items-center justify-center">
                <Navigation className="w-5 h-5" />
              </div>
              <div>
                <h1 className="text-lg font-bold">Trip in Progress</h1>
                <p className="text-xs text-achrams-text-light/80">Live tracking</p>
              </div>
            </div>
            <button
              onClick={onPanic}
              className="w-12 h-12 bg-gradient-to-br from-red-500 to-red-700 rounded-full shadow-lg flex items-center justify-center border-2 border-white hover:from-red-600 hover:to-red-800 active:scale-95 hover:scale-105 transition-all duration-200"
            >
              <Shield className="w-6 h-6 text-white" />
            </button>
          </div>

          {routeInfo && (
            <div className="bg-white border-b border-achrams-border px-6 py-3 shadow-sm">
              <div className="flex items-center justify-between gap-4">
                <div className="flex items-center gap-2">
                  <div className="w-9 h-9 bg-achrams-primary-solid/5 rounded-lg flex items-center justify-center">
                    <Route className="w-4 h-4 text-achrams-primary-solid" />
                  </div>
                  <div>
                    <p className="text-xs text-achrams-text-secondary font-medium">Distance</p>
                    <p className="text-sm font-bold text-achrams-text-primary">{routeInfo.distance}</p>
                  </div>
                </div>
                <div className="w-px h-10 bg-achrams-border"></div>
                <div className="flex items-center gap-2">
                  <div className="w-9 h-9 bg-achrams-secondary-solid/5 rounded-lg flex items-center justify-center">
                    <Clock className="w-4 h-4 text-achrams-secondary-solid" />
                  </div>
                  <div>
                    <p className="text-xs text-achrams-text-secondary font-medium">ETA</p>
                    <p className="text-sm font-bold text-achrams-text-primary">{routeInfo.duration}</p>
                  </div>
                </div>
              </div>
            </div>
          )}

          <div className="flex-1 relative">
            {isGoogleMapsLoaded ? (
              <GoogleMap
                mapContainerStyle={{ width: "100%", height: "100%" }}
                center={hasUserInteracted ? undefined : initialMapCenter}
                zoom={hasUserInteracted ? undefined : 14}
                onLoad={onLoad}
                onUnmount={onUnmount}
                options={{
                  styles: mapStyles,
                  streetViewControl: false,
                  mapTypeControl: false,
                  fullscreenControl: false,
                  zoomControl: true,
                  zoomControlOptions: {
                    position: google.maps.ControlPosition.RIGHT_CENTER,
                  },
                  draggable: true,
                  scrollwheel: true,
                  disableDefaultUI: false,
                }}
              >
                {/*  Polygon */}
                {polygonPaths.length > 0 && (
                  <Polygon
                    paths={polygonPaths}
                    options={{
                      fillColor: '#10B981',
                      fillOpacity: 0.2,
                      strokeColor: '#10B981',
                      strokeOpacity: 0.8,
                      strokeWeight: 2,
                    }}
                  />
                )}

                {/*  Destination Marker */}
                {destinationCoords && (
                  <Marker
                    position={{
                      lat: destinationCoords[1],
                      lng: destinationCoords[0],
                    }}
                    icon={getDestinationIcon()}
                    title="Destination"
                    onClick={() => setSelectedMarker("destination")}
                  />
                )}

                {/*  Driver Marker */}
                {driverLocation && (
                  <Marker
                    position={{
                      lat: driverLocation[1],
                      lng: driverLocation[0],
                    }}
                    icon={getDriverIcon()}
                    title={`Driver: ${driver.name}`}
                    onClick={() => setSelectedMarker("driver")}
                  />
                )}

                {/*  InfoWindow for Destination */}
                {selectedMarker === "destination" && destinationCoords && (
                  <InfoWindow
                    position={{
                      lat: destinationCoords[1],
                      lng: destinationCoords[0],
                    }}
                    onCloseClick={() => setSelectedMarker(null)}
                  >
                    <div className="p-2">
                      <div className="flex items-center gap-2 mb-2">
                        <div className="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center">
                          <MapPin className="w-4 h-4 text-red-600" />
                        </div>
                        <span className="font-bold text-gray-900">Destination</span>
                      </div>
                      {routeInfo && (
                        <div className="text-xs text-gray-600 space-y-1">
                          <p className="flex items-center gap-1">
                            <Route className="w-3 h-3" />
                            {routeInfo.distance} away
                          </p>
                          <p className="flex items-center gap-1">
                            <Clock className="w-3 h-3" />
                            {routeInfo.duration} remaining
                          </p>
                        </div>
                      )}
                    </div>
                  </InfoWindow>
                )}

                {selectedMarker === "driver" && driverLocation && driver && (
                  <InfoWindow
                    position={{
                      lat: driverLocation[1],
                      lng: driverLocation[0],
                    }}
                    onCloseClick={() => setSelectedMarker(null)}
                  >
                    <div className="p-2">
                      <div className="flex items-center gap-2 mb-2">
                        <div className="w-8 h-8 bg-amber-100 rounded-lg flex items-center justify-center">
                          <Car className="w-4 h-4 text-amber-600" />
                        </div>
                        <span className="font-bold text-gray-900">{driver.name}</span>
                      </div>
                      {routeInfo && (
                        <div className="text-xs text-gray-600 space-y-1">
                          <p className="flex items-center gap-1">
                            <Route className="w-3 h-3" />
                            {routeInfo.distance} to destination
                          </p>
                          <p className="flex items-center gap-1">
                            <Clock className="w-3 h-3" />
                            {routeInfo.duration} away
                          </p>
                        </div>
                      )}
                    </div>
                  </InfoWindow>
                )}
              </GoogleMap>
            ) : (
              <div className="absolute inset-0 flex items-center justify-center bg-achrams-bg-secondary">
                <div className="text-center">
                  <div className="w-12 h-12 border-4 border-achrams-primary-solid border-t-transparent rounded-full animate-spin mx-auto mb-3"></div>
                  <p className="text-achrams-text-secondary text-sm">Loading map...</p>
                </div>
              </div>
            )}
          </div>

          <div className={`bg-achrams-bg-primary px-6 py-5 border-t border-achrams-border shadow-lg ${isAuthenticated ? 'mb-10': ''}`}>
            <div className="flex items-center gap-4">
              <div className="relative">
                <div className="w-16 h-16 bg-gradient-to-br from-achrams-primary-solid to-achrams-secondary-solid rounded-2xl flex items-center justify-center text-achrams-text-light text-xl font-bold shadow-md ring-4 ring-achrams-primary-solid/10">
                  {driver.initials || driver.name?.charAt(0) || "D"}
                </div>
                <div className="absolute -bottom-1 -right-1 w-5 h-5 bg-green-500 rounded-full border-3 border-white shadow-sm"></div>
              </div>
              <div className="flex-1">
                <div className="font-bold text-achrams-text-primary text-lg">
                  {driver.name}
                </div>
                <div className="text-sm text-achrams-text-secondary flex items-center gap-1 mt-0.5">
                  <Navigation className="w-3.5 h-3.5" />
                  En route to destination
                </div>
                {routeInfo && (
                  <div className="flex items-center gap-3 mt-2 text-xs text-achrams-text-secondary">
                    <span className="flex items-center gap-1">
                      <Route className="w-3 h-3" />
                      {routeInfo.distance}
                    </span>
                    <span></span>
                    <span className="flex items-center gap-1">
                      <Clock className="w-3 h-3" />
                      {routeInfo.duration}
                    </span>
                  </div>
                )}
              </div>
            </div>
          </div>
          <ACHRAMFooter />
        </>
      )}
    </div>
  );
}





----- FILE: src/components/app/screens/BookingScreen.tsx -----
// "use client";
import { useState, useEffect, useRef, useCallback } from "react";
import {
  MapPin,
  Navigation,
  Plane,
  ChevronDown,
  X,
  Loader,
  ChevronLeft,
} from "lucide-react";
import { useGeolocation } from "@/hooks/useGeolocation";
import ACHRAMSHeader from "@/components/ui/ACHRAMSHeader";
import { findNearestAirport, Airport } from "@/lib/airports";
import { LoadScript, StandaloneSearchBox } from "@react-google-maps/api";
import AirportSelectionModal from "@/components/app/modals/AirportSelectionModal";
import OutsideServiceAreaModal from "@/components/app/modals/OutsideServiceAreaModal";
import { apiClient } from "@/lib/api";
import ACHRAMFooter from "@/components/app/ui/ACHRAMFooter";

interface LocationData {
  name: string;
  coords: [number, number] | null;
  id?: string;
  codename?: string;
}

interface BookingScreenProps {
  pickup: string;
  setPickup: (val: string) => void;
  destination: string;
  setDestination: (val: string) => void;
  fareEstimate: number | null;
  setFareEstimate: (val: number | null) => void;
  onProceed: () => void;
  setShowPassengerDetails: (val: boolean) => void;
  passengerData: any;
  setPassengerData: (val: any) => void;
  showPassengerDetails: boolean;
  requirements: any;
  setRequirements: (val: any) => void;
  setPickupCoords: (coords: [number, number] | null) => void;
  setDestinationCoords: (coords: [number, number] | null) => void;
  tripRequestStatus: "loading" | "accepted" | "no-driver" | "error" | null;
  resetKey: number;
  setPickupId: (id: string | null) => void;
  setPickupCodename: (codename: string | undefined) => void;
  fareIsFlatRate: boolean | null;
  setFareIsFlatRate: (val: boolean | null) => void;

  isGoogleMapsLoaded: boolean;
  googleMapsLoadError?: Error | undefined;
  onShowLogin: (val: boolean) => void;
  showNotification: (
    message: string,
    type: "info" | "success" | "warning" | "error"
  ) => void;
  isAuthenticated: boolean;
  onBackToDashboard: () => void;
  screenPaddingClass: string;
}

const losCoords: [number, number] = [3.330058, 6.568287];
const abvCoords: [number, number] = [7.2667, 9.0167];

const GOOGLE_MAPS_API_KEY = process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY!;
const libraries: "places"[] = ["places"];

// Custom debounce hook (lightweight & stable)
function useDebounceCallback<T extends (...args: any[]) => any>(
  callback: T,
  delay: number
) {
  const timeoutRef = useRef<NodeJS.Timeout | null>(null);

  useEffect(() => {
    return () => {
      if (timeoutRef.current) clearTimeout(timeoutRef.current);
    };
  }, []);

  return useCallback(
    ((...args: Parameters<T>) => {
      if (timeoutRef.current) clearTimeout(timeoutRef.current);
      timeoutRef.current = setTimeout(() => {
        callback(...args);
      }, delay);
    }) as T,
    [callback, delay]
  );
}

export default function BookingScreen({
  pickup,
  setPickup,
  destination,
  setDestination,
  fareEstimate,
  setFareEstimate,
  onProceed,
  setPickupCoords,
  setDestinationCoords,
  tripRequestStatus,
  resetKey,
  setPickupId,
  setPickupCodename,
  fareIsFlatRate,
  setFareIsFlatRate,
  isGoogleMapsLoaded,
  googleMapsLoadError,
  showNotification,
  onShowLogin,
  isAuthenticated,
  onBackToDashboard,
  screenPaddingClass,
}: BookingScreenProps) {
  const [pickupOpen, setPickupOpen] = useState(false);
  const [destOpen, setDestOpen] = useState(false);
  const [showAirportSelectionModal, setShowAirportSelectionModal] =
    useState(false);
  const [airportsToSelect, setAirportsToSelect] = useState<Airport[]>([]);
  const [showOutsideServiceModal, setShowOutsideServiceModal] = useState(false);
  const [showLocationSettingsModal, setShowLocationSettingsModal] =
    useState(false);


  const searchBoxRef = useRef<google.maps.places.SearchBox | null>(null);
  const destinationInputRef = useRef<HTMLInputElement>(null);
  const pickupSearchBoxRef = useRef<google.maps.places.SearchBox | null>(null);
  const pickupInputRef = useRef<HTMLInputElement>(null);

  const {
    coords,
    error,
    requestPermission,
    loading: hookLoading,
  } = useGeolocation();
  const [isFetchingLocation, setIsFetchingLocation] = useState(false);

  const [pickupLocationData, setPickupLocationData] = useState<LocationData>({
    name: pickup,
    coords: null,
    id: undefined,
    codename: undefined,
  });

  const [destinationLocationData, setDestinationLocationData] =
    useState<LocationData>({
      name: destination,
      coords: null,
    });

  useEffect(() => {
    console.log("DEBUG: Reset key changed, resetting booking screen state");
    setPickupLocationData({ name: "", coords: null });
    setDestinationLocationData({ name: "", coords: null });
  }, [resetKey]); // Depend on resetKey

  // Sync local state  parent
  useEffect(() => {
    console.log(
      "DEBUG: Syncing pickup data to parent - Name: ",
      pickupLocationData.name
    );
    setPickup(pickupLocationData.name);
    setPickupCoords(pickupLocationData.coords);
  }, [pickupLocationData, setPickup, setPickupCoords]);

  useEffect(() => {
    console.log(
      "DEBUG: Syncing destination data to parent - Name:",
      destinationLocationData.name,
      "coords:",
      destinationLocationData.coords
    );
    setDestination(destinationLocationData.name);
    setDestinationCoords(destinationLocationData.coords);
  }, [destinationLocationData, setDestination, setDestinationCoords]);

  useEffect(() => {
    setPickupCodename(pickupLocationData.codename);
  }, [pickupLocationData.codename, setPickupCodename]);

  const fetchFareEstimate = async (
    airportCodename: string,
    destinationName: string
  ): Promise<number | null> => {
    if (!airportCodename || !destinationName) {
      console.warn(
        "Cannot fetch fare: airport codename or destination name is missing"
      );
      setFareEstimate(null);
      setFareIsFlatRate(null);
      return null;
    }
    try {
      console.log(
        `Fetching fare for airport: ${airportCodename}, destination: ${destinationName}`
      );
      // The 'search' parameter is the destination address string.
      // The 'airport' parameter is the airport codename.
      const response = await apiClient.get(
        `/fares/lookup?airport=${encodeURIComponent(
          airportCodename
        )}&search=${encodeURIComponent(destinationName)}`
      );
      // ikeja
      console.log(`Estimated Fare Response: ${response}`);

      if (response.status === "success" && response.data) {
        const fareData = response.data;
        console.log("Fetched fare data:", fareData);
        // Return the numeric amount from the API response
        setFareEstimate(fareData.amount.amount);
        setFareIsFlatRate(fareData.is_flat_rate);
        return fareData.amount.amount; // e.g., 100 from the example
      } else {
        console.log(
          "Fare lookup API responded with non-success status or missing data:",
          response
        );

        setFareEstimate(null);
        setFareIsFlatRate(null);
        return null;
      }
    } catch (err) {
      console.error("Error fetching fare estimate:", err);
      //showNotification("Could not fetch fare estimate. Using default.", "warning"); // Example
      setFareEstimate(null);
      setFareIsFlatRate(null);
      return null;
    }
  };

  useEffect(() => {
    const getFare = async () => {
      // Only proceed if both codename and destination name are present
      if (pickupLocationData.codename && destinationLocationData.name) {
        // Show a loading state if desired (e.g., disable proceed button, show spinner next to fare)
        // setIsFetchingFare(true); // Example state

        const fare = await fetchFareEstimate(
          pickupLocationData.codename,
          destinationLocationData.name
        );

        // setIsFetchingFare(false); // Example state

        if (fare !== null) {
          // Update the parent's fare estimate state
          setFareEstimate(fare);
        } else {
          // Handle case where fare lookup failed
          // You might want to clear the estimate or show an error
          setFareIsFlatRate(null);
          setFareEstimate(null); // Or keep the previous value, or set to -1 to indicate error
          // showNotification("Failed to get fare estimate.", "error"); // Example
        }
      } else {
        // If either codename or destination name is missing, clear the estimate
        setFareEstimate(null);
        setFareIsFlatRate(null);
      }
    };

    getFare(); // Call the async function

    // Depend on the codename and destination name to re-run the effect when they change
  }, [
    pickupLocationData.codename,
    destinationLocationData.name,
    setFareEstimate,
    setFareIsFlatRate,
  ]);

  // Reset fetching state when trip request ends
  useEffect(() => {
    if (tripRequestStatus !== "loading") {
      setIsFetchingLocation(false);
    }
  }, [tripRequestStatus]);

  const showFetchingUI = isFetchingLocation || hookLoading;

  useEffect(() => {
    setPickupId(pickupLocationData.id || null);
  }, [pickupLocationData.id, setPickupId]);

  // Stable debounced handler
  const debouncedDestinationInput = useDebounceCallback((value: string) => {
    console.log("Destination input settled:", value);
    // Add custom logic here if needed (e.g. fallback API search)
  }, 300);

  // Stable change handler
  const handleDestinationChanged = useCallback(
    (e: React.ChangeEvent<HTMLInputElement>) => {
      const value = e.target.value;
      setDestinationLocationData((prev) => ({ ...prev, name: value }));
      if (value.trim()) {
        setDestOpen(true);
      }
      debouncedDestinationInput(value);
    },
    [debouncedDestinationInput]
  );

  const geolocationCoordsRef = useRef<[number, number] | null>(null);

  const handlePlaceChanged = useCallback(() => {
    if (isGoogleMapsLoaded && searchBoxRef.current) {
      // NEW: Only run if API is loaded
      const places = searchBoxRef.current.getPlaces();
      if (places && places.length > 0) {
        const place = places[0];
        if (place.geometry && place.geometry.location) {
          const lat = place.geometry.location.lat();
          const lng = place.geometry.location.lng();
          setDestinationLocationData({
            name: place.formatted_address || place.name || "", // Prefer formatted address, fallback to name
            coords: [lng, lat], // [longitude, latitude]
          });
          setDestOpen(false); // Close the dropdown after selection
        } else {
          console.error("Place selected but no geometry.location found.");
        }
      } else {
        console.log("No places found from search box.");
        // Optionally clear coordinates if user clears the input and presses enter/selects nothing
        setDestinationLocationData((prev) => ({ ...prev, coords: null }));
      }
    }
  }, [isGoogleMapsLoaded]);

  const handlePickupPlaceChanged = useCallback(() => {
    if (isGoogleMapsLoaded && pickupSearchBoxRef.current) {
      const places = pickupSearchBoxRef.current.getPlaces();
      if (places && places.length > 0) {
        const place = places[0];
        if (place.geometry?.location) {
          const lat = place.geometry.location.lat();
          const lng = place.geometry.location.lng();
          const coords: [number, number] = [lng, lat];

          // Close dropdown
          setPickupOpen(false);

          // Trigger airport lookup using these coords
          (async () => {
            setIsFetchingLocation(true);
            try {
              const airports = await findNearestAirport(lng, lat);
              if (airports && airports.length > 0) {
                if (airports.length === 1) {
                  setPickupLocationData({
                    name: airports[0].name,
                    coords,
                    id: airports[0].id,
                    codename: airports[0].codename,
                  });
                } else {
                  setAirportsToSelect(airports);
                  setShowAirportSelectionModal(true);
                  // Store coords for later use in modal selection
                  geolocationCoordsRef.current = coords;
                }
              } else {
                setShowOutsideServiceModal(true);
              }
            } catch (err) {
              console.error(
                "Failed to fetch airports for pickup location:",
                err
              );
              showNotification(
                "Failed to fetch airports for pickup location. Please try again",
                "error"
              );
              //  Notify user  see Step 4 for implementation
              onShowLogin(false); // Placeholder  youll replace this with real notification
              // Example: showNotification("Failed to find nearby airport. Please try again.", "error");
            } finally {
              setIsFetchingLocation(false);
            }
          })();
        } else {
          console.warn("Selected pickup place has no geometry.");
        }
      }
    }
  }, [isGoogleMapsLoaded]);

  const handleClearDestination = useCallback(() => {
    setDestinationLocationData({ name: "", coords: null });
    setDestOpen(false);
    destinationInputRef.current?.focus();
  }, []);

  const handleUseCurrentLocation = useCallback(async () => {
    if (error?.includes("denied")) {
      setShowLocationSettingsModal(true);
      setPickupOpen(false);
      return;
    }

    setIsFetchingLocation(true);
    setPickupOpen(false);

    try {
      const position = await requestPermission();
      if (!position) throw new Error("No coordinates");

      const { latitude, longitude } = position;
      console.log(
        "DEBUG: handleUseCurrentLocation - Got geolocation:",
        longitude,
        latitude
      );

      const coords = [latitude, longitude] as [number, number];

      geolocationCoordsRef.current = coords;

      const airports = await findNearestAirport(latitude, longitude);
      console.log(
        "DEBUG: handleUseCurrentLocation - Found airports:",
        airports
      );
      if (airports && airports.length > 0) {
        if (airports.length === 1) {
          console.log(
            "DEBUG: handleUseCurrentLocation - Setting single airport:",
            airports[0].name,
            "with coords:",
            [longitude, latitude]
          );

          setPickupLocationData({
            name: airports[0].name,
            coords: [latitude, longitude],
            id: airports[0].id,
            codename: airports[0].codename,
          });
        } else {
          setAirportsToSelect(airports);
          setShowAirportSelectionModal(true);
        }
      } else {
        setShowOutsideServiceModal(true);
      }
    } catch (err) {
      console.error("Location fetch failed:", err);
      showNotification(`Location fetch failed, Kindly search your location  `, 'error')
    } finally {
      setIsFetchingLocation(false);
    }
  }, [error, requestPermission]);

  const handleAirportSelectedFromModal = useCallback((airport: Airport) => {
    
    const geolocationCoords = geolocationCoordsRef.current;

    console.log(
      "DEBUG: handleAirportSelectedFromModal - Selected airport:",
      airport,
      "Retaining coords:",
      geolocationCoords
    );
    console.log(
      "DEBUG: handleAirportSelectedFromModal - Using coords from SELECTED airport object:",
      geolocationCoords
    );
    setPickupLocationData({
      name: airport.name,
      coords: geolocationCoords,
      id: airport.id,
      codename: airport.codename,
    });
    setShowAirportSelectionModal(false);
  }, []);

  const handleAirportSelect = useCallback((airportId: string) => {
    const map: Record<
      string,
      { name: string; coords: [number, number]; id: string; codename?: string }
    > = {
      los: {
        name: "Murtala Muhammed Int'l Airport (LOS)",
        coords: losCoords,
        id: "0199de42-10b4-7f53-b670-42f107897a1d",
        codename: "actual_codename",
      },
      abv: {
        name: "Nnamdi Azikiwe Int'l Airport (ABV)",
        coords: abvCoords,
        id: "actual_id",
        codename: "Acutal_codeName",
      },
    };

    const selected = map[airportId];
    if (selected) {
      console.log(
        "DEBUG: handleAirportSelect - Setting pickup to:",
        selected.name,
        "with coords:",
        selected.coords
      );
      setPickupLocationData({
        name: selected.name,
        coords: selected.coords,
        id: selected.id,
        codename: selected.codename,
      });
    } else {
      console.warn(
        "DEBUG: handleAirportSelect - Airport ID not found in map:",
        airportId
      );
    }
    setPickupOpen(false);
  }, []);

  return (
    <div className="bg-achrams-bg-primary flex flex-col flex-1">
      <AirportSelectionModal
        isOpen={showAirportSelectionModal}
        onClose={() => setShowAirportSelectionModal(false)}
        airports={airportsToSelect}
        onSelect={handleAirportSelectedFromModal}
      />
      <OutsideServiceAreaModal
        isOpen={showOutsideServiceModal}
        onClose={() => setShowOutsideServiceModal(false)}
      />

      <div className="bg-achrams-primary-solid text-achrams-text-light px-0 py-4">
        <div className="px-6">
          <ACHRAMSHeader title="" />
        </div>
      </div>

      {/* {isAuthenticated && onBackToDashboard && (
              <button
      onClick={onBackToDashboard}
      className="flex items-center gap-1 px-3 py-2 rounded-lg bg-achrams-primary-light text-achrams-primary-solid hover:bg-achrams-primary hover:shadow-md transition-all"
    >
      <ChevronLeft className="w-5 h-5" />
      <span className="text-sm font-medium">Back</span>
    </button>
            )} */}

      {error?.includes("denied") && (
        <div className="bg-blue-600 text-achrams-text-light p-3 flex items-center justify-between">
          <div className="flex items-center gap-2">
            <Navigation className="w-5 h-5" />
            <span>This app requires your location access to work</span>
          </div>
          <button
            onClick={() => setShowLocationSettingsModal(true)}
            className="bg-white text-achrams-text-primary px-4 py-1 rounded-full text-sm font-medium hover:bg-achrams-bg-primary"
          >
            Grant access
          </button>
        </div>
      )}

      {showLocationSettingsModal && (
        <div className="fixed inset-0 bg-achrams-secondary-solid/50 bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg p-6 max-w-md w-full">
            <h3 className="text-lg font-semibold mb-2">
              Enable Location Access
            </h3>
            <p className="mb-4">
              Please allow location access in your browser settings.
            </p>
            <ol className="list-decimal list-inside mb-4 space-y-1 text-sm">
              <li>Click the lock/info icon in the address bar</li>
              <li>Go to "Site settings"  "Location"  Allow</li>
              <li>Refresh the page</li>
            </ol>
            <button
              onClick={() => setShowLocationSettingsModal(false)}
              className="w-full bg-achrams-primary-solid text-white py-2 rounded-lg"
            >
              Close
            </button>
          </div>
        </div>
      )}

      <div
        className={`flex-1 px-6 py-8 overflow-y-auto ${screenPaddingClass}`}
      >
        <h2 className="text-2xl font-semibold tracking-tight text-achrams-text-primary pb-4">
          Book Your Airport Ride
        </h2>

        <div className="space-y-4">
          {/* Pickup */}
          <div className="relative">
            {!isGoogleMapsLoaded ? (
              <div className="flex items-center gap-3 bg-achrams-bg-secondary rounded-xl px-4 py-4 border border-achrams-border">
                <div className="w-2 h-2 bg-achrams-primary-solid rounded-full" />
                <input
                  type="text"
                  placeholder="Airport pickup location (Loading...)"
                  value={pickupLocationData.name}
                  onChange={() => {}}
                  className="flex-1 bg-transparent outline-none text-base text-achrams-text-secondary italic "
                  disabled
                />
              </div>
            ) : (
              <StandaloneSearchBox
                onLoad={(ref) => (pickupSearchBoxRef.current = ref)}
                onUnmount={() => (pickupSearchBoxRef.current = null)}
                onPlacesChanged={handlePickupPlaceChanged}
              >
                <div className=" left-0 flex items-center gap-3 bg-achrams-bg-secondary rounded-xl px-4 py-4 border border-achrams-border h-14 w-full">
                  <div className="w-2 h-2 bg-achrams-primary-solid rounded-full" />
                  <input
                    ref={pickupInputRef}
                    type="text"
                    placeholder="Search pickup location"
                    value={
                      showFetchingUI
                        ? "Getting your location..."
                        : pickupLocationData.name
                    }
                    onChange={(e) =>
                      !showFetchingUI &&
                      setPickupLocationData((prev) => ({
                        ...prev,
                        name: e.target.value,
                      }))
                    }
                    onFocus={() => !showFetchingUI && setPickupOpen(true)}
                    readOnly={showFetchingUI}
                    className={`flex-1 bg-transparent outline-none text-base ${
                      showFetchingUI
                        ? "text-achrams-text-secondary italic"
                        : "text-achrams-text-primary"
                    }`}
                  />
                  <button
                    onClick={() =>
                      !showFetchingUI && setPickupOpen(!pickupOpen)
                    }
                    disabled={showFetchingUI}
                    className={`p-2 transition-colors ${
                      showFetchingUI
                        ? "text-achrams-text-secondary opacity-50 cursor-not-allowed"
                        : "text-achrams-text-secondary hover:text-achrams-text-primary"
                    }`}
                  >
                    {showFetchingUI ? (
                      <Loader className="w-5 h-5 animate-spin text-achrams-primary-solid" />
                    ) : pickupOpen ? (
                      <ChevronDown className="w-5 h-5" />
                    ) : (
                      <Navigation className="w-5 h-5" />
                    )}
                  </button>
                </div>
              </StandaloneSearchBox>
            )}

            {pickupOpen && !showFetchingUI && isGoogleMapsLoaded && (
              <div className="absolute top-full w-full mt-1 bg-white rounded-xl shadow-lg border border-achrams-border z-50 max-h-64 overflow-y-auto">
                <button
                  onClick={handleUseCurrentLocation}
                  className="w-full px-4 py-3 flex items-center gap-3 hover:bg-achrams-bg-secondary text-left"
                >
                  <MapPin className="w-5 h-5 text-achrams-primary-solid" />
                  <span>Use my current location</span>
                </button>
                {/* Optionally: Add "Or type to search" hint */}
              </div>
            )}
          </div>

          {/* Destination */}
          <div className="relative w-full">
            {!isGoogleMapsLoaded ? (
              <div className="flex items-center gap-3 bg-achrams-bg-secondary rounded-xl px-4 py-4 border border-achrams-border">
                <div className="w-2 h-2 bg-achrams-primary-solid rounded-full" />
                <input
                  type="text"
                  placeholder="Enter destination (Loading...)"
                  value={destinationLocationData.name}
                  // Disable input while loading
                  onChange={() => {}} // No-op while loading
                  className="flex-1 bg-transparent outline-none text-base text-achrams-text-secondary italic"
                  disabled
                />
              </div>
            ) : (
              // NEW: Render the StandaloneSearchBox only when API is loaded
              <StandaloneSearchBox
                onLoad={(ref) => {
                  searchBoxRef.current = ref; // Store the reference
                }}
                onUnmount={() => {
                  searchBoxRef.current = null; // Clean up reference
                }}
                onPlacesChanged={handlePlaceChanged} // Handle place selection
              >
                <div className="flex items-center gap-3 bg-achrams-bg-secondary rounded-xl px-4 py-4 border border-achrams-border h-14">
                  <div className="w-2 h-2 bg-achrams-primary-solid rounded-full" />
                  <input
                    type="text"
                    placeholder="Enter destination"
                    value={destinationLocationData.name}
                    onChange={(e) => {
                      // Update local state name immediately as user types
                      setDestinationLocationData((prev) => ({
                        ...prev,
                        name: e.target.value,
                      }));
                      setDestOpen(true); // Keep dropdown open while typing
                    }}
                    onFocus={() => setDestOpen(true)} // Open dropdown on focus
                    className="flex-1 bg-transparent outline-none text-base text-achrams-text-primary"
                  />
                  {destOpen &&
                    destinationLocationData.name && ( // Use local state
                      <button
                        onClick={() => {
                          setDestinationLocationData({
                            name: "",
                            coords: null,
                          });
                          setDestOpen(false);
                        }}
                        className="p-2 text-achrams-text-secondary hover:text-achrams-text-primary transition-colors"
                      >
                        <X className="w-5 h-5" />
                      </button>
                    )}
                </div>
              </StandaloneSearchBox>
            )}
          </div>
        </div>

        {fareEstimate !== null && (
          <div className="mt-6 p-4 bg-achrams-bg-secondary rounded-xl border border-achrams-border">
            <div className="flex justify-between items-center">
              <span className="text-achrams-text-secondary">
                {fareIsFlatRate ? (
                  <>
                    Estimated fare
                    <br />
                    (subject to bargain)
                  </>
                ) : (
                  "Actual fare"
                )}
              </span>
              <span className="text-xl font-bold text-achrams-text-primary">
                {fareEstimate.toLocaleString()}
              </span>
            </div>
          </div>
        )}




        
      </div>

      <div className={` p-6 ${isAuthenticated ? 'mb-24' : ''}`}>
        <button
          onClick={onProceed}
          disabled={!fareEstimate}
          className={`w-full py-4 rounded-xl text-lg font-bold text-achrams-text-light transition-all ${
            fareEstimate
              ? "bg-achrams-gradient-primary hover:opacity-95 active:scale-[0.98] shadow-md"
              : "bg-achrams-secondary-solid opacity-75 cursor-not-allowed"
          }`}
        >
          {fareEstimate
            ? `Proceed  ${fareEstimate.toLocaleString()}`
            : "Enter destinations"}
        </button>
      </div>

      {!isAuthenticated && (
        <div className="w-full flex justify-end mb-4">
          {" "}
          {/* Example: Top-right aligned */}
          <button
            onClick={onShowLogin} // NEW: Call the prop function passed from page.tsx
            className="text-sm text-achrams-primary-solid hover:underline transition-colors  mx-auto cursor-pointer"
          >
            Have an account? Log in
          </button>
        </div>
      )}

      {!isAuthenticated && <ACHRAMFooter />}
    </div>
  );
}


----- FILE: src/components/app/screens/DriverAssignedScreen.tsx -----

// src/components/app/screens/DriverAssignedScreen.tsx
"use client";

import {
  MapPin,
  MessageCircle,
  Phone,
  X,
  CheckCircle,
  Shield,
  Star,
} from "lucide-react";
import { Driver } from "@/types/passenger";
import { useState, useEffect } from "react";
import ACHRAMFooter from "@/components/app/ui/ACHRAMFooter";
import Image from "next/image";

interface DriverAssignedScreenProps {
  pickup: string;
  destination: string;
  driver: Driver;
  verificationCode: string;
  onShowDirections: () => void;
  onShowDriverVerification: () => void;
  onStartTrip: () => void;
  onBack: () => void;
  showNotification: (
    message: string,
    type: "info" | "success" | "warning" | "error"
  ) => void;
  onCancelTrip: () => void;
  isAuthenticated: boolean;
  screenPaddingClass: string;
}

export default function DriverAssignedScreen({
  pickup,
  destination,
  driver,
  verificationCode,
  onShowDirections,
  onShowDriverVerification,
  onStartTrip,
  onBack,
  showNotification,
  onCancelTrip,
  isAuthenticated,
  screenPaddingClass,
}: DriverAssignedScreenProps) {
  const [isVerified, setIsVerified] = useState(false);

  useEffect(() => {
    const timer = setTimeout(() => setIsVerified(true), 5000);
    return () => clearTimeout(timer);
  }, []);

  return (
    <div className="bg-achrams-bg-primary flex flex-col relative flex-1">
      {driver ? (
        <>
          {/* Header */}
          <div className="bg-achrams-primary-solid text-achrams-text-light px-6 py-4 flex items-center justify-between">
            <h1 className="text-xl font-bold">Driver Assigned</h1>
            <button onClick={onBack} className="text-achrams-text-light">
              <X className="w-6 h-6" />
            </button>
          </div>

          <div className={`flex-1 overflow-y-auto px-6 py-6 ${screenPaddingClass}`}>
            {/* Trip Summary */}
            <div className="bg-achrams-bg-secondary rounded-xl p-4 mb-6 border border-achrams-border">
              <div className="flex items-start gap-3 mb-3">
                <div className="w-2 h-2 bg-achrams-primary-solid rounded-full mt-2"></div>
                <div>
                  <div className="text-xs text-achrams-text-secondary mb-1">PICKUP</div>
                  <div className="font-medium text-achrams-text-primary">{pickup}</div>
                </div>
              </div>
              <div className="ml-3 w-0.5 h-6 bg-achrams-border"></div>
              <div className="flex items-start gap-3">
                <div className="w-2 h-2 bg-achrams-primary-solid rounded-full mt-2"></div>
                <div>
                  <div className="text-xs text-achrams-text-secondary mb-1">DESTINATION</div>
                  <div className="font-medium text-achrams-text-primary">{destination}</div>
                </div>
              </div>
            </div>

            {/* Driver Card */}
            <div className="bg-achrams-bg-secondary border border-achrams-border rounded-xl p-5 mb-4">
              {/* Profile Header */}
              <div className="flex items-center gap-4 mb-5">
                <div className="relative w-16 h-16 rounded-full overflow-hidden border-2 border-achrams-border">
                  {driver.profile_photo ? (
                    <Image
                      src={driver.profile_photo}
                      alt={driver.name}
                      fill
                      className="object-cover"
                    />
                  ) : (
                    <div className="w-full h-full bg-achrams-primary-solid flex items-center justify-center text-achrams-text-light font-bold text-lg">
                      {driver.name.charAt(0)}
                    </div>
                  )}
                </div>
                <div>
                  <h3 className="text-lg font-bold text-achrams-text-primary">{driver.name}</h3>
                  <div className="flex items-center gap-1">
                    <Star className="w-4 h-4 fill-yellow-500 text-yellow-500" />
                    <span className="font-medium text-achrams-text-primary">{driver.rating || "5.0"}</span>
                    {/* Optional: Add trip count if available */}
                    {/* <span className="text-achrams-text-secondary ml-1"> 120 trips</span> */}
                  </div>
                </div>
              </div>

              {/* Car Photo (if available) */}
              {driver.car_photo && (
                <div className="mb-4 rounded-lg overflow-hidden border border-achrams-border">
                  <div className="relative w-full h-32">
                    <Image
                      src={driver.car_photo}
                      alt={`${driver.car_type} - ${driver.car_color}`}
                      fill
                      className="object-cover"
                    />
                  </div>
                </div>
              )}

              {/* Car Details */}
              <div className="bg-achrams-bg-primary rounded-lg p-4 mb-4 border border-achrams-border">
                <div className="text-sm text-achrams-text-secondary mb-1">
                  {driver.car_type || "Vehicle"}  {driver.car_color || "Color"}
                </div>
                <div className="text-2xl font-mono font-bold text-achrams-text-primary">
                  {driver.plate_number || ""}
                </div>
              </div>

              {/* Action Buttons (Optional) */}
              {/* 
              <div className="grid grid-cols-2 gap-3">
                <button className="flex items-center justify-center gap-2 py-3 bg-achrams-bg-primary border border-achrams-border rounded-xl font-medium text-achrams-text-primary hover:bg-achrams-bg-secondary transition-colors">
                  <MessageCircle className="w-5 h-5" />
                  Message
                </button>
                <button className="flex items-center justify-center gap-2 py-3 bg-achrams-bg-primary border border-achrams-border rounded-xl font-medium text-achrams-text-primary hover:bg-achrams-bg-secondary transition-colors">
                  <Phone className="w-5 h-5" />
                  Call
                </button>
              </div>
              */}
            </div>

            {/* Verify Driver */}
            <button
              onClick={onShowDriverVerification}
              className={`w-full flex items-center justify-center gap-2 py-3 mb-3 rounded-xl font-medium transition-colors ${
                isVerified
                  ? "bg-green-100 text-green-800 border border-green-300"
                  : "bg-achrams-primary-solid/10 border border-achrams-primary-solid text-achrams-primary-solid animate-pulse"
              }`}
            >
              {isVerified ? (
                <CheckCircle className="w-5 h-5 text-green-600" />
              ) : (
                <Shield className="w-5 h-5" />
              )}
              {isVerified ? "Verify Your Driver" : "Verify Your Driver"}
            </button>

            {/* Directions & Actions */}
            <button
              onClick={onShowDirections}
              className="w-full border border-achrams-primary-solid text-achrams-primary-solid bg-transparent py-4 rounded-xl font-semibold mb-3 hover:bg-achrams-bg-secondary transition-colors"
            >
              Get directions to pickup
            </button>

            <button
              onClick={onCancelTrip}
              className="w-full py-4 rounded-xl font-semibold bg-red-500 text-white hover:bg-red-600 active:scale-[0.98] transition-all"
            >
              Cancel trip
            </button>
          </div>
          {
            !isAuthenticated &&(

              <ACHRAMFooter />

            )
          }
        </>
      ) : (
        <div className="flex-1 flex items-center justify-center">
          <p className="text-achrams-text-secondary">Loading driver info...</p>
        </div>
      )}
    </div>
  );
}



----- FILE: src/components/app/screens/AssigningScreen.tsx -----
// src/components/app/screens/AssigningScreen.tsx
'use client';

import { Loader } from 'lucide-react';
import ACHRAMFooter from "@/components/app/ui/ACHRAMFooter"

interface RequestStatusProp {
  status: 'loading' | 'accepted' | 'no-driver' | 'error' | null;
  isAuthenticated: boolean;
}
export default function AssigningScreen({status, isAuthenticated}: RequestStatusProp) {
    const isNoDriver = status === "no-driver";
    const error = status === "error";
  //if (status == 'no-driver') // I want to change the spinner to stop spinning 
  return (
    <div className="h-screen bg-achrams-bg-primary flex flex-col items-center justify-center px-6">
      {/* Spinner using ACHRAMS primary color */
      }
      <div className="h-screen bg-achrams-bg-primary flex flex-col items-center justify-center px-6">
      {/* Spinner */}
      <div
        className={`w-20 h-20 border-4 border-achrams-primary-solid border-t-transparent rounded-full mb-8 ${
          isNoDriver || error ? "" : "animate-spin"
        }` 
      
      } 
      ></div>

      <h2 className="text-2xl font-bold mb-2 text-achrams-text-primary">
        {isNoDriver ? "No Driver Available" : "Please hold on"}
        {error ? status : "" }
      </h2>

      <p className="text-achrams-text-secondary">
        {isNoDriver || error ? "Try again shortly" : "Assigning a driver"}
      </p>
    </div>

    {
      !isAuthenticated && (

        <ACHRAMFooter />

      )
    }
    </div>
  );
}

----- FILE: src/components/app/screens/TripHistoryScreen.tsx -----
// src/components/app/modals/TripHistoryModal.tsx
import { useState, useEffect } from "react";
import { Clock, MapPin, Wallet, Star, X, Loader } from "lucide-react";
import { apiClient } from "@/lib/api";
import { Driver } from "@/types/passenger"; // Assuming this type exists

// Define the type for a trip based on the API response
interface Trip {
  id: string;
  amount: {
    formatted: string;
    currency: string;
    amount: number;
  };
  status: {
    label: string; // e.g., "Completed", "Cancelled"
    value: string; // e.g., "completed", "cancelled"
  };
  pickup_address: string;
  destination_address: string;
  verification_code: string;
  rating: number | null; // Can be null if not rated
  map_data?: { // Optional, as it might not be in history list
    airport?: any; // Or a more specific type if needed
    pickup_location?: any;
    destination_location?: any;
  };
  driver?: Driver; // Driver details might be included
  created_at?: string; // ISO date string
  // Add other fields if present in API response
}

interface TripHistoryModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSelectTrip?: (tripId: string) => void; // Optional callback to view details of a specific trip
  showNotification: (message: string, type: "info" | "success" | "warning" | "error") => void;
}

export default function TripHistoryModal({
  isOpen,
  onClose,
  onSelectTrip,
  showNotification,
}: TripHistoryModalProps) {
  const [trips, setTrips] = useState<Trip[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [page, setPage] = useState(1);
  const [hasMore, setHasMore] = useState(true);
  const limit = 10; // Number of trips per page

  // Fetch trips from the API
  const fetchTrips = async (pageNum: number) => {
    if (!isOpen) return; // Only fetch if modal is open

    setLoading(true);
    setError(null);
    try {
      console.log("Fetching trips from API, page:", pageNum);
      const response = await apiClient.get(
                "/trips",
                undefined,
                false,
                undefined,
                true
              );
      console.log("Trip history API response:", response);

      if (response.status === "success" && response.data) {
        const newTrips: Trip[] = response.data.data || []; // Adjust based on actual API structure
        const total = response.data.total || 0; // Adjust based on actual API structure

        // Assuming API returns paginated data with a total count or a way to know if there are more pages
        // Example: If API returns { data: [...], total: 25, page: 1, limit: 10 }
        // Then 25 total, page 1, limit 10 means 3 pages (10, 10, 5). So if (page * limit) < total, hasMore = true
        // Or if API returns { data: [...], next_page: 2 } then hasMore = !!response.data.next_page
        // For now, assuming a simple structure or that we can infer from length
        // A better API might return { data: [...], has_more: true/false }
        // Let's assume response.data contains the list directly or { data: [...], meta: { total: 25, page: 1, limit: 10 } }
        // Simplified check: if we fetched less than the limit, assume no more
        // Or use total if available
        setHasMore(newTrips.length === limit && (response.data.total === undefined || (pageNum * limit) < response.data.total));

        if (pageNum === 1) {
          setTrips(newTrips); // Replace for first page
        } else {
          setTrips(prev => [...prev, ...newTrips]); // Append for subsequent pages
        }
      } else {
        console.error("API response was not successful:", response);
        setError("Failed to fetch trip history. Server responded with an error.");
        showNotification("Failed to fetch trip history.", "error");
      }
    } catch (err) {
      console.error("Error fetching trip history:", err);
      setError("An error occurred while fetching trip history.");
      showNotification("Failed to fetch trip history. Please check your connection.", "error");
    } finally {
      setLoading(false);
    }
  };

  // Fetch trips when modal opens or page changes
  useEffect(() => {
    if (isOpen) {
      fetchTrips(page);
    }
    // Reset page when modal closes (optional, for future open)
    return () => {
        if (!isOpen) {
            setPage(1);
        }
    };
  }, [isOpen, page]);

  // Handle closing the modal
  const handleClose = () => {
    setPage(1); // Reset page for next open
    setTrips([]); // Clear trips for next open
    setHasMore(true); // Reset for next open
    onClose();
  };

  // Format date if available
  const formatDate = (dateString?: string) => {
    if (!dateString) return "Date unknown";
    const date = new Date(dateString);
    // Example: "Today, 2:30 PM" or "Yesterday, 10:15 AM" or "Nov 10, 2024"
    // Using a simple formatter for now
    return date.toLocaleString();
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-end justify-center">
      {/* Backdrop */}
      <div
        className="absolute inset-0 bg-black/50"
        onClick={handleClose}
      />
      {/* Modal Content */}
      <div className="relative bg-achrams-bg-primary w-full max-w-md h-[80vh] rounded-t-3xl border-t border-achrams-border shadow-lg overflow-hidden flex flex-col">
        {/* Header */}
        <div className="bg-achrams-primary-solid text-achrams-text-light px-6 py-4 flex items-center justify-between">
          <h2 className="text-xl font-bold">Trip History</h2>
          <button
            onClick={handleClose}
            className="text-achrams-text-light hover:text-achrams-text-secondary"
            aria-label="Close"
          >
            <X className="w-6 h-6" />
          </button>
        </div>

        {/* Content Area */}
        <div className="flex-1 overflow-y-auto px-6 py-4">
          {error ? (
            <div className="text-center py-8">
              <p className="text-achrams-text-secondary mb-2">{error}</p>
              <button
                onClick={() => fetchTrips(page)} // Retry current page
                className="text-achrams-primary-solid font-medium"
              >
                Retry
              </button>
            </div>
          ) : loading && trips.length === 0 ? (
            <div className="flex justify-center items-center h-full">
              <Loader className="w-8 h-8 text-achrams-primary-solid animate-spin" />
            </div>
          ) : trips.length === 0 ? (
            <div className="text-center py-8">
              <Clock className="w-12 h-12 text-achrams-text-secondary mx-auto mb-2" />
              <p className="text-achrams-text-secondary">No trip history found.</p>
            </div>
          ) : (
            <>
              <div className="space-y-4">
                {trips.map((trip) => (
                  <div
                    key={trip.id}
                    className="bg-achrams-bg-secondary rounded-xl p-4 border border-achrams-border"
                  >
                    <div className="flex items-start justify-between">
                      <div className="flex-1 min-w-0">
                        {/* Driver Name (if available) or Status */}
                        <div className="flex items-center gap-2 mb-1">
                          {trip.driver?.name ? (
                            <span className="text-sm font-semibold text-achrams-text-primary truncate">
                              {trip.driver.name}
                            </span>
                          ) : (
                            <span className={`text-xs px-2 py-1 rounded-full ${
                              trip.status.value === "completed"
                                ? "bg-emerald-100 text-emerald-800"
                                : "bg-amber-100 text-amber-800" // Assuming cancelled or other
                            }`}>
                              {trip.status.label}
                            </span>
                          )}
                          {/* Rating */}
                          {trip.rating !== null && (
                            <div className="flex items-center gap-1">
                              <Star className="w-4 h-4 fill-yellow-500 text-yellow-500" />
                              <span className="text-xs text-achrams-text-secondary">{trip.rating}</span>
                            </div>
                          )}
                        </div>

                        {/* Pickup */}
                        <div className="flex items-start gap-2 mb-1">
                          <MapPin className="w-4 h-4 text-achrams-primary-solid flex-shrink-0 mt-0.5" />
                          <div className="text-sm text-achrams-text-primary truncate">
                            {trip.pickup_address}
                          </div>
                        </div>

                        {/* Destination */}
                        <div className="flex items-start gap-2 pl-6"> {/* Indent destination */}
                          <div className="text-sm text-achrams-text-secondary truncate">
                             {trip.destination_address}
                          </div>
                        </div>

                        {/* Date and Fare */}
                        <div className="flex justify-between items-center mt-2 pt-2 border-t border-achrams-border">
                          <span className="text-xs text-achrams-text-secondary flex items-center gap-1">
                            <Clock className="w-3 h-3" />
                            {formatDate(trip.created_at)}
                          </span>
                          <div className="flex items-center gap-1">
                            <Wallet className="w-4 h-4 text-achrams-text-secondary" />
                            <span className="text-sm font-medium text-achrams-text-primary">
                              {trip.amount.formatted}
                            </span>
                          </div>
                        </div>
                      </div>

                      {/* Optional: View Details Button */}
                      {onSelectTrip && (
                        <button
                          onClick={() => onSelectTrip(trip.id)}
                          className="ml-4 p-2 text-achrams-primary-solid hover:text-achrams-primary-light"
                          aria-label={`View details for trip ${trip.id}`}
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
                        </button>
                      )}
                    </div>
                  </div>
                ))}
              </div>

              {/* Load More / End of List */}
              {loading && trips.length > 0 && (
                <div className="flex justify-center py-4">
                  <Loader className="w-6 h-6 text-achrams-primary-solid animate-spin" />
                </div>
              )}
              {!loading && !hasMore && (
                <div className="text-center text-achrams-text-secondary py-4 text-sm">
                  You've reached the end of your trip history.
                </div>
              )}
              {!loading && hasMore && (
                <button
                  onClick={() => setPage(prev => prev + 1)}
                  className="w-full py-3 mt-4 bg-achrams-primary-solid text-achrams-text-light rounded-xl font-medium hover:opacity-90 active:scale-[0.98] transition-all"
                >
                  Load More
                </button>
              )}
            </>
          )}
        </div>
      </div>
    </div>
  );
}




----- FILE: src/components/app/screens/TripCompleteScreen.tsx -----
'use client';

import { Check, MapPin, Star } from 'lucide-react';
import { Driver } from '@/types/passenger';
import ACHRAMFooter from '@/components/app/ui/ACHRAMFooter';
import Image from 'next/image';

type OnDoneHandler = () => void;

interface TripCompleteScreenProps {
  fareEstimate: number | null;
  driver: Driver;
  pickup: string;
  destination: string;
  onRate?: () => void;
  onDone: OnDoneHandler;
  screenPaddingClass: string,
  isAuthenticated: boolean;
}

export default function TripCompleteScreen({
  fareEstimate,
  driver,
  pickup,
  destination,
  onRate,
  onDone,
  screenPaddingClass,
  isAuthenticated,
}: TripCompleteScreenProps) {
  return (
    <div className="flex-1 bg-achrams-bg-primary flex flex-col">
      <div className="bg-achrams-primary-solid text-achrams-text-light px-6 py-4">
        <h1 className="text-xl font-bold">Trip completed</h1>
      </div>

      <div className={`flex-1 overflow-y-auto px-6 py-8  ${screenPaddingClass}`}>
        <div className="text-center mb-8">
          <div className="w-20 h-20 bg-achrams-bg-secondary rounded-full flex items-center justify-center mx-auto mb-4 border border-achrams-border">
            <Check className="w-10 h-10 text-achrams-primary-solid" />
          </div>
          <h2 className="text-2xl font-bold mb-2 text-achrams-text-primary">You've arrived!</h2>
          <p className="text-achrams-text-secondary">How was your trip?</p>
        </div>

        {/* Driver Info */}
        {driver && (
          <div className="bg-achrams-bg-secondary rounded-xl p-5 mb-6 border border-achrams-border">
            <div className="flex items-center gap-4 mb-5">
              {/* Profile Picture */}
              <div className="relative w-14 h-14 rounded-full overflow-hidden border-2 border-achrams-border">
                {driver.profile_photo ? (
                  <Image
                    src={driver.profile_photo}
                    alt={driver.name}
                    fill
                    className="object-cover"
                  />
                ) : (
                  <div className="w-full h-full bg-achrams-primary-solid flex items-center justify-center text-achrams-text-light font-bold">
                    {driver.name.charAt(0).toUpperCase()}
                  </div>
                )}
              </div>
              {/* Name & Rating */}
              <div>
                <h3 className="text-lg font-bold text-achrams-text-primary">{driver.name}</h3>
                <div className="flex items-center gap-1">
                  <Star className="w-4 h-4 fill-yellow-500 text-yellow-500" />
                  <span className="font-medium text-achrams-text-primary">
                    {driver.rating || "5.0"}
                  </span>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Trip Summary: Pickup + Destination */}
        <div className="bg-achrams-bg-secondary rounded-xl p-4 mb-6 border border-achrams-border">
          <div className="flex items-start gap-3 mb-3">
            <MapPin className="w-4 h-4 text-achrams-primary-solid mt-0.5 flex-shrink-0" />
            <div>
              <div className="text-xs text-achrams-text-secondary mb-1">PICKUP</div>
              <div className="font-medium text-achrams-text-primary">{pickup}</div>
            </div>
          </div>
          <div className="flex items-start gap-3">
            <MapPin className="w-4 h-4 text-achrams-primary-solid mt-0.5 flex-shrink-0" />
            <div>
              <div className="text-xs text-achrams-text-secondary mb-1">DESTINATION</div>
              <div className="font-medium text-achrams-text-primary">{destination}</div>
            </div>
          </div>
        </div>

        {/* Fare */}
        <div className="bg-achrams-bg-secondary rounded-xl p-6 mb-6 border border-achrams-border">
          <div className="flex justify-between items-center mb-4">
            <span className="text-achrams-text-secondary">Total Fare</span>
            <span className="text-3xl font-bold text-achrams-text-primary">
              {fareEstimate?.toLocaleString() || '0'}
            </span>
          </div>
          <div className="text-sm text-achrams-text-secondary">Paid via Cash</div>
        </div>

        {onRate && (
  <button
    onClick={onRate}
    className="w-full py-4 rounded-xl font-semibold mb-3 
      border border-achrams-primary-solid text-achrams-primary-solid 
      bg-white hover:bg-achrams-bg-secondary transition-colors cursor-pointer"
  >
    Rate your ride
  </button>
)}

{/* Done  primary style */}
<button
  onClick={onDone}
  className="w-full py-4 rounded-xl font-semibold 
    bg-achrams-gradient-primary text-achrams-text-light 
    hover:opacity-90 active:scale-[0.98] transition-all cursor-pointer"
>
  Done
</button>
      </div>
    {
      !isAuthenticated && (

        <ACHRAMFooter />

      )
    }
    </div>
  );
}

----- FILE: src/components/app/screens/SettingsScreen.tsx -----
// src/components/app/screens/SettingsScreen.tsx
import { ChevronLeft, Shield, User, CreditCard, Bell, Globe, HelpCircle, LogOut, ChevronRight } from 'lucide-react';

export default function SettingsScreen({ onBack, onShowProfile, onShowSecurity, onShowPayment, onShowNotifications, onShowLanguage, onShowHelp, onLogout }: { onBack: () => void; onShowProfile: () => void; onShowSecurity: () => void; onShowPayment: () => void; onShowNotifications: () => void; onShowLanguage: () => void; onShowHelp: () => void; onLogout: () => void }) {
  return (
    <div className="h-screen bg-achrams-bg-primary flex flex-col">
      {/* Header */}
      <div className="bg-achrams-primary-solid text-achrams-text-light px-6 py-4 flex items-center">
        <button onClick={onBack} className="mr-4">
          <ChevronLeft className="w-6 h-6" />
        </button>
        <h1 className="text-xl font-bold">Settings</h1>
      </div>

      {/* Content */}
      <div className="flex-1 overflow-y-auto p-6 space-y-6">
        {/* Account */}
        <div className="bg-achrams-bg-secondary rounded-xl border border-achrams-border">
          <h3 className="text-lg font-semibold px-4 py-3 text-achrams-text-primary">Account</h3>
          <button
            onClick={onShowProfile}
            className="w-full flex items-center justify-between px-4 py-3 hover:bg-achrams-bg-primary border-b border-achrams-border text-left"
          >
            <div className="flex items-center gap-3">
              <User className="w-5 h-5 text-achrams-text-secondary" />
              <span>Edit Profile</span>
            </div>
            <ChevronRight className="w-5 h-5 text-achrams-text-secondary" />
          </button>
          <button
            onClick={onShowSecurity}
            className="w-full flex items-center justify-between px-4 py-3 hover:bg-achrams-bg-primary border-b border-achrams-border text-left"
          >
            <div className="flex items-center gap-3">
              <Shield className="w-5 h-5 text-achrams-text-secondary" />
              <span>Security</span>
            </div>
            <ChevronRight className="w-5 h-5 text-achrams-text-secondary" />
          </button>
          <button
            onClick={onShowPayment}
            className="w-full flex items-center justify-between px-4 py-3 hover:bg-achrams-bg-primary text-left"
          >
            <div className="flex items-center gap-3">
              <CreditCard className="w-5 h-5 text-achrams-text-secondary" />
              <span>Payment Methods</span>
            </div>
            <ChevronRight className="w-5 h-5 text-achrams-text-secondary" />
          </button>
        </div>

        {/* Preferences */}
        <div className="bg-achrams-bg-secondary rounded-xl border border-achrams-border">
          <h3 className="text-lg font-semibold px-4 py-3 text-achrams-text-primary">Preferences</h3>
          <button
            onClick={onShowNotifications}
            className="w-full flex items-center justify-between px-4 py-3 hover:bg-achrams-bg-primary border-b border-achrams-border text-left"
          >
            <div className="flex items-center gap-3">
              <Bell className="w-5 h-5 text-achrams-text-secondary" />
              <span>Notifications</span>
            </div>
            <ChevronRight className="w-5 h-5 text-achrams-text-secondary" />
          </button>
          <button
            onClick={onShowLanguage}
            className="w-full flex items-center justify-between px-4 py-3 hover:bg-achrams-bg-primary text-left"
          >
            <div className="flex items-center gap-3">
              <Globe className="w-5 h-5 text-achrams-text-secondary" />
              <span>Language</span>
            </div>
            <ChevronRight className="w-5 h-5 text-achrams-text-secondary" />
          </button>
        </div>

        {/* Support */}
        <div className="bg-achrams-bg-secondary rounded-xl border border-achrams-border">
          <h3 className="text-lg font-semibold px-4 py-3 text-achrams-text-primary">Support</h3>
          <button
            onClick={onShowHelp}
            className="w-full flex items-center justify-between px-4 py-3 hover:bg-achrams-bg-primary border-b border-achrams-border text-left"
          >
            <div className="flex items-center gap-3">
              <HelpCircle className="w-5 h-5 text-achrams-text-secondary" />
              <span>Help Center</span>
            </div>
            <ChevronRight className="w-5 h-5 text-achrams-text-secondary" />
          </button>
          <button
            onClick={onLogout}
            className="w-full flex items-center justify-between px-4 py-3 hover:bg-red-50 text-left text-red-600"
          >
            <div className="flex items-center gap-3">
              <LogOut className="w-5 h-5" />
              <span>Log Out</span>
            </div>
          </button>
        </div>
      </div>
    </div>
  );
}

----- FILE: src/components/app/screens/WalletScreen.tsx -----
// src/components/app/screens/WalletScreen.tsx
import { useState, useEffect } from 'react';
import { Wallet, TrendingUp, TrendingDown, Calendar, Clock } from 'lucide-react';
import { apiClient } from '@/services/apiClient'; // Assuming you create this service

interface Transaction {
  id: string;
  reference: string;
  amount: {
    formatted: string;
    currency: string;
    amount: number;
  };
  status: {
    label: string;
    value: string;
  };
  entry_type: {
    label: string; // e.g., "Credit", "Debit"
    value: string; // e.g., "credit", "debit"
  };
  narration: string;
  created_at: string; // ISO date string
  // Add other fields as needed from the API response
}

export default function WalletScreen({ onBack }: { onBack: () => void }) {
  const [balance, setBalance] = useState({ formatted: '0.00', currency: 'NGN', amount: 0 });
  const [transactions, setTransactions] = useState<Transaction[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchWalletData = async () => {
      try {
        setLoading(true);
        setError(null);
        // NEW: Call the wallet details API using apiClient
        // Example: GET /wallets (to get balance)
        const balanceResponse = await apiClient.get('/wallets'); // Use correct endpoint from Postman doc
        // Example: GET /wallets/history (to get history)
        const historyResponse = await apiClient.get('/wallets/history'); // Use correct endpoint from Postman doc

        console.log("Wallet Balance Response:", balanceResponse); // Debug log
        console.log("Wallet History Response:", historyResponse); // Debug log

        if (balanceResponse.status === 200 && balanceResponse.data && balanceResponse.data.data) {
          setBalance(balanceResponse.data.data.balance); // Adjust based on actual API response structure for balance
        } else {
          setError('Failed to load wallet balance.');
        }

        if (historyResponse.status === 200 && historyResponse.data && Array.isArray(historyResponse.data.data)) {
          setTransactions(historyResponse.data.data);
        } else {
          setError('Failed to load transaction history.');
        }
      } catch (err) {
        console.error("Wallet Data Fetch Error:", err);
        let errorMessage = 'An unexpected error occurred.';
        if (err instanceof Error) {
          errorMessage = err.message;
        }
        setError(errorMessage);
      } finally {
        setLoading(false);
      }
    };

    fetchWalletData();
  }, []); // Fetch on mount


  if (loading) {
    return (
      <div className="h-screen bg-achrams-bg-primary flex items-center justify-center">
        <div className="text-center">
          <div className="w-16 h-16 border-4 border-achrams-primary-solid border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p className="text-achrams-text-secondary">Loading wallet...</p>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="h-screen bg-achrams-bg-primary flex flex-col items-center justify-center p-6">
        <p className="text-red-500 text-center mb-6">{error}</p>
        <button
          onClick={() => window.location.reload()} // Simple retry for now
          className="bg-achrams-gradient-primary text-achrams-text-light py-3 px-6 rounded-xl font-semibold"
        >
          Retry
        </button>
      </div>
    );
  }

  return (
    <div className="h-screen bg-achrams-bg-primary flex flex-col">
      {/* Header */}
      <div className="bg-achrams-primary-solid text-achrams-text-light px-6 py-4 flex items-center">
        <button onClick={onBack} className="mr-4">
          <ChevronLeft className="w-6 h-6" />
        </button>
        <h1 className="text-xl font-bold">My Wallet</h1>
      </div>

      {/* Content */}
      <div className="flex-1 overflow-y-auto">
        {/* Balance Card */}
        <div className="bg-gradient-to-r from-achrams-primary-solid to-achrams-secondary-solid text-achrams-text-light p-6 m-6 rounded-2xl shadow-md">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm opacity-80">Available Balance</p>
              <p className="text-3xl font-bold">{balance.formatted}</p>
            </div>
            <Wallet className="w-12 h-12 opacity-80" />
          </div>
        </div>

        {/* Transactions List */}
        <div className="mx-6 mb-6">
          <h2 className="text-lg font-semibold mb-4 text-achrams-text-primary">Transaction History</h2>
          {transactions.length === 0 ? (
            <div className="text-center py-8">
              <p className="text-achrams-text-secondary">No transactions found.</p>
            </div>
          ) : (
            <div className="space-y-4">
              {transactions.map((tx) => (
                <div key={tx.id} className="bg-achrams-bg-secondary rounded-xl p-4 border border-achrams-border flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <div className={`p-2 rounded-full ${
                      tx.entry_type.value === 'credit' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'
                    }`}>
                      {tx.entry_type.value === 'credit' ? <TrendingUp className="w-5 h-5" /> : <TrendingDown className="w-5 h-5" />}
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="font-medium text-achrams-text-primary truncate">{tx.narration || tx.reference}</p>
                      <div className="flex items-center gap-2 text-xs text-achrams-text-tertiary">
                        <Calendar className="w-3 h-3" />
                        <span>{new Date(tx.created_at).toLocaleDateString()}</span>
                        <Clock className="w-3 h-3" />
                        <span>{new Date(tx.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                      </div>
                    </div>
                  </div>
                  <div className="text-right">
                    <p className={`font-semibold ${
                      tx.entry_type.value === 'credit' ? 'text-green-600' : 'text-red-600'
                    }`}>
                      {tx.entry_type.value === 'credit' ? '+' : '-'}{tx.amount.formatted}
                    </p>
                    <span className={`text-xs px-2 py-0.5 rounded-full ${
                      tx.status.value === 'successful' ? 'bg-green-100 text-green-800' :
                      tx.status.value === 'failed' ? 'bg-red-100 text-red-800' :
                      'bg-yellow-100 text-yellow-800'
                    }`}>
                      {tx.status.label}
                    </span>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

----- FILE: src/components/app/screens/DashboardScreen.tsx -----
// components/app/screens/DashboardScreen.tsx
import { useCallback, useState } from "react";
import {
  MapPin,
  Clock,
  Wallet,
  User,
  ChevronRight,
  Sun,
  Cloud,
  CloudRain,
  Plane,
  TrendingUp,
  Star,
  Gift,
  Shield,
  HeadphonesIcon,
  CreditCard,
  Bell,
  Heart,
  Utensils,
  Bed, // If available, otherwise use Plane for hotels
  // Add other icons if needed
} from "lucide-react";
import BottomNavBar from "../ui/BottomNavBar";
import { Driver } from "@/types/passenger";
import ACHRAMSHeader from "@/components/ui/ACHRAMSHeader";
import Image from "next/image";

// NEW: Import the Coming Soon Modal
import ComingSoonModal from "../modals/ComingSoonModal";

interface DashboardProps {
  onBookNewTrip: () => void;
  passengerData: { name: string; phone: string; email: string };
  // walletBalance: number;
  activeTrip?: {
    id: string;
    status: string;
    driver?: Driver;
    destination: string;
  } | null;
  onShowProfile: () => void;
  onShowTripHistory: () => void;
  onShowWallet: () => void; // Handler for wallet button
  onShowSettings: () => void;
  onShowActiveTrip: () => void;
  accountData: any;
  onResumeRecentTrip: (tripId: string) => void;
  recentTripData: any;
  // NEW: Add prop for showing notifications (if needed for wallet)
  weatherData: {
    temp: number;
    condition: string;
    location: string;
    humidity?: number;
    windSpeed?: number;
  } | null;
  weatherLoading: boolean;
  weatherError: string | null;
  showNotification: (message: string, type: "info" | "success" | "warning" | "error") => void;
}
export default function DashboardScreen({
  onBookNewTrip,
  passengerData,
  // walletBallance,
  activeTrip,
  onShowProfile,
  onShowTripHistory,
  onShowWallet, // NEW: Handler for wallet button
  onShowSettings,
  onShowActiveTrip,
  accountData,
  onResumeRecentTrip,
  recentTripData,
  // NEW: Prop for notifications
  weatherData,
  weatherLoading,
  weatherError,
  showNotification,
}: DashboardProps) {
  // NEW: State for the coming soon modal
  const [showComingSoon, setShowComingSoon] = useState<{
    isOpen: boolean;
    feature: 'hotels' | 'restaurant' | 'support' | 'alerts' | 'wallet' | 'payment' | 'security' | null;
  }>({ isOpen: false, feature: null });

  // const [weather] = useState({
  //   temp: 28,
  //   condition: "sunny",
  //   location: "Lagos",
  // });

  const walletBalance = 12500;

  const hour = new Date().getHours();
  const greeting =
    hour < 12 ? "Good morning" : hour < 18 ? "Good afternoon" : "Good evening";
  const firstName =
    accountData?.first_name || accountData?.name?.split(" ")[0] || "Passenger";
  const initials =
    accountData?.initials ||
    `${accountData?.first_name?.charAt(0) || ""}${
      accountData?.last_name?.charAt(0) || ""
    }`.toUpperCase();
  const profilePhoto = accountData?.profile_photo;

  const walletBalanceFromData =
    accountData?.profile?.wallet?.balance?.amount ?? 0;

  const isRecentTripResumable = recentTripData && !['completed', 'cancelled'].includes(recentTripData.status?.value); // Adjust field name


  const displayWalletBalance = walletBalance ?? walletBalanceFromData; // Prefer the prop if available

  
  console.log("Weather Data: ", weatherData)
  const WeatherIcon = useCallback(() => {
    // Default icon if no data or condition is unknown
    let iconComponent = <Sun className="w-12 h-12 text-amber-500" />;

    if (weatherData) {
      const condition = weatherData.condition.toLowerCase();
      if (condition.includes("clear") || condition.includes("sunny")) {
        iconComponent = <Sun className="w-12 h-12 text-amber-500" />;
      } else if (condition.includes("clouds") || condition.includes("cloudy")) {
        iconComponent = <Cloud className="w-12 h-12 text-gray-400" />;
      } else if (condition.includes("rain") || condition.includes("drizzle") || condition.includes("shower")) {
        iconComponent = <CloudRain className="w-12 h-12 text-blue-500" />;
      } else if (condition.includes("snow")) {
        iconComponent = <Cloud className="w-12 h-12 text-blue-200" />; // Placeholder
      } else if (condition.includes("thunderstorm")) {
        iconComponent = <Cloud className="w-12 h-12 text-gray-700" />; // Placeholder
      }
      // Add more conditions as needed based on the API's response
    }

    return iconComponent;
  }, [weatherData]);
  

  // NEW: Handler to open the coming soon modal
  const handleComingSoonClick = (feature: 'hotels' | 'restaurant' | 'support' | 'alerts' | 'payment' | 'security') => {
    setShowComingSoon({ isOpen: true, feature });
  };

  // NEW: Handler for wallet click (can also show ComingSoonModal or navigate)
  const handleWalletClick = () => {
    // Option 1: Show Coming Soon Modal
    setShowComingSoon({ isOpen: true, feature: 'wallet' });
    // alert('handlewallet clicked')
    // Option 2: Call the existing onShowWallet handler (if it navigates to wallet page)
    // onShowWallet(); // Uncomment if this is the desired behavior
  };

  return (
    <div className="min-h-screen bg-gradient-to-b from-gray-50 to-white flex justify-center max-w-md">
      <div className="w-full max-w-md flex flex-col h-screen">
        {/* Premium Header with Brand Gradient */}
        <div className="bg-gradient-to-r from-emerald-600 via-teal-600 to-cyan-600 text-white px-6 py-5 shadow-lg">
          <div className="flex items-center justify-between">
            <ACHRAMSHeader title="" />
            <button className="w-14 h-14 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center text-sm font-bold shadow-lg border-2 border-white/30 hover:bg-white/30 transition-all">
              {profilePhoto ? (
                // If using Next.js Image
                <Image
                  src={profilePhoto}
                  alt={`${firstName}'s profile`}
                  fill
                  className="w-full h-full rounded-full object-cover"
                />
              ) : (
                // Fallback to initials if no photo
                initials
              )}
            </button>
          </div>
        </div>

        {/* Scrollable Content Area */}
        <div className="flex-1 overflow-y-auto pb-24 px-6">
          {/* Greeting & Weather Card */}
          <div className="bg-gradient-to-br from-emerald-50 via-teal-50 to-cyan-50 rounded-3xl p-6 mt-6 mb-5 shadow-sm border border-emerald-100">
            <div className="flex items-start justify-between mb-4">
              <div>
                <h2 className="text-2xl font-bold text-gray-900 mb-1">
                  {greeting}, {firstName}!
                </h2>
                <p className="text-gray-600 text-sm">
                  Ready for your next journey?
                </p>
              </div>
              <Plane className="w-6 h-6 text-emerald-600" />
            </div>

            {/* NEW: Weather Display Card - Handle loading, error, and data */}
            <div className="bg-white/80 backdrop-blur-sm rounded-2xl p-5 flex items-center justify-between border border-white shadow-sm">
              {weatherLoading ? (
                // Show loading state
                <div className="flex items-center justify-center w-full">
                  <div className="text-center">
                    <div className="w-12 h-12 border-4 border-achrams-primary-solid border-t-transparent rounded-full animate-spin mx-auto mb-2"></div>
                    <p className="text-achrams-text-secondary text-sm">Loading weather...</p>
                  </div>
                </div>
              ) : weatherError ? (
                // Show error state
                <div className="flex items-center justify-center w-full">
                  <div className="text-center">
                    <div className="text-red-500 mb-2">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                    </div>
                    <p className="text-achrams-text-secondary text-sm">Weather unavailable</p>
                    <p className="text-xs text-red-500 mt-1">{weatherError}</p>
                  </div>
                </div>
              ) : weatherData ? (
                // Show weather data
                <>
                  <div>
                    <div className="text-4xl font-bold text-gray-900 mb-1">
                      {weatherData.temp}C
                    </div>
                    <div className="text-gray-600 capitalize font-medium">
                      {weatherData.condition}
                    </div>
                    <div className="text-xs text-gray-500 mt-1 flex items-center gap-1">
                      <MapPin className="w-3 h-3" />
                      {weatherData.location}
                    </div>
                    {/* Optional: Display humidity/wind if available */}
                    {weatherData.humidity !== undefined && (
                      <div className="text-xs text-gray-500 mt-1">
                        Humidity: {weatherData.humidity}%
                      </div>
                    )}
                    {weatherData.windSpeed !== undefined && (
                      <div className="text-xs text-gray-500">
                        Wind: {weatherData.windSpeed} m/s
                      </div>
                    )}
                  </div>
                  <div className="ml-4">
                    <WeatherIcon />
                  </div>
                </>
              ) : (
                // Fallback if no data but no error/loading
                <div className="flex items-center justify-center w-full">
                  <div className="text-center">
                    <div className="text-gray-500 mb-2">
                      <Sun className="w-12 h-12 mx-auto" />
                    </div>
                    <p className="text-achrams-text-secondary text-sm">Weather unknown</p>
                  </div>
                </div>
              )}
            </div>
          </div>

          

          {activeTrip && (
            // Added `w-full` to ensure it takes full width of its container (with padding from parent `px-6`)
            //  Removed fixed width/height that might cause stretching if content is less
            <button
              className="w-full bg-gradient-to-r from-amber-50 to-orange-50 rounded-3xl p-5 mb-5 shadow-sm border border-amber-200 transition-all hover:bg-green-50 active:scale-95 cursor-pointer"
              onClick={onShowActiveTrip}
            >
              <div className="flex items-center justify-between mb-4">
                <div className="flex items-center gap-2">
                  <MapPin className="w-5 h-5 text-amber-600" />
                  <h3 className="font-bold text-gray-900">Active Trip</h3>
                </div>
                <span className="text-xs bg-amber-100 text-amber-800 px-3 py-1.5 rounded-full font-semibold">
                  {activeTrip.status}
                </span>
              </div>
              <div className="flex items-center gap-4">
                {/*  Kept fixed size for the avatar circle */}
                <div className="w-12 h-12 bg-gradient-to-br from-emerald-600 to-teal-600 rounded-2xl flex items-center justify-center text-white font-bold text-lg shadow-md">
                  {activeTrip.driver?.name?.charAt(0) || "D"}
                </div>
                {/*  Added `min-w-0` and `flex-1` to allow flexible shrinking of the middle content */}
                <div className="flex-1 min-w-0">
                  {/*  Added `truncate` to handle potentially long driver names */}
                  <p className="text-sm font-semibold text-gray-900 truncate">
                    {activeTrip.driver?.name || "Searching Driver"}
                  </p>

                  <p className="text-xs text-gray-600 truncate flex items-center gap-1 mt-0.5 min-w-0">
                    <MapPin className="w-3 h-3 flex-shrink-0" />
                    {activeTrip.destination}
                  </p>
                </div>

                <ChevronRight className="w-5 h-5 text-gray-400 flex-shrink-0" />
              </div>
            </button>
          )}

          {/* Primary CTA Button */}
          <button
            className="w-full bg-gradient-to-r from-emerald-600 to-teal-600 text-white py-5 rounded-2xl text-lg font-bold shadow-lg hover:shadow-xl active:scale-[0.98] transition-all mb-6 flex items-center justify-center gap-2"
            onClick={onBookNewTrip}
          >
            <Plane className="w-5 h-5" />
            Book Your Airport Ride
          </button>

          {/* Quick Actions Grid - New Relevant Actions */}
          <div className="grid grid-cols-4 gap-3 mb-6 overflow-auto">
            {[
              { icon: Bed, label: "Hotels", color: "emerald", feature: 'hotels' as const }, // NEW: Use Bed icon
              { icon: Utensils, label: "Restaurant", color: "teal", feature: 'restaurant' as const }, // NEW: Use Utensils icon
              { icon: HeadphonesIcon, label: "Support", color: "cyan", feature: 'support' as const }, // Support opens modal
              { icon: Bell, label: "Alerts", color: "sky", feature: 'alerts' as const }, // NEW: Alerts opens modal
            ].map((item, idx) => (
              <button
                key={idx}
                className="flex flex-col items-center justify-center gap-2 bg-white rounded-2xl p-4 border border-gray-200 hover:border-gray-300 hover:shadow-md transition-all active:scale-95"
                onClick={() => handleComingSoonClick(item.feature)} // NEW: Call handler
              >
                <div
                  className={`w-10 h-10 rounded-xl bg-${item.color}-50 flex items-center justify-center`}
                >
                  <item.icon
                    className={`w-5 h-5 text-${item.color}-600`}
                    strokeWidth={2}
                  />
                </div>
                <span className="text-xs text-gray-700 font-medium">
                  {item.label}
                </span>
              </button>
            ))}
          </div>

          {/* Recent Trip */}
          {recentTripData && ( // Render if recentTripData exists (could be terminal)
            <div className="mb-6">
              <h3 className="font-bold text-lg mb-3 text-gray-900 flex items-center gap-2">
                <Clock className="w-5 h-5 text-gray-600" />
                Recent Trip
              </h3>
              {/* NEW: Conditionally make the card clickable based on resumability */}
              {isRecentTripResumable ? (
                // Clickable button for resumable trips
                <button
                  className="w-full bg-white rounded-2xl p-5 shadow-sm border border-gray-200 text-left transition-all hover:bg-gray-50 active:scale-[0.98]"
                  onClick={() => onResumeRecentTrip(recentTripData.id)} // Call the prop function with the trip ID
                >
                  {/* Trip Content */}
                  <div className="flex items-start justify-between mb-3">
                    <div className="flex-1 min-w-0">
                      <div className="flex items-start gap-2 mb-2">
                        <MapPin className="w-4 h-4 text-gray-400 flex-shrink-0 mt-0.5" />
                        <div className="text-sm text-gray-900 font-medium leading-tight">
                          {recentTripData.pickup_address || "Pickup Location"} {/* Adjust field name */}
                        </div>
                      </div>
                      <div className="flex items-start gap-2 pl-6">
                        <div className="text-sm text-gray-600 leading-tight">
                           {recentTripData.destination_address || "Destination"} {/* Adjust field name */}
                        </div>
                      </div>
                    </div>
                    <div className="text-right ml-3">
                      <div className="text-xl font-bold text-gray-900">
                        {recentTripData.amount?.amount?.toLocaleString() || "0"} {/* Adjust field name */}
                      </div>
                      {/* Status Badge */}
                      <span className="text-xs font-semibold capitalize bg-amber-50 text-amber-600 px-2 py-1 rounded-full mt-1 inline-block">
                        {recentTripData.status.label || "Status"} {/* Adjust field name */}
                      </span>
                    </div>
                  </div>
                  <div className="text-xs text-gray-500 flex items-center gap-1 mt-3 pt-3 border-t border-gray-100">
                    <Clock className="w-3 h-3" />
                    {new Date(recentTripData.created_at || '').toLocaleString() || "Date Unknown"} {/* Adjust field name */}
                  </div>
                </button>
              ) : (
                // Non-clickable div for non-resumable trips
                <div className="w-full bg-white rounded-2xl p-5 shadow-sm border border-gray-200 text-left">
                  {/* Trip Content */}
                  <div className="flex items-start justify-between mb-3">
                    <div className="flex-1 min-w-0">
                      <div className="flex items-start gap-2 mb-2">
                        <MapPin className="w-4 h-4 text-gray-400 flex-shrink-0 mt-0.5" />
                        <div className="text-sm text-gray-900 font-medium leading-tight">
                          {recentTripData.pickup_address || "Pickup Location"} {/* Adjust field name */}
                        </div>
                      </div>
                      <div className="flex items-start gap-2 pl-6">
                        <div className="text-sm text-gray-600 leading-tight">
                           {recentTripData.destination_address || "Destination"} {/* Adjust field name */}
                        </div>
                      </div>
                    </div>
                    <div className="text-right ml-3">
                      <div className="text-xl font-bold text-gray-900">
                        {recentTripData.amount?.amount?.toLocaleString() || "0"} {/* Adjust field name */}
                      </div>
                      {/* Status Badge - Highlight terminal status */}
                      <span className="text-xs font-semibold capitalize bg-emerald-50 text-emerald-600 px-2 py-1 rounded-full mt-1 inline-block">
                        {recentTripData.status.label || "Status"} {/* Adjust field name */}
                      </span>
                    </div>
                  </div>
                  <div className="text-xs text-gray-500 flex items-center gap-1 mt-3 pt-3 border-t border-gray-100">
                    <Clock className="w-3 h-3" />
                    {new Date(recentTripData.created_at || '').toLocaleString() || "Date Unknown"} {/* Adjust field name */}
                  </div>
                </div>
              )}
            </div>
          )}

          {/* Fallback if no recent trip data at all */}
          {!recentTripData && (
             <div className="mb-6">
              <h3 className="font-bold text-lg mb-3 text-gray-900 flex items-center gap-2">
                <Clock className="w-5 h-5 text-gray-600" />
                Recent Trip
              </h3>
              <div className="bg-white rounded-2xl p-5 shadow-sm border border-gray-200 text-center">
                  <p className="text-gray-500 text-sm">No recent trips found.</p>
              </div>
             </div>
          )}

          {/* Premium Feature Banner */}
          <div className="bg-gradient-to-r from-emerald-600 to-teal-600 rounded-2xl p-5 shadow-md mb-6 text-white">
            <div className="flex items-start gap-4">
              <div className="w-12 h-12 bg-white/20 backdrop-blur-sm rounded-2xl flex items-center justify-center flex-shrink-0">
                <Plane className="w-6 h-6 text-white" />
              </div>
              <div className="flex-1">
                <h4 className="font-bold mb-1 text-lg">Flight Delayed?</h4>
                <p className="text-sm text-emerald-100 leading-relaxed">
                  We'll wait for you  no extra charges applied.
                </p>
              </div>
            </div>
          </div>

          {/* Stats Cards */}
          {/* <div className="flex gap-3 mb-6 overflow-x-auto scrollbar-hide mx-auto border border-gray-100 p-2 py-4 shadow-sm rounded-xl items-center justify-center bg-gradient-to-br from-emerald-50 via-teal-50 to-cyan-50 ">
            {[
              {
                value: "12",
                label: "Trips",
                icon: TrendingUp,
                color: "emerald",
              },
              { value: "5.0", label: "Rating", icon: Star, color: "amber" },
              {
                value: `${displayWalletBalance?.toLocaleString() || "0"}`,
                label: "Balance",
                icon: Wallet,
                color: "teal",
              },
            ].map((stat, idx) => (
              <div
                key={idx}
                className="min-w-[100px] bg-white rounded-2xl p-4 shadow-sm border border-gray-200 text-center flex-shrink-0"
              >
                <div className="flex justify-center mb-2">
                  <div
                    className={`w-8 h-8 rounded-lg bg-${stat.color}-50 flex items-center justify-center`}
                  >
                    <stat.icon className={`w-4 h-4 text-${stat.color}-600`} />
                  </div>
                </div>
                <div className="text-xl font-bold text-gray-900 mb-1">
                  {stat.value}
                </div>
                <div className="text-xs text-gray-600 font-medium">
                  {stat.label}
                </div>
              </div>
            ))}
          </div> */}

          {/* Powered By Footer - Subtle placement */}
          <div className="text-center py-6 mb-2">
            <p className="text-xs text-gray-400 font-medium">
              Powered by{" "}
              <span className="text-gray-600 font-semibold">
                Excelian Technologies
              </span>
            </p>
          </div>
        </div>

        {/* NEW: Render the Coming Soon Modal */}
        <ComingSoonModal
          isOpen={showComingSoon.isOpen}
          onClose={() => setShowComingSoon({ isOpen: false, feature: null })}
          feature={showComingSoon.feature!}
          showNotification={showNotification} // Pass the notification function if needed (e.g., for wallet)
        />

        {/* Bottom Navigation */}
        <BottomNavBar
          onProfileClick={() => {}}
          onHomeClick={() => {}}
          onWalletClick={handleWalletClick} // NEW: Use the new handler
          onSearchClick={() => {}}
          walletBalance={walletBalance}
        />
      </div>
    </div>
  );
}





----- FILE: src/app/page.tsx -----
"use client";
import { useEffect, useState, useRef, useCallback, useMemo } from "react";
import { AuthProvider, useAuth } from "@/contexts/AuthContext";
import BookingScreen from "@/components/app/screens/BookingScreen";
import AssigningScreen from "@/components/app/screens/AssigningScreen";
import DriverAssignedScreen from "@/components/app/screens/DriverAssignedScreen";
import TripProgressScreen from "@/components/app/screens/TripProgressScreen";
import TripCompleteScreen from "@/components/app/screens/TripCompleteScreen";
import TripHistoryScreen from "@/components/app/screens/TripHistoryScreen";
import TripDetailsScreen from "@/components/app/screens/TripDetailsScreen";
import WalletScreen from "@/components/app/screens/WalletScreen";
import SettingsScreen from "@/components/app/screens/SettingsScreen";
import DashboardScreen from "@/components/app/screens/DashboardScreen";
import dynamic from "next/dynamic";
const DirectionsModal = dynamic(
  () => import("@/components/app/modals/DirectionsModal"),
  { ssr: false }
);
import PassengerDetailsModal from "@/components/app/modals/PassengerDetailsModal";
import PanicModal from "@/components/app/modals/PanicModal";
import SignupPromptModal from "@/components/app/modals/SignupPromptModal";
import OTPModal from "@/components/app/modals/OTPModal";
import ProfileModal from "@/components/app/modals/ProfileModal";
import CancelModal from "@/components/app/modals/CancelModal";
import RateModal from "@/components/app/modals/RateModal";
import MessageWindowModal from "@/components/app/modals/MessageWindowModal";
import TripRequestStatusModal from "@/components/app/modals/TripRequestStatusModal";
import DriverVerificationModal from "@/components/app/modals/DriverVerificationModal";
import LoginModal from "@/components/app/modals/LoginModal";
import Enable2FAModal from "@/components/app/modals/Enable2FAModal";
import Disable2FAModal from "@/components/app/modals/Disable2FAModal";
import UpdateProfileModal from "@/components/app/modals/UpdateProfileModal";
import Image from "next/image";
import { apiClient } from "@/lib/api";
import TripUpdateNotification from "@/components/app/ui/TripUpdateNotification";
import BottomNavBar from "@/components/app/ui/BottomNavBar";
import { findNearestAirport, KNOWN_AIRPORTS } from "@/lib/airports";
import ReconnectingWebSocket from "reconnecting-websocket";
import { useJsApiLoader } from "@react-google-maps/api";
import TripHistoryModal from "@/components/app/modals/TripHistoryModal";
import TripDetailsModal from "@/components/app/modals/TripDetailModal";
import LoginOTPModal from "@/components/app/modals/LoginOTPModal";
import PasswordResetModal from "@/components/app/modals/PasswordResetModal";
import AccountDeletionModal from "@/components/app/modals/AccountDeletionModal";
import {useApiErrorHandler} from "@/lib/errors/apiErrorHandler"
import router from "next/router";


type TripStatusValue =
  | "searching"
  | "driver_assigned"
  | "accepted"
  | "active"
  | "completed"
  | "cancelled"
  | "driver not found";

type TripStatus = {
  label: string;
  value: TripStatusValue;
};

type WebSocketMessage = {
  event: "trip:assigned" | "trip:status:update" | string;
  data: any;
  message_id: string;
};

type ScreenState =
  | "booking"
  | "assigning"
  | "driver-assigned"
  | "trip-progress"
  | "trip-complete"
  | "dashboard"
  | "signup-prompt"
  | "login-modal"
  | "profile"
  | "settings";

type Requirements = {
  luggage: boolean;
  wheelchair: boolean;
  elderly: boolean;
};

type PassengerData = {
  name: string;
  phone: string;
  email: string;
};

interface PersistedState {
  screen: ScreenState | null;
  pickup: string;
  destination: string;
  fareEstimate: number | null;
  driver: any | null;
  tripProgress: number;
  pickupCoords: [number, number] | null;
  destinationCoords: [number, number] | null;
  verificationCode: string | null;
  activeTripId: string | null;
  guestId: string | null;
  bookAsGuest: boolean;
}

const saveAppState = (state: PersistedState) => {
  if (typeof window !== "undefined" && window.sessionStorage) {
    try {
      sessionStorage.setItem("achrams_app_state", JSON.stringify(state));
      console.log("App state saved to sessionStorage", state);
    } catch (e) {
      console.error("Failed to save app state to sessionStorage", e);
    }
  }
};

const loadAppState = (): PersistedState | null => {
  if (typeof window !== "undefined" && window.sessionStorage) {
    try {
      const savedStateStr = sessionStorage.getItem("achrams_app_state");
      if (savedStateStr) {
        const savedState = JSON.parse(savedStateStr) as PersistedState;
        console.log("App state loaded from sessionStorage", savedState);
        return savedState;
      }
    } catch (e) {
      console.error("Failed to load app state from sessionStorage", e);
    }
  }
  return null;
};

export default function ACHRAMApp() {
  const { token, isAuthenticated, isLoading: isAuthLoading , checkAuthStatus} = useAuth();
  
  const {
    generalError: bookingGeneralError,
    fieldErrors: bookingFieldErrors,
    handleApiError: handleBookingApiError,
    clearErrors: clearBookingErrors,
  } = useApiErrorHandler();

  const getBookingFieldError = (fieldName: string): string | undefined => {
    return bookingFieldErrors[fieldName]?.[0];
  }

  const [hasHydrated, setHasHydrated] = useState(false);
  const [screen, setScreen] = useState<ScreenState | null>(null);
  const [accountData, setAccountData] = useState<any>(null);
  const [pickup, setPickup] = useState<string>("");
  const [destination, setDestination] = useState<string>("");
  const [fareEstimate, setFareEstimate] = useState<number | null>(null);
  const [fareIsFlatRate, setFareIsFlatRate] = useState<boolean | null>(null);
  const [driver, setDriver] = useState<any>(null);
  const [tripProgress, setTripProgress] = useState<number>(0);
  const [pickupCoords, setPickupCoords] = useState<[number, number] | null>(
    null
  );
  const [driverLocation, setDriverLocation] = useState<[number, number] | null>(
    null
  );
  const [pickupCodename, setPickupCodename] = useState<string | undefined>(
    undefined
  );
  const [destinationCoords, setDestinationCoords] = useState<
    [number, number] | null
  >(null);
  const [routePath, setRoutePath] = useState<google.maps.LatLngLiteral[]>([]);
  const [routeInfo, setRouteInfo] = useState<{ distance: string; duration: string } | null>(null);

  const [verificationCode, setVerificationCode] = useState<string | null>(null);
  const [guestId, setGuestId] = useState<string | null>(null);
  const [activeTripId, setActiveTripId] = useState<string | null>(null);
  const [webSocketConnection, setWebSocketConnection] =
    useState<ReconnectingWebSocket | null>(null);
  const [webSocketStatus, setWebSocketStatus] = useState<
    "connecting" | "open" | "closed" | "reconnecting"
  >("closed");
  const [pollingIntervalId, setPollingIntervalId] =
    useState<NodeJS.Timeout | null>(null);
  const [bookAsGuest, setBookAsGuest] = useState(false);
  const activeTripIdRef = useRef(activeTripId);
  const activeGuestIdRef = useRef(guestId);
  const screenRef = useRef(screen);
  const pollingIntervalRef = useRef<NodeJS.Timeout | null>(null);
  // const pollingIntervalIdRef = useRef(pollingIntervalId);
  const [tripHistory, setTripHistory] = useState<any[]>([]);

  useEffect(() => {
    activeTripIdRef.current = activeTripId;
  }, [activeTripId]);

  useEffect(() => {
    screenRef.current = screen;
  }, [screen]);

  useEffect(() => {
    pollingIntervalRef.current = pollingIntervalId;
  }, [pollingIntervalId]);

  const screenPaddingClass = isAuthenticated ? "pb-24" : "pb-20";

  const [walletBalance, setWalletBalance] = useState<number>(0);
  const [is2FAEnabled, setIs2FAEnabled] = useState<boolean>(false);
  const [showPassengerDetails, setShowPassengerDetails] = useState(false);
  const [showDirections, setShowDirections] = useState(false);
  const [showPanic, setShowPanic] = useState(false);
  const [showSignup, setShowSignup] = useState(false);
  const [showOTP, setShowOTP] = useState(false);
  const [otpCountdown, setOtpCountdown] = useState(0);
  const [signupDataForOtp, setSignupDataForOtp] =
    useState<PassengerData | null>(null);
  const [signupPasswordForOtp, setSignupPasswordForOtp] = useState<string>("");
  const [initialOtpCountdown, setInitialOtpCountdown] = useState<number>(0);
  const [showProfile, setShowProfile] = useState(false);
  const [showCancel, setShowCancel] = useState(false);
  const [showRate, setShowRate] = useState(false);
  const [showMessage, setShowMessage] = useState(false);
  const [showTripHistory, setShowTripHistory] = useState(false);
  const [showTripDetails, setShowTripDetails] = useState(false);
  const [selectedTripId, setSelectedTripId] = useState<string | null>(null);
  const [showWallet, setShowWallet] = useState(false);
  const [showSettings, setShowSettings] = useState(false);
  const [showEnable2FA, setShowEnable2FA] = useState(false);
  const [showDisable2FA, setShowDisable2FA] = useState(false);
  const [showUpdateProfile, setShowUpdateProfile] = useState(false);
  const [showLogin, setShowLogin] = useState(false);
  const [tripRequestStatus, setTripRequestStatus] = useState<
    "loading" | "accepted" | "no-driver" | "error" | null
  >(null);
  const [tripRequestError, setTripRequestError] = useState<string | null>(null);
  const [showDriverVerification, setShowDriverVerification] = useState(false);
  const [resetBookingKey, setResetBookingKey] = useState(0);
  const [currentNotification, setCurrentNotification] = useState<{
    message: string;
    type: "info" | "success" | "warning" | "error";
  } | null>(null);
  const [pickupId, setPickupId] = useState<string | null>(null);

  const [passengerLiveLocation, setPassengerLiveLocation] = useState<
    [number, number] | null
  >(null);


  const [weatherData, setWeatherData] = useState<{
  temp: number;
  condition: string; // e.g., 'sunny', 'cloudy', 'rainy'
  location: string;  // e.g., 'Lagos, Nigeria'
  humidity?: number;
  windSpeed?: number;
} | null>(null);

const [weatherLoading, setWeatherLoading] = useState(false);
const [weatherError, setWeatherError] = useState<string | null>(null);



  const [airportPickupArea, setAirportPickupArea] = useState<any>(null);

  const [previousScreen, setPreviousScreen] = useState<ScreenState | null>(
    null
  );

  const [show2FAOtpModal, setShow2FAOtpModal] = useState(false);
  const [pendingLoginCreds, setPendingLoginCreds] = useState<{email: string; password: string} | null>(null)

  // NEW: Add a flag to indicate we are navigating to dashboard with an active trip
  const [isNavigatingToDashboard, setIsNavigatingToDashboard] = useState(false);
  const [showPasswordResetModal, setShowPasswordResetModal] = useState(false);
  const [showAccountDeletionModal, setShowAccountDeletionModal] = useState(false);

  // New state for initialization status
  const [initComplete, setInitComplete] = useState(false);

  // Refs for current state
  const currentAuthStatusRef = useRef(isAuthenticated);
  const currentTokenRef = useRef(token);

  useEffect(() => {
    currentAuthStatusRef.current = isAuthenticated;
    currentTokenRef.current = token;
  }, [isAuthenticated, token]);

  const preserveBookingContext = () => {
    console.log("Clearing trip data but preserving booking context for retry");
    console.log(
      "Inside preserve booking context, I am setting guest Id to null"
    );

    setActiveTripId(null);
    setGuestId(null);
    setDriver(null);
    setVerificationCode(null);
    setTripProgress(0);
    setFareEstimate(null);
    setDestination("");

    if (typeof window !== "undefined" && window.sessionStorage) {
      const currentState = loadAppState();
      sessionStorage.removeItem("tripData");

      if (currentState) {
        saveAppState({
          ...currentState,
          activeTripId: null,
          guestId: null,
          driver: null,
          verificationCode: null,
          tripProgress: 0,
          screen: "booking", //  Go back to booking screen
        });
      }
    }

    setScreen("booking"); //  Show booking screen
  };

  useEffect(() => {
    if (screen !== "driver-assigned" && screen !== "trip-progress" && screen !== 'dashboard') return;

    let watchId: number;

    // const startWatchingLocation = () => {
    //   if (navigator.geolocation) {
    //     watchId = navigator.geolocation.watchPosition(
    //       (position) => {
    //         const { longitude, latitude } = position.coords;
    //         setPassengerLiveLocation([latitude, longitude]);
    //         console.log("Passenger location updated:", [longitude, latitude]);
    //       },
    //       (error) => {
    //         console.error("Error watching passenger location:", error);
    //       },
    //       {
    //         enableHighAccuracy: true,
    //         maximumAge: 5000,
    //         timeout: 10000,
    //       }
    //     );
    //   }
    // };

    const startWatchingLocation = async () => {
  if (!navigator.geolocation) return;

  try {
    // Step 1: Get one accurate position first (waits for good GPS lock)
    const initialPosition = await new Promise<GeolocationPosition>((resolve, reject) => {
      navigator.geolocation.getCurrentPosition(resolve, reject, {
        enableHighAccuracy: true,
        maximumAge: 5000,
        timeout: 20000, // Give GPS time to warm up
      });
    });

    const { longitude, latitude } = initialPosition.coords;
    setPassengerLiveLocation([latitude, longitude]);
    console.log("Initial accurate location:", [longitude, latitude]);

    // Step 2: Now start watching with tighter settings
    watchId = navigator.geolocation.watchPosition(
      (position) => {
        const { longitude, latitude, accuracy } = position.coords;
        
        if (accuracy <= 50) {
          setPassengerLiveLocation([latitude, longitude]);
          console.log("Updated location:", [longitude, latitude]);
        }
      },
      (error) => {
        console.error("Error watching location:", error);
      },
      {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 15000,
      }
    );
  } catch (error) {
    console.error("Failed to get initial location:", error);
  }
};

    startWatchingLocation();

    return () => {
      if (watchId) {
        navigator.geolocation.clearWatch(watchId);
      }
    };
  }, [screen]);

  const activeTripForDashboard = useMemo(() => {
    //if(activeTripId && driver){...}
    if (activeTripId) {
      return {
        id: activeTripId,
        status:
          previousScreen === "trip-progress"
            ? "In Progress"
            : previousScreen === "driver-assigned"
            ? "Driver Assigned"
            : previousScreen === "assigning"
            ? "Assigning"
            : previousScreen === "trip-complete" 
            ? "Completed"
            : "Unknown",
        driver: driver,
        destination: destination,
      };
    }

    return null;
  }, [activeTripId, driver, screen, destination]);

  const initializeAppState = useCallback(async () => {
    if (!hasHydrated || isAuthLoading) {
      console.log(
        "initializeAppState: Waiting for hydration or auth loading to complete."
      );
      return;
    }

    console.log("Initializing app state after hydration and auth check...");

    // Load persisted state (includes screen, trip data, guestId, activeTripId, bookAsGuest flag)
    const savedState = loadAppState();

    // Load persisted trip data (pickup, destination, passenger details, requirements)
    const savedTripDataStr = sessionStorage.getItem("tripData");
    let savedTripData = null;
    if (savedTripDataStr) {
      try {
        savedTripData = JSON.parse(savedTripDataStr);
        console.log("Restored tripData from sessionStorage:", savedTripData);
      } catch (e) {
        console.error("Failed to parse tripData from sessionStorage:", e);
        // Optionally clear corrupted data
        sessionStorage.removeItem("tripData");
      }
    }

    // --- Restore State from savedTripData (if available) ---
    if (savedTripData) {
      setPickup(savedTripData.pickup_address || "");
      setDestination(savedTripData.destination_address || "");
      setFareEstimate(parseFloat(savedTripData.amount?.amount) || null);
      setPickupCoords(savedTripData.pickup_location || null);
      setDestinationCoords(savedTripData.destination_location || null);
      setRequirements({
        luggage: savedTripData.has_extra_luggage || false,
        wheelchair: savedTripData.has_wheel_chair_access || false,
        elderly: savedTripData.has_extra_leg_room || false,
      });
      // Only restore passenger data if it's present in the saved data (relevant for guest/booking-as-guest)
      if (
        savedTripData.guest_name ||
        savedTripData.guest_email ||
        savedTripData.guest_phone
      ) {
        setPassengerData({
          name: savedTripData.guest_name || passengerData.name, // Fallback to existing state
          phone: savedTripData.guest_phone || passengerData.phone,
          email: savedTripData.guest_email || passengerData.email,
        });
      }
    }

    // --- Determine Booking Mode and Restore Session ---
    if (savedState) {
      // Restore the booking mode flag from the saved state
      setBookAsGuest(savedState.bookAsGuest || false);

      const isTransitRoute = typeof window !== 'undefined' && /^\/trips\/transit\/[a-zA-Z0-9_-]+$/.test(window.location.pathname);

      // Scenario 1: Authenticated User with Active Trip
      if (isAuthenticated) {
        console.log(
          "User is authenticated, checking for stored active trip ID..."
        );
        if (savedState.bookAsGuest || savedState.activeTripId) {
          console.log(
            "Found stored active trip ID for authenticated user:",
            savedState.activeTripId
          );
          setActiveTripId(savedState.activeTripId);

          setDriver(savedState.driver);
          console.log("Driver object", driver);

          try {
            // Determine the correct API call based on the saved booking mode (bookAsGuest flag)
            let response;
            if (savedState.bookAsGuest) {
              console.log(
                "Initializing as authenticated user who booked as guest. Fetching trip via guest endpoint with guestId:",
                savedState.guestId
              );

              setGuestId(savedState.guestId || null);

              // Ensure guest ID is cleared for authenticated users (unless they booked as guest)
              if (!savedState.guestId) {
                throw new Error(
                  "bookAsGuest is true but guestId is missing from saved state."
                );
              }
              // Use guest endpoint with guestId, but isGuest=true flag
              response = await apiClient.get(
                `/trips/${savedState.guestId}`, // Use guestId to identify the trip session
                undefined, // token (not directly used for guest calls, cookie handles auth if needed, but guestId takes precedence here)
                true, // isGuest = true (CRITICAL: Uses X-Guest-Id header)
                savedState.guestId // guestId (CRITICAL: Passed as the guest identifier)
              );
            } else {
              setGuestId(null);

              console.log(
                "Initializing as authenticated user who booked normally. Fetching trip via auth endpoint with tripId:",
                savedState.activeTripId
              );
              // Use authenticated endpoint with tripId, isAuthRequest=true flag
              response = await apiClient.get(
                `/trips/${savedState.activeTripId}`, // Use the specific tripId
                undefined, // token (not directly needed, cookie handles auth)
                false, // isGuest = false
                undefined, // guestId (not needed for auth)
                true // isAuthRequest = true (CRITICAL: enables cookie)
              );
            }

            if (response.status === "success" && response.data) {
              const trip = response.data;
              console.log(
                "Fetched trip status for user (booked as guest?",
                !!savedState.bookAsGuest,
                "):",
                trip
              );

              if(savedState.bookAsGuest){
                if (!window.location.pathname.startsWith('/trips/transit/')) {
                  window.history.replaceState(null, '', `/trips/transit/${trip?.guest.id}`);
                  console.log('Updated URL to deep link:', `/trips/transit/${trip?.guest?.id}`);
                }
              }

              if (trip?.map_data?.airport?.pickup_area) {
                setAirportPickupArea(trip.map_data.airport.pickup_area);
              }

              // Set up trip state based on fetched data (common for both modes)
              setDriver(trip.driver || null);
              setPickup(trip.pickup_address || "");

              setActiveTripId(trip.id)

              console.log(
                "Setting Pickup address: ",
                pickup,
                destinationCoords,
                verificationCode,
                trip.pickup_address
              );
              setDestination(trip.destination_address || "");
              setFareEstimate(
                trip.amount?.amount ? parseFloat(trip.amount.amount) : null
              );
              setPickupCoords(
                trip.map_data.pickup_location.geometry.coordinates || null
              );
              console.log("Pickup coords", pickupCoords);
              setDestinationCoords(
                trip.map_data.destination_location.geometry.coordinates || null
              );
              setVerificationCode(trip.verification_code || null);
              setTripProgress(trip.progress || 0);

              // Determine screen based on fetched trip status (common logic)

              if (
                savedState.bookAsGuest &&
                savedState.guestId &&
                savedState.activeTripId
              ) {
                console.log(
                  "Resuming WebSocket for authenticated user who booked as guest."
                );
                startWebSocketConnection(
                  savedState.guestId,
                  savedState.activeTripId
                ); // Use guest connection logic
              } else if (savedState.activeTripId) {
                // For normal auth booking
                console.log(
                  "Resuming WebSocket for authenticated user who booked normally."
                );
                startWebSocketConnectionForAuthUser(savedState.activeTripId); // Use auth connection logic
              }

              if (["searching"].includes(trip.status.value)) {
                setScreen("assigning");
                // Start WebSocket based on the booking mode stored in savedState
              } else if (trip.status.value === "accepted") {
                console.log(
                  "Resuming WebSocket for authenticated user who booked normally."
                );
                // startWebSocketConnectionForAuthUser(savedState.activeTripId);
                setScreen("driver-assigned");
              } else if (trip.status.value === "driver not found") {
                console.log(
                  "Setting screen to assigning due to driver not found."
                );
                setScreen("assigning"); // Or maybe "booking"? Depends on UX
                stopWebSocketConnection();
                stopPollingTripStatus();
                setTripRequestStatus("no-driver");
                setTripRequestError(`No drivers available for your trip.`);
              } else if (trip.status.value === "active") {
                // console.log("Resuming WebSocket for authenticated user who booked normally.");
                // startWebSocketConnectionForAuthUser(savedState.activeTripId);
                setScreen("trip-progress");
              } else if (trip.status.value === "completed") {
                setScreen("trip-complete");
              } else if (trip.status.value === "cancelled") {
                console.log(
                  "Stored trip was cancelled, clearing ID and going to dashboard."
                );

                setActiveTripId(null);
                preserveBookingContext();

                if (typeof window !== "undefined" && window.sessionStorage) {
                  // Clear trip-specific data
                  sessionStorage.removeItem("tripData");
                  // Optionally clear general app state if trip completion means session end
                  // saveAppState({ ...savedState, activeTripId: null, guestId: null, screen: "dashboard" });
                }
                setScreen("dashboard");
              } else {
                console.warn(
                  "Unexpected trip status for user (booked as guest?",
                  !!savedState.bookAsGuest,
                  "):",
                  trip.status
                );
                setScreen("dashboard"); // Default fallback
              }
            } else {
              console.error(
                "Error or trip not found when fetching user's trip (booked as guest?",
                !!savedState.bookAsGuest,
                "):",
                response
              );
              // Clear the stored trip ID as it's no longer valid
              setActiveTripId(null);
              sessionStorage.removeItem("tripData");
              setScreen("dashboard");
            }
          } catch (error) {
            console.error(
              "Error fetching user's trip status (booked as guest?",
              !!savedState.bookAsGuest,
              "):",
              error
            );
            setActiveTripId(null);
            sessionStorage.removeItem("tripData");
            setScreen("dashboard");
          }
        } else {
          // No stored active trip ID for authenticated user, go to dashboard
          console.log(
            "No stored active trip ID for authenticated user, going to dashboard..."
          );
          setScreen("dashboard");
        }
      } else {
        // Scenario 2 & 3: Guest User 
        console.log(
          "User is not authenticated OR was booking as guest, restoring guest session..."
        );
        console.log("Guest ID from session:", savedState.guestId);

        // Check if the guest has an active trip in progress using guestId endpoint
        if (isTransitRoute && savedState.guestId) {
          console.log(
            "Attempting to verify guest trip status for guest ID:",
            savedState.guestId
          );
          setDriver(savedState.driver);

          try {
            
            const response = await apiClient.get(
              `/trips/${savedState.guestId}`, // Use guestId for guest status check
              undefined, // token (not needed for guest flow)
              true, // isGuest = true (CRITICAL: Uses X-Guest-Id header)
              savedState.guestId // guestId (CRITICAL: Passed as the guest identifier)
            );

            if (response.status === "success" && response.data) {
              const trip = response.data;
              console.log(
                "Guest trip status fetch was successful: ",
                response.data
              );

              // Update activeTripId from the fetched trip data (in case it changed or was set during booking)

              if (trip?.map_data?.airport?.pickup_area) {
                setAirportPickupArea(trip.map_data.airport.pickup_area);
              }

              setActiveTripId(trip.id);
              // Ensure guestId is set from the saved state
              setGuestId(savedState.guestId);

              // Set up trip state based on fetched data (common for guest modes)
              setDriver(trip.driver || null);
              setPickup(trip.pickup_address || "");
              setDestination(trip.destination_address || "");
              setFareEstimate(
                trip.amount?.amount ? parseFloat(trip.amount.amount) : null
              );
              console.log(
                "setting pickupcoords from refresh request",
                trip.pickup_location
              );
              setPickupCoords(
                trip.map_data.pickup_location.geometry.coordinates || null
              );
              console.log("Pickup coords", pickupCoords);
              setDestinationCoords(
                trip.map_data.destination_location.geometry.coordinates || null
              );
              setVerificationCode(trip.verification_code || null);
              setTripProgress(trip.progress || 0);

              // Determine screen based on fetched trip status (common logic for guest modes)
              if (trip.status.value === "searching") {
                setScreen("assigning");
                startWebSocketConnection(savedState.guestId, trip.id); // Start guest WebSocket
              } else if (trip.status.value === "driver not found") {
                console.log(
                  "Setting screen to assigning due to driver not found."
                );
                setScreen("assigning"); // Or maybe "booking"? Depends on UX
                stopWebSocketConnection();
                stopPollingTripStatus();
                setTripRequestStatus("no-driver");
                setTripRequestError(`No drivers available for your trip.`);
                // Consider preserving booking context if needed
                // preserveBookingContext();
              } else if (
                ["accepted", "driver_assigned"].includes(trip.status.value)
              ) {
                setScreen("driver-assigned");
                startWebSocketConnection(savedState.guestId, trip.id); // Start guest WebSocket
              } else if (trip.status.value === "active") {
                setScreen("trip-progress");
                startWebSocketConnection(savedState.guestId, trip.id); // Start guest WebSocket
              } else if (trip.status.value === "completed") {
                setScreen("trip-complete");
                // Optional: preserveBookingContext(); // If relevant after completion
              } else if (trip.status.value === "cancelled") {
                // Clear storage and go back to booking
                preserveBookingContext(); // This function should clear trip IDs and guest ID
              } else {
                // Unknown status, go to dashboard
                console.log(
                  "Setting screen to dashboard due to unknown trip status."
                );
                setScreen("dashboard");
              }
            } else {
              // Trip not found or error for guest
              console.log(
                "Trip not found or error for guest ID, going to booking. Response:",
                response
              );
              setScreen("booking");
              preserveBookingContext(); // Clear trip IDs and guest ID
            }
          } catch (error) {
            console.error("Error verifying guest trip status:", error);
            setScreen("booking");
            preserveBookingContext(); // Clear trip IDs and guest ID
          }
        } else {
          // NOT on deep link  clear any accidental guest state
          console.log("Not on deep link  clearing guest trip state if present.");
          if (savedState.guestId || savedState.activeTripId) {
            // Keep booking context (pickup/dest) but clear trip IDs
            saveAppState({
              ...savedState,
              guestId: null,
              activeTripId: null,
              driver: null,
              verificationCode: null,
              tripProgress: 0,
              screen: "booking",
            });
            // Also update local state
            setGuestId(null);
            setActiveTripId(null);
            setDriver(null);
            setVerificationCode(null);
            setTripProgress(0);
          }
          setScreen("booking");
        }
      }
    } else {
      // Scenario 4: No saved state at all
      // No saved state, go to booking or dashboard based on auth status
      console.log("No saved state found.");
      if (isAuthenticated) {
        console.log("user is authenticated, so let us take him to dashboard");
        setScreen("dashboard");
      } else {
        console.log('setting screen to booking from initialize app state else condition')
        setScreen("booking");
      }
      // Reset bookAsGuest flag if there's no saved state indicating it was set
      setBookAsGuest(false);
    }

    // Mark initialization as complete
    setInitComplete(true);
  }, [hasHydrated, isAuthLoading, isAuthenticated, token]); // Dependency array

  // Initialize app state after hydration AND auth loading is complete
  useEffect(() => {
    // This effect now runs when hydration or auth loading state changes
    // It will call initializeAppState which checks both flags internally
    initializeAppState();
  }, [initializeAppState]); // Depend only on the function itself

  // Hydration effect
  useEffect(() => {
    if (typeof window !== "undefined") {
      setHasHydrated(true);
    }
  }, []);

  // Fetch user profile when authenticated
  useEffect(() => {
    if (hasHydrated && isAuthenticated) {
      const fetchAccountData = async () => {
        try {
          console.log("Fetching account data from /auth/passenger/me...");
          // Use your existing apiClient, ensuring it's configured for authenticated requests
          const response = await apiClient.get(
            "/auth/passenger/me",
            undefined,
            false,
            undefined,
            true
          );

          console.log("Account data API response:", response); // Debug log

          if (response.status === "success" && response.data) {
            setAccountData(response.data); // Store the entire data object

            // Derive and set the wallet balance and 2FA status from the response
            const balanceAmount =
              response.data.profile?.wallet?.balance?.amount ?? 0;
            setWalletBalance(balanceAmount);

            const is2FAEnabled = response.data.is_2fa_enabled ?? false;
            setIs2FAEnabled(is2FAEnabled);

            console.log("Account data fetched and state updated:", {
              balance: balanceAmount,
              is2FA: is2FAEnabled,
              // name: response.data.name
            });
          } else {
            console.error(
              "API response for account data was not successful:",
              response
            );
            // Optionally set default values or handle error state
            setWalletBalance(0);
            setIs2FAEnabled(false);
            setCurrentNotification({
              message: response.message || "Failed to load profile data.",
              type: "error",
            });
            // Potentially logout or navigate to an error state
          }
        } catch (err) {
          console.error("Failed to fetch user account data:", err);
          // Handle error, maybe show notification, potentially logout
          setWalletBalance(0);
          setIs2FAEnabled(false);
          setCurrentNotification({
            message:
              "Failed to load profile data. Please check your connection.",
            type: "error",
          });
          // Optionally logout or navigate to an error state
          // Example: preserveBookingContext(); window.location.href = "/auth/login";
        }
      };

      fetchAccountData();
    } else if (hasHydrated && !isAuthenticated) {
      // If user is no longer authenticated, clear the account data
      console.log("User is not authenticated, clearing account data.");
      setAccountData(null);
      setWalletBalance(0);
      setIs2FAEnabled(false);
    }
  }, [hasHydrated, isAuthenticated]);

  // Handle trip completion
  useEffect(() => {
    if (screen === "trip-complete") {
      if (isAuthenticated) {
        // Authenticated user completes trip
        console.log("user is authenticated no need to prompt signup");
      } else {
        const timer = setTimeout(() => {
          setShowSignup(true);
        }, 1500);
        return () => clearTimeout(timer);
      }
    }
  }, [screen]);

  const [passengerData, setPassengerData] = useState<PassengerData>({
    name: "",
    phone: "",
    email: "",
  });

  const [requirements, setRequirements] = useState<Requirements>({
    luggage: false,
    wheelchair: false,
    elderly: false,
  });

  const showNotification = useCallback(
    (
    message: string,
    type: "info" | "success" | "warning" | "error"
  ) => {
    setCurrentNotification({ message, type });
    setTimeout(() => {
      setCurrentNotification(null);
    }, 5000);
  }
    ,[]
  )
  
  console.log("Page.tsx is being rendered Now")

  const [driverDistance, setDriverDistance] = useState<string | null>(null);
  const [driverDuration, setDriverDuration] = useState<string | null>(null);
  const [isDriverAtPickupArea, setIsDriverAtPickupArea] =
    useState<boolean>(false);
  const directionsServiceRef = useRef<google.maps.DirectionsService | null>(
    null
  );

  const driverDurationRef = useRef<number | null>(null);
  const driverDistanceRef = useRef<number | null>(null);
  // NEW: Ref to track if driver has arrived (to show notification only once)
  const isDriverAtPickupAreaRef = useRef<boolean>(false);

  useEffect(() => {
    // Only run if screen is driver-assigned, driver location is available, and pickup is known
    if (
      screen !== "driver-assigned" ||
      !driver?.location ||
      !pickupCoords ||
      !window.google?.maps
    ) {
      // Reset state if conditions are not met
      setDriverDistance(null);
      setDriverDuration(null);
      setIsDriverAtPickupArea(false);
      return;
    }

    const [driverLng, driverLat] = driver.location; // [lng, lat] from WebSocket
    const [pickupLng, pickupLat] = pickupCoords; // [lng, lat] from state

    // Check if driver is within the pickup area polygon
    if (airportPickupArea?.geometry?.coordinates) {
      const polygonCoords = airportPickupArea.geometry.coordinates[0]; // Assuming simple polygon
      const polygon = new google.maps.Polygon({
        paths: polygonCoords.map((coord: number[]) => ({
          lat: coord[1],
          lng: coord[0],
        })),
      });
      const driverLatLng = new google.maps.LatLng(driverLat, driverLng); // [lat, lng] for Google Maps
      const isInside = google.maps.geometry.poly.containsLocation(
        driverLatLng,
        polygon
      );
      setIsDriverAtPickupArea(isInside);

      if (isInside) {
        // Driver is inside the polygon, show arrival notification once
        // Use a ref to ensure notification is only shown once per arrival
        if (!isDriverAtPickupAreaRef.current) {
          // Assume isDriverAtPickupAreaRef is a ref tracking the previous state
          showNotification("Driver has arrived at the pickup area!", "success");
          isDriverAtPickupAreaRef.current = true; // Update the ref
          // Potentially transition screen or stop further distance checks
          // setScreen("trip-progress"); // Uncomment if auto-transition is desired upon arrival
        }
        return; // Stop further processing if arrived
      } else {
        isDriverAtPickupAreaRef.current = false; // Reset ref if driver leaves
      }
    }

    // Calculate directions if not arrived yet
    if (!isDriverAtPickupArea) {
      if (!directionsServiceRef.current) {
        directionsServiceRef.current = new google.maps.DirectionsService();
      }

      const request: google.maps.DirectionsRequest = {
        origin: new google.maps.LatLng(driverLat, driverLng), // Driver's current location [lat, lng]
        destination: new google.maps.LatLng(pickupLat, pickupLng), // Pickup location [lat, lng]
        travelMode: google.maps.TravelMode.DRIVING,
      };

      directionsServiceRef.current.route(request, (result, status) => {
        if (
          status === google.maps.DirectionsStatus.OK &&
          result &&
          result.routes.length > 0
        ) {
          const route = result.routes[0];
          const leg = route.legs[0]; // Assuming single leg

          const newDistance = leg.distance?.text || "Unknown";
          const newDuration = leg.duration?.text || "Unknown";

          // NEW: Throttle/Debounce notifications based on significant changes
          // Example: Only notify if duration changes by more than 1 minute or distance by more than 0.5km
          const durationThreshold = 60; // 1 minute in seconds
          const distanceThreshold = 500; // 0.5 km in meters

          const durationValue = leg.duration?.value || 0;
          const distanceValue = leg.distance?.value || 0;

          // Compare with previous values if they exist
          if (
            driverDurationRef.current !== null &&
            driverDistanceRef.current !== null
          ) {
            const prevDurationValue = driverDurationRef.current; // Assume this is stored in seconds
            const prevDistanceValue = driverDistanceRef.current; // Assume this is stored in meters

            const durationChange = Math.abs(durationValue - prevDurationValue);
            const distanceChange = Math.abs(distanceValue - prevDistanceValue);

            if (
              durationChange >= durationThreshold ||
              distanceChange >= distanceThreshold
            ) {
              // Determine notification type based on remaining time/distance
              let notificationType: "info" | "success" | "warning" | "error" =
                "info";
              let message = `Driver is ${newDistance} away, ETA ${newDuration}`;

              if (durationValue < 120) {
                // Less than 2 mins
                notificationType = "success";
                message = "Driver is very close!";
              } else if (durationValue < 300) {
                // Less than 5 mins
                notificationType = "info";
                message = `Driver is ${newDistance} away, ETA ${newDuration}`;
              } else if (durationValue > 600) {
                // More than 10 mins
                notificationType = "warning";
                message = `Driver is ${newDistance} away, ETA ${newDuration}. This is longer than usual.`;
              }

              showNotification(message, notificationType);
            }
          } else {
            // Initial update or no previous data, always show
            let notificationType: "info" | "success" | "warning" | "error" =
              "info";
            let message = `Driver is ${newDistance} away, ETA ${newDuration}`;
            if (durationValue < 120) {
              notificationType = "success";
              message = "Driver is very close!";
            }
            showNotification(message, notificationType);
          }

          // Update state and refs with new values
          setDriverDistance(newDistance);
          setDriverDuration(newDuration);
          driverDurationRef.current = durationValue; // Store value for comparison
          driverDistanceRef.current = distanceValue; // Store value for comparison
        } else {
          console.warn("Directions request failed:", status, result);
          setDriverDistance("Unknown");
          setDriverDuration("Unknown");
          // Optionally show an error notification
          // showNotification("Could not calculate distance to pickup.", "error");
        }
      });
    }
  }, [
    screen,
    driver?.location,
    pickupCoords,
    airportPickupArea,
    isDriverAtPickupArea,
  ]); // Dependency array

  // Save app state whenever it changes (only after hydration)
  useEffect(() => {
    if (hasHydrated && screen !== null) {
      const screenToSave =
        isNavigatingToDashboard && previousScreen ? previousScreen : screen;

      const stateToSave: PersistedState = {
        screen: screenToSave,
        pickup,
        destination,
        fareEstimate,
        driver,
        tripProgress,
        pickupCoords,
        destinationCoords,
        verificationCode,
        activeTripId,
        guestId,
        bookAsGuest,
      };

      console.log("Saving app state with screen:", screenToSave); // Debug log

      saveAppState(stateToSave);

      if (isNavigatingToDashboard) {
        setIsNavigatingToDashboard(false);
      }
    }
  }, [
    screen,
    pickup,
    destination,
    fareEstimate,
    driver,
    tripProgress,
    pickupCoords,
    destinationCoords,
    verificationCode,
    activeTripId,
    guestId,
    bookAsGuest,
    hasHydrated,
    isNavigatingToDashboard, // Depend on the navigation flag
    previousScreen, // Depend on the previous screen
  ]);

  const handleRegistrationSuccess = (email: string) => {
    console.log("setting screen to dashboard six");
    setScreen("dashboard");
    setShowSignup(false);
  };

  const handleLoginSuccess = () => {
    console.log(
      "login successful, Authcontext should update. Screen will update via useEffect"
    );
    showNotification("Welcome Back!", "success");
    setShowLogin(false);
  };

  const handleLogoutSuccess = () => {
    console.log(
      "Logout successful, Authcontext should update. Screen will update via useEffect"
    );
    showNotification("You have been logged out.", "info");

    preserveBookingContext();
  };

  const handle2FAEnabled = () => {
    setIs2FAEnabled(true);
    setShowEnable2FA(false);
    showNotification(
      "Two-factor authentication enabled successfully!",
      "success"
    );
  };

  const handle2FADisabled = () => {
    setIs2FAEnabled(false);
    setShowDisable2FA(false);
    showNotification("Two-factor authentication disabled.", "info");
  };

  const handleProfileUpdated = (updatedData: any) => {
    setPassengerData(updatedData);
    setShowUpdateProfile(false);
    showNotification("Profile updated successfully!", "success");
  };

  const handleProceed = () => {
    if (fareEstimate && pickup && destination) {
      setShowPassengerDetails(true);
    }
  };

  const formatPhoneNumber = (input: string): string => {
    const digitsOnly = input.replace(/\D/g, "");
    if (digitsOnly.startsWith("0")) {
      return `+234${digitsOnly.slice(1)}`;
    }
    if (digitsOnly.startsWith("234")) {
      return `+${digitsOnly}`;
    }
    if (digitsOnly.startsWith("+")) {
      return digitsOnly;
    }
    if (digitsOnly.length === 11) {
      return `+234${digitsOnly.slice(1)}`;
    }
    return digitsOnly;
  };

  const [bookTripRetry, setBookTripRetry]  = useState(false);

  const handleRequestRide = async () => {
    // Check if tripData exists in sessionStorage

    

    let tripData: any = null;

    if (typeof window !== "undefined" && window.sessionStorage && tripRequestStatus === "no-driver")
       {
      const savedTripData = sessionStorage.getItem("tripData");
      if (savedTripData) {
        tripData = JSON.parse(savedTripData);
        console.log("Using existing tripData from sessionStorage:", tripData);
      }
    }

    // If tripData exists, skip validation and use it directly
    if (!tripData) {
      // Validate passenger details
      if (bookAsGuest || !isAuthenticated) {
        if (
          !passengerData.name ||
          !passengerData.phone ||
          !passengerData.email
        ) {
          showNotification("Please fill all passenger details.", "error");
          return;
        }
      }

      // Validate pickup and destination locations
      if (!pickupCoords || !destinationCoords) {
        showNotification(
          "Pickup and destination locations are required.",
          "error"
        );
        return;
      }

      // Build tripData if it doesn't exist in sessionStorage
      let airportId: string | null = null;
      if (pickup.startsWith("Use my current location")) {
        const nearestAirports = await findNearestAirport(
          pickupCoords[0],
          pickupCoords[1]
        );
        if (!nearestAirports || !nearestAirports.length) {
          setTripRequestStatus("error");
          setTripRequestError(
            "You're outside our service area. Booking not available from this location."
          );
          return;
        }
        const selectedAirport = nearestAirports.find(
          (apt) => apt.name === pickup
        );
        if (!selectedAirport) {
          console.error(
            "Selected pickup name does not match any fetched airport:",
            pickup,
            nearestAirports
          );
          setTripRequestStatus("error");
          setTripRequestError(
            "Could not confirm selected pickup location. Please try again."
          );
          return;
        }
        airportId = selectedAirport.id;
      } else if (pickup in KNOWN_AIRPORTS) {
        airportId = KNOWN_AIRPORTS[pickup];
      } else {
        const nearestAirports = await findNearestAirport(
          pickupCoords[0],
          pickupCoords[1]
        );
        if (!nearestAirports || !nearestAirports.length) {
          setTripRequestStatus("error");
          setTripRequestError(
            "Pickup location is not near a supported airport."
          );
          return;
        }
        const selectedAirport = nearestAirports.find(
          (apt) => apt.name === pickup
        );
        if (selectedAirport) {
          airportId = selectedAirport.id;
        } else {
          console.warn(
            "Typed pickup name did not match any fetched airport name, using first result.",
            pickup,
            nearestAirports
          );
          airportId = nearestAirports[0].id;
        }
      }

      if (!airportId) {
        console.error("Airport ID not available for booking.");
        showNotification(
          "Failed to confirm pickup location. Please try again.",
          "error"
        );
        return;
      }

      tripData = {
        amount: {
          amount: fareEstimate?.toString() || "0",
          currency: "NGN",
        },
        airport: airportId,
        ...(bookAsGuest || !isAuthenticated
          ? {
              guest_name: passengerData.name,
              guest_email: passengerData.email,
              guest_phone: formatPhoneNumber(passengerData.phone),
            }
          : {}),

        has_extra_leg_room: requirements.elderly,
        has_extra_luggage: requirements.luggage,
        has_wheel_chair_access: requirements.wheelchair,
        pickup_address: pickup,
        pickup_location: pickupCoords,
        destination_address: destination,
        destination_location: destinationCoords,
      };

      console.log("Request Data:", tripData);

      // Persist tripData to sessionStorage
      if (typeof window !== "undefined" && window.sessionStorage) {
        sessionStorage.setItem("tripData", JSON.stringify(tripData));
        console.log("Trip data saved to sessionStorage:", tripData);
      }
    }

    // Proceed with the ride request
    // setShowPassengerDetails(false);
    clearBookingErrors();
    setTripRequestStatus("loading");
    setTripRequestError(null);

    try {
      let response;
      if (!bookAsGuest && isAuthenticated) {
        console.log("Booking as an authenticated user");
        response = await apiClient.post(
          "/trips",
          tripData,
          undefined,
          undefined,
          true
        );
      } else {
        // Guest user - use guest booking endpoint
        response = await apiClient.post("/trips/guest-booking", tripData);
      }

      console.log("Raw API Response:", response);

      if (response.status === "success" && response.data) {

        
        
        const trip = response.data;
        setShowPassengerDetails(false);
        const extractedGuestId = trip.guest?.id;
        if(extractedGuestId){
          setGuestId(extractedGuestId);
        }
        if (bookAsGuest || !isAuthenticated && extractedGuestId) {
          // Guest user
          // if (!extractedGuestId) {
          //   console.error(
          //     "Guest ID not found in booking response, cannot start WebSocket."
          //   );
          //   setTripRequestStatus("error");
          //   setTripRequestError(
          //     "Failed to get guest session. Booking cancelled."
          //   );
          //   return;
          // }

          if (bookTripRetry || !window.location.pathname.startsWith('/trips/transit/')) {
            window.history.replaceState(null, '', `/trips/transit/${extractedGuestId}`);
            console.log('Updated URL to deep link:', `/trips/transit/${extractedGuestId}`);
          }

          console.log("Trip data received:", trip);
          console.log("Guest ID received:", extractedGuestId);

          if (trip?.map_data?.airport?.pickup_area) {
            setAirportPickupArea(trip.map_data.airport.pickup_area);
          }

          setVerificationCode(trip.verification_code || "");
          setActiveTripId(trip.id);
          setGuestId(extractedGuestId);

          if (trip.status.value === "searching") {
            setTripRequestStatus(null);
            setScreen("assigning");
            startWebSocketConnection(extractedGuestId, trip.id);
          } else if (trip.status.value === "driver_assigned" && trip.driver) {
            setDriver(trip.driver);
            setTripRequestStatus(null);
            setScreen("driver-assigned");
          } else {
            console.warn("Unexpected trip status after booking:", trip.status);
            setTripRequestStatus("error");
            setTripRequestError(
              `Unexpected booking state: ${trip.status.label}`
            );
          }
        } else {
          // Authenticated user
          console.log("Trip data received:", trip);

          setVerificationCode(trip.verification_code || "");
          setActiveTripId(trip.id);

          if (trip.status.value === "searching") {
            setTripRequestStatus(null);
            setScreen("assigning");
            startWebSocketConnectionForAuthUser(trip.id);
          } else if (trip.status.value === "driver_assigned" && trip.driver) {
            setDriver(trip.driver);
            setTripRequestStatus(null);
            setScreen("driver-assigned");
          } else {
            console.warn("Unexpected trip status after booking:", trip.status);
            setTripRequestStatus("error");
            setTripRequestError(
              `Unexpected booking state: ${trip.status.label}`
            );
          }
        }
      } else {
        console.error(
          "API responded with non-success status or missing data:",
          response
        );
        handleBookingApiError(response);

        if(response?.details?.destination_location){
          setTripRequestStatus("error")
          setTripRequestError(response?.details?.destination_location?.[0])
          // throw new Error(
          //   `${ response?.details?.destination_location?.destination_location?.[0] || "Failed to book your trip. Server responded unexpectedly."} `
          // );
        }
        }
    } catch (err: any) {
      console.error("Booking error:", err);

      handleBookingApiError(err);
      // setTripRequestStatus("error");
      // setTripRequestError(
      // `${ err || "Failed to book your trip. Please check your connection and try again"}`
      const hasFieldErrors = Object.keys(bookingFieldErrors).length > 0
  

      if(bookingGeneralError){
        console.log("general booking error occured")
        setTripRequestStatus("error");
        setTripRequestError(bookingGeneralError);
        if(!hasFieldErrors){
          setShowPassengerDetails(false);
        }
      } 
      // );
    } finally{

    }
  };

  const { isLoaded: isGoogleMapsLoaded, loadError: googleMapsLoadError } =
    useJsApiLoader({
      id: "google-map-script",
      googleMapsApiKey: process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY || "",
      libraries: ["places", "geometry"],
    });

  if (googleMapsLoadError) {
    console.error("Failed to load Google Maps API:", googleMapsLoadError);
    return <div>Error loading Google Maps.</div>;
  }

  const handleShowLocationModal = () => {
    setShowLocationModal(true);
  };

  const handleLocationModalClose = () => {
    setShowLocationModal(false);
  };

  const handleGrantLocationAccess = () => {
    console.log(
      "location access granted button clicked in modal. The BookingScreen will handle the requestPermission call"
    );
  };

  // WebSocket connection for authenticated users
  const startWebSocketConnectionForAuthUser = (tripId: string) => {
    if (webSocketConnection) {
      console.log("Closing existing WebSocket connection.");
      webSocketConnection.close();
    }

    const wsUrl = `wss://api.achrams.com.ng/ws/v1/app?trip_id=${tripId}`;
    console.log(
      `Attempting to connect to WebSocket for authenticated user: ${wsUrl}`
    );

    const rws = new ReconnectingWebSocket(wsUrl, [], {
      connectionTimeout: 10000,
      maxRetries: 10,
      maxReconnectionDelay: 10000,
    });

    rws.onopen = () => {
      console.log("WebSocket connection opened for authenticated user.");
      setWebSocketStatus("open");
      stopPollingTripStatus();
    };

    rws.onmessage = (event) => {
      try {
        const messageData: WebSocketMessage = JSON.parse(event.data);
        console.log("Received WebSocket message in page.tsx:", messageData);
        const { event: eventType, data: tripData, message_id: incomingMessageId } = messageData;

        if (incomingMessageId){
          const ackMessage = JSON.stringify(
            {
              event: "ack",
              data: {
                message_id: incomingMessageId
              }
            }
          );
          console.log("sending ACK for message_id", incomingMessageId);
          rws.send(ackMessage);
        }

        if (tripData?.map_data?.airport?.pickup_area) {
          setAirportPickupArea(tripData.map_data.airport.pickup_area);
        }

        if (
          eventType === "trip:assigned" ||
          eventType === "trip:status:update"
        ) {
          if (tripData.status.value === "driver not found") {
            console.log(
              "Driver not found via WebSocket (page.tsx), updating UI."
            );
            stopWebSocketConnection();
            stopPollingTripStatus();
            setTripRequestStatus("no-driver");
            setTripRequestError(`No drivers available for your trip.`);
            return;
          }
          if (
            (tripData.status.value === "accepted" ||
              tripData.status.value === "driver_assigned") &&
            tripData.driver
          ) {
            console.log(
              `${tripData.status.label} via WebSocket (page.tsx), updating UI with driver.`
            );
            setDriver(tripData.driver);
            console.log("Active Trip Id: ", activeTripId);
            setScreen("driver-assigned");
            stopPollingTripStatus();
            console.log("stopPollingTripStatus was just called");
          } else if (tripData.status.value === "active") {
            console.log(
              `Trip started (status: ${tripData.status.label}) via WebSocket (page.tsx), transitioning to trip-progress.`
            );
            setScreen("trip-progress");
          } else if (
            tripData.status.value === "cancelled" ||
            tripData.status.value === "completed"
          ) {
            console.log(
              `Trip ${tripData.id} is now ${tripData.status.value} via WebSocket (page.tsx).`
            );
            stopWebSocketConnection();
            stopPollingTripStatus();
            setTripProgress(0);
            setVerificationCode(null);
            if (tripData.status.value === "completed") {
              setScreen("trip-complete");
              showNotification("Trip completed successfully", "info");
              // preserveBookingContext()
            } else if (tripData.status.value === "cancelled") {
              showNotification("Trip was cancelled successfully", "info");
              setScreen("booking");
              setDriver(null);
              preserveBookingContext();
            }
          } else {
            console.log(
              `Received trip status update via WebSocket (page.tsx): ${tripData.status.value}`
            );
          }
        }
        if (eventType === "trip:location:driver") {
          const coords = tripData?.map_data?.location?.coordinates; // [lng, lat]
          if (Array.isArray(coords) && coords.length === 2) {
            setDriverLocation(coords);
            setDriver((prevDriver: any) => {
              if (!prevDriver) return null;
              return {
                ...prevDriver,
                location: coords,
              };
            });
            console.log("Driver location updated via WebSocket:", coords);
          } else {
            console.warn("Invalid driver location data received:", coords);
          }
          return;
        } else {
          console.log(
            `Received other WebSocket event (page.tsx): ${eventType}`
          );
        }
      } catch (error) {
        console.error(
          "Error parsing WebSocket message in page.tsx:",
          error,
          event.data
        );
      }
    };

    rws.onclose = (event) => {
      console.log("WebSocket connection closed:", event.code, event.reason);
      const currentTripId = activeTripIdRef.current;
      const currentScreen = screenRef.current;
      const currentPollingId = pollingIntervalRef.current;

      setWebSocketStatus("closed");

      if (
        currentTripId &&
        ![
          "driver-assigned",
          "completed",
          "cancelled",
          "driver not found",
        ].includes(currentScreen) &&
        !currentPollingId
      ) {
        console.log(
          `WebSocket closed unexpectedly while screen is '${currentScreen}', starting polling for trip ${currentTripId} as fallback.`
        );
        startPollingTripStatus(currentTripId, guestId);
      } else {
        console.log(
          `WebSocket closed, but not starting polling. Trip ID: ${currentTripId}, Screen: ${currentScreen}, Polling Active: ${!!currentPollingId}`
        );
        if (
          [
            "driver-assigned",
            "completed",
            "cancelled",
            "driver not found",
          ].includes(currentScreen)
        ) {
          console.log(
            "Screen indicates final state or driver-assigned (post-cancellation), ensuring polling is stopped."
          );
          stopPollingTripStatus();
        }
      }
    };

    rws.onerror = (error) => {
      console.error("WebSocket error:", error);
    };

    setWebSocketConnection(rws);
    setWebSocketStatus("connecting");
  };

  // WebSocket connection for guests
  const startWebSocketConnection = (guestId: string, tripId: string) => {
    if (webSocketConnection) {
      console.log("Closing existing WebSocket connection.");
      webSocketConnection.close();
    }

    const wsUrl = `wss://api.achrams.com.ng/ws/v1/app?guest_id=${guestId}`;
    console.log(`Attempting to connect to WebSocket for guest: ${wsUrl}`);

    const rws = new ReconnectingWebSocket(wsUrl, [], {
      connectionTimeout: 10000,
      maxRetries: 10,
      maxReconnectionDelay: 10000,
    });

    rws.onopen = () => {
      console.log("WebSocket connection opened for guest.");
      setWebSocketStatus("open");
      stopPollingTripStatus();
    };

    rws.onmessage = (event) => {
      try {
        const messageData: WebSocketMessage = JSON.parse(event.data);
        console.log("Received WebSocket message in page.tsx:", messageData);
        const { event: eventType, data: tripData, message_id: incomingMessageId } = messageData;

        if (incomingMessageId){
          const ackMessage = JSON.stringify(
            {
              event: "ack",
              data: {
                message_id: incomingMessageId
              }
            }
          );
          console.log("sending ACK for message_id", incomingMessageId);
          rws.send(ackMessage);
        }

        if (tripData?.map_data?.airport?.pickup_area) {
          setAirportPickupArea(tripData.map_data.airport.pickup_area);
        }

        if (
          eventType === "trip:assigned" ||
          eventType === "trip:status:update"
        ) {
          if (tripData.status.value === "driver not found") {
            console.log(
              "Driver not found via WebSocket (page.tsx), updating UI."
            );
            stopWebSocketConnection();
            stopPollingTripStatus();
            setTripRequestStatus("no-driver");
            setTripRequestError(`No drivers available for your trip.`);
            return;
          }
          if (
            (tripData.status.value === "accepted" ||
              tripData.status.value === "driver_assigned") &&
            tripData.driver
          ) {
            console.log(
              `${tripData.status.label} via WebSocket (page.tsx), updating UI with driver.`
            );
            setDriver(tripData.driver);
            console.log("Active Trip Id: ", activeTripId);
            setScreen("driver-assigned");
            stopPollingTripStatus();
            console.log("stopPollingTripStatus was just called");
          } else if (tripData.status.value === "active") {
            console.log(
              `Trip started (status: ${tripData.status.label}) via WebSocket (page.tsx), transitioning to trip-progress.`
            );
            setScreen("trip-progress");
          } else if (
            tripData.status.value === "cancelled" ||
            tripData.status.value === "completed"
          ) {
            console.log(
              `Trip ${tripData.id} is now ${tripData.status.value} via WebSocket (page.tsx).`
            );
            stopWebSocketConnection();
            stopPollingTripStatus();

            setTripProgress(0);
            setVerificationCode(null);
            if (tripData.status.value === "completed") {
              setScreen("trip-complete");
              showNotification("Trip completed successfully", "info");
              // setGuestId(null)
              // setActiveTripId(null)
            } else if (tripData.status.value === "cancelled") {
              showNotification("Trip was cancelled successfully", "info");
              setDriver(null);
              setScreen("booking");
              preserveBookingContext();
            }
          } else {
            console.log(
              `Received trip status update via WebSocket (page.tsx): ${tripData.status.value}`
            );
          }
        }
        if (eventType === "trip:location:driver") {
          const coords = tripData?.map_data?.location?.coordinates; // [lng, lat]
          if (Array.isArray(coords) && coords.length === 2) {

            setDriverLocation(coords);
            setDriver((prevDriver: any) => {
              if (!prevDriver) return null;
              return {
                ...prevDriver,
                location: coords,
              };
            });
            console.log("Driver location updated via WebSocket:", coords);
          } else {
            console.warn("Invalid driver location data received:", coords);
          }
          return;
        } else {
          console.log(
            `Received other WebSocket event (page.tsx): ${eventType}`
          );
        }
      } catch (error) {
        console.error(
          "Error parsing WebSocket message in page.tsx:",
          error,
          event.data
        );
      }
    };

    rws.onclose = (event) => {
      console.log("WebSocket connection closed:", event.code, event.reason);
      const currentTripId = activeTripIdRef.current;
      const currentGuestId = activeGuestIdRef.current;
      const currentScreen = screenRef.current;
      const currentPollingId = pollingIntervalRef.current;

      setWebSocketStatus("closed");

      if (
        currentTripId &&
        ![
          "driver-assigned",
          "completed",
          "cancelled",
          "driver not found",
        ].includes(currentScreen) &&
        !currentPollingId
      ) {
        console.log(
          `WebSocket closed unexpectedly while screen is '${currentScreen}', starting polling for trip ${currentTripId} as fallback.`
        );
        startPollingTripStatus(currentTripId, guestId);
      } else {
        console.log(
          `WebSocket closed, but not starting polling. Trip ID: ${currentTripId}, Screen: ${currentScreen}, Polling Active: ${!!currentPollingId}`
        );
        if (
          [
            "driver-assigned",
            "completed",
            "cancelled",
            "driver not found",
          ].includes(currentScreen)
        ) {
          console.log(
            "Screen indicates final state or driver-assigned (post-cancellation), ensuring polling is stopped."
          );
          stopPollingTripStatus();
        }
      }
    };

    rws.onerror = (error) => {
      console.error("WebSocket error:", error);
    };

    setWebSocketConnection(rws);
    setWebSocketStatus("connecting");
  };

  const stopWebSocketConnection = () => {
    if (webSocketConnection) {
      stopPollingTripStatus();
      console.log("Manually stopping WebSocket connection.");
      webSocketConnection.close();
      setWebSocketConnection(null);
      setWebSocketStatus("closed");
    }
  };

  const fetchTripStatus = async (tripId: string, guestId: string) => {
    if (!tripId) {
      console.warn("fetchTripStatus called without a tripId");
      return;
    }

    try {
      console.log(`Polling trip status for ID: ${tripId}`);

      let response;
      if (!bookAsGuest && isAuthenticated) {
        // Authenticated user - use trip endpoint
        response = await apiClient.get(
          `/trips/${tripId}`,
          undefined,
          false,
          undefined,
          true
        );
      } else {
        // Guest user - use guest trip endpoint with guestId
        if (!guestId) {
          console.warn("fetchTripStatus called without guestId for guest user");
          stopPollingTripStatus();
          return;
        }

        console.log("Guest Id in polling function", guestId);
        response = await apiClient.get(
          `/trips/${guestId}`,
          undefined,
          true,
          guestId
        );
      }

      if (response.status === "success" && response.data) {
        const trip = response.data;
        console.log(
          `Polled trip status: ${trip.status.value}, has driver: !!${trip.driver}`
        );

        if (trip?.map_data?.airport?.pickup_area) {
          setAirportPickupArea(trip.map_data.airport.pickup_area);
        }

        setDriver(trip.driver || null);
        setPickup(trip.pickup_address || "");

        console.log(
          "Setting Pickup address: ",
          pickup,
          destinationCoords,
          verificationCode,
          trip.pickup_address
        );
        setDestination(trip.destination_address || "");
        setFareEstimate(
          trip.amount?.amount ? parseFloat(trip.amount.amount) : null
        );
        setPickupCoords(
          trip.map_data.pickup_location.geometry.coordinates || null
        );
        console.log("Pickup coords", pickupCoords);
        setDestinationCoords(
          trip.map_data.destination_location.geometry.coordinates || null
        );
        setVerificationCode(trip.verification_code || null);
        setTripProgress(trip.progress || 0);

        const terminalStates = ["driver not found", "cancelled", "completed"];

        if (terminalStates.includes(trip.status.value)) {
          console.log(
            ` Terminal state reached: ${trip.status.value}. STOPPING POLLING.`
          );
          stopPollingTripStatus();
          stopWebSocketConnection();

          if (trip.status.value === "driver not found") {
            setTripRequestStatus("no-driver");
            setTripRequestError("No drivers available for your trip.");
          } else if (trip.status.value === "completed") {
            showNotification("Trip Completed", "success");
            setScreen("trip-complete");
          } else if (trip.status.value === "cancelled") {
            preserveBookingContext();
            showNotification("Trip was cancelled", "info");
            setScreen("booking");
          }

          return; // CRITICAL: Exit immediately
        }

        // DRIVER ASSIGNED - Stop polling
        if (
          (trip.status.value === "accepted" ||
            trip.status.value === "driver_assigned") &&
          trip.driver
        ) {
          console.log(" Driver assigned via polling. STOPPING POLLING.");
          stopPollingTripStatus();
          //stopWebSocketConnection();
          // setDriver(trip.driver);
          setScreen("driver-assigned");
          return; //  CRITICAL: Exit immediately
        }

        //  ACTIVE TRIP - Update screen but continue polling
        if (trip.status.value === "active") {
          console.log(" Trip is active, updating screen");
          setScreen("trip-progress");
          // Don't return - continue polling
        }

        //  For "searching" state, just log and continue
        console.log(` Trip still searching. Continuing to poll.`);
      } else {
        console.error(" Polling API error:", response);
      }
    } catch (err) {
      console.error(" Error polling trip status:", err);
    }
  };

  const startPollingTripStatus = (tripId: string, guestId: string) => {
    if (pollingIntervalRef.current) {
      clearInterval(pollingIntervalRef.current);
      pollingIntervalRef.current = null;
    }

    console.log(
      `Starting polling for trip ${tripId} every 20 seconds (fallback).`
    );

    const interval = setInterval(() => {
      fetchTripStatus(tripId, guestId);
    }, 20000);

    pollingIntervalRef.current = interval;
    setPollingIntervalId(interval);
  };

  const stopPollingTripStatus = () => {
    if (pollingIntervalRef.current) {
      console.log(
        `Stopping trip status polling. with interval ID: ${pollingIntervalRef.current}`
      );
      clearInterval(pollingIntervalRef.current);
      pollingIntervalRef.current = null;
      setPollingIntervalId(null);
    } else {
      console.log(
        "stopPollingTripStatus called but no active polling interval found"
      );
    }
  };

  useEffect(() => {
    return () => {
      console.log("Cleaning up WebSocket and polling intervals on unmount.");
      stopWebSocketConnection();
      stopPollingTripStatus();
    };
  }, []);

  const handleTripStart = () => {
    setScreen("trip-progress");
  };

  const handleRateSubmit = () => {
    setScreen("trip-complete");
  };

  const handleTripComplete = () => {
    setScreen("trip-complete");
  };

  const cancelTrip = async (reason: string) => {
    console.log("Active Trip Id: ", activeTripId);
    if (!activeTripId) {
      console.error(
        "Cannot cancel trip: activeTripId is missing (is null, undefined, or empty string)."
      );
      console.log("Current activeTripId state:", activeTripId);
      console.log("Current screen state:", screen);
      console.log("Current tripRequestStatus:", tripRequestStatus);
      showNotification("Unable to cancel trip. No active trip found.", "error");
      setShowCancel(false);
      return;
    }

    const locationToUse = pickupCoords;
    const addressToUse = pickup;

    if (!locationToUse || !addressToUse) {
      console.error(
        "Cannot cancel trip: Missing pickup coordinates or address for cancellation payload."
      );
      console.log("Current pickupCoords state:", pickupCoords);
      console.log("Current pickup state:", pickup);
      showNotification(
        "Unable to cancel trip. Missing location data.",
        "error"
      );
      setShowCancel(false);
      return;
    }

    try {
      const cancelRequestBody = {
        reason: reason,
        location: [locationToUse[0], locationToUse[1]],
        address: addressToUse,
      };

      console.log(
        "Cancelling trip with ID:",
        activeTripId,
        "and payload:",
        cancelRequestBody
      );

      let response;
      if (!bookAsGuest && isAuthenticated) {
        // Authenticated user - use trip cancel endpoint
        response = await apiClient.post(
          `/trips/${activeTripId}/cancel`,
          cancelRequestBody,
          undefined,
          undefined,
          true
        );
      } else {
        // Guest user - use guest cancel endpoint with guestId
        if (!guestId) {
          console.error("Cannot cancel trip: guestId is missing.");
          console.log("Current guestId state:", guestId);
          showNotification("Unable to cancel trip. Session expired.", "error");
          setShowCancel(false);
          return;
        }

        console.log("Guest Id: ", guestId);
        response = await apiClient.post(
          `/trips/${guestId}/cancel`,
          cancelRequestBody,
          undefined,
          guestId
        );
      }

      if (response.status === "success" && response.data) {
        console.log("Trip cancelled successfully:", response.data);
        showNotification("Trip cancelled successfully.", "success");
        stopWebSocketConnection();
        stopPollingTripStatus();
        setDriver(null);
        setActiveTripId(null);
        if (!isAuthenticated) {
          // Only clear guestId for guest users
          setGuestId(null);
        }
        setPickup("");
        setDestination("");
        setFareEstimate(null);
        setTripProgress(0);
        setPickupCoords(null);
        setDestinationCoords(null);
        setVerificationCode(null);
        setDriverLocation(null);
        setScreen("booking");
      } else {
        console.error(
          "Trip cancellation API responded with non-success status or missing data:",
          response
        );
        let errorMessage =
          "Failed to cancel your trip. Server responded unexpectedly.";
        if (response.message) {
          errorMessage = response.message;
          if (response.details) {
            const fieldErrors = [];
            for (const [field, messages] of Object.entries(response.details)) {
              if (Array.isArray(messages)) {
                fieldErrors.push(`${field}: ${messages.join(", ")}`);
              }
            }
            if (fieldErrors.length > 0) {
              errorMessage += ` Details: ${fieldErrors.join("; ")}`;
            }
          }
        }
        showNotification(errorMessage, "error");
      }
    } catch (err: any) {
      console.error("Error cancelling trip:", err);
      let errorMessage =
        "Failed to cancel your trip. Please check your connection and try again.";
      if (err instanceof Error) {
        errorMessage = err.message;
      } else {
        console.error("Unexpected error type caught:", typeof err, err);
        errorMessage = "An unexpected error occurred during cancellation.";
      }
      showNotification(errorMessage, "error");
    } finally {
      setShowCancel(false);
    }
  };

  const handleSignupInitiateSuccess = (
    data: { name: string; email: string; phone: string; password: string },
    countdown: number
  ) => {
    const { name, email, phone, password } = data;
    const signupData = { name, email, phone };
    setSignupDataForOtp(signupData);
    setPassengerData({ name, phone, email });
    console.log("setting passenger data:", { name, email, phone });
    setSignupPasswordForOtp(password);
    setInitialOtpCountdown(countdown);
    setShowSignup(false); // Close signup modal
    setShowOTP(true);
  };

  const handleResendOtp = async (data: {
    name: string;
    phone: string;
    email: string;
    password: string;
  }): Promise<number> => {
    console.log("Resending OTP for email:", data.email);
    try {
      const nameParts = data.name.trim().split(/\s+/);
      const firstName = nameParts[0] || "User";
      const lastName = nameParts.slice(1).join(" ") || "";
      const response = await apiClient.post(
        "/auth/passenger/onboard/initiate",
        {
          email: data.email,
          phone_number: data.phone, // Use the phone from the stored signup data
          first_name: firstName, // Use the parsed name from the stored signup data
          last_name: lastName,
          password: data.password, // Use the password stored during signup
        }
      );
      console.log("Resend OTP Response:", response);
      if (response.status === "success" && response.data?.countdown) {
        // Return the new countdown received from the API
        console.log("New OTP sent, new countdown:", response.data.countdown);
        showNotification("New OTP sent, new countdown", "info");
        return response.data.countdown;
      } else {
        // Handle potential API error responses that still have status 200
        const errorMessage =
          response.message || "Failed to resend OTP. Please try again.";
        throw new Error(errorMessage);
      }
    } catch (err: any) {
      console.error("Resend OTP Error:", err);
      let errorMessage = "An unexpected error occurred while resending OTP.";
      if (err.response?.data?.message) {
        errorMessage = err.response.data.message;
      } else if (err.message) {
        errorMessage = err.message;
      }
      // Re-throw the error so the OTPModal can catch it and display it
      throw new Error(errorMessage);
    }
  };

  const handleCancelConfirmed = (
    reason: string,
    location?: [number, number],
    address?: string
  ) => {
    cancelTrip(reason);
  };

  const syncTripStatusInBackground = useCallback(
    async (tripId: string, wasBookedAsGuest: boolean) => {
      console.log(
        "Background sync: Fetching current status for trip ID:",
        tripId
      );

      try {
        let response;
        const isCurrentlyAuthenticated = isAuthenticated && !bookAsGuest;
        const isCurrentlyGuest = !isAuthenticated || bookAsGuest;

        // Determine the correct API call based on the booking context (from saved state)
        // and the *current* authentication state.
        // If the user logged out, we might not be able to sync anymore.
        if (isCurrentlyAuthenticated && !wasBookedAsGuest) {
          console.log(
            "Background sync: Fetching status via authenticated endpoint."
          );
          response = await apiClient.get(
            `/trips/${tripId}`,
            undefined,
            false,
            undefined,
            true
          );
        } else if (isCurrentlyGuest && guestId && wasBookedAsGuest) {
          console.log(
            "Background sync: Fetching status via guest endpoint with guestId:",
            guestId
          );
          response = await apiClient.get(
            `/trips/${guestId}`,
            undefined,
            true,
            guestId
          );
        } else {
          console.error(
            "Background sync: Cannot sync status. Authentication context mismatch or missing guestId."
          );
          return; // Exit if context is wrong
        }

        if (response.status === "success" && response.data) {
          const trip = response.data;
          console.log(
            "Background sync: Fetched current trip status:",
            trip.status.value
          );

          // Update state based on the *fetched* status, but only if it represents a change
          // or a final state that requires action (like cancellation/completion).

          // Update driver details if they are now available or changed
          if (
            trip.driver &&
            JSON.stringify(trip.driver) !== JSON.stringify(driver)
          ) {
            setDriver(trip.driver);
          }

          // Update progress if it's an active trip
          if (
            trip.status.value === "active" &&
            trip.progress !== tripProgress
          ) {
            setTripProgress(trip.progress || 0);
          }

          // Update verification code if assigned
          if (
            trip.verification_code &&
            trip.verification_code !== verificationCode
          ) {
            setVerificationCode(trip.verification_code);
          }

          // Check for final or significant status changes that might require navigation
          // even if the user just resumed. This handles the case where status changed
          // *while* they were on the dashboard.
          if (trip.status.value === "completed") {
            console.log("Background sync: Trip is now completed.");
            setScreen("trip-complete"); // Navigate to completion screen if status changed
            // Driver and other state should already be handled by the previous setDriver call
            stopWebSocketConnection(); // Ensure connection is stopped for completed trip
            stopPollingTripStatus();
          } else if (trip.status.value === "cancelled") {
            console.log("Background sync: Trip was cancelled.");
            showNotification("Trip was cancelled.", "info");
            setScreen("booking");
            preserveBookingContext(); // Clear trip-specific state
            stopWebSocketConnection();
            stopPollingTripStatus();
          } else if (trip.status.value === "driver not found") {
            console.log("Background sync: Driver not found.");
            setTripRequestStatus("no-driver");
            setTripRequestError("No drivers available for your trip.");
            // Potentially go back to assigning or booking, depending on UX
            // For now, let's assume the user sees this on the resumed screen or WebSocket handles it
          }
          // Note: Statuses like "searching", "driver_assigned", "active" usually just mean
          // the resumed screen is still correct, and the WebSocket (if restarted) will handle updates.
        } else {
          console.error(
            "Background sync: API call succeeded but response data/status was unexpected:",
            response
          );
        }
      } catch (error) {
        console.error(
          "Background sync: Error fetching current trip status:",
          error
        );
        // An error here doesn't necessarily mean the resumed screen is wrong,
        // just that we couldn't confirm the status. The WebSocket connection might still be active
        // and receive updates, or the user might need to refresh if the state seems stale.
        // We don't navigate away from the resumed screen due to a background sync failure.
      }
    },
    [
      isAuthenticated,
      bookAsGuest,
      guestId,
      driver,
      tripProgress,
      verificationCode,
      setDriver,
      setTripProgress,
      setVerificationCode,
      setScreen,
      setTripRequestStatus,
      setTripRequestError,
      showNotification,
      preserveBookingContext,
      stopWebSocketConnection,
      stopPollingTripStatus,
    ]
  );


  


  const handleResumeActiveTrip = useCallback(() => {
    console.log("Attempting to resume active trip with ID:", activeTripId);

    if (!activeTripId) {
      console.warn("No active trip ID found to resume.");
      setScreen("booking");
      return;
    }

    // Load the *persisted* state from sessionStorage
    const savedState = loadAppState();

    if (!savedState || savedState.activeTripId !== activeTripId) {
      console.warn(
        "No valid persisted state found for the active trip ID, or trip ID mismatch."
      );
      setScreen("booking");
      return;
    }

    console.log("Found persisted state, saved screen was:", savedState.screen);

    // Determine the screen to resume to based on the *persisted* screen state
    const savedScreen = previousScreen;

    if (
      ["assigning", "driver-assigned", "trip-progress"].includes(savedScreen)
    ) {
      setScreen(savedScreen);

      // Restore relevant state from the saved state if available
      setDriver(savedState.driver || null);
      setTripProgress(savedState.tripProgress || 0);
      setVerificationCode(savedState.verificationCode || "");

      // Determine authentication context for WebSocket
      const isCurrentlyAuthenticated = isAuthenticated && !bookAsGuest;
      const isCurrentlyGuest = !isAuthenticated || bookAsGuest;

      // Attempt to restart WebSocket based on the *saved* screen context
      if (
        isCurrentlyAuthenticated &&
        ["assigning", "driver-assigned", "trip-progress"].includes(savedScreen)
      ) {
        console.log(
          "Resuming WebSocket for authenticated user based on saved screen."
        );
        startWebSocketConnectionForAuthUser(activeTripId);
      } else if (
        isCurrentlyGuest &&
        guestId &&
        ["assigning", "driver-assigned", "trip-progress"].includes(savedScreen)
      ) {
        console.log("Resuming WebSocket for guest user based on saved screen.");
        startWebSocketConnection(guestId, activeTripId);
      }

      // Initiate background sync to ensure state is fresh
      syncTripStatusInBackground(activeTripId, savedState.bookAsGuest);
    } else if (savedScreen === "trip-complete") {
      setScreen("trip-complete");
      setDriver(savedState.driver || null);
      // No need to restart WebSocket for completed trip.
    } else {
      console.warn(
        "Persisted screen state is inconsistent with activeTripId, going to booking."
      );
      setScreen("booking");
    }
  }, [
    activeTripId,
    isAuthenticated,
    bookAsGuest,
    guestId,
    setScreen,
    setDriver,
    setTripProgress,
    setVerificationCode,
    startWebSocketConnectionForAuthUser,
    startWebSocketConnection,
    syncTripStatusInBackground,
    previousScreen
  ]);


  const fetchTripHistory = useCallback(async () => {
  if (!isAuthenticated || bookAsGuest) {
    // Only fetch history for authenticated users who booked normally
    return;
  }

  try {
    console.log("Fetching trip history for dashboard...");
    // Example API call - adjust endpoint and parameters as needed
    // Use the same query parameters as TripHistoryScreen for consistency
    // Fetch the first page with a reasonable limit
    const pageNum = 1;
    const limit = 10; // Or another suitable number for the dashboard
    const queryParams = `?page=${pageNum}&page_size=${limit}`;
    const response = await apiClient.get(`/trips${queryParams}`, undefined, false, undefined, true); // isAuthRequest=true

    console.log("Trip history API response for dashboard:", response);

    if (response.count > 0) { // Check if count > 0, indicating success and data
      const paginationData = response; // The response object itself is the pagination object
      const history = paginationData.results || []; // Trips are in the 'results' field
      console.log("Fetched trip history for dashboard:", history);
      setTripHistory(history);
    } else {
      console.log("No trips found in history or count is 0.");
      setTripHistory([]); // Set to empty array if no trips
    }
  } catch (error) {
    console.error("Error fetching trip history for dashboard:", error);
    setTripHistory([]); // Clear history on error
  }
}, [isAuthenticated, bookAsGuest, apiClient]);



// NEW: useEffect to fetch trip history when user becomes authenticated
useEffect(() => {
  if (isAuthenticated && !bookAsGuest) {
    // Optionally add a small delay or debounce if this triggers too frequently
    fetchTripHistory();
  } else {
    // Clear history if user logs out or is a guest
    setTripHistory([]);
  }
}, [isAuthenticated, bookAsGuest, fetchTripHistory]);

// NEW: Determine recentTripData based on activeTripId and tripHistory
// This uses useMemo to calculate the value efficiently only when dependencies change
const recentTripData = useMemo(() => {
  if (activeTripId && !bookAsGuest) {
    // If there's a current active trip in session state, the 'recent' one shown on dashboard
    // should be the *second most recent* trip from history.
    // This assumes tripHistory is sorted with most recent first.
    console.log("Current session has an active trip. Looking for second most recent in history.");
    return tripHistory.length > 1 ? tripHistory[1] : null;
  } else {
    // If there's no current active trip in session state
    console.log("Current session has no active trip. Checking history for resumable or fallback trip.");
    const terminalStatuses = ['completed', 'cancelled']; // Define terminal statuses
    if(bookAsGuest){
      
      return tripHistory.length > 1 ? tripHistory[0] : null;
    }
    // First, try to find the *most recent* trip that is NOT terminal (resumable)
    const resumableTrip = tripHistory.find(trip => !terminalStatuses.includes(trip.status.value));
    if (resumableTrip) {
        console.log("Found a potentially active/resumable trip in history:", resumableTrip);
        return resumableTrip; // Return the first non-terminal trip found
    }

    // If no resumable trip was found, fall back to the *most recent* trip (index 0), regardless of status
    if (tripHistory.length > 0) {
        console.log("No non-terminal trips found. Falling back to the most recent trip (might be terminal):", tripHistory[0]);
        return tripHistory[0]; // Return the most recent trip (e.g., completed/cancelled)
    }

    // If there's no active trip and the history list is empty, return null
    console.log("No active trip and no history found. recentTripData will be null.");
    return null;

  }
}, [activeTripId, bookAsGuest, tripHistory]);


const verify2FAAfterLogin = async (email: string, password: string, otp: string) => {
    console.log("page.tsx: Attempting 2FA verification for login with email:", email);
    try {
        const response = await apiClient.post('/auth/passenger/2fa/verify', {
            email,
            password,
            otp,
        }, undefined, undefined, true); // isAuthRequest=true

        console.log("2FA Verification Response:", response);

        if (response.status === "success" && response.data && response.data.token) {
            console.log("2FA Verification successful. Token received.");
            await new Promise(resolve => setTimeout(resolve, 500));
            await checkAuthStatus();
            return { success: true };
        } else {
            console.error("2FA Verification failed:", response);
            return { success: false, message: response.message || "2FA verification failed." };
        }
    } catch (err: any) {
        console.error("Error during 2FA verification API call:", err);
        let errorMessage = "An error occurred during 2FA verification.";
        if (err.response?.data?.message) {
            errorMessage = err.response.data.message;
        } else if (err.message) {
            errorMessage = err.message;
        }
        return { success: false, message: errorMessage };
    }
};

// NEW: Function to handle OTP submission in the 2FA modal
const handle2FAOtpSubmit = async (otpCode: string) => {
    if (!pendingLoginCreds) {
        console.error("page.tsx: No pending login credentials found for 2FA verification.");
        showNotification("Session expired. Please try logging in again.", "error");
        setShow2FAOtpModal(false);
        return;
    }

    console.log("page.tsx: Submitting OTP for 2FA verification...");
    const { email, password } = pendingLoginCreds;
    const result = await verify2FAAfterLogin(email, password, otpCode);

    if (result.success) {
        console.log("page.tsx: 2FA verification successful. User is now fully authenticated.");
        showNotification("Login successful!", "success");
        setShow2FAOtpModal(false);
        setPendingLoginCreds(null); // Clear stored credentials
    } else {
        console.error("page.tsx: 2FA verification failed:", result.message);
        showNotification(result.message || "2FA verification failed. Please try again.", "error");
    }
};

// NEW: Handler for when LoginModal reports 2FA is required
const handleRequires2FA = useCallback((email: string, password: string) => {
    console.log("page.tsx: Received 2FA requirement from LoginModal for email:", email);
    // Store the credentials received from the login modal
    setPendingLoginCreds({ email, password });
    // Close the login modal
    setShowLogin(false);
    // Open the 2FA OTP modal
    setShow2FAOtpModal(true);
}, [setShowLogin, setShow2FAOtpModal, setPendingLoginCreds]);



const updateAccountData = useCallback((newAccountData: any) => {
  console.log("Updating account data state after API call:", newAccountData);
  setAccountData(newAccountData); 
}, [setAccountData]); 

// NEW: Function to handle resuming a trip by ID (as discussed previously)
const handleResumeTripById = useCallback(async (tripIdToResume: string) => {
  console.log("Attempting to resume trip by ID from dashboard:", tripIdToResume);

  if (!tripIdToResume) {
    console.warn("No trip ID provided to resume.");
    setScreen("booking");
    return;
  }

  try {
    // Determine auth context
    const isCurrentlyAuthenticated = isAuthenticated && !bookAsGuest;
    const isCurrentlyGuest = !isAuthenticated || bookAsGuest;

    let response;
    if (isCurrentlyAuthenticated) {
      console.log("Resuming trip via authenticated endpoint with tripId:", tripIdToResume);
      response = await apiClient.get(`/trips/${tripIdToResume}`, undefined, false, undefined, true); // isAuthRequest=true
      console.log(response)
    } else if (isCurrentlyGuest && guestId) {
      console.log("Resuming trip via guest endpoint with guestId:", guestId);
      response = await apiClient.get(`/trips/${tripIdToResume}?guest_id=${guestId}`, undefined, true, guestId); // isGuest=true
    } else {
      console.error("Cannot resume trip: No valid auth context (token or guestId) for the provided trip ID.");
      setScreen("booking");
      return;
    }

    if (response.status === "success" && response.data) {
      const trip = response.data;
      console.log("Fetched trip details for resume from dashboard:", trip);

      // Update relevant state based on the fetched trip
      setActiveTripId(trip.id);
      setDriver(trip.driver || null);
      setTripProgress(trip.progress || 0);
      setVerificationCode(trip.verification_code || "");
      setPickup(trip.pickup_address || "");
      setDestination(trip.destination_address || "");
      // Update coordinates if available in the response
      setFareEstimate(
                trip.amount?.amount ? parseFloat(trip.amount.amount) : null
              );

      setPickupCoords(
          trip.map_data.pickup_location.geometry.coordinates || null
        );
        console.log("Pickup coords", pickupCoords);
        setDestinationCoords(
          trip.map_data.destination_location.geometry.coordinates || null
        );
      if (trip?.map_data?.airport?.pickup_area) {
        setAirportPickupArea(trip.map_data.airport.pickup_area);
      }

      // Determine the correct screen based on the *fetched* status
      if (trip.status.value === "searching") {
        setScreen("assigning");
        if (isCurrentlyAuthenticated) {
          startWebSocketConnectionForAuthUser(trip.id);
        } else if (isCurrentlyGuest && guestId) {
          startWebSocketConnection(guestId, trip.id);
        }
      } else if (trip.status.value === "accepted") {
        setScreen("driver-assigned");
        setDriver(trip.driver);
        setVerificationCode(trip.verification_code);
        if (isCurrentlyAuthenticated) {
          startWebSocketConnectionForAuthUser(trip.id);
        } else if (isCurrentlyGuest && guestId) {
          startWebSocketConnection(guestId, trip.id);
        }
      } else if (trip.status.value === "active") {
        setScreen("trip-progress");
        setDriver(trip.driver);
        setTripProgress(trip.progress || 0);
        if (isCurrentlyAuthenticated) {
          startWebSocketConnectionForAuthUser(trip.id);
        } else if (isCurrentlyGuest && guestId) {
          startWebSocketConnection(guestId, trip.id);
        }
      } else if (trip.status.value === "completed") {
        setScreen("trip-complete");
        setDriver(trip.driver);
        stopWebSocketConnection();
        stopPollingTripStatus();
      } else if (trip.status.value === "cancelled") {
        console.log("Trip was cancelled, clearing ID and going to dashboard.");
        setActiveTripId(null);
        preserveBookingContext(); // Clear trip-specific state
        stopWebSocketConnection();
        stopPollingTripStatus();
        setScreen("dashboard");
      } else {
        console.warn("Unexpected trip status on resume by ID from dashboard:", trip.status.value);
        setScreen("booking");
        stopWebSocketConnection();
        stopPollingTripStatus();
      }

      // Save the updated state to sessionStorage
      const stateToSave: PersistedState = {
        screen: screen, // The screen set above
        pickup,
        destination,
        fareEstimate,
        driver,
        tripProgress,
        pickupCoords,
        destinationCoords,
        verificationCode,
        activeTripId: trip.id, // Update active trip ID
        guestId, // Keep guest ID if applicable
        bookAsGuest,
        // ... other state that needs persistence ...
      };
      saveAppState(stateToSave);

    } else {
      console.error("Failed to fetch trip details for resume from dashboard:", response);
      setScreen("booking");
      // Optionally clear activeTripId if it was set incorrectly before the call
      if (activeTripId === tripIdToResume) {
        setActiveTripId(null);
      }
    }
  } catch (error) {
    console.error("Error resuming trip by ID from dashboard:", error);
    setScreen("booking");
    // Optionally clear activeTripId if it was set incorrectly before the call
    if (activeTripId === tripIdToResume) {
      setActiveTripId(null);
    }
  }
}, [
  isAuthenticated,
  bookAsGuest,
  guestId,
  startWebSocketConnectionForAuthUser,
  startWebSocketConnection,
  stopWebSocketConnection,
  stopPollingTripStatus,
  setScreen,
  setActiveTripId,
  setDriver,
  setTripProgress,
  setVerificationCode,
  setPickup,
  setDestination,
  setAirportPickupArea,
  pickup,
  destination,
  fareEstimate,
  driver,
  tripProgress,
  verificationCode,
  preserveBookingContext,
  activeTripId,
  screen,
  destinationCoords,
  pickupCoords,
]);



  const handleHomeClick = useCallback(() => {
    if(screen === 'dashboard') return;

    if (activeTripId) {
      // If there's an active trip, we want to navigate to dashboard
      // but save the *current* screen state first.
      console.log(
        "Navigating to dashboard with active trip. Current screen:",
        screen
      );
      setPreviousScreen(screen); // Store the current screen
      setIsNavigatingToDashboard(true); // Set the flag
      setScreen("dashboard"); // Now change the screen state
      // The useEffect above will see the flag and save the 'previousScreen' instead of 'dashboard'
    } else {
      // If no active trip, navigate to the booking screen
      console.log(
        "Navigating to booking (no active trip). Current screen:",
        screen
      );
      setScreen("dashboard");
      // The useEffect will save 'booking' as expected
    }
  }, [activeTripId, screen]);

  const handleLogout = async () => {
              // Optional: Preserve booking context details (pickup, destination) if desired for guest re-entry
              // preserveBookingContext(); // Uncomment if you want to keep booking fields filled

              try {
                console.log("Initiating logout API call...");
                // Make the API call to the logout endpoint
                // Ensure the URL is correct (no trailing spaces)
                const response = await apiClient.post(
                  "/auth/logout", // Corrected URL
                  {},
                  undefined,
                  undefined,
                  true // isAuthRequest: Ensures the auth cookie is sent with the request
                );

                console.log("Logout API response:", response); // Debug log

                if (response.status === "success") {
                  console.log(
                    "Logout successful on server, cookie should be cleared."
                  );
                  window.location.href = "/";
                } else {
                  console.error(
                    "Logout API responded with non-success status:",
                    response
                  );
                  showNotification(
                    response.message || "Logout failed. Please try again.",
                    "error"
                  );
                }
              } catch (err) {
                console.error(
                  "An error occurred during the logout API call:",
                  err
                );
                showNotification(
                  "An error occurred while logging out. Please check your connection.",
                  "error"
                );
              }
            }

   const handleAccountDeletionSuccess = () => {
    console.log("Account deletion confirmed. Loggin out user");
    handleLogout();
    setShowAccountDeletionModal(false);

  }


 const [resolvedLocationName, setResolvedLocationName] = useState<string | null>(null);

// ... (other functions) ...

// NEW: Function to reverse geocode coordinates using Google Geocoding API
const reverseGeocodeLocation = useCallback(async (lat: number, lng: number): Promise<string | null> => {
  try {
    const GEOCODE_API_KEY = process.env.NEXT_PUBLIC_GOOGLE_API_KEY; // Use the same key
    if (!GEOCODE_API_KEY) {
      throw new Error("Geocoding API key is not configured.");
    }

    // Google Geocoding API URL for reverse geocoding
    const GEOCODE_API_URL = `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key=${GEOCODE_API_KEY}`;

    const response = await fetch(GEOCODE_API_URL);
    if (!response.ok) {
      throw new Error(`Geocoding API request failed with status ${response.status}`);
    }

    const data = await response.json();
    console.log("Reverse geocode response:", data);

    if (data.status === 'OK' && data.results && data.results.length > 0) {
      // Extract relevant components
      const result = data.results[0];
      const addressComponents = result.address_components;

      let locality = '';
      let administrativeArea = '';
      let country = '';

      if (addressComponents) {
        for (let component of addressComponents) {
          const types = component.types;
          if (types.includes('locality') && types.includes('political')) {
            locality = component.long_name;
          } else if (types.includes('administrative_area_level_1') && types.includes('political')) {
            administrativeArea = component.short_name; // Use short name (e.g., 'NG-LA') or long_name ('Lagos State')
          } else if (types.includes('country') && types.includes('political')) {
            country = component.short_name; // Use short name (e.g., 'NG') or long_name ('Nigeria')
          }
        }
      }

      // Construct the location name
      let locationName = '';
      if (locality) locationName = locality;
      if (administrativeArea) locationName = locationName ? `${locationName}, ${administrativeArea}` : administrativeArea;
      if (country) locationName = locationName ? `${locationName}, ${country}` : country;

      if (locationName) {
        return locationName;
      } else {
        // Fallback to formatted address if specific components aren't found
        return result.formatted_address || null;
      }
    } else {
      console.warn("Geocoding API returned no results for coordinates:", lat, lng);
      return null;
    }
  } catch (error) {
    console.error("Error reverse geocoding location:", error);
    return null;
  }
}, []); // No dependencies if API key is stable


const weatherFetchTimeoutRef = useRef<NodeJS.Timeout | null>(null);
const hasInitialWeatherFetch = useRef(false); // Track if we've fetched once



const fetchWeatherData = useCallback(async (lat: number, lng: number) => {
  if (!lat || !lng) {
    console.warn("Cannot fetch weather: coordinates missing.");
    setWeatherData(null);
    setWeatherError("Location not available for weather.");
    setResolvedLocationName(null);
    return;
  }

  setWeatherLoading(true);
  setWeatherError(null);
  console.log("Fetching weather data for:", lat, lng);

  try {

    const locationName = await reverseGeocodeLocation(lat, lng);
    if(!locationName){
      console.warn("Could not determine location name for coordinates:", lat, lng);
        setWeatherData(null);
        setWeatherError("Could not determine location name.");
        setResolvedLocationName(null);
        setWeatherLoading(false); // Stop loading
        return;
    }


    const WEATHER_API_KEY = process.env.NEXT_PUBLIC_GOOGLE_API_KEY;
    if (!WEATHER_API_KEY) {
      throw new Error("Weather API key is not configured.");
    }

    // const WEATHER_API_URL = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&appid=${WEATHER_API_KEY}&units=metric`;
    const WEATHER_API_URL =
  `https://weather.googleapis.com/v1/currentConditions:lookup` +
  `?location.latitude=${lat}` +
  `&location.longitude=${lng}` +
  `&key=${WEATHER_API_KEY}`;
    
    const response = await fetch(WEATHER_API_URL,
      {
        method: "GET",
        headers:{Accept: "application/json"} 
      }
    );

    if (!response.ok) {
      throw new Error(`Weather API failed: ${response.status}`);
    }

    const data = await response.json();
    console.log(data)
  

    // const parsedWeather = {
    //   temp: Math.round(data.main.temp),
    //   condition: data.weather[0].main.toLowerCase(),
    //   location: `${data.name}, ${data.sys.country}`,
    //   humidity: data.main.humidity,
    //   windSpeed: data.wind.speed,
    // };

    const parsedWeather = {
      temp: Math.round(data.temperature?.degrees) || 0,
      condition: data.weatherCondition?.description?.text?.toLowerCase() || data.weatherCondition?.type?.toLowerCase() || 'unknown',
      location: locationName,
      humidity: data.relativeHumidity || undefined,
      windSpeed: data.wind?.speed?.value ? (data.wind.speed.value / 3.6).toFixed(2) : undefined,
    };

    setWeatherData(parsedWeather);
    hasInitialWeatherFetch.current = true; // Mark as fetched
    console.log("Weather data set:", parsedWeather);

  } catch (error) {
    console.error("Error fetching weather:", error);
    setWeatherError(error instanceof Error ? error.message : "Unknown error");
    setWeatherData(null);
    setResolvedLocationName(null);
  } finally {
    setWeatherLoading(false);
  }
}, [reverseGeocodeLocation]);

useEffect(() => {
  // Clear any pending timeout
  if (weatherFetchTimeoutRef.current) {
    clearTimeout(weatherFetchTimeoutRef.current);
    weatherFetchTimeoutRef.current = null;
  }

  if (!passengerLiveLocation) {
    console.log("No location available, clearing weather.");
    setWeatherData(null);
    setWeatherError(null);
    hasInitialWeatherFetch.current = false; // Reset on location loss
    return;
  }

  const [lat, lng] = passengerLiveLocation;
  
  // Validate coordinates
  if (typeof lat !== 'number' || typeof lng !== 'number' || isNaN(lat) || isNaN(lng)) {
    console.warn("Invalid coordinates:", passengerLiveLocation);
    setWeatherData(null);
    setWeatherError("Invalid location coordinates.");
    return;
  }

  // STRATEGY 1: Only fetch on first valid location
  if (!hasInitialWeatherFetch.current) {
    console.log("First valid location detected, fetching weather...");
    fetchWeatherData(lat, lng);
    return;
  }

  // STRATEGY 2: Debounce subsequent fetches (only if location changes)
  // This prevents constant refetching due to GPS drift
  console.log("Location updated, but initial weather already fetched. Skipping.");
  
  // Optional: Schedule periodic refresh (e.g., every 30 minutes)
  // Uncomment if you want automatic weather updates
  /*
  const REFRESH_INTERVAL = 30 * 60 * 1000; // 30 minutes
  weatherFetchTimeoutRef.current = setTimeout(() => {
    console.log("Periodic weather refresh triggered");
    fetchWeatherData(lat, lng);
  }, REFRESH_INTERVAL);
  */

  return () => {
    if (weatherFetchTimeoutRef.current) {
      clearTimeout(weatherFetchTimeoutRef.current);
    }
  };
}, [hasHydrated, isAuthenticated, passengerLiveLocation, fetchWeatherData]);




  if (!hasHydrated || isAuthLoading || !initComplete) {
    return (
      <div className="fixed inset-0 flex items-center justify-center bg-achrams-bg-primary z-50">
    {/* Background with subtle gradient animation */}
    <div className="absolute inset-0 bg-gradient-to-br from-achrams-primary-solid/5 via-achrams-secondary-solid/5 to-achrams-bg-primary"></div>
    
    {/* Main Content Container */}
    <div className="relative z-10 flex flex-col items-center space-y-6">
      
      {/* Animated Logo Container */}
      <div className="relative">
        {/* Glow Effect */}
        <div 
          className="absolute -inset-4 rounded-full bg-achrams-primary-solid/20 blur-lg animate-pulse"
          style={{
            animation: 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          }}
        ></div>
        
        {/* Logo Card */}
        <div className="relative w-20 h-20 bg-gradient-to-br from-achrams-primary-solid to-achrams-secondary-solid rounded-2xl flex items-center justify-center shadow-lg border border-achrams-border/20 overflow-hidden">
          {/* Animated Gradient Sweep */}
          <div className="absolute inset-0 bg-[linear-gradient(135deg,transparent_40%,rgba(255,255,255,0.1)_50%,transparent_60%)] animate-sweep"></div>
          
          {/* Logo Image */}
          <Image
            src="/images/logo.png"
            alt="ACHRAMS Logo"
            width={40}
            height={40}
            className="object-contain z-10 relative"
            priority // Good for critical loading assets
          />
        </div>
      </div>

      {/* Loading Text */}
      <div className="text-center">
        {/* <p className="text-achrams-text-secondary text-sm font-medium tracking-wide">
         ACHRAMS...
        </p> */}
        
        {/* Optional Subtle Progress Indicator */}
        <div className="mt-3 w-32 h-1 bg-achrams-bg-secondary rounded-full overflow-hidden mx-auto">
          <div 
            className="h-full bg-achrams-gradient-primary rounded-full animate-progress"
            style={{
              animation: 'loadingBar 1.5s ease-in-out infinite',
            }}
          ></div>
        </div>
      </div>
    </div>

    {/* Custom CSS for animations (can be in a global CSS file or Tailwind config) */}
    <style jsx>{`
      @keyframes pulse {
        0%, 100% { opacity: 0.3; transform: scale(1); }
        50% { opacity: 0.6; transform: scale(1.05); }
      }
      @keyframes sweep {
        0% { transform: translateX(-100%) skewX(-25deg); }
        100% { transform: translateX(100vw) skewX(-25deg); }
      }
      @keyframes loadingBar {
        0% { width: 0%; }
        50% { width: 80%; }
        100% { width: 100%; }
      }
    `}</style>
  </div>
    );
  }

  let mainContent = null;
  if (screen === "booking") {
    mainContent = (
      <BookingScreen
        pickup={pickup}
        setPickup={setPickup}
        destination={destination}
        setDestination={setDestination}
        fareEstimate={fareEstimate}
        setFareEstimate={setFareEstimate}
        fareIsFlatRate={fareIsFlatRate}
        setFareIsFlatRate={setFareIsFlatRate}
        isGoogleMapsLoaded={isGoogleMapsLoaded}
        googleMapsLoadError={googleMapsLoadError}
        onProceed={handleProceed}
        setShowPassengerDetails={setShowPassengerDetails}
        passengerData={passengerData}
        setPassengerData={setPassengerData}
        showPassengerDetails={showPassengerDetails}
        requirements={requirements}
        setRequirements={setRequirements}
        setPickupCoords={setPickupCoords}
        setDestinationCoords={setDestinationCoords}
        tripRequestStatus={tripRequestStatus}
        resetKey={resetBookingKey}
        setPickupId={setPickupId}
        setPickupCodename={setPickupCodename}
        onShowLogin={() => setShowLogin(true)}
        showNotification={showNotification}
        isAuthenticated={isAuthenticated}
        onBackToDashboard={
          isAuthenticated
            ? () => {
                preserveBookingContext();
                setScreen("dashboard");
              }
            : undefined
        }
        screenPaddingClass={screenPaddingClass}
      />
    );
  } else if (screen === "assigning") {
    mainContent = (
      <AssigningScreen
        status={tripRequestStatus}
        isAuthenticated={isAuthenticated}
      />
    );
  } else if (screen === "driver-assigned") {
    mainContent = (
      <DriverAssignedScreen
        pickup={pickup}
        destination={destination}
        driver={driver}
        verificationCode={verificationCode || ""}
        onShowDirections={() => setShowDirections(true)}
        onShowDriverVerification={() => setShowDriverVerification(true)}
        onStartTrip={handleTripStart}
        onBack={() => setScreen("booking")}
        showNotification={showNotification}
        onCancelTrip={() => setShowCancel(true)}
        screenPaddingClass={screenPaddingClass}
        isAuthenticated={isAuthenticated}
      />
    );
  } else if (screen === "trip-progress") {
    mainContent = (
      <TripProgressScreen
        driver={driver}
        onPanic={() => setShowPanic(true)}
        onComplete={handleTripComplete}
        pickupCoords={pickupCoords}
        destinationCoords={destinationCoords}
        tripProgress={tripProgress}
        isGoogleMapsLoaded={isGoogleMapsLoaded}
        googleMapsLoadError={googleMapsLoadError}
        guestId={guestId}
        airportPickupArea={airportPickupArea}
        screenPaddingClass={screenPaddingClass}
        isAuthenticated={isAuthenticated}
        // routePath={routePath}
        // setRoutePath={setRoutePath}
        // routeInfo={routeInfo}
        // setRouteInfo={setRouteInfo}
        driverLocation={driverLocation}
        setDriverLocation={setDriverLocation}
      />
    );
  } else if (screen === "trip-complete") {
    mainContent = (
      <TripCompleteScreen
        fareEstimate={fareEstimate}
        driver={driver}
        pickup={pickup}
        destination={destination}
        onRate={() => setShowRate(true)}
        screenPaddingClass={screenPaddingClass}
        isAuthenticated={isAuthenticated}
        onDone={() => {

          setResetBookingKey((prev) => prev + 1);
          preserveBookingContext();
          setPickup("");
          setDestination("");
          setFareEstimate(null);
          setDriver(null);
          setTripProgress(0);
          setPickupCoords(null);
          setDestinationCoords(null);
          setVerificationCode(null);
          setBookAsGuest(false);
          if (!isAuthenticated) {
            setGuestId(null);
          }
          stopPollingTripStatus();
          stopWebSocketConnection();
          // setDriverLiveLocation(null);
          if (typeof window !== 'undefined'){
            window.history.replaceState(null, '' ,'/');
            console.log('cleared deep link URL, redirected to /')
          }
          if (isAuthenticated) {
            console.log("setting screen to dashboard seven");
            fetchTripHistory();
            setScreen("dashboard")
          } else {
            setScreen("booking");
          }
        }}
      />
    );
  } else if (screen === "dashboard") {
    mainContent = (
      <DashboardScreen
        passengerData={passengerData}
        walletBalance={walletBalance}
        is2FAEnabled={is2FAEnabled}
        onShowProfile={() => setShowProfile(true)}
        accountData={accountData}
        onBookNewTrip={() => {
          if(activeTripId) {
            showNotification('You have an active Trip', "info") 
            return null;
          } 

          setScreen("booking");
          setPickup("");
          setDestination("");
          setFareEstimate(null);
          setPickupCoords(null);
          setDestinationCoords(null);
          setDriver(null);
          setTripProgress(0);
          setVerificationCode(null);
        }}
        // onShowTripHistory={() => setShowTripHistory(true)}
        onShowWallet={() => setShowWallet(true)}
        onShowSettings={() => setShowSettings(true)}
        onShowEnable2FA={() => setShowEnable2FA(true)}
        onShowUpdateProfile={() => setShowUpdateProfile(true)}
        onBookRide={() => setScreen("booking")}
        onProfile={() => setShowProfile(true)}
        onLogout={() => {}}

        weatherData={weatherData}
        weatherLoading={weatherLoading}
        weatherError={weatherError}

        activeTrip={activeTripForDashboard}
        onShowActiveTrip={handleResumeActiveTrip}
        recentTripData = {recentTripData}
        onResumeRecentTrip={handleResumeTripById}
      />
    );
  } else if (showTripHistory) {
    console.log("show trip history was called");
    mainContent = (
      <TripHistoryScreen
        isOpen={showTripHistory}
        onClose={() => setShowTripHistory(false)}
        onSelectTrip={(tripId) => {
          setSelectedTripId(tripId);
          setShowTripHistory(false);
        }}
        showNotification={showNotification}
      />
    );
  } else if (selectedTripId) {
    mainContent = (
      <TripDetailsScreen
        tripId={selectedTripId}
        onBack={() => {
          setSelectedTripId(null);
          console.log("Selected trip Id is true");
          setShowTripHistory(true);
        }}
        showNotification={showNotification}
      />
    );
  } else if (showWallet) {
    mainContent = (
      <WalletScreen
        balance={walletBalance}
        onBack={() => setShowWallet(false)}
      />
    );
  } else if (showSettings) {
    mainContent = (
      <SettingsScreen
        onBack={() => setShowSettings(false)}
        onShowProfile={() => {
          setShowSettings(false);
          setShowProfile(true);
        }}
        onShowEnable2FA={() => {
          setShowSettings(false);
          setShowEnable2FA(true);
        }}
        onShowUpdateProfile={() => {
          setShowSettings(false);
          setShowUpdateProfile(true);
        }}
      />
    );
  }

  return (
    <>
      <div className="min-h-screen flex items-center justify-center">
        <div
          className="
  min-h-screen h-dvh
  w-full max-w-[430px] mx-auto
  bg-white
  flex flex-col
  /* Critical for header/body/footer layouts */
  text-sm
  antialiased
  [font-feature-settings:'ss01']
"
        >
          {/* NEW: Render notification if available */}
          {currentNotification && (
            <TripUpdateNotification
              message={currentNotification.message}
              type={currentNotification.type}
              onDismiss={() => setCurrentNotification(null)}
            />
          )}
          {mainContent}
          {/* Modals - all rendered as overlays */}
          <PassengerDetailsModal
            isOpen={showPassengerDetails}
            onClose={() => setShowPassengerDetails(false)}
            passengerData={passengerData}
            setPassengerData={setPassengerData}
            requirements={requirements}
            setRequirements={setRequirements}
            getBookingFieldError={getBookingFieldError}
            onRequestRide={handleRequestRide}
            isLoading={tripRequestStatus === "loading"}
            isAuthenticated={isAuthenticated}
            setBookAsGuest={setBookAsGuest}
            bookAsGuest={bookAsGuest}
            setTripRequestStatus={setTripRequestStatus}
            setTripRequestError={setTripRequestError}
          />
          {/* NEW: Dynamically imported DirectionsModal */}
          {hasHydrated && (
            <DirectionsModal
              isOpen={showDirections}
              onClose={() => setShowDirections(false)}
              pickup={pickup}
              pickupCoords={pickupCoords}
              destination={destination}
              destinationCoords={destinationCoords}
              driverLocation={driver?.location || null}
              passengerLocation={passengerLiveLocation}
              airportPickupArea={airportPickupArea}
              isGoogleMapsLoaded={isGoogleMapsLoaded}
              googleMapsLoadError={googleMapsLoadError}
            />
          )}
          <PanicModal
            isOpen={showPanic}
            onClose={() => setShowPanic(false)}
            onComplete={() => {
              setShowPanic(false);
              alert("Safety team notified");
            }}
            guestId={isAuthenticated && !bookAsGuest ? null : guestId}
            currentLocationAddress={pickup}
            currentLocationCoords={pickupCoords || [0, 0]}
            tripId={activeTripId || ""}
            isAuthenticated={isAuthenticated}
            bookAsGuest={bookAsGuest}
          />
          {!token && showSignup && (
            <SignupPromptModal
              isOpen={showSignup}
              passengerData={passengerData}
              onClose={() => setShowSignup(false)}
              // NEW: Store the countdown received from SignupPromptModal
              onVerifyEmail={handleSignupInitiateSuccess}
              onRegistrationSuccess={handleRegistrationSuccess}
              onOpenLoginModal={() => setShowLogin(true)}
              onSignup={() => {
                setShowSignup(false);
              }}
              onLogin={() => {
                setShowSignup(false);
              }}
              onContinueAsGuest={() => {
                setShowSignup(false);
                setScreen("dashboard");
              }}
            />
          )}
          <OTPModal
            isOpen={showOTP}
            // NEW: Pass the stored countdown value
            initialOtpCountdown={initialOtpCountdown}
            initialSignupData={{
              ...passengerData,
              password: signupPasswordForOtp,
            }}
            onComplete={() => {
              setScreen("dashboard");
              setShowOTP(false);
              setSignupPasswordForOtp("");
            }}
            onClose={() => {
              console.log("onclose button was clicked");
              setShowOTP(false);
              setSignupPasswordForOtp("");
            }}
            onResendOtp={handleResendOtp} // Pass the stored password
          />
          <ProfileModal
            isOpen={showProfile}
            accountData={accountData}
            onClose={() => setShowProfile(false)}
            showNotification={showNotification}
            onLogout={handleLogout}
            onUpdateAccountData={updateAccountData}
            setShowPasswordResetModal={setShowPasswordResetModal}
            setShowAccountDeletionModal={setShowAccountDeletionModal}
          />
          {/* NEW: Trip Request Status Modal */}
          <TripRequestStatusModal
            isOpen={!!tripRequestStatus}
            status={tripRequestStatus}
            message={tripRequestError}
            onClose={() => {
              setTripRequestStatus(null);
              
              // Clear tripData from sessionStorage
              
              if (typeof window !== "undefined" && window.sessionStorage && tripRequestStatus === "no-driver") {
                console.log("Clearing TripData in session");
                preserveBookingContext();
                sessionStorage.removeItem("tripData");
                console.log("Cleared tripData from sessionStorage.");
                window.history.replaceState(null, '' ,'/');
                setScreen("booking");
              }
            }}
            onConfirm={() => {
              if (
                tripRequestStatus === "no-driver" ||
                tripRequestStatus === "error"
              ) {
                console.log("Retrying booking process...");
                setTripRequestStatus(null);
                setBookTripRetry(true);
                handleRequestRide();
              } else {
                setTripRequestStatus(null);
              }
            }}
          />
          {/* NEW: Driver Verification Modal */}
          <DriverVerificationModal
            isOpen={showDriverVerification}
            securityCode={verificationCode || ""}
            onClose={() => setShowDriverVerification(false)}
          />
          {/* NEW: Login Modal */}
          <LoginModal
            isOpen={showLogin}
            onClose={() => setShowLogin(false)}
            onLoginSuccess={handleLoginSuccess}
            onRequires2FA={handleRequires2FA}
            onLoginError={(errorMessage) => {
                // This function is called by LoginModal when login fails with a specific message
                console.log("page.tsx: Received login error from modal:", errorMessage);
                showNotification(errorMessage, "error"); // Show the specific error notification
            }}
            showNotification={showNotification}
            onShowSignupPrompt={() => {
              setShowSignup(true);
              setShowLogin(false);
            }}
          />

          {show2FAOtpModal && pendingLoginCreds && (
            <LoginOTPModal
              isOpen={show2FAOtpModal}
              onClose={() => {
                  setShow2FAOtpModal(false);
                  setPendingLoginCreds(null); // Clear credentials if modal is closed
              }}
              onSubmit={handle2FAOtpSubmit}
              email={pendingLoginCreds.email} // Pass the email to display
              showNotification={showNotification}
            />
          )}

          {/* NEW: Modals for dashboard features */}
          {showEnable2FA && (
            <Enable2FAModal
              isOpen={showEnable2FA}
              onClose={() => setShowEnable2FA(false)}
              onSuccess={handle2FAEnabled}
            />
          )}
          {showDisable2FA && (
            <Disable2FAModal
              isOpen={showDisable2FA}
              onClose={() => setShowDisable2FA(false)}
              onSuccess={handle2FADisabled}
            />
          )}
          {showUpdateProfile && (
            <UpdateProfileModal
              isOpen={showUpdateProfile}
              initialData={passengerData}
              onClose={() => setShowUpdateProfile(false)}
              onSuccess={handleProfileUpdated}
            />
          )}

          {showTripHistory && (
            <TripHistoryModal
              isOpen={showTripHistory}
              onClose={() => setShowTripHistory(false)}
              onSelectTrip={(tripId) => {
                setSelectedTripId(tripId);
                // setShowTripHistory(false);
                setShowTripDetails(true);
              }}
              showNotification={showNotification}
            />
          )}

          <TripDetailsModal
            isOpen={showTripDetails} // Pass the state controlling visibility
            tripId={selectedTripId} // Pass the selected trip ID
            onClose={() => {
              setShowTripDetails(false); // Close the details modal
              setSelectedTripId(null); // Clear the selected ID
              // Optionally, you could set showTripHistory(true) here if you want
              // to automatically return to the history list after closing details.
              setShowTripHistory(true);
            }}
            showNotification={showNotification}
          />
          {/* Future: Uncomment when implemented */}
          <CancelModal
            isOpen={showCancel}
            onClose={() => setShowCancel(false)}
            onConfirm={handleCancelConfirmed}
            pickupAddress={pickup}
          />
          {showRate && (
            <RateModal
              isOpen={showRate}
              onClose={() => setShowRate(false)}
              onRate={handleRateSubmit}
              driverName={driver?.name}
              setNotification={setCurrentNotification}
              tripId={activeTripId}
              guestId={isAuthenticated && !bookAsGuest ? null : guestId}
              bookAsGuest={bookAsGuest}
              isAuthenticated={isAuthenticated}
            />
          )}
          <MessageWindowModal
            isOpen={showMessage}
            onClose={() => setShowMessage(false)}
            recipientName={driver?.name || "Driver"}
          />
        </div>
      </div>

       {/* NEW: Render Password Reset Modal */}
      <PasswordResetModal
        isOpen={showPasswordResetModal}
        onClose={() => setShowPasswordResetModal(false)}
        showNotification={showNotification}
        email={accountData?.email ?? ''} // Pass user's email
      />

      {/* NEW: Render Account Deletion Modal */}
      <AccountDeletionModal
        isOpen={showAccountDeletionModal}
        onClose={() => setShowAccountDeletionModal(false)}
        onConfirm={handleAccountDeletionSuccess}
        showNotification={showNotification}
      />
      
      {/* NEW: Bottom Navigation Bar - Rendered only on dashboard screen */}
      {isAuthenticated && (
        <BottomNavBar
          onProfileClick={() => setShowProfile(true)}
          walletBalance={walletBalance}
          onHomeClick={handleHomeClick}
          onWalletClick={() => setShowWallet(true)}
          onShowTripHistory={() => {
            setShowTripHistory(true);
            console.log("show trip history value", showTripHistory);
          }}
        />
      )}
    </>
  );
}


----- FILE: src/app/layout.tsx -----
// src/app/layout.tsx
import type { Metadata } from "next";
import "./globals.css";
import ClientProviders from "@/components/ClientProviders"; // We'll create this

export const metadata: Metadata = {
  title: "ACHRAMS Passenger App",
  description: "Book your airport transfer with ACHRAMS.",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en" suppressHydrationWarning={true}>
      <body className="bg-achrams-background-primary" suppressHydrationWarning={true}>
        <ClientProviders>
          {children}
        </ClientProviders>
      </body>
    </html>
  );
}

----- FILE: src/app/trips/transit/[guestId]/page.tsx -----
// app/trips/transit/[guestId]/page.tsx
'use client';

import { useEffect, useState } from 'react';
import { useParams, useRouter } from 'next/navigation';
import { Loader2, AlertCircle } from 'lucide-react';
import Image from 'next/image';
import ACHRAMApp from '@/app/page';

/**
 * Transit Link Page
 * 
 * This page handles deep links for guest users to access their trips across devices.
 * Backend generates links like: /trips/transit/{guestId}
 * 
 * Flow:
 * 1. Extract guestId from URL params
 * 2. Store in achrams_app_state (existing state structure)
 * 3. Redirect to main app
 * 4. Main app's initializeAppState picks up the guestId and restores trip
 */
export default function TransitLinkPage() {
  const params = useParams();
  const router = useRouter();
  const guestId = params.guestId as string;
  
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    // Validate guestId exists
    if (!guestId || typeof guestId !== 'string') {
      console.error('Invalid or missing guestId in transit link');
      setError('Invalid trip link. Please check the URL and try again.');
      return;
    }

    // Basic validation: guestId should be a non-empty string
    // We don't validate specific format since backend may use different ID patterns
    if (guestId.trim().length === 0) {
      console.error('GuestId is empty:', guestId);
      setError('Invalid trip link format. Please check the URL.');
      return;
    }

    console.log('Transit link accessed with guestId:', guestId);

    try {
      // Create state object following existing achrams_app_state structure
      const transitState = {
        screen: null, // Will be determined after fetching trip in main app
        pickup: '',
        destination: '',
        fareEstimate: null,
        driver: null,
        tripProgress: 0,
        pickupCoords: null,
        destinationCoords: null,
        verificationCode: null,
        activeTripId: null, // Will be populated after fetch
        guestId: guestId, //  The extracted guestId from URL
        bookAsGuest: true, // They're accessing an existing guest trip, not booking as guest
      };

      // Store in sessionStorage using existing state key
      sessionStorage.setItem('achrams_app_state', JSON.stringify(transitState));
      console.log('Saved transit guestId to achrams_app_state:', transitState);

      // Small delay to ensure sessionStorage write completes
      // setTimeout(() => {
      //   console.log('Redirecting to main app to restore trip session...');
      //   router.replace('/'); // Redirect to main app
      // }, 100);
      

    } catch (err) {
      console.error('Error saving transit state to sessionStorage:', err);
      setError('Failed to process trip link. Please try again.');
    }
  }, [guestId, router]);

  // Error state
  if (error) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-red-50 to-orange-50 px-6">
        <div className="max-w-md w-full bg-white rounded-2xl shadow-lg p-8">
          <div className="flex flex-col items-center gap-4 text-center">
            <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center">
              <AlertCircle className="w-8 h-8 text-red-600" />
            </div>
            <h1 className="text-xl font-bold text-gray-900">Invalid Trip Link</h1>
            <p className="text-gray-600 leading-relaxed">{error}</p>
            <button
              onClick={() => router.push('/')}
              className="mt-4 w-full bg-gradient-to-r from-emerald-600 to-teal-600 text-white py-3 px-6 rounded-xl font-semibold shadow-md hover:shadow-lg transition-all"
            >
              Go to Home
            </button>
          </div>
        </div>
      </div>
    );
  }

  return <ACHRAMApp />
  // Loading state (default)
  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-emerald-50 via-teal-50 to-cyan-50">
      <div className="flex flex-col items-center gap-6">
        {/* Animated Logo Container */}
        <div className="relative">
          {/* Glow Effect */}
          <div 
            className="absolute -inset-4 rounded-full bg-emerald-500 opacity-20 blur-lg"
            style={{
              animation: 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            }}
          />
          
          {/* Logo Card */}
          <div className="relative w-20 h-20 bg-gradient-to-br from-emerald-600 to-teal-600 rounded-2xl flex items-center justify-center shadow-lg overflow-hidden">
            {/* Animated Gradient Sweep */}
            <div 
              className="absolute inset-0"
              style={{
                background: 'linear-gradient(135deg, transparent 40%, rgba(255,255,255,0.2) 50%, transparent 60%)',
                animation: 'sweep 2s linear infinite',
              }}
            />
            
            {/* Logo Image */}
            <Image
              src="/images/logo.png"
              alt="ACHRAMS Logo"
              width={40}
              height={40}
              className="object-contain relative z-10"
              priority
            />
          </div>
        </div>
        
        {/* Loading State */}
        <div className="flex flex-col items-center gap-3">
          {/* <Loader2 className="w-10 h-10 text-emerald-600 animate-spin" /> */}
          <h2 className="text-gray-900 font-bold text-xl">Loading Your Trip</h2>
          <p className="text-gray-600 text-sm">Please wait a moment...</p>
        </div>

        {/* Progress Indicator */}
        <div className="w-48 h-1 bg-gray-200 rounded-full overflow-hidden">
          <div 
            className="h-full bg-gradient-to-r from-emerald-600 to-teal-600 rounded-full"
            style={{
              animation: 'loadingBar 1.5s ease-in-out infinite',
            }}
          />
        </div>
      </div>

      {/* Custom CSS Animations */}
      <style jsx>{`
        @keyframes pulse {
          0%, 100% { 
            opacity: 0.2; 
            transform: scale(1); 
          }
          50% { 
            opacity: 0.4; 
            transform: scale(1.05); 
          }
        }
        
        @keyframes sweep {
          0% { 
            transform: translateX(-100%) skewX(-25deg); 
          }
          100% { 
            transform: translateX(200%) skewX(-25deg); 
          }
        }
        
        @keyframes loadingBar {
          0% { 
            width: 0%; 
            margin-left: 0%; 
          }
          50% { 
            width: 70%; 
            margin-left: 0%; 
          }
          100% { 
            width: 0%; 
            margin-left: 100%; 
          }
        }
      `}</style>
    </div>
  );
}

----- FILE: src/lib/utils.ts -----
// src/lib/utils.ts

/**
 * Formats a Nigerian phone number to the +234XXXXXXXXX format.
 * Handles various input formats like 080XXXXXXXX, 234XXXXXXXX, +234XXXXXXXX.
 * @param input - The raw phone number string.
 * @returns The formatted phone number string in +234XXXXXXXXX format.
 */
export const formatPhoneNumber = (input: string): string => {
 
  const digitsOnly = input.replace(/\D/g, "");

  
  if (digitsOnly.startsWith("0")) {
    return `+234${digitsOnly.slice(1)}`;
  }

  
  if (digitsOnly.startsWith("234")) {
    return `+${digitsOnly}`;
  }

  
  if (digitsOnly.startsWith("+234")) {
    return digitsOnly;
  }

  
  if (digitsOnly.length === 11 && /^[789]\d{9}$/.test(digitsOnly)) {
     return `+234${digitsOnly.slice(1)}`;
  }

  
  console.warn(`Phone number format not recognized: ${input}. Returning as is.`);
  return digitsOnly;
};

----- FILE: src/lib/api.ts -----

// src/lib/api.ts
const API_BASE = 'https://api.achrams.com.ng/v1'; // Corrected trailing space

interface ApiResponse<T = unknown> {
  status: 'success' | 'error';
  message: string;
  data?: T;
  details?: Record<string, string[]>;
}

// NEW: Updated buildHeaders to correctly handle the new parameter flow
// It should NOT add Authorization header for requests intended to use cookies IF the backend relies solely on cookies.
// It SHOULD add X-Guest-Id for guest requests.
const buildHeaders = (
  token?: string, // Token for Bearer header (used if isAuthRequest is false or if backend checks both)
  isGuest = false,
  guestId?: string,
  isFormData = false,
  isAuthRequest = false // NEW: Flag indicating if this request relies on httpOnly cookie
) => {
  const headers: Record<string, string> = {};

  if (!isFormData) {
    headers['Content-Type'] = 'application/json';
  }

  // NEW: Add Authorization header only if:
  // 1. A token is provided AND {undefined, false, undefined, false, true}
  // 2. It's NOT an authenticated request relying on cookies (isAuthRequest is false) OR
  // 3. The backend is configured to check both (less common, but possible)
  // For cookie-based auth, the header is often omitted.
  if (token && !isAuthRequest) {
    headers['Authorization'] = `Bearer ${token}`;
  }

  // Add X-Guest-Id header if it's a guest request
  if (isGuest && guestId) {
    headers['X-Guest-Id'] = guestId;
  }

  return headers;
};

export const apiClient = {
  post: async <T = unknown>(
    endpoint: string,
    data: unknown,
    token?: string, // Token for Bearer header (if not using cookie)
    guestId?: string,
    isAuthRequest = false // NEW: Flag for cookie-based requests
  ): Promise<ApiResponse<T>> => {
    const isGuestRequest = endpoint.includes('/guest-booking') ||
                          endpoint.includes('/cancel') || // Note: This could be for guest or auth user depending on context
                          endpoint.includes('/rate') ||   // Note: This could be for guest or auth user depending on context
                          guestId !== undefined;

    try {
      // NEW: Prepare fetch options
      const fetchOptions: RequestInit = {
        method: 'POST',
        headers: buildHeaders(token, isGuestRequest, guestId, false, isAuthRequest), // Pass isAuthRequest to buildHeaders
        body: JSON.stringify(data),
      };

      // NEW: Add credentials if the request is for an authenticated user (relies on cookie)
      if (isAuthRequest) {
        fetchOptions.credentials = 'include';
      }

      const res = await fetch(`${API_BASE}${endpoint}`, fetchOptions);

      const responseData = await res.json();

      if (!res.ok) {
        return {
          status: 'error',
          message: responseData.message || `HTTP error! status: ${res.status}`,
          details: responseData.details,
        };
      }

      return responseData;
    } catch (error) {
      console.error('API POST Error:', error);
      return {
        status: 'error',
        message: error instanceof Error ? error.message : 'Network error',
      };
    }
  },

  get: async <T = unknown>(
    endpoint: string,
    token?: string, // Token for Bearer header (if not using cookie)
    isGuest = false,
    guestId?: string,
    isAuthRequest = false // NEW: Flag for cookie-based requests
  ): Promise<ApiResponse<T>> => {
    try {
      // NEW: Prepare fetch options
      const fetchOptions: RequestInit = {
        headers: buildHeaders(token, isGuest, guestId, false, isAuthRequest), // Pass isAuthRequest to buildHeaders
      };

      // NEW: Add credentials if the request is for an authenticated user (relies on cookie)
      if (isAuthRequest) {
        fetchOptions.credentials = 'include';
      }

      const res = await fetch(`${API_BASE}${endpoint}`, fetchOptions);

      const responseData = await res.json();

      if (!res.ok) {
        return {
          status: 'error',
          message: responseData.message || `HTTP error! status: ${res.status}`,
          details: responseData.details,
        };
      }

      return responseData;
    } catch (error) {
      console.error('API GET Error:', error);
      return {
        status: 'error',
        message: error instanceof Error ? error.message : 'Network error',
      };
    }
  },

  patch: async <T = unknown>(
    endpoint: string,
    data: FormData | Record<string, unknown>,
    token?: string, // Token for Bearer header (if not using cookie)
    isAuthRequest = false // NEW: Flag for cookie-based requests
  ): Promise<ApiResponse<T>> => {
    const isFormData = data instanceof FormData;

    try {
      // NEW: Prepare fetch options
      const fetchOptions: RequestInit = {
        method: 'PATCH',
        headers: buildHeaders(token, false, undefined, isFormData, isAuthRequest), // Pass isAuthRequest to buildHeaders
        body: isFormData ? data : JSON.stringify(data),
      };

      // NEW: Add credentials if the request is for an authenticated user (relies on cookie)
      if (isAuthRequest) {
        fetchOptions.credentials = 'include';
      }

      const res = await fetch(`${API_BASE}${endpoint}`, fetchOptions);

      const responseData = await res.json();

      if (!res.ok) {
        return {
          status: 'error',
          message: responseData.message || `HTTP error! status: ${res.status}`,
          details: responseData.details,
        };
      }

      return responseData;
    } catch (error) {
      console.error('API PATCH Error:', error);
      return {
        status: 'error',
        message: error instanceof Error ? error.message : 'Network error',
      };
    }
  },

  delete: async <T = unknown>(
    endpoint: string,
    token?: string, // Token for Bearer header (if not using cookie)
    isAuthRequest = false // NEW: Flag for cookie-based requests
  ): Promise<ApiResponse<T>> => {
    try {
      // NEW: Prepare fetch options
      const fetchOptions: RequestInit = {
        method: 'DELETE',
        headers: buildHeaders(token, false, undefined, false, isAuthRequest), // Pass isAuthRequest to buildHeaders
      };

      // NEW: Add credentials if the request is for an authenticated user (relies on cookie)
      if (isAuthRequest) {
        fetchOptions.credentials = 'include';
      }

      const res = await fetch(`${API_BASE}${endpoint}`, fetchOptions);

      const responseData = await res.json();

      if (!res.ok) {
        return {
          status: 'error',
          message: responseData.message || `HTTP error! status: ${res.status}`,
        };
      }

      return responseData;
    } catch (error) {
      console.error('API DELETE Error:', error);
      return {
        status: 'error',
        message: error instanceof Error ? error.message : 'Network error',
      };
    }
  },
};








// src/lib/api.ts
// const API_BASE = 'https://api.achrams.com.ng/v1';

// interface ApiResponse<T = unknown> {
//   status: 'success' | 'error';
//   message: string;
//   data?: T;
//   details?: Record<string, string[]>;
// }

// const buildHeaders = (
//   token?: string,
//   isGuest = false,
//   guestId?: string,
//   isFormData = false
// ) => {
//   const headers: Record<string, string> = {};
  
//   if (!isFormData) {
//     headers['Content-Type'] = 'application/json';
//   }
  
//   if (token) {
//     headers['Authorization'] = `Bearer ${token}`;
//   }
  
//   if (isGuest && guestId) {
//     headers['X-Guest-Id'] = guestId;
//   }
  
//   return headers;
// };

// export const apiClient = {
//   post: async <T = unknown>(
//     endpoint: string,
//     data: unknown,
//     token?: string,
//     guestId?: string
//   ): Promise<ApiResponse<T>> => {
//     const isGuestRequest = endpoint.includes('/guest-booking') || 
//                           endpoint.includes('/cancel') || 
//                           endpoint.includes('/rate') ||
//                           guestId !== undefined;
    
//     try {
//       const res = await fetch(`${API_BASE}${endpoint}`, {
//         method: 'POST',
//         headers: buildHeaders(token, isGuestRequest, guestId),
//         body: JSON.stringify(data),
//       });

//       const responseData = await res.json();

//       if (!res.ok) {
//         return {
//           status: 'error',
//           message: responseData.message || `HTTP error! status: ${res.status}`,
//           details: responseData.details,
//         };
//       }

//       return responseData;
//     } catch (error) {
//       console.error('API POST Error:', error);
//       return {
//         status: 'error',
//         message: error instanceof Error ? error.message : 'Network error',
//       };
//     }
//   },

//   get: async <T = unknown>(
//     endpoint: string,
//     isGuest = false,
//     guestId?: string,
//     token?: string
//   ): Promise<ApiResponse<T>> => {
//     try {
//       const res = await fetch(`${API_BASE}${endpoint}`, {
//         headers: buildHeaders(token, isGuest, guestId),
//       });

//       const responseData = await res.json();

//       if (!res.ok) {
//         return {
//           status: 'error',
//           message: responseData.message || `HTTP error! status: ${res.status}`,
//           details: responseData.details,
//         };
//       }

//       return responseData;
//     } catch (error) {
//       console.error('API GET Error:', error);
//       return {
//         status: 'error',
//         message: error instanceof Error ? error.message : 'Network error',
//       };
//     }
//   },

//   patch: async <T = unknown>(
//     endpoint: string,
//     data: FormData | Record<string, unknown>,
//     token?: string
//   ): Promise<ApiResponse<T>> => {
//     const isFormData = data instanceof FormData;
    
//     try {
//       const res = await fetch(`${API_BASE}${endpoint}`, {
//         method: 'PATCH',
//         headers: buildHeaders(token, false, undefined, isFormData),
//         body: isFormData ? data : JSON.stringify(data),
//       });

//       const responseData = await res.json();

//       if (!res.ok) {
//         return {
//           status: 'error',
//           message: responseData.message || `HTTP error! status: ${res.status}`,
//           details: responseData.details,
//         };
//       }

//       return responseData;
//     } catch (error) {
//       console.error('API PATCH Error:', error);
//       return {
//         status: 'error',
//         message: error instanceof Error ? error.message : 'Network error',
//       };
//     }
//   },

//   delete: async <T = unknown>(
//     endpoint: string,
//     token?: string
//   ): Promise<ApiResponse<T>> => {
//     try {
//       const res = await fetch(`${API_BASE}${endpoint}`, {
//         method: 'DELETE',
//         headers: buildHeaders(token),
//       });

//       const responseData = await res.json();

//       if (!res.ok) {
//         return {
//           status: 'error',
//           message: responseData.message || `HTTP error! status: ${res.status}`,
//         };
//       }

//       return responseData;
//     } catch (error) {
//       console.error('API DELETE Error:', error);
//       return {
//         status: 'error',
//         message: error instanceof Error ? error.message : 'Network error',
//       };
//     }
//   },
// };








----- FILE: src/lib/errors/apiErrorHandler.ts -----
// hooks/useApiErrorHandler.ts (or utils/apiErrorHandler.ts)

import { useState } from 'react';

type FieldErrors = {
  [fieldName: string]: string[];
};

export const useApiErrorHandler = () => {
  const [generalError, setGeneralError] = useState<string | null>(null);
  const [fieldErrors, setFieldErrors] = useState<FieldErrors>({});

  const parseFieldErrors = (details: any): FieldErrors => {
    const parsedFieldErrors: FieldErrors = {};
    if (details && typeof details === 'object') {
      for (const fieldName in details) {
        if (details.hasOwnProperty(fieldName)) {
          const fieldErrorList = details[fieldName];
          if (Array.isArray(fieldErrorList) && fieldErrorList.length > 0) {
            parsedFieldErrors[fieldName] = fieldErrorList;
          } else if (typeof fieldErrorList === 'string') {
            parsedFieldErrors[fieldName] = [fieldErrorList];
          }
        }
      }
    }
    return parsedFieldErrors;
  };

  const handleApiError = (errorObj: any) => {
    console.log("Handling API error object:", errorObj); // Debug log

    // Check if it looks like an API response error (has status === "error")
    if (errorObj && typeof errorObj === 'object' && errorObj.status === "error") {
      const response = errorObj;

      // Parse field-specific errors
      const parsedFieldErrors = parseFieldErrors(response.details);
      setFieldErrors(parsedFieldErrors);

      // Set a general error message (e.g., the first field error or the top-level message)
      let message = response.message || 'Operation failed.';
      if (Object.keys(parsedFieldErrors).length > 0) {
        const firstField = Object.keys(parsedFieldErrors)[0];
        message = parsedFieldErrors[firstField][0] || message; // Use first error of first field
      }
      setGeneralError(message);
    }
    // Check if it looks like a raw error object from a catch block (e.g., err.response.data)
    else if (errorObj && typeof errorObj === 'object' && errorObj.status === "error") {
      // This branch handles the case where the entire error object *is* the API error response
      // e.g., handleApiError(err.response.data) in a catch block
      const response = errorObj;
      const parsedFieldErrors = parseFieldErrors(response.details);
      setFieldErrors(parsedFieldErrors);

      let message = response.message || 'An error occurred.';
      if (Object.keys(parsedFieldErrors).length > 0) {
        const firstField = Object.keys(parsedFieldErrors)[0];
        message = parsedFieldErrors[firstField][0] || message;
      }
      setGeneralError(message);
    }
    // Handle raw error object (e.g., from catch) that might have response.data
    else if (errorObj && errorObj.response && errorObj.response.data) {
        const responseData = errorObj.response.data;
        if (responseData.status === "error") {
            const parsedFieldErrors = parseFieldErrors(responseData.details);
            setFieldErrors(parsedFieldErrors);

            let message = responseData.message || 'An error occurred.';
            if (Object.keys(parsedFieldErrors).length > 0) {
                const firstField = Object.keys(parsedFieldErrors)[0];
                message = parsedFieldErrors[firstField][0] || message;
            }
            setGeneralError(message);
        } else {
            // If response data doesn't have status "error", treat it as a generic error
            setGeneralError(errorObj.response.data.message || 'An unexpected error occurred.');
            setFieldErrors({}); // Clear field errors
        }
    }
    // Handle other raw error objects (e.g., network errors, non-API errors)
    else {
        setGeneralError(errorObj?.message || 'An unexpected error occurred.');
        setFieldErrors({}); // Clear field errors
    }
  };

  const clearErrors = () => {
    setGeneralError(null);
    setFieldErrors({});
  };

  return { generalError, fieldErrors, handleApiError, clearErrors };
};

----- FILE: src/lib/errors/normalizeApiError.ts -----
export function extractErrorMessages(
  error: unknown,
  messages: string[] = []
): string[] {
  if (!error) return messages;

  if (typeof error === "string") {
    messages.push(error);
    return messages;
  }

  if (Array.isArray(error)) {
    error.forEach(e => extractErrorMessages(e, messages));
    return messages;
  }

  if (typeof error === "object") {
    Object.values(error).forEach(value =>
      extractErrorMessages(value, messages)
    );
  }

  return messages;
}

export function normalizeApiError(err: any): string[] {
  const data = err?.response?.data ?? err;

  if (typeof data?.message === "string") {
    return [data.message];
  }

  if (data?.details) {
    const extracted = extractErrorMessages(data.details);
    if (extracted.length > 0) return extracted;
  }

  return ["Something went wrong. Please try again."];
}


----- FILE: src/lib/airports.ts -----
// src/lib/airports.ts
import { apiClient } from '@/services/apiClient';
import { normalizeApiError } from "@/lib/errors/normalizeApiError";

export interface Airport {
  id: string;
  name: string;
  codename: string;
  map_data: any; 
  is_active: boolean; 
}
export const findNearestAirport = async (
  longitude: number,
  latitude: number
): Promise<Airport[] | null> => {
  try {
    const response = await apiClient.get(`/v1/airports/by-location/?lon=${longitude}&lat=${latitude}`);
    console.log("API Response for airports by location:", response); 
    if (response.data?.data && Array.isArray(response.data.data) && response.data.data.length > 0) {
      return response.data.data; 
    }
    console.log("No airports found near coordinates:", longitude, latitude); 
    return null;
  } catch (err) {
    console.error('Failed to find airport by location:', err);
    throw new Error(normalizeApiError(err)[0]);
  }
};


export const KNOWN_AIRPORTS: Record<string, string> = {
  'Murtala Muhammed Int\'l Airport (LOS)': '0199de42-10b4-7f53-b670-42f107897a1d',

};

----- FILE: src/services/apiClient.ts -----
// src/services/apiClient.ts
import axios, { AxiosRequestConfig } from 'axios';


const apiClient = axios.create({
  baseURL: 'https://api.achrams.com.ng',
  timeout: 10000, 
  headers: {
    'Content-Type': 'application/json',
  },
});


apiClient.interceptors.request.use(
  (config) => {
    const token = typeof window !== 'undefined' ? localStorage.getItem('auth_token') : null;
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
  },
  (error) => {
    return Promise.reject(error);
  }
);


apiClient.interceptors.response.use(
  (response) => response,
  (error) => {
    
    if (error.response?.status === 401) {
      
      if (typeof window !== 'undefined') {
          localStorage.removeItem('auth_token');
      }
    }
    return Promise.reject(error);
  }
);

export default apiClient;

export { apiClient };

