----- FILE: src/hooks/useAuth.ts -----
// src/hooks/useAuth.ts
import { useState, useEffect } from 'react';

const TOKEN_KEY = 'achrams_passenger_token';

export const useAuth = () => {
  const [token, setToken] = useState<string | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const stored = typeof window !== 'undefined' ? localStorage.getItem(TOKEN_KEY) : null;
    if (stored) setToken(stored);
    setLoading(false);
  }, []);

  const login = (newToken: string) => {
    localStorage.setItem(TOKEN_KEY, newToken);
    setToken(newToken);
  };

  const logout = () => {
    localStorage.removeItem(TOKEN_KEY);
    setToken(null);
  };

  return { token, login, logout, isLoading: loading };
};

----- FILE: src/hooks/useGeolocation.ts -----
// // src/hooks/useGeolocation.ts
// import { useState, useEffect } from 'react';

// export interface GeolocationCoordinates {
//   latitude: number;
//   longitude: number;
// }

// export interface GeolocationResult {
//   coords: GeolocationCoordinates | null;
//   error: string | null;
//   loading: boolean;
//   requestPermission: () => Promise<GeolocationCoordinates | null>;
// }

// export const useGeolocation = (): GeolocationResult => {
//   const [coords, setCoords] = useState<GeolocationCoordinates | null>(null);
//   const [error, setError] = useState<string | null>(null);
//   const [loading, setLoading] = useState<boolean>(false);

//   const requestPermission = (): Promise<GeolocationCoordinates | null> => {
//     return new Promise((resolve) => {
//       if (!navigator.geolocation) {
//         setError('Geolocation is not supported by this browser.');
//         resolve(null);
//         return;
//       }

//       setLoading(true);
//       navigator.geolocation.getCurrentPosition(
//         (position) => {
//           const { latitude, longitude } = position.coords;
//           const newCoords = { latitude, longitude };
//           setCoords(newCoords);
//           setError(null);
//           setLoading(false);
//           resolve(newCoords);
//         },
//         (err) => {
//           let message = 'Unable to retrieve your location.';
//           if (err.code === 1) message = 'Location access denied.';
//           else if (err.code === 2) message = 'Location unavailable.';
//           else if (err.code === 3) message = 'Location request timed out.';

//           setError(message);
//           setLoading(false);
//           resolve(null);
//         },
//         {
//           enableHighAccuracy: true,
//           timeout: 10000,
//           maximumAge: 0,
//         }
//       );
//     });
//   };

//   return { coords, error, loading, requestPermission };
// };

// src/hooks/useGeolocation.ts
import { useState, useEffect } from 'react';

export interface GeolocationCoordinates {
  latitude: number;
  longitude: number;
}

export interface GeolocationResult {
  coords: GeolocationCoordinates | null;
  error: string | null;
  loading: boolean; // NEW: Track overall loading state
  requestPermission: () => Promise<GeolocationCoordinates | null>;
}

export const useGeolocation = (): GeolocationResult => {
  const [coords, setCoords] = useState<GeolocationCoordinates | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [loading, setLoading] = useState<boolean>(false); // NEW: Overall loading state

  const requestPermission = (): Promise<GeolocationCoordinates | null> => {
    // NEW: Return a promise that resolves when getCurrentPosition succeeds or rejects on error
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        const errorMsg = 'Geolocation is not supported by this browser.';
        setError(errorMsg);
        setLoading(false); // NEW: Stop loading if unsupported
        reject(errorMsg);
        return;
      }

      // NEW: Set loading state before requesting
      setLoading(true);
      setError(null); // NEW: Clear previous errors
      setCoords(null); // NEW: Clear previous coords

      navigator.geolocation.getCurrentPosition(
        (position) => {
          // NEW: Success callback
          const { latitude, longitude } = position.coords;
          const newCoords = { latitude, longitude };
          setCoords(newCoords);
          setError(null); // Ensure error is cleared on success
          setLoading(false); // NEW: Stop loading on success
          resolve(newCoords); // NEW: Resolve the promise with the coords
        },
        (err) => {
          // NEW: Error callback
          let message = 'Unable to retrieve your location.';
          if (err.code === 1) message = 'Location access denied.';
          else if (err.code === 2) message = 'Location unavailable.';
          else if (err.code === 3) message = 'Location request timed out.';

          setError(message);
          setLoading(false); // NEW: Stop loading on error
          console.error("Geolocation error:", message); // NEW: Log for debugging
          reject(message); // NEW: Reject the promise with the error message
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0,
        }
      );
    });
  };

  // NEW: Provide overall loading state to consumers
  return { coords, error, loading, requestPermission };
};

----- FILE: src/contexts/AuthContext.tsx -----
// src/contexts/AuthContext.tsx
'use client';

import { createContext, useContext, useState, useEffect } from 'react';

type AuthContextType = {
  token: string | null;
  isAuthenticated: boolean;
};

const AuthContext = createContext<AuthContextType>({ token: null, isAuthenticated: false });

export function AuthProvider({ children }: { children: React.ReactNode }) {
  const [token, setToken] = useState<string | null>(null);

  useEffect(() => {
    const stored = typeof window !== 'undefined' ? localStorage.getItem('auth_token') : null;
    setToken(stored);
  }, []);

  return (
    <AuthContext.Provider value={{ token, isAuthenticated: !!token }}>
      {children}
    </AuthContext.Provider>
  );
}

export const useAuth = () => useContext(AuthContext);

----- FILE: src/types/trip.ts -----


----- FILE: src/types/passenger.ts -----
// src/types/passenger.ts

export interface Passenger {
  id: string;
  name: string;
  initials: string;
  email: string;
  first_name: string;
  last_name: string;
  phone_number: string;
  profile_photo?: string;
  is_2fa_enabled: boolean;
  verified_at?: string;
  last_login?: string;
  created_at: string;
  updated_at: string;
  profile: {
    status: { label: string; value: string };
    wallet: {
      balance: {
        formatted: string;
        currency: string;
        amount: number;
      };
    };
    active_trip: Trip | null;
  };
}


export interface PassengerAccount {
  id: string;
  first_name: string;
  last_name: string;
  email: string;
  phone_number: string;
  is_2fa_enabled: boolean;
  profile?: {
    wallet?: {
      balance: {
        formatted: string;
        amount: number;
        currency: string;
      };
    };
  };
}


export interface Trip {
  id: string;
  amount: Money;
  status: Status;
  pickup_address: string;
  destination_address: string;
  verification_code: string;
  rating: Rating | null;
  map_ MapData;
  driver: Driver | null;
  guest?: Guest;
}

export interface Money {
  formatted: string;
  currency: string;
  amount: number;
}

export interface Status {
  label: string;
  value: string;
}

export interface Rating {
  score: number;
  comment: string;
}

export interface MapData {
  pickup_location: GeoFeature;
  destination_location: GeoFeature;
}

export interface GeoFeature {
  type: 'Feature';
  geometry: {
    type: 'Point';
    coordinates: [number, number]; // [longitude, latitude]
  };
  properties: {
    name: string;
    description: string;
  };
}

export interface Driver {
  id: string;
  name: string;
  details: {
    
    car_type: string;
    car_color: string;
    car_photo?: string;
    plate_number: string;
  }
  profile_photo?: string;
  has_extra_leg_room: boolean;
  has_extra_trunk_space: boolean;
  has_wheel_chair_access: boolean;
  rating: string;
}

export interface Guest {
  id: string;
  name: string;
  email: string;
  phone_number: string;
  expires_at: string;
  url: string;
}

export interface AuthResponse {
  token: string;
}

export interface ApiResponse<T = unknown> {
  status: 'success' | 'error';
  message: string;
   T;
}

----- FILE: src/components/ClientProviders.tsx -----
// src/components/ClientProviders.tsx
'use client';

import { AuthProvider } from '@/contexts/AuthContext';
import QueryProvider from './QueryProvider'; // Assume this exists

interface ClientProvidersProps {
  children: React.ReactNode;
}

export default function ClientProviders({ children }: ClientProvidersProps) {
  return (
    <AuthProvider>
      <QueryProvider>
        {children}
      </QueryProvider>
    </AuthProvider>
  );
}

----- FILE: src/components/navigation/BottomNavBar.tsx -----
import React from 'react';
import Link from 'next/link';
import { Home, History, CreditCard, User, Car } from 'lucide-react'; // Added Car for Booking
import { usePathname } from 'next/navigation';

const BottomNavBar: React.FC = () => {
  const pathname = usePathname();

  const navItems = [
    { href: '/', label: 'Home', icon: Home },
    { href: '/booking', label: 'Book', icon: Car }, // Using Car for booking
    { href: '/history', label: 'History', icon: History },
    { href: '/wallet', label: 'Wallet', icon: CreditCard },
    { href: '/profile', label: 'Profile', icon: User },
  ];

  return (
    <nav className="fixed bottom-0 left-0 right-0 bg-achrams-background-primary border-t border-achrams-border p-3 flex justify-around z-10">
      {navItems.map((item) => {
        const IconComponent = item.icon;
        const isActive = pathname === item.href;

        return (
          <Link
            key={item.href}
            href={item.href}
            className={`flex flex-col items-center gap-1 p-2 rounded-lg min-w-[60px] ${
              isActive
                ? 'text-achrams-primary-solid'
                : 'text-achrams-text-secondary'
            }`}
            aria-current={isActive ? 'page' : undefined}
          >
            <IconComponent className="w-6 h-6" />
            <span className="text-xs">{item.label}</span>
          </Link>
        );
      })}
    </nav>
  );
};

export default BottomNavBar;

----- FILE: src/components/layout/BottomNavBar.tsx -----
// src/components/layout/BottomNavBar.tsx
import React from 'react';
import { useRouter } from 'next/navigation';
import { Home, MapPin, User, WalletCards } from 'lucide-react';
import { twMerge } from 'tailwind-merge';

interface BottomNavBarProps {
  activeTab: 'home' | 'book' | 'profile' | 'wallet'; // Define active tab prop
}

const BottomNavBar: React.FC<BottomNavBarProps> = ({ activeTab }) => {
  const router = useRouter();

  const navItems = [
    { id: 'home', icon: Home, label: 'Home', path: '/' },
    { id: 'book', icon: MapPin, label: 'Book', path: '/booking/details' },
    { id: 'wallet', icon: WalletCards, label: 'Wallet', path: '/wallet' },
    { id: 'profile', icon: User, label: 'Profile', path: '/profile' },
  ];

  return (
    <div className="fixed bottom-0 left-1/2 transform -translate-x-1/2 w-full max-w-md bg-achrams-background-primary border-t border-achrams-border py-2 px-4 flex justify-around items-center z-20">
      {navItems.map((item) => (
        <button
          key={item.id}
          onClick={() => router.push(item.path)}
          className={twMerge(
            'flex flex-col items-center gap-1 p-2 rounded-lg transition-colors w-full',
            activeTab === item.id
              ? 'text-achrams-primary-solid' // Active tab color
              : 'text-achrams-text-secondary hover:text-achrams-text-primary' // Inactive tab color
          )}
          aria-label={item.label}
        >
          <item.icon className="w-6 h-6" />
          <span className="text-xs font-medium">{item.label}</span>
        </button>
      ))}
    </div>
  );
};

export default BottomNavBar;

----- FILE: src/components/ui/Input.tsx -----
// src/components/ui/Input.tsx
import { InputHTMLAttributes } from 'react';
import { twMerge } from 'tailwind-merge';

interface InputProps extends InputHTMLAttributes<HTMLInputElement> {
  label?: string;
  error?: string;
  icon?: React.ReactNode;
}

const Input: React.FC<InputProps> = ({
  label,
  error,
  icon,
  className,
  ...props
}) => {
  const containerClasses = twMerge(
    'w-full',
    className
  );

  const inputClasses = twMerge(
    'w-full pl-10 pr-4 py-3 bg-achrams-background-card rounded-xl border border-achrams-border focus:outline-none focus:ring-2 focus:ring-achrams-primary-solid',
    error ? 'border-red-500 focus:ring-red-500' : '',
    icon ? 'pl-10' : 'pl-4'
  );

  return (
    <div className={containerClasses}>
      {label && <label className="block text-sm font-medium text-achrams-text-primary mb-1">{label}</label>}
      <div className="relative">
        {icon && <div className="absolute left-3 top-1/2 transform -translate-y-1/2 text-achrams-text-secondary">{icon}</div>}
        <input
          className={inputClasses}
          {...props}
        />
      </div>
      {error && <p className="mt-1 text-sm text-red-600">{error}</p>}
    </div>
  );
};

export default Input;

----- FILE: src/components/ui/OTPInput.tsx -----
// src/components/ui/OTPInput.tsx
import React, { useState, useRef, useEffect } from 'react';
import { twMerge } from 'tailwind-merge';

interface OTPInputProps {
  length?: number;
  onChange: (otp: string) => void;
  onComplete?: (otp: string) => void;
  autoFocus?: boolean;
  containerClassName?: string;
  inputClassName?: string;
  error?: string; // Add error prop
}

const OTPInput: React.FC<OTPInputProps> = ({
  length = 5,
  onChange,
  onComplete,
  autoFocus = true,
  containerClassName,
  inputClassName,
  error,
}) => {
  const [otp, setOtp] = useState<string[]>(Array(length).fill(''));
  const inputRefs = useRef<Array<HTMLInputElement | null>>([]);

  useEffect(() => {
    if (autoFocus && inputRefs.current[0]) {
      inputRefs.current[0]?.focus();
    }
  }, [autoFocus]);

  const handleChange = (index: number, value: string) => {
    if (/^\d*$/.test(value) && value.length <= 1) {
      const newOtp = [...otp];
      newOtp[index] = value;
      setOtp(newOtp);

      onChange(newOtp.join(''));

      // Auto-focus next input
      if (value && index < length - 1) {
        inputRefs.current[index + 1]?.focus();
      }

      // Auto-submit if all filled
      const allFilled = newOtp.every(digit => digit !== '');
      if (allFilled && newOtp.join('').length === length) {
        onComplete?.(newOtp.join(''));
      }
    }
  };

  const handleKeyDown = (index: number, e: React.KeyboardEvent<HTMLInputElement>) => {
    // Allow backspace to clear current and move to previous
    if (e.key === 'Backspace' && !otp[index] && index > 0) {
      inputRefs.current[index - 1]?.focus();
    }
  };

  const containerClasses = twMerge(
    'flex gap-3 justify-center bg-achrams-secondary-solid/50 ',
    containerClassName
  );

  const inputClasses = twMerge(
    'w-14 h-14 text-center text-2xl font-bold border-2 border-achrams-border rounded-xl focus:outline-none focus:ring-2 focus:ring-achrams-primary-solid bg-achrams-background-card',
    error ? 'border-red-500 focus:ring-red-500' : 'focus:border-achrams-primary-solid',
    inputClassName
  );

  return (
    <div className={containerClasses}>
      {otp.map((digit, index) => (
        <input
          key={index}
          ref={(el) => (inputRefs.current[index] = el)}
          type="text"
          inputMode="numeric"
          maxLength={1}
          value={digit}
          onChange={(e) => handleChange(index, e.target.value)}
          onKeyDown={(e) => handleKeyDown(index, e)}
          className={inputClasses}
        />
      ))}
      {error && <p className="mt-2 text-sm text-red-600 w-full text-center">{error}</p>}
    </div>
  );
};

export default OTPInput;

----- FILE: src/components/ui/ACHRAMSHeader.tsx -----
import React from 'react';
import { X } from 'lucide-react';
import { twMerge } from 'tailwind-merge';
import Image from "next/image"

interface ACHRAMSHeaderProps {
  title: string;
  showBackButton?: boolean;
  onBackClick?: () => void;
  showLogo?: boolean; // New prop to control logo visibility
  className?: string;
}

const ACHRAMSHeader: React.FC<ACHRAMSHeaderProps> = ({
  title,
  showBackButton = false,
  onBackClick,
  showLogo = true, // Default to true to maintain existing behavior on other screens
  className = "",
}) => {
  return (
    <div
      className={twMerge(
        " text-achrams-text-light  flex items-center gap-4 ",
        className
      )}
    >
      {/* Conditionally render the Logo Container */}
      {showLogo && (<>
        <div className="max-w-7xl mx-auto">
  <div className="flex items-center h-20 space-x-3">
    {/* Logo Box */}
    <div className="w-12 h-12 bg-achrams-gradient-primary rounded-xl flex items-center justify-center shadow-lg">
      <Image
        src="/images/logo.png"
        alt="ACHRAMS Logo"
        width={25}
        height={25}
        className="object-contain"
      />
    </div>

    {/* Title + Subtitle */}
    <div className="text-left flex flex-col items-start">
      <h1 className="text-2xl font-bold text-white ">
        ACHRAMS
      </h1>
      {/* text-achrams-primary-solid */}
      <p className="text-xs text-gray-300">
        Official Airport Car Hire
      </p>
    </div>
  </div>
</div>


      
      </>
      )}

      {showBackButton && (
        <button
          onClick={onBackClick}
          aria-label="Go back"
          className="p-1" // Add padding for touch target size
        >
          <X className="w-6 h-6" />
        </button>
      )}
      <h2 className="text-lg font-bold flex-1 text-center">
        {title}
      </h2>
    </div>
  );
};

export default ACHRAMSHeader;

----- FILE: src/components/ui/Button.tsx -----
// src/components/ui/Button.tsx
import { ButtonHTMLAttributes } from 'react';
import { twMerge } from 'tailwind-merge';

interface ButtonProps extends ButtonHTMLAttributes<HTMLButtonElement> {
  variant?: 'primary' | 'secondary' | 'outline' | 'ghost';
  size?: 'sm' | 'md' | 'lg';
  isLoading?: boolean;
}

const Button: React.FC<ButtonProps> = ({
  children,
  className,
  variant = 'primary',
  size = 'md',
  isLoading = false,
  disabled,
  ...props
}) => {
  const baseClasses = 'font-semibold rounded-xl transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2';
  const sizeClasses = {
    sm: 'text-xs py-2 px-4',
    md: 'text-sm py-3 px-6',
    lg: 'text-base py-4 px-8',
  };
  const variantClasses = {
    primary: 'bg-achrams-gradient-primary text-achrams-text-light hover:opacity-90 focus:ring-achrams-primary-solid',
    secondary: 'bg-achrams-secondary-solid text-achrams-text-light hover:bg-opacity-90 focus:ring-achrams-secondary-solid',
    outline: 'border border-achrams-border text-achrams-text-primary bg-transparent hover:bg-achrams-background-secondary focus:ring-achrams-border',
    ghost: 'text-achrams-text-primary hover:bg-achrams-background-secondary focus:ring-achrams-border',
  };

  const disabledClasses = disabled || isLoading ? 'opacity-60 cursor-not-allowed' : '';

  const classes = twMerge(
    baseClasses,
    sizeClasses[size],
    variantClasses[variant],
    disabledClasses,
    className
  );

  return (
    <button
      className={classes}
      disabled={disabled || isLoading}
      {...props}
    >
      {isLoading ? (
        <span className="flex items-center justify-center">
          <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-current" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          Loading...
        </span>
      ) : (
        children
      )}
    </button>
  );
};

export default Button;

----- FILE: src/components/QueryProvider.tsx -----
// src/components/QueryProvider.tsx
"use client"; // This marks the entire file as a Client Component

import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import { ReactNode, useState } from "react";

const QueryProvider = ({ children }: { children: ReactNode }) => {
  // Use useState to create the QueryClient instance only on the client side
  const [queryClient] = useState(
    () =>
      new QueryClient({
        defaultOptions: {
          queries: {
            staleTime: 5 * 60 * 1000, // 5 minutes
          },
        },
      })
  );

  return (
    <QueryClientProvider client={queryClient}>
      {children}
    </QueryClientProvider>
  );
};

export default QueryProvider;

----- FILE: src/components/icons/GoogleColor.tsx -----
export default function GoogleIconColor({ size = 24 }) {
  return (
    <svg
      width={size}
      height={size}
      viewBox="0 0 533.5 544.3"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path fill="#4285F4" d="M533.5 278.4c0-18.6-1.5-37.3-4.8-55.6H272v105.2h147.7c-6.4 35.6-26.1 65.7-55.3 85.9l89.3 69.2c52-48 82-118.6 82-204.7z"/>
      <path fill="#34A853" d="M272 544.3c74.7 0 137.4-24.7 183.1-67.2l-89.3-69.2c-24.8 16.8-56.6 26.6-93.8 26.6-72.2 0-133.4-48.8-155.3-114.2H25.8v71.9c45.8 90.8 139.3 152.1 246.2 152.1z"/>
      <path fill="#FBBC05" d="M116.7 320.3c-5.8-17.3-9-35.7-9-54.3s3.2-37 9-54.3V139.8H25.8C9.3 174.6 0 214.4 0 266c0 51.6 9.3 91.4 25.8 126.2l90.9-71.9z"/>
      <path fill="#EA4335" d="M272 107.1c40.7 0 77.3 14 106 41.4l79.3-79.3C409.3 24.7 346.6 0 272 0 165.1 0 71.6 61.3 25.8 152.1l90.9 71.9C138.6 155.9 199.8 107.1 272 107.1z"/>
    </svg>
  );
}


----- FILE: src/components/app/modals/UpdateProfileModal.tsx -----
// src/components/app/modals/UpdateProfileModal.tsx
import { X, User, Mail, Phone, Globe, Loader } from 'lucide-react';
import { useState, useEffect } from 'react';
import { apiClient } from '@/services/apiClient'; // Assuming you create this service

interface UpdateProfileModalProps {
  isOpen: boolean;
  initialData: { name: string; email: string; phone: string; preferred_language: string }; // NEW: Pass initial data
  onClose: () => void;
  onSuccess: (updatedData: any) => void; // NEW: Callback after successful update
}

export default function UpdateProfileModal({
  isOpen,
  initialData,
  onClose,
  onSuccess,
}: UpdateProfileModalProps) {
  if (!isOpen) return null;

  // NEW: State for form data, loading, error
  const [formData, setFormData] = useState(initialData); // NEW: Initialize with initial data
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  // NEW: Reset form when initialData changes (e.g., if modal is reused)
  useEffect(() => {
    if (isOpen) {
        setFormData(initialData);
        setError('');
    }
  }, [initialData, isOpen]);


  const handleChange = (field: keyof typeof formData, value: string) => {
    setFormData(prev => ({ ...prev, [field]: value }));
  };

  const handleSubmit = async () => {
    setError(''); // Clear previous errors
    // Basic validation can be added here if needed

    setLoading(true);
    try {
      // NEW: Call the update profile API using apiClient
      // Use PATCH /auth/passenger/me as per Postman doc
      const response = await apiClient.patch('/auth/passenger/me', formData);

      console.log("Profile Update Response:", response); // Debug log
      if (response.status === 200 && response.data && response.data.data) { // Assuming 200 for success
        // NEW: On success, close modal and trigger success handler with updated data
        onClose();
        onSuccess(response.data.data); // Pass the updated user data back
      } else {
          setError('Failed to update profile. Please try again.');
      }
    } catch (err: any) {
        console.error("Profile Update Error:", err);
        let errorMessage = 'An unexpected error occurred.';
        if (err.response && err.response.data && err.response.data.message) {
            errorMessage = err.response.data.message;
        } else if (err.message) {
            errorMessage = err.message;
        }
        setError(errorMessage);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-achrams-bg-primary bg-opacity-70 flex items-end z-50">
      <div className="bg-achrams-bg-primary w-full rounded-t-3xl p-6 animate-slideUp max-h-[85vh] overflow-y-auto border-t border-achrams-border">
        <div className="flex justify-between items-center mb-6">
          <h3 className="text-xl font-bold text-achrams-text-primary">Edit Profile</h3>
          <button
            onClick={onClose}
            disabled={loading} // NEW: Disable close button while loading
            className="text-achrams-text-secondary hover:text-achrams-text-primary transition-colors disabled:opacity-50"
          >
            <X className="w-6 h-6" />
          </button>
        </div>

        <div className="space-y-4 mb-6">
          <div className="relative">
            <User className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-achrams-text-secondary" />
            <input
              type="text"
              placeholder="Full name"
              value={formData.name}
              onChange={(e) => handleChange('name', e.target.value)}
              disabled={loading} // NEW: Disable input while loading
              className="w-full pl-10 pr-4 py-4 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border border-achrams-border"
            />
          </div>
          <div className="relative">
            <Mail className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-achrams-text-secondary" />
            <input
              type="email"
              placeholder="Email"
              value={formData.email}
              onChange={(e) => handleChange('email', e.target.value)}
              disabled={loading} // NEW: Disable input while loading
              className="w-full pl-10 pr-4 py-4 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border border-achrams-border"
            />
          </div>
          <div className="relative">
            <Phone className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-achrams-text-secondary" />
            <input
              type="tel"
              placeholder="Phone number"
              value={formData.phone}
              onChange={(e) => handleChange('phone', e.target.value)} // NEW: Handle phone change
              disabled={loading} // NEW: Disable input while loading
              className="w-full pl-10 pr-4 py-4 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border border-achrams-border"
            />
          </div>
          <div className="relative">
            <Globe className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-achrams-text-secondary" />
            <select // NEW: Use select for language
              value={formData.preferred_language}
              onChange={(e) => handleChange('preferred_language', e.target.value)}
              disabled={loading} // NEW: Disable input while loading
              className="w-full pl-10 pr-4 py-4 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border border-achrams-border appearance-none"
            >
              <option value="en">English</option>
              <option value="es">Spanish</option>
              <option value="fr">French</option>
              {/* Add more options as needed based on API support */}
            </select>
          </div>
        </div>

        {/* NEW: Error Message Display */}
        {error && (
          <p className="text-red-500 text-sm mb-4">{error}</p>
        )}

        <button
          onClick={handleSubmit}
          disabled={loading} // NEW: Disable based on loading
          className={`w-full py-4 rounded-xl font-semibold mb-3 transition-all ${
            loading
              ? 'bg-achrams-secondary-solid text-achrams-text-light opacity-75 cursor-not-allowed'
              : 'bg-achrams-gradient-primary text-achrams-text-light hover:opacity-90 active:scale-[0.98]'
          }`}
        >
          {loading ? ( // NEW: Show spinner while loading
            <div className="flex items-center justify-center">
              <Loader className="w-5 h-5 animate-spin mr-2" />
              Saving...
            </div>
          ) : (
            'Save Changes'
          )}
        </button>

        <button
          onClick={onClose}
          disabled={loading} // NEW: Disable "Cancel" while loading
          className="w-full text-achrams-text-secondary font-medium hover:text-achrams-text-primary transition-colors disabled:opacity-50"
        >
          Cancel
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/ProfileModal.tsx -----
// src/components/app/modals/ProfileModal.tsx
import { X, Phone, Mail, Star, Shield, ChevronRight } from 'lucide-react';
import { PassengerAccount } from '@/types/passenger'; // You can define this type

interface ProfileModalProps {
  isOpen: boolean;
  onClose: () => void;
  passenger: PassengerAccount | null;
  onLogout: () => void;
}

export default function ProfileModal({
  isOpen,
  onClose,
  passenger,
  onLogout,
}: ProfileModalProps) {
  if (!isOpen || !passenger) return null;

  const initials = `${passenger.first_name.charAt(0)}${passenger.last_name.charAt(0)}`.toUpperCase();

  return (
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 flex items-end z-50 animate-fadeIn">
      <div className="bg-white w-full rounded-t-3xl animate-slideUp max-h-[90vh] overflow-y-auto">
        <div className="bg-achrams-primary-solid text-white px-6 py-8">
          <button onClick={onClose} className="mb-6">
            <X className="w-6 h-6" />
          </button>
          <div className="flex items-center gap-4">
            <div className="w-20 h-20 bg-gradient-to-br from-emerald-400 to-teal-500 rounded-full flex items-center justify-center text-2xl font-bold shadow-lg">
              {initials}
            </div>
            <div>
              <h3 className="text-2xl font-bold mb-1">
                {passenger.first_name} {passenger.last_name}
              </h3>
              {passenger.is_2fa_enabled && (
                <div className="flex items-center gap-1 text-xs text-green-200">
                  <Shield className="w-4 h-4" />
                  <span>2FA enabled</span>
                </div>
              )}
            </div>
          </div>
        </div>

        <div className="px-6 py-6 space-y-6">
          {/* Contact Info */}
          <div>
            <h4 className="font-bold mb-4 text-gray-800">Contact information</h4>
            <div className="space-y-3">
              <div className="flex items-center gap-3 p-4 bg-gray-50 rounded-xl">
                <Phone className="w-5 h-5 text-gray-600" />
                <div>
                  <div className="text-xs text-gray-500 mb-1">Phone</div>
                  <div className="font-medium">{passenger.phone_number}</div>
                </div>
              </div>
              <div className="flex items-center gap-3 p-4 bg-gray-50 rounded-xl">
                <Mail className="w-5 h-5 text-gray-600" />
                <div>
                  <div className="text-xs text-gray-500 mb-1">Email</div>
                  <div className="font-medium">{passenger.email}</div>
                </div>
              </div>
            </div>
          </div>

          {/* Account Stats */}
          {passenger.profile?.wallet && (
            <div>
              <h4 className="font-bold mb-4 text-gray-800">Wallet</h4>
              <div className="p-4 bg-gray-50 rounded-xl">
                <div className="text-lg font-bold">
                  {passenger.profile.wallet.balance.formatted}
                </div>
              </div>
            </div>
          )}

          {/* Settings & Support */}
          <div>
            <h4 className="font-bold mb-4 text-gray-800">Account</h4>
            <div className="space-y-2">
              <button className="w-full flex items-center justify-between p-4 bg-gray-50 rounded-xl hover:bg-gray-100">
                <span>Security & 2FA</span>
                <ChevronRight className="w-5 h-5 text-gray-500" />
              </button>
              <button className="w-full flex items-center justify-between p-4 bg-gray-50 rounded-xl hover:bg-gray-100">
                <span>Payment methods</span>
                <ChevronRight className="w-5 h-5 text-gray-500" />
              </button>
              <button className="w-full flex items-center justify-between p-4 bg-gray-50 rounded-xl hover:bg-gray-100">
                <span>Trip history</span>
                <ChevronRight className="w-5 h-5 text-gray-500" />
              </button>
            </div>
          </div>

          <button
            onClick={onLogout}
            className="w-full py-4 text-center text-red-600 font-medium hover:bg-red-50 rounded-xl"
          >
            Log out
          </button>
          <div className="h-4"></div>
        </div>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/LocationPermissionModal.tsx -----
// src/components/app/modals/LocationPermissionModal.tsx
import { X } from 'lucide-react';

interface LocationPermissionModalProps {
  isOpen: boolean;
  onClose: () => void;
  onGrantAccess: () => void; // Function to trigger browser permission request
}

export default function LocationPermissionModal({
  isOpen,
  onClose,
  onGrantAccess,
}: LocationPermissionModalProps) {
  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 bg-opacity-70 flex items-end z-100">
      <div className="bg-white w-full rounded-t-3xl p-6 animate-slideUp max-h-[85vh] overflow-y-auto border-t border-achrams-border">
        <div className="flex justify-between items-center mb-6">
          <h3 className="text-xl font-bold text-achrams-text-primary">Location Access Required</h3>
          <button
            onClick={onClose}
            className="text-achrams-text-secondary hover:text-achrams-text-primary transition-colors"
          >
            <X className="w-6 h-6" />
          </button>
        </div>
        <div className="flex flex-col items-center gap-4 mb-6">
          <p className="text-center text-achrams-text-secondary">
            This app requires your location access to work. Please grant access to find nearby pickup locations.
          </p>
        </div>
        <button
          onClick={() => {
            onGrantAccess(); // Trigger the geolocation permission request
            onClose(); // Close the modal after triggering
          }}
          className={`w-full py-4 rounded-xl font-semibold transition-all bg-achrams-gradient-primary text-achrams-text-light hover:opacity-90 active:scale-[0.98]`}
        >
          Grant Access
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/PassengerDetailsModal.tsx -----
// src/components/app/modals/PassengerDetailsModal.tsx
import { X, Package, Users, Accessibility } from 'lucide-react'; // Added Wheelchair icon
import { useState } from 'react';

interface PassengerDetailsModalProps {
  isOpen: boolean;
  onClose: () => void;
  passengerData: { name: string; phone: string; email: string };
  setPassengerData: (data: any) => void;
  requirements: { luggage: boolean; wheelchair: boolean; elderly: boolean };
  setRequirements: (req: any) => void;
  onRequestRide: () => void;

  isLoading? : boolean;

}

export default function PassengerDetailsModal({
  isOpen,
  onClose,
  passengerData,
  setPassengerData,
  requirements,
  setRequirements,
  onRequestRide,
  isLoading,
}: PassengerDetailsModalProps) {
  const [showRequirements, setShowRequirements] = useState(false);

  if (!isOpen) return null;

  return (
    // Fixed background: use bg-achrams-bg-primary with opacity
    // Ensure it covers the whole screen behind the modal
    <div className=" fixed inset-0 bg-achrams-secondary-solid/50 flex items-end z-50"> 
      {/* The modal content */}
      <div className="bg-white w-full rounded-t-3xl p-6 animate-slideUp max-h-[85vh] overflow-y-auto border-t border-achrams-border">
        <div className="flex justify-between items-center mb-6">
          <h3 className="text-xl font-bold text-achrams-text-primary">Passenger details</h3>
          <button 
            onClick={onClose}
            className="text-achrams-text-secondary hover:text-achrams-text-primary transition-colors"
          >
            <X className="w-6 h-6" />
          </button>
        </div>
        <div className="space-y-4 mb-6">
          <input
            type="text"
            placeholder="Full name"
            value={passengerData.name}
            onChange={(e) => setPassengerData({ ...passengerData, name: e.target.value })}
            // Apply ACHRAMS styling to input
            className="w-full px-4 py-4 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border border-achrams-border"
          />
          <input
            type="tel"
            placeholder="Phone number"
            value={passengerData.phone}
            onChange={(e) => setPassengerData({ ...passengerData, phone: e.target.value })}
            // Apply ACHRAMS styling to input
            className="w-full px-4 py-4 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border border-achrams-border"
          />
          <input
            type="email"
            placeholder="Email address"
            value={passengerData.email}
            onChange={(e) => setPassengerData({ ...passengerData, email: e.target.value })}
            // Apply ACHRAMS styling to input
            className="w-full px-4 py-4 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border border-achrams-border"
          />
        </div>
        <button
          onClick={() => setShowRequirements(!showRequirements)}
          // Apply ACHRAMS styling to button
          className="w-full flex items-center justify-between py-4 border-t border-b border-achrams-border text-achrams-text-primary hover:bg-achrams-bg-secondary transition-colors"
        >
          <span className="font-medium">Special requirements</span>
          {/* Use ChevronDown/Up instead of X for consistency */}
          {showRequirements ? <X className="w-5 h-5" /> : <span className="text-achrams-text-secondary">+ Add</span>}
        </button>
        {showRequirements && (
          <div className="space-y-3 py-4">
            <label className="flex items-center gap-3 p-3 bg-achrams-bg-secondary rounded-xl cursor-pointer border border-achrams-border">
              <input
                type="checkbox"
                checked={requirements.luggage}
                onChange={(e) => setRequirements({ ...requirements, luggage: e.target.checked })}
                className="w-5 h-5 text-achrams-primary-solid rounded focus:ring-achrams-primary-solid focus:ring-offset-0"
              />
              <Package className="w-5 h-5 text-achrams-text-secondary flex-shrink-0" />
              <span className="text-achrams-text-primary">Extra luggage</span>
            </label>
            <label className="flex items-center gap-3 p-3 bg-achrams-bg-secondary rounded-xl cursor-pointer border border-achrams-border">
              <input
                type="checkbox"
                checked={requirements.wheelchair}
                onChange={(e) => setRequirements({ ...requirements, wheelchair: e.target.checked })}
                className="w-5 h-5 text-achrams-primary-solid rounded focus:ring-achrams-primary-solid focus:ring-offset-0"
              />
              {/* Replaced emoji with Wheelchair icon */}
              <Accessibility className="w-5 h-5 text-achrams-text-secondary flex-shrink-0" />
              <span className="text-achrams-text-primary">Wheelchair accessible</span>
            </label>
            <label className="flex items-center gap-3 p-3 bg-achrams-bg-secondary rounded-xl cursor-pointer border border-achrams-border">
              <input
                type="checkbox"
                checked={requirements.elderly}
                onChange={(e) => setRequirements({ ...requirements, elderly: e.target.checked })}
                className="w-5 h-5 text-achrams-primary-solid rounded focus:ring-achrams-primary-solid focus:ring-offset-0"
              />
              <Users className="w-5 h-5 text-achrams-text-secondary flex-shrink-0" />
              <span className="text-achrams-text-primary">Elderly passenger</span>
            </label>
          </div>
        )}
        <button
          onClick={onRequestRide}
          disabled={!passengerData.name || !passengerData.phone || !passengerData.email}
          // Apply ACHRAMS gradient button styling
          className={`w-full py-4 rounded-xl font-semibold mt-6 transition-all ${
            passengerData.name && passengerData.phone && passengerData.email
              ? 'bg-achrams-gradient-primary text-achrams-text-light hover:opacity-90 active:scale-[0.98]' // Enabled state
              : 'bg-achrams-secondary-solid text-achrams-text-light opacity-75 cursor-not-allowed' // Disabled state
          }`}
        >
          {isLoading ? 'Requesting...': 'Request a ride'}
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/Enable2FAModal.tsx -----
// src/components/app/modals/Enable2FAModal.tsx
import { X, QrCode, Loader } from 'lucide-react';
import { useState, useEffect } from 'react';
import { apiClient } from '@/services/apiClient'; // Assuming you create this service

interface Enable2FAModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSuccess: () => void; // NEW: Callback after successful enablement
}

export default function Enable2FAModal({
  isOpen,
  onClose,
  onSuccess,
}: Enable2FAModalProps) {
  if (!isOpen) return null;

  // NEW: State for QR code data, OTP input, loading, error
  const [qrDataUrl, setQrDataUrl] = useState<string | null>(null);
  const [secret, setSecret] = useState<string | null>(null); // NEW: Store secret if needed for manual entry
  const [otp, setOtp] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);
  const [loadingSetup, setLoadingSetup] = useState(true); // NEW: Loading for initial setup

  // NEW: Fetch QR code and secret on modal open
  useEffect(() => {
    if (isOpen) {
      const fetchSetupData = async () => {
        setLoadingSetup(true);
        setError('');
        try {
          const response = await apiClient.post('/auth/passenger/2fa/setup'); // Use correct endpoint from Postman
          if (response.status === 200 && response.data && response.data.data) {
            setQrDataUrl(response.data.data.qr_code_url); // Adjust based on actual API response structure
            setSecret(response.data.data.secret); // Adjust based on actual API response structure
          } else {
            setError('Failed to get setup data. Please try again.');
          }
        } catch (err) {
          console.error("2FA Setup Error:", err);
          let errorMessage = 'An unexpected error occurred.';
          if (err instanceof Error) {
            errorMessage = err.message;
          }
          setError(errorMessage);
        } finally {
          setLoadingSetup(false);
        }
      };

      fetchSetupData();
    } else {
        // NEW: Reset state when modal closes
        setQrDataUrl(null);
        setSecret(null);
        setOtp('');
        setError('');
        setLoading(false);
        setLoadingSetup(false);
    }
  }, [isOpen]);


  const handleEnable = async () => {
    setError(''); // Clear previous errors
    if (!otp) {
      setError('Please enter the OTP from your authenticator app.');
      return;
    }

    setLoading(true);
    try {
      // NEW: Call the enable API using apiClient
      const response = await apiClient.post('/auth/passenger/2fa/enable', { // Use correct endpoint from Postman
        token: otp, // Or 'otp' depending on API expectation
      });

      console.log("2FA Enable Response:", response); // Debug log
      if (response.status === 200) { // Assuming 200 for success
        // NEW: On success, close modal and trigger success handler (e.g., update profile info in parent)
        onClose();
        onSuccess();
      } else {
          setError('Failed to enable 2FA. Please check the code and try again.');
      }
    } catch (err: any) {
        console.error("2FA Enable Error:", err);
        let errorMessage = 'An unexpected error occurred.';
        if (err.response && err.response.data && err.response.data.message) {
            errorMessage = err.response.data.message;
        } else if (err.message) {
            errorMessage = err.message;
        }
        setError(errorMessage);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-achrams-bg-primary bg-opacity-70 flex items-end z-50">
      <div className="bg-achrams-bg-primary w-full rounded-t-3xl p-6 animate-slideUp max-h-[85vh] overflow-y-auto border-t border-achrams-border">
        <div className="flex justify-between items-center mb-6">
          <h3 className="text-xl font-bold text-achrams-text-primary">Enable Two-Factor Authentication</h3>
          <button
            onClick={onClose}
            disabled={loading} // NEW: Disable close button while loading
            className="text-achrams-text-secondary hover:text-achrams-text-primary transition-colors disabled:opacity-50"
          >
            <X className="w-6 h-6" />
          </button>
        </div>

        {loadingSetup ? (
          <div className="flex flex-col items-center justify-center py-8">
            <Loader className="w-8 h-8 animate-spin text-achrams-primary-solid mb-4" />
            <p className="text-achrams-text-secondary">Setting up...</p>
          </div>
        ) : (
          <>
            <p className="text-achrams-text-secondary mb-6">
              Scan the QR code below with your authenticator app (like Google Authenticator or Authy) to link your account.
            </p>

            {qrDataUrl ? (
              <div className="flex flex-col items-center mb-6">
                <img src={qrDataUrl} alt="2FA QR Code" className="w-48 h-48 bg-achrams-bg-secondary p-4 rounded-lg border border-achrams-border" />
                {secret && (
                  <p className="text-xs text-achrams-text-tertiary mt-2">
                    Secret: <span className="font-mono">{secret}</span> (For manual entry if QR scan fails)
                  </p>
                )}
              </div>
            ) : (
              <p className="text-red-500 text-sm text-center mb-6">Failed to load QR code.</p>
            )}

            <input
              type="text"
              placeholder="Enter 6-digit code from app"
              value={otp}
              onChange={(e) => setOtp(e.target.value.replace(/\D/g, '').slice(0, 6))} // NEW: Allow only digits, max 6
              disabled={loading} // NEW: Disable input while loading
              className="w-full px-4 py-4 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border border-achrams-border mb-4"
            />

            {/* NEW: Error Message Display */}
            {error && (
              <p className="text-red-500 text-sm mb-4">{error}</p>
            )}

            <button
              onClick={handleEnable}
              disabled={loading || !otp} // NEW: Disable based on loading and OTP field
              className={`w-full py-4 rounded-xl font-semibold mb-3 transition-all ${
                loading || !otp
                  ? 'bg-achrams-secondary-solid text-achrams-text-light opacity-75 cursor-not-allowed'
                  : 'bg-achrams-gradient-primary text-achrams-text-light hover:opacity-90 active:scale-[0.98]'
              }`}
            >
              {loading ? ( // NEW: Show spinner while loading
                <div className="flex items-center justify-center">
                  <Loader className="w-5 h-5 animate-spin mr-2" />
                  Enabling...
                </div>
              ) : (
                'Enable 2FA'
              )}
            </button>
          </>
        )}

        <button
          onClick={onClose}
          disabled={loading} // NEW: Disable "Cancel" while loading
          className="w-full text-achrams-text-secondary font-medium hover:text-achrams-text-primary transition-colors disabled:opacity-50"
        >
          Cancel
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/PanicModal.tsx -----
// src/components/app/modals/PanicModal.tsx
import { AlertCircle, X, Check } from 'lucide-react';
import { useState } from 'react';

const panicOptions = [
  'Driver is behaving suspiciously',
  'Taking wrong route',
  'Uncomfortable with driver behavior',
  'Vehicle condition is unsafe',
  'Other emergency',
];

export default function PanicModal({
  isOpen,
  onClose,
  onComplete,
}: {
  isOpen: boolean;
  onClose: () => void;
  onComplete: () => void;
}) {
  const [selected, setSelected] = useState<string | null>(null);
  const [sent, setSent] = useState(false);

  if (!isOpen) return null;

  const handleSubmit = () => {
    if (selected) {
      setSent(true);
      setTimeout(() => {
        setSent(false);
        onComplete();
        onClose();
      }, 2000);
    }
  };

  if (sent) {
    return (
      <div className="fixed inset-0 bg-achrams-secondary-solid/50 flex items-end z-50 animate-fadeIn">
        <div className="bg-white w-full rounded-t-3xl p-6 animate-slideUp text-center">
          <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <Check className="w-8 h-8 text-green-600" />
          </div>
          <h3 className="text-xl font-bold mb-2">Alert Sent</h3>
          <p className="text-gray-600">Your message has been received and someone is looking into it.</p>
        </div>
      </div>
    );
  }

  return (
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 bg-opacity-50 flex items-end z-50 animate-fadeIn">
      <div className="bg-white w-full rounded-t-3xl p-6 animate-slideUp">
        <div className="flex items-center justify-between mb-6">
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
              <AlertCircle className="w-6 h-6 text-red-600" />
            </div>
            <h3 className="text-xl font-bold">Safety Alert</h3>
          </div>
          <button onClick={onClose}>
            <X className="w-6 h-6" />
          </button>
        </div>
        <p className="text-gray-600 mb-6">Select an issue to quickly send an alert</p>
        <div className="space-y-3">
          {panicOptions.map((option, idx) => (
            <button
              key={idx}
              onClick={() => setSelected(option)}
              className={`w-full text-left px-4 py-4 rounded-xl transition-all ${
                selected === option ? 'bg-red-50 border border-red-200' : 'bg-gray-50 hover:bg-gray-100'
              }`}
            >
              {option}
            </button>
          ))}
        </div>
        <button
          onClick={handleSubmit}
          disabled={!selected}
          className="w-full mt-6 py-4 bg-red-600 text-white rounded-xl font-semibold disabled:bg-gray-300"
        >
          Send Alert
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/RateModal.tsx -----
// src/components/app/modals/RateModal.tsx
import { X, Star, Check } from 'lucide-react';
import { useState } from 'react';

interface RateModalProps {
  isOpen: boolean;
  onClose: () => void;
  onRate: (score: number, comment: string) => void;
  driverName?: string;
  // NEW: Prop to update the parent's notification state
  setNotification: (notification: { message: string; type: 'info' | 'success' | 'warning' | 'error' } | null) => void;
}

export default function RateModal({
  isOpen,
  onClose,
  onRate,
  driverName = 'your driver',
  setNotification, // NEW: Destructure the new prop
}: RateModalProps) {
  const [rating, setRating] = useState(0);
  const [comment, setComment] = useState('');

  const handleSubmit = () => {
    if (rating > 0) {
      // NEW: Call the API/rate handling function passed from parent (e.g., page.tsx)
      onRate(rating, comment);

      // NEW: Close the modal
      onClose();

      // NEW: Set the success notification in the parent component via the prop
      setNotification({
        message: 'Thank you for your feedback!',
        type: 'success'
      });

      // NEW: Optionally, reset local state after submission
      // setRating(0); // Resetting rating might be confusing if the API call fails, so leaving it as is for now
      // setComment('');
    }
  };

  if (!isOpen) return null;

  return (
    <div className="fixed bg-achrams-secondary-solid/50 inset-0 bg-opacity-50 flex items-end z-50 animate-fadeIn ">
      <div className="bg-white w-full rounded-t-3xl p-6 animate-slideUp max-h-[85vh] overflow-y-auto">
        <div className="flex justify-between items-center mb-6">
          <h3 className="text-2xl font-bold">Rate {driverName}</h3>
          <button onClick={onClose}>
            <X className="w-6 h-6" />
          </button>
        </div>

        <div className="flex justify-center gap-2 mb-6">
          {[1, 2, 3, 4, 5].map((star) => (
            <button
              key={star}
              onClick={() => setRating(star)}
              className="transform hover:scale-110 transition"
            >
              <Star
                className={`w-12 h-12 ${
                  star <= rating
                    ? 'fill-yellow-400 text-yellow-400'
                    : 'text-gray-300'
                }`}
              />
            </button>
          ))}
        </div>

        <textarea
          placeholder="Share your experience (optional)"
          value={comment}
          onChange={(e) => setComment(e.target.value)}
          className="w-full px-4 py-3 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary resize-none mb-6 border border-achrams-border"
          rows={3}
        />

        <button
          onClick={handleSubmit}
          disabled={rating === 0}
          className="w-full bg-achrams-primary-solid text-achrams-text-light py-4 rounded-xl font-semibold disabled:bg-gray-300"
        >
          Submit
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/SignupPromptModal.tsx -----
// src/components/app/modals/SignupPromptModal.tsx
import { X, Loader } from 'lucide-react';
import { useState } from 'react';
// NEW: Import apiClient for registration call
import { apiClient } from '@/services/apiClient'; // Assuming you create this service

interface SignupPromptModalProps {
  isOpen: boolean;
  passengerData: { name: string; email: string; phone: string };
  onClose: () => void;
  // NEW: Prop to handle successful registration and navigation (e.g., to OTP modal)
  onRegistrationSuccess: (email: string) => void;
  // NEW: Prop to trigger opening the LoginModal from page.tsx
  onOpenLoginModal: () => void;
}

export default function SignupPromptModal({
  isOpen,
  passengerData,
  onClose,
  onRegistrationSuccess,
  onOpenLoginModal, // NEW: Destructure the new prop
}: SignupPromptModalProps) {
  if (!isOpen) return null;

  // NEW: Local state for password fields and loading/error
  const [password, setPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  const handleRegister = async () => {
    setError(''); // Clear previous errors
    if (!password || !confirmPassword) {
      setError('Please fill in all password fields.');
      return;
    }
    if (password !== confirmPassword) {
      setError('Passwords do not match.');
      return;
    }
    if (password.length < 8) { // Example validation
      setError('Password must be at least 8 characters long.');
      return;
    }

    setLoading(true);
    try {
      // NEW: Call the registration API using apiClient
      // Split name into first and last name for API
      const nameParts = passengerData.name.split(' ');
      const firstName = nameParts[0] || 'Guest';
      const lastName = nameParts.slice(1).join(' ') || 'User';

      const response = await apiClient.post('/auth/passenger/register', {
        email: passengerData.email,
        phone_number: passengerData.phone, // API expects phone_number
        first_name: firstName,
        last_name: lastName,
        password: password,
      });

      console.log("Registration Response:", response); // Debug log
      // NEW: Check response status/message if needed
      if (response.status === 201) { // Assuming 201 for success
        // NEW: On success, close modal and trigger success handler (e.g., open OTP modal)
        onRegistrationSuccess(passengerData.email);
      } else {
          setError('Registration failed. Please try again.');
      }
    } catch (err: any) {
        console.error("Registration Error:", err);
        // NEW: Handle different error types if possible
        let errorMessage = 'An unexpected error occurred.';
        if (err.response && err.response.data && err.response.data.message) {
            errorMessage = err.response.data.message;
        } else if (err.message) {
            errorMessage = err.message;
        }
        setError(errorMessage);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 bg-opacity-70 flex items-end z-50">
      <div className="bg-white w-full rounded-t-3xl p-6 animate-slideUp max-h-[85vh] overflow-y-auto border-t border-achrams-border">
        <div className="flex justify-between items-center mb-2">
          <h3 className="text-xl font-bold text-achrams-text-primary">Create your account</h3>
          <button
            onClick={onClose}
            disabled={loading} // NEW: Disable close button while loading
            className="text-achrams-text-secondary hover:text-achrams-text-primary transition-colors disabled:opacity-50"
          >
            <X className="w-6 h-6" />
          </button>
        </div>
        <p className="text-achrams-text-secondary mb-6">Sign up to save your trips and preferences</p>

        {/* Display passenger data */}
        <div className="space-y-4 mb-4"> {/* Added mb-4 for spacing before password fields */}
          <div className="w-full px-4 py-3 bg-achrams-bg-secondary rounded-xl border border-achrams-border">
            <div className="text-xs text-achrams-text-secondary mb-1">Full name</div>
            <div className="text-achrams-text-primary">{passengerData.name}</div>
          </div>
          <div className="w-full px-4 py-3 bg-achrams-bg-secondary rounded-xl border border-achrams-border">
            <div className="text-xs text-achrams-text-secondary mb-1">Email</div>
            <div className="text-achrams-text-primary">{passengerData.email}</div>
          </div>
          <div className="w-full px-4 py-3 bg-achrams-bg-secondary rounded-xl border border-achrams-border">
            <div className="text-xs text-achrams-text-secondary mb-1">Phone</div>
            <div className="text-achrams-text-primary">{passengerData.phone}</div>
          </div>
        </div>

        {/* NEW: Password Fields */}
        <div className="space-y-4">
          <input
            type="password"
            placeholder="Password"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            disabled={loading} // NEW: Disable input while loading
            className="w-full px-4 py-3 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border border-achrams-border"
          />
          <input
            type="password"
            placeholder="Confirm Password"
            value={confirmPassword}
            onChange={(e) => setConfirmPassword(e.target.value)}
            disabled={loading} // NEW: Disable input while loading
            className="w-full px-4 py-3 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border border-achrams-border"
          />
        </div>

        {/* NEW: Error Message Display */}
        {error && (
          <p className="text-red-500 text-sm mt-2">{error}</p>
        )}

        <button
          onClick={handleRegister}
          disabled={loading || !password || !confirmPassword} // NEW: Disable based on loading and password fields
          className={`w-full py-4 rounded-xl font-semibold mt-6 transition-all ${
            loading || !password || !confirmPassword
              ? 'bg-achrams-secondary-solid text-achrams-text-light opacity-75 cursor-not-allowed'
              : 'bg-achrams-gradient-primary text-achrams-text-light hover:opacity-90 active:scale-[0.98]'
          }`}
        >
          {loading ? ( // NEW: Show spinner while loading
            <div className="flex items-center justify-center">
              <Loader className="w-5 h-5 animate-spin mr-2" />
              Creating...
            </div>
          ) : (
            'Create account'
          )}
        </button>

        {/* NEW: Sign In Link */}
        <div className="mt-4 text-center">
          <button
            onClick={() => {
              onClose(); // Close this modal
              onOpenLoginModal(); // NEW: Call the handler passed from page.tsx to open the login modal
            }}
            className="text-sm text-achrams-primary-solid hover:underline"
          >
            Already have an account? Sign In
          </button>
        </div>

        <button
          onClick={onClose}
          disabled={loading} // NEW: Disable "Not now" while loading
          className="w-full mt-4 text-achrams-text-secondary font-medium hover:text-achrams-text-primary transition-colors disabled:opacity-50"
        >
          Not now
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/OTPModal.tsx -----
// src/components/app/modals/OTPModal.tsx
import { useState, useEffect, useRef } from 'react';
import { X, Check, MailCheck } from 'lucide-react'; // Added MailCheck icon

export default function OTPModal({
  isOpen,
  email,
  onComplete,
  onClose,
}: {
  isOpen: boolean;
  email: string;
  onComplete: () => void;
  onClose: () => void;
}) {
  const [otp, setOtp] = useState(['', '', '', '', '']);
  const [verified, setVerified] = useState(false);
  const inputRefs = useRef<(HTMLInputElement | null)[]>([]);

  useEffect(() => {
    if (isOpen) {
      setOtp(['', '', '', '', '']);
      setVerified(false); // Reset verified state when opening
    }
  }, [isOpen]);

  const handleOtpChange = (index: number, value: string) => {
    if (!/^\d*$/.test(value) || value.length > 1) return;
    const newOtp = [...otp];
    newOtp[index] = value;
    setOtp(newOtp);

    if (value && index < 4) {
      inputRefs.current[index + 1]?.focus();
    }

    if (newOtp.every((d) => d !== '') && newOtp.join('').length === 5) {
      setTimeout(() => {
        setVerified(true);
        setTimeout(() => {
          onComplete();
        }, 1000);
      }, 800);
    }
  };

  if (!isOpen) return null;

  if (verified) {
    return (
      // Verified state modal
      <div className="fixed inset-0 bg-achrams-secondary-solid/50 flex items-end z-50">
        <div className="bg-white w-full rounded-t-3xl p-6 animate-slideUp text-center border-t border-achrams-border">
          <div className="w-16 h-16 bg-achrams-bg-secondary rounded-full flex items-center justify-center mx-auto mb-4 border border-achrams-border">
            <Check className="w-8 h-8 text-achrams-primary-solid" />
          </div>
          <h3 className="text-xl font-bold mb-2 text-achrams-text-primary">Email verified!</h3>
          <p className="text-achrams-text-secondary">Setting up your account...</p>
        </div>
      </div>
    );
  }

  return (
    // Input state modal
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 flex items-end z-50">
      <div className="bg-white w-full rounded-t-3xl p-6 animate-slideUp border-t border-achrams-border">
        <div className="flex justify-between items-center mb-2">
          <h3 className="text-xl font-bold text-achrams-text-primary text-center  mx-auto" >Verify your email</h3>
          <button
            onClick={onClose}
            className="text-achrams-text-secondary hover:text-achrams-text-primary transition-colors"
          >
            <X className="w-6 h-6" />
          </button>
        </div>
        <p className="text-achrams-text-secondary mb-8 mx-auto w-fit">Enter the 5-digit code sent to <span className="font-medium text-achrams-text-primary">{email}</span></p>
        <div className="flex gap-3 justify-center mb-8">
          {otp.map((_, idx) => (
            <input
              key={idx}
              ref={(el) => (inputRefs.current[idx] = el)}
              type="text"
              inputMode="numeric" // Better for mobile numeric keyboards
              maxLength={1}
              value={otp[idx]}
              onChange={(e) => handleOtpChange(idx, e.target.value)}
              // Apply ACHRAMS styling to input
              className="w-14 h-14 text-center text-2xl font-bold bg-achrams-bg-secondary border-2 border-achrams-border rounded-xl outline-none text-achrams-text-primary focus:border-achrams-primary-solid focus:ring-1 focus:ring-achrams-primary-solid"
            />
          ))}
        </div>
        <button className="w-full text-center text-achrams-text-secondary font-medium hover:text-achrams-text-primary transition-colors">
          Resend code
        </button>
        <button
          onClick={onClose}
          className="w-full mt-3 text-sm text-achrams-text-secondary font-medium hover:text-achrams-text-primary transition-colors"
        >
          Cancel
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/MessageWindowModal.tsx -----
// src/components/app/modals/MessageWindowModal.tsx
import { X, Send } from 'lucide-react';
import { useState } from 'react';

interface MessageWindowModalProps {
  isOpen: boolean;
  onClose: () => void;
  recipientName: string;
}

export default function MessageWindowModal({
  isOpen,
  onClose,
  recipientName,
}: MessageWindowModalProps) {
  const [message, setMessage] = useState('');

  const sendMessage = () => {
    if (message.trim()) {
      // In real app: call /messages or WebSocket
      console.log('Message sent to', recipientName, ':', message);
      setMessage('');
    }
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 z-50 animate-fadeIn">
      <div className="h-full flex flex-col">
        <div className="bg-achrams-primary-solid text-white px-6 py-4 flex items-center justify-between">
          <h2 className="text-xl font-bold">Message {recipientName}</h2>
          <button onClick={onClose}>
            <X className="w-6 h-6" />
          </button>
        </div>

        <div className="flex-1 p-4 bg-gray-100 overflow-y-auto">
          {/* Example message history */}
          <div className="bg-white rounded-2xl p-4 mb-4 max-w-xs ml-auto">
            <p className="text-sm">Hi, Im outside!</p>
          </div>
          <div className="bg-gray-200 rounded-2xl p-4 mb-4 max-w-xs">
            <p className="text-sm">OK, coming down now.</p>
          </div>
        </div>

        <div className="p-4 border-t bg-white">
          <div className="flex gap-3">
            <input
              type="text"
              value={message}
              onChange={(e) => setMessage(e.target.value)}
              placeholder="Type a message..."
              className="flex-1 px-4 py-3 bg-gray-100 rounded-full outline-none"
              onKeyDown={(e) => e.key === 'Enter' && sendMessage()}
            />
            <button
              onClick={sendMessage}
              disabled={!message.trim()}
              className="p-3 bg-achrams-primary-solid text-white rounded-full disabled:opacity-50"
            >
              <Send className="w-5 h-5" />
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/LoginModal.tsx -----
// src/components/app/modals/LoginModal.tsx
import { X, Loader, Mail, Chrome, Eye, EyeOff } from 'lucide-react'; // Added Eye/EyeOff for password visibility
import { useState } from 'react';
// NEW: Import apiClient for login call, useAuth hook to update context
import { apiClient } from '@/services/apiClient'; // Assuming you create this service
import { useAuth } from '@/contexts/AuthContext'; // Assuming this context manages the token

interface LoginModalProps {
  isOpen: boolean;
  onClose: () => void;
  // NEW: Prop to handle successful login (e.g., update auth context, navigate to dashboard)
  onLoginSuccess: () => void;
}

export default function LoginModal({
  isOpen,
  onClose,
  onLoginSuccess,
}: LoginModalProps) {
  if (!isOpen) return null;

  const { login: updateAuthContext } = useAuth(); // NEW: Get login function from context

  // NEW: Local state for credentials, password visibility, loading, error
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [showPassword, setShowPassword] = useState(false); // NEW: State for password visibility
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);
  const [loadingGoogle, setLoadingGoogle] = useState(false); // NEW: Separate loading state for Google

  const handleLogin = async () => {
    setError(''); // Clear previous errors
    if (!email || !password) {
      setError('Please fill in all fields.');
      return;
    }

    setLoading(true);
    try {
      // NEW: Call the login API using apiClient
      const response = await apiClient.post('/auth/passenger/login', {
        email: email,
        password: password,
      });

      console.log("Login Response:", response); // Debug log
      // NEW: Check response status/message if needed
      if (response.status === 200 && response.data && response.data.data && response.data.data.token) {
        const token = response.data.data.token;
        // NEW: Update the AuthContext with the received token
        updateAuthContext(token); // This should trigger a re-render and potentially navigate to dashboard in page.tsx
        // NEW: Close the modal and trigger success handler in parent (page.tsx)
        onClose();
        onLoginSuccess(); // Parent (page.tsx) can handle navigation to dashboard
      } else {
          setError('Login failed. Please check your credentials.');
      }
    } catch (err: any) {
        console.error("Login Error:", err);
        // NEW: Handle different error types if possible
        let errorMessage = 'An unexpected error occurred.';
        if (err.response && err.response.data && err.response.data.message) {
            errorMessage = err.response.data.message;
        } else if (err.message) {
            errorMessage = err.message;
        }
        setError(errorMessage);
    } finally {
      setLoading(false);
    }
  };

  // NEW: Placeholder for Google login function
  const handleGoogleLogin = () => {
      setLoadingGoogle(true);
      // Simulate Google login process (replace with actual Google SDK call)
      setTimeout(() => {
          setLoadingGoogle(false);
          // On successful Google login, you would receive a token or user info
          // You might need to link this Google account to your backend or create a new user
          // For now, let's assume a token is obtained and context is updated
          // updateAuthContext('MOCK_GOOGLE_TOKEN'); // Replace with real token
          // onClose();
          // onLoginSuccess();
          alert('Google login functionality would be implemented here using Google SDK.');
      }, 2000); // Simulate 2s delay
  };

  return (
    <div className="fixed inset-0 bg-achrams-bg-primary bg-opacity-70 flex items-end z-50">
      <div className="bg-achrams-bg-primary w-full rounded-t-3xl p-6 animate-slideUp max-h-[85vh] overflow-y-auto border-t border-achrams-border">
        <div className="flex justify-between items-center mb-2">
          <h3 className="text-xl font-bold text-achrams-text-primary">Sign In to your account</h3>
          <button
            onClick={onClose}
            disabled={loading || loadingGoogle} // NEW: Disable close button while loading
            className="text-achrams-text-secondary hover:text-achrams-text-primary transition-colors disabled:opacity-50"
          >
            <X className="w-6 h-6" />
          </button>
        </div>

        {/* NEW: Email/Password Login Form */}
        <div className="space-y-4 mb-6">
          <div className="relative">
            <Mail className="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-achrams-text-secondary" />
            <input
              type="email"
              placeholder="Email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              disabled={loading || loadingGoogle} // NEW: Disable input while loading
              className="w-full pl-10 pr-4 py-3 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border border-achrams-border"
            />
          </div>
          <div className="relative">
            <input
              type={showPassword ? "text" : "password"} // NEW: Toggle input type
              placeholder="Password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              disabled={loading || loadingGoogle} // NEW: Disable input while loading
              className="w-full px-4 py-3 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border border-achrams-border pr-10" // Added pr-10 for eye button
            />
            <button // NEW: Toggle password visibility
              type="button"
              onClick={() => setShowPassword(!showPassword)}
              className="absolute right-3 top-1/2 transform -translate-y-1/2 text-achrams-text-secondary hover:text-achrams-text-primary"
            >
              {showPassword ? <EyeOff className="w-5 h-5" /> : <Eye className="w-5 h-5" />}
            </button>
          </div>
        </div>

        {/* NEW: Error Message Display */}
        {error && (
          <p className="text-red-500 text-sm mb-4">{error}</p>
        )}

        <button
          onClick={handleLogin}
          disabled={loading || loadingGoogle || !email || !password} // NEW: Disable based on loading and fields
          className={`w-full py-4 rounded-xl font-semibold mb-4 transition-all ${
            loading || loadingGoogle || !email || !password
              ? 'bg-achrams-secondary-solid text-achrams-text-light opacity-75 cursor-not-allowed'
              : 'bg-achrams-gradient-primary text-achrams-text-light hover:opacity-90 active:scale-[0.98]'
          }`}
        >
          {loading ? ( // NEW: Show spinner while loading
            <div className="flex items-center justify-center">
              <Loader className="w-5 h-5 animate-spin mr-2" />
              Signing In...
            </div>
          ) : (
            'Sign In'
          )}
        </button>

        {/* NEW: Google Login Button */}
        <button
          onClick={handleGoogleLogin}
          disabled={loading || loadingGoogle} // NEW: Disable Google button while any loading happens
          className={`w-full py-3 rounded-xl font-medium mb-4 transition-colors flex items-center justify-center gap-2 ${
            loadingGoogle
              ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
              : 'bg-white text-gray-800 border border-gray-300 hover:bg-gray-100'
          }`}
        >
          {loadingGoogle ? ( // NEW: Show spinner for Google
            <div className="flex items-center justify-center">
              <Loader className="w-5 h-5 animate-spin mr-2" />
              Signing In...
            </div>
          ) : (
            <>
              <Chrome className="w-5 h-5" />
              Sign In with Google
            </>
          )}
        </button>

        {/* NEW: Sign Up Link */}
        <div className="mt-4 text-center">
          <button
            onClick={() => {
              onClose(); // Close this modal
              // Assuming page.tsx will handle opening the signup prompt modal via a state prop
              // e.g., if page.tsx passes onOpenSignupPrompt prop:
              // onOpenSignupPrompt();
            }}
            className="text-sm text-achrams-primary-solid hover:underline"
          >
            Don't have an account? Sign Up
          </button>
        </div>

        <button
          onClick={onClose}
          disabled={loading || loadingGoogle} // NEW: Disable "Cancel" while loading
          className="w-full mt-4 text-achrams-text-secondary font-medium hover:text-achrams-text-primary transition-colors disabled:opacity-50"
        >
          Cancel
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/TripRequestStatusModal.tsx -----
// src/components/app/modals/TripRequestStatusModal.tsx
import { X, AlertCircle, CheckCircle, Loader } from 'lucide-react';

interface TripRequestStatusModalProps {
  isOpen: boolean;
  onClose: () => void;
  status: 'loading' | 'accepted' | 'no-driver' | 'error' | null;
  message?: string | null; // Optional custom message
  onConfirm?: () => void
}

export default function TripRequestStatusModal({
  isOpen,
  onClose,
  status,
  message,
  onConfirm,
}: TripRequestStatusModalProps) {
  if (!isOpen || !status) return null;

  let icon = null;
  let title = '';
  let description = '';
  let buttonText = 'OK';

  switch (status) {
    case 'loading':
      icon = <Loader className="w-8 h-8 animate-spin text-achrams-primary-solid" />;
      title = 'Finding a Driver...';
      description = 'Please wait while we connect you with a driver.';
      buttonText = 'Cancel'; // Or handle cancellation differently if needed
      break;
    case 'accepted':
      icon = <CheckCircle className="w-8 h-8 text-green-500" />;
      title = 'Driver Found!';
      description = message || 'Your ride has been confirmed.';
      buttonText = 'View Details';
      break;
    case 'no-driver':
      icon = <AlertCircle className="w-8 h-8 text-yellow-500" />;
      title = 'No Drivers Available';
      description = message || 'We couldn\'t find a driver at the moment. Please try again later.';
      buttonText = 'Try Again';
      break;
    case 'error':
      icon = <AlertCircle className="w-8 h-8 text-red-500" />;
      title = 'Something Went Wrong';
      description = message || 'An error occurred while processing your request. Please check your connection and try again.';
      buttonText = 'Retry';
      break;
  }

  return (
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 bg-opacity-70 flex items-end z-100">
      <div className="bg-white w-full rounded-t-3xl p-6 animate-slideUp max-h-[85vh] overflow-y-auto border-t border-achrams-border">
        <div className="flex justify-between items-center mb-6">
          <h3 className="text-xl font-bold text-achrams-text-primary">{title}</h3>
          <button
            onClick={onClose}
            className="text-achrams-text-secondary hover:text-achrams-text-primary transition-colors"
          >
            <X className="w-6 h-6" />
          </button>
        </div>
        <div className="flex flex-col items-center gap-4 mb-6">
          {icon}
          <p className="text-center text-achrams-text-secondary">{description}</p>
        </div>
        <button
          onClick={() => {
            if (status === 'accepted') {
              // The parent (page.tsx) handles the transition after 'accepted' status is set
              onClose(); // Close the modal
            } else if (status === 'no-driver' || status === 'error') {
              // Retry logic or close - in this mock, just 
              if (onConfirm) {onConfirm()} else onClose();
            } else onClose();
          }}
          className={`w-full py-4 rounded-xl font-semibold transition-all ${
            status === 'accepted'
              ? 'bg-achrams-gradient-primary text-achrams-text-light hover:opacity-90 active:scale-[0.98]'
              : 'bg-achrams-secondary-solid text-achrams-text-light hover:bg-achrams-secondary-solid/90'
          }`}
        >
          {buttonText}
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/DirectionsModal.tsx -----
// // src/components/app/modals/DirectionsModal.tsx
import { X } from 'lucide-react';
import { GoogleMap, Marker, DirectionsRenderer, useJsApiLoader } from '@react-google-maps/api'; // NEW: Import DirectionsRenderer
import {useState, useEffect} from 'react';
interface DirectionsModalProps {
  isOpen: boolean;
  onClose: () => void;
  pickup: string;
  pickupCoords?: [number, number] | null;
  destination: string; // NEW
  destinationCoords?: [number, number] | null; // NEW
}

// NEW: Define map container style
const mapContainerStyle = {
  width: '100%',
  height: '100%',
};

// NEW: Optional: Set a default center if no coordinates are provided
const defaultCenter = {
  lat: 6.5244, // Example: Lagos approximate center
  lng: 3.3792,
};

export default function DirectionsModal({
  isOpen,
  onClose,
  pickup,
  pickupCoords,
  destination, // NEW: Destructure the new prop
  destinationCoords, // NEW: Destructure the new prop
}: DirectionsModalProps) {
  if (!isOpen) return null;

  // NEW: Load the Google Maps API script
  const { isLoaded, loadError } = useJsApiLoader({
    id: 'google-map-script',
    // Ensure you have this in your .env.local
    googleMapsApiKey: process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY!,
  });

  // NEW: State for directions result
  const [directions, setDirections] = useState<google.maps.DirectionsResult | null>(null);
  const [directionsError, setDirectionsError] = useState<string | null>(null);

  // NEW: Calculate directions when both pickup and destination coords are available
  useEffect(() => {
    if (isLoaded && pickupCoords && destinationCoords) {
      const directionsService = new google.maps.DirectionsService();
      const request: google.maps.DirectionsRequest = {
        origin: { lat: pickupCoords[1], lng: pickupCoords[0] }, // [lng, lat] to {lat, lng}
        destination: { lat: destinationCoords[1], lng: destinationCoords[0] }, // [lng, lat] to {lat, lng}
        travelMode: google.maps.TravelMode.DRIVING,
      };

      directionsService.route(request, (result, status) => {
        if (status === "OK" && result) {
          setDirections(result);
          setDirectionsError(null);
        } else {
          console.error("Directions request failed due to " + status);
          setDirections(null);
          setDirectionsError("Could not calculate directions.");
        }
      });
    } else {
        setDirections(null); // Reset if coords are missing
        setDirectionsError(null);
    }
  }, [isLoaded, pickupCoords, destinationCoords]);

  // NEW: Determine map center based on available coordinates (could be pickup, destination, or midpoint)
  // For simplicity, using pickup if available, otherwise destination, otherwise default
  let mapCenter = defaultCenter;
  if (pickupCoords) {
      mapCenter = { lat: pickupCoords[1], lng: pickupCoords[0] };
  } else if (destinationCoords) {
      mapCenter = { lat: destinationCoords[1], lng: destinationCoords[0] };
  }


  // NEW: Handle loading/error states for the script
  if (loadError) {
    return (
      <div className="fixed inset-0 bg-achrams-bg-primary z-50 flex items-center justify-center">
        <p className="text-achrams-text-secondary">Error loading map: {loadError.message}</p>
      </div>
    );
  }

  return (
    // NEW: Apply ACHRAMS bg color
    <div className="fixed inset-0 bg-achrams-bg-primary z-50" suppressHydrationWarning={true}>
      <div className="h-full flex flex-col">
        {/* NEW: Apply ACHRAMS header styling */}
        <div className="bg-achrams-primary-solid text-achrams-text-light px-6 py-4 flex items-center justify-between">
          <h2 className="text-xl font-bold">Directions to Pickup</h2>
          <button
            onClick={onClose}
            className="text-achrams-text-light hover:text-achrams-text-light/80 transition-colors"
          >
            <X className="w-6 h-6" />
          </button>
        </div>

        {/* NEW: Map Container */}
        <div className="flex-1 relative">
          {isLoaded ? (
            <GoogleMap
              mapContainerStyle={mapContainerStyle}
              center={mapCenter}
              zoom={12} // Adjust zoom level as needed, maybe fitBounds later
              options={{
                // Optional: Disable default UI elements for a cleaner look
                // mapTypeControl: false,
                // streetViewControl: false,
                // fullscreenControl: false,
                // zoomControl: false,
                // Add other map options as needed
              }}
            >
              {/* NEW: Add marker for pickup location if coordinates are available */}
              {pickupCoords && (
                <Marker
                  position={{ lat: pickupCoords[1], lng: pickupCoords[0] }}
                  // Optional: Customize marker icon
                  // icon={...}
                  title={`Pickup: ${pickup}`}
                />
              )}
              {/* NEW: Add marker for destination location if coordinates are available */}
              {destinationCoords && (
                <Marker
                  position={{ lat: destinationCoords[1], lng: destinationCoords[0] }}
                  // Optional: Customize marker icon
                  // icon={...}
                  title={`Destination: ${destination}`}
                />
              )}
              {/* NEW: Render directions if available */}
              {directions && <DirectionsRenderer directions={directions} />}
              {/* NEW: Display error if directions failed */}
              {directionsError && (
                 <div className="absolute top-4 left-4 bg-red-100 text-red-800 p-2 rounded">
                    {directionsError}
                 </div>
              )}
            </GoogleMap>
          ) : (
            // NEW: Fallback while loading or if failed to load
            <div className="absolute inset-0 flex items-center justify-center bg-achrams-bg-secondary">
              <p className="text-achrams-text-secondary">Loading map...</p>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}


// src/components/app/modals/DirectionsModal.tsx
// import { X } from 'lucide-react';
// // NEW: Import the wrapper component
// import DirectionsMapWrapper from './DirectionsMapWrapper'; // Adjust path if necessary

// interface DirectionsModalProps {
//   isOpen: boolean;
//   onClose: () => void;
//   pickup: string;
//   pickupCoords?: [number, number] | null;
//   destination: string;
//   destinationCoords?: [number, number] | null;
// }

// export default function DirectionsModal({
//   isOpen,
//   onClose,
//   pickup,
//   pickupCoords,
//   destination,
//   destinationCoords,
// }: DirectionsModalProps) {
//   if (!isOpen) return null;

//   return (
//     <div className="fixed inset-0 bg-achrams-bg-primary z-50">
//       <div className="h-full flex flex-col">
//         <div className="bg-achrams-primary-solid text-achrams-text-light px-6 py-4 flex items-center justify-between">
//           <h2 className="text-xl font-bold">Directions to Pickup</h2>
//           <button onClick={onClose}>
//             <X className="w-6 h-6" />
//           </button>
//         </div>
//         {/* NEW: Use the wrapper component */}
//         <DirectionsMapWrapper
//           pickup={pickup}
//           destination={destination}
//           pickupCoords={pickupCoords || null}
//           destinationCoords={destinationCoords || null}
//         />
//       </div>
//     </div>
//   );
// }

----- FILE: src/components/app/modals/DriverVerificationModal.tsx -----
// src/components/app/modals/DriverVerificationModal.tsx
import { Shield, Check } from 'lucide-react';

interface DriverVerificationModalProps {
  isOpen: boolean;
  onClose: () => void;
  securityCode: string; // Pass the code from parent
}

export default function DriverVerificationModal({
  isOpen,
  onClose,
  securityCode,
}: DriverVerificationModalProps) {
  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 flex items-end z-50">
      <div className="bg-white w-full rounded-t-3xl p-6 animate-slideUp max-h-[85vh] overflow-y-auto  shadow-sm">
        <div className="flex justify-center mb-6">
          <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center text-green-600">
            <Shield className="w-8 h-8" />
          </div>
        </div>
        <div className="text-center mb-6">
          <h3 className="text-xl font-bold text-achrams-text-primary">Verify Your Driver</h3>
          <p className="text-achrams-text-secondary mt-2">Share this code with your driver to confirm their identity</p>
        </div>
        <div className="bg-achrams-bg-secondary rounded-xl p-4 mb-6 text-center">
          <div className="text-xs text-achrams-text-secondary mb-2">SECURITY CODE</div>
          <div className="text-4xl font-bold text-achrams-text-primary">{securityCode}</div>
        </div>
        <button
          onClick={onClose}
          className="w-full py-4 rounded-xl font-semibold bg-achrams-gradient-primary text-achrams-text-light hover:opacity-90 active:scale-[0.98] transition-all"
        >
          OK
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/OutsideServiceAreaModal.tsx -----
// src/components/app/modals/OutsideServiceAreaModal.tsx
import { X } from 'lucide-react';

interface OutsideServiceAreaModalProps {
  isOpen: boolean;
  onClose: () => void; // Allows closing the modal
}

export default function OutsideServiceAreaModal({
  isOpen,
  onClose,
}: OutsideServiceAreaModalProps) {
  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 bg-opacity-70 flex items-end z-100">
      <div className="bg-white w-full rounded-t-3xl p-6 animate-slideUp max-h-[85vh] overflow-y-auto border-t border-achrams-border">
        <div className="flex justify-between items-center mb-6">
          <h3 className="text-xl font-bold text-achrams-text-primary">Service Area Limitation</h3>
          <button
            onClick={onClose}
            className="text-achrams-text-secondary hover:text-achrams-text-primary transition-colors"
          >
            <X className="w-6 h-6" />
          </button>
        </div>
        <div className="flex flex-col items-center gap-4 mb-6">
          <p className="text-center text-achrams-text-secondary">
            You are currently outside our service area. Booking is not available from this location.
          </p>
        </div>
        <button
          onClick={onClose} // Close the modal when OK is clicked
          className={`w-full py-4 rounded-xl font-semibold transition-all bg-achrams-gradient-primary text-achrams-text-light hover:opacity-90 active:scale-[0.98]`}
        >
          OK
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/CancelModal.tsx -----
// src/components/app/modals/CancelModal.tsx
import { X, MapPin } from 'lucide-react';
import { useState } from 'react';

const cancelReasons = [
  'Driver is taking too long',
  'Changed my mind',
  'Found another ride',
  'Driver is unprofessional',
  'Other'
];

interface CancelModalProps {
  isOpen: boolean;
  onClose: () => void;
  onConfirm: (reason: string, location?: [number, number], address?: string) => void;
  pickupAddress?: string;
}

export default function CancelModal({
  isOpen,
  onClose,
  onConfirm,
  pickupAddress,
}: CancelModalProps) {
  const [selectedReason, setSelectedReason] = useState<string | null>(null);
  const [otherReason, setOtherReason] = useState('');

  const handleConfirm = () => {
    const reason = selectedReason === 'Other' ? otherReason : selectedReason;
    if (reason) {
      // In real app, get current coordinates via Geolocation
      onConfirm(reason, undefined, pickupAddress);
    }
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 flex items-end z-50 animate-fadeIn">
      <div className="bg-white w-full rounded-t-3xl p-6 animate-slideUp max-h-[85vh] overflow-y-auto">
        <div className="flex justify-between items-center mb-6">
          <h3 className="text-2xl font-bold">Cancel trip</h3>
          <button onClick={onClose}>
            <X className="w-6 h-6" />
          </button>
        </div>

        <p className="text-gray-600 mb-6">Why do you want to cancel?</p>

        <div className="space-y-3 mb-6">
          {cancelReasons.map((reason, idx) => (
            <button
              key={idx}
              onClick={() => setSelectedReason(reason)}
              className={`w-full text-left px-4 py-4 rounded-xl transition-all ${
                selectedReason === reason
                  ? 'bg-achrams-primary-solid text-white'
                  : 'bg-gray-50 hover:bg-gray-100'
              }`}
            >
              {reason}
            </button>
          ))}
        </div>

        {selectedReason === 'Other' && (
          <div className="mb-6">
            <textarea
              placeholder="Please specify..."
              value={otherReason}
              onChange={(e) => setOtherReason(e.target.value)}
              className="w-full px-4 py-3 bg-gray-50 rounded-xl outline-none resize-none"
              rows={2}
            />
          </div>
        )}

        {pickupAddress && (
          <div className="flex items-center gap-3 mb-6 p-4 bg-gray-50 rounded-xl">
            <MapPin className="w-5 h-5 text-gray-600 flex-shrink-0" />
            <span className="text-sm">{pickupAddress}</span>
          </div>
        )}

        <button
          onClick={handleConfirm}
          disabled={!selectedReason || (selectedReason === 'Other' && !otherReason.trim())}
          className="w-full bg-red-600 text-white py-4 rounded-xl font-semibold disabled:bg-gray-300"
        >
          Confirm cancellation
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/Disable2FAModal.tsx -----
// src/components/app/modals/Disable2FAModal.tsx
import { X, ShieldAlert, Loader } from 'lucide-react';
import { useState } from 'react';
import { apiClient } from '@/services/apiClient'; // Assuming you create this service

interface Disable2FAModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSuccess: () => void; // NEW: Callback after successful disable
}

export default function Disable2FAModal({
  isOpen,
  onClose,
  onSuccess,
}: Disable2FAModalProps) {
  if (!isOpen) return null;

  // NEW: State for OTP input, loading, error
  const [otp, setOtp] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  const handleDisable = async () => {
    setError(''); // Clear previous errors
    if (!otp) {
      setError('Please enter the OTP from your authenticator app.');
      return;
    }

    setLoading(true);
    try {
      // NEW: Call the disable API using apiClient
      // The exact endpoint might vary (e.g., POST /auth/passenger/2fa/disable, DELETE /auth/passenger/2fa, or PUT/PATCH with flag)
      // Check passenger postman DOC.txt for the correct endpoint.
      // Example: Assuming POST /auth/passenger/2fa/disable
      const response = await apiClient.post('/auth/passenger/2fa/disable', { // Use correct endpoint from Postman
        token: otp, // Or 'otp' depending on API expectation
      });

      console.log("2FA Disable Response:", response); // Debug log
      if (response.status === 200) { // Assuming 200 for success
        // NEW: On success, close modal and trigger success handler (e.g., update profile info in parent)
        onClose();
        onSuccess();
      } else {
          setError('Failed to disable 2FA. Please check the code and try again.');
      }
    } catch (err: any) {
        console.error("2FA Disable Error:", err);
        let errorMessage = 'An unexpected error occurred.';
        if (err.response && err.response.data && err.response.data.message) {
            errorMessage = err.response.data.message;
        } else if (err.message) {
            errorMessage = err.message;
        }
        setError(errorMessage);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-achrams-bg-primary bg-opacity-70 flex items-end z-50">
      <div className="bg-achrams-bg-primary w-full rounded-t-3xl p-6 animate-slideUp max-h-[85vh] overflow-y-auto border-t border-achrams-border">
        <div className="flex justify-between items-center mb-6">
          <h3 className="text-xl font-bold text-achrams-text-primary">Disable Two-Factor Authentication</h3>
          <button
            onClick={onClose}
            disabled={loading} // NEW: Disable close button while loading
            className="text-achrams-text-secondary hover:text-achrams-text-primary transition-colors disabled:opacity-50"
          >
            <X className="w-6 h-6" />
          </button>
        </div>

        <div className="flex items-center gap-3 p-4 bg-achrams-bg-secondary rounded-xl border border-achrams-border mb-6">
          <ShieldAlert className="w-6 h-6 text-achrams-warning-dark flex-shrink-0" />
          <p className="text-achrams-text-secondary text-sm">
            Disabling 2FA reduces the security of your account. Are you sure you want to proceed?
          </p>
        </div>

        <input
          type="text"
          placeholder="Enter 6-digit code from app"
          value={otp}
          onChange={(e) => setOtp(e.target.value.replace(/\D/g, '').slice(0, 6))} // NEW: Allow only digits, max 6
          disabled={loading} // NEW: Disable input while loading
          className="w-full px-4 py-4 bg-achrams-bg-secondary rounded-xl outline-none text-achrams-text-primary border border-achrams-border mb-4"
        />

        {/* NEW: Error Message Display */}
        {error && (
          <p className="text-red-500 text-sm mb-4">{error}</p>
        )}

        <button
          onClick={handleDisable}
          disabled={loading || !otp} // NEW: Disable based on loading and OTP field
          className={`w-full py-4 rounded-xl font-semibold mb-3 transition-all ${
            loading || !otp
              ? 'bg-achrams-secondary-solid text-achrams-text-light opacity-75 cursor-not-allowed'
              : 'bg-red-600 text-achrams-text-light hover:opacity-90 active:scale-[0.98]'
          }`}
        >
          {loading ? ( // NEW: Show spinner while loading
            <div className="flex items-center justify-center">
              <Loader className="w-5 h-5 animate-spin mr-2" />
              Disabling...
            </div>
          ) : (
            'Disable 2FA'
          )}
        </button>

        <button
          onClick={onClose}
          disabled={loading} // NEW: Disable "Cancel" while loading
          className="w-full text-achrams-text-secondary font-medium hover:text-achrams-text-primary transition-colors disabled:opacity-50"
        >
          Cancel
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/AirportSelectionModal.tsx -----
// src/components/app/modals/AirportSelectionModal.tsx
import { X } from 'lucide-react';
import { Airport } from '@/lib/airports'; // Assuming this is your Airport type from src/lib/airports.ts

interface AirportSelectionModalProps {
  isOpen: boolean;
  onClose: () => void;
  airports: Airport[]; // List of airports returned by the API
  onSelect: (airport: Airport) => void; // Callback when an airport is selected
}

export default function AirportSelectionModal({
  isOpen,
  onClose,
  airports,
  onSelect,
}: AirportSelectionModalProps) {
  if (!isOpen || airports.length === 0) return null;

  return (
    <div className="fixed inset-0 bg-achrams-secondary-solid/50 bg-opacity-70 flex items-end z-100">
      <div className="bg-white w-full rounded-t-3xl p-6 animate-slideUp max-h-[85vh] overflow-y-auto border-t border-achrams-border">
        <div className="flex justify-between items-center mb-6">
          <h3 className="text-xl font-bold text-achrams-text-primary">Select Airport</h3>
          <button
            onClick={onClose}
            className="text-achrams-text-secondary hover:text-achrams-text-primary transition-colors"
          >
            <X className="w-6 h-6" />
          </button>
        </div>
        <div className="flex flex-col gap-2">
          {airports.map((airport) => (
            <button
              key={airport.id}
              onClick={() => {
                onSelect(airport); // Pass the selected airport back to the parent
                onClose(); // Close the modal
              }}
              className="w-full px-4 py-3 flex items-start gap-3 hover:bg-achrams-bg-secondary border border-achrams-border rounded-lg text-left transition-colors"
            >
              <div className="mt-0.5">
                {/* You could add an icon here if needed */}
              </div>
              <div>
                <div className="font-medium text-achrams-text-primary text-sm">{airport.name}</div>
                <div className="text-xs text-achrams-text-secondary">{airport.codename}</div>
              </div>
            </button>
          ))}
        </div>
      </div>
    </div>
  );
}

----- FILE: src/components/app/modals/DirectionsMapWrapper.tsx -----
// src/components/app/modals/DirectionsMapWrapper.tsx
import { GoogleMap, Marker, useJsApiLoader } from '@react-google-maps/api';
import { useEffect, useState } from 'react';

interface DirectionsMapWrapperProps {
  pickupCoords: [number, number] | null;
  destinationCoords: [number, number] | null;
  pickup: string; // For display
  destination: string; // For display
  // Add any other props needed specifically for map rendering
}

const DirectionsMapWrapper: React.FC<DirectionsMapWrapperProps> = ({
  pickupCoords,
  destinationCoords,
  pickup,
  destination,
}) => {
  // NEW: State to ensure map renders only after mount
  const [hasMounted, setHasMounted] = useState(false);

  useEffect(() => {
    // NEW: Set mounted state after the first render
    setHasMounted(true);
  }, []);

  // NEW: Load Google Maps API only if mounted
  const { isLoaded, loadError } = useJsApiLoader({
    id: 'google-map-script-directions',
    googleMapsApiKey: process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY!,
    // NEW: Skip loading if not mounted yet
    skip: !hasMounted,
  });

  // NEW: Determine map center - prioritize pickup, then destination, then default
  let mapCenter = { lat: 6.5244, lng: 3.3792 }; // Default
  if (pickupCoords) {
    mapCenter = { lat: pickupCoords[1], lng: pickupCoords[0] };
  } else if (destinationCoords) {
    mapCenter = { lat: destinationCoords[1], lng: destinationCoords[0] };
  }

  // NEW: If not mounted, return a placeholder
  if (!hasMounted) {
    return <div className="absolute inset-0 flex items-center justify-center bg-achrams-bg-secondary"><p className="text-achrams-text-secondary">Loading map...</p></div>;
  }

  if (loadError) {
    return (
      <div className="absolute inset-0 flex items-center justify-center bg-achrams-bg-secondary">
        <p className="text-achrams-text-secondary">Error loading map: {loadError.message}</p>
      </div>
    );
  }

  return (
    <div className="flex-1 relative">
      {isLoaded ? (
        <GoogleMap
          mapContainerStyle={{ width: '100%', height: '100%' }}
          center={mapCenter}
          zoom={14}
          options={{
            // Optional: Disable default UI elements for a cleaner look
            // mapTypeControl: false,
            // streetViewControl: false,
            // fullscreenControl: false,
            // zoomControl: false,
            // Add other map options as needed
          }}
        >
          {/* Pickup Marker */}
          {pickupCoords && (
            <Marker
              position={{ lat: pickupCoords[1], lng: pickupCoords[0] }}
              // FIXED: Removed trailing spaces from URL
              icon={{ url: 'https://maps.google.com/mapfiles/ms/micons/green-dot.png', scaledSize: new window.google.maps.Size(32, 32) }}
              title="Pickup Location"
            />
          )}
          {/* Destination Marker */}
          {destinationCoords && (
            <Marker
              position={{ lat: destinationCoords[1], lng: destinationCoords[0] }}
              // FIXED: Removed trailing spaces from URL
              icon={{ url: 'https://maps.google.com/mapfiles/ms/micons/red-dot.png', scaledSize: new window.google.maps.Size(32, 32) }}
              title="Destination"
            />
          )}
        </GoogleMap>
      ) : (
        <div className="absolute inset-0 flex items-center justify-center bg-achrams-bg-secondary">
          <p className="text-achrams-text-secondary">Loading map...</p>
        </div>
      )}
    </div>
  );
};

export default DirectionsMapWrapper;

----- FILE: src/components/app/ui/BottomNavBar.tsx -----
// src/components/app/ui/BottomNavBar.tsx
import { House, Search, Wallet, User } from 'lucide-react';
import { usePathname, useRouter } from 'next/navigation'; // Or your routing library

interface BottomNavBarProps {
  onProfileClick: () => void; // Handler to open profile modal/settings
  walletBalance?: number; // Optional: Display small badge/indicator on wallet icon
  // NEW: Add handlers for other nav items if needed, e.g., onHomeClick, onSearchClick, onWalletClick
  onHomeClick?: () => void;
  onSearchClick?: () => void;
  onWalletClick?: () => void;
}

export default function BottomNavBar({
  onProfileClick,
  walletBalance,
  onHomeClick,
  onSearchClick,
  onWalletClick,
}: BottomNavBarProps) {
  const pathname = usePathname();
  const router = useRouter();

  // Helper to determine if a nav item is active
  const isActive = (path: string) => pathname === path;

  // Handlers for navigation clicks
  const handleHomeClick = () => {
    if (onHomeClick) {
      onHomeClick(); // Allow parent to handle logic (e.g., scroll to top)
    } else {
      // Default behavior: navigate to dashboard if not already there
      if (pathname !== '/dashboard') {
        router.push('/dashboard');
      } else {
        // If already on dashboard, maybe scroll to top
        window.scrollTo(0, 0);
      }
    }
  };

  const handleSearchClick = () => {
    if (onSearchClick) {
      onSearchClick();
    } else {
      // Navigate to search screen - placeholder path
      router.push('/search'); // Replace with actual search screen path
    }
  };

  const handleWalletClick = () => {
    if (onWalletClick) {
      onWalletClick();
    } else {
      // Navigate to wallet screen - placeholder path
      router.push('/wallet'); // Replace with actual wallet screen path
    }
  };

  return (
    <nav className="fixed bottom-0 left-0 right-0 bg-achrams-bg-primary border-t border-achrams-border z-40">
      <div className="flex justify-around items-center py-3 px-2">
        <button
          onClick={handleHomeClick}
          className={`flex flex-col items-center justify-center gap-1 p-2 rounded-lg transition-colors ${
            isActive('/dashboard') ? 'text-achrams-primary-solid' : 'text-achrams-text-secondary'
          }`}
        >
          <House className={`w-6 h-6 ${isActive('/dashboard') ? 'fill-current' : ''}`} />
          <span className="text-xs">Home</span>
        </button>
        <button
          onClick={handleSearchClick}
          className={`flex flex-col items-center justify-center gap-1 p-2 rounded-lg transition-colors ${
            isActive('/search') ? 'text-achrams-primary-solid' : 'text-achrams-text-secondary'
          }`}
        >
          <Search className={`w-6 h-6 ${isActive('/search') ? 'fill-current' : ''}`} />
          <span className="text-xs">Search</span>
        </button>
        <button
          onClick={handleWalletClick}
          className={`flex flex-col items-center justify-center gap-1 p-2 rounded-lg transition-colors relative ${
            isActive('/wallet') ? 'text-achrams-primary-solid' : 'text-achrams-text-secondary'
          }`}
        >
          <Wallet className={`w-6 h-6 ${isActive('/wallet') ? 'fill-current' : ''}`} />
          {/* Optional: Wallet balance indicator */}
          {walletBalance != null && walletBalance > 0 && (
            <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
              {walletBalance}
            </span>
          )}
          <span className="text-xs">Wallet</span>
        </button>
        <button
          onClick={onProfileClick}
          className={`flex flex-col items-center justify-center gap-1 p-2 rounded-lg transition-colors ${
            isActive('/profile') ? 'text-achrams-primary-solid' : 'text-achrams-text-secondary' // Assuming profile page path
          }`}
        >
          <User className={`w-6 h-6 ${isActive('/profile') ? 'fill-current' : ''}`} />
          <span className="text-xs">Profile</span>
        </button>
      </div>
    </nav>
  );
}

----- FILE: src/components/app/ui/TripUpdateNotification.tsx -----
// src/components/app/ui/TripUpdateNotification.tsx
import { useEffect } from 'react';
import { AlertTriangle, CheckCircle, Info, X } from 'lucide-react';

interface TripUpdateNotificationProps {
  message: string;
  type: 'info' | 'success' | 'warning' | 'error';
  onDismiss: () => void;
}

export default function TripUpdateNotification({
  message,
  type,
  onDismiss,
}: TripUpdateNotificationProps) {
  let icon = null;
  let bgColor = '';
  let textColor = '';
  let iconColor = '';

  switch (type) {
    case 'info':
      icon = <Info className="w-5 h-5" />;
      bgColor = 'bg-blue-100';
      textColor = 'text-blue-800';
      iconColor = 'text-blue-500';
      break;
    case 'success':
      icon = <CheckCircle className="w-5 h-5" />;
      bgColor = 'bg-green-100';
      textColor = 'text-green-800';
      iconColor = 'text-green-500';
      break;
    case 'warning':
      icon = <AlertTriangle className="w-5 h-5" />;
      bgColor = 'bg-yellow-100';
      textColor = 'text-yellow-800';
      iconColor = 'text-yellow-500';
      break;
    case 'error':
      icon = <AlertTriangle className="w-5 h-5" />;
      bgColor = 'bg-red-100';
      textColor = 'text-red-800';
      iconColor = 'text-red-500';
      break;
  }

  useEffect(()=>{
    const timer = setTimeout(()=>{
      onDismiss();
    }, 6000);

    return() => {
      clearTimeout(timer);
    }

  }, [onDismiss]);

  return (
    <div className={`fixed top-4 left-1/2 transform -translate-x-1/2 max-w-xs w-full p-4 rounded-lg shadow-lg ${bgColor} ${textColor} flex items-start gap-2 z-50 animate-fadeInUp`}>
      <div className={`flex-shrink-0 mt-0.5 ${iconColor}`}>{icon}</div>
      <div className="flex-1">
        <p className="text-sm">{message}</p>
      </div>
      <button
        onClick={onDismiss}
        className="flex-shrink-0 text-current hover:opacity-80"
      >
        <X className="w-4 h-4" />
      </button>
    </div>
  );
}

----- FILE: src/components/app/screens/TripDetailsScreen.tsx -----
// src/components/app/screens/TripDetailsScreen.tsx
import { useState, useEffect } from 'react';
import { MapPin, Clock, Star, Calendar, ChevronLeft, MessageCircle, Phone } from 'lucide-react';
import { GoogleMap, Marker, useJsApiLoader } from '@react-google-maps/api';
import { apiClient } from '@/services/apiClient'; // Assuming you create this service

interface TripDetails {
  id: string;
  amount: {
    formatted: string;
  };
  status: {
    label: string;
    value: string;
  };
  pickup_address: string;
  destination_address: string;
  verification_code: string;
  rating?: {
    score: number;
    comment?: string;
  } | null;
  map_data: {
    pickup_location: {
      geometry: {
        coordinates: [number, number]; // [lng, lat]
      };
      properties: {
        name: string;
        description: string;
      };
    };
    destination_location: {
      geometry: {
        coordinates: [number, number]; // [lng, lat]
      };
      properties: {
        name: string;
        description: string;
      };
    };
  };
  driver?: {
    name: string;
    rating: string; // e.g., "4.9"
    car_type: string;
    car_color: string;
    plate_number: string;
    profile_photo?: string;
    phone: string;
  };
  created_at: string; // ISO date string
  // Add other fields as needed
}

export default function TripDetailsScreen({ tripId, onBack }: { tripId: string; onBack: () => void }) {
  const [tripDetails, setTripDetails] = useState<TripDetails | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchTripDetails = async () => {
      try {
        setLoading(true);
        setError(null);
        // NEW: Call the specific trip API using apiClient
        // Example: GET /trips/{tripId}
        const response = await apiClient.get(`/trips/${tripId}`); // Use correct endpoint from Postman doc

        console.log("Trip Details Response:", response); // Debug log
        if (response.status === 200 && response.data && response.data.data) {
          setTripDetails(response.data.data);
        } else {
          setError('Failed to load trip details.');
        }
      } catch (err) {
        console.error("Trip Details Fetch Error:", err);
        let errorMessage = 'An unexpected error occurred.';
        if (err instanceof Error) {
          errorMessage = err.message;
        }
        setError(errorMessage);
      } finally {
        setLoading(false);
      }
    };

    if (tripId) {
        fetchTripDetails();
    }
  }, [tripId]);


  if (loading) {
    return (
      <div className="h-screen bg-achrams-bg-primary flex items-center justify-center">
        <div className="text-center">
          <div className="w-16 h-16 border-4 border-achrams-primary-solid border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p className="text-achrams-text-secondary">Loading trip details...</p>
        </div>
      </div>
    );
  }

  if (error || !tripDetails) {
    return (
      <div className="h-screen bg-achrams-bg-primary flex flex-col items-center justify-center p-6">
        <p className="text-red-500 text-center mb-6">{error || 'Trip details not found.'}</p>
        <button
          onClick={onBack} // Go back on error
          className="bg-achrams-gradient-primary text-achrams-text-light py-3 px-6 rounded-xl font-semibold"
        >
          Back to History
        </button>
      </div>
    );
  }

  // NEW: Extract map coordinates and center
  const pickupCoords = tripDetails.map_data.pickup_location.geometry.coordinates; // [lng, lat]
  const destCoords = tripDetails.map_data.destination_location.geometry.coordinates; // [lng, lat]
  const mapCenter = { lat: pickupCoords[1], lng: pickupCoords[0] }; // { lat: lat, lng: lng }

  // NEW: Load Google Maps API
  const { isLoaded, loadError } = useJsApiLoader({
    id: 'google-map-script-trip-details',
    googleMapsApiKey: process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY!,
  });

  return (
    <div className="h-screen bg-achrams-bg-primary flex flex-col">
      {/* Header */}
      <div className="bg-achrams-primary-solid text-achrams-text-light px-6 py-4 flex items-center">
        <button onClick={onBack} className="mr-4">
          <ChevronLeft className="w-6 h-6" />
        </button>
        <h1 className="text-xl font-bold">Trip Details</h1>
      </div>

      {/* Content */}
      <div className="flex-1 overflow-y-auto">
        {/* Map Preview (smaller) */}
        <div className="h-48 relative">
          {isLoaded ? (
            <GoogleMap
              mapContainerStyle={{ width: '100%', height: '100%' }}
              center={mapCenter}
              zoom={12}
              options={{
                // Disable default UI for a cleaner look in preview
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false,
                zoomControl: false,
              }}
            >
              <Marker
                position={{ lat: pickupCoords[1], lng: pickupCoords[0] }}
                icon={{ url: 'https://maps.google.com/mapfiles/ms/micons/green-dot.png', scaledSize: new window.google.maps.Size(32, 32) }}
                title={tripDetails.map_data.pickup_location.properties.name}
              />
              <Marker
                position={{ lat: destCoords[1], lng: destCoords[0] }}
                icon={{ url: 'https://maps.google.com/mapfiles/ms/micons/red-dot.png', scaledSize: new window.google.maps.Size(32, 32) }}
                title={tripDetails.map_data.destination_location.properties.name}
              />
            </GoogleMap>
          ) : (
            <div className="absolute inset-0 flex items-center justify-center bg-achrams-bg-secondary">
              <p className="text-achrams-text-secondary">Loading map...</p>
            </div>
          )}
        </div>

        {/* Trip Info */}
        <div className="p-6 space-y-6">
          {/* Date & Status */}
          <div className="flex justify-between items-center">
            <div className="flex items-center gap-2">
              <Calendar className="w-5 h-5 text-achrams-text-secondary" />
              <span className="text-achrams-text-primary">{new Date(tripDetails.created_at).toLocaleString()}</span>
            </div>
            <span className={`text-xs px-3 py-1 rounded-full ${
              tripDetails.status.value === 'completed' ? 'bg-green-100 text-green-800' :
              tripDetails.status.value === 'cancelled' ? 'bg-red-100 text-red-800' :
              'bg-yellow-100 text-yellow-800'
            }`}>
              {tripDetails.status.label}
            </span>
          </div>

          {/* Fare */}
          <div className="bg-achrams-bg-secondary rounded-xl p-4 border border-achrams-border">
            <div className="flex justify-between items-center">
              <span className="text-achrams-text-secondary">Total Fare</span>
              <span className="text-2xl font-bold text-achrams-text-primary">{tripDetails.amount.formatted}</span>
            </div>
          </div>

          {/* Verification Code */}
          {tripDetails.verification_code && (
            <div className="bg-achrams-bg-secondary rounded-xl p-4 border border-achrams-border">
              <div className="text-xs text-achrams-text-secondary mb-1">Verification Code</div>
              <div className="text-xl font-mono font-bold text-achrams-text-primary">{tripDetails.verification_code}</div>
            </div>
          )}

          {/* Driver Info (if assigned) */}
          {tripDetails.driver && (
            <div className="bg-achrams-bg-secondary rounded-xl p-4 border border-achrams-border">
              <h3 className="font-semibold mb-3 text-achrams-text-primary">Driver Info</h3>
              <div className="flex items-center gap-4 mb-4">
                <div className="w-14 h-14 bg-gradient-to-br from-achrams-primary-solid to-achrams-secondary-solid rounded-full flex items-center justify-center text-achrams-text-light text-lg font-bold">
                  {tripDetails.driver.name.charAt(0)}
                </div>
                <div className="flex-1">
                  <div className="font-bold text-achrams-text-primary">{tripDetails.driver.name}</div>
                  <div className="flex items-center gap-1 text-sm text-achrams-text-secondary">
                    <Star className="w-4 h-4 fill-yellow-400 text-yellow-400" />
                    <span>{tripDetails.driver.rating}</span>
                  </div>
                </div>
              </div>
              <div className="space-y-2">
                <div className="text-sm">
                  <span className="text-achrams-text-secondary">Car: </span>
                  <span className="text-achrams-text-primary">{tripDetails.driver.car_type}  {tripDetails.driver.car_color}</span>
                </div>
                <div className="text-sm">
                  <span className="text-achrams-text-secondary">Plate: </span>
                  <span className="text-achrams-text-primary">{tripDetails.driver.plate_number}</span>
                </div>
              </div>
              <div className="flex gap-3 mt-4">
                <button className="flex-1 flex items-center justify-center gap-2 py-3 bg-achrams-bg-primary border border-achrams-border rounded-xl font-medium text-achrams-text-primary hover:bg-achrams-bg-secondary transition-colors">
                  <MessageCircle className="w-5 h-5" />
                  Message
                </button>
                <button className="flex-1 flex items-center justify-center gap-2 py-3 bg-achrams-bg-primary border border-achrams-border rounded-xl font-medium text-achrams-text-primary hover:bg-achrams-bg-secondary transition-colors">
                  <Phone className="w-5 h-5" />
                  Call
                </button>
              </div>
            </div>
          )}

          {/* Rating */}
          {tripDetails.rating && (
            <div className="bg-achrams-bg-secondary rounded-xl p-4 border border-achrams-border">
              <h3 className="font-semibold mb-3 text-achrams-text-primary">Your Rating</h3>
              <div className="flex items-center gap-2 mb-2">
                {[...Array(5)].map((_, i) => (
                  <Star
                    key={i}
                    className={`w-6 h-6 ${
                      i < tripDetails.rating!.score
                        ? 'fill-yellow-400 text-yellow-400'
                        : 'text-gray-300'
                    }`}
                  />
                ))}
                <span className="ml-2 font-medium text-achrams-text-primary">{tripDetails.rating.score}/5</span>
              </div>
              {tripDetails.rating.comment && (
                <p className="text-achrams-text-secondary text-sm italic">"{tripDetails.rating.comment}"</p>
              )}
            </div>
          )}

          {/* Addresses */}
          <div className="space-y-4">
            <div className="flex items-start gap-3">
              <div className="w-2 h-2 bg-achrams-primary-solid rounded-full mt-2 flex-shrink-0"></div>
              <div className="flex-1">
                <div className="text-xs text-achrams-text-secondary mb-1">PICKUP</div>
                <div className="font-medium text-achrams-text-primary">{tripDetails.pickup_address}</div>
              </div>
            </div>
            <div className="flex items-start gap-3">
              <div className="w-2 h-2 bg-achrams-primary-solid rounded-full mt-2 flex-shrink-0"></div>
              <div className="flex-1">
                <div className="text-xs text-achrams-text-secondary mb-1">DESTINATION</div>
                <div className="font-medium text-achrams-text-primary">{tripDetails.destination_address}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

----- FILE: src/components/app/screens/TripProgressScreen.tsx -----
// // src/components/app/screens/TripProgressScreen.tsx
'use client';

import { Shield } from 'lucide-react';
import { GoogleMap, Marker, Polyline, useJsApiLoader } from '@react-google-maps/api';
import { Driver } from '@/types/passenger'; // Assuming this type is defined
import { useState, useEffect } from 'react';

interface TripProgressScreenProps {
  driver: Driver;
  onPanic: () => void;
  onComplete: () => void;
  pickupCoords: [number, number] | null; // NEW: Prop for pickup coordinates
  destinationCoords: [number, number] | null; // NEW: Prop for destination coordinates
  tripProgress: number; // NEW: Prop for simulated progress
}

export default function TripProgressScreen({
  driver,
  onPanic,
  onComplete,
  pickupCoords,
  destinationCoords,
  tripProgress, // NEW: Destructure prop
}: TripProgressScreenProps) {
  const [driverLocation, setDriverLocation] = useState<[number, number] | null>(null); // NEW: State for driver location

  // NEW: Simulate driver movement based on tripProgress
  useEffect(() => {
    if (pickupCoords && destinationCoords) {
      const [startLng, startLat] = pickupCoords;
      const [endLng, endLat] = destinationCoords;

      // Simple linear interpolation for simulation
      const lat = startLat + (endLat - startLat) * (tripProgress / 100);
      const lng = startLng + (endLng - startLng) * (tripProgress / 100);

      setDriverLocation([lng, lat]);
    }
  }, [tripProgress, pickupCoords, destinationCoords]);

  // NEW: Load Google Maps API
  const { isLoaded, loadError } = useJsApiLoader({
    id: 'google-map-script',
    googleMapsApiKey: process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY!,
  });

  // NEW: Determine map center (use driver location if available, otherwise pickup or default)
  let mapCenter = { lat: 6.5244, lng: 3.3792 }; // Default
  if (driverLocation) {
    mapCenter = { lat: driverLocation[1], lng: driverLocation[0] };
  } else if (pickupCoords) {
    mapCenter = { lat: pickupCoords[1], lng: pickupCoords[0] };
  }

  if (loadError) {
    return (
      <div className="h-screen bg-achrams-bg-primary flex flex-col">
        <div className="bg-achrams-primary-solid text-achrams-text-light px-6 py-4">
          <h1 className="text-xl font-bold">Trip in progress</h1>
        </div>
        <div className="flex-1 flex items-center justify-center bg-achrams-bg-secondary">
          <p className="text-achrams-text-secondary">Error loading map: {loadError.message}</p>
        </div>
        <div className="bg-achrams-bg-primary px-6 py-6 border-t border-achrams-border">
          <div className="flex items-center gap-4 mb-4">
            <div className="w-14 h-14 bg-gradient-to-br from-achrams-primary-solid to-achrams-secondary-solid rounded-full flex items-center justify-center text-achrams-text-light text-lg font-bold">
              {driver.initials || driver.name?.charAt(0) || 'D'}
            </div>
            <div>
              <div className="font-bold text-achrams-text-primary">{driver.name}</div>
              <div className="text-sm text-achrams-text-secondary">
                En route to {destinationCoords ? 'your destination' : 'unknown'}
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="h-screen bg-achrams-bg-primary flex flex-col">
      {/* Header */}
      <div className="bg-achrams-primary-solid text-achrams-text-light px-6 py-4 flex items-center justify-between">
        <h1 className="text-xl font-bold">Trip in progress</h1>
        <button
          onClick={onPanic}
          className="w-12 h-12 bg-achrams-bg-primary rounded-full shadow-lg flex items-center justify-center border border-achrams-border hover:bg-achrams-bg-secondary transition-colors"
        >
          <Shield className="w-6 h-6 text-white" />
        </button>
      </div>
      {/* Map Container */}
      <div className="flex-1 relative">
        {isLoaded ? (
          <GoogleMap
            mapContainerStyle={{ width: '100%', height: '100%' }}
            center={mapCenter}
            zoom={14}
            options={{
              // Optional: Disable default UI elements for a cleaner look
              // mapTypeControl: false,
              // streetViewControl: false,
              // fullscreenControl: false,
              // zoomControl: false,
              // Add other map options as needed
            }}
          >
            {/* Pickup Marker */}
            {pickupCoords && (
              <Marker
                position={{ lat: pickupCoords[1], lng: pickupCoords[0] }}
                icon={{
                  url: 'https://maps.google.com/mapfiles/ms/micons/green-dot.png',
                  scaledSize: new window.google.maps.Size(32, 32),
                }}
                title="Pickup Location"
              />
            )}
            {/* Destination Marker */}
            {destinationCoords && (
              <Marker
                position={{ lat: destinationCoords[1], lng: destinationCoords[0] }}
                icon={{
                  url: 'https://maps.google.com/mapfiles/ms/micons/red-dot.png',
                  scaledSize: new window.google.maps.Size(32, 32),
                }}
                title="Destination"
              />
            )}
            {/* Driver Marker */}
            {driverLocation && (
              <Marker
                position={{ lat: driverLocation[1], lng: driverLocation[0] }}
                icon={{
                  url: 'https://maps.google.com/mapfiles/ms/micons/blue-dot.png',
                  scaledSize: new window.google.maps.Size(32, 32),
                }}
                title={`Driver ${driver.name}`}
              />
            )}
            {/* Route Polyline (Optional) */}
            {pickupCoords && destinationCoords && (
              <Polyline
                path={[
                  { lat: pickupCoords[1], lng: pickupCoords[0] },
                  { lat: destinationCoords[1], lng: destinationCoords[0] },
                ]}
                options={{
                  strokeColor: '#FF0000',
                  strokeOpacity: 0.8,
                  strokeWeight: 2,
                }}
              />
            )}
          </GoogleMap>
        ) : (
          <div className="absolute inset-0 flex items-center justify-center bg-achrams-bg-secondary">
            <p className="text-achrams-text-secondary">Loading map...</p>
          </div>
        )}
      </div>
      {/* Driver Info Bar */}
      <div className="bg-achrams-bg-primary px-6 py-6 border-t border-achrams-border">
        <div className="flex items-center gap-4 mb-4">
          <div className="w-14 h-14 bg-gradient-to-br from-achrams-primary-solid to-achrams-secondary-solid rounded-full flex items-center justify-center text-achrams-text-light text-lg font-bold">
            {driver.initials || driver.name?.charAt(0) || 'D'}
          </div>
          <div>
            <div className="font-bold text-achrams-text-primary">{driver.name}</div>
            <div className="text-sm text-achrams-text-secondary">
              En route to {destinationCoords ? 'your destination' : 'unknown'}
            </div>
          </div>
        </div>
        {/* NEW: Progress indicator */}
        <div className="w-full bg-achrams-border rounded-full h-2.5">
          <div
            className="bg-achrams-gradient-primary h-2.5 rounded-full transition-all duration-300"
            style={{ width: `${tripProgress}%` }}
          ></div>
        </div>
        <div className="text-center mt-1 text-sm text-achrams-text-secondary">
          {tripProgress}% Complete
        </div>
      </div>
    </div>
  );
}


// src/components/app/screens/TripProgressScreen.tsx
// 'use client';

// import { Shield } from 'lucide-react';
// import { GoogleMap, Marker, Polyline, useJsApiLoader } from '@react-google-maps/api';
// import { Driver } from '@/types/passenger'; // Assuming this type is defined
// import { useState, useEffect } from 'react';

// interface TripProgressScreenProps {
//   driver: Driver;
//   onPanic: () => void;
//   onComplete: () => void;
//   pickupCoords: [number, number] | null; // NEW: Prop for pickup coordinates
//   destinationCoords: [number, number] | null; // NEW: Prop for destination coordinates
//   tripProgress: number; // NEW: Prop for simulated progress
// }

// export default function TripProgressScreen({
//   driver,
//   onPanic,
//   onComplete,
//   pickupCoords,
//   destinationCoords,
//   tripProgress, // NEW: Destructure prop
// }: TripProgressScreenProps) {
//   const [driverLocation, setDriverLocation] = useState<[number, number] | null>(null); // NEW: State for driver location

//   // NEW: Simulate driver movement based on tripProgress
//   useEffect(() => {
//     if (pickupCoords && destinationCoords) {
//       const [startLng, startLat] = pickupCoords;
//       const [endLng, endLat] = destinationCoords;

//       // Simple linear interpolation for simulation
//       const lat = startLat + (endLat - startLat) * (tripProgress / 100);
//       const lng = startLng + (endLng - startLng) * (tripProgress / 100);

//       setDriverLocation([lng, lat]);
//     }
//   }, [tripProgress, pickupCoords, destinationCoords]);

//   // NEW: Load Google Maps API
//   const { isLoaded, loadError } = useJsApiLoader({
//     id: 'google-map-script',
//     googleMapsApiKey: process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY!,
//   });

//   // NEW: Determine map center (use driver location if available, otherwise pickup or default)
//   let mapCenter = { lat: 6.5244, lng: 3.3792 }; // Default
//   if (driverLocation) {
//     mapCenter = { lat: driverLocation[1], lng: driverLocation[0] };
//   } else if (pickupCoords) {
//     mapCenter = { lat: pickupCoords[1], lng: pickupCoords[0] };
//   }

//   if (loadError) {
//     return (
//       <div className="h-screen bg-achrams-bg-primary flex flex-col">
//         <div className="bg-achrams-primary-solid text-achrams-text-light px-6 py-4">
//           <h1 className="text-xl font-bold">Trip in progress</h1>
//         </div>
//         <div className="flex-1 flex items-center justify-center bg-achrams-bg-secondary">
//           <p className="text-achrams-text-secondary">Error loading map: {loadError.message}</p>
//         </div>
//         <div className="bg-achrams-bg-primary px-6 py-6 border-t border-achrams-border">
//           <div className="flex items-center gap-4 mb-4">
//             <div className="w-14 h-14 bg-gradient-to-br from-achrams-primary-solid to-achrams-secondary-solid rounded-full flex items-center justify-center text-achrams-text-light text-lg font-bold">
//               {driver.initials || driver.name?.charAt(0) || 'D'}
//             </div>
//             <div>
//               <div className="font-bold text-achrams-text-primary">{driver.name}</div>
//               <div className="text-sm text-achrams-text-secondary">
//                 En route to {destinationCoords ? 'your destination' : 'unknown'}
//               </div>
//             </div>
//           </div>
//         </div>
//       </div>
//     );
//   }

//   return (
//     <div className="h-screen bg-achrams-bg-primary flex flex-col">
//       {/* Header */}
//       <div className="bg-achrams-primary-solid text-achrams-text-light px-6 py-4 flex items-center justify-between">
//         <h1 className="text-xl font-bold">Trip in progress</h1>
//         <button
//           onClick={onPanic}
//           className="w-12 h-12 bg-achrams-bg-primary rounded-full shadow-lg flex items-center justify-center border border-achrams-border hover:bg-achrams-bg-secondary transition-colors"
//         >
//           <Shield className="w-6 h-6 text-white" /> {/* Consider changing text color if background is light */}
//         </button>
//       </div>
//       {/* Map Container */}
//       <div className="flex-1 relative">
//         {isLoaded ? (
//           <GoogleMap
//             mapContainerStyle={{ width: '100%', height: '100%' }}
//             center={mapCenter}
//             zoom={14}
//             options={{
//               // Optional: Disable default UI elements for a cleaner look
//               // mapTypeControl: false,
//               // streetViewControl: false,
//               // fullscreenControl: false,
//               // zoomControl: false,
//               // Add other map options as needed
//             }}
//           >
//             {/* Pickup Marker */}
//             {pickupCoords && (
//               <Marker
//                 position={{ lat: pickupCoords[1], lng: pickupCoords[0] }}
//                 // FIXED: Removed trailing spaces from URL
//                 icon={{
//                   url: 'https://maps.google.com/mapfiles/ms/micons/green-dot.png',
//                   scaledSize: new window.google.maps.Size(32, 32),
//                 }}
//                 title="Pickup Location"
//               />
//             )}
//             {/* Destination Marker */}
//             {destinationCoords && (
//               <Marker
//                 position={{ lat: destinationCoords[1], lng: destinationCoords[0] }}
//                 // FIXED: Removed trailing spaces from URL
//                 icon={{
//                   url: 'https://maps.google.com/mapfiles/ms/micons/red-dot.png',
//                   scaledSize: new window.google.maps.Size(32, 32),
//                 }}
//                 title="Destination"
//               />
//             )}
//             {/* Driver Marker */}
//             {driverLocation && (
//               <Marker
//                 position={{ lat: driverLocation[1], lng: driverLocation[0] }}
//                 // FIXED: Removed trailing spaces from URL
//                 icon={{
//                   url: 'https://maps.google.com/mapfiles/ms/micons/blue-dot.png',
//                   scaledSize: new window.google.maps.Size(32, 32),
//                 }}
//                 title={`Driver ${driver.name}`}
//               />
//             )}
//             {/* Route Polyline (Optional) */}
//             {pickupCoords && destinationCoords && (
//               <Polyline
//                 path={[
//                   { lat: pickupCoords[1], lng: pickupCoords[0] },
//                   { lat: destinationCoords[1], lng: destinationCoords[0] },
//                 ]}
//                 options={{
//                   strokeColor: '#FF0000',
//                   strokeOpacity: 0.8,
//                   strokeWeight: 2,
//                 }}
//               />
//             )}
//           </GoogleMap>
//         ) : (
//           <div className="absolute inset-0 flex items-center justify-center bg-achrams-bg-secondary">
//             <p className="text-achrams-text-secondary">Loading map...</p>
//           </div>
//         )}
//       </div>
//       {/* Driver Info Bar */}
//       <div className="bg-achrams-bg-primary px-6 py-6 border-t border-achrams-border">
//         <div className="flex items-center gap-4 mb-4">
//           <div className="w-14 h-14 bg-gradient-to-br from-achrams-primary-solid to-achrams-secondary-solid rounded-full flex items-center justify-center text-achrams-text-light text-lg font-bold">
//             {driver.initials || driver.name?.charAt(0) || 'D'}
//           </div>
//           <div>
//             <div className="font-bold text-achrams-text-primary">{driver.name}</div>
//             <div className="text-sm text-achrams-text-secondary">
//               En route to {destinationCoords ? 'your destination' : 'unknown'}
//             </div>
//           </div>
//         </div>
//         {/* NEW: Progress indicator */}
//         <div className="w-full bg-achrams-border rounded-full h-2.5">
//           <div
//             className="bg-achrams-gradient-primary h-2.5 rounded-full transition-all duration-300"
//             style={{ width: `${tripProgress}%` }}
//           ></div>
//         </div>
//         <div className="text-center mt-1 text-sm text-achrams-text-secondary">
//           {tripProgress}% Complete
//         </div>
//       </div>
//     </div>
//   );
// }

----- FILE: src/components/app/screens/BookingScreen.tsx -----
"use client";
import { useState, useEffect, useRef, useCallback } from "react";
import {
  MapPin,
  Navigation,
  Plane,
  ChevronDown,
  X,
  Loader,
} from "lucide-react";
import { useGeolocation } from "@/hooks/useGeolocation";
import ACHRAMSHeader from "@/components/ui/ACHRAMSHeader";
import { findNearestAirport, Airport } from "@/lib/airports";
import { LoadScript, StandaloneSearchBox } from "@react-google-maps/api";
import AirportSelectionModal from "@/components/app/modals/AirportSelectionModal";
import OutsideServiceAreaModal from "@/components/app/modals/OutsideServiceAreaModal";

interface LocationData {
  name: string;
  coords: [number, number] | null;
}

interface BookingScreenProps {
  pickup: string;
  setPickup: (val: string) => void;
  destination: string;
  setDestination: (val: string) => void;
  fareEstimate: number | null;
  setFareEstimate: (val: number | null) => void;
  onProceed: () => void;
  setShowPassengerDetails: (val: boolean) => void;
  passengerData: any;
  setPassengerData: (val: any) => void;
  showPassengerDetails: boolean;
  requirements: any;
  setRequirements: (val: any) => void;
  setPickupCoords: (coords: [number, number] | null) => void;
  setDestinationCoords: (coords: [number, number] | null) => void;
  tripRequestStatus: 'loading' | 'accepted' | 'no-driver' | 'error' | null;
}

const losCoords: [number, number] = [3.330058, 6.568287];
const abvCoords: [number, number] = [7.2667, 9.0167];

const airports = [
  { id: "current", name: "Use my current location", special: true },
  { id: "los", name: "Murtala Muhammed Int'l Airport (LOS)", city: "Lagos" },
  { id: "abv", name: "Nnamdi Azikiwe Int'l Airport (ABV)", city: "Abuja" },
];

const destinationCoordsMap: Record<string, [number, number] | null> = {
  "Victoria Island, Lagos": [3.4084, 6.4397],
  "Lekki Phase 1, Lagos": [3.9942, 6.4253],
  "Ikeja GRA, Lagos": [3.3519, 6.555],
  "Ikorodu, Lagos": [3.504145, 6.620891],
};

const GOOGLE_MAPS_API_KEY = process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY!;
const libraries: ("places")[] = ["places"];

// Custom debounce hook (lightweight & stable)
function useDebounceCallback<T extends (...args: any[]) => any>(
  callback: T,
  delay: number
) {
  const timeoutRef = useRef<NodeJS.Timeout | null>(null);

  useEffect(() => {
    return () => {
      if (timeoutRef.current) clearTimeout(timeoutRef.current);
    };
  }, []);

  return useCallback(
    ((...args: Parameters<T>) => {
      if (timeoutRef.current) clearTimeout(timeoutRef.current);
      timeoutRef.current = setTimeout(() => {
        callback(...args);
      }, delay);
    }) as T,
    [callback, delay]
  );
}

export default function BookingScreen({
  pickup,
  setPickup,
  destination,
  setDestination,
  fareEstimate,
  setFareEstimate,
  onProceed,
  setPickupCoords,
  setDestinationCoords,
  tripRequestStatus,
}: BookingScreenProps) {
  const [pickupOpen, setPickupOpen] = useState(false);
  const [destOpen, setDestOpen] = useState(false);
  const [showAirportSelectionModal, setShowAirportSelectionModal] = useState(false);
  const [airportsToSelect, setAirportsToSelect] = useState<Airport[]>([]);
  const [showOutsideServiceModal, setShowOutsideServiceModal] = useState(false);
  const [showLocationSettingsModal, setShowLocationSettingsModal] = useState(false);

  const searchBoxRef = useRef<google.maps.places.SearchBox | null>(null);
  const destinationInputRef = useRef<HTMLInputElement>(null);

  const { coords, error, requestPermission, loading: hookLoading } = useGeolocation();
  const [isFetchingLocation, setIsFetchingLocation] = useState(false);

  const [pickupLocationData, setPickupLocationData] = useState<LocationData>({
    name: pickup,
    coords: null,
  });

  const [destinationLocationData, setDestinationLocationData] = useState<LocationData>({
    name: destination,
    coords: null,
  });

 
  
  // Sync local state  parent
  useEffect(() => {
    setPickup(pickupLocationData.name);
    setPickupCoords(pickupLocationData.coords);
  }, [pickupLocationData, setPickup, setPickupCoords]);

  useEffect(() => {
    setDestination(destinationLocationData.name);
    setDestinationCoords(destinationLocationData.coords);
  }, [destinationLocationData, setDestination, setDestinationCoords]);

  // Fare estimate mock (replace with API later)
  useEffect(() => {
    if (pickupLocationData.name && destinationLocationData.name) {
      const estimate = 4500 + Math.floor(Math.random() * 2000);
      setFareEstimate(estimate);
    } else {
      setFareEstimate(null);
    }
  }, [pickupLocationData, destinationLocationData, setFareEstimate]);

  // Reset fetching state when trip request ends
  useEffect(() => {
    if (tripRequestStatus !== "loading") {
      setIsFetchingLocation(false);
    }
  }, [tripRequestStatus]);

  const showFetchingUI = isFetchingLocation || hookLoading;

  // Stable debounced handler
  const debouncedDestinationInput = useDebounceCallback((value: string) => {
    console.log("Destination input settled:", value);
    // Add custom logic here if needed (e.g. fallback API search)
  }, 300);

  // Stable change handler
  const handleDestinationChanged = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;
    setDestinationLocationData(prev => ({ ...prev, name: value }));
    if (value.trim()) {
      setDestOpen(true);
    }
    debouncedDestinationInput(value);
  }, [debouncedDestinationInput]);

  // Stable place selection handler
  const handlePlaceChanged = useCallback(() => {
    if (!searchBoxRef.current) return;

    const places = searchBoxRef.current.getPlaces();
    if (!places || places.length === 0) return;

    const place = places[0];
    if (place.geometry?.location) {
      const lat = place.geometry.location.lat();
      const lng = place.geometry.location.lng();
      const formattedAddress = place.formatted_address || place.name || "";

      setDestinationLocationData({
        name: formattedAddress,
        coords: [lng, lat],
      });
      setDestOpen(false);
    }
  }, []);

  const handleClearDestination = useCallback(() => {
    setDestinationLocationData({ name: "", coords: null });
    setDestOpen(false);
    destinationInputRef.current?.focus();
  }, []);

  const handleUseCurrentLocation = useCallback(async () => {
    if (error?.includes("denied")) {
      setShowLocationSettingsModal(true);
      setPickupOpen(false);
      return;
    }

    setIsFetchingLocation(true);
    setPickupOpen(false);

    try {
      const position = await requestPermission();
      if (!position) throw new Error("No coordinates");

      const { longitude, latitude } = position;
      const airports = await findNearestAirport(longitude, latitude);

      if (airports && airports.length > 0) {
        if (airports.length === 1) {
          setPickupLocationData({
            name: airports[0].name,
            coords: [longitude, latitude],
          });
        } else {
          setAirportsToSelect(airports);
          setShowAirportSelectionModal(true);
        }
      } else {
        setShowOutsideServiceModal(true);
      }
    } catch (err) {
      console.error("Location fetch failed:", err);
    } finally {
      setIsFetchingLocation(false);
    }
  }, [error, requestPermission]);

  const handleAirportSelectedFromModal = useCallback((airport: Airport) => {
    setPickupLocationData(prev => ({
      name: airport.name,
      coords: prev.coords, // retain geolocation coords
    }));
    setShowAirportSelectionModal(false);
  }, []);

  const handleAirportSelect = useCallback((airportId: string) => {
    const map: Record<string, { name: string; coords: [number, number] }> = {
      los: { name: "Murtala Muhammed Int'l Airport (LOS)", coords: losCoords },
      abv: { name: "Nnamdi Azikiwe Int'l Airport (ABV)", coords: abvCoords },
    };

    const selected = map[airportId];
    if (selected) {
      setPickupLocationData({
        name: selected.name,
        coords: selected.coords,
      });
    }
    setPickupOpen(false);
  }, []);

  return (
    <div className="h-screen bg-achrams-bg-primary flex flex-col">
      <AirportSelectionModal
        isOpen={showAirportSelectionModal}
        onClose={() => setShowAirportSelectionModal(false)}
        airports={airportsToSelect}
        onSelect={handleAirportSelectedFromModal}
      />
      <OutsideServiceAreaModal
        isOpen={showOutsideServiceModal}
        onClose={() => setShowOutsideServiceModal(false)}
      />

      <div className="bg-achrams-primary-solid text-achrams-text-light px-0 py-4">
        <div className="px-6">
          <ACHRAMSHeader title="" />
        </div>
      </div>

      {error?.includes("denied") && (
        <div className="bg-blue-600 text-achrams-text-light p-3 flex items-center justify-between">
          <div className="flex items-center gap-2">
            <Navigation className="w-5 h-5" />
            <span>This app requires your location access to work</span>
          </div>
          <button
            onClick={() => setShowLocationSettingsModal(true)}
            className="bg-white text-achrams-text-primary px-4 py-1 rounded-full text-sm font-medium hover:bg-achrams-bg-primary"
          >
            Grant access
          </button>
        </div>
      )}

      {showLocationSettingsModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg p-6 max-w-md w-full">
            <h3 className="text-lg font-semibold mb-2">Enable Location Access</h3>
            <p className="mb-4">Please allow location access in your browser settings.</p>
            <ol className="list-decimal list-inside mb-4 space-y-1 text-sm">
              <li>Click the lock/info icon in the address bar</li>
              <li>Go to "Site settings"  "Location"  Allow</li>
              <li>Refresh the page</li>
            </ol>
            <button
              onClick={() => setShowLocationSettingsModal(false)}
              className="w-full bg-achrams-primary-solid text-white py-2 rounded-lg"
            >
              Close
            </button>
          </div>
        </div>
      )}

      <div className="flex-1 px-6 py-8 overflow-y-auto">
        <h2 className="text-2xl font-semibold tracking-tight text-achrams-text-primary pb-4">
          Book Your Airport Ride
        </h2>

        <div className="space-y-4">
          {/* Pickup */}
          <div className="relative">
            <div className="flex items-center gap-3 bg-achrams-bg-secondary rounded-xl px-4 py-4 border border-achrams-border">
              <div className="w-2 h-2 bg-achrams-primary-solid rounded-full" />
              <input
                type="text"
                placeholder="Airport pickup location"
                value={showFetchingUI ? "Getting your location..." : pickupLocationData.name}
                onChange={(e) => !showFetchingUI && setPickupLocationData(prev => ({ ...prev, name: e.target.value }))}
                onFocus={() => !showFetchingUI && setPickupOpen(true)}
                readOnly={showFetchingUI}
                className={`flex-1 bg-transparent outline-none text-base ${
                  showFetchingUI ? "text-achrams-text-secondary italic" : "text-achrams-text-primary"
                }`}
              />
              <button
                onClick={() => !showFetchingUI && setPickupOpen(!pickupOpen)}
                disabled={showFetchingUI}
                className={`p-2 transition-colors ${
                  showFetchingUI
                    ? "text-achrams-text-secondary opacity-50 cursor-not-allowed"
                    : "text-achrams-text-secondary hover:text-achrams-text-primary"
                }`}
              >
                {showFetchingUI ? (
                  <Loader className="w-5 h-5 animate-spin text-achrams-primary-solid" />
                ) : pickupOpen ? (
                  <ChevronDown className="w-5 h-5" />
                ) : (
                  <Navigation className="w-5 h-5" />
                )}
              </button>
            </div>

            {pickupOpen && (
              <div className="absolute top-full left-0 right-0 mt-1 bg-white rounded-xl shadow-lg border border-achrams-border z-50 max-h-64 overflow-y-auto">
                {showFetchingUI ? (
                  <div className="px-4 py-3 flex items-center gap-3 text-achrams-text-secondary">
                    <Loader className="w-5 h-5 animate-spin" />
                    <span>Locating you...</span>
                  </div>
                ) : (
                  <>
                    <button
                      onClick={handleUseCurrentLocation}
                      className="w-full px-4 py-3 flex items-center gap-3 hover:bg-achrams-bg-secondary border-b border-achrams-border text-left"
                    >
                      <MapPin className="w-5 h-5 text-achrams-primary-solid" />
                      <span>Use my current location</span>
                    </button>
                    {airports.slice(1).map((a) => (
                      <button
                        key={a.id}
                        onClick={() => handleAirportSelect(a.id)}
                        className="w-full px-4 py-3 flex items-start gap-3 hover:bg-achrams-bg-secondary border-b border-achrams-border text-left"
                      >
                        <Plane className="w-5 h-5 text-achrams-primary-solid mt-0.5" />
                        <div>
                          <div className="font-medium text-sm">{a.name}</div>
                          <div className="text-xs text-achrams-text-secondary">{a.city}</div>
                        </div>
                      </button>
                    ))}
                  </>
                )}
              </div>
            )}
          </div>

          <div className="flex justify-center py-1">
            <div className="w-0.5 h-6 bg-achrams-border" />
          </div>

          {/* Destination */}
          <div className="relative">
            <LoadScript googleMapsApiKey={GOOGLE_MAPS_API_KEY} libraries={libraries}>
              <StandaloneSearchBox
                onLoad={(ref) => (searchBoxRef.current = ref)}
                onPlacesChanged={handlePlaceChanged}
              >
                <div className="flex items-center gap-3 bg-achrams-bg-secondary rounded-xl px-4 py-4 border border-achrams-border">
                  <div className="w-2 h-2 bg-achrams-primary-solid rounded-full" />
                  <input
                    ref={destinationInputRef}
                    type="text"
                    placeholder="Enter destination"
                    value={destinationLocationData.name}
                    onChange={handleDestinationChanged}
                    onFocus={() => destinationLocationData.name && setDestOpen(true)}
                    className="flex-1 bg-transparent outline-none text-base text-achrams-text-primary"
                  />
                  {destOpen && destinationLocationData.name && (
                    <button
                      onClick={handleClearDestination}
                      className="p-2 text-achrams-text-secondary hover:text-achrams-text-primary"
                    >
                      <X className="w-5 h-5" />
                    </button>
                  )}
                </div>
              </StandaloneSearchBox>
            </LoadScript>
          </div>
        </div>

        {fareEstimate && (
          <div className="mt-6 p-4 bg-achrams-bg-secondary rounded-xl border border-achrams-border">
            <div className="flex justify-between items-center">
              <span className="text-achrams-text-secondary">Estimated fare</span>
              <span className="text-xl font-bold text-achrams-text-primary">
                {fareEstimate.toLocaleString()}
              </span>
            </div>
          </div>
        )}
      </div>

      <div className="p-6">
        <button
          onClick={onProceed}
          disabled={!fareEstimate}
          className={`w-full py-4 rounded-xl text-lg font-bold text-achrams-text-light transition-all ${
            fareEstimate
              ? "bg-achrams-gradient-primary hover:opacity-95 active:scale-[0.98] shadow-md"
              : "bg-achrams-secondary-solid opacity-75 cursor-not-allowed"
          }`}
        >
          {fareEstimate ? `Proceed  ${fareEstimate.toLocaleString()}` : "Enter destinations"}
        </button>
      </div>
    </div>
  );
}


// // src/components/app/screens/BookingScreen.tsx
// "use client";

// import { useState, useEffect, useRef } from "react";
// import {
//   MapPin,
//   Navigation,
//   Plane,
//   ChevronDown,
//   X,
//   Loader,
// } from "lucide-react";
// import { useGeolocation } from "@/hooks/useGeolocation";
// import ACHRAMSHeader from "@/components/ui/ACHRAMSHeader";
// import { findNearestAirport, Airport } from "@/lib/airports"; // NEW: Import Airport type
// import { LoadScript, StandaloneSearchBox } from "@react-google-maps/api"; // NEW: Import Google Maps components
// import AirportSelectionModal from "@/components/app/modals/AirportSelectionModal"; // NEW: Import the new modal
// import OutsideServiceAreaModal from "@/components/app/modals/OutsideServiceAreaModal"; // NEW: Import the new modal

// // NEW: Define type for location data
// interface LocationData {
//   name: string;
//   coords: [number, number] | null; // [lng, lat]
// }

// interface BookingScreenProps {
//   pickup: string;
//   setPickup: (val: string) => void;
//   destination: string;
//   setDestination: (val: string) => void;
//   fareEstimate: number | null;
//   setFareEstimate: (val: number | null) => void;
//   onProceed: () => void;
//   setShowPassengerDetails: (val: boolean) => void;
//   passengerData: any;
//   setPassengerData: (val: any) => void;
//   showPassengerDetails: boolean;
//   requirements: any;
//   setRequirements: (val: any) => void;
//   // NEW: Prop to set pickup coordinates in parent (page.tsx)
//   setPickupCoords: (coords: [number, number] | null) => void;
//   // NEW: Prop to set destination coordinates in parent (page.tsx)
//   setDestinationCoords: (coords: [number, number] | null) => void;
// }

// // NEW: Define coordinates for airports (replace with actual coordinates)
// const losCoords: [number, number] = [3.330058, 6.568287]; // Actual coord from API doc
// const abvCoords: [number, number] = [7.2667, 9.0167]; // Placeholder, find actual

// const airports = [
//   { id: "current", name: "Use my current location", special: true },
//   { id: "los", name: "Murtala Muhammed Int'l Airport (LOS)", city: "Lagos" },
//   { id: "abv", name: "Nnamdi Azikiwe Int'l Airport (ABV)", city: "Abuja" },
// ];

// // NEW: Placeholder coordinates for common destinations (find actual coords)
// // This map is now primarily used for the simple destination dropdown suggestions.
// // For real coordinates, Google Maps Autocomplete is preferred.
// const destinationCoordsMap: Record<string, [number, number] | null> = {
//   "Victoria Island, Lagos": [3.4084, 6.4397],
//   "Lekki Phase 1, Lagos": [3.9942, 6.4253],
//   "Ikeja GRA, Lagos": [3.3519, 6.555],
//   "Ikorodu, Lagos": [3.504145, 6.620891], // From API doc
//   // Add more as needed
// };

// // NEW: Google Maps API Key (ensure it's available in environment)
// const GOOGLE_MAPS_API_KEY = process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY!;

// export default function BookingScreen({
//   pickup,
//   setPickup,
//   destination,
//   setDestination,
//   fareEstimate,
//   setFareEstimate,
//   onProceed,
//   setShowPassengerDetails,
//   passengerData,
//   setPassengerData,
//   showPassengerDetails,
//   requirements,
//   setRequirements,
//   setPickupCoords,
//   setDestinationCoords,
//   onShowLocationModal, // NEW: Destructure the prop
// }: BookingScreenProps) {
//   const [pickupOpen, setPickupOpen] = useState(false);
//   const [destOpen, setDestOpen] = useState(false);
//   // NEW: State for airport selection modal
//   const [showAirportSelectionModal, setShowAirportSelectionModal] = useState(false);
//   const [airportsToSelect, setAirportsToSelect] = useState<Airport[]>([]);
//   // NEW: State for outside service area modal
//   const [showOutsideServiceModal, setShowOutsideServiceModal] = useState(false); // NEW
//   // NEW: Ref for the destination search box
//   const searchBoxRef = useRef<google.maps.places.SearchBox | null>(null);
//   const [showLocationSettingsModal, setShowLocationSettingsModal] = useState(false); // NEW: State for instructions modal

//   // NEW: Destructure loading state from the hook
//   const {
//     coords,
//     error,
//     requestPermission,
//     loading: hookLoading,
//   } = useGeolocation();

//   // NEW: State to track if location is being fetched (combines hook loading and UI state)
//   const [isFetchingLocation, setIsFetchingLocation] = useState(false);

//   // NEW: State to hold full pickup location data including coordinates
//   const [pickupLocationData, setPickupLocationData] = useState<LocationData>({
//     name: pickup,
//     coords: null,
//   });

//   // NEW: State to hold full destination location data including coordinates
//   const [destinationLocationData, setDestinationLocationData] =
//     useState<LocationData>({
//       name: destination,
//       coords: null,
//     });


//   // NEW: Effect to watch for geolocation errors and trigger the banner display


//   // NEW: Sync pickupLocationData.name with the parent's pickup state if it changes externally
//   useEffect(() => {
//     setPickupLocationData((prev) => ({ ...prev, name: pickup }));
//   }, [pickup]);

//   // NEW: Sync destinationLocationData.name with the parent's destination state if it changes externally
//   useEffect(() => {
//     setDestinationLocationData((prev) => ({ ...prev, name: destination }));
//   }, [destination]);

//   // NEW: Sync parent's pickup and pickupCoords states when pickupLocationData changes
//   useEffect(() => {
//     setPickup(pickupLocationData.name);
//     setPickupCoords(pickupLocationData.coords);
//   }, [pickupLocationData, setPickup, setPickupCoords]);

//   // NEW: Sync parent's destination and destinationCoords states when destinationLocationData changes
//   useEffect(() => {
//     setDestination(destinationLocationData.name);
//     setDestinationCoords(destinationLocationData.coords);
//   }, [destinationLocationData, setDestination, setDestinationCoords]);

//   // NEW: Sync parent's fareEstimate when pickupLocationData or destinationLocationData changes
//   // This is a placeholder. In a real implementation, you would call GET /v1/fares/lookup here.
//   useEffect(() => {
//     if (destinationLocationData.name && pickupLocationData.name) {
//       // Example: Call fare lookup API when both locations are set
//       // fetchFareEstimate(pickupLocationData, destinationLocationData).then(setFareEstimate);
//       // For now, keep the existing mock logic or remove it if using API call exclusively
//       const estimate = 4500 + Math.floor(Math.random() * 2000);
//       setFareEstimate(estimate);
//     } else {
//       setFareEstimate(null);
//     }
//   }, [destinationLocationData, pickupLocationData, setFareEstimate]);

//   // NEW: Updated handleUseCurrentLocation function
//   const handleUseCurrentLocation = async () => {
//     // NEW: Check if permission was previously denied or if error indicates need for modal
//     if (error && (error.includes("denied") || error.includes("Permission denied"))) {
//       console.log(error);
//       console.log("Location permission denied, showing modal.");
//     // Trigger parent to show the modal
//       setPickupOpen(false); // Close dropdown
//       return;
//     }

    

//     // NEW: Set fetching state and close dropdown immediately
//     setIsFetchingLocation(true);
//     setPickupOpen(false); // Close dropdown when fetching starts

   

//     try {
//       // NEW: Await the result of requestPermission
//       const fetchedCoords = await requestPermission();
//       // NEW: Check if coords were successfully obtained
//       if (fetchedCoords) {
//         // NEW: Call /v1/airports/by-location to resolve the airport
//         const foundAirports = await findNearestAirport(
//           fetchedCoords.longitude,
//           fetchedCoords.latitude
//         );

//         if (foundAirports && Array.isArray(foundAirports) && foundAirports.length > 0) {
//             if (foundAirports.length === 1) {
//                 // If only one airport found, use it directly
//                 setPickupLocationData({
//                     name: foundAirports[0].name, // e.g., "Murtala Muhammed International Airport"
//                     coords: [fetchedCoords.longitude, fetchedCoords.latitude],
//                 });
//             } else {
//                 // If multiple airports found, show the selection modal
//                 setAirportsToSelect(foundAirports);
//                 setShowAirportSelectionModal(true);
//             }
//         } else {
//           // Handle case where no airport is found near the location (foundAirports is null or [])
//           console.warn("No ACHRAMS airport found near the current location.");
//           // NEW: Show the specific modal for this scenario
//           setShowOutsideServiceModal(true);
//           // NEW: Do NOT clear pickupLocationData here, let the modal handle user dismissal
//           // setPickupLocationData({ name: "", coords: null }); // Remove this line
//         }
//       } else {
//         // NEW: Handle case where request was granted but coords were null (unlikely but possible)
//         console.warn(
//           "Geolocation request granted but no coordinates returned."
//         );
//         // Optionally update UI to show a generic error or retry option
//         // setPickupLocationData({ name: "", coords: null }); // Or clear if needed for other errors
//       }
//     } catch (err) {
//       console.error("Geolocation request or API call failed:", err);
//       // NEW: Optionally update UI to show the error from the hook or a generic message
//       // setErrorState("Failed to get location: " + err);
//       // setPickupLocationData({ name: "", coords: null }); // Or clear on generic error
//     } finally {
//       // NEW: Always stop fetching state when done (success or failure)
//       setIsFetchingLocation(false);
//     }
//   };

//   // NEW: Handle airport selection from the modal
//   const handleAirportSelectedFromModal = (selectedAirport: Airport) => {
//     // Use the coordinates from the geolocation request and the name/ID from the selected airport
//     setPickupLocationData({
//       name: selectedAirport.name,
//       coords: pickupLocationData.coords, // Use the coords obtained from geolocation
//     });
//     // The airport ID (selectedAirport.id) is now resolved and can be used
//     // in handleRequestRide in page.tsx for the booking API call.
//   };

//   const handleAirportSelect = (airportId: string) => {
//     let selectedCoords: [number, number] | null = null;
//     let selectedName = "";

//     switch (airportId) {
//       case "los":
//         selectedCoords = losCoords;
//         selectedName = "Murtala Muhammed Int'l Airport (LOS)";
//         break;
//       case "abv":
//         selectedCoords = abvCoords;
//         selectedName = "Nnamdi Azikiwe Int'l Airport (ABV)";
//         break;
//       default:
//         selectedName = "Unknown Airport";
//     }

//     if (selectedCoords) {
//       setPickupLocationData({
//         name: selectedName,
//         coords: selectedCoords,
//       });
//     }
//     setPickupOpen(false);
//   };

//   // NEW: Handle destination selection from simple dropdown (fallback)
//   const handleDestinationSelect = (selectedDestination: string) => {
//     // NEW: In a real implementation with autocomplete, the coordinates would come from the autocomplete result
//     // For now, use the map or set to null if not found
//     const selectedCoords = destinationCoordsMap[selectedDestination] || null;
//     setDestinationLocationData({
//       name: selectedDestination,
//       coords: selectedCoords,
//     });
//     setDestOpen(false);
//   };

//   // NEW: Handle destination changes from Google Maps Autocomplete
//   const handleDestinationChanged = (e: any) => { // 'e' is the event from StandaloneSearchBox
//     // Update local state name immediately as user types
//     setDestinationLocationData((prev) => ({ ...prev, name: e.target.value }));
//     setDestOpen(true); // Keep dropdown open while typing/searching
//   };

//   // NEW: Handle when a place is selected from the autocomplete dropdown
//   const handlePlaceChanged = () => {
//     if (searchBoxRef.current) {
//       const places = searchBoxRef.current.getPlaces();
//       if (places && places.length > 0) {
//         const place = places[0];
//         if (place.geometry && place.geometry.location) {
//           const lat = place.geometry.location.lat();
//           const lng = place.geometry.location.lng();
//           setDestinationLocationData({
//             name: place.formatted_address || place.name || "", // Prefer formatted address, fallback to name
//             coords: [lng, lat], // [longitude, latitude]
//           });
//           setDestOpen(false); // Close the dropdown after selection
//         } else {
//           console.error("Place selected but no geometry.location found.");
//         }
//       } else {
//           console.log("No places found from search box.");
//           // Optionally clear coordinates if user clears the input and presses enter/selects nothing
//           // setDestinationLocationData(prev => ({ ...prev, coords: null }));
//       }
//     }
//   };

//     const handleGrantAccessClick = () => {
//     // The browser prompt won't show again if previously denied.
//     // Show an instruction modal to guide the user.
//     setShowLocationSettingsModal(true);
//   }

//   // NEW: Combine internal fetching state with hook's loading state for UI
//   const showFetchingUI = isFetchingLocation || hookLoading;

//   return (
//     <div className="h-screen bg-achrams-bg-primary flex flex-col">
//       {/* NEW: Airport Selection Modal */}
//       <AirportSelectionModal
//         isOpen={showAirportSelectionModal}
//         onClose={() => setShowAirportSelectionModal(false)}
//         airports={airportsToSelect}
//         onSelect={handleAirportSelectedFromModal}
//       />
//       {/* NEW: Outside Service Area Modal */}
//       <OutsideServiceAreaModal
//         isOpen={showOutsideServiceModal}
//         onClose={() => setShowOutsideServiceModal(false)} // Close the modal
//       />


//       {/* Header container now spans full width with no horizontal padding */}
//       <div className="bg-achrams-primary-solid text-achrams-text-light px-0 py-4">
//         <div className="px-6">
//           <ACHRAMSHeader title="" />
//         </div>
//       </div>
//      {error && (error.includes("denied") || error.includes("Permission denied")) && (
//   // NEW BASED ON LATEST PROMPT: Use bg-amber-500 instead of bg-blue-600 or bg-achrams-primary-solid to avoid header clash
//   <div className="bg-blue-600 text-achrams-text-light p-3 flex items-center justify-between"> 
//     <div className="flex items-center gap-2">
//       <Navigation className="w-5 h-5" />
//       <span>This app requires your location access to work</span>
//     </div>
//     {/* NEW BASED ON LATEST PROMPT: Use achrams-bg-secondary and achrams-text-light for the button */}
//     <button
//       onClick={handleGrantAccessClick} 
//       className="bg-white text-achrams-text-primary px-4 py-1 rounded-full text-sm font-medium hover:bg-achrams-bg-primary" // NEW BASED ON LATEST PROMPT: Adjusted button style for contrast
//     >
//       Grant access
//     </button>
//   </div>
// )}

//        {showLocationSettingsModal && (
//         <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
//           <div className="bg-white rounded-lg p-6 max-w-md w-full">
//             <h3 className="text-lg font-semibold mb-2">Enable Location Access</h3>
//             <p className="mb-4">
//               To use this feature, please allow location access in your browser settings.
//             </p>
//             <ol className="list-decimal list-inside mb-4 space-y-1 text-sm">
//               <li>Click the lock icon or info icon in the address bar.</li>
//               <li>Select "Site settings" or "Permissions".</li>
//               <li>Find "Location" and change it to "Allow".</li>
//               <li>Refresh the page or try again.</li>
//             </ol>
//             <button
//               onClick={() => setShowLocationSettingsModal(false)}
//               className="w-full bg-achrams-primary-solid text-white py-2 rounded-lg"
//             >
//               Close
//             </button>
//           </div>
//         </div>
//       )}
//       <div className="flex-1 px-6 py-8 overflow-y-auto">
//         <h2 className="text-2xl font-semibold tracking-tight text-achrams-text-primary pb-4">
//           Book Your Airport Ride
//         </h2>

//         <div className="space-y-4">
//           {/* Pickup */}
//           <div className="relative">
//             {/* Main Input Field */}
//             <div className="flex items-center gap-3 bg-achrams-bg-secondary rounded-xl px-4 py-4 border border-achrams-border">
//               <div className="w-2 h-2 bg-achrams-primary-solid rounded-full" />
//               <input
//                 type="text"
//                 placeholder="Airport pickup location"
//                 // NEW: Show fetching message or actual name, make read-only if fetching
//                 value={
//                   showFetchingUI
//                     ? "Getting your location..."
//                     : pickupLocationData.name
//                 }
//                 // NEW: Disable input while fetching
//                 onChange={(e) => {
//                   if (!showFetchingUI) {
//                     setPickupLocationData((prev) => ({
//                       ...prev,
//                       name: e.target.value,
//                     }));
//                   }
//                 }}
//                 onFocus={() => {
//                   if (!showFetchingUI) {
//                     setPickupOpen(true);
//                   }
//                 }}
//                 // NEW: Show read-only state while fetching
//                 readOnly={showFetchingUI}
//                 className={`flex-1 bg-transparent outline-none text-base ${
//                   // NEW: Apply different text color when fetching to indicate disabled state
//                   showFetchingUI
//                     ? "text-achrams-text-secondary italic"
//                     : "text-achrams-text-primary"
//                 }`}
//               />
//               {/* Dropdown/Open Button */}
//               <div className="flex items-center">
//                 {/* NEW: Show loader next to dropdown button while fetching, disable button */}
//                 {showFetchingUI && (
//                   <Loader className="w-5 h-5 animate-spin text-achrams-primary-solid mr-1" />
//                 )}
//                 <button
//                   onClick={() => {
//                     if (!showFetchingUI) {
//                       setPickupOpen(!pickupOpen);
//                     }
//                   }}
//                   disabled={showFetchingUI} // NEW: Disable button while fetching
//                   className={`p-2 ${
//                     // NEW: Apply different text color and cursor when disabled
//                     showFetchingUI
//                       ? "text-achrams-text-secondary opacity-50 cursor-not-allowed"
//                       : "text-achrams-text-secondary hover:text-achrams-text-primary"
//                   } transition-colors`}
//                 >
//                   {/* NEW: Show spinner inside button instead of Navigation icon while fetching */}
//                   {showFetchingUI ? (
//                     <Loader className="w-5 h-5 animate-spin text-achrams-primary-solid" />
//                   ) : pickupOpen ? (
//                     <ChevronDown className="w-5 h-5" />
//                   ) : (
//                     <Navigation className="w-5 h-5" />
//                   )}
//                 </button>
//               </div>
//             </div>

//             {/* Dropdown Content */}
//             {pickupOpen && (
//               <div className="absolute top-full left-0 right-0 mt-1 bg-white rounded-xl shadow-lg border border-achrams-border z-50 max-h-64 overflow-y-auto">
//                 {/* NEW: Show fetching indicator if loading, otherwise show options */}
//                 {showFetchingUI ? (
//                   <div className="w-full px-4 py-3 flex items-center gap-3 justify-center text-achrams-text-secondary">
//                     <Loader className="w-5 h-5 animate-spin mr-2" />
//                     <span>Locating you...</span>{" "}
//                     {/* NEW: Professional message */}
//                   </div>
//                 ) : (
//                   <>
//                     <button
//                       onClick={handleUseCurrentLocation}
//                       disabled={showFetchingUI} // NEW: Disable button while fetching (shouldn't be reachable here, but good practice)
//                       className="w-full px-4 py-3 flex items-center gap-3 hover:bg-achrams-bg-secondary border-b border-achrams-border text-left disabled:opacity-50 disabled:cursor-not-allowed" // NEW: Add disabled styles
//                     >
//                       <MapPin className="w-5 h-5 text-achrams-primary-solid flex-shrink-0" />
//                       <span>Use my current location</span>
//                     </button>
//                     {/* ... Other Airport Buttons ... */}
//                     {airports.slice(1).map((a) => (
//                       <button
//                         key={a.id}
//                         onClick={() => handleAirportSelect(a.id)} // Use new handler
//                         className="w-full px-4 py-3 flex items-start gap-3 hover:bg-achrams-bg-secondary border-b border-achrams-border text-left"
//                       >
//                         <Plane className="w-5 h-5 text-achrams-primary-solid flex-shrink-0 mt-0.5" />
//                         <div>
//                           <div className="font-medium text-achrams-text-primary text-sm">
//                             {a.name}
//                           </div>
//                           <div className="text-xs text-achrams-text-secondary">
//                             {a.city}
//                           </div>
//                         </div>
//                       </button>
//                     ))}
//                   </>
//                 )}
//               </div>
//             )}
//           </div>

//           <div className="flex items-center justify-center py-1">
//             <div className="w-0.5 h-6 bg-achrams-border" />
//           </div>

//           {/* Destination */}
//           <div className="relative">
//             {/* NEW: Wrap destination input with LoadScript and StandaloneSearchBox */}
//             <LoadScript
//               googleMapsApiKey={GOOGLE_MAPS_API_KEY}
//               libraries={["places"]}
//             >
//               <StandaloneSearchBox
//                 onLoad={(ref) => {
//                   searchBoxRef.current = ref; // Store the reference
//                 }}
//                 onUnmount={() => {
//                   searchBoxRef.current = null; // Clean up reference
//                 }}
//                 onPlacesChanged={handlePlaceChanged} // Handle place selection
//               >
//                 <div className="flex items-center gap-3 bg-achrams-bg-secondary rounded-xl px-4 py-4 border border-achrams-border">
//                   <div className="w-2 h-2 bg-achrams-primary-solid rounded-full" />
//                   <input
//                     type="text"
//                     placeholder="Enter destination"
//                     value={destinationLocationData.name} // NEW: Use name from local state
//                     onChange={handleDestinationChanged} // NEW: Handle input change for autocomplete
//                     onFocus={() => setDestOpen(true)} // NEW: Open dropdown on focus
//                     className="flex-1 bg-transparent outline-none text-base text-achrams-text-primary"
//                   />
//                   {destOpen &&
//                     destinationLocationData.name && ( // NEW: Use local state
//                       <button
//                         onClick={() => {
//                           setDestinationLocationData({ name: "", coords: null }); // NEW: Clear local state
//                           setDestination(""); // NEW: Clear parent state
//                         }}
//                         className="p-2 text-achrams-text-secondary hover:text-achrams-text-primary transition-colors"
//                       >
//                         <X className="w-5 h-5" />
//                       </button>
//                     )}
//                 </div>
//               </StandaloneSearchBox>
//             </LoadScript>
//             {/* NEW: Dropdown for simple destination suggestions (fallback if autocomplete not used) */}
//             {/* This is now hidden when the search box is active, but could be shown if needed */}
//             {destOpen &&
//               destinationLocationData.name &&
//               !searchBoxRef.current && ( // NEW: Only show if search box ref is not active (fallback logic)
//                 <div className="absolute top-full left-0 right-0 mt-1 bg-white rounded-xl shadow-lg border border-achrams-border z-50 max-h-64 overflow-y-auto">
//                   {Object.keys(destinationCoordsMap)
//                     .filter((d) =>
//                       d
//                         .toLowerCase()
//                         .includes(destinationLocationData.name.toLowerCase())
//                     )
//                     .map((d, i) => (
//                       <button
//                         key={i}
//                         onClick={() => handleDestinationSelect(d)} // NEW: Use new handler
//                         className="w-full px-4 py-3 flex items-center gap-3 hover:bg-achrams-bg-secondary border-b border-achrams-border text-left"
//                       >
//                         <MapPin className="w-5 h-5 text-achrams-primary-solid flex-shrink-0" />
//                         <div className="text-achrams-text-primary text-sm">
//                           {d}
//                         </div>
//                       </button>
//                     ))}
//                 </div>
//               )}
//           </div>
//         </div>

//         {fareEstimate && (
//           <div className="mt-6 p-4 bg-achrams-bg-secondary rounded-xl border border-achrams-border">
//             <div className="flex justify-between items-center">
//               <span className="text-achrams-text-secondary">
//                 Estimated fare
//               </span>
//               <span className="text-xl font-bold text-achrams-text-primary">
//                 {fareEstimate.toLocaleString()}
//               </span>
//             </div>
//           </div>
//         )}
//       </div>
//       <div className="p-6">
//         <button
//           onClick={onProceed}
//           disabled={!fareEstimate}
//           className={`w-full py-4 rounded-xl text-lg font-bold text-achrams-text-light transition-all ${
//             fareEstimate
//               ? "bg-achrams-gradient-primary hover:opacity-95 active:scale-[0.98] shadow-md"
//               : "bg-achrams-secondary-solid opacity-75 cursor-not-allowed"
//           }`}
//         >
//           {fareEstimate
//             ? `Proceed  ${fareEstimate.toLocaleString()}`
//             : "Enter destinations"}
//         </button>
//       </div>

//       {/* Modals handled by parent */}
//     </div>
//   );
// }


----- FILE: src/components/app/screens/DriverAssignedScreen.tsx -----
// src/components/app/screens/DriverAssignedScreen.tsx
'use client';

import { MapPin, MessageCircle, Phone, X, CheckCircle, Shield } from 'lucide-react'; // Added CheckCircle
import { Driver } from '@/types/passenger';
import { useState, useEffect } from 'react'; // Add useEffect if not already present




interface DriverAssignedScreenProps {
  pickup: string;
  destination: string;
  driver: Driver;
  verificationCode: string; // NEW: Prop for verification code
  onShowDirections: () => void;
  onShowDriverVerification: () => void; // NEW: Handler for verification modal
  onStartTrip: () => void;
  onBack: () => void;
}

export default function DriverAssignedScreen({
  pickup,
  destination,
  driver,
  verificationCode, // NEW: Destructure prop
  onShowDirections,
  onShowDriverVerification, // NEW: Destructure handler
  onStartTrip,
  onBack,
}: DriverAssignedScreenProps) {
  // NEW: State to track if driver is verified (mock for now)
  const [isVerified, setIsVerified] = useState(false);

  // NEW: Simulate verification after 5 seconds for demo
  useEffect(() => {
    const timer = setTimeout(() => {
      setIsVerified(true);
    }, 5000);

    return () => clearTimeout(timer);
  }, []);

  return (
    <div className="h-screen bg-achrams-bg-primary flex flex-col relative">
      <div className="bg-achrams-primary-solid text-achrams-text-light px-6 py-4 flex items-center justify-between">
        <h1 className="text-xl font-bold">Driver Assigned</h1>
        <button onClick={onBack}>
          <X className="w-6 h-6" />
        </button>
      </div>
      <div className="flex-1 overflow-y-auto px-6 py-6">
        {/* Trip Details */}
        <div className="bg-achrams-bg-secondary rounded-xl p-4 mb-6 border border-achrams-border">
          <div className="flex items-start gap-3 mb-3">
            <div className="w-2 h-2 bg-achrams-primary-solid rounded-full mt-2"></div>
            <div className="flex-1">
              <div className="text-xs text-achrams-text-secondary mb-1">PICKUP</div>
              <div className="font-medium text-achrams-text-primary">{pickup}</div>
            </div>
          </div>
          <div className="ml-3 w-0.5 h-6 bg-achrams-border"></div>
          <div className="flex items-start gap-3">
            <div className="w-2 h-2 bg-achrams-primary-solid rounded-full mt-2"></div>
            <div className="flex-1">
              <div className="text-xs text-achrams-text-secondary mb-1">DESTINATION</div>
              <div className="font-medium text-achrams-text-primary">{destination}</div>
            </div>
          </div>
        </div>

        {/* Driver Card */}
        <div className="bg-achrams-bg-secondary border border-achrams-border rounded-xl p-6 mb-4">
          <div className="flex items-center gap-4 mb-6">
            <div className="w-20 h-20 bg-gradient-to-br from-achrams-primary-solid to-achrams-secondary-solid rounded-full flex items-center justify-center text-achrams-text-light text-2xl font-bold">
              {driver.initials || driver.name?.charAt(0) || 'D'}
            </div>
            <div className="flex-1">
              <h3 className="text-xl font-bold mb-1 text-achrams-text-primary">{driver.name}</h3>
              <div className="flex items-center gap-1 text-sm text-achrams-text-secondary">
                <span className="font-medium text-achrams-text-primary">{driver.rating}</span>
                <span className="text-achrams-text-secondary"> {driver.trips} trips</span>
              </div>
            </div>
          </div>
          <div className="bg-achrams-bg-primary rounded-lg p-4 mb-4 border border-achrams-border">
            <div className="text-sm text-achrams-text-secondary mb-2">{driver.car_type || "Toyota  Camry"}  {driver.car_color || "Red"}</div>
            <div className="text-3xl font-mono font-bold text-achrams-text-primary">{driver.plate_number || "XYZ-ABJ-14"}</div>
          </div>
          <div className="grid grid-cols-2 gap-3">
            <button className="flex items-center justify-center gap-2 py-3 bg-achrams-bg-primary border border-achrams-border rounded-xl font-medium text-achrams-text-primary hover:bg-achrams-bg-secondary transition-colors">
              <MessageCircle className="w-5 h-5" />
              Message
            </button>
            <button className="flex items-center justify-center gap-2 py-3 bg-achrams-bg-primary border border-achrams-border rounded-xl font-medium text-achrams-text-primary hover:bg-achrams-bg-secondary transition-colors">
              <Phone className="w-5 h-5" />
              Call
            </button>
          </div>
        </div>

        {/* NEW: Verify Driver Link/Button */}
        <button
          onClick={onShowDriverVerification}
          className="w-full flex items-center justify-center gap-2 py-3 mb-3 bg-achrams-bg-primary border border-achrams-border rounded-xl font-medium text-achrams-text-primary hover:bg-achrams-bg-secondary transition-colors"
        >
          {isVerified ? <CheckCircle className="w-5 h-5 text-green-500" /> : <Shield className="w-5 h-5" />}
          {isVerified ? 'Driver Verified' : 'Verify Driver'}
        </button>

        <button
          onClick={onShowDirections}
          className="w-full border border-achrams-primary-solid text-achrams-primary-solid bg-transparent py-4 rounded-xl font-semibold mb-3 hover:bg-achrams-bg-secondary transition-colors"
        >
          Get directions to pickup
        </button>
        <button
          onClick={onStartTrip}
          disabled={!isVerified} // NEW: Disable until verified (mock logic)
          className={`w-full py-4 rounded-xl font-semibold transition-all ${
            isVerified
              ? 'bg-achrams-gradient-primary text-achrams-text-light hover:opacity-90 active:scale-[0.98]'
              : 'bg-achrams-secondary-solid text-achrams-text-light opacity-75 cursor-not-allowed'
          }`}
        >
          Start trip
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/screens/AssigningScreen.tsx -----
// src/components/app/screens/AssigningScreen.tsx
'use client';

import { Loader } from 'lucide-react';


interface RequestStatusProp {
  status: 'loading' | 'accepted' | 'no-driver' | 'error' | null;
}
export default function AssigningScreen({status,}: RequestStatusProp) {
    const isNoDriver = status === "no-driver";
    const error = status === "error";
  //if (status == 'no-driver') // I want to change the spinner to stop spinning 
  return (
    <div className="h-screen bg-achrams-bg-primary flex flex-col items-center justify-center px-6">
      {/* Spinner using ACHRAMS primary color */
      }
      <div className="h-screen bg-achrams-bg-primary flex flex-col items-center justify-center px-6">
      {/* Spinner */}
      <div
        className={`w-20 h-20 border-4 border-achrams-primary-solid border-t-transparent rounded-full mb-8 ${
          isNoDriver || error ? "" : "animate-spin"
        }` 
      
      } 
      ></div>

      <h2 className="text-2xl font-bold mb-2 text-achrams-text-primary">
        {isNoDriver ? "No Driver Available" : "Please hold on"}
        {error ? status : "" }
      </h2>

      <p className="text-achrams-text-secondary">
        {isNoDriver || error ? "Try again shortly" : "Assigning a driver"}
      </p>
    </div>
    </div>
  );
}

----- FILE: src/components/app/screens/TripHistoryScreen.tsx -----
// src/components/app/screens/TripHistoryScreen.tsx
import { useState, useEffect } from 'react';
import { MapPin, Clock, Star, Calendar, ChevronRight } from 'lucide-react';
import { apiClient } from '@/services/apiClient'; // Assuming you create this service

interface Trip {
  id: string;
  amount: {
    formatted: string;
  };
  status: {
    label: string;
    value: string;
  };
  pickup_address: string;
  destination_address: string;
  created_at: string; // ISO date string
  rating?: {
    score: number;
    comment?: string;
  } | null;
  // Add other fields as needed from the API response
}

export default function TripHistoryScreen({ onBack, onSelectTrip }: { onBack: () => void; onSelectTrip: (tripId: string) => void }) {
  const [trips, setTrips] = useState<Trip[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchTrips = async () => {
      try {
        setLoading(true);
        setError(null);
        // NEW: Call the trips API using apiClient
        // Example: GET /trips?page=1&limit=20 (pagination might be needed)
        // Example: GET /trips?status=completed (filtering might be needed)
        const response = await apiClient.get('/trips'); // Use correct endpoint and params from Postman doc

        console.log("Trip History Response:", response); // Debug log
        if (response.status === 200 && response.data && Array.isArray(response.data.data)) {
          setTrips(response.data.data);
        } else {
          setError('Failed to load trip history.');
        }
      } catch (err) {
        console.error("Trip History Fetch Error:", err);
        let errorMessage = 'An unexpected error occurred.';
        if (err instanceof Error) {
          errorMessage = err.message;
        }
        setError(errorMessage);
      } finally {
        setLoading(false);
      }
    };

    fetchTrips();
  }, []); // Fetch on mount


  if (loading) {
    return (
      <div className="h-screen bg-achrams-bg-primary flex items-center justify-center">
        <div className="text-center">
          <div className="w-16 h-16 border-4 border-achrams-primary-solid border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p className="text-achrams-text-secondary">Loading trips...</p>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="h-screen bg-achrams-bg-primary flex flex-col items-center justify-center p-6">
        <p className="text-red-500 text-center mb-6">{error}</p>
        <button
          onClick={() => window.location.reload()} // Simple retry for now
          className="bg-achrams-gradient-primary text-achrams-text-light py-3 px-6 rounded-xl font-semibold"
        >
          Retry
        </button>
      </div>
    );
  }

  return (
    <div className="h-screen bg-achrams-bg-primary flex flex-col">
      {/* Header */}
      <div className="bg-achrams-primary-solid text-achrams-text-light px-6 py-4 flex items-center">
        <button onClick={onBack} className="mr-4">
          <ChevronLeft className="w-6 h-6" />
        </button>
        <h1 className="text-xl font-bold">Trip History</h1>
      </div>

      {/* Content */}
      <div className="flex-1 overflow-y-auto p-6">
        {trips.length === 0 ? (
          <div className="text-center py-12">
            <p className="text-achrams-text-secondary">No trips found.</p>
          </div>
        ) : (
          <div className="space-y-4">
            {trips.map((trip) => (
              <div
                key={trip.id}
                onClick={() => onSelectTrip(trip.id)} // NEW: Navigate to TripDetailsScreen
                className="bg-achrams-bg-secondary rounded-2xl p-5 shadow-sm border border-achrams-border flex items-center justify-between cursor-pointer hover:bg-achrams-bg-primary transition-colors"
              >
                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2 mb-1">
                    <Calendar className="w-4 h-4 text-achrams-text-tertiary flex-shrink-0" />
                    <span className="text-xs text-achrams-text-tertiary">
                      {new Date(trip.created_at).toLocaleDateString()}
                    </span>
                  </div>
                  <div className="flex items-start gap-2 mb-2">
                    <MapPin className="w-4 h-4 text-achrams-text-secondary mt-0.5 flex-shrink-0" />
                    <div className="text-sm text-achrams-text-primary truncate">{trip.pickup_address}</div>
                  </div>
                  <div className="flex items-start gap-2 mb-2">
                    <MapPin className="w-4 h-4 text-achrams-text-secondary mt-0.5 flex-shrink-0" />
                    <div className="text-sm text-achrams-text-primary truncate">{trip.destination_address}</div>
                  </div>
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-1">
                      <span className="text-sm font-medium text-achrams-text-primary">{trip.amount.formatted}</span>
                      <span className={`text-xs px-2 py-0.5 rounded-full ${
                        trip.status.value === 'completed' ? 'bg-green-100 text-green-800' :
                        trip.status.value === 'cancelled' ? 'bg-red-100 text-red-800' :
                        'bg-yellow-100 text-yellow-800' // For statuses like 'driver not found', 'searching', etc.
                      }`}>
                        {trip.status.label}
                      </span>
                    </div>
                    {trip.rating && (
                      <div className="flex items-center gap-1">
                        <Star className="w-4 h-4 fill-yellow-400 text-yellow-400" />
                        <span className="text-xs text-achrams-text-secondary">{trip.rating.score}</span>
                      </div>
                    )}
                  </div>
                </div>
                <ChevronRight className="w-5 h-5 text-achrams-text-secondary flex-shrink-0 ml-2" />
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}

----- FILE: src/components/app/screens/TripCompleteScreen.tsx -----
// src/components/app/screens/TripCompleteScreen.tsx
'use client';

import { Check } from 'lucide-react';
import { Driver } from '@/types/passenger';

// NEW: Define the type for the onDone prop
type OnDoneHandler = () => void;

interface TripCompleteScreenProps {
  fareEstimate: number | null;
  driver: Driver;
  onRate?: () => void;
  // NEW: Add onDone prop
  onDone: OnDoneHandler;
}

export default function TripCompleteScreen({
  fareEstimate,
  driver,
  onRate,
  onDone, // NEW: Destructure the onDone prop
}: TripCompleteScreenProps) {
  return (
    <div className="h-screen bg-achrams-bg-primary flex flex-col">
      <div className="bg-achrams-primary-solid text-achrams-text-light px-6 py-4">
        <h1 className="text-xl font-bold">Trip completed</h1>
      </div>
      <div className="flex-1 overflow-y-auto px-6 py-8">
        <div className="text-center mb-8">
          <div className="w-20 h-20 bg-achrams-bg-secondary rounded-full flex items-center justify-center mx-auto mb-4 border border-achrams-border">
            <Check className="w-10 h-10 text-achrams-primary-solid" />
          </div>
          <h2 className="text-2xl font-bold mb-2 text-achrams-text-primary">You've arrived!</h2>
          <p className="text-achrams-text-secondary">How was your trip?</p>
        </div>

        <div className="bg-achrams-bg-secondary rounded-xl p-6 mb-6 border border-achrams-border">
          <div className="flex justify-between items-center mb-4">
            <span className="text-achrams-text-secondary">Total Fare</span>
            <span className="text-3xl font-bold text-achrams-text-primary">
              {fareEstimate?.toLocaleString() || '0'}
            </span>
          </div>
          <div className="text-sm text-achrams-text-secondary">Paid via Cash</div>
        </div>

        {onRate && (
          <button
            onClick={onRate} // Keep existing rate button
            className="w-full py-4 rounded-xl font-semibold mb-3 bg-achrams-gradient-primary text-achrams-text-light hover:opacity-90 active:scale-[0.98] transition-all"
          >
            Rate your ride
          </button>
        )}

        {/* NEW: Button that triggers the onDone handler passed from page.tsx */}
        <button
          onClick={onDone} // NEW: Call the onDone function passed as a prop
          className="w-full py-4 rounded-xl font-semibold bg-achrams-gradient-primary text-achrams-text-light hover:opacity-90 active:scale-[0.98] transition-all"
        >
          Done
        </button>
      </div>
    </div>
  );
}

----- FILE: src/components/app/screens/SettingsScreen.tsx -----
// src/components/app/screens/SettingsScreen.tsx
import { ChevronLeft, Shield, User, CreditCard, Bell, Globe, HelpCircle, LogOut, ChevronRight } from 'lucide-react';

export default function SettingsScreen({ onBack, onShowProfile, onShowSecurity, onShowPayment, onShowNotifications, onShowLanguage, onShowHelp, onLogout }: { onBack: () => void; onShowProfile: () => void; onShowSecurity: () => void; onShowPayment: () => void; onShowNotifications: () => void; onShowLanguage: () => void; onShowHelp: () => void; onLogout: () => void }) {
  return (
    <div className="h-screen bg-achrams-bg-primary flex flex-col">
      {/* Header */}
      <div className="bg-achrams-primary-solid text-achrams-text-light px-6 py-4 flex items-center">
        <button onClick={onBack} className="mr-4">
          <ChevronLeft className="w-6 h-6" />
        </button>
        <h1 className="text-xl font-bold">Settings</h1>
      </div>

      {/* Content */}
      <div className="flex-1 overflow-y-auto p-6 space-y-6">
        {/* Account */}
        <div className="bg-achrams-bg-secondary rounded-xl border border-achrams-border">
          <h3 className="text-lg font-semibold px-4 py-3 text-achrams-text-primary">Account</h3>
          <button
            onClick={onShowProfile}
            className="w-full flex items-center justify-between px-4 py-3 hover:bg-achrams-bg-primary border-b border-achrams-border text-left"
          >
            <div className="flex items-center gap-3">
              <User className="w-5 h-5 text-achrams-text-secondary" />
              <span>Edit Profile</span>
            </div>
            <ChevronRight className="w-5 h-5 text-achrams-text-secondary" />
          </button>
          <button
            onClick={onShowSecurity}
            className="w-full flex items-center justify-between px-4 py-3 hover:bg-achrams-bg-primary border-b border-achrams-border text-left"
          >
            <div className="flex items-center gap-3">
              <Shield className="w-5 h-5 text-achrams-text-secondary" />
              <span>Security</span>
            </div>
            <ChevronRight className="w-5 h-5 text-achrams-text-secondary" />
          </button>
          <button
            onClick={onShowPayment}
            className="w-full flex items-center justify-between px-4 py-3 hover:bg-achrams-bg-primary text-left"
          >
            <div className="flex items-center gap-3">
              <CreditCard className="w-5 h-5 text-achrams-text-secondary" />
              <span>Payment Methods</span>
            </div>
            <ChevronRight className="w-5 h-5 text-achrams-text-secondary" />
          </button>
        </div>

        {/* Preferences */}
        <div className="bg-achrams-bg-secondary rounded-xl border border-achrams-border">
          <h3 className="text-lg font-semibold px-4 py-3 text-achrams-text-primary">Preferences</h3>
          <button
            onClick={onShowNotifications}
            className="w-full flex items-center justify-between px-4 py-3 hover:bg-achrams-bg-primary border-b border-achrams-border text-left"
          >
            <div className="flex items-center gap-3">
              <Bell className="w-5 h-5 text-achrams-text-secondary" />
              <span>Notifications</span>
            </div>
            <ChevronRight className="w-5 h-5 text-achrams-text-secondary" />
          </button>
          <button
            onClick={onShowLanguage}
            className="w-full flex items-center justify-between px-4 py-3 hover:bg-achrams-bg-primary text-left"
          >
            <div className="flex items-center gap-3">
              <Globe className="w-5 h-5 text-achrams-text-secondary" />
              <span>Language</span>
            </div>
            <ChevronRight className="w-5 h-5 text-achrams-text-secondary" />
          </button>
        </div>

        {/* Support */}
        <div className="bg-achrams-bg-secondary rounded-xl border border-achrams-border">
          <h3 className="text-lg font-semibold px-4 py-3 text-achrams-text-primary">Support</h3>
          <button
            onClick={onShowHelp}
            className="w-full flex items-center justify-between px-4 py-3 hover:bg-achrams-bg-primary border-b border-achrams-border text-left"
          >
            <div className="flex items-center gap-3">
              <HelpCircle className="w-5 h-5 text-achrams-text-secondary" />
              <span>Help Center</span>
            </div>
            <ChevronRight className="w-5 h-5 text-achrams-text-secondary" />
          </button>
          <button
            onClick={onLogout}
            className="w-full flex items-center justify-between px-4 py-3 hover:bg-red-50 text-left text-red-600"
          >
            <div className="flex items-center gap-3">
              <LogOut className="w-5 h-5" />
              <span>Log Out</span>
            </div>
          </button>
        </div>
      </div>
    </div>
  );
}

----- FILE: src/components/app/screens/WalletScreen.tsx -----
// src/components/app/screens/WalletScreen.tsx
import { useState, useEffect } from 'react';
import { Wallet, TrendingUp, TrendingDown, Calendar, Clock } from 'lucide-react';
import { apiClient } from '@/services/apiClient'; // Assuming you create this service

interface Transaction {
  id: string;
  reference: string;
  amount: {
    formatted: string;
    currency: string;
    amount: number;
  };
  status: {
    label: string;
    value: string;
  };
  entry_type: {
    label: string; // e.g., "Credit", "Debit"
    value: string; // e.g., "credit", "debit"
  };
  narration: string;
  created_at: string; // ISO date string
  // Add other fields as needed from the API response
}

export default function WalletScreen({ onBack }: { onBack: () => void }) {
  const [balance, setBalance] = useState({ formatted: '0.00', currency: 'NGN', amount: 0 });
  const [transactions, setTransactions] = useState<Transaction[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    const fetchWalletData = async () => {
      try {
        setLoading(true);
        setError(null);
        // NEW: Call the wallet details API using apiClient
        // Example: GET /wallets (to get balance)
        const balanceResponse = await apiClient.get('/wallets'); // Use correct endpoint from Postman doc
        // Example: GET /wallets/history (to get history)
        const historyResponse = await apiClient.get('/wallets/history'); // Use correct endpoint from Postman doc

        console.log("Wallet Balance Response:", balanceResponse); // Debug log
        console.log("Wallet History Response:", historyResponse); // Debug log

        if (balanceResponse.status === 200 && balanceResponse.data && balanceResponse.data.data) {
          setBalance(balanceResponse.data.data.balance); // Adjust based on actual API response structure for balance
        } else {
          setError('Failed to load wallet balance.');
        }

        if (historyResponse.status === 200 && historyResponse.data && Array.isArray(historyResponse.data.data)) {
          setTransactions(historyResponse.data.data);
        } else {
          setError('Failed to load transaction history.');
        }
      } catch (err) {
        console.error("Wallet Data Fetch Error:", err);
        let errorMessage = 'An unexpected error occurred.';
        if (err instanceof Error) {
          errorMessage = err.message;
        }
        setError(errorMessage);
      } finally {
        setLoading(false);
      }
    };

    fetchWalletData();
  }, []); // Fetch on mount


  if (loading) {
    return (
      <div className="h-screen bg-achrams-bg-primary flex items-center justify-center">
        <div className="text-center">
          <div className="w-16 h-16 border-4 border-achrams-primary-solid border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p className="text-achrams-text-secondary">Loading wallet...</p>
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <div className="h-screen bg-achrams-bg-primary flex flex-col items-center justify-center p-6">
        <p className="text-red-500 text-center mb-6">{error}</p>
        <button
          onClick={() => window.location.reload()} // Simple retry for now
          className="bg-achrams-gradient-primary text-achrams-text-light py-3 px-6 rounded-xl font-semibold"
        >
          Retry
        </button>
      </div>
    );
  }

  return (
    <div className="h-screen bg-achrams-bg-primary flex flex-col">
      {/* Header */}
      <div className="bg-achrams-primary-solid text-achrams-text-light px-6 py-4 flex items-center">
        <button onClick={onBack} className="mr-4">
          <ChevronLeft className="w-6 h-6" />
        </button>
        <h1 className="text-xl font-bold">My Wallet</h1>
      </div>

      {/* Content */}
      <div className="flex-1 overflow-y-auto">
        {/* Balance Card */}
        <div className="bg-gradient-to-r from-achrams-primary-solid to-achrams-secondary-solid text-achrams-text-light p-6 m-6 rounded-2xl shadow-md">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm opacity-80">Available Balance</p>
              <p className="text-3xl font-bold">{balance.formatted}</p>
            </div>
            <Wallet className="w-12 h-12 opacity-80" />
          </div>
        </div>

        {/* Transactions List */}
        <div className="mx-6 mb-6">
          <h2 className="text-lg font-semibold mb-4 text-achrams-text-primary">Transaction History</h2>
          {transactions.length === 0 ? (
            <div className="text-center py-8">
              <p className="text-achrams-text-secondary">No transactions found.</p>
            </div>
          ) : (
            <div className="space-y-4">
              {transactions.map((tx) => (
                <div key={tx.id} className="bg-achrams-bg-secondary rounded-xl p-4 border border-achrams-border flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <div className={`p-2 rounded-full ${
                      tx.entry_type.value === 'credit' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'
                    }`}>
                      {tx.entry_type.value === 'credit' ? <TrendingUp className="w-5 h-5" /> : <TrendingDown className="w-5 h-5" />}
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="font-medium text-achrams-text-primary truncate">{tx.narration || tx.reference}</p>
                      <div className="flex items-center gap-2 text-xs text-achrams-text-tertiary">
                        <Calendar className="w-3 h-3" />
                        <span>{new Date(tx.created_at).toLocaleDateString()}</span>
                        <Clock className="w-3 h-3" />
                        <span>{new Date(tx.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                      </div>
                    </div>
                  </div>
                  <div className="text-right">
                    <p className={`font-semibold ${
                      tx.entry_type.value === 'credit' ? 'text-green-600' : 'text-red-600'
                    }`}>
                      {tx.entry_type.value === 'credit' ? '+' : '-'}{tx.amount.formatted}
                    </p>
                    <span className={`text-xs px-2 py-0.5 rounded-full ${
                      tx.status.value === 'successful' ? 'bg-green-100 text-green-800' :
                      tx.status.value === 'failed' ? 'bg-red-100 text-red-800' :
                      'bg-yellow-100 text-yellow-800'
                    }`}>
                      {tx.status.label}
                    </span>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

----- FILE: src/components/app/screens/DashboardScreen.tsx -----
// src/components/app/screens/DashboardScreen.tsx
'use client';

import { useEffect, useState } from 'react';
import { MapPin, Plus, CreditCard, ShieldAlert, Settings, Bell, Clock, Wallet, User } from 'lucide-react'; // NEW: Add icons
import BottomNavBar from '../ui/BottomNavBar'; // NEW: Import BottomNavBar
import { Driver } from '@/types/passenger'; // Assuming this type exists or define it

interface DashboardScreenProps {
  passengerData: { name: string; phone: string; email: string };
  walletBalance: number; // NEW: Pass wallet balance from parent
  activeTrip?: { id: string; status: string; driver?: Driver; destination: string }; // NEW: Pass active trip data if any
  onShowProfile: () => void;
  onBookNewTrip: () => void;
  onShowTripHistory: () => void; // NEW: Handler to trigger trip history view
  onShowWallet: () => void; // NEW: Handler to trigger wallet view
  onShowSettings: () => void; // NEW: Handler to trigger settings view
  onShowActiveTrip: () => void; // NEW: Handler if active trip card is clicked
}

export default function DashboardScreen({
  passengerData,
  walletBalance, // NEW: Destructure balance
  activeTrip, // NEW: Destructure active trip data
  onShowProfile,
  onBookNewTrip,
  onShowTripHistory, // NEW: Destructure handler
  onShowWallet, // NEW: Destructure handler
  onShowSettings, // NEW: Destructure handler
  onShowActiveTrip, // NEW: Destructure handler
}: DashboardScreenProps) {
  const hour = new Date().getHours();
  const greeting = hour < 12 ? 'Good morning' : hour < 18 ? 'Good afternoon' : 'Good evening';
  const firstName = passengerData.name.split(' ')[0] || 'Passenger';

  // NEW: State for weather (could be fetched from an API)
  const [weather, setWeather] = useState({ temp: 28, condition: 'sunny', location: 'Lagos' });

  // NEW: Example recent trip data (could come from props or fetched)
  const recentTrip = {
    id: 'recent_1',
    pickup: 'Murtala Muhammed Airport',
    destination: 'VI, Lagos',
    fare: 4500,
    status: 'completed',
    date: 'Today',
  };

  return (
    <div className="h-screen bg-achrams-bg-primary flex flex-col pb-20"> {/* pb-20 to account for fixed BottomNavBar */}
      {/* Header */}
      <div className="bg-achrams-primary-solid text-achrams-text-light px-6 py-4 flex items-center justify-between">
        <h1 className="text-2xl font-bold">ACHRAM</h1>
        <button
          onClick={onShowProfile}
          className="w-10 h-10 bg-gradient-to-br from-achrams-primary-solid to-achrams-secondary-solid rounded-full flex items-center justify-center text-sm font-bold shadow-lg"
        >
          {passengerData.name
            .split(' ')
            .map((n) => n[0])
            .join('')}
        </button>
      </div>

      {/* Scrollable Content Area */}
      <div className="flex-1 overflow-y-auto px-6 py-8">
        {/* Weather & Greeting */}
        <div className="bg-gradient-to-br from-achrams-accent-primary/10 to-achrams-accent-secondary/10 px-6 py-8 rounded-2xl mb-6">
          <h2 className="text-2xl font-bold mb-1 text-achrams-text-primary">{greeting}, {firstName}!</h2>
          <p className="text-achrams-text-secondary mb-4">Ready for your next journey?</p>
          <div className="bg-achrams-bg-secondary rounded-xl p-4 flex items-center justify-between border border-achrams-border">
            <div>
              <div className="text-3xl font-bold text-achrams-text-primary">{weather.temp}C</div>
              <div className="text-achrams-text-secondary capitalize">{weather.condition}</div>
              <div className="text-xs text-achrams-text-tertiary">{weather.location}, Nigeria</div>
            </div>
            <div className="text-5xl">
              {weather.condition === 'sunny' && ''}
              {weather.condition === 'cloudy' && ''}
              {weather.condition === 'rainy' && ''}
            </div>
          </div>
        </div>

        {/* Active Trip Card (if applicable) */}
        {activeTrip && (
          <div
            onClick={onShowActiveTrip} // NEW: Click handler to view active trip
            className="bg-achrams-bg-secondary rounded-2xl p-5 mb-6 shadow-sm border border-achrams-border cursor-pointer hover:bg-achrams-bg-primary transition-colors"
          >
            <div className="flex items-center justify-between mb-3">
              <h3 className="font-semibold text-achrams-text-primary">Active Trip</h3>
              <span className="text-xs bg-achrams-warning-light text-achrams-warning-dark px-2 py-1 rounded-full">{activeTrip.status}</span>
            </div>
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 bg-gradient-to-br from-achrams-primary-solid to-achrams-secondary-solid rounded-full flex items-center justify-center text-achrams-text-light font-bold">
                {activeTrip.driver?.name?.charAt(0) || 'D'}
              </div>
              <div className="flex-1 min-w-0">
                <p className="text-sm font-medium truncate text-achrams-text-primary">{activeTrip.driver?.name || 'Driver Assigned'}</p>
                <p className="text-xs text-achrams-text-secondary truncate">To {activeTrip.destination}</p>
              </div>
              <button className="text-achrams-primary-solid">
                <ChevronRight className="w-5 h-5" />
              </button>
            </div>
          </div>
        )}

        {/* Book Button */}
        <button
          onClick={onBookNewTrip}
          className="w-full bg-achrams-gradient-primary text-achrams-text-light py-5 rounded-2xl text-lg font-semibold shadow-md hover:opacity-95 active:scale-[0.98] transition-all mb-6"
        >
          Book your airport ride
        </button>

        {/* Quick Actions */}
        <div className="grid grid-cols-4 gap-3 mb-6">
          <button
            onClick={onShowTripHistory} // NEW: Click handler
            className="flex flex-col items-center justify-center gap-2 bg-achrams-bg-secondary rounded-xl p-4 border border-achrams-border hover:bg-achrams-bg-primary transition-colors"
          >
            <Clock className="w-6 h-6 text-achrams-primary-solid" />
            <span className="text-xs text-achrams-text-primary">History</span>
          </button>
          <button
            onClick={onShowWallet} // NEW: Click handler
            className="flex flex-col items-center justify-center gap-2 bg-achrams-bg-secondary rounded-xl p-4 border border-achrams-border hover:bg-achrams-bg-primary transition-colors"
          >
            <Wallet className="w-6 h-6 text-achrams-primary-solid" />
            <span className="text-xs text-achrams-text-primary">Wallet</span>
          </button>
          <button
            onClick={onShowSettings} // NEW: Click handler
            className="flex flex-col items-center justify-center gap-2 bg-achrams-bg-secondary rounded-xl p-4 border border-achrams-border hover:bg-achrams-bg-primary transition-colors"
          >
            <Settings className="w-6 h-6 text-achrams-primary-solid" />
            <span className="text-xs text-achrams-text-primary">Settings</span>
          </button>
          <button
            onClick={onShowProfile} // NEW: Could also link to profile
            className="flex flex-col items-center justify-center gap-2 bg-achrams-bg-secondary rounded-xl p-4 border border-achrams-border hover:bg-achrams-bg-primary transition-colors"
          >
            <User className="w-6 h-6 text-achrams-primary-solid" />
            <span className="text-xs text-achrams-text-primary">Profile</span>
          </button>
        </div>

        {/* Recent Trip */}
        <div className="mb-6">
          <h3 className="font-bold text-lg mb-3 text-achrams-text-primary">Recent trip</h3>
          <div className="bg-achrams-bg-secondary rounded-2xl p-5 shadow-sm border border-achrams-border">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <MapPin className="w-4 h-4 text-achrams-text-secondary flex-shrink-0" />
                <span className="text-sm truncate text-achrams-text-primary">{recentTrip.pickup}  {recentTrip.destination}</span>
              </div>
              <span className="text-lg font-bold text-achrams-text-primary">{recentTrip.fare.toLocaleString()}</span>
            </div>
            <div className="flex justify-between mt-2 text-xs text-achrams-text-tertiary">
              <span>{recentTrip.date}</span>
              <span className="capitalize">{recentTrip.status}</span>
            </div>
          </div>
        </div>

        {/* Promotion Banner */}
        <div className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl p-5 shadow-sm mb-6 border border-achrams-border">
          <div className="flex items-start gap-3">
            <div className="text-2xl"></div>
            <div>
              <h4 className="font-semibold mb-1 text-achrams-text-primary">Flight Delay?</h4>
              <p className="text-sm text-achrams-text-secondary">Well wait for you  no extra charge.</p>
            </div>
          </div>
        </div>

        {/* Stats */}
        <div className="grid grid-cols-3 gap-3">
          <div className="bg-achrams-bg-secondary rounded-2xl p-4 shadow-sm border border-achrams-border text-center">
            <div className="text-xl font-bold mb-1 text-achrams-text-primary">1</div>
            <div className="text-xs text-achrams-text-tertiary">Trips</div>
          </div>
          <div className="bg-achrams-bg-secondary rounded-2xl p-4 shadow-sm border border-achrams-border text-center">
            <div className="text-xl font-bold mb-1 text-achrams-text-primary">5.0</div>
            <div className="text-xs text-achrams-text-tertiary">Rating</div>
          </div>
          <div className="bg-achrams-bg-secondary rounded-2xl p-4 shadow-sm border border-achrams-border text-center">
            <div className="text-xl font-bold mb-1 text-achrams-text-primary">{walletBalance?.toLocaleString() || '0'}</div> {/* NEW: Display balance */}
            <div className="text-xs text-achrams-text-tertiary">Wallet</div>
          </div>
        </div>
      </div>

      {/* NEW: Bottom Navigation Bar */}
      <BottomNavBar
        onProfileClick={onShowProfile}
        walletBalance={walletBalance} // Pass balance to navbar if needed for icon badge
        onHomeClick={onBookNewTrip} // Example: Home click could book new trip
        onWalletClick={onShowWallet} // NEW: Link wallet click
        onSearchClick={onShowTripHistory} // Example: Link search to history
      />
    </div>
  );
}

----- FILE: src/app/pbk.tsx -----
// src/app/page.tsx
"use client";

import { useEffect, useState } from "react";
import { useAuth } from "@/contexts/AuthContext";
import BookingScreen from "@/components/app/screens/BookingScreen";
import AssigningScreen from "@/components/app/screens/AssigningScreen";
import DriverAssignedScreen from "@/components/app/screens/DriverAssignedScreen";
// NEW: Import TripProgressScreen statically
import TripProgressScreen from "@/components/app/screens/TripProgressScreen";
import TripCompleteScreen from "@/components/app/screens/TripCompleteScreen";
// NEW: Import new dashboard-related screens
import TripHistoryScreen from "@/components/app/screens/TripHistoryScreen";
import TripDetailsScreen from "@/components/app/screens/TripDetailsScreen";
import WalletScreen from "@/components/app/screens/WalletScreen";
import SettingsScreen from "@/components/app/screens/SettingsScreen";

// NEW: Import the dashboard screen (assuming it's updated to handle new features)
import DashboardScreen from "@/components/app/screens/DashboardScreen";

// Modals - Dynamically import map-dependent modals like DirectionsModal
import dynamic from "next/dynamic";
const DirectionsModal = dynamic(
  () => import("@/components/app/modals/DirectionsModal"),
  { ssr: false }
);

// Modals - Imported normally
import PassengerDetailsModal from "@/components/app/modals/PassengerDetailsModal";
import PanicModal from "@/components/app/modals/PanicModal";
import SignupPromptModal from "@/components/app/modals/SignupPromptModal";
import OTPModal from "@/components/app/modals/OTPModal";
import ProfileModal from "@/components/app/modals/ProfileModal";
import CancelModal from "@/components/app/modals/CancelModal";
import RateModal from "@/components/app/modals/RateModal";
import MessageWindowModal from "@/components/app/modals/MessageWindowModal";
import TripRequestStatusModal from "@/components/app/modals/TripRequestStatusModal";
import DriverVerificationModal from "@/components/app/modals/DriverVerificationModal";
import LoginModal from "@/components/app/modals/LoginModal";
// NEW: Import new modals
import Enable2FAModal from "@/components/app/modals/Enable2FAModal";
import Disable2FAModal from "@/components/app/modals/Disable2FAModal";
import UpdateProfileModal from "@/components/app/modals/UpdateProfileModal";


import Image from "next/image";
import { apiClient } from "@/lib/api";

// UI
import TripUpdateNotification from "@/components/app/ui/TripUpdateNotification";
// NEW: Import BottomNavBar
import BottomNavBar from "@/components/app/ui/BottomNavBar";
import { findNearestAirport, KNOWN_AIRPORTS } from "@/lib/airports";
import ReconnectingWebSocket from "reconnecting-websocket";
import LocationPermissionModal from '@/components/app/modals/LocationPermissionModal'; // NEW: Import the new modal

type TripStatusValue =
  | "searching"
  | "driver_assigned"
  | "accepted"
  | "active"
  | "completed"
  | "cancelled"
  | "driver not found"; // Added "driver not found"

  type TripStatus = {
  label: string;
  value: TripStatusValue;
};

// NEW: Define types for the WebSocket message
type WebSocketMessage = {
  event: "trip:assigned" | "trip:status:update" | string; // Add other potential events
  any; // This will be the trip object
};

// Types
type ScreenState =
  | "booking"
  | "assigning"
  | "driver-assigned"
  | "trip-progress"
  | "trip-complete"
  | "dashboard";
// NEW: Add any new screen states if necessary, though most new features will be modals/screens on top of 'dashboard'

type Requirements = {
  luggage: boolean;
  wheelchair: boolean;
  elderly: boolean;
};

type PassengerData = {
  name: string;
  phone: string;
  email: string;
};

// NEW: Define type for the state you want to persist
interface PersistedState {
  screen: ScreenState;
  pickup: string;
  destination: string;
  fareEstimate: number | null;
  driver: any | null;
  tripProgress: number;
  pickupCoords: [number, number] | null;
  destinationCoords: [number, number] | null;
  verificationCode: string | null;
  // NEW: Add other critical states you want to persist across refresh
  // e.g., walletBalance, is2FAEnabled (though these might be fetched fresh from API on load)
  // Add other critical states as needed
}

// NEW: Function to save state to sessionStorage - only runs on client
const saveAppState = (state: PersistedState) => {
  if (typeof window !== "undefined" && window.sessionStorage) {
    try {
      sessionStorage.setItem("achrams_app_state", JSON.stringify(state));
      console.log("App state saved to sessionStorage"); // Optional: For debugging
    } catch (e) {
      console.error("Failed to save app state to sessionStorage", e);
    }
  }
};

// NEW: Function to load state from sessionStorage - only runs on client
const loadAppState = (): PersistedState | null => {
  if (typeof window !== "undefined" && window.sessionStorage) {
    try {
      const savedStateStr = sessionStorage.getItem("achrams_app_state");
      if (savedStateStr) {
        const savedState = JSON.parse(savedStateStr) as PersistedState;
        console.log("App state loaded from sessionStorage", savedState); // Optional: For debugging
        return savedState;
      }
    } catch (e) {
      console.error("Failed to load app state from sessionStorage", e);
    }
  }
  return null; // Return null if sessionStorage is not available or error occurred
};

export default function ACHRAMApp() {
  const { token } = useAuth();

  // NEW: Use a state variable to track if we have checked sessionStorage on the client
  const [hasHydrated, setHasHydrated] = useState(false);

  // NEW: Define state variables without initial values from loadAppState here
  const [screen, setScreen] = useState<ScreenState>("booking"); // Will be set after hydration
  const [pickup, setPickup] = useState<string>("");
  const [destination, setDestination] = useState<string>("");
  const [fareEstimate, setFareEstimate] = useState<number | null>(null);
  const [driver, setDriver] = useState<any>(null);
  const [tripProgress, setTripProgress] = useState<number>(0);
  const [pickupCoords, setPickupCoords] = useState<[number, number] | null>(
    null
  );
  const [destinationCoords, setDestinationCoords] = useState<
    [number, number] | null
  >(null);
  const [verificationCode, setVerificationCode] = useState<string | null>(null);
  const [guestId, setGuestId] = useState<string | null>(null); // NEW: Store guest ID
  const [activeTripId, setActiveTripId] = useState<string | null>(null); // NEW: Store active trip ID (from booking response)
  // NEW: State for WebSocket connection
  const [webSocketConnection, setWebSocketConnection] =
    useState<ReconnectingWebSocket | null>(null);
  const [webSocketStatus, setWebSocketStatus] = useState<
    "connecting" | "open" | "closed" | "reconnecting"
  >("closed");
  // NEW: State for polling fallback
  const [pollingIntervalId, setPollingIntervalId] =
    useState<NodeJS.Timeout | null>(null);

  // NEW: State for new dashboard features (these might be fetched from API on load)
  const [walletBalance, setWalletBalance] = useState<number>(0); // NEW: State for wallet balance
  const [is2FAEnabled, setIs2FAEnabled] = useState<boolean>(false); // NEW: State for 2FA status
  // const [activeTripId, setActiveTripId] = useState<string | null>(null); // NEW: State for active trip ID (if any)

  // NEW: State for modals (these can be initialized normally)
  const [showPassengerDetails, setShowPassengerDetails] = useState(false);
  const [showDirections, setShowDirections] = useState(false);
  const [showPanic, setShowPanic] = useState(false);
  const [showSignup, setShowSignup] = useState(false); // NEW: Use this state instead of screen === 'signup-prompt'
  const [showOTP, setShowOTP] = useState(false);
  const [showProfile, setShowProfile] = useState(false);
  const [showCancel, setShowCancel] = useState(false);
  const [showRate, setShowRate] = useState(false);
  const [showMessage, setShowMessage] = useState(false);

  // NEW: State for new modals/screens
  const [showTripHistory, setShowTripHistory] = useState(false);
  const [showTripDetails, setShowTripDetails] = useState(false);
  const [selectedTripId, setSelectedTripId] = useState<string | null>(null);
  const [showWallet, setShowWallet] = useState(false);
  const [showSettings, setShowSettings] = useState(false);
  const [showEnable2FA, setShowEnable2FA] = useState(false);
  const [showDisable2FA, setShowDisable2FA] = useState(false);
  const [showUpdateProfile, setShowUpdateProfile] = useState(false);

  // NEW: State for Login Modal
  const [showLogin, setShowLogin] = useState(false); // NEW: Add state for login modal

  // NEW: State for trip request status modal
  const [tripRequestStatus, setTripRequestStatus] = useState<
    "loading" | "accepted" | "no-driver" | "error" | null
  >(null);
  const [tripRequestError, setTripRequestError] = useState<string | null>(null);

  // NEW: State for driver verification modal
  const [showDriverVerification, setShowDriverVerification] = useState(false);

  const [showLocationModal, setShowLocationModal] = useState(false);



  // NEW: State for trip update notifications
  const [currentNotification, setCurrentNotification] = useState<{
    message: string;
    type: "info" | "success" | "warning" | "error";
  } | null>(null);

  // NEW: Effect to run only on the client after mount to load state and set initial values
  useEffect(() => {
    // Check if we are on the client
    if (typeof window !== "undefined") {
      const savedState = loadAppState();
      if (savedState) {
        // Set state using the loaded values
        setScreen(savedState.screen);
        setPickup(savedState.pickup);
        setDestination(savedState.destination);
        setFareEstimate(savedState.fareEstimate);
        setDriver(savedState.driver);
        setTripProgress(savedState.tripProgress);
        setPickupCoords(savedState.pickupCoords);
        setDestinationCoords(savedState.destinationCoords);
        setVerificationCode(savedState.verificationCode);
        // NEW: Load other persisted states if added
        // setWalletBalance(savedState.walletBalance); // Example
        // setIs2FAEnabled(savedState.is2FAEnabled); // Example
      } else {
        // Set default initial state based on token
        setScreen(token ? "dashboard" : "booking");
      }
      // Mark as hydrated after loading/saving defaults
      setHasHydrated(true);
    } else {
      // Fallback if somehow this runs on server (shouldn't with 'use client')
      setScreen(token ? "dashboard" : "booking");
      setHasHydrated(true);
    }
  }, [token]); // Depend on token if initial screen logic depends on it

  // NEW: Effect to fetch user profile data (including 2FA status, wallet, active trip) on initial load or token change
  useEffect(() => {
    if (hasHydrated && token) {
      const fetchUserProfile = async () => {
        try {
          // NEW: Call the API to get user profile using apiClient
          // Example: const response = await apiClient.get('/auth/passenger/me');
          // Example structure based on passenger postman DOC.txt:
          // const profileData = response.data.data;
          // setWalletBalance(profileData.profile.wallet.balance.amount);
          // setIs2FAEnabled(profileData.is_2fa_enabled);
          // if (profileData.profile.active_trip) {
          //    setActiveTripId(profileData.profile.active_trip.id);
          //    // Potentially set screen to 'driver-assigned' or 'trip-progress' if active trip exists
          //    // This logic depends on your desired UX for resuming active trips
          // }

          // For now, simulate with mock data after a short delay
          setTimeout(() => {
            setWalletBalance(5000); // Mock balance
            setIs2FAEnabled(false); // Mock 2FA status
            // setActiveTripId(null); // Mock active trip ID - assume no active trip for this example
          }, 500); // Simulate API delay
        } catch (err) {
          console.error("Failed to fetch user profile:", err);
          // NEW: Optionally show an error notification
          setCurrentNotification({
            message: "Failed to load profile data.",
            type: "error",
          });
          setTimeout(() => setCurrentNotification(null), 5000);
        }
      };

      fetchUserProfile();
    }
  }, [hasHydrated, token]); // Run when hydrated state is true and token changes

  // NEW: Effect to handle navigation after trip completion and set showSignup
  useEffect(() => {
    if (screen === "trip-complete") {
      // Check if user is authenticated
      if (token) {
        // If authenticated, maybe show rate modal (if not already shown) and then go to dashboard
        // Or, if rating is handled elsewhere, just go to dashboard after a delay or user action
        // For now, let's assume the user can click a button or it happens automatically after a short delay
        // Or, the TripCompleteScreen itself could trigger this.
        // Let's simulate a delay and then transition to dashboard if authenticated.
        // This is just a simulation, the real trigger might be clicking 'Done' in TripCompleteScreen.
        // We'll add a specific state to manage this transition cleanly.
        // Let's assume the TripCompleteScreen has a button that calls a handler passed from page.tsx.
        // For now, let's just add the logic here that *would* happen when the user wants to leave the trip-complete screen.
        // The key is to clear trip data and set screen to dashboard *before* the save effect runs.
      } else {
        // If not authenticated (guest), show signup prompt after a delay
        const timer = setTimeout(() => {
          // NEW: Clear specific trip-related state before navigating to signup
          // Note: This clearing is now handled in the onDone handler in TripCompleteScreen render block
          // We set showSignup here, which triggers the modal.
          setShowSignup(true); // NEW: Trigger the signup modal
        }, 1500); // Delay matches the original effect

        return () => clearTimeout(timer);
      }
    }
  }, [screen, token]); // Depend on screen and token only

  // Data state
  const [passengerData, setPassengerData] = useState<PassengerData>({
    name: "",
    phone: "",
    email: "",
  });
  const [requirements, setRequirements] = useState<Requirements>({
    luggage: false,
    wheelchair: false,
    elderly: false,
  });

  // NEW: Function to show notifications
  const showNotification = (
    message: string,
    type: "info" | "success" | "warning" | "error"
  ) => {
    setCurrentNotification({ message, type });
    setTimeout(() => {
      setCurrentNotification(null);
    }, 5000); // Auto-dismiss after 5 seconds
  };

  // NEW: Effect to trigger notifications based on screen changes (simulated)
  useEffect(() => {
    if (screen === "driver-assigned" && driver) {
      // Simulate driver found notification
      showNotification("Driver assigned successfully!", "success");
      // Simulate trip updates after some delay
      const timer1 = setTimeout(
        () => showNotification("Driver is 7 mins from pickup location", "info"),
        3000
      );
      const timer2 = setTimeout(
        () =>
          showNotification("Driver has arrived at pickup location", "success"),
        10000
      );

      return () => {
        clearTimeout(timer1);
        clearTimeout(timer2);
      };
    }
    if (screen === "trip-progress") {
      // Simulate ongoing trip updates
      const timer = setInterval(() => {
        setTripProgress((prev) => {
          if (prev >= 100) {
            clearInterval(timer);
            setScreen("trip-complete");
            return 100;
          }
          return prev + 2; // Simulate progress
        });
      }, 1000); // Update every second for simulation

      return () => clearInterval(timer);
    }
  }, [screen, driver]); // Depend on screen and driver

  // NEW: Effect to save state whenever it changes (only runs on client after hydration)
  useEffect(() => {
    if (hasHydrated) {
      // Only save after initial state has been loaded/set
      const stateToSave: PersistedState = {
        screen,
        pickup,
        destination,
        fareEstimate,
        driver,
        tripProgress,
        pickupCoords,
        destinationCoords,
        verificationCode,
        // NEW: Add other states you want to persist
        // walletBalance, // Example - might be fetched fresh from API
        // is2FAEnabled, // Example - might be fetched fresh from API
        // Add other states...
      };
      saveAppState(stateToSave);
    }
  }, [
    screen,
    pickup,
    destination,
    fareEstimate,
    driver,
    tripProgress,
    pickupCoords,
    destinationCoords,
    verificationCode,
    // NEW: Add other states to dependency array if they are included in stateToSave
    // walletBalance,
    // is2FAEnabled,
    hasHydrated, // Include hydration flag to prevent saving before state is loaded
  ]);

  // NEW: Handler passed to SignupPromptModal for successful registration (e.g., open OTP)
  const handleRegistrationSuccess = (email: string) => {
    // For now, simulate OTP verification success and move to dashboard
    // In reality, you'd open OTPModal here
    // setShowOTP(true); // Assuming OTPModal exists and handles verification
    // If OTP verification is successful within OTPModal, it would then trigger navigation to dashboard
    // OR, if registration API directly logs in (less common), update token and screen here.
    // Let's assume it leads to OTP first, then dashboard.
    // For this mock, let's just move to dashboard after "registration"
    setScreen("dashboard");
    setShowSignup(false); // Close signup prompt modal
    // setShowOTP(true); // Uncomment if implementing OTP flow
  };

  // NEW: Handler passed to LoginModal for successful login
  const handleLoginSuccess = () => {
    // The useAuth context should now have the token
    // page.tsx relies on the `token` from useAuth to determine initial screen and rendering logic
    // If token exists, screen should be 'dashboard' (handled by initial load or subsequent logic)
    // Ensure screen is set correctly, maybe explicitly if needed after login
    // setScreen('dashboard'); // Often not needed if initial load logic handles it based on token
    // onClose in LoginModal should be sufficient if screen logic in render is correct
    // No explicit action needed here if state management is correct, just let the parent re-render based on updated token.
    // If token changes and initial screen logic in useEffect isn't catching it, maybe force update screen here.
    // For now, assume token update in context triggers correct re-render.
    // NEW: Optionally refetch profile data after login
    // setHasHydrated(false); // Trigger re-fetch logic in profile effect by resetting hydration state slightly
    // OR, rely on the token change triggering the profile fetch effect naturally.
  };

  // NEW: Handler passed to Enable2FAModal on success
  const handle2FAEnabled = () => {
    setIs2FAEnabled(true); // Update local state
    setShowEnable2FA(false); // Close the modal
    // NEW: Optionally show a success notification
    showNotification(
      "Two-factor authentication enabled successfully!",
      "success"
    );
  };

  // NEW: Handler passed to Disable2FAModal on success
  const handle2FADisabled = () => {
    setIs2FAEnabled(false); // Update local state
    setShowDisable2FA(false); // Close the modal
    // NEW: Optionally show a success notification
    showNotification("Two-factor authentication disabled.", "info");
  };

  // NEW: Handler passed to UpdateProfileModal on success
  const handleProfileUpdated = (updatedData: any) => {
    // Update local passengerData state with the new data
    setPassengerData(updatedData);
    setShowUpdateProfile(false); // Close the modal
    // NEW: Optionally show a success notification
    showNotification("Profile updated successfully!", "success");
  };

  const handleProceed = () => {
    if (fareEstimate && pickup && destination) {
      setShowPassengerDetails(true);
    }
  };

  // src/app/page.tsx

  // Add this helper function inside your component
  const formatPhoneNumber = (input: string): string => {
    // Remove any non-digit characters (like spaces, dashes, parentheses)
    const digitsOnly = input.replace(/\D/g, "");

    // If it starts with '0', remove the '0' and prepend '+234'
    if (digitsOnly.startsWith("0")) {
      return `+234${digitsOnly.slice(1)}`;
    }

    // If it starts with '234', prepend '+'
    if (digitsOnly.startsWith("234")) {
      return `+${digitsOnly}`;
    }

    // If it already starts with '+', return as is
    if (digitsOnly.startsWith("+")) {
      return digitsOnly;
    }

    // If it's a bare number without a country code, assume it's a Nigerian number starting with '0'
    // This is a fallback; ideally, your input validation should enforce a format.
    if (digitsOnly.length === 11) {
      return `+234${digitsOnly.slice(1)}`;
    }

    // If none of the above, return as is (might cause API error)
    return digitsOnly;
  };

  // NEW: Modified handleRequestRide with mock API call simulation and state persistence
  // NEW: Modified handleRequestRide with real API call integration and state persistence
  const handleRequestRide = async () => {
  if (!passengerData.name || !passengerData.phone || !passengerData.email) {
    showNotification("Please fill all passenger details.", "error");
    return;
  }

  if (!pickupCoords || !destinationCoords) {
    showNotification(
      "Pickup and destination locations are required.",
      "error"
    );
    return;
  }

  setShowPassengerDetails(false);
  setTripRequestStatus("loading"); // Shows "Finding a driver..." modal

  try {
    // === Step A: Resolve airport ID ===
    let airportId: string | null = null;

    if (pickup.startsWith("Use my current location")) {
      // NEW: This branch might now be less likely to be triggered if BookingScreen
      // correctly sets the `pickup` state to the *resolved name* (e.g., "Murtala Muhammed International Airport")
      // and `pickupCoords` to the geolocation coords, because `pickup` no longer literally starts with "Use my current location".
      // However, keep it as a potential fallback or if the naming logic in BookingScreen changes slightly.
      // The critical part is that `pickupCoords` contains the coordinates used for the API call,
      // and `pickup` contains the *name* of the *selected* airport.

      // Fetch airports based on the coordinates stored in pickupCoords
      const nearestAirports = await findNearestAirport(pickupCoords[0], pickupCoords[1]);

      if (!nearestAirports || !nearestAirports.length) {
        setTripRequestStatus("error");
        setTripRequestError("Youre outside our service area. Booking not available from this location.");
        return;
      }

      // NEW: Find the specific airport ID based on the `pickup` name state
      // This assumes the name set by BookingScreen matches the `name` field from the API exactly.
      // This is the crucial change: match the name stored in state to the array returned by the API.
      const selectedAirport = nearestAirports.find(apt => apt.name === pickup);
      if (!selectedAirport) {
          console.error("Selected pickup name does not match any fetched airport:", pickup, nearestAirports);
          setTripRequestStatus("error");
          setTripRequestError("Could not confirm selected pickup location. Please try again.");
          return;
      }
      airportId = selectedAirport.id;

    } else if (pickup in KNOWN_AIRPORTS) {
      // Handle selection from the hardcoded list in BookingScreen
      airportId = KNOWN_AIRPORTS[pickup];
    } else {
      // Handle a custom pickup name typed by the user (e.g., via Google Autocomplete or manual entry).
      // The `pickupCoords` should now be the coordinates resolved from the *typed* destination name
      // by the Google Autocomplete component integrated into BookingScreen.
      // Call the API again to ensure the coordinates map to a valid ACHRAMS airport.
      const nearestAirports = await findNearestAirport(pickupCoords[0], pickupCoords[1]);

      if (!nearestAirports || !nearestAirports.length) {
        setTripRequestStatus("error");
        setTripRequestError("Pickup location is not near a supported airport.");
        return;
      }

      // NEW: Similar to the "Use my current location" case, find the ID based on the name stored in state.
      // For a custom name, `pickup` is the typed name, and `pickupCoords` are its resolved coordinates.
      // The API might return airports near those coordinates.
      // This logic assumes that for a custom name, the intention is to find *an* ACHRAMS airport near the *typed* location.
      // If the user types "Some Random Street", and it resolves to coordinates not near an ACHRAMS airport,
      // `findNearestAirport` should return null, and the check above (`!nearestAirports`) handles it.
      // If it *does* resolve near an airport, this code finds the ID for that airport.
      // However, if the user typed "Murtala Muhammed Int'l Airport", it should ideally resolve coordinates
      // that `findNearestAirport` matches back to the ACHRAMS entry for that airport.
      // The name matching logic here is primarily for the "Use my current location" case where the name is explicitly selected.
      // For custom names, if the coordinates are accurate, `findNearestAirport` should ideally return the relevant airport.
      // If the typed name doesn't correspond to a specific ACHRAMS airport boundary but is nearby,
      // the backend might expect the ID of the nearest ACHRAMS airport.
      // The safest bet is still to match the name if possible, or default to the first result if names don't match perfectly.
      // Let's try name matching first, then fall back.
      const selectedAirport = nearestAirports.find(apt => apt.name === pickup);
      if (selectedAirport) {
          airportId = selectedAirport.id;
      } else {
          // Fallback: if the typed name doesn't exactly match an API result name,
          // use the first result from the API call (assuming it's the nearest one).
          // This covers cases where the user types a location close to an airport but not the airport name itself,
          // and the system correctly identifies the nearest airport boundary.
          console.warn("Typed pickup name did not match any fetched airport name, using first result.", pickup, nearestAirports);
          airportId = nearestAirports[0].id;
      }
    }

    // === Step B: Prepare request body (amount, guest details, requirements, locations) ===
    // (This part remains largely the same, using fareEstimate, passengerData, requirements, pickupCoords, destinationCoords)
    const tripData = {
      amount: {
        amount: fareEstimate?.toString() || "0",
        currency: "NGN",
      },
      airport: airportId, // Use the resolved ID
      guest_name: passengerData.name,
      guest_email: passengerData.email,
      guest_phone: formatPhoneNumber(passengerData.phone),
      has_extra_leg_room: requirements.elderly,
      has_extra_luggage: requirements.luggage,
      has_wheel_chair_access: requirements.wheelchair,
      pickup_address: pickup, // The resolved/typed pickup name
      pickup_location: pickupCoords, // [lng, lat] from state
      destination_address: destination, // The typed destination name
      destination_location: destinationCoords, // [lng, lat] from state (resolved by Google Autocomplete in BookingScreen)
    };

    console.log("Request Data:", tripData);

    // === Step C: Make API call ===
    const response = await apiClient.post("/trips/guest-booking", tripData);

    console.log("Raw API Response:", response);

    if (response.status === "success" && response.data) {
      const trip = response.data;
      const extractedGuestId = trip.guest?.id;

      if (!extractedGuestId) {
        console.error("Guest ID not found in booking response, cannot start WebSocket.");
        setTripRequestStatus('error');
        setTripRequestError('Failed to get guest session. Booking cancelled.');
        return;
      }

      console.log("Trip data received:", trip);
      console.log("Guest ID received:", extractedGuestId);

      setVerificationCode(trip.verification_code || "");
      setActiveTripId(trip.id);
      setGuestId(extractedGuestId);

      if (trip.status.value === "searching") {
        setTripRequestStatus(null);
        setScreen("assigning");
        startWebSocketConnection(extractedGuestId, trip.id);
      } else if (trip.status.value === "driver_assigned" && trip.driver) {
        setDriver(trip.driver);
        setTripRequestStatus(null);
        setScreen("driver-assigned");
        // No need to start WebSocket or polling if driver is already assigned
      } else {
        console.warn("Unexpected trip status after booking:", trip.status);
        setTripRequestStatus("error");
        setTripRequestError(`Unexpected booking state: ${trip.status.label}`);
      }
    } else {
      console.error(
        "API responded with non-success status or missing data:",
        response
      );
      let errorMessage = "Failed to book your trip. Server responded unexpectedly.";
      if (response.message) {
        errorMessage = response.message;
        if (response.details) {
          const fieldErrors = [];
          for (const [field, messages] of Object.entries(response.details)) {
            if (Array.isArray(messages)) {
              fieldErrors.push(`${field}: ${messages.join(", ")}`);
            }
          }
          if (fieldErrors.length > 0) {
            errorMessage += ` Details: ${fieldErrors.join("; ")}`;
          }
        }
      }
      throw new Error(errorMessage);
    }
  } catch (err: any) {
    console.error("Guest booking error:", err);
    setTripRequestStatus("error");

    let errorMessage = "Failed to book your trip. Please check your connection and try again.";

    if (err instanceof Error) {
      errorMessage = err.message;
    } else {
      console.error("Unexpected error type caught:", typeof err, err);
      errorMessage = 'An unexpected error occurred during booking.';
    }

    setTripRequestError(errorMessage);
  }
};

 const handleShowLocationModal = () => {
    setShowLocationModal(true);
  };
const handleLocationModalClose = () => {
    setShowLocationModal(false);
  };


const handleGrantLocationAccess = () => {
  console.log("location access granted button clicked in modal. The BookingScreen will handle the requestPermission call")
}

  const startWebSocketConnection = (guestId: string, tripId: string) => {
    if (webSocketConnection) {
      // Close any existing connection before starting a new one
      console.log("Closing existing WebSocket connection.");
      webSocketConnection.close();
      // Note: The onclose handler will fire, potentially starting polling if trip is still active.
      // We might want to prevent that if we are intentionally reconnecting.
      // For now, the logic in onclose checks the screen state or activeTripId to decide.
    }

    // Construct the WebSocket URL using the guest ID
    const wsUrl = `wss://api.achrams.com.ng/ws/v1/app?guest_id=${guestId}`;

    console.log(`Attempting to connect to WebSocket: ${wsUrl}`);

    // Create the ReconnectingWebSocket instance
    const rws = new ReconnectingWebSocket(wsUrl, [], {
      // Optional configuration for ReconnectingWebSocket
      connectionTimeout: 10000, // Timeout for individual connection attempts
      maxRetries: 10, // Maximum number of reconnection attempts (or Number.MAX_VALUE for unlimited)
      maxReconnectionDelay: 10000, // Maximum delay between reconnections
      // Add other options as needed from the library's documentation
    });

    // Set up event handlers
    rws.onopen = () => {
      console.log("WebSocket connection opened.");
      setWebSocketStatus("open");
      // If polling was running as a fallback, stop it now that WS is open
      stopPollingTripStatus();
    };

    rws.onmessage = (event) => {
      try {
        const messageData: WebSocketMessage = JSON.parse(event.data);
        console.log("Received WebSocket message:", messageData);

        const { event: eventType, data: tripData } = messageData;

        // Check if it's a relevant trip update event
        if (eventType === 'trip:assigned' || eventType === 'trip:status:update') {
      // Update UI state based on the received trip data

      // NEW: Check for 'driver not found' status
      if (tripData.status.value === 'driver not found') { // Use the exact string from backend/Postman
        console.log("Driver not found via WebSocket, updating UI.");
        // Stop both WebSocket and polling
        stopWebSocketConnection();
        stopPollingTripStatus();
        // Set status to show 'no-driver' modal
        setTripRequestStatus('no-driver');
        // Optionally set a specific error message
        setTripRequestError(`No drivers available for your trip.`);
        // Do NOT change the screen here, let the modal handle the user interaction.
        // The screen might still be 'assigning', which is okay until the user retries/cancels.
        return; // Exit handler after handling 'driver not found'
      }

      // NEW: Check for 'accepted' OR 'driver_assigned' status when a driver is present
      if ((tripData.status.value === 'accepted' || tripData.status.value === 'driver_assigned') && tripData.driver) {
        // Driver found or assigned!
        console.log(`${tripData.status.label} via WebSocket, updating UI with driver.`);
        setDriver(tripData.driver);
        setScreen('driver-assigned'); // Transition to the driver-assigned screen
        stopWebSocketConnection(); // Stop WebSocket as trip is assigned/accepted
        stopPollingTripStatus(); // Ensure polling is also stopped
        // No need to start polling here, as trip is assigned/accepted.
      } else if (tripData.status.value === 'cancelled' || tripData.status.value === 'completed') {
        // Trip is no longer active, stop polling and handle accordingly
        console.log(`Trip ${tripData.id} is now ${tripData.status.value} via WebSocket.`);
        setTripRequestStatus('error'); // Or a specific status like 'trip-cancelled'
        setTripRequestError(`Trip ${tripData.status.label}.`); // Show status message
        stopWebSocketConnection(); // Stop WebSocket as trip is finished
        stopPollingTripStatus(); // Ensure polling is also stopped
        // No need to start polling here, as trip is finished.
      } else {
        // Handle other statuses if needed, or just log/update state if necessary
        // e.g., update verification code, status label, etc., if relevant
        console.log(`Received trip status update via WebSocket: ${tripData.status.value}`);
        // You might want to update activeTripId if it changed, though unlikely after initial booking
        // setActiveTripId(tripData.id);
        // setVerificationCode(tripData.verification_code || '');
        // setTripStatus(tripData.status); // If you have a separate state for trip status
      }
    } else {
      // Handle other event types if the backend sends them
      console.log(`Received other WebSocket event: ${eventType}`);
    }
  } catch (error) {
    console.error('Error parsing WebSocket message:', error, event.data);
  }
    };

    // Inside startWebSocketConnection setup
rws.onclose = (event) => {
  console.log('WebSocket connection closed:', event.code, event.reason);
  setWebSocketStatus('closed');
  // IMPORTANT: The WebSocket closed. If the trip is *not* in a final state,
  // we need to start the polling fallback.
  // Check current screen or potentially fetch latest status via API first before polling.
  // For now, if screen is still 'assigning' or related to searching/active, and we have an active trip ID, start polling.
  // We'll pass the activeTripId to the polling function.
  // NEW: Only start polling if we are still in an intermediate state and polling isn't already active.
  if (activeTripId && !['driver-assigned', 'completed', 'cancelled', 'driver not found'].includes(screen) && !pollingIntervalId) { // NEW: Check pollingIntervalId
     console.log(`WebSocket closed, starting polling for trip ${activeTripId} as fallback.`);
     startPollingTripStatus(activeTripId);
  } else {
     console.log(`WebSocket closed, but not starting polling. Trip ID: ${activeTripId}, Screen: ${screen}, Polling Active: ${!!pollingIntervalId}`);
     // If screen is a final state, ensure polling is definitely stopped just in case.
     if (['driver-assigned', 'completed', 'cancelled', 'driver not found'].includes(screen)) {
         console.log("Screen indicates final state, ensuring polling is stopped.");
         stopPollingTripStatus(); // NEW: Ensure polling stops if closed event happens after final state
     }
  }
};

    rws.onerror = (error) => {
      console.error("WebSocket error:", error);
      // Error doesn't necessarily mean the connection is closed, but log it.
      // The library handles reconnection attempts.
      // You might want to update a UI status indicator if needed.
      // setWebSocketStatus('reconnecting'); // The library handles this internally, but you can track if desired.
    };

    // Store the connection instance
    setWebSocketConnection(rws);
    setWebSocketStatus("connecting"); // Update status while connecting
  };

  // NEW: Function to stop the WebSocket connection
  const stopWebSocketConnection = () => {
    if (webSocketConnection) {

      stopPollingTripStatus();
      console.log("Manually stopping WebSocket connection.");
      webSocketConnection.close(); // This will trigger the onclose handler
      setWebSocketConnection(null);
      setWebSocketStatus("closed");
    }
  };

  const fetchTripStatus = async (tripId: string) => {
    if (!tripId || !guestId) {
      // Ensure both tripId and guestId are available
      console.warn("fetchTripStatus called without a tripId or guestId");
      return;
    }
    try {
      console.log(
        `Polling trip status for ID: ${tripId} using guestId: ${guestId}`
      );
      // Use apiClient to call GET /trips/{id}
      // The apiClient (from src/lib/api.ts) is designed to add X-Guest-Id header if guestId is provided
      const response = await apiClient.get(`/trips/${tripId}`, true, guestId); // Pass isGuest=true and guestId

      // Remember, apiClient returns the JSON body directly for success
      if (response.status === "success" && response.data) {
        const trip = response.data; // This is the trip object from the API's { status: "...",  {...} }

        console.log(
          `Polled trip status: ${
            trip.status.value
          }, has driver: ${!!trip.driver}`
        );

        // Check the status and handle accordingly
        if (trip.status.value === "driver_assigned" && trip.driver) {
          // Driver found!
          console.log("Driver assigned via polling, updating UI.");
          setDriver(trip.driver);
          setScreen("driver-assigned"); // Transition to the next screen
          stopPollingTripStatus(); // Stop polling
          stopWebSocketConnection(); // Stop WebSocket if it was re-established during polling
        } else if (
          trip.status.value === "cancelled" ||
          trip.status.value === "completed"
        ) {
          // Trip is no longer active, stop polling and handle accordingly
          console.log(
            `Trip ${tripId} is now ${trip.status.value} via polling, stopping polling.`
          );
          setTripRequestStatus("error"); // Or a specific status like 'trip-cancelled'
          setTripRequestError(`Trip ${trip.status.label}.`); // Show status message
          stopPollingTripStatus(); // Stop polling
          stopWebSocketConnection(); // Stop WebSocket if it was re-established during polling
          // You might want to clear trip details and go back to booking or dashboard
        } else {
          // Trip is still searching or in another intermediate state via polling
          console.log(
            `Trip ${tripId} is still ${trip.status.value} via polling.`
          );
          // Continue polling
        }
      } else {
        // Handle API error response (e.g., status not "success"), e.g., trip not found (404)
        console.error(
          "Polling API responded with non-success status or missing ",
          response
        );
        // Decide: Stop polling? Retry? Log and continue?
        // For a 404 (trip not found), it might imply cancellation.
        // For other errors (500, etc.), maybe continue polling briefly.
        // For now, log and continue polling (assuming temporary issue or trip not yet visible).
        // You could add logic here to stop polling after N consecutive errors.
      }
    } catch (err) {
      // Handle network error or apiClient throwing an error
      console.error("Error polling trip status:", err);
      // Decide: Stop polling after a few errors? Or continue? Add retry logic?
      // For now, log and continue polling (assuming temporary network glitch).
      // Optionally, add retry logic or error count here.
    }
  };

  const startPollingTripStatus = (tripId: string) => {
    if (pollingIntervalId) {
      // Clear any existing polling interval to avoid duplicates
      clearInterval(pollingIntervalId);
    }

    console.log(
      `Starting polling for trip ${tripId} every 5 seconds (fallback).`
    );
    const interval = setInterval(() => {
      fetchTripStatus(tripId); // Pass the tripId to the fetch function
    }, 5000); // Poll every 5 seconds

    setPollingIntervalId(interval);
  };

  // NEW: Function to stop polling
  const stopPollingTripStatus = () => {
    if (pollingIntervalId) {
      console.log("Stopping trip status polling.");
      clearInterval(pollingIntervalId);
      setPollingIntervalId(null);
    }
  };

  useEffect(() => {
    return () => {
      console.log("Cleaning up WebSocket and polling intervals on unmount.");
      stopWebSocketConnection();
      stopPollingTripStatus();
    };
  }, []);

  const handleTripStart = () => {
    setScreen("trip-progress");
  };

  const handleRateSubmit = () => {
    setScreen("trip-complete");
  };

  const handleTripComplete = () => {
    setScreen("trip-complete");
  };

  // NEW: Wait for hydration before rendering main content to avoid SSR/client mismatch
  if (!hasHydrated) {
    return (
      <div className="flex items-center justify-center h-screen w-full bg-white animate-fadeIn">
        <div className="relative">
          {/* Soft pulsing glow */}
          <div className="absolute inset-0 rounded-2xl bg-achrams-gradient-primary opacity-40 blur-xl animate-pulse"></div>

          {/* Main Logo Container */}
          <div className="w-16 h-16 bg-achrams-gradient-primary rounded-2xl flex items-center justify-center shadow-xl animate-scaleIn relative overflow-hidden">
            {/* Subtle rotating light sweep */}
            <div className="absolute inset-0 bg-white/20 animate-sweep pointer-events-none"></div>

            <Image
              src="/images/logo.png"
              alt="ACHRAMS Logo"
              width={30}
              height={30}
              className="object-contain animate-popIn"
            />
          </div>
        </div>
      </div>
    ); // Or a skeleton loader
  }

  // === Render current screen as main content ===
  let mainContent = null;

  if (screen === "booking") {
    mainContent = (
      <BookingScreen
        pickup={pickup}
        setPickup={setPickup}
        destination={destination}
        setDestination={setDestination}
        fareEstimate={fareEstimate}
        setFareEstimate={setFareEstimate}
        onProceed={handleProceed}
        setShowPassengerDetails={setShowPassengerDetails}
        passengerData={passengerData}
        setPassengerData={setPassengerData}
        showPassengerDetails={showPassengerDetails}
        requirements={requirements}
        setRequirements={setRequirements}
        setPickupCoords={setPickupCoords} // NEW
        setDestinationCoords={setDestinationCoords} // NEW
        onShowLocationModal={handleShowLocationModal}


      />
    );
  } else if (screen === "assigning") {
    mainContent = <AssigningScreen 
    status={tripRequestStatus}
    />;
  } else if (screen === "driver-assigned") {
    mainContent = (
      <DriverAssignedScreen
        pickup={pickup}
        destination={destination}
        driver={driver}
        verificationCode={verificationCode || ""} // NEW: Pass verification code
        onShowDirections={() => setShowDirections(true)}
        onShowDriverVerification={() => setShowDriverVerification(true)} // NEW: Handler for verification modal
        onStartTrip={handleTripStart}
        onBack={() => setScreen("booking")}
      />
    );
  } else if (screen === "trip-progress") {
    // NEW: Use the statically imported TripProgressScreen
    mainContent = (
      <TripProgressScreen
        driver={driver}
        onPanic={() => setShowPanic(true)}
        onComplete={handleTripComplete}
        pickupCoords={pickupCoords} // NEW: Pass coordinates
        destinationCoords={destinationCoords} // NEW: Pass coordinates
        tripProgress={tripProgress} // NEW: Pass progress
        // Remove canRenderMaps prop as it's no longer needed if using dynamic import for the screen was the main strategy
      />
    );
  } else if (screen === "trip-complete") {
    mainContent = (
      <TripCompleteScreen
        fareEstimate={fareEstimate}
        driver={driver}
        onRate={() => setShowRate(true)}
        onDone={() => {
          // NEW: Clear specific trip-related state before navigating
          setPickup("");
          setDestination("");
          setFareEstimate(null);
          setDriver(null);
          setTripProgress(0);
          setPickupCoords(null);
          setDestinationCoords(null);
          setVerificationCode(null); // NEW: Clear verification code
          // alert('was called');
          setGuestId(null); // NEW: Clear guest ID
          // Stop any potential polling/WebSocket if they were still running due to timing
          stopPollingTripStatus();
          stopWebSocketConnection();
          if (!token) {
            setScreen("dashboard");
          } else {
            // NEW: Instead of setting screen to 'signup-prompt', just set the showSignup state
            setScreen("booking");
            // setShowSignup(true);
          }
        }}
      />
    );
  } else if (screen === "dashboard") {
    // NEW: Render the DashboardScreen component
    mainContent = (
      <DashboardScreen
        passengerData={passengerData}
        walletBalance={walletBalance} // NEW: Pass wallet balance
        is2FAEnabled={is2FAEnabled} // NEW: Pass 2FA status
        onShowProfile={() => setShowProfile(true)}
        onBookNewTrip={() => {
          setScreen("booking");
          setPickup("");
          setDestination("");
          setFareEstimate(null);
          setPickupCoords(null);
          setDestinationCoords(null);
          setDriver(null);
          setTripProgress(0); // NEW: Reset trip progress
          setVerificationCode(null); // NEW: Reset verification code
        }}
        // NEW: Pass handlers for new dashboard features
        onShowTripHistory={() => setShowTripHistory(true)}
        onShowWallet={() => setShowWallet(true)}
        onShowSettings={() => setShowSettings(true)}
        onShowEnable2FA={() => setShowEnable2FA(true)} // NEW: Handler for enabling 2FA
        onShowUpdateProfile={() => setShowUpdateProfile(true)} // NEW: Handler for updating profile
        onBookRide={() => setScreen("booking")}
        onProfile={() => setShowProfile(true)}
        onLogout={() => {}}
      />
    );
  }
  // NEW: Render new screens if their state is active (overlaying the dashboard or other screens if needed)
  // These are rendered *instead of* the main screen content when active.
  else if (showTripHistory) {
    mainContent = (
      <TripHistoryScreen
        onBack={() => setShowTripHistory(false)} // NEW: Handler to go back to dashboard
        onSelectTrip={(tripId) => {
          setSelectedTripId(tripId);
          setShowTripHistory(false); // Close history
          setShowTripDetails(true); // Open details
        }}
      />
    );
  } else if (showTripDetails && selectedTripId) {
    mainContent = (
      <TripDetailsScreen
        tripId={selectedTripId}
        onBack={() => {
          setShowTripDetails(false);
          setSelectedTripId(null); // Clear selected ID
          setShowTripHistory(true); // Optionally go back to history
        }}
      />
    );
  } else if (showWallet) {
    mainContent = (
      <WalletScreen
        balance={walletBalance} // NEW: Pass current balance
        onBack={() => setShowWallet(false)} // NEW: Handler to go back to dashboard
      />
    );
  } else if (showSettings) {
    mainContent = (
      <SettingsScreen
        onBack={() => setShowSettings(false)} // NEW: Handler to go back to dashboard
        onShowProfile={() => {
          setShowSettings(false);
          setShowProfile(true);
        }} // NEW: Navigate to profile from settings
        onShowEnable2FA={() => {
          setShowSettings(false);
          setShowEnable2FA(true);
        }} // NEW: Navigate to 2FA enable from settings
        onShowUpdateProfile={() => {
          setShowSettings(false);
          setShowUpdateProfile(true);
        }} // NEW: Navigate to profile update from settings
        // Add other handlers for settings options (notifications, help, etc.)
      />
    );
  }
  // Note: Removed the 'signup-prompt' screen render block as it's handled by the showSignup state and modal

  // === Return full UI tree including modals and notifications ===
  return (
    <>
      <div className="min-h-screen flex items-center justify-center">
        <div
          className="
  min-h-screen h-dvh
  w-full max-w-[430px] mx-auto
  bg-white
  flex flex-col
  /* Critical for header/body/footer layouts */
  text-sm
  antialiased
  [font-feature-settings:'ss01']
"
        >
          {/* NEW: Render notification if available */}
          {currentNotification && (
            <TripUpdateNotification
              message={currentNotification.message}
              type={currentNotification.type}
              onDismiss={() => setCurrentNotification(null)}
            />
          )}

          {mainContent}

          {/* Modals  all rendered as overlays */}
          <PassengerDetailsModal
            isOpen={showPassengerDetails}
            onClose={() => setShowPassengerDetails(false)}
            passengerData={passengerData}
            setPassengerData={setPassengerData}
            requirements={requirements}
            setRequirements={setRequirements}
            onRequestRide={handleRequestRide}
            isLoading={tripRequestStatus === "loading"}
          />

           <LocationPermissionModal
              isOpen={showLocationModal}
              onClose={handleLocationModalClose}
              onGrantAccess={handleGrantLocationAccess}
            />

          {/* NEW: Dynamically imported DirectionsModal */}
          {hasHydrated && (
            <DirectionsModal
              isOpen={showDirections}
              onClose={() => setShowDirections(false)}
              pickup={pickup}
              pickupCoords={pickupCoords}
              destination={destination} // NEW
              destinationCoords={destinationCoords} // NEW
            />
          )}

          <PanicModal
            isOpen={showPanic}
            onClose={() => setShowPanic(false)}
            onComplete={() => {
              setShowPanic(false);
              alert("Safety team notified");
            }}
          />

          {!token &&
            showSignup && ( // Ensure it only shows for unauthenticated users
              <SignupPromptModal
                isOpen={showSignup} // Use showSignup state
                passengerData={passengerData}
                onClose={() => setShowSignup(false)} // Close the modal state
                onVerifyEmail={() => setShowOTP(true)} // Keep existing link to OTP
                onRegistrationSuccess={handleRegistrationSuccess} // NEW: Pass success handler
                onOpenLoginModal={() => setShowLogin(true)} // NEW: Pass handler to open login modal
                onSignup={() => {
                  // NEW: Handler for signup button in modal (e.g., navigate to register)
                  setShowSignup(false);
                  // You could navigate to a registration page or open the registration modal here
                  // For now, just close the prompt.
                }}
                onLogin={() => {
                  // NEW: Handler for login button in modal (e.g., open login modal)
                  setShowSignup(false);
                  // You could open a login modal here
                  // For now, just close the prompt.
                }}
                onContinueAsGuest={() => {
                  // NEW: Handler for continue as guest button (e.g., close modal, maybe navigate to dashboard)
                  setShowSignup(false);
                  setScreen("dashboard"); // Example: go to dashboard after trip
                }}
                // NEW: Pass registration success handler
              />
            )}

          <OTPModal
            isOpen={showOTP}
            email={passengerData.email}
            onComplete={() => {
              setTimeout(() => {
                setScreen("dashboard");
                setShowOTP(false);
                setShowSignup(false);
              }, 1000);
            }}
            onClose={() => setShowOTP(false)}
          />

          <ProfileModal
            isOpen={showProfile}
            passengerData={passengerData}
            onClose={() => setShowProfile(false)}
            onLogout={() => {
              // Clear saved state on logout
              if (typeof window !== "undefined" && window.sessionStorage) {
                sessionStorage.removeItem("achrams_app_state");
              }
              window.location.href = "/auth/login";
            }}
          />

          {/* NEW: Trip Request Status Modal */}
          <TripRequestStatusModal
            isOpen={!!tripRequestStatus}
            status={tripRequestStatus}
            message={tripRequestError}
            onClose={() => {setTripRequestStatus(null)
              setScreen("booking")
            }}
            onConfirm={() => {
                if (tripRequestStatus === 'no-driver' || tripRequestStatus === 'error') {
                  // NEW: If status is 'no-driver' or 'error', retry the booking process
                  console.log("Retrying booking process...");
                  setTripRequestStatus(null); // Close the modal first
                  // NEW: Call the main booking function again to restart the flow
                  handleRequestRide();
                } else {
                  // For 'loading' or 'accepted' states, just close the modal
                  setTripRequestStatus(null);
                }}}
          />

          {/* NEW: Driver Verification Modal */}
          <DriverVerificationModal
            isOpen={showDriverVerification}
            securityCode={verificationCode || ""}
            onClose={() => setShowDriverVerification(false)}
          />

          {/* NEW: Login Modal */}
          <LoginModal
            isOpen={showLogin}
            onClose={() => setShowLogin(false)}
            onLoginSuccess={handleLoginSuccess} // NEW: Pass success handler
          />

          {/* NEW: Modals for dashboard features */}
          {showEnable2FA && (
            <Enable2FAModal
              isOpen={showEnable2FA}
              onClose={() => setShowEnable2FA(false)}
              onSuccess={handle2FAEnabled} // NEW: Pass success handler
            />
          )}
          {showDisable2FA && (
            <Disable2FAModal
              isOpen={showDisable2FA}
              onClose={() => setShowDisable2FA(false)}
              onSuccess={handle2FADisabled} // NEW: Pass success handler
            />
          )}
          {showUpdateProfile && (
            <UpdateProfileModal
              isOpen={showUpdateProfile}
              initialData={passengerData} // Pass current data as initial values
              onClose={() => setShowUpdateProfile(false)}
              onSuccess={handleProfileUpdated} // NEW: Pass success handler
            />
          )}

          {/* Future: Uncomment when implemented */}
          <CancelModal
            isOpen={showCancel}
            onClose={() => setShowCancel(false)}
            onConfirm={() => {}}
          />
          {showRate && (
            <RateModal
              isOpen={showRate}
              onClose={() => setShowRate(false)}
              onRate={handleRateSubmit} // Assuming you have a function to handle API call
              driverName={driver?.name}
              // NEW: Pass the notification setter as setNotification
              setNotification={setCurrentNotification} // Use setCurrentNotification
            />
          )}
          <MessageWindowModal
            isOpen={showMessage}
            onClose={() => setShowMessage(false)}
            recipientName={driver?.name || "Driver"}
          />
        </div>
      </div>
      {/* NEW: Bottom Navigation Bar - Rendered only on dashboard screen */}
      {screen === "dashboard" && (
        <BottomNavBar
          onProfileClick={() => setShowProfile(true)}
          walletBalance={walletBalance} // Pass balance for potential icon badge
          onHomeClick={() => setScreen("booking")} // Example: Home click books new trip
          onWalletClick={() => setShowWallet(true)} // NEW: Link wallet click
          onSearchClick={() => setShowTripHistory(true)} // Example: Link search to history
          // Add other handlers for new nav items if needed
        />
      )}
    </>
  );
}


----- FILE: src/app/globals.css -----
/* src/app/globals.css */
@import "tailwindcss";
/* Define ACHRAMS theme tokens using @theme */


@utility bg-achrams-gradient-primary {
  background: linear-gradient(
    135deg,
    #06b27c 0%,
    #059669 40%,
    #0d9488 100%
  );
}

@utility bg-achrams-gradient-secondary {
  background: linear-gradient(
    135deg,
    #0da9a0 0%,
    #0d9488 45%,
    #0891b2 100%
  );
}

@theme {

  /* Solid Colors */
  --color-achrams-primary-solid: #059669;
  --color-achrams-secondary-solid: #0d9488;
  --color-achrams-accent: #0891b2;
  --color-achrams-text-primary: #1f2937;
  --color-achrams-text-secondary: #6b7280;
  --color-achrams-text-light: #f9fafb;
  --color-achrams-background-primary: #ffffff;
  --color-achrams-background-secondary: #f3f4f6;
  --color-achrams-background-card: #ffffff;
  --color-achrams-border: #e5e7eb;
}

/* Your existing default theme variables can remain if needed */
:root {
  --background: #ffffff; /* Aligns with achrams-background-primary */
  --foreground: #171717;
}

/* @media (prefers-color-scheme: dark) {
  :root {
    --background: #0a0a0a;
    --foreground: #ededed;
  }
} */

/* Your existing body styles */
body {
  background: var(--background);
  color: var(--foreground);
  font-family: Arial, Helvetica, sans-serif;
  margin: 0;
  padding: 0;
  height: 100%;
}

#__next,
html,
body {
  height: 100%;
}

/* 3. Mobile viewport height fix (very important on iOS/Android) */
@viewport {
  width: device-width;
  height: device-height;
}

/* 4. Optional: respect safe-area on notched devices */
@layer utilities {
  .pt-safe {
    padding-top: env(safe-area-inset-top);
  }
  .pb-safe {
    padding-bottom: env(safe-area-inset-bottom);
  }
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
@keyframes scaleIn {
  from { transform: scale(0.8); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}
@keyframes fadeInScale {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

.animate-fadeIn {
  animation: fadeIn 0.3s ease-out forwards;
}
.animate-fadeInUp {
  animation: fadeInUp 0.4s ease-out forwards;
}
.animate-scaleIn {
  animation: scaleIn 0.3s ease-out forwards;
}
.animate-fadeInScale {
  animation: fadeInScale 0.3s ease-out forwards;
}

----- FILE: src/app/page.tsx -----
// src/app/page.tsx
"use client";

import { useEffect, useState } from "react";
import { useAuth } from "@/contexts/AuthContext";
import BookingScreen from "@/components/app/screens/BookingScreen";
import AssigningScreen from "@/components/app/screens/AssigningScreen";
import DriverAssignedScreen from "@/components/app/screens/DriverAssignedScreen";
// NEW: Import TripProgressScreen statically
import TripProgressScreen from "@/components/app/screens/TripProgressScreen";
import TripCompleteScreen from "@/components/app/screens/TripCompleteScreen";
// NEW: Import new dashboard-related screens
import TripHistoryScreen from "@/components/app/screens/TripHistoryScreen";
import TripDetailsScreen from "@/components/app/screens/TripDetailsScreen";
import WalletScreen from "@/components/app/screens/WalletScreen";
import SettingsScreen from "@/components/app/screens/SettingsScreen";

// NEW: Import the dashboard screen (assuming it's updated to handle new features)
import DashboardScreen from "@/components/app/screens/DashboardScreen";

// Modals - Dynamically import map-dependent modals like DirectionsModal
import dynamic from "next/dynamic";
const DirectionsModal = dynamic(
  () => import("@/components/app/modals/DirectionsModal"),
  { ssr: false }
);

// Modals - Imported normally
import PassengerDetailsModal from "@/components/app/modals/PassengerDetailsModal";
import PanicModal from "@/components/app/modals/PanicModal";
import SignupPromptModal from "@/components/app/modals/SignupPromptModal";
import OTPModal from "@/components/app/modals/OTPModal";
import ProfileModal from "@/components/app/modals/ProfileModal";
import CancelModal from "@/components/app/modals/CancelModal";
import RateModal from "@/components/app/modals/RateModal";
import MessageWindowModal from "@/components/app/modals/MessageWindowModal";
import TripRequestStatusModal from "@/components/app/modals/TripRequestStatusModal";
import DriverVerificationModal from "@/components/app/modals/DriverVerificationModal";
import LoginModal from "@/components/app/modals/LoginModal";
// NEW: Import new modals
import Enable2FAModal from "@/components/app/modals/Enable2FAModal";
import Disable2FAModal from "@/components/app/modals/Disable2FAModal";
import UpdateProfileModal from "@/components/app/modals/UpdateProfileModal";


import Image from "next/image";
import { apiClient } from "@/lib/api";

// UI
import TripUpdateNotification from "@/components/app/ui/TripUpdateNotification";
// NEW: Import BottomNavBar
import BottomNavBar from "@/components/app/ui/BottomNavBar";
import { findNearestAirport, KNOWN_AIRPORTS } from "@/lib/airports";
import ReconnectingWebSocket from "reconnecting-websocket";

type TripStatusValue =
  | "searching"
  | "driver_assigned"
  | "accepted"
  | "active"
  | "completed"
  | "cancelled"
  | "driver not found"; // Added "driver not found"

  type TripStatus = {
  label: string;
  value: TripStatusValue;
};

// NEW: Define types for the WebSocket message
type WebSocketMessage = {
  event: "trip:assigned" | "trip:status:update" | string; // Add other potential events
  any; // This will be the trip object
};

// Types
type ScreenState =
  | "booking"
  | "assigning"
  | "driver-assigned"
  | "trip-progress"
  | "trip-complete"
  | "dashboard";
// NEW: Add any new screen states if necessary, though most new features will be modals/screens on top of 'dashboard'

type Requirements = {
  luggage: boolean;
  wheelchair: boolean;
  elderly: boolean;
};

type PassengerData = {
  name: string;
  phone: string;
  email: string;
};

// NEW: Define type for the state you want to persist
interface PersistedState {
  screen: ScreenState;
  pickup: string;
  destination: string;
  fareEstimate: number | null;
  driver: any | null;
  tripProgress: number;
  pickupCoords: [number, number] | null;
  destinationCoords: [number, number] | null;
  verificationCode: string | null;
  // NEW: Add other critical states you want to persist across refresh
  // e.g., walletBalance, is2FAEnabled (though these might be fetched fresh from API on load)
  // Add other critical states as needed
}

// NEW: Function to save state to sessionStorage - only runs on client
const saveAppState = (state: PersistedState) => {
  if (typeof window !== "undefined" && window.sessionStorage) {
    try {
      sessionStorage.setItem("achrams_app_state", JSON.stringify(state));
      console.log("App state saved to sessionStorage"); // Optional: For debugging
    } catch (e) {
      console.error("Failed to save app state to sessionStorage", e);
    }
  }
};

// NEW: Function to load state from sessionStorage - only runs on client
const loadAppState = (): PersistedState | null => {
  if (typeof window !== "undefined" && window.sessionStorage) {
    try {
      const savedStateStr = sessionStorage.getItem("achrams_app_state");
      if (savedStateStr) {
        const savedState = JSON.parse(savedStateStr) as PersistedState;
        console.log("App state loaded from sessionStorage", savedState); // Optional: For debugging
        return savedState;
      }
    } catch (e) {
      console.error("Failed to load app state from sessionStorage", e);
    }
  }
  return null; // Return null if sessionStorage is not available or error occurred
};

export default function ACHRAMApp() {
  const { token } = useAuth();

  // NEW: Use a state variable to track if we have checked sessionStorage on the client
  const [hasHydrated, setHasHydrated] = useState(false);

  // NEW: Define state variables without initial values from loadAppState here
  const [screen, setScreen] = useState<ScreenState>("booking"); // Will be set after hydration
  const [pickup, setPickup] = useState<string>("");
  const [destination, setDestination] = useState<string>("");
  const [fareEstimate, setFareEstimate] = useState<number | null>(null);
  const [driver, setDriver] = useState<any>(null);
  const [tripProgress, setTripProgress] = useState<number>(0);
  const [pickupCoords, setPickupCoords] = useState<[number, number] | null>(
    null
  );
  const [destinationCoords, setDestinationCoords] = useState<
    [number, number] | null
  >(null);
  const [verificationCode, setVerificationCode] = useState<string | null>(null);
  const [guestId, setGuestId] = useState<string | null>(null); // NEW: Store guest ID
  const [activeTripId, setActiveTripId] = useState<string | null>(null); // NEW: Store active trip ID (from booking response)
  // NEW: State for WebSocket connection
  const [webSocketConnection, setWebSocketConnection] =
    useState<ReconnectingWebSocket | null>(null);
  const [webSocketStatus, setWebSocketStatus] = useState<
    "connecting" | "open" | "closed" | "reconnecting"
  >("closed");
  // NEW: State for polling fallback
  const [pollingIntervalId, setPollingIntervalId] =
    useState<NodeJS.Timeout | null>(null);

  // NEW: State for new dashboard features (these might be fetched from API on load)
  const [walletBalance, setWalletBalance] = useState<number>(0); // NEW: State for wallet balance
  const [is2FAEnabled, setIs2FAEnabled] = useState<boolean>(false); // NEW: State for 2FA status
  // const [activeTripId, setActiveTripId] = useState<string | null>(null); // NEW: State for active trip ID (if any)

  // NEW: State for modals (these can be initialized normally)
  const [showPassengerDetails, setShowPassengerDetails] = useState(false);
  const [showDirections, setShowDirections] = useState(false);
  const [showPanic, setShowPanic] = useState(false);
  const [showSignup, setShowSignup] = useState(false); // NEW: Use this state instead of screen === 'signup-prompt'
  const [showOTP, setShowOTP] = useState(false);
  const [showProfile, setShowProfile] = useState(false);
  const [showCancel, setShowCancel] = useState(false);
  const [showRate, setShowRate] = useState(false);
  const [showMessage, setShowMessage] = useState(false);

  // NEW: State for new modals/screens
  const [showTripHistory, setShowTripHistory] = useState(false);
  const [showTripDetails, setShowTripDetails] = useState(false);
  const [selectedTripId, setSelectedTripId] = useState<string | null>(null);
  const [showWallet, setShowWallet] = useState(false);
  const [showSettings, setShowSettings] = useState(false);
  const [showEnable2FA, setShowEnable2FA] = useState(false);
  const [showDisable2FA, setShowDisable2FA] = useState(false);
  const [showUpdateProfile, setShowUpdateProfile] = useState(false);

  // NEW: State for Login Modal
  const [showLogin, setShowLogin] = useState(false); // NEW: Add state for login modal

  // NEW: State for trip request status modal
  const [tripRequestStatus, setTripRequestStatus] = useState<
    "loading" | "accepted" | "no-driver" | "error" | null
  >(null);
  const [tripRequestError, setTripRequestError] = useState<string | null>(null);

  // NEW: State for driver verification modal
  const [showDriverVerification, setShowDriverVerification] = useState(false);

 


  // NEW: State for trip update notifications
  const [currentNotification, setCurrentNotification] = useState<{
    message: string;
    type: "info" | "success" | "warning" | "error";
  } | null>(null);

  // NEW: Effect to run only on the client after mount to load state and set initial values
  useEffect(() => {
    // Check if we are on the client
    if (typeof window !== "undefined") {
      const savedState = loadAppState();
      if (savedState) {
        // Set state using the loaded values
        setScreen(savedState.screen);
        setPickup(savedState.pickup);
        setDestination(savedState.destination);
        setFareEstimate(savedState.fareEstimate);
        setDriver(savedState.driver);
        setTripProgress(savedState.tripProgress);
        setPickupCoords(savedState.pickupCoords);
        setDestinationCoords(savedState.destinationCoords);
        setVerificationCode(savedState.verificationCode);
        // NEW: Load other persisted states if added
        // setWalletBalance(savedState.walletBalance); // Example
        // setIs2FAEnabled(savedState.is2FAEnabled); // Example
      } else {
        // Set default initial state based on token
        setScreen(token ? "dashboard" : "booking");
      }
      // Mark as hydrated after loading/saving defaults
      setHasHydrated(true);
    } else {
      // Fallback if somehow this runs on server (shouldn't with 'use client')
      setScreen(token ? "dashboard" : "booking");
      setHasHydrated(true);
    }
  }, [token]); // Depend on token if initial screen logic depends on it

  // NEW: Effect to fetch user profile data (including 2FA status, wallet, active trip) on initial load or token change
  useEffect(() => {
    if (hasHydrated && token) {
      const fetchUserProfile = async () => {
        try {
          // NEW: Call the API to get user profile using apiClient
          // Example: const response = await apiClient.get('/auth/passenger/me');
          // Example structure based on passenger postman DOC.txt:
          // const profileData = response.data.data;
          // setWalletBalance(profileData.profile.wallet.balance.amount);
          // setIs2FAEnabled(profileData.is_2fa_enabled);
          // if (profileData.profile.active_trip) {
          //    setActiveTripId(profileData.profile.active_trip.id);
          //    // Potentially set screen to 'driver-assigned' or 'trip-progress' if active trip exists
          //    // This logic depends on your desired UX for resuming active trips
          // }

          // For now, simulate with mock data after a short delay
          setTimeout(() => {
            setWalletBalance(5000); // Mock balance
            setIs2FAEnabled(false); // Mock 2FA status
            // setActiveTripId(null); // Mock active trip ID - assume no active trip for this example
          }, 500); // Simulate API delay
        } catch (err) {
          console.error("Failed to fetch user profile:", err);
          // NEW: Optionally show an error notification
          setCurrentNotification({
            message: "Failed to load profile data.",
            type: "error",
          });
          setTimeout(() => setCurrentNotification(null), 5000);
        }
      };

      fetchUserProfile();
    }
  }, [hasHydrated, token]); // Run when hydrated state is true and token changes

  // NEW: Effect to handle navigation after trip completion and set showSignup
  useEffect(() => {
    if (screen === "trip-complete") {
      // Check if user is authenticated
      if (token) {
        // If authenticated, maybe show rate modal (if not already shown) and then go to dashboard
        // Or, if rating is handled elsewhere, just go to dashboard after a delay or user action
        // For now, let's assume the user can click a button or it happens automatically after a short delay
        // Or, the TripCompleteScreen itself could trigger this.
        // Let's simulate a delay and then transition to dashboard if authenticated.
        // This is just a simulation, the real trigger might be clicking 'Done' in TripCompleteScreen.
        // We'll add a specific state to manage this transition cleanly.
        // Let's assume the TripCompleteScreen has a button that calls a handler passed from page.tsx.
        // For now, let's just add the logic here that *would* happen when the user wants to leave the trip-complete screen.
        // The key is to clear trip data and set screen to dashboard *before* the save effect runs.
      } else {
        // If not authenticated (guest), show signup prompt after a delay
        const timer = setTimeout(() => {
          // NEW: Clear specific trip-related state before navigating to signup
          // Note: This clearing is now handled in the onDone handler in TripCompleteScreen render block
          // We set showSignup here, which triggers the modal.
          setShowSignup(true); // NEW: Trigger the signup modal
        }, 1500); // Delay matches the original effect

        return () => clearTimeout(timer);
      }
    }
  }, [screen, token]); // Depend on screen and token only

  // Data state
  const [passengerData, setPassengerData] = useState<PassengerData>({
    name: "",
    phone: "",
    email: "",
  });
  const [requirements, setRequirements] = useState<Requirements>({
    luggage: false,
    wheelchair: false,
    elderly: false,
  });

  // NEW: Function to show notifications
  const showNotification = (
    message: string,
    type: "info" | "success" | "warning" | "error"
  ) => {
    setCurrentNotification({ message, type });
    setTimeout(() => {
      setCurrentNotification(null);
    }, 5000); // Auto-dismiss after 5 seconds
  };

  // NEW: Effect to trigger notifications based on screen changes (simulated)
  useEffect(() => {
    if (screen === "driver-assigned" && driver) {
      // Simulate driver found notification
      showNotification("Driver assigned successfully!", "success");
      // Simulate trip updates after some delay
      const timer1 = setTimeout(
        () => showNotification("Driver is 7 mins from pickup location", "info"),
        3000
      );
      const timer2 = setTimeout(
        () =>
          showNotification("Driver has arrived at pickup location", "success"),
        10000
      );

      return () => {
        clearTimeout(timer1);
        clearTimeout(timer2);
      };
    }
    if (screen === "trip-progress") {
      // Simulate ongoing trip updates
      const timer = setInterval(() => {
        setTripProgress((prev) => {
          if (prev >= 100) {
            clearInterval(timer);
            setScreen("trip-complete");
            return 100;
          }
          return prev + 2; // Simulate progress
        });
      }, 1000); // Update every second for simulation

      return () => clearInterval(timer);
    }
  }, [screen, driver]); // Depend on screen and driver

  // NEW: Effect to save state whenever it changes (only runs on client after hydration)
  useEffect(() => {
    if (hasHydrated) {
      // Only save after initial state has been loaded/set
      const stateToSave: PersistedState = {
        screen,
        pickup,
        destination,
        fareEstimate,
        driver,
        tripProgress,
        pickupCoords,
        destinationCoords,
        verificationCode,
        // NEW: Add other states you want to persist
        // walletBalance, // Example - might be fetched fresh from API
        // is2FAEnabled, // Example - might be fetched fresh from API
        // Add other states...
      };
      saveAppState(stateToSave);
    }
  }, [
    screen,
    pickup,
    destination,
    fareEstimate,
    driver,
    tripProgress,
    pickupCoords,
    destinationCoords,
    verificationCode,
    // NEW: Add other states to dependency array if they are included in stateToSave
    // walletBalance,
    // is2FAEnabled,
    hasHydrated, // Include hydration flag to prevent saving before state is loaded
  ]);

  // NEW: Handler passed to SignupPromptModal for successful registration (e.g., open OTP)
  const handleRegistrationSuccess = (email: string) => {
    // For now, simulate OTP verification success and move to dashboard
    // In reality, you'd open OTPModal here
    // setShowOTP(true); // Assuming OTPModal exists and handles verification
    // If OTP verification is successful within OTPModal, it would then trigger navigation to dashboard
    // OR, if registration API directly logs in (less common), update token and screen here.
    // Let's assume it leads to OTP first, then dashboard.
    // For this mock, let's just move to dashboard after "registration"
    setScreen("dashboard");
    setShowSignup(false); // Close signup prompt modal
    // setShowOTP(true); // Uncomment if implementing OTP flow
  };

  // NEW: Handler passed to LoginModal for successful login
  const handleLoginSuccess = () => {
    // The useAuth context should now have the token
    // page.tsx relies on the `token` from useAuth to determine initial screen and rendering logic
    // If token exists, screen should be 'dashboard' (handled by initial load or subsequent logic)
    // Ensure screen is set correctly, maybe explicitly if needed after login
    // setScreen('dashboard'); // Often not needed if initial load logic handles it based on token
    // onClose in LoginModal should be sufficient if screen logic in render is correct
    // No explicit action needed here if state management is correct, just let the parent re-render based on updated token.
    // If token changes and initial screen logic in useEffect isn't catching it, maybe force update screen here.
    // For now, assume token update in context triggers correct re-render.
    // NEW: Optionally refetch profile data after login
    // setHasHydrated(false); // Trigger re-fetch logic in profile effect by resetting hydration state slightly
    // OR, rely on the token change triggering the profile fetch effect naturally.
  };

  // NEW: Handler passed to Enable2FAModal on success
  const handle2FAEnabled = () => {
    setIs2FAEnabled(true); // Update local state
    setShowEnable2FA(false); // Close the modal
    // NEW: Optionally show a success notification
    showNotification(
      "Two-factor authentication enabled successfully!",
      "success"
    );
  };

  // NEW: Handler passed to Disable2FAModal on success
  const handle2FADisabled = () => {
    setIs2FAEnabled(false); // Update local state
    setShowDisable2FA(false); // Close the modal
    // NEW: Optionally show a success notification
    showNotification("Two-factor authentication disabled.", "info");
  };

  // NEW: Handler passed to UpdateProfileModal on success
  const handleProfileUpdated = (updatedData: any) => {
    // Update local passengerData state with the new data
    setPassengerData(updatedData);
    setShowUpdateProfile(false); // Close the modal
    // NEW: Optionally show a success notification
    showNotification("Profile updated successfully!", "success");
  };

  const handleProceed = () => {
    if (fareEstimate && pickup && destination) {
      setShowPassengerDetails(true);
    }
  };

  // src/app/page.tsx

  // Add this helper function inside your component
  const formatPhoneNumber = (input: string): string => {
    // Remove any non-digit characters (like spaces, dashes, parentheses)
    const digitsOnly = input.replace(/\D/g, "");

    // If it starts with '0', remove the '0' and prepend '+234'
    if (digitsOnly.startsWith("0")) {
      return `+234${digitsOnly.slice(1)}`;
    }

    // If it starts with '234', prepend '+'
    if (digitsOnly.startsWith("234")) {
      return `+${digitsOnly}`;
    }

    // If it already starts with '+', return as is
    if (digitsOnly.startsWith("+")) {
      return digitsOnly;
    }

    // If it's a bare number without a country code, assume it's a Nigerian number starting with '0'
    // This is a fallback; ideally, your input validation should enforce a format.
    if (digitsOnly.length === 11) {
      return `+234${digitsOnly.slice(1)}`;
    }

    // If none of the above, return as is (might cause API error)
    return digitsOnly;
  };

  // NEW: Modified handleRequestRide with mock API call simulation and state persistence
  // NEW: Modified handleRequestRide with real API call integration and state persistence
  const handleRequestRide = async () => {
  if (!passengerData.name || !passengerData.phone || !passengerData.email) {
    showNotification("Please fill all passenger details.", "error");
    return;
  }

  if (!pickupCoords || !destinationCoords) {
    showNotification(
      "Pickup and destination locations are required.",
      "error"
    );
    return;
  }

  setShowPassengerDetails(false);
  setTripRequestStatus("loading"); // Shows "Finding a driver..." modal

  try {
    // === Step A: Resolve airport ID ===
    let airportId: string | null = null;

    if (pickup.startsWith("Use my current location")) {
      // NEW: This branch might now be less likely to be triggered if BookingScreen
      // correctly sets the `pickup` state to the *resolved name* (e.g., "Murtala Muhammed International Airport")
      // and `pickupCoords` to the geolocation coords, because `pickup` no longer literally starts with "Use my current location".
      // However, keep it as a potential fallback or if the naming logic in BookingScreen changes slightly.
      // The critical part is that `pickupCoords` contains the coordinates used for the API call,
      // and `pickup` contains the *name* of the *selected* airport.

      // Fetch airports based on the coordinates stored in pickupCoords
      const nearestAirports = await findNearestAirport(pickupCoords[0], pickupCoords[1]);

      if (!nearestAirports || !nearestAirports.length) {
        setTripRequestStatus("error");
        setTripRequestError("Youre outside our service area. Booking not available from this location.");
        return;
      }

      // NEW: Find the specific airport ID based on the `pickup` name state
      // This assumes the name set by BookingScreen matches the `name` field from the API exactly.
      // This is the crucial change: match the name stored in state to the array returned by the API.
      const selectedAirport = nearestAirports.find(apt => apt.name === pickup);
      if (!selectedAirport) {
          console.error("Selected pickup name does not match any fetched airport:", pickup, nearestAirports);
          setTripRequestStatus("error");
          setTripRequestError("Could not confirm selected pickup location. Please try again.");
          return;
      }
      airportId = selectedAirport.id;

    } else if (pickup in KNOWN_AIRPORTS) {
      // Handle selection from the hardcoded list in BookingScreen
      airportId = KNOWN_AIRPORTS[pickup];
    } else {
      // Handle a custom pickup name typed by the user (e.g., via Google Autocomplete or manual entry).
      // The `pickupCoords` should now be the coordinates resolved from the *typed* destination name
      // by the Google Autocomplete component integrated into BookingScreen.
      // Call the API again to ensure the coordinates map to a valid ACHRAMS airport.
      const nearestAirports = await findNearestAirport(pickupCoords[0], pickupCoords[1]);

      if (!nearestAirports || !nearestAirports.length) {
        setTripRequestStatus("error");
        setTripRequestError("Pickup location is not near a supported airport.");
        return;
      }

      // NEW: Similar to the "Use my current location" case, find the ID based on the name stored in state.
      // For a custom name, `pickup` is the typed name, and `pickupCoords` are its resolved coordinates.
      // The API might return airports near those coordinates.
      // This logic assumes that for a custom name, the intention is to find *an* ACHRAMS airport near the *typed* location.
      // If the user types "Some Random Street", and it resolves to coordinates not near an ACHRAMS airport,
      // `findNearestAirport` should return null, and the check above (`!nearestAirports`) handles it.
      // If it *does* resolve near an airport, this code finds the ID for that airport.
      // However, if the user typed "Murtala Muhammed Int'l Airport", it should ideally resolve coordinates
      // that `findNearestAirport` matches back to the ACHRAMS entry for that airport.
      // The name matching logic here is primarily for the "Use my current location" case where the name is explicitly selected.
      // For custom names, if the coordinates are accurate, `findNearestAirport` should ideally return the relevant airport.
      // If the typed name doesn't correspond to a specific ACHRAMS airport boundary but is nearby,
      // the backend might expect the ID of the nearest ACHRAMS airport.
      // The safest bet is still to match the name if possible, or default to the first result if names don't match perfectly.
      // Let's try name matching first, then fall back.
      const selectedAirport = nearestAirports.find(apt => apt.name === pickup);
      if (selectedAirport) {
          airportId = selectedAirport.id;
      } else {
          // Fallback: if the typed name doesn't exactly match an API result name,
          // use the first result from the API call (assuming it's the nearest one).
          // This covers cases where the user types a location close to an airport but not the airport name itself,
          // and the system correctly identifies the nearest airport boundary.
          console.warn("Typed pickup name did not match any fetched airport name, using first result.", pickup, nearestAirports);
          airportId = nearestAirports[0].id;
      }
    }

    // === Step B: Prepare request body (amount, guest details, requirements, locations) ===
    // (This part remains largely the same, using fareEstimate, passengerData, requirements, pickupCoords, destinationCoords)
    const tripData = {
      amount: {
        amount: fareEstimate?.toString() || "0",
        currency: "NGN",
      },
      airport: airportId, // Use the resolved ID
      guest_name: passengerData.name,
      guest_email: passengerData.email,
      guest_phone: formatPhoneNumber(passengerData.phone),
      has_extra_leg_room: requirements.elderly,
      has_extra_luggage: requirements.luggage,
      has_wheel_chair_access: requirements.wheelchair,
      pickup_address: pickup, // The resolved/typed pickup name
      pickup_location: pickupCoords, // [lng, lat] from state
      destination_address: destination, // The typed destination name
      destination_location: destinationCoords, // [lng, lat] from state (resolved by Google Autocomplete in BookingScreen)
    };

    console.log("Request Data:", tripData);

    // === Step C: Make API call ===
    const response = await apiClient.post("/trips/guest-booking", tripData);

    console.log("Raw API Response:", response);

    if (response.status === "success" && response.data) {
      const trip = response.data;
      const extractedGuestId = trip.guest?.id;

      if (!extractedGuestId) {
        console.error("Guest ID not found in booking response, cannot start WebSocket.");
        setTripRequestStatus('error');
        setTripRequestError('Failed to get guest session. Booking cancelled.');
        return;
      }

      console.log("Trip data received:", trip);
      console.log("Guest ID received:", extractedGuestId);

      setVerificationCode(trip.verification_code || "");
      setActiveTripId(trip.id);
      setGuestId(extractedGuestId);

      if (trip.status.value === "searching") {
        setTripRequestStatus(null);
        setScreen("assigning");
        startWebSocketConnection(extractedGuestId, trip.id);
      } else if (trip.status.value === "driver_assigned" && trip.driver) {
        setDriver(trip.driver);
        setTripRequestStatus(null);
        setScreen("driver-assigned");
        // No need to start WebSocket or polling if driver is already assigned
      } else {
        console.warn("Unexpected trip status after booking:", trip.status);
        setTripRequestStatus("error");
        setTripRequestError(`Unexpected booking state: ${trip.status.label}`);
      }
    } else {
      console.error(
        "API responded with non-success status or missing data:",
        response
      );
      let errorMessage = "Failed to book your trip. Server responded unexpectedly.";
      if (response.message) {
        errorMessage = response.message;
        if (response.details) {
          const fieldErrors = [];
          for (const [field, messages] of Object.entries(response.details)) {
            if (Array.isArray(messages)) {
              fieldErrors.push(`${field}: ${messages.join(", ")}`);
            }
          }
          if (fieldErrors.length > 0) {
            errorMessage += ` Details: ${fieldErrors.join("; ")}`;
          }
        }
      }
      throw new Error(errorMessage);
    }
  } catch (err: any) {
    console.error("Guest booking error:", err);
    setTripRequestStatus("error");

    let errorMessage = "Failed to book your trip. Please check your connection and try again.";

    if (err instanceof Error) {
      errorMessage = err.message;
    } else {
      console.error("Unexpected error type caught:", typeof err, err);
      errorMessage = 'An unexpected error occurred during booking.';
    }

    setTripRequestError(errorMessage);
  }
};

 const handleShowLocationModal = () => {
    setShowLocationModal(true);
  };
const handleLocationModalClose = () => {
    setShowLocationModal(false);
  };


const handleGrantLocationAccess = () => {
  console.log("location access granted button clicked in modal. The BookingScreen will handle the requestPermission call")
}

  const startWebSocketConnection = (guestId: string, tripId: string) => {
    if (webSocketConnection) {
      // Close any existing connection before starting a new one
      console.log("Closing existing WebSocket connection.");
      webSocketConnection.close();
      // Note: The onclose handler will fire, potentially starting polling if trip is still active.
      // We might want to prevent that if we are intentionally reconnecting.
      // For now, the logic in onclose checks the screen state or activeTripId to decide.
    }

    // Construct the WebSocket URL using the guest ID
    const wsUrl = `wss://api.achrams.com.ng/ws/v1/app?guest_id=${guestId}`;

    console.log(`Attempting to connect to WebSocket: ${wsUrl}`);

    // Create the ReconnectingWebSocket instance
    const rws = new ReconnectingWebSocket(wsUrl, [], {
      // Optional configuration for ReconnectingWebSocket
      connectionTimeout: 10000, // Timeout for individual connection attempts
      maxRetries: 10, // Maximum number of reconnection attempts (or Number.MAX_VALUE for unlimited)
      maxReconnectionDelay: 10000, // Maximum delay between reconnections
      // Add other options as needed from the library's documentation
    });

    // Set up event handlers
    rws.onopen = () => {
      console.log("WebSocket connection opened.");
      setWebSocketStatus("open");
      // If polling was running as a fallback, stop it now that WS is open
      stopPollingTripStatus();
    };

    rws.onmessage = (event) => {
      try {
        const messageData: WebSocketMessage = JSON.parse(event.data);
        console.log("Received WebSocket message:", messageData);

        const { event: eventType, data: tripData } = messageData;

        // Check if it's a relevant trip update event
        if (eventType === 'trip:assigned' || eventType === 'trip:status:update') {
      // Update UI state based on the received trip data

      // NEW: Check for 'driver not found' status
      if (tripData.status.value === 'driver not found') { // Use the exact string from backend/Postman
        console.log("Driver not found via WebSocket, updating UI.");
        // Stop both WebSocket and polling
        stopWebSocketConnection();
        stopPollingTripStatus();
        // Set status to show 'no-driver' modal
        setTripRequestStatus('no-driver');
        // Optionally set a specific error message
        setTripRequestError(`No drivers available for your trip.`);
        // Do NOT change the screen here, let the modal handle the user interaction.
        // The screen might still be 'assigning', which is okay until the user retries/cancels.
        return; // Exit handler after handling 'driver not found'
      }

      // NEW: Check for 'accepted' OR 'driver_assigned' status when a driver is present
      if ((tripData.status.value === 'accepted' || tripData.status.value === 'driver_assigned') && tripData.driver) {
        // Driver found or assigned!
        console.log(`${tripData.status.label} via WebSocket, updating UI with driver.`);
        setDriver(tripData.driver);
        setScreen('driver-assigned'); // Transition to the driver-assigned screen
        stopWebSocketConnection(); // Stop WebSocket as trip is assigned/accepted
        stopPollingTripStatus(); // Ensure polling is also stopped
        // No need to start polling here, as trip is assigned/accepted.
      } else if (tripData.status.value === 'cancelled' || tripData.status.value === 'completed') {
        // Trip is no longer active, stop polling and handle accordingly
        console.log(`Trip ${tripData.id} is now ${tripData.status.value} via WebSocket.`);
        setTripRequestStatus('error'); // Or a specific status like 'trip-cancelled'
        setTripRequestError(`Trip ${tripData.status.label}.`); // Show status message
        stopWebSocketConnection(); // Stop WebSocket as trip is finished
        stopPollingTripStatus(); // Ensure polling is also stopped
        // No need to start polling here, as trip is finished.
      } else {
        // Handle other statuses if needed, or just log/update state if necessary
        // e.g., update verification code, status label, etc., if relevant
        console.log(`Received trip status update via WebSocket: ${tripData.status.value}`);
        // You might want to update activeTripId if it changed, though unlikely after initial booking
        // setActiveTripId(tripData.id);
        // setVerificationCode(tripData.verification_code || '');
        // setTripStatus(tripData.status); // If you have a separate state for trip status
      }
    } else {
      // Handle other event types if the backend sends them
      console.log(`Received other WebSocket event: ${eventType}`);
    }
  } catch (error) {
    console.error('Error parsing WebSocket message:', error, event.data);
  }
    };

    // Inside startWebSocketConnection setup
rws.onclose = (event) => {
  console.log('WebSocket connection closed:', event.code, event.reason);
  setWebSocketStatus('closed');
  // IMPORTANT: The WebSocket closed. If the trip is *not* in a final state,
  // we need to start the polling fallback.
  // Check current screen or potentially fetch latest status via API first before polling.
  // For now, if screen is still 'assigning' or related to searching/active, and we have an active trip ID, start polling.
  // We'll pass the activeTripId to the polling function.
  // NEW: Only start polling if we are still in an intermediate state and polling isn't already active.
  if (activeTripId && !['driver-assigned', 'completed', 'cancelled', 'driver not found'].includes(screen) && !pollingIntervalId) { // NEW: Check pollingIntervalId
     console.log(`WebSocket closed, starting polling for trip ${activeTripId} as fallback.`);
     startPollingTripStatus(activeTripId);
  } else {
     console.log(`WebSocket closed, but not starting polling. Trip ID: ${activeTripId}, Screen: ${screen}, Polling Active: ${!!pollingIntervalId}`);
     // If screen is a final state, ensure polling is definitely stopped just in case.
     if (['driver-assigned', 'completed', 'cancelled', 'driver not found'].includes(screen)) {
         console.log("Screen indicates final state, ensuring polling is stopped.");
         stopPollingTripStatus(); // NEW: Ensure polling stops if closed event happens after final state
     }
  }
};

    rws.onerror = (error) => {
      console.error("WebSocket error:", error);
      // Error doesn't necessarily mean the connection is closed, but log it.
      // The library handles reconnection attempts.
      // You might want to update a UI status indicator if needed.
      // setWebSocketStatus('reconnecting'); // The library handles this internally, but you can track if desired.
    };

    // Store the connection instance
    setWebSocketConnection(rws);
    setWebSocketStatus("connecting"); // Update status while connecting
  };

  // NEW: Function to stop the WebSocket connection
  const stopWebSocketConnection = () => {
    if (webSocketConnection) {

      stopPollingTripStatus();
      console.log("Manually stopping WebSocket connection.");
      webSocketConnection.close(); // This will trigger the onclose handler
      setWebSocketConnection(null);
      setWebSocketStatus("closed");
    }
  };

  const fetchTripStatus = async (tripId: string) => {
    if (!tripId || !guestId) {
      // Ensure both tripId and guestId are available
      console.warn("fetchTripStatus called without a tripId or guestId");
      return;
    }
    try {
      console.log(
        `Polling trip status for ID: ${tripId} using guestId: ${guestId}`
      );
      // Use apiClient to call GET /trips/{id}
      // The apiClient (from src/lib/api.ts) is designed to add X-Guest-Id header if guestId is provided
      const response = await apiClient.get(`/trips/${tripId}`, true, guestId); // Pass isGuest=true and guestId

      // Remember, apiClient returns the JSON body directly for success
      if (response.status === "success" && response.data) {
        const trip = response.data; // This is the trip object from the API's { status: "...",  {...} }

        console.log(
          `Polled trip status: ${
            trip.status.value
          }, has driver: ${!!trip.driver}`
        );

        // Check the status and handle accordingly
        if (trip.status.value === "driver_assigned" && trip.driver) {
          // Driver found!
          console.log("Driver assigned via polling, updating UI.");
          setDriver(trip.driver);
          setScreen("driver-assigned"); // Transition to the next screen
          stopPollingTripStatus(); // Stop polling
          stopWebSocketConnection(); // Stop WebSocket if it was re-established during polling
        } else if (
          trip.status.value === "cancelled" ||
          trip.status.value === "completed"
        ) {
          // Trip is no longer active, stop polling and handle accordingly
          console.log(
            `Trip ${tripId} is now ${trip.status.value} via polling, stopping polling.`
          );
          setTripRequestStatus("error"); // Or a specific status like 'trip-cancelled'
          setTripRequestError(`Trip ${trip.status.label}.`); // Show status message
          stopPollingTripStatus(); // Stop polling
          stopWebSocketConnection(); // Stop WebSocket if it was re-established during polling
          // You might want to clear trip details and go back to booking or dashboard
        } else {
          // Trip is still searching or in another intermediate state via polling
          console.log(
            `Trip ${tripId} is still ${trip.status.value} via polling.`
          );
          // Continue polling
        }
      } else {
        // Handle API error response (e.g., status not "success"), e.g., trip not found (404)
        console.error(
          "Polling API responded with non-success status or missing ",
          response
        );
        // Decide: Stop polling? Retry? Log and continue?
        // For a 404 (trip not found), it might imply cancellation.
        // For other errors (500, etc.), maybe continue polling briefly.
        // For now, log and continue polling (assuming temporary issue or trip not yet visible).
        // You could add logic here to stop polling after N consecutive errors.
      }
    } catch (err) {
      // Handle network error or apiClient throwing an error
      console.error("Error polling trip status:", err);
      // Decide: Stop polling after a few errors? Or continue? Add retry logic?
      // For now, log and continue polling (assuming temporary network glitch).
      // Optionally, add retry logic or error count here.
    }
  };

  const startPollingTripStatus = (tripId: string) => {
    if (pollingIntervalId) {
      // Clear any existing polling interval to avoid duplicates
      clearInterval(pollingIntervalId);
    }

    console.log(
      `Starting polling for trip ${tripId} every 5 seconds (fallback).`
    );
    const interval = setInterval(() => {
      fetchTripStatus(tripId); // Pass the tripId to the fetch function
    }, 5000); // Poll every 5 seconds

    setPollingIntervalId(interval);
  };

  // NEW: Function to stop polling
  const stopPollingTripStatus = () => {
    if (pollingIntervalId) {
      console.log("Stopping trip status polling.");
      clearInterval(pollingIntervalId);
      setPollingIntervalId(null);
    }
  };

  useEffect(() => {
    return () => {
      console.log("Cleaning up WebSocket and polling intervals on unmount.");
      stopWebSocketConnection();
      stopPollingTripStatus();
    };
  }, []);

  const handleTripStart = () => {
    setScreen("trip-progress");
  };

  const handleRateSubmit = () => {
    setScreen("trip-complete");
  };

  const handleTripComplete = () => {
    setScreen("trip-complete");
  };

  // NEW: Wait for hydration before rendering main content to avoid SSR/client mismatch
  if (!hasHydrated) {
    return (
      <div className="flex items-center justify-center h-screen w-full bg-white animate-fadeIn">
        <div className="relative">
          {/* Soft pulsing glow */}
          <div className="absolute inset-0 rounded-2xl bg-achrams-gradient-primary opacity-40 blur-xl animate-pulse"></div>

          {/* Main Logo Container */}
          <div className="w-16 h-16 bg-achrams-gradient-primary rounded-2xl flex items-center justify-center shadow-xl animate-scaleIn relative overflow-hidden">
            {/* Subtle rotating light sweep */}
            <div className="absolute inset-0 bg-white/20 animate-sweep pointer-events-none"></div>

            <Image
              src="/images/logo.png"
              alt="ACHRAMS Logo"
              width={30}
              height={30}
              className="object-contain animate-popIn"
            />
          </div>
        </div>
      </div>
    ); // Or a skeleton loader
  }

  // === Render current screen as main content ===
  let mainContent = null;

  if (screen === "booking") {
    mainContent = (
      <BookingScreen
        pickup={pickup}
        setPickup={setPickup}
        destination={destination}
        setDestination={setDestination}
        fareEstimate={fareEstimate}
        setFareEstimate={setFareEstimate}
        onProceed={handleProceed}
        setShowPassengerDetails={setShowPassengerDetails}
        passengerData={passengerData}
        setPassengerData={setPassengerData}
        showPassengerDetails={showPassengerDetails}
        requirements={requirements}
        setRequirements={setRequirements}
        setPickupCoords={setPickupCoords} // NEW
        setDestinationCoords={setDestinationCoords} // NEW
       


      />
    );
  } else if (screen === "assigning") {
    mainContent = <AssigningScreen 
    status={tripRequestStatus}
    />;
  } else if (screen === "driver-assigned") {
    mainContent = (
      <DriverAssignedScreen
        pickup={pickup}
        destination={destination}
        driver={driver}
        verificationCode={verificationCode || ""} // NEW: Pass verification code
        onShowDirections={() => setShowDirections(true)}
        onShowDriverVerification={() => setShowDriverVerification(true)} // NEW: Handler for verification modal
        onStartTrip={handleTripStart}
        onBack={() => setScreen("booking")}
      />
    );
  } else if (screen === "trip-progress") {
    // NEW: Use the statically imported TripProgressScreen
    mainContent = (
      <TripProgressScreen
        driver={driver}
        onPanic={() => setShowPanic(true)}
        onComplete={handleTripComplete}
        pickupCoords={pickupCoords} // NEW: Pass coordinates
        destinationCoords={destinationCoords} // NEW: Pass coordinates
        tripProgress={tripProgress} // NEW: Pass progress
        // Remove canRenderMaps prop as it's no longer needed if using dynamic import for the screen was the main strategy
      />
    );
  } else if (screen === "trip-complete") {
    mainContent = (
      <TripCompleteScreen
        fareEstimate={fareEstimate}
        driver={driver}
        onRate={() => setShowRate(true)}
        onDone={() => {
          // NEW: Clear specific trip-related state before navigating
          setPickup("");
          setDestination("");
          setFareEstimate(null);
          setDriver(null);
          setTripProgress(0);
          setPickupCoords(null);
          setDestinationCoords(null);
          setVerificationCode(null); // NEW: Clear verification code
          // alert('was called');
          setGuestId(null); // NEW: Clear guest ID
          // Stop any potential polling/WebSocket if they were still running due to timing
          stopPollingTripStatus();
          stopWebSocketConnection();
          if (!token) {
            setScreen("dashboard");
          } else {
            // NEW: Instead of setting screen to 'signup-prompt', just set the showSignup state
            setScreen("booking");
            // setShowSignup(true);
          }
        }}
      />
    );
  } else if (screen === "dashboard") {
    // NEW: Render the DashboardScreen component
    mainContent = (
      <DashboardScreen
        passengerData={passengerData}
        walletBalance={walletBalance} // NEW: Pass wallet balance
        is2FAEnabled={is2FAEnabled} // NEW: Pass 2FA status
        onShowProfile={() => setShowProfile(true)}
        onBookNewTrip={() => {
          setScreen("booking");
          setPickup("");
          setDestination("");
          setFareEstimate(null);
          setPickupCoords(null);
          setDestinationCoords(null);
          setDriver(null);
          setTripProgress(0); // NEW: Reset trip progress
          setVerificationCode(null); // NEW: Reset verification code
        }}
        // NEW: Pass handlers for new dashboard features
        onShowTripHistory={() => setShowTripHistory(true)}
        onShowWallet={() => setShowWallet(true)}
        onShowSettings={() => setShowSettings(true)}
        onShowEnable2FA={() => setShowEnable2FA(true)} // NEW: Handler for enabling 2FA
        onShowUpdateProfile={() => setShowUpdateProfile(true)} // NEW: Handler for updating profile
        onBookRide={() => setScreen("booking")}
        onProfile={() => setShowProfile(true)}
        onLogout={() => {}}
      />
    );
  }
  // NEW: Render new screens if their state is active (overlaying the dashboard or other screens if needed)
  // These are rendered *instead of* the main screen content when active.
  else if (showTripHistory) {
    mainContent = (
      <TripHistoryScreen
        onBack={() => setShowTripHistory(false)} // NEW: Handler to go back to dashboard
        onSelectTrip={(tripId) => {
          setSelectedTripId(tripId);
          setShowTripHistory(false); // Close history
          setShowTripDetails(true); // Open details
        }}
      />
    );
  } else if (showTripDetails && selectedTripId) {
    mainContent = (
      <TripDetailsScreen
        tripId={selectedTripId}
        onBack={() => {
          setShowTripDetails(false);
          setSelectedTripId(null); // Clear selected ID
          setShowTripHistory(true); // Optionally go back to history
        }}
      />
    );
  } else if (showWallet) {
    mainContent = (
      <WalletScreen
        balance={walletBalance} // NEW: Pass current balance
        onBack={() => setShowWallet(false)} // NEW: Handler to go back to dashboard
      />
    );
  } else if (showSettings) {
    mainContent = (
      <SettingsScreen
        onBack={() => setShowSettings(false)} // NEW: Handler to go back to dashboard
        onShowProfile={() => {
          setShowSettings(false);
          setShowProfile(true);
        }} // NEW: Navigate to profile from settings
        onShowEnable2FA={() => {
          setShowSettings(false);
          setShowEnable2FA(true);
        }} // NEW: Navigate to 2FA enable from settings
        onShowUpdateProfile={() => {
          setShowSettings(false);
          setShowUpdateProfile(true);
        }} // NEW: Navigate to profile update from settings
        // Add other handlers for settings options (notifications, help, etc.)
      />
    );
  }
  // Note: Removed the 'signup-prompt' screen render block as it's handled by the showSignup state and modal

  // === Return full UI tree including modals and notifications ===
  return (
    <>
      <div className="min-h-screen flex items-center justify-center">
        <div
          className="
  min-h-screen h-dvh
  w-full max-w-[430px] mx-auto
  bg-white
  flex flex-col
  /* Critical for header/body/footer layouts */
  text-sm
  antialiased
  [font-feature-settings:'ss01']
"
        >
          {/* NEW: Render notification if available */}
          {currentNotification && (
            <TripUpdateNotification
              message={currentNotification.message}
              type={currentNotification.type}
              onDismiss={() => setCurrentNotification(null)}
            />
          )}

          {mainContent}

          {/* Modals  all rendered as overlays */}
          <PassengerDetailsModal
            isOpen={showPassengerDetails}
            onClose={() => setShowPassengerDetails(false)}
            passengerData={passengerData}
            setPassengerData={setPassengerData}
            requirements={requirements}
            setRequirements={setRequirements}
            onRequestRide={handleRequestRide}
            isLoading={tripRequestStatus === "loading"}
          />

      

          {/* NEW: Dynamically imported DirectionsModal */}
          {hasHydrated && (
            <DirectionsModal
              isOpen={showDirections}
              onClose={() => setShowDirections(false)}
              pickup={pickup}
              pickupCoords={pickupCoords}
              destination={destination} // NEW
              destinationCoords={destinationCoords} // NEW
            />
          )}

          <PanicModal
            isOpen={showPanic}
            onClose={() => setShowPanic(false)}
            onComplete={() => {
              setShowPanic(false);
              alert("Safety team notified");
            }}
          />

          {!token &&
            showSignup && ( // Ensure it only shows for unauthenticated users
              <SignupPromptModal
                isOpen={showSignup} // Use showSignup state
                passengerData={passengerData}
                onClose={() => setShowSignup(false)} // Close the modal state
                onVerifyEmail={() => setShowOTP(true)} // Keep existing link to OTP
                onRegistrationSuccess={handleRegistrationSuccess} // NEW: Pass success handler
                onOpenLoginModal={() => setShowLogin(true)} // NEW: Pass handler to open login modal
                onSignup={() => {
                  // NEW: Handler for signup button in modal (e.g., navigate to register)
                  setShowSignup(false);
                  // You could navigate to a registration page or open the registration modal here
                  // For now, just close the prompt.
                }}
                onLogin={() => {
                  // NEW: Handler for login button in modal (e.g., open login modal)
                  setShowSignup(false);
                  // You could open a login modal here
                  // For now, just close the prompt.
                }}
                onContinueAsGuest={() => {
                  // NEW: Handler for continue as guest button (e.g., close modal, maybe navigate to dashboard)
                  setShowSignup(false);
                  setScreen("dashboard"); // Example: go to dashboard after trip
                }}
                // NEW: Pass registration success handler
              />
            )}

          <OTPModal
            isOpen={showOTP}
            email={passengerData.email}
            onComplete={() => {
              setTimeout(() => {
                setScreen("dashboard");
                setShowOTP(false);
                setShowSignup(false);
              }, 1000);
            }}
            onClose={() => setShowOTP(false)}
          />

          <ProfileModal
            isOpen={showProfile}
            passengerData={passengerData}
            onClose={() => setShowProfile(false)}
            onLogout={() => {
              // Clear saved state on logout
              if (typeof window !== "undefined" && window.sessionStorage) {
                sessionStorage.removeItem("achrams_app_state");
              }
              window.location.href = "/auth/login";
            }}
          />

          {/* NEW: Trip Request Status Modal */}
          <TripRequestStatusModal
            isOpen={!!tripRequestStatus}
            status={tripRequestStatus}
            message={tripRequestError}
            onClose={() => {setTripRequestStatus(null)
              setScreen("booking")
            }}
            onConfirm={() => {
                if (tripRequestStatus === 'no-driver' || tripRequestStatus === 'error') {
                  // NEW: If status is 'no-driver' or 'error', retry the booking process
                  console.log("Retrying booking process...");
                  setTripRequestStatus(null); // Close the modal first
                  // NEW: Call the main booking function again to restart the flow
                  handleRequestRide();
                } else {
                  // For 'loading' or 'accepted' states, just close the modal
                  setTripRequestStatus(null);
                }}}
          />

          {/* NEW: Driver Verification Modal */}
          <DriverVerificationModal
            isOpen={showDriverVerification}
            securityCode={verificationCode || ""}
            onClose={() => setShowDriverVerification(false)}
          />

          {/* NEW: Login Modal */}
          <LoginModal
            isOpen={showLogin}
            onClose={() => setShowLogin(false)}
            onLoginSuccess={handleLoginSuccess} // NEW: Pass success handler
          />

          {/* NEW: Modals for dashboard features */}
          {showEnable2FA && (
            <Enable2FAModal
              isOpen={showEnable2FA}
              onClose={() => setShowEnable2FA(false)}
              onSuccess={handle2FAEnabled} // NEW: Pass success handler
            />
          )}
          {showDisable2FA && (
            <Disable2FAModal
              isOpen={showDisable2FA}
              onClose={() => setShowDisable2FA(false)}
              onSuccess={handle2FADisabled} // NEW: Pass success handler
            />
          )}
          {showUpdateProfile && (
            <UpdateProfileModal
              isOpen={showUpdateProfile}
              initialData={passengerData} // Pass current data as initial values
              onClose={() => setShowUpdateProfile(false)}
              onSuccess={handleProfileUpdated} // NEW: Pass success handler
            />
          )}

          {/* Future: Uncomment when implemented */}
          <CancelModal
            isOpen={showCancel}
            onClose={() => setShowCancel(false)}
            onConfirm={() => {}}
          />
          {showRate && (
            <RateModal
              isOpen={showRate}
              onClose={() => setShowRate(false)}
              onRate={handleRateSubmit} // Assuming you have a function to handle API call
              driverName={driver?.name}
              // NEW: Pass the notification setter as setNotification
              setNotification={setCurrentNotification} // Use setCurrentNotification
            />
          )}
          <MessageWindowModal
            isOpen={showMessage}
            onClose={() => setShowMessage(false)}
            recipientName={driver?.name || "Driver"}
          />
        </div>
      </div>
      {/* NEW: Bottom Navigation Bar - Rendered only on dashboard screen */}
      {screen === "dashboard" && (
        <BottomNavBar
          onProfileClick={() => setShowProfile(true)}
          walletBalance={walletBalance} // Pass balance for potential icon badge
          onHomeClick={() => setScreen("booking")} // Example: Home click books new trip
          onWalletClick={() => setShowWallet(true)} // NEW: Link wallet click
          onSearchClick={() => setShowTripHistory(true)} // Example: Link search to history
          // Add other handlers for new nav items if needed
        />
      )}
    </>
  );
}


----- FILE: src/app/layout.tsx -----
// src/app/layout.tsx
import type { Metadata } from "next";
import "./globals.css";
import ClientProviders from "@/components/ClientProviders"; // We'll create this

export const metadata: Metadata = {
  title: "ACHRAMS Passenger App",
  description: "Book your airport transfer with ACHRAMS.",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en" suppressHydrationWarning={true}>
      <body className="bg-achrams-background-primary" suppressHydrationWarning={true}>
        <ClientProviders>
          {children}
        </ClientProviders>
      </body>
    </html>
  );
}

----- FILE: src/lib/api.ts -----
// src/lib/api.ts
const API_BASE = 'https://api.achrams.com.ng/v1';

// Define the generic API response structure
interface ApiResponse<T = unknown> {
  status: 'success' | 'error';
  message: string;
   T;
}

const buildHeaders = (token?: string, isGuest = false, guestId?: string) => {
  const headers: Record<string, string> = {
    'Content-Type': 'application/json',
  };
  if (token) {
    headers['Authorization'] = `Bearer ${token}`;
  }
  if (isGuest && guestId) {
    headers['X-Guest-Id'] = guestId;
  }
  return headers;
};

export const apiClient = {
  post: async <T = unknown>(
    endpoint: string,
    data: unknown,
    token?: string,
    guestId?: string
  ): Promise<ApiResponse<T>> => {
    const isGuestRequest = endpoint.includes('/guest-booking') || guestId !== undefined;
    const res = await fetch(`${API_BASE}${endpoint}`, {
      method: 'POST',
      headers: buildHeaders(token, isGuestRequest, guestId),
      body: JSON.stringify(data),
    });

    if (!res.ok) {
      const errorData = await res.json().catch(() => ({ message: 'Network or server error' }));
      console.log(`Data: ${data} \n Result: ${res}`)
      throw new Error(errorData.message || `HTTP error! status: ${res.status}`);
      
    }

    return res.json();
  },

  get: async <T = unknown>(endpoint: string, token?: string, guestId?: string): Promise<ApiResponse<T>> => {
    const isGuestRequest = guestId !== undefined;
    const res = await fetch(`${API_BASE}${endpoint}`, {
      headers: buildHeaders(token, isGuestRequest, guestId),
    });

    if (!res.ok) {
      const errorData = await res.json().catch(() => ({ message: 'Network or server error' }));
      throw new Error(errorData.message || `HTTP error! status: ${res.status}`);
    }

    return res.json();
  },

  patch: async <T = unknown>(endpoint: string, formData: FormData, token?: string): Promise<ApiResponse<T>> => {
    const res = await fetch(`${API_BASE}${endpoint}`, {
      method: 'PATCH',
      headers: {
        Authorization: `Bearer ${token}`, // Token passed in
      },
      body: formData,
    });

    if (!res.ok) {
      const errorData = await res.json().catch(() => ({ message: 'Network or server error' }));
      throw new Error(errorData.message || `HTTP error! status: ${res.status}`);
    }

    return res.json();
  },
};

----- FILE: src/lib/airports.ts -----
// // src/lib/airports.ts
// import { apiClient } from '@/services/apiClient';

// export interface Airport {
//   id: string;
//   name: string;
//   codename: string;
//   map_data: any; // or define GeoJSON type if needed
// }

// // Reverse geocode coords  nearest ACHRAMS airport
// export const findNearestAirport = async (
//   longitude: number,
//   latitude: number
// ): Promise<Airport | null> => {
//   try {
//     const response = await apiClient.get(`/v1/airports/by-location/?lon=${longitude}&lat=${latitude}`);
//     if (response.data?.data?.length > 0) {
//       return response.data.data[0]; // assume first is nearest
//     }
//     return null;
//   } catch (err) {
//     console.error('Failed to find airport by location:', err);
//     return null;
//   }
// };

// // Map known airport name  UUID (for when user selects from list)
// export const KNOWN_AIRPORTS: Record<string, string> = {
//   'Murtala Muhammed Int\'l Airport (LOS)': '0199de42-10b4-7f53-b670-42f107897a1d',
//   // Add others as needed from /choices or /airports list
// };


// src/lib/airports.ts
import { apiClient } from '@/services/apiClient';

export interface Airport {
  id: string;
  name: string;
  codename: string;
  map_data: any; // or define GeoJSON type if needed
  is_active: boolean; // Add this based on the API response structure
}

// Reverse geocode coords  nearest ACHRAMS airport(s)
// Returns an array of airports found, or null if none or on error.
export const findNearestAirport = async (
  longitude: number,
  latitude: number
): Promise<Airport[] | null> => {
  try {
    const response = await apiClient.get(`/v1/airports/by-location/?lon=${longitude}&lat=${latitude}`);
    console.log("API Response for airports by location:", response); // Optional: For debugging
    if (response.data?.data && Array.isArray(response.data.data) && response.data.data.length > 0) {
      return response.data.data; // Return the full array of airports
    }
    console.log("No airports found near coordinates:", longitude, latitude); // Optional: For debugging
    return null;
  } catch (err) {
    console.error('Failed to find airport by location:', err);
    return null;
  }
};

// Map known airport name  UUID (for when user selects from list)
export const KNOWN_AIRPORTS: Record<string, string> = {
  'Murtala Muhammed Int\'l Airport (LOS)': '0199de42-10b4-7f53-b670-42f107897a1d',
  // Add others as needed from /choices or /airports list
};

----- FILE: src/services/apiClient.ts -----
// src/services/apiClient.ts
import axios, { AxiosRequestConfig } from 'axios';

// NEW: Create an axios instance
const apiClient = axios.create({
  baseURL: 'https://api.achrams.com.ng', // NEW: Use the correct base URL from passenger postman DOC.txt
  timeout: 10000, // 10 seconds timeout
  headers: {
    'Content-Type': 'application/json',
  },
});

// NEW: Request interceptor to add Bearer token if available
apiClient.interceptors.request.use(
  (config) => {
    // NEW: Get token from where you store it (e.g., localStorage, cookie via httpOnly)
    // For this example, assuming it's in localStorage under 'auth_token'
    // For better security, consider storing the token in an httpOnly cookie.
    const token = typeof window !== 'undefined' ? localStorage.getItem('auth_token') : null;
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
  },
  (error) => {
    return Promise.reject(error);
  }
);

// NEW: Response interceptor (optional, for handling errors globally)
apiClient.interceptors.response.use(
  (response) => response,
  (error) => {
    // Handle specific status codes (e.g., 401 for unauthorized)
    if (error.response?.status === 401) {
      // NEW: Clear token and potentially redirect
      if (typeof window !== 'undefined') {
          localStorage.removeItem('auth_token');
      }
      // Dispatch an action to update auth state if using a global state manager
      // Or use router.push('/auth/login') if using Next.js router
      // window.location.href = '/auth/login'; // Or dispatch an action to update auth state
    }
    return Promise.reject(error);
  }
);

export default apiClient;
// Export the instance to be used in components
export { apiClient };

